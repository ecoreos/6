/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.namespace("SYNO.SDS.EzInternet.WizardStep");SYNO.SDS.EzInternet.Instance=Ext.extend(SYNO.SDS.AppInstance,{appWindowName:"SYNO.SDS.EzInternet.Wizard",constructor:function(a){SYNO.SDS.EzInternet.Instance.superclass.constructor.apply(this,arguments)}});Ext.define("SYNO.SDS.EzInternet.Utils.NetworkEnv",{extend:"Object",getNetworkEnv:function(b){this.getNetworkEnvCallback=null;this.getNetworkEnvCallbackArgument=null;this.getNetworkEnvCallbackScope=null;if(b&&b.getNetworkEnvCallback&&b.getNetworkEnvCallbackScope){this.getNetworkEnvCallback=b.getNetworkEnvCallback;this.getNetworkEnvCallbackArgument=b.getNetworkEnvCallbackArgument;this.getNetworkEnvCallbackScope=b.getNetworkEnvCallbackScope}var a=[{api:"SYNO.Core.Network.Ethernet",version:1,method:"list"},{api:"SYNO.Core.Network.Bridge",version:1,method:"list"},{api:"SYNO.Core.Network.Wifi.Client",version:1,method:"list"},{api:"SYNO.Core.Network.PPPoE",version:1,method:"list"},{api:"SYNO.Core.Network",version:1,method:"get"},{api:"SYNO.Core.Network.Interface",version:1,method:"list"},{api:"SYNO.Core.Network.Router.Topology",version:2,method:"get"}];if(b.call_test_internet){a.push({api:"SYNO.Core.Network",version:1,method:"test_internet"})}this.owner.clearStatusBusy();this.owner.setStatusBusy();this.sendWebAPI({params:{},scope:this,compound:{stopwhenerror:false,params:a},callback:SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.loadHandler})},loadHandler:function(m,e,l){var f=null;var j=null;var d=null;var p="";var o=[];var c=[];var g=[];var k=null;var n="none";var a=false;var q=null;var b="";this.owner.clearStatusBusy();if(!e.result){SYNO.Debug("compound SYNO.Core.Network related APIs do not has resp.result");if(this.getNetworkEnvCallback&&this.getNetworkEnvCallbackScope){this.getNetworkEnvCallback.call(this.getNetworkEnvCallbackScope,this.netenv,this.getNetworkEnvCallbackArgument)}return}for(var h=0;h<e.result.size();h++){if(!e.result[h].api){this.owner.getMsgBox().alert(_T("common","note"),_T("common","commfail"));SYNO.Debug("compound SYNO.Core.Network related APIs do not has resp.api");if(this.getNetworkEnvCallback&&this.getNetworkEnvCallbackScope){this.getNetworkEnvCallback.call(this.getNetworkEnvCallbackScope,this.netenv,this.getNetworkEnvCallbackArgument)}return}if("SYNO.Core.Network.Wifi.Client"===e.result[h].api){if(e.result[h].data){c=e.result[h].data}}if("SYNO.Core.Network.PPPoE"===e.result[h].api){if(!e.result[h].data){SYNO.Debug("SYNO.Core.Network.PPPoE list do not return data")}else{g=e.result[h].data}}if("SYNO.Core.Network"===e.result[h].api){if("get"===e.result[h].method){if(!e.result[h].data){SYNO.Debug("SYNO.Core.Network get do not return data")}else{k=e.result[h].data;p=k.gateway}}else{if("test_internet"===e.result[h].method){q=e.result[h].success}}}if("SYNO.Core.Network.Interface"===e.result[h].api){if("list"===e.result[h].method){if(!e.result[h].data){SYNO.Debug("SYNO.Core.Network.Interface get do not return data")}else{o=e.result[h].data}}}if("SYNO.Core.Network.Router.Topology"===e.result[h].api){if(!e.result[h].data){SYNO.Debug("SYNO.Core.Network.Router.Topology get do not return data")}else{n=e.result[h].data.net_topology;a=e.result[h].data.support_net_topology;b=e.result[h].data.supported_mode}}}j=k.gateway_info;if(null===j){SYNO.Debug("Can not find gateway correspond interface, we use the first interface as gateway interface");j=d}Ext.each(g,function(i){if(i.real_ifname&&j.ifname&&(i.real_ifname===j.ifname)){f=i}});if((null===f)){if(0<g.size()){f=g[0]}else{f={}}}if(!j.ifname){if(!(f&&"connected"===f.status)){this.owner.getMsgBox().alert(this.title,_T("service","service_wanconfig_gateway_not_set_warn"));if("bridge"===n){j.ifname="br0"}else{j.ifname="eth0"}}j.ifnameFound=false}else{j.ifnameFound=true}this.netenv={pppoe:f,gateif:j,gateway:p,dns:k?k.dns_primary:"",topology:n,support_net_topology:a,support_net_topology_modes:b,wifi_interfaces:c,interfaces:o};this.test_internet=q;if(this.getNetworkEnvCallback&&this.getNetworkEnvCallbackScope){this.getNetworkEnvCallback.call(this.getNetworkEnvCallbackScope,this.netenv,this.getNetworkEnvCallbackArgument)}},getCurrentIP:function(a){if(!a){SYNO.Debug("[Error] getCurrentIP");return null}if(a.pppoe&&("connected"===a.pppoe.status)){return a.pppoe.ip}else{return a.gateif.ip}},isPrivateIP:function(a){return !SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.isPublicIP(a)},isPublicIP:function(a){var e=[];a=Ext.util.Format.trim(a||"").split(".");for(var d=0;d<a.length;d++){var b=parseInt(a[d],10);if(Ext.isNumber(b)&&b>=0&&b<=255){e.push(b)}else{return false}}if(e.length===4){if((e[0]===169)&&(e[1]===254)){return false}if(e[0]===127||e[0]===10||(e[0]===192&&e[1]===168)||(e[0]===172&&e[1]>=16&&e[1]<=31)){return false}else{return true}}else{var c="[Error] ip format length wrong: "+e.length;SYNO.Debug(c);return true}},isPPPoEConnected:function(a){return(a&&a.pppoe&&"connected"===a.pppoe.status)},checkTopologySwitching:function(a){if(a){this.checkTopologySwitchingCallback=a}else{this.checkTopologySwitchingCallback=null}this.owner.sendWebAPI({api:"SYNO.Core.Network.Router.Topology",version:2,method:"get",scope:this,callback:SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.checkTopologySwitchingHandler})},checkTopologySwitchingHandler:function(d,c,b){if(!d){this.owner.clearStatusBusy();SYNO.Debug("checkTopologySwitching failed");return}if(!c||(undefined===c.switching)){this.owner.clearStatusBusy();SYNO.Debug("Critical error in checkTopologySwitchingHandler()");return}if(c.switching){var e=this;var a=function(){SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.checkTopologySwitching.call(e,e.checkTopologySwitchingCallback)};SYNO.Debug("topology is switching, after 10 sec check again");setTimeout(a,10000);return}else{if(this.checkTopologySwitchingCallback){this.checkTopologySwitchingCallback()}}}});Ext.define("SYNO.SDS.EzInternet.Utils.Topology",{extend:"Object",isWifiDS:function(a){return true===a.support_net_topology},isSupportAPMode:function(a){return a.support_net_topology_modes=="bridge router client"},isRouterMode:function(a){return"router"===a.topology},isClientMode:function(a){return"client"===a.topology},isAnyClientModeEnabled:function(a){for(var b=0;b<a.wifi_interfaces.size();b++){if("Enabled"===a.wifi_interfaces[b].status){return true}}return false},isBridgeMode:function(a){return"bridge"===a.topology},getMode:function(a){return a.topology}});Ext.define("SYNO.SDS.EzInternet.Utils.Flow",{extend:"Object",isDefaultInterfacePublicIP:function(a){var b=SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype;if(b.isPrivateIP(b.getCurrentIP(a))){return false}else{return true}},isDefaultGatewayUSBModemDongle:function(a){if(!a||!a.gateif){return false}if(("connected"===a.gateif.status)&&("usbmodem"===a.gateif.type)){if(!a.gateif.ip||!a.gateif.mask){SYNO.Debug("[Error] usbmodem has not ip or netmask")}return true}return false}});Ext.define("SYNO.SDS.EzInternet.Utils.CheckUserSelection",{extend:"Object",isViaRouter:function(a){var b=a.getStep("welcome").netenv;var d=["topology_conn_bridge","topology_conn_direct_link","topology_conn_via_router"];var c=null;var e=function(){for(var f=0;f<d.size();f++){if(d[f]===a.getActiveStep().itemId){return d[f]}}return null};c=e();if(c){if("topology_conn_direct_link"!==c){return true}else{return false}}else{if(SYNO.SDS.EzInternet.Utils.Topology.prototype.isWifiDS(b)&&SYNO.SDS.EzInternet.Utils.Topology.prototype.isSupportAPMode(b)){if(SYNO.SDS.EzInternet.Utils.CheckUserSelection.prototype.isClientMode(a)||SYNO.SDS.EzInternet.Utils.CheckUserSelection.prototype.isBridgeMode(a)){return true}else{if(SYNO.SDS.EzInternet.Utils.CheckUserSelection.prototype.isRouterMode(a)){return false}else{SYNO.Debug("[Error] isViaRouter(1)");return false}}}else{if(!a.inHistory("connopt")&&("connopt"!==a.getActiveStep().itemId)){SYNO.Debug("use this function error, the precondiction of this function is used after connopt");return false}if("by_router"===a.getStep("connopt").getForm().getValues().mode){return true}else{if("direct"===a.getStep("connopt").getForm().getValues().mode){return false}else{SYNO.Debug("[Error] isViaRouter(2)");return false}}}}},isBridgeMode:function(a){if(!a.inHistory("topology")&&("topology"!==a.getActiveStep().itemId)){SYNO.Debug("wrong usage in isBridgeMode");return false}if("bridge"===a.getStep("topology").getForm().getValues().mode){return true}else{return false}},isRouterMode:function(a){if(!a.inHistory("topology")&&("topology"!==a.getActiveStep().itemId)){SYNO.Debug("wrong usage in isRouterMode");return false}if("router"===a.getStep("topology").getForm().getValues().mode){return true}else{return false}},isClientMode:function(a){if(!a.inHistory("topology")&&("topology"!==a.getActiveStep().itemId)){SYNO.Debug("wrong usage in isCilentMode");return false}if("client"===a.getStep("topology").getForm().getValues().mode){return true}else{return false}},hasSetupNetwork:function(a){if(a.inHistory("topology_conn_direct_link")||("topology_conn_direct_link"===a.getActiveStep().itemId)||a.inHistory("topology_conn_via_router")||("topology_conn_via_router"===a.getActiveStep().itemId)||a.inHistory("topology_conn_bridge")||("topology_conn_bridge"===a.getActiveStep().itemId)){return true}else{return false}},hasSelectPPPoE:function(a,b){if(("pppoe"===a.getStep("topology_conn_direct_link").getForm().getValues().mode)||("pppoe"===a.getStep("topology_conn_via_router").getForm().getValues().mode)||("pppoe"===a.getStep("topology_conn_bridge").getForm().getValues().mode)){return true}else{return false}}});Ext.define("SYNO.SDS.EzInternet.WizardStep.Firewall",{extend:"SYNO.ux.FormPanel",constructor:function(b){this.portInfo=null;this.FwStatus={enable:null,activeProfile:null};this.ifname=null;var a=Ext.apply({headline:_T("ezinternet","ezinternet_firewall_title"),description:_T("ezinternet","ezinternet_firewall_desc"),autoFlexcroll:false,layout:"auto",items:[{xtype:"syno_checkbox",boxLabel:_T("ezinternet","ezinternet_firewall_chkbox"),name:"enable_firewall",itemId:"enable_firewall",checked:true,listeners:{check:function(d,e){var c=this.getGrid().getView().el;return c[e?"unmask":"mask"]()},scope:this}},new SYNO.SDS.AdminCenter.Utils.Dialog.ServPortsGrid({ignoreAdmPorts:true,itemId:"rules",height:250,serverPorts:[]}),{htmlEncode:false,xtype:"syno_displayfield",name:"overwrite_if"}]},b);this.callParent([a])},getGrid:function(){return this.getComponent("rules")},activate:function(){var a=this.owner.getStep("welcome").netenv;this.owner.setHeight(530);if(null===a){SYNO.Debug("netenv is null try to get again");SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.getNetworkEnv.call(this.owner.getStep("welcome"),{getNetworkEnvCallback:this.activateCore,getNetworkEnvCallbackScope:this});SYNO.Debug("wait netenv ready")}else{this.activateCore()}},hasSetPPPoE:function(a,b){if((SYNO.SDS.EzInternet.Utils.CheckUserSelection.prototype.hasSetupNetwork(a)&&SYNO.SDS.EzInternet.Utils.CheckUserSelection.prototype.hasSelectPPPoE(a,b))||SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.isPPPoEConnected(b)){return 1}else{return 0}},activateCore:function(){var b=this.owner.getStep("welcome").netenv;if(null===b){SYNO.Debug("netenv="+b);this.module.appWin.getMsgBox().alert(this.title,_T("common","error_system"));this.module.getButton("next").disable();return}var c=this.getForm().findField("overwrite_if");var a=(1===this.hasSetPPPoE(this.owner,b))?{ifname:b.pppoe.type,type:b.pppoe.type}:{ifname:b.gateif.ifname,type:b.gateif.type};this.ifname=a.ifname;c.setValue(String.format('<div class="red-status" style="{1}">'+_T("ezinternet","ezinternet_firewall_warning")+"</div>",SYNO.SDS.Utils.Network.idToString.call(this,a.ifname,a.type),Ext.isIE?"padding-top: 5px":""));if(!this.FwStatus.enable||!this.FwStatus.activeProfile||!this.portInfo){this.loadFwData()}},loadFwData:function(){this.owner.setStatusBusy({text:_T("common","loading")});this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall",version:1,method:"get"},scope:this,callback:function(b,a){if(!b){this.module.appWin.getMsgBox().alert(_T("tree","leaf_firewall"),SYNO.API.getErrorString(a.code));return}this.FwStatus.enable=a.status;this.FwStatus.activeProfile=a.profile_name;this.getComponent("enable_firewall").setValue(this.FwStatus.enable);this.loadPortInfo()}})},loadPortInfo:function(){this.sendWebAPI({params:{},scope:this,compound:{stopwhenerror:false,params:[{api:"SYNO.Core.Security.Firewall.Adapter",version:1,method:"get",params:{profile_name:this.FwStatus.activeProfile,adapter_name:this.ifname}},{api:"SYNO.Core.Service.PortInfo",method:"load",version:1}]},callback:function(f,c,e){if(f){var g=null;var h=null;var a="";var j="dms_https,dms";var k=j;var b=[];var d=0;for(d=0;d<c.result.size();d++){if("SYNO.Core.Security.Firewall.Adapter"===c.result[d].api){g=c.result[d].data}else{if("SYNO.Core.Service.PortInfo"===c.result[d].api){h=c.result[d].data;if(h&&h.port_info){this.portInfo=h.port_info}}}}if(g&&g.rules){for(d=0;d<g.rules.size();d++){if(("allow"===g.rules[d].policy)&&g.rules[d].enable){if(0<a.length){a+=","}a+=g.rules[d].ports}}}SYNO.SDS.AdminCenter.Utils.Render.ServerPortsParsing(h,this.getGrid().serverPorts,false);if(0<a.length){k+=",";k+=a}this.getGrid().setVal(k);if(this.isDefaultGwIfLANIP()&&(!this.isLocalServicesAllAllowed(b,this.getGrid()))){for(d=0;d<b.size();d++){k+=",";k+=b[d]}}this.getGrid().setVal(k);this.getGrid().setNonEditable(j)}else{this.owner.getMsgBox().alert(_T("common","note"),_T("common","commfail"))}this.owner.clearStatusBusy()}})},getSubmitData:function(){var d={};var f=[];var c=this.getGrid();var b=this.owner.getStep("welcome").netenv;var a=null;var g=null;a=(1===this.hasSetPPPoE(this.owner,b))?b.pppoe.type:b.gateif.ifname;g=this.getForm().findField("enable_firewall");if(!g){SYNO.Debug("[getSubmitData] enable_firewall is null");return{}}if(!g.getValue()){return{enable:false,policy:"allow",adapter:a,rules:[]}}var e={};if(!c){SYNO.Debug("[getSubmitData] grid is null");return{}}e.enable=true;e.name="System Service";e.port_direction="destination";e.port_group="reserved";e.ports=c.getEnabledPorts();e.protocol=c.getEnabledPortsProtocol();e.source_ip_group="all";e.source_ip="all";e.policy="allow";e.log=false;f.push(e);d={enable:true,adapter:a,policy:"drop",rules:f};return d},summary:function(c){var a,d,b=this.getGrid().getStore();var e=null;e=this.getForm().findField("enable_firewall");if(!e||!e.getValue()){c.append(_T("ezinternet","ezinternet_summary_firewall"),_T("common","disabled"));return}c.append(_T("ezinternet","ezinternet_summary_firewall"),_T("common","enabled"));for(a=0;a<b.getCount();a++){if(b.getAt(a).get("enabled")){d=b.getAt(a);c.append("",String.format("{0}({1})",d.get("name"),d.get("desc")))}}return true},appendTask:function(a){var b=this.getSubmitData();if(!b.enable){this.task=a.append(this.getItemId(),_T("ezinternet","ezinternet_apply_firewall"),{api:"SYNO.Core.Security.Firewall",version:1,method:"set",params:{set_type:"disable"},scope:this,callback:function(d,c){if(!d){this.owner.getMsgBox().alert("",_T("firewall","firewall_save_failed"));this.task.doNextTask(false);return false}this.task.doNextTask(true);return false}});return}this.task=a.append(this.getItemId(),_T("ezinternet","ezinternet_apply_firewall"),{api:"SYNO.Core.Security.Firewall.Adapter",version:1,method:"set",params:{profile_name:this.FwStatus.activeProfile,adapter_name:b.adapter,policy:b.policy,rules:b.rules,profile_applying:true},scope:this,callback:this.taskCallback})},taskCallback:function(c,b,a){this.applyProfile(this.FwStatus.activeProfile);return false},applyProfile:function(a){this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",version:1,method:"start",params:{name:a,profile_applying:true}},scope:this,callback:this.pollingApplyStatus})},pollingApplyStatus:function(b,a){if(!b){this.owner.getMsgBox().alert("",_T("firewall","firewall_save_failed"));this.task.doNextTask(false);return}this.polling_id=this.pollReg({interval:1,immediate:true,scope:this,webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",method:"status",params:{task_id:a.task_id},version:1},status_callback:function(f,d,e,c){if(undefined===d.success){return}if(true!==f||true!==d.success){this.stopPollingTask();if(true!==d.success){this.owner.getMsgBox().alert("",SYNO.API.getErrorString(d.error.code));this.task.doNextTask(false);return}}if(true===d.success){this.stopPollingTask();this.task.doNextTask(true)}}})},stopPollingTask:function(){if(null===this.polling_id){return}this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",version:1,method:"stop"},scope:this,callback:function(c,b,a){this.pollUnreg(this.polling_id);this.polling_id=null}})},netCheckerHandler:function(a,c,b){if(b&&b.data&&(true===b.data.save_done)){this.owner.pollUnreg(this.saveStatusPollId);this.saveStatusPollId=null;this.task.doNextTask(true)}return},getNext:function(){var a=[];var b="";if(this.isDefaultGwIfLANIP()&&(!this.isLocalServicesAllAllowed(a,this.getGrid()))){b=this.getFwDisServiceDescStr(a);return this.popWarning(b)}else{return this.nextId}},getFwDisServiceDescStr:function(b){var c="";for(var a=0;a<b.size();a++){c+="<br>";c+=this.getDesc(b[a])}c+="<br>";return c},getDesc:function(b){if(!b){return""}if("findhostd"===b){return"Synology Assistant"}for(var a=0;a<this.portInfo.size();a++){if(b===this.portInfo[a].port_id){return this.portInfo[a].desc}}return b},isLocalServicesAllAllowed:function(f,d){var c=[];var b=0,a=0;var e=["cifs","findhostd","bonjour"];if(!Ext.isArray(f)||(0!==f.size())){SYNO.Debug("[Error] rgDisabledServices wrong type in  isLocalServicesAllAllowed");return true}if(!d){SYNO.Debug("[Error] grid is empty in isLocalServicesAllAllowed");return true}c=d.getValues();if(!c){SYNO.Debug("[Error] grid_items is empty in isLocalServicesAllAllowed");return true}for(b=0;b<c.size();b++){if(c[b]&&!c[b].enabled){for(a=0;a<e.size();a++){if(e[a]===c[b].port_id){f.push(c[b].port_id)}}}}if(0<f.size()){return false}else{return true}},popWarning:function(a){this.owner.getMsgBox().confirm(this.owner.title,String.format(_T("ezinternet","ezinternet_firewall_popwarn"),a,this._D("product")),function(b){if("yes"===b){if(this.nextId){this.owner.goNext(this.nextId,true)}}},this);return false},isDefaultGwIfLANIP:function(){var a=this.owner.getStep("welcome").netenv;var b=a?a.gateway:"";if(!b){return true}if(this.isPrivateIP(b)){return true}else{return false}},isPrivateIP:function(a){return !SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.isPublicIP(a)}});Ext.define("SYNO.SDS.EzInternet.WizardStep.PortForwarding.EmptyStep",{extend:"SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.EmptyStep",constructor:function(a){this.callParent([a])},activate:function(){this.callParent();this.hasRecievedEvent=false;this.mon(this,"disableNextStep",function(){if(!this.hasRecievedEvent){this.hasRecievedEvent=true;this.owner.goBack()}})}});Ext.define("SYNO.SDS.EzInternet.WizardStep.PortForwarding.UPnPStep",{extend:"SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.UPnPStep",constructor:function(a){this.callParent([a])},getNext:function(){this.callParent();return this.nextId}});Ext.define("SYNO.SDS.EzInternet.WizardStep.PortForwarding.PortFWStep",{extend:"SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortFWStep",constructor:function(a){this.callParent([a])},activate:function(){this.callParent()},getNext:function(){this.callParent();return false}});Ext.define("SYNO.SDS.EzInternet.WizardStep.PortForwarding.NatpmpStep",{extend:"SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.NatpmpStep",constructor:function(a){this.callParent([a])},getNext:function(){this.callParent();return this.nextId}});Ext.define("SYNO.SDS.EzInternet.WizardStep.PortForwarding.TestStep",{extend:"SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.TestStep",constructor:function(a){this.callParent([a])},getNext:function(){this.callParent();return false}});Ext.define("SYNO.SDS.EzInternet.WizardStep.PortForwarding.ServiceRuleStep",{extend:"SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ServiceRuleStepAbstract",constructor:function(a){this.callParent([a]);this.rule_store=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleStore({owner:a.owner,grid:this,listeners:[]});this.saveRuleErrorHandlerRetry=5},activate:function(){if(!this.serviceDescObj.hasInitialized()){this.owner.setStatusBusy();this.serviceDescObj.initAsync(function(){this.owner.clearStatusBusy();this.grid.getStore().loadData(this.serviceDescObj.getPortInfoArrayData(),false);this.activateCore()}.bind(this))}else{this.activateCore()}},activateCore:function(){this.rule_store.loadData([],false);this.rule_store.commitChanges();this.setDefault();this.grid.getColumnModel().setEditable(4,this.isSupportChangePort);if(!this.isSupportChangePort){this.grid.getStore().each(function(a){a.set("router_ports",a.get("dst_port"))})}},setDefault:function(){var a=["http","dms"];var e;var d=0,c=0;var b=this.grid.getStore();for(d=0;d<this.grid.store.getCount();d++){for(c=0;c<a.size();c++){e=b.getAt(d);if(a[c]===e.get("port_id").toString()){e.set("enabled",true)}}}this.grid.getStore().commitChanges()},loadUsedPorts:SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.AddRuleWizard.prototype.loadUsedPorts,addSystemRules:SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.AddRuleWizard.prototype.addSystemRules,getUniqueId:SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.AddRuleWizard.prototype.getUniqueId,isRuleIdInStore:SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.AddRuleWizard.prototype.isRuleIdInStore,getConflictInfo:SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.AddRuleWizard.prototype.getConflictInfo,createConflictInfo:SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.AddRuleWizard.prototype.createConflictInfo,getConflictPorts:SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.AddRuleWizard.prototype.getConflictPorts,getNext:function(){this.grid.stopEditing();if(this.addSystemRules(this.grid.getStore())){return this.nextId}else{return false}},summary:function(c){var a,b=this.rule_store;var f=_T("ezinternet","ezinternet_summary_portfwd");var e=null;if(0===b.getCount()){c.append(f,String.format("({0})",_T("system","none_opt")));return}for(a=0;a<b.getCount();a++){var d;e=b.getAt(a);if(!e.get("enable")){continue}d=e.get("serviceid").desc;c.append(f,String.format("{0}({1})",d,e.get("ds_port")));if(f){f=""}}},appendTask:function(a){this.task=a.append(this.getItemId(),_T("ezinternet","ezinternet_apply_portfwd"),{api:"SYNO.Core.PortForwarding.Rules",version:1,method:"save",params:{rules:this.rule_store.getRules()},callback:this.saveRuleCallBack,scope:this})},toSaveRuleErrorStringWithData:SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleGrid.prototype.toSaveRuleErrorStringWithData,saveRuleErrorHandler:function(a,d){var b=1501;var c="";if(a===b){this.saveRuleErrorHandlerRetry--;if(0>this.saveRuleErrorHandlerRetry){this.saveRulePollStop();c=this.toSaveRuleErrorStringWithData(a,d);this.owner.getMsgBox().alert(this.title,c)}}else{c=this.toSaveRuleErrorStringWithData(a,d);this.saveRulePollStop();this.owner.getMsgBox().alert(this.title,c)}},saveRulePollStop:function(){this.owner.pollUnreg(this.saveStatusPollId);this.saveStatusPollId=null;this.saveRuleErrorHandlerRetry=5},saveRuleCallBack:function(c,b,a){this.saveStatusConf={interval:1,immediate:false,webapi:{api:"SYNO.Core.PortForwarding.Rules",version:1,method:"save_status",params:{task_id:b.task_id}},status_callback:function(g,f,e,d){if(!g){this.saveRuleErrorHandler(f.code,f);this.task.doNextTask(false);return}this.applyHandler(d,g,f)},scope:this};this.saveStatusPollId=this.owner.pollReg(this.saveStatusConf);return false},reportFailure:function(a){if(a.alert){this.owner.getMsgBox().alert(this.title,a.text)}else{this.owner.setStatusError(a)}return false},showAdminCenterPortforwardPage:function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.PublicAccess.Main",tab:"portforwardingtab"})},applyHandler:function(b,e,d){if("success"!==d.status){return}else{var c=this.task.store.get(this.getItemId()).data.text;this.owner.pollUnreg(this.saveStatusPollId);this.saveStatusPollId=null;this.task.doNextTask(true);if(d.port_status&&0<d.port_status.length){var f=Ext.id();var a=null;this.task.store.get(this.getItemId()).set("text",c+" "+String.format('<span class="green-status">('+_T("routerconf","port_conflict_on_router")+")</span>",'<span class="blue-status" id="'+f+'">',"</span>"));a=Ext.get(f);a.on("click",this.showAdminCenterPortforwardPage)}}}});Ext.define("SYNO.SDS.EzInternet.Util.EnableRadioGroup",{extend:"SYNO.ux.Utils.EnableRadioGroup",constructor:function(e,b,a,d,c){this.callParent(arguments);this.buttons=d;this.callbacks=c},radioHandler:function(b,d){var g=b.getInputValue();if(g&&d){if(this.buttons){var f=this.buttons[g].enable;var e=this.buttons[g].disable;Ext.each(f,function(h){var i=this.form.owner.getButton(h);if(i){i.enable()}},this);Ext.each(e,function(h){var i=this.form.owner.getButton(h);if(i){i.disable()}},this)}if(this.callbacks){var c=this.callbacks[g].scope;var a=this.callbacks[g].cb;if(c&&a){a.call(c)}}}},onRadioEnable:function(a){this.callParent(arguments);this.radioHandler(a,undefined)},onRadioCheck:function(a,b){this.callParent(arguments);this.radioHandler(a,b)}});Ext.define("SYNO.SDS.EzInternet.WizardStep.DDNSOpt",{extend:"SYNO.ux.FormPanel",constructor:function(c){var b=200;var a=Ext.apply({headline:_T("ezinternet","ezinternet_ddns_opt_title"),description:_T("ezinternet","ezinternet_ddns_opt_desc"),autoFlexcroll:false,items:[{xtype:"syno_radio",boxLabel:String.format(_T("service","service_ddns_account_login"),"Synology"),name:"opt",checked:true,inputValue:"nonskip"},{fieldLabel:_T("service","service_ddns_hostname"),xtype:"syno_compositefield",indent:1,itemId:"register_hostname_domain",items:[{xtype:"syno_textfield",name:"register_hostname",allowBlank:false,minLength:2,maxLength:24,width:b,vtype:"shorthostname",enableKeyEvents:true,listeners:{scope:this,keyup:function(){this.checkValid()}}},{xtype:"syno_displayfield",width:5,value:"."},{xtype:"syno_combobox",name:"ddns_domain_list",allowBlank:false,valueField:"value",displayField:"display",width:b,value:"synology.me",store:new Ext.data.JsonStore({autoDestroy:true,fields:["value","display"],data:[]})}]},{htmlEncode:false,xtype:"syno_displayfield",indent:1,itemId:"mydsAccount",value:'<a class="link-font" href="javascript: void(0)">'+_T("myds","login_or_register_myds_account")+"</a>",fieldLabel:_T("service","service_ddns_username")+"/"+_T("service","service_ddns_email")},{htmlEncode:false,xtype:"syno_checkbox",indent:1,name:"register_tos",boxLabel:_T("service","service_ddns_syno_tos"),checked:false},{xtype:"syno_radio",boxLabel:_T("ezinternet","ezinternet_ddns_opt_skip"),name:"opt",inputValue:"skip"}]},c);this.callParent([a])},getRecordAndMyDsAccount:function(){this.getInfoArray=[{api:"SYNO.Core.DDNS.Record",version:1,method:"list"},{api:"SYNO.Core.DDNS.Synology",version:1,method:"get_myds_account"},{api:"SYNO.Core.DDNS.ExtIP",version:1,method:"list"}];this.owner.setStatusBusy();this.owner.sendWebAPI({params:{},scope:this,compound:{stopwhenerror:false,params:this.getInfoArray},callback:this.getRecordAndMyDsAccountCB})},setToBeModifiedRecord:function(a){this.toBeModifiedRecord=a},getToBeModifiedRecord:function(){return this.toBeModifiedRecord},getRecordAndMyDsAccountCB:function(l,d,h){var e=0;var c=0;var f=-1;var m=this.getForm().findField("register_hostname");var g=this.getForm().findField("ddns_domain_list");var k=this.getForm().findField("mydsAccount");this.owner.clearStatusBusy();this.myDSAccountLogin=false;this.myDSAccount="NO_MY_DS_ACCOUNT";for(e=0;e<d.result.length;e++){if(!d.result[e].success){continue}if(SYNO.ux.Utils.checkApiConsistency(d.result[e],this.getInfoArray[0])){this.allSynologyRecords=[];this.setToBeModifiedRecord(null);if(0>=d.result[e].data.records.length){continue}var a=d.result[e].data.records;for(c=0;c<a.length;c++){if("Synology"===d.result[e].data.records[c].provider){this.allSynologyRecords.push(d.result[e].data.records[c]);break}}this.setToBeModifiedRecord(this.allSynologyRecords[0]);if(0===this.allSynologyRecords.length){continue}if(!this.domainList||!this.domainList.store||!this.domainList.store.data||!this.domainList.store.data.length){this.owner.getMsgBox().alert(this.title,_T("common","error_system"));SYNO.Debug("this.domainList.store.data.length is not valid");return}var b=this.getToBeModifiedRecord();for(c=0;c<this.domainList.store.data.length;c++){f=b.hostname.lastIndexOf(this.domainList.store.getAt(c).data.value);if(0<=f){break}}if(0>f){this.owner.getMsgBox().alert(this.title,_T("common","error_system"));SYNO.Debug("can not find lastIndex");return}if(!this.hostName||!this.domainName){this.domainName=b.hostname.substring(f);this.hostName=b.hostname.substring(0,f-1);if(!m||!g){this.owner.getMsgBox().alert(this.title,_T("common","error_system"));SYNO.Debug("can not get hsotnameFiled or this.domainListCombobox");return}m.setValue(this.hostName);g.setValue(this.domainName)}}else{if(SYNO.ux.Utils.checkApiConsistency(d.result[e],this.getInfoArray[1])){if(this.myDSAccount!==d.result[e].data.email){this.myDSAccountLogin=true;this.myDSAccount=d.result[e].data.email;if(!k){this.owner.getMsgBox().alert(this.title,_T("common","error_system"));SYNO.Debug("can not get mydsAccountField");return}this.munMyDsAccountClick()}else{this.myDSAccountLogin=false;this.myDSAccount='<a class="link-font" href="javascript: void(0)">'+_T("myds","login_or_register_myds_account")+"</a>";this.monMyDsAccountClick()}k.setValue(this.myDSAccount)}else{if(SYNO.ux.Utils.checkApiConsistency(d.result[e],this.getInfoArray[2])){for(c=0;c<d.result[e].data.length;c++){if("WAN"==d.result[e].data[c].type){this.ipAddrs=d.result[e].data[c];break}}}}}}this.checkValid()},monMyDsAccountClick:function(){var a=this.getForm().findField("mydsAccount");if(a){a.getEl().on("click",this.myDsAccountClickHandler,this)}},myDsAccountClickHandler:function(){var a=new SYNO.SDS.MyDSCenter.LoginDialog({owner:this.findWindow(),listeners:{scope:this,login_success:this.getRecordAndMyDsAccount}});a.show()},munMyDsAccountClick:function(){var a=this.getForm().findField("mydsAccount");if(a){a.getEl().un("click",this.myDsAccountClickHandler,this)}},isValid:function(){var b=this.getForm().isValid();var a=this.getForm().findField("register_tos");if(!a){this.owner.getMsgBox().alert(this.title,_T("common","error_system"));SYNO.Debug("can not get checkTOS");return false}if(this.selectSkip){return true}else{return(a.getValue()&&b&&this.myDSAccountLogin)}},checkValid:function(){if(!this.isValid()){this.owner.getButton("next").disable()}else{this.owner.getButton("next").enable()}},checkValidAndLogNonSkip:function(){this.logNonSkip();this.checkValid()},checkValidAndLogSkip:function(){this.logSkip();this.checkValid()},logSkip:function(){this.selectSkip=true},logNonSkip:function(){this.selectSkip=false},activate:function(){if("yes"!==this._D("supportddns")){this.owner.goNext(this.nextId[1],false);return false}var b=new SYNO.SDS.EzInternet.Util.EnableRadioGroup(this.getForm(),"opt",{nonskip:["register_hostname_domain","mydsAccount","register_tos"],skip:[]},{nonskip:{enable:[],disable:[]},skip:{enable:["next"],disable:[]}},{nonskip:{scope:this,cb:this.checkValidAndLogNonSkip},skip:{scope:this,cb:this.checkValidAndLogSkip}});b=null;var a=this.getForm().findField("register_tos");if(a){a.mon(a,"check",function(d,c){this.checkValid()},this)}this.loadDomainList();this.getRecordAndMyDsAccount();return true},loadDomainList:function(){this.domainList=this.getForm().findField("ddns_domain_list");SYNO.SDS.AdminCenter.PublicAccess.DDNSRecordDialog.prototype.getDomainList.call(this)},isInputHostNameExisted:function(){var d=this.getForm().findField("register_hostname");var c=this.getForm().findField("ddns_domain_list");if(!d||!c){this.owner.getMsgBox().alert(this.title,_T("common","error_system"));SYNO.Debug("can not get hostNameField or domainListCombobox");return false}if(!this.allSynologyRecords||(0===this.allSynologyRecords.length)){this.owner.getMsgBox().alert(this.title,_T("common","error_system"));SYNO.Debug("this.allRecords has not init");return false}var a=d.getValue()+"."+c.getValue();for(var b=0;b<this.allSynologyRecords.length;b++){if(a===this.allSynologyRecords[b].hostname){return true}}return false},getRecordAction:function(){if(!this.allSynologyRecords||(0===this.allSynologyRecords.length)){return"create"}return"set"},getNext:function(){var a=this.getRecordAction();if(!this.selectSkip&&a&&("set"===a)&&!this.isInputHostNameExisted()){this.owner.getMsgBox().confirm(this.title,_T("ezinternet","confirm_change_ddns_hostname"),function(c,b,d){if("yes"===c){this.owner.goNext(this.nextId,true)}},this)}else{this.owner.goNext(this.nextId,true)}return false},summary:function(c){var b=this.getForm();var a=function(d){return b.findField(d).getValue()};c.append(_T("ezinternet","ezinternet_summary_ddns"),"");if(this.selectSkip){c.appendSub(_T("common","skip"))}else{c.appendSub(_T("service","service_ddns_hostname"),a("register_hostname")+"."+a("ddns_domain_list"));c.appendSub(_T("service","service_ddns_email"),a("mydsAccount"))}},appendTask:function(i){if(this.selectSkip){return}this.apiParams=[];var f=_T("ezinternet","ezinternet_apply_ddns_use").replace("__PROVIDER__","Synology");var l=this.getForm().findField("register_hostname");var h=this.getForm().findField("ddns_domain_list");var g=this.getForm().findField("mydsAccount");if(!l||!h||!g){this.owner.getMsgBox().alert(this.title,_T("common","error_system"));SYNO.Debug("can not get hostNameField or domainListCombobox");return false}var j=l.getValue()+"."+h.getValue();var b=g.getValue();var e=this.getRecordAction();var a=null;if("set"===e){var m=this.getToBeModifiedRecord();if(!m){this.owner.getMsgBox().alert(this.title,_T("common","error_system"));SYNO.Debug("can not get toBeModifiedRecord");return false}a=m.id}var k={api:"SYNO.Core.DDNS.Synology",version:1,method:"register_hostname",params:{hostname:j,ip:this.ipAddrs.ip,ipv6:this.ipAddrs.ipv6,heartbeat:true,forced_update:true}};var d={api:"SYNO.Core.DDNS.Record",version:1,method:e,params:{id:a,enable:true,provider:"Synology",hostname:j,username:b,passwd:"Synology",net:"DEFAULT",ip:this.ipAddrs.ip,ipv6:this.ipAddrs.ipv6,heartbeat:true}};var c={api:"SYNO.Core.DDNS.Record",version:1,method:"update_ip_address",params:{id:a?a:"Synology"}};this.apiParams.push(k);this.apiParams.push(d);this.apiParams.push(c);this.task=i.append(this.getItemId(),f,{params:{},scope:this,compound:{stopwhenerror:true,params:this.apiParams},callback:this.doActionDone})},getErrorString:SYNO.SDS.AdminCenter.PublicAccess.DDNSRecordDialog.prototype.getErrorString,doActionDone:function(e,c,b){var d="";for(var a=0;a<c.result.length;a++){if(!c.result[a].success){d=this.getErrorString(c.result[a].error.errors,b.compound[a].hostname);this.owner.getMsgBox().alert(_T("tree","leaf_wanconfig"),d);this.task.doNextTask(false);return false}}this.task.doNextTask(true);return false}});SYNO.SDS.EzInternet.Wizard=Ext.extend(SYNO.SDS.Wizard.AppWindow,{next_step:null,EZINTERNET_HEIGHT:450,constructor:function(c){var a=SYNO.SDS.EzInternet.WizardStep;var d=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.ServiceName(this,this);var b=[new a.WelcomeStep({itemId:"welcome",nextId:["topology","connopt"],height:this.EZINTERNET_HEIGHT}),new a.TopologyOpt({itemId:"topology",nextId:["topology_conn_bridge","topology_conn_direct_link","topology_conn_via_router"],height:this.EZINTERNET_HEIGHT}),new a.ConnectOpt({itemId:"connopt",nextId:["topology_conn_direct_link","topology_conn_via_router"]}),new a.TopologyConnectOptBridge({itemId:"topology_conn_bridge",nextId:["firewall","router_empty"]}),new a.TopologyConnectOptViaRouter({itemId:"topology_conn_via_router",nextId:["firewall","router_empty"]}),new a.TopologyConnectOptDirectlink({itemId:"topology_conn_direct_link",nextId:["firewall","router_empty"]}),new a.Firewall({itemId:"firewall",nextId:"ddnsopt"}),new a.PortForwarding.EmptyStep({owner:this,itemId:"router_empty",iface:null,nextId:["upnpform","natpmpform","portfwform","radioform"]}),new a.PortForwarding.UPnPStep({owner:this,itemId:"upnpform",nextId:"portfwd"}),new a.PortForwarding.PortFWStep({owner:this,itemId:"portfwform",nextId:"portfwd"}),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RadioStep({itemId:"uradioform",nextId:["upnpform","portfwform"]}),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RadioStep({itemId:"radioform",nextId:["testform","portfwform"]}),new a.PortForwarding.NatpmpStep({itemId:"natpmpform",owner:this,nextId:"portfwd"}),new a.PortForwarding.TestStep({itemId:"testform",owner:this,nextId:"portfwform"}),new a.PortForwarding.ServiceRuleStep({itemId:"portfwd",nextId:"ddnsopt",owner:this,serviceDescObj:d}),new a.DDNSOpt({itemId:"ddnsopt",nextId:"summary",owner:this}),new SYNO.SDS.Wizard.SummaryStep({itemId:"summary",nextId:"apply",showCommitButton:true}),new SYNO.SDS.Wizard.ApplyStep({itemId:"apply",nextId:null})];SYNO.SDS.EzInternet.Wizard.superclass.constructor.call(this,Ext.apply({title:_T("ezinternet","ezinternet_wizard_title"),showHelp:false,dsmStyle:"v5",cls:"syno-ezinternet",width:700,height:this.EZINTERNET_HEIGHT,steps:b},c))},onOpen:function(){var a=["upnpform","natpmpform","portfwform","testform"];for(var b=0;b<a.size();b++){this.getStep(a[b]).blNotCloseWhenFinish=true}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.EzInternet",version:1,method:"get",params:{type:"step",remove:true},callback:function(l,d,h){var m=d;this.clearStatusBusy();SYNO.SDS.EzInternet.Wizard.superclass.onOpen.apply(this,arguments);if(m&&m.next_step){var f,g;var j=true;var c=m.next_step.split(",");for(f=0;f<c.size();f++){if(!this.getStep(c[f])){j=false;this.stepStack=[];return}this.stepStack.push(c[f])}if(!j){return false}g=this.stepStack.pop();SYNO.Debug("App setActiveStep("+g+")");var e=this;var k=function(){SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.getNetworkEnv.call(e.getStep("welcome"),{getNetworkEnvCallback:e.getNetworkEnvCallback,getNetworkEnvCallbackScope:e,getNetworkEnvCallbackArgument:g})};SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.checkTopologySwitching.call(e.getStep("welcome"),k)}},scope:this})},reportFailure:function(b){var a=b||{};var c=a.msg||_T("common","loadsetting_fail");c+="<br><br>"+_T("common","reload_res")+"?";this.getMsgBox().confirm(this.title,c,function(e,d,f){if("yes"===e&&Ext.isFunction(a.yesfn)){a.yesfn.apply(a.scope||this,a.args||[])}else{if("no"===e&&Ext.isFunction(a.nofn)){a.nofn.apply(a.scope||this,a.args||[])}}},this);return false},getNetworkEnvCallback:function(a,b){if(!a){SYNO.Debug("SYNO.SDS.EzInternet.Wizard getNetworkEnvCallback failed due to no netenv")}if(!b){SYNO.Debug("SYNO.SDS.EzInternet.Wizard getNetworkEnvCallback failed due to no active step")}if("router_empty"===b){if(!a.gateif){SYNO.Debug("SYNO.SDS.EzInternet.Wizard getNetworkEnvCallback failed due to no netenv.gateif")}this.getStep("router_empty").iface=a.gateif}this.goNext(b,false)},setNextStep:function(a,c){if(0>this.stepStack.indexOf(a)){this.stepStack.push(a)}if(Ext.isString(c)){this.stepStack.push(c)}var b=this.stepStack.toString();SYNO.Debug("step is "+b);this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.EzInternet",version:1,method:"set",params:{type:"step",step:b},callback:function(g,f,e){var d=f;this.clearStatusBusy();if(d&&d.next_step){SYNO.Debug("set next step of ezinternet as "+d.next_step)}return},scope:this})},waitingBox:function(e){var f=e.times||10;var b=f;var a=Ext.isDefined(e.no_close)?e.no_close:true;var c=e.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:e.title||this.title,width:e.width||240,progress:true,closable:false});var d=function(){b--;if(0===b&&!a){if(Ext.isFunction(e.callback)){e.callback.call(e.scope||this)}SYNO.SDS.Desktop.getMsgBox().hide();return}if(0===b){b=f}SYNO.SDS.Desktop.getMsgBox().updateProgress(1-b/f,_T("tcpip","connect_new_ip"));d.defer(c,this)};d.defer(c,this)},redirect:function(b,d){var c=d||20000;var a=0;if(!Ext.isString(b.auth_key)||!Ext.isArray(b.ip_list)){return}SYNO.SDS.StatusNotifier.fireEvent("redirect");window.onbeforeunload=null;var e=function(f){SYNO.Debug("try "+b.ip_list[f%b.ip_list.length]);if(b.secure){window.location="https://"+b.ip_list[f%b.ip_list.length]+":"+b.port+"/webman/index.cgi?auth_key="+b.auth_key}else{window.location="http://"+b.ip_list[f%b.ip_list.length]+":"+b.port+"/webman/index.cgi?auth_key="+b.auth_key}};e.defer(c,this,[0]);for(a=0;a<3;a++){c+=10000;e.defer(c,this,[0])}for(a=1;a<=b.ip_list.length;a++){c+=10000;e.defer(c,this,[a])}this.waitingBox({times:c/1000,msg:_T("tcpip","connect_new_ip")});return}});Ext.define("SYNO.SDS.EzInternet.WizardStep.ConnectOpt",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a=Ext.apply({headline:_T("setupwizard","netinfo_title"),description:_T("ezinternet","ezinternet_how_to_network"),autoFlexcroll:false,trackResetOnLoad:true},b);this.mode_id=[];a.items=this.getItems();this.callParent([a])},getItems:function(){var a=[];a.push({xtype:"syno_radio",boxLabel:_T("ezinternet","ezinternet_router_conn_short"),name:"mode",inputValue:"by_router",checked:true,itemId:this.mode_id.by_router=Ext.id()});a.push({xtype:"syno_displayfield",indent:1,value:_T("ezinternet","ezinternet_router_conn_long_1"),itemId:this.mode_id.by_router_desc=Ext.id()});a.push({xtype:"syno_displayfield",indent:1,cls:"wrapper-ez-4",width:552,height:80});a.push({xtype:"syno_radio",boxLabel:_T("ezinternet","ezinternet_direct_conn_short_1"),name:"mode",inputValue:"direct",itemId:this.mode_id.direct=Ext.id()});a.push({xtype:"syno_displayfield",indent:1,value:_T("ezinternet","ezinternet_direct_conn_long_1"),itemId:this.mode_id.direct_desc=Ext.id()});a.push({xtype:"syno_displayfield",indent:1,cls:"wrapper-ez-5",width:552,height:80});return a},activate:function(){var a=this.owner.getStep("welcome").netenv;var b=this.owner.getStep("welcome").test_internet;this.owner.clearStatusBusy();this.owner.setHeight(530);if(b){if(SYNO.SDS.EzInternet.Utils.Flow.prototype.isDefaultInterfacePublicIP(a)){if(SYNO.SDS.EzInternet.Utils.Flow.prototype.isDefaultGatewayUSBModemDongle(a)){this.owner.goNext("ddnsopt",false);return}else{this.owner.goNext("firewall",false);return}}}},getNext:function(){return SYNO.SDS.EzInternet.Utils.CheckUserSelection.prototype.isViaRouter(this.owner)?"topology_conn_via_router":"topology_conn_direct_link"},ajaxErrorHandler:function(a){this.owner.getMsgBox().alert(this.title,a)},summary:function(b){var c={direct:_T("ezinternet","ezinternet_direct_conn_short"),by_router:_T("ezinternet","ezinternet_router_conn_short")};var a=this.getForm().getValues().mode;b.append(_T("inetwizard","summary_conn"),c[a]);return true}});Ext.define("SYNO.SDS.EzInternet.WizardStep.TopologyOpt",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a=Ext.apply({headline:_T("network","network_topology_configuration"),description:_T("network","network_topology_selection"),trackResetOnLoad:true,autoFlexcroll:true},b);this.mode_id={bridge:"",router:"",client:""};a.items=this.getItems();this.callParent([a])},getItems:function(){var a=[];a.push({xtype:"syno_radio",boxLabel:_T("network","network_topology_ap"),name:"mode",inputValue:"bridge",checked:true,itemId:this.mode_id.bridge=Ext.id()});a.push({xtype:"syno_displayfield",indent:1,value:_T("network","network_topology_ap_desc")});a.push({xtype:"syno_displayfield",indent:1,cls:"wrapper-ez-1",width:552,height:80});a.push({xtype:"syno_radio",boxLabel:_T("network","network_topology_router"),name:"mode",inputValue:"router",itemId:this.mode_id.router=Ext.id()});a.push({xtype:"syno_displayfield",indent:1,value:_T("network","network_topology_router_desc")});a.push({xtype:"syno_displayfield",indent:1,cls:"wrapper-ez-2",width:552,height:80});a.push({htmlEncode:false,xtype:"syno_displayfield",indent:1,value:'<span class="blue-status">'+_T("ezinternet","ezinternet_mode_selection_sta")+"</span>",itemId:this.mode_selection_sta_desc_id=Ext.id()});a.push({xtype:"syno_radio",boxLabel:_T("network","network_topology_sta"),name:"mode",inputValue:"client",itemId:this.mode_id.client=Ext.id()});a.push({xtype:"syno_displayfield",indent:1,value:_T("network","network_topology_sta_desc"),itemId:this.network_topology_sta_desc_id=Ext.id()});a.push({xtype:"syno_displayfield",indent:1,cls:"wrapper-ez-3",width:552,height:80,itemId:this.network_topology_sta_graph_id=Ext.id()});return a},activate:function(){var a=this.owner.getStep("welcome").netenv;var b=this.owner.getStep("welcome").test_internet;this.isNeedSta=this.isNeedShowStaMode();this.getForm().setValues({mode:SYNO.SDS.EzInternet.Utils.Topology.prototype.getMode(a)});if(this.isNeedSta){this.owner.setHeight(550);this.getComponent(this.mode_selection_sta_desc_id).setVisible(false)}else{this.owner.setHeight(550);this.getComponent(this.mode_id.client).setVisible(false);this.getComponent(this.network_topology_sta_desc_id).setVisible(false);this.getComponent(this.network_topology_sta_graph_id).setVisible(false)}this.resetSuggestTopology();if(b&&SYNO.SDS.EzInternet.Utils.Flow.prototype.isDefaultInterfacePublicIP(a)){this.owner.goNext("firewall",false)}else{this.setSuggestTopology(a.topology)}},resetSuggestTopology:function(){this.suggestRadioLabel(this.mode_id.bridge,false);this.suggestRadioLabel(this.mode_id.router,false);if(this.isNeedShowStaMode()){this.suggestRadioLabel(this.mode_id.client,false)}},isNeedShowStaMode:function(){var a=this.owner.getStep("welcome").netenv;return(SYNO.SDS.EzInternet.Utils.Topology.prototype.isClientMode(a)&&SYNO.SDS.EzInternet.Utils.Topology.prototype.isAnyClientModeEnabled(a))},setSuggestTopology:function(a){if(!SYNO.SDS.EzInternet.Utils.Topology.prototype.isAnyClientModeEnabled(this.owner.getStep("welcome").netenv)&&SYNO.SDS.EzInternet.Utils.Topology.prototype.isClientMode(this.owner.getStep("welcome").netenv)){this.suggestRadioLabel(this.mode_id.bridge,true);this.getComponent(this.mode_id.bridge).setValue(true)}else{if(a in this.mode_id){this.suggestRadioLabel(this.mode_id[a],true);this.getComponent(this.mode_id[a]).setValue(true)}}},suggestRadioLabel:function(c,a){var b=this.getComponent(c);this.getComponent(c).boxlabelEl.update(b.boxLabel+(a?" ("+_T("common","recommend")+")":""))},getNext:function(){if(!this.getForm().isDirty()){this.owner.setHeight(this.height);return this.getNextId()}this.owner.setStatusBusy({text:_T("common","saving")});var a=this;SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.checkTopologySwitching.call(this,function(){a.applyTopology()});return false},applyTopology:function(){var a=this.getForm().getValues().mode;SYNO.SDS.UserSettings.setProperty("Desktop","restoreParams",Ext.apply({className:"SYNO.SDS.EzInternet.Instance",params:this.owner.getStateParam()}),true);this.owner.sendWebAPI({api:"SYNO.Core.Network.Router.Topology",version:1,method:"set",params:{net_topology:a},scope:this,callback:this.applyHandler})},applyHandler:function(f,e,c){var d=40;var a=this.owner.getStep("welcome").netenv;var h=this;if(!f){SYNO.SDS.UserSettings.removeProperty("Desktop","restoreParams",true);if(e&&e.code&&4340===e.code){SYNO.Debug("topology is not ready, try to set toplogy again after 10 sec");var g=function(){h.applyTopology.call(h)};setTimeout(g,10000)}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(this.title,_T("common","error_system"));this.owner.setHeight(this.height);this.owner.goNext(this.getNextId(),true)}return}this.owner.clearStatusBusy();a.topology=this.getForm().getValues().mode;var b=function(){var i=function(){h.owner.clearStatusBusy();h.owner.setHeight(h.height);h.owner.goNext(h.getNextId(),true);SYNO.SDS.UserSettings.removeProperty("Desktop","restoreParams",true)};h.owner.setStatusBusy();SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.checkTopologySwitching.call(h,i)};if(e&&e.redirect){this.owner.setNextStep(this.itemId,this.getNextId());this.owner.redirect(e)}else{this.owner.waitingBox({times:d,no_close:false,callback:b,scope:this})}},getNextId:function(){if(SYNO.SDS.EzInternet.Utils.CheckUserSelection.prototype.isBridgeMode(this.owner)){return this.nextId[0]}else{if(SYNO.SDS.EzInternet.Utils.CheckUserSelection.prototype.isRouterMode(this.owner)){return this.nextId[1]}else{return this.nextId[2]}}},ajaxErrorHandler:function(a){this.owner.getMsgBox().alert(this.title,a)}});Ext.define("SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets",{extend:"Object",manualIpField:{xtype:"syno_textfield",fieldLabel:_T("tcpip","tcpip_ipaddr"),name:"ip",indent:1,allowBlank:false,itemId:"manual_ip",vtype:"ip"},manualNetmaskField:{xtype:"syno_textfield",fieldLabel:_T("tcpip","tcpip_mask"),name:"mask",indent:1,allowBlank:false,vtype:"netmask",itemId:"manual_netmask"},manualGatewayField:{xtype:"syno_textfield",fieldLabel:_T("tcpip","tcpip_gateway"),name:"gateway",indent:1,itemId:"manual_gateway",validator:function(h){var d=this.ownerCt.getForm().findField("manual_ip").value;var f=h;var b=this.ownerCt.getForm().findField("manual_netmask").value;var a=Ext.form.VTypes.ip(d);if(!a){return Ext.form.VTypes.ipText}if(!SYNO.SDS.Utils.Network.GatewayMatchIP(d,f,b)){return _T("common","error_notmatch")}var g=false;var c=this.ownerCt.owner.getStep("welcome").netenv;for(var e=0;e<c.interfaces.size();e++){if(SYNO.SDS.Utils.Network.GatewayMatchIP(f,c.interfaces[e].ip,b)){g=true;break}}if(!g){return _T("common","error_badgate")}return true}},manualDnsField:{xtype:"syno_textfield",fieldLabel:_T("tcpip","tcpip_dns1"),name:"dns",indent:1,vtype:("yes"===_D("ipv4only"))?"v4ip":"ip",itemId:"manual_dns"},getThroughRouterComponents:function(){return[{xtype:"syno_radio",boxLabel:_T("ezinternet","ezinternet_specify_manual_private_ip"),name:"mode",inputValue:"manual",checked:false,id:this.manualRadio=Ext.id(),itemId:"manual_radio"},SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.manualIpField,SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.manualNetmaskField,SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.manualGatewayField,SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.manualDnsField,{xtype:"syno_radio",boxLabel:_T("ezinternet","ezinternet_setup_pppoe_connection"),name:"mode",inputValue:"pppoe",id:this.pppoeRadio=Ext.id(),itemId:"pppoe_radio"},{htmlEncode:false,xtype:"syno_displayfield",indent:1,value:'<span class="note-font">'+_T("common","note")+"</span> : "+_T("ezinternet","pppoe_warn_router_passthrough"),itemId:"pppoe_relay_warn"},{xtype:"syno_textfield",fieldLabel:_T("pppoe","pppoe_username"),name:"username",indent:1,allowBlank:false,itemId:"pppoe_username"},{xtype:"syno_textfield",textType:"password",fieldLabel:_T("pppoe","pppoe_password"),name:"password",indent:1,itemId:"pppoe_password"}]},getDirectlinkComponents:function(){return[{xtype:"syno_radio",boxLabel:_T("ezinternet","ezinternet_setup_pppoe_connection"),name:"mode",inputValue:"pppoe",id:this.pppoeRadio=Ext.id(),itemId:"pppoe_radio"},{xtype:"syno_combobox",fieldLabel:_T("tcpip","tcpip_lan_port"),name:"real_ifname",indent:1,editable:false,store:new Ext.data.SimpleStore({fields:["ifname","ifstring"],data:[]}),displayField:"ifstring",valueField:"ifname",hidden:true},{xtype:"syno_textfield",fieldLabel:_T("pppoe","pppoe_username"),name:"username",indent:1,allowBlank:false,itemId:"pppoe_username"},{xtype:"syno_textfield",textType:"password",fieldLabel:_T("pppoe","pppoe_password"),name:"password",indent:1,itemId:"pppoe_password"},{xtype:"syno_radio",boxLabel:_T("ezinternet","ezinternet_specify_manual_public_ip"),name:"mode",inputValue:"manual",checked:false,id:this.manualRadio=Ext.id(),itemId:"manual_radio"},SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.manualIpField,SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.manualNetmaskField,SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.manualGatewayField,SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.manualDnsField,{xtype:"syno_radio",boxLabel:_T("tcpip","tcpip_dhcp"),name:"mode",inputValue:"dhcp",checked:true,itemId:"dhcp_radio"}]}});Ext.define("SYNO.SDS.EzInternet.WizardStep.TopologyConnectOpt",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.netenv=null;a.autoFlexcroll=false;this.hasLoaded=false;this.callParent([a])},activate:function(){var a=this.owner.getStep("welcome").netenv;this.owner.setHeight(550);if(null===a){SYNO.Debug("netenv="+a);this.owner.getMsgBox().alert(this.title,_T("common","error_system"));this.owner.getButton("next").disable();return}this.owner.getButton("next").enable();if(!this.hasLoaded){this.hasLoaded=true;this.getForm().setValues(a.pppoe);this.getForm().setValues(a.gateif);this.getForm().setValues(a);this.mon(this.getForm().findField("manual_radio"),"check",SYNO.SDS.EzInternet.WizardStep.TopologyConnectOpt.prototype.radioHandler,this);if(this.getForm().findField("dhcp_radio")){this.mon(this.getForm().findField("dhcp_radio"),"check",SYNO.SDS.EzInternet.WizardStep.TopologyConnectOpt.prototype.radioHandler,this)}this.mon(this.getForm().findField("pppoe_radio"),"check",SYNO.SDS.EzInternet.WizardStep.TopologyConnectOpt.prototype.radioHandler,this);this.mon(this.getForm().findField("username"),"change",SYNO.SDS.EzInternet.WizardStep.TopologyConnectOpt.prototype.textHandler,this);this.mon(this.getForm().findField("password"),"change",SYNO.SDS.EzInternet.WizardStep.TopologyConnectOpt.prototype.textHandler,this)}},radioHandler:function(a,b){this.owner.getButton("next").enable();this.getForm().findField("manual_ip").validate();this.allowBlankFields(a,b)},textHandler:function(b,a){if((b!==a)&&""!==b){this.owner.getButton("next").enable()}},allowBlankFields:function(a,b){if(!b){return}this.setActiveFields(a.inputValue)},setActiveFields:function(a){if("pppoe"===a){this.setPPPoEActive()}else{if("manual"===a){this.setManualActive()}else{if("dhcp"===a){this.setDHCPActive()}}}},clearManualInvalid:function(){Ext.apply(this.getForm().findField("manual_ip"),{allowBlank:true}).clearInvalid();Ext.apply(this.getForm().findField("manual_gateway"),{allowBlank:true}).clearInvalid();Ext.apply(this.getForm().findField("manual_netmask"),{allowBlank:true}).clearInvalid();Ext.apply(this.getForm().findField("manual_dns"),{allowBlank:true}).clearInvalid()},validateManual:function(){Ext.apply(this.getForm().findField("manual_ip"),{allowBlank:false}).validate();Ext.apply(this.getForm().findField("manual_gateway"),{allowBlank:false}).validate();Ext.apply(this.getForm().findField("manual_netmask"),{allowBlank:false}).validate();Ext.apply(this.getForm().findField("manual_dns"),{allowBlank:false}).validate()},disableManual:function(){this.getForm().findField("manual_ip").disable();this.getForm().findField("manual_gateway").disable();this.getForm().findField("manual_netmask").disable();this.getForm().findField("manual_dns").disable()},enableManual:function(){this.getForm().findField("manual_ip").enable();this.getForm().findField("manual_gateway").disable();this.getForm().findField("manual_netmask").disable();this.getForm().findField("manual_dns").enable()},clearPPPoEInvalid:function(){Ext.apply(this.getForm().findField("username"),{allowBlank:true}).clearInvalid();Ext.apply(this.getForm().findField("password"),{allowBlank:true}).clearInvalid()},validatePPPoE:function(){Ext.apply(this.getForm().findField("username"),{allowBlank:false}).validate();Ext.apply(this.getForm().findField("password"),{allowBlank:false}).validate()},enablePPPoE:function(){this.getForm().findField("username").enable();this.getForm().findField("password").enable();if(this.getForm().findField("real_ifname")){this.getForm().findField("real_ifname").enable()}},disablePPPoE:function(){this.getForm().findField("username").disable();this.getForm().findField("password").disable();if(this.getForm().findField("real_ifname")){this.getForm().findField("real_ifname").disable()}},setPPPoEActive:function(){this.clearManualInvalid();this.disableManual();this.enablePPPoE();this.validatePPPoE()},setManualActive:function(){this.enableManual();this.validateManual();this.clearPPPoEInvalid();this.disablePPPoE()},setDHCPActive:function(){this.clearPPPoEInvalid();this.disablePPPoE();this.clearManualInvalid();this.disableManual()},getNext:function(){if(!this.getForm().isValid()){return false}if(!this.applyNetInterfaceSetting()){return false}return this.getNextId()},getNextId:function(){var b=this.owner.getStep("welcome");var a=b.netenv;if(!a){SYNO.Debug("[Critical Error] netenv should not be null")}if(SYNO.SDS.EzInternet.Utils.Flow.prototype.isDefaultInterfacePublicIP(this.owner.getStep("welcome").netenv)){return"firewall"}else{if(!SYNO.SDS.EzInternet.Utils.CheckUserSelection.prototype.isViaRouter(this.owner)){return"firewall"}else{this.owner.getStep("router_empty").iface=a.gateif;return"router_empty"}}},summary:function(e){var a=this.owner.getStep("welcome").netenv;var d=this.getForm();var b=function(f){return d.findField(f).getValue()};var c=this.getForm().getValues().mode;if("pppoe"===c){e.append(_T("inetwizard","summary_conn"),_T("ezinternet","ezinternet_pppoe_conn_short"))}else{if("manual"===c){e.append(_T("ezinternet","ezinternet_summary_static_ip_conf"),SYNO.SDS.Utils.Network.idToString.call(this,a.gateif.ifname));e.appendSub(_T("tcpip","tcpip_ipaddr"),b("ip"));e.appendSub(_T("tcpip","tcpip_mask"),b("mask"));e.appendSub(_T("tcpip","tcpip_dns1"),b("dns"));e.appendSub(_T("tcpip","tcpip_gateway"),b("gateway"))}else{if("dhcp"===c){e.append(_T("inetwizard","summary_conn"),_T("tcpip","tcpip_dhcp"))}}}return true},ajaxErrorHandler:function(a){this.owner.getMsgBox().alert(this.title,a)},applyNetInterfaceSetting:function(){var a=this.owner.getStep("welcome").netenv;if(null===a){SYNO.Debug("netenv is null try to get again");SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.getNetworkEnv.call(this.owner.getStep("welcome"),{getNetworkEnvCallback:this.applyNetInterfaceSettingCore,getNetworkEnvCallbackScope:this});SYNO.Debug("wait netenv ready")}else{this.applyNetInterfaceSettingCore()}},getManualSettingWebAPICfg:function(b,c,a){if(("bridge"===b)&&("br0"===c)){return{api:"SYNO.Core.Network.Bridge",version:1,method:"set",params:{configs:[a]}}}else{if("wificlient"===b){return{api:"SYNO.Core.Network.Wifi.Client",version:1,method:"set",params:a}}else{if("bond"===b){return{api:"SYNO.Core.Network.Bond",version:1,method:"set",params:{configs:[a]}}}else{return{api:"SYNO.Core.Network.Ethernet",version:1,method:"set",params:{configs:[a]}}}}}},applyNetInterfaceSettingCore:function(){var m=function(o){if(!o||!o.wifi_interfaces){throw Error("critical error")}for(var p=0;p<o.wifi_interfaces.size();p++){if("Enabled"===o.wifi_interfaces[p].status&&o.gateif.ifname===o.wifi_interfaces[p].interface_name){return o.wifi_interfaces[p]}}return null};var l=function(o){var p=m(o);if(!p){return null}return p};var f=this.owner.getStep("welcome").netenv;var a=this.getForm();var k=function(o){return a.findField(o).getValue()};var b=this.getForm().getValues().mode;var d=null;var h=true;var e=a.findField("real_ifname");var g=null;if(e&&!e.hidden){g=e.getValue()}if(null===g){g=f.gateif.ifname}if("pppoe"===b){if(f.pppoe&&"connected"===f.pppoe.status){this.owner.setHeight(this.height);this.owner.goNext("firewall",true);return true}d=_T("ezinternet","ezinternet_pppoe_conn_short");var n={ifname:"pppoe",real_ifname:g,username:k("username")};if(a.findField("password").isDirty()){n.password=k("password")}this.owner.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({params:{},scope:this,compound:{stopwhenerror:true,params:[{api:"SYNO.Core.Network.PPPoE",method:"set",version:1,params:{configs:[n]}},{api:"SYNO.Core.Network.PPPoE",version:1,method:"connect",params:{ifname:"pppoe"}}]},callback:this.applyPPPoEHandler});return true}if("manual"===b){h=true}else{if("dhcp"===b){h=false}}var c={dns_manual:true,dns_primary:k("dns"),gateway:k("gateway")};if(!SYNO.SDS.Utils.Network.GatewayMatchIP(k("gateway"),k("ip"),k("mask"))){this.owner.getMsgBox().alert(this.title,_T("dhcp_server","dhcp_gateway_err"));return false}var i=null;var j=l(f);if(j){j.is_dhcp=!h;j.ip=k("ip");j.netmask=k("mask");j.gateway=k("gateway");j.interface_name=j.interface_name;SYNO.Debug("wifi interface = "+j.interface_name);i=j}else{i={ip:k("ip"),mask:k("mask"),use_dhcp:!h,ifname:f.gateif.ifname,type:f.gateif.type}}SYNO.SDS.UserSettings.setProperty("Desktop","restoreParams",Ext.apply({className:"SYNO.SDS.EzInternet.Instance",params:this.owner.getStateParam()}),true);this.owner.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({params:{},scope:this,compound:{stopwhenerror:true,params:[this.getManualSettingWebAPICfg(f.gateif.type,f.gateif.ifname,i),{api:"SYNO.Core.Network",version:1,method:"set",params:c}]},callback:this.applyHandler});return true},applyPPPoEHandler:function(c,b,a){SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.getNetworkEnv.call(this.owner.getStep("welcome"),{getNetworkEnvCallback:this.applyPPPoEHandlerCore,getNetworkEnvCallbackScope:this,getNetworkEnvCallbackArgument:{success:c,resp:b,req:a}})},applyPPPoEHandlerCore:function(b,d){var f=d.success||{};var e=d.resp||{};this.owner.clearStatusBusy();var a=false;if(!f||e.has_fail){for(var c=0;c<e.result.size();c++){if(!e.result[c].success&&("connect"===e.result[c].method)){a=true}}this.owner.getMsgBox().alert(this.title,_T("pppoe","pppoe_connection_failed"));return false}this.owner.setHeight(this.height);this.owner.goNext("firewall",true)},applyHandler:function(f,e,c){var b="";var d=null;var a=0;this.owner.clearStatusBusy();if(!f||e.has_fail){SYNO.SDS.UserSettings.removeProperty("Desktop","restoreParams",true);var g="";for(a=0;a<e.result.size();a++){if(!e.result[a].success){g=SYNO.API.getErrorString(e.result[a].error.code);break}}if(""!==g){this.owner.getMsgBox().alert(this.title,g)}else{this.owner.getMsgBox().alert(this.title,_T("common","error_system"))}return false}for(a=0;a<e.result.size();a++){if(!(("SYNO.Core.Network"===e.result[a].api)&&("set"===e.result[a].method))&&(e.result[a].data)&&(e.result[a].data.redirect)){d=e.result[a].data}}if(d){this.owner.setNextStep(this.itemId,this.getNextId());this.owner.redirect(d,b)}else{SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.getNetworkEnv.call(this.owner.getStep("welcome"),{getNetworkEnvCallback:function(){this.owner.setHeight(this.height);this.owner.goNext(this.getNextId(),true);SYNO.SDS.UserSettings.removeProperty("Desktop","restoreParams",true)},getNetworkEnvCallbackScope:this})}}});Ext.define("SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptViaRouter",{extend:"SYNO.SDS.EzInternet.WizardStep.TopologyConnectOpt",constructor:function(b){var a=Ext.apply({headline:_T("ezinternet","ezinternet_conn_title"),description:String.format(_T("ezinternet","ezinternet_conn_desc"),_D("product")),trackResetOnLoad:true,labelWidth:170,items:SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.getThroughRouterComponents.call(this)},b);this.callParent([a])},activate:function(){if(!this.hasUserSelect){this.getForm().setValues({mode:"manual"});this.setManualActive();this.hasUserSelect=true}else{var a=this.getForm().getValues().mode;this.setActiveFields(a)}this.callParent()}});Ext.define("SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptBridge",{extend:"SYNO.SDS.EzInternet.WizardStep.TopologyConnectOpt",constructor:function(b){var a=Ext.apply({headline:_T("ezinternet","ezinternet_conn_title"),description:String.format(_T("ezinternet","ezinternet_conn_desc"),_D("product")),trackResetOnLoad:true,labelWidth:170,items:SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.getThroughRouterComponents.call(this)},b);this.callParent([a])},activate:function(){if(!this.hasUserSelect){this.getForm().setValues({mode:"manual"});this.setManualActive();this.hasUserSelect=true}else{var a=this.getForm().getValues().mode;this.setActiveFields(a)}this.callParent()}});Ext.define("SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptDirectlink",{extend:"SYNO.SDS.EzInternet.WizardStep.TopologyConnectOpt",constructor:function(b){var a=Ext.apply({headline:_T("ezinternet","ezinternet_conn_title"),description:String.format(_T("ezinternet","ezinternet_conn_desc"),_D("product")),trackResetOnLoad:true,labelWidth:170,items:SYNO.SDS.EzInternet.WizardStep.TopologyConnectOptComponets.prototype.getDirectlinkComponents.call(this)},b);this.callParent([a])},activate:function(){if(!this.hasUserSelect){this.getForm().setValues({mode:"pppoe"});this.setPPPoEActive();this.hasUserSelect=true}else{var a=this.getForm().getValues().mode;this.setActiveFields(a)}this.setComboBoxPPPoE();this.callParent()},setComboBoxPPPoE:function(){var a=this.owner.getStep("welcome").netenv;var b=this.getForm().findField("real_ifname");if(!b){return}if(a&&a.pppoe&&("connected"!==a.pppoe.status)){if(!a){SYNO.Debug("In TopologyConnectOptDirectlink, netenv is null");return}if(!a.pppoe){SYNO.Debug("In TopologyConnectOptDirectlink, netenv.pppoe is null");return}if(!a.pppoe.real_ifname){SYNO.Debug("In TopologyConnectOptDirectlink, netenv.pppoe is null");return}if(!a.pppoe.devs){SYNO.Debug("In TopologyConnectOptDirectlink, netenv.pppoe.devs is null");return}if(2>a.pppoe.devs.size()){return}this.setData(a);b.show()}},setData:function(a){if(a.pppoe.devs instanceof Array){var b=this.getForm().findField("real_ifname");var c=[];a.pppoe.devs.sort(SYNO.SDS.AdminCenter.Network.Utils.SortFunc);Ext.each(a.pppoe.devs,function(d){c.push([d,SYNO.SDS.Utils.Network.idToString.apply(this,[d])])},this);if(b){b.getStore().loadData(c)}}if(-1==a.pppoe.devs.indexOf(a.pppoe.real_ifname)){a.pppoe.real_ifname=a.pppoe.devs[0]}this.getForm().setValues(a)}});Ext.define("SYNO.SDS.EzInternet.WizardStep.WelcomeStep",{extend:"SYNO.SDS.Wizard.WelcomeStep",constructor:function(b){this.netenv=null;this.test_internet=false;this.FwStatus={enable:null,activeProfile:null};var a=Ext.apply({headline:_T("ezinternet","ezinternet_welcome_title"),description:_T("ezinternet","ezinternet_welcome"),disableNextInDemoMode:true},b);this.callParent([a])},activate:function(){this.hideBanner();this.owner.setHeight(this.height);this.owner.setStatusBusy();var a=this;SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.checkTopologySwitching.call(this,function(){SYNO.SDS.EzInternet.Utils.NetworkEnv.prototype.getNetworkEnv.call(a,{call_test_internet:true,getNetworkEnvCallback:this.checkIfUSBModem,getNetworkEnvCallbackScope:this})})},checkIfUSBModem:function(){var a=this.owner.getStep("welcome").netenv;if(SYNO.SDS.EzInternet.Utils.Flow.prototype.isDefaultGatewayUSBModemDongle(a)&&false===SYNO.SDS.EzInternet.Utils.Flow.prototype.isDefaultInterfacePublicIP(a)){this.owner.getMsgBox().alert(this.owner.title,_T("ezinternet","warn_usb_modem_private_ip"),function(b){this.owner.getButton("next").disable()},this)}},getNext:function(){if(SYNO.SDS.EzInternet.Utils.Topology.prototype.isWifiDS(this.netenv)&&SYNO.SDS.EzInternet.Utils.Topology.prototype.isSupportAPMode(this.netenv)){return this.nextId[0]}else{return this.nextId[1]}}});