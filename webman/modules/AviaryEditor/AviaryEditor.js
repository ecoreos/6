/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.AviaryEditor.Application",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.AviaryEditor.MainWindow"});SYNO.SDS.AviaryEditor.ErrorMsg={3000:_T("pkgmgr","download_fail"),3001:_T("error","error_select_conflict"),3002:_T("error","mvcp_file_too_big")};Ext.define("SYNO.SDS.AviaryEditor.MainWindow",{extend:"SYNO.SDS.AppWindow",normalUrl:"http://feather.aviary.com/js/feather.js",sslUrl:"https://dme0ih8comzn4.cloudfront.net/js/feather.js",aviaryReady:false,frame:false,header:false,showHelp:false,toggleMinimizable:false,aviaryLang:{cht:"zh_HANT",chs:"zh_HANS",enu:"en",ger:"de",jpn:"ja",krn:"ko",spn:"es",fre:"fr",ita:"it",ptb:"pt_BR",ptg:"pt",hun:"hu",trk:"tr",rus:"ru",dan:"da",sve:"sv",nor:"no",nld:"nl",plk:"pl",csy:"cs"},constructor:function(a){this.hookIframeMsg();this.initParam();this.callParent([this.fillConfig(a)]);this.addPollTask();this.mon(SYNO.SDS.StatusNotifier,"beforeunload",function(){if(this.loadError===true){return true}return false},this)},initParam:function(){var a=Ext.urlDecode(decodeURIComponent(Ext.urlDecode(window.location.search.substr(1)).launchParam));this.openParam=a},fillConfig:function(a){var c=Ext.id(),d=Ext.urlAppend(this.jsConfig.jsBaseURL+"/aviaryframe.html",Ext.urlEncode({url:encodeURIComponent(this.openParam.imgUrl),path:encodeURIComponent(this.openParam.path),lang:this.aviaryLang[_S("lang")]||"en"})),b={layout:"fit",header:false,showHelp:false,cls:"aviary-appwindow",items:[{xtype:"panel",html:String.format('<iframe id="{0}" scrolling="no" src="{1}" frameborder="0" class="aviary-ct" style="border: 0px none; width:100%; height: 100%;"></iframe>',c,d)}]};this.frameId=c;return Ext.apply(b,a)},afterRender:function(){this.callParent(arguments);this.el.mask(_T("common","loading"),"x-mask-loading").addClass("filled-bg sds-window-mask")},handleError:function(b){var a=this,c=function(){window.close()};this.loadError=true;switch(b){case"2":break;case"1":case"3":a.getMsgBox().alert("Aviary",_T("aviary","no_external_ip"),c,a);break;default:a.getMsgBox().alert("Aviary",_T("aviary","load_aviary_common_fail"),c,a);break}},postIframeMsg:function(c){var b=Ext.get(this.frameId),a=b.dom.contentWindow;a.postMessage(c,"*")},hookIframeMsg:function(){var b=this,a=function(f){if(!Ext.isIE9&&!Ext.isIE10&&window.location.origin!==f.origin){return}var d={};try{d=Ext.urlDecode(f.data)}catch(c){SYNO.Debug(c);d={}}if(d.error){b.handleError(d.error)}if(d.save){b.saveImage(d.save)}if(d.ready){b.el.unmask()}};if(b.iframeHooked){return}if(window.addEventListener){window.addEventListener("message",a,false)}else{window.attachEvent("onmessage",a)}b.onMsgPost=a;b.iframeHooked=true},getErrMsg:function(a){a=a||{code:100};return SYNO.SDS.AviaryEditor.ErrorMsg[a.code]||SYNO.API.getErrorString(a)},addSaveStatusTask:function(c,b){var a=this;if(!c||c.success===false||!Ext.isDefined(c.taskid)){a.getMsgBox().alert("aviary",this.getErrMsg(c));return}a.stopSaveStatusTask();a.pollSaveTaskId=a.pollReg({webapi:{api:"SYNO.Aviary",method:"save_progress",version:1,params:{taskid:c.taskid}},immediate:true,interval:5,scope:a,status_callback:a.onGetSaveStatus})},stopSaveStatusTask:function(){if(this.pollSaveTaskId){this.pollUnreg(this.pollSaveTaskId);this.pollSaveTaskId=null}},onGetSaveStatus:function(c,b){var a=this;if(!c||!b||b.success===false){a.postIframeMsg("saveerror=true");a.stopSaveStatusTask();a.getMsgBox().alert("aviary",this.getErrMsg(b));return}if(!b.running){a.postIframeMsg("savedone=true");a.stopSaveStatusTask()}},onGetSaveStatusFailed:function(b,a){this.stopSaveStatusTask()},onSaveFail:function(a){this.postIframeMsg("saveerror=true");this.getMsgBox().alert("aviary",this.getErrMsg(a))},saveImage:function(c){var d=this,e=this.openParam.path,b=e.substr(0,e.lastIndexOf("/")),a=e.substr(1+e.lastIndexOf("/"));d.sendWebAPI({api:"SYNO.Aviary",method:"save",version:1,params:{path:b,name:a,title:a.substr(0,a.lastIndexOf(".")),type:a.substr(a.lastIndexOf(".")+1),url:c},scope:this,callback:function(g,f){if(g){d.addSaveStatusTask(f)}else{d.onSaveFail(f)}}})},addPollTask:function(){this.pollReg({webapi:{api:"SYNO.Aviary",method:"avoid_timeout",version:1},immediate:true,status_callback:Ext.emptyFn,interval:10})}});