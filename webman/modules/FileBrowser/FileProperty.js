/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.ns("SYNO.FileStation");SYNO.FileStation.PropertyDialogEnum={privilegeType:{acl:"aclPrivilege",posix:"posixPrivilege",none:"noPrivilege"}};Ext.define("SYNO.SDS.Snapshot.SnapshotGrid",{extend:"SYNO.ux.GridPanel",constructor:function(c){this.createStore(c);var b=[{header:_T("time","time_time"),dataIndex:"time",id:"time",width:150,renderer:SYNO.webfm.utils.snapshotTimeRenderer},{header:_WFT("common","desc"),dataIndex:"desc",id:"desc",width:250}];var a=Ext.apply({title:_T("filebrowser","snapshot"),layout:"fit",store:this.store,width:700,autoExpandColumn:"desc",tbar:[{itemId:"browse-btn",xtype:"syno_button",text:_WFT("mount","browse"),handler:this.onBrowseBtnClick,disabled:true,scope:this}],colModel:new Ext.grid.ColumnModel({defaultSortable:true,defaults:{align:"center"},columns:b}),selModel:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{selectionchange:this.onSelectedChange,scope:this}})},c);this.callParent([a]);this.store.load({path:a.path})},createStore:function(a){this.store=new Ext.data.Store({proxy:new SYNO.API.Proxy({api:"SYNO.FileStation.Snapshot",method:"list",version:2}),reader:new Ext.data.JsonReader({root:"items",id:"time"},[{name:"time"},{name:"desc"}]),sortInfo:{field:"time",direction:"DESC"},baseParams:{path:a.path,real_path:a.real_path}})},onSelectedChange:function(c){var a=c.getSelections(),b=this.getTopToolbar().getComponent("browse-btn");b.setDisabled((a.length!==1))},onBrowseBtnClick:function(){var a=this.getSelectionModel().getSelections(),b=this.owner,d=b.owner.panelObj,c;if(a.length!==1){return}c=this.path+"/#snapshot/"+a[0].get("time");if(b.checkModified()){b.getMsgBox().confirm(_WFT("filetable","filetable_properties"),_WFT("common","confirm_lostchange"),function(e){if("yes"==e){d.onGoToFolder(c);b.close()}else{return}},this)}else{d.onGoToFolder(c);b.close()}}});Ext.define("SYNO.FileStation.PropertyDialog",{extend:SYNO.SDS.Share.PermissionDialog,tabs:null,gTargetFiles:null,gDirPaths:null,constructor:function(b){this.owner=b.owner;var f=Ext.applyIf(this.CreateTabsConfig(b.rec,b.source),b);var c=b.privilegeType;this.ns=SYNO.SDS.ControlPanel.Share;this.tabs=(function(){var g=[];if(b.hideInfoPanel!==true){g.push({title:_WFT("property","heading_general"),layout:"fit",items:new SYNO.FileStation.PropertyDialog.InfoPage(f,c)})}if(SYNO.FileStation.PropertyDialogEnum.privilegeType.acl===c&&!b.rec[0].get("is_snapshot")){g.push({title:_WFT("acl_editor","permission"),layout:"fit",items:this.aclPanel=new SYNO.FileStation.PropertyDialog.ACLPrivilege(Ext.apply({isFirstLoad:true,openConfig:b.openConfig},f))})}else{if(!b.rec[0].get("isshare")&&!b.rec[0].get("is_snapshot")&&SYNO.FileStation.PropertyDialogEnum.privilegeType.posix===c){g.push({title:_WFT("acl_editor","permission"),layout:"fit",items:new SYNO.FileStation.PropertyDialog.PosixPrivilege(f)})}}if(_S("is_admin")&&b.rec[0].get("isshare")&&b.hideAdvPermPanel!==true){g.push(this.createShareGridPanel());g.push(this.createAdvPermPanel(b.rec[0]))}if(b.rec[0].get("isshare")){g.push(this.createSnapshotGridPanel(b.rec[0]))}return g}).call(this);var e=_WFT("filetable","filetable_properties");if(b.isShareForceRO){e+=" ("+_WFT("common","readonly")+")"}var a=Ext.apply({width:750,height:_S("diskless")?320:590,shadow:true,minWidth:600,minHeight:_S("diskless")?320:400,collapsible:false,constrainHeader:true,plain:true,title:e,layout:"fit",items:[{xtype:"syno_tabpanel",activeTab:0,plain:true,itemId:"tab",layoutOnTabChange:true,items:this.tabs,deferredRender:false}],buttons:[{btnStyle:"blue",text:_WFT("common","ok"),scope:this,disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):undefined,handler:this.okHandler},{text:_WFT("common","close"),scope:this,handler:this.closeHandler}],keys:[{key:27,fn:this.closeHandler,scope:this}],listeners:{afterlayout:{fn:this.center,scope:this,single:true},error:{fn:this.errorHandler,scope:this},beforeclose:{fn:this.beforecloseHandler,scope:this}}},b);SYNO.SDS.Share.PermissionDialog.superclass.constructor.call(this,a);var d=this.getComponent("tab");d.hideTabStripItem("snapshotgrid");if(_S("is_admin")&&b.rec[0].get("isshare")){if(SYNO.FileStation.PropertyDialogEnum.privilegeType.posix===c){d.unhideTabStripItem("sharegrid")}else{d.hideTabStripItem("sharegrid")}}if(this.snapshotGridPanel){this.mon(this.snapshotGridPanel.store,"load",function(g,i,h){if(i.length>0){this.getComponent("tab").unhideTabStripItem("snapshotgrid")}},this)}},createShareGridPanel:function(){this.gridPanel=new SYNO.SDS.Share.ShareGrid({owner:this,itemId:"sharegrid",hideCustomColumn:true,checkShareModified:function(){return(this.store.getModifiedRecords().length!==0)}});return this.gridPanel},createSnapshotGridPanel:function(a){this.snapshotGridPanel=new SYNO.SDS.Snapshot.SnapshotGrid({owner:this,itemId:"snapshotgrid",path:a.get("path"),real_path:a.get("real_path")});return this.snapshotGridPanel},createAdvPermPanel:function(a){this.formPanel=new SYNO.SDS.Share.AdvanceForm({owner:this,itemId:"advperm",checkShareModified:function(){return this.getForm().isDirty()},loadData:function(){this.owner.loadPermissionData(a)}});return this.formPanel},AlertMsg:function(a){this.owner.getMsgBox().alert(this.title,a)},closeHandler:function(){if(this.checkModified()){this.getMsgBox().confirm(_WFT("filetable","filetable_properties"),_WFT("common","confirm_lostchange"),function(a){if("yes"==a){this.close()}else{return}},this)}else{this.close()}},okHandler:function(){if(_S("demo_mode")){this.getMsgBox().alert(_WFT("filetable","filetable_properties"),_JSLIBSTR("uicommon","error_demo"));return}if(this.checkModified()){if(this.validateData()){this.saveProperty(this.collectData())}else{return}}else{this.close()}},errorHandler:function(a){this.getMsgBox().alert(_WFT("error","error_error"),a,this.close,this)},load:function(){if(this.rec===""){return}var a=(SYNO.FileStation.PropertyDialogEnum.privilegeType.none===this.privilegeType)?320:590;var b=SYNO.SDS.Desktop?SYNO.SDS.Desktop.getEl().getHeight():Ext.lib.Dom.getViewHeight();if(b<a){a=b}this.setSize(this.width,a);this.LoadTabs();this.show().center()},LoadTabs:function(){for(var a=0;a<this.tabs.length;++a){if(Ext.isFunction(this.tabs[a].items.loadData)){this.tabs[a].items.loadData()}else{if(Ext.isFunction(this.tabs[a].loadData)){this.tabs[a].loadData()}}}},CreateTabsConfig:function(b,a){var d=[];var g,c;var f=false;var h=[];var k;var j=null;var l=[];var e;if(b.length>1){f=true;for(e=0;e<b.length;e++){d.push(b[e].get("real_path"));k=b[e].get("file_id");if(b[0].get("isdir")){h.push(k)}else{h.push(k.substr(0,k.lastIndexOf("/")))}l.push(b[e].get("file_id"))}g=d.join("_SYNOFM_");j=h.join("_SYNOFM_");c=l}else{f=false;g=b[0].get("real_path");k=b[0].get("file_id");if(b[0].get("isdir")){j=k}else{j=k.substr(0,k.lastIndexOf("/"))}c=b[0].get("file_id")}if(SYNO.webfm.utils.isLocalSource(a)){if(b.length==1){d[0]=g}this.gTargetFiles=d}else{this.gTargetFiles=g;this.gAPITargetFiles=c;this.gDirPaths=j}return{owner:this,gblMultiFiles:f,gTargetFiles:this.gTargetFiles,gAPITargetFiles:this.gAPITargetFiles,gDirPaths:this.gDirPaths}},checkModified:function(d,a){for(var b=0;b<this.tabs.length;++b){var c=null,e=null;if(Ext.isFunction(this.tabs[b].items.checkModified)){if(a===false){continue}c=this.tabs[b].items.checkModified;e=this.tabs[b].items}else{if(Ext.isFunction(this.tabs[b].checkShareModified)){if(d===false){continue}c=this.tabs[b].checkShareModified;e=this.tabs[b]}}if(!Ext.isFunction(c)){continue}if(true===c.call(e)){return true}}return false},validateData:function(){for(var a=0;a<this.tabs.length;++a){if(!Ext.isFunction(this.tabs[a].items.validateData)){continue}if(false===this.tabs[a].items.validateData()){this.getComponent("tab").setActiveTab(a);return false}}return true},collectData:function(){var a={file_path:this.gTargetFiles,files:this.gTargetFiles,dirPaths:this.gDirPaths};for(var b=0;b<this.tabs.length;++b){if(Ext.isFunction(this.tabs[b].items.collectData)){Ext.apply(a,this.tabs[b].items.collectData())}}return a},saveProperty:function(a){var b=this.formPanel&&this.formPanel.isAdvPermissionDisabled();var d=this.aclPanel&&this.aclPanel.checkModified();var c={name:this.rec[0].get("name"),is_sync_share:this.rec[0].get("is_sync_share"),permissions:[],no_check_permission:false};if(this.rec[0].get("isshare")){if(this.gridPanel&&!this.isShareGridHidden()){c.permissions=this.gridPanel.getModifiedPermissions()}else{if(d){c.permissions=[{is_readonly:false,is_deny:false,is_writable:false,is_custom:true}]}}if(b){c.no_check_permission=true}}SYNO.SDS.Utils.S2S.confirmIfSyncShareAffected(false,c,{dialogTitle:this.title,dialogMsg:_T("s2s","s2s_warn_share_change_priv"),dialogOwner:this,continueHandler:function(){this.propertyVal=a;if(this.checkModified(true,false)){this.remoteSavePermission();return}this.successHandler()},abortHandler:Ext.EmptyFn,scope:this})},successHandler:function(){if(!this.checkModified(false)){this.close();return}var a=SYNO.webfm.utils.getParentDirArr(this.rec);if("aclPrivilege"===this.privilegeType){this.sendWebAPI({api:"SYNO.Core.ACL",method:"set",version:1,scope:this,params:this.propertyVal,callback:function(e,d,c){c.nodeIdArr=a;c.is_acl=true;this.savePropertyCB(c,e,d)}});return}var b={};Ext.apply(b,this.propertyVal);Ext.apply(b,this.savePropertyExtParams);if(b.dirPaths){b.dir_paths=b.dirPaths.split("_SYNOFM_");delete b.dirPaths}b.files=b.files.split("_SYNOFM_");b.mode=""+b.mode;this.sendWebAPI({api:"SYNO.FileStation.Property",method:"set",version:1,params:b,scope:this,callback:function(e,d,c){c.nodeIdArr=a;c.is_acl=false;this.savePropertyCB(c,e,d)}})},savePropertyCB:function(a,c,b){this.fireEvent("callback",a,c,b);this.close()},beforecloseHandler:function(){for(var a=0;a<this.tabs.length;++a){if(Ext.isFunction(this.tabs[a].items.onClose)){this.tabs[a].items.onClose()}}}});Ext.define("SYNO.FileStation.PropertyDialog.InfoPage",{extend:SYNO.ux.FormPanel,components:null,constructor:function(c,a){this.components=[];this.components.push(new SYNO.FileStation.PropertyDialog.InfoPage.InfoFieldset(c));if((false===Ext.isDefined(c.rec[0].get("isshare"))||false===c.rec[0].get("isshare"))&&!c.rec[0].get("is_snapshot")&&false===SYNO.webfm.VFS.isVFSPath(c.rec[0].get("path"))){if(SYNO.FileStation.PropertyDialogEnum.privilegeType.posix===a){this.components.push(new SYNO.FileStation.PropertyDialog.InfoPage.PosixOwnerFieldset(c))}else{if(SYNO.FileStation.PropertyDialogEnum.privilegeType.acl===a){this.components.push(new SYNO.FileStation.PropertyDialog.InfoPage.ACLOwnerFieldset(c))}}}var b=Ext.apply({layout:"form",trackResetOnLoad:true,waitMsgTarget:true,hideMode:"display",hidden:false,border:false,name:"infoPage",itemId:"infoPage",items:this.components},c);SYNO.FileStation.PropertyDialog.InfoPage.superclass.constructor.call(this,b)},loadData:function(){for(var a=0;a<this.items.length;++a){this.components[a].loadData()}},checkModified:function(){for(var a=0;a<this.components.length;++a){if(true===this.components[a].checkModified()){return true}}return false},validateData:function(){for(var a=0;a<this.components.length;++a){if(false===this.components[a].validateData()){return false}}return true},collectData:function(){var a={};for(var b=0;b<this.components.length;++b){Ext.apply(a,this.components[b].collectData())}return a},onClose:function(){for(var a=0;a<this.items.length;++a){this.components[a].onClose()}}});Ext.define("SYNO.FileStation.PropertyDialog.InfoPage.InfoFieldset",{extend:SYNO.ux.FieldSet,md5ThreadId:null,sizeTreadId:null,constructor:function(c){var b=[{xtype:"syno_textfield",fieldLabel:_WFT("common","common_filename"),name:"name",itemId:"name",width:300,readOnly:true,cls:"selectabletext allowDefCtxMenu"},{xtype:"syno_textfield",fieldLabel:_WFT("property","file_location"),name:"real_path",itemId:"real_path",width:300,readOnly:true,cls:"selectabletext allowDefCtxMenu"},{itemId:"size",xtype:"syno_displayfield",width:"auto",fieldLabel:_WFT("common","common_filesize"),name:"size"},{itemId:"disk_size",xtype:"syno_displayfield",width:"auto",fieldLabel:_WFT("property","file_disk_size"),name:"disk_size"},{xtype:"syno_displayfield",itemId:"mod_time",width:"auto",fieldLabel:_WFT("filetable","filetable_mtime"),name:"mod_time"},{itemId:"folder_access_link",border:false,layout:"form",items:[{xtype:"syno_displayfield",width:"auto",fieldLabel:_WFT("filetable","filetable_dir_access_link"),itemId:"link",htmlEncode:false,listeners:{render:function(f){var e=f.label.first("a.pathlink");if(e){this.mon(e,"click",function(){SYNO.webfm.utils.onMailTo(encodeURIComponent(this.folderAccessLinkurl))},this)}},scope:this,single:true,buffer:80}}]},{itemId:"snapshot_desc",xtype:"syno_displayfield",width:"auto",fieldLabel:_T("filebrowser","snapshot_desc"),name:"snapshot_desc",hidden:!((c.rec.length==1)&&SYNO.webfm.utils.isSnapshotShareFolder(c.rec[0].get("path"),c.rec[0].get("is_snapshot"),c.rec[0].get("is_btrfs_subvol")))},{itemId:"md5",border:false,layout:"hbox",items:[{xtype:"syno_displayfield",value:"MD5",width:185},{itemId:"md5_calc_btn",xtype:"syno_button",text:_WFT("common","calculate"),handler:this.CalcMD5,scope:this},{xtype:"syno_displayfield",name:"md5",itemId:"md5_value",selectable:true,width:300}]}];var d=(SYNO.FileStation.PropertyDialogEnum.privilegeType.none===c.privilegeType);var a=Ext.apply({title:_WFT("property","heading_general"),border:(d)?false:true,cls:(d)?"syno-sds-fieldset-without-legend":"",hideMode:"display",synodefaults:{width:300},name:"infoFieldset",items:b},c);SYNO.FileStation.PropertyDialog.InfoPage.InfoFieldset.superclass.constructor.call(this,a);Ext.EventManager.on(window,"unload",this.handelKillprocess,this);SYNO.SDS.StatusNotifier.on("logout",this.handelKillprocess,this)},GetSnapshotDesc:function(a){this.addWebAPITask({api:"SYNO.FileStation.Snapshot",method:"desc",version:2,single:true,params:{path:this.gAPITargetFiles},callback:function(d,c,b){if(d){this.get("snapshot_desc").setValue(c.desc)}else{this.get("snapshot_desc").setValue("N/A")}},scope:this}).start(true)},CalcFileSize:function(a){if(SYNO.webfm.utils.isLocalSource(this.source)){var b={pathlist:this.gTargetFiles,dialogId:this.id,action:"getSize"};var c=AppletProgram.action(b);if(!c||!c.success){this.get("size").setValue("N/A")}return}this.addWebAPITask({api:"SYNO.FileStation.DirSize",method:"start",version:2,single:true,params:{path:this.gAPITargetFiles},callback:function(f,e,d){if(f){this.calcSizeCallback(e.taskid)}else{this.get("size").setValue("N/A")}},scope:this}).start(true)},calcSizeCallback:function(b){var c,e,d,a;this.gCalcRequest=this.addWebAPITask({api:"SYNO.FileStation.DirSize",method:"status",version:2,interval:5000,params:{taskid:b},callback:function(i,h,g){if(this.isDestroyed){if(this.gCalcRequest){this.gCalcRequest.stop();this.gCalcRequest=0}return}var f="N/A";if(i&&h.finished){this.gCalcRequest.stop();this.gCalcRequest=0;if(Ext.isNumber(h.total_size)||Ext.isNumber(h.num_dir)||Ext.isNumber(h.num_file)){c=parseInt(h.total_size,10);a=Ext.util.Format.number(c,"0,000");e=Ext.util.Format.fileSize(c)+" ("+a+" Bytes)";d=String.format(_WFT("property","file_statistics"),h.num_file,h.num_dir);f=e+". "+d}this.get("size").setValue(f)}else{if(!i||h.errors){this.gCalcRequest.stop();this.gCalcRequest=0;this.get("size").setValue(f)}}},scope:this});this.gCalcRequest.start(true);this.gCalcSizeTaskId=b},CalcMD5:function(){var a=_WFT("common","calculatingmd5")+"...",b=this.getComponent("md5"),f=b.getComponent("md5_calc_btn"),e=b.getComponent("md5_value");f.hide();b.doLayout();e.setValue(a);if(SYNO.webfm.utils.isLocalSource(this.source)){var c={path:this.gTargetFiles[0],dialogId:this.id,action:"getMD5"};var d=AppletProgram.action(c);if(!d||!d.success){e.setValue("N/A")}return}this.addWebAPITask({api:"SYNO.FileStation.MD5",method:"start",version:2,single:true,params:{file_path:this.gAPITargetFiles},callback:function(i,h,g){if(i){this.CalcMD5Callback(h.taskid)}else{e.setValue("N/A")}},scope:this}).start(true)},CalcMD5Callback:function(a){this.gMD5Request=this.addWebAPITask({api:"SYNO.FileStation.MD5",method:"status",version:2,interval:1000,params:{taskid:a},callback:function(d,c,b){if(this.isDestroyed){this.gMD5Request.stop();this.gMD5Request=0;return}if(d&&c.finished&&c.md5){this.gMD5Request.stop();this.gMD5Request=0;this.get("md5").get("md5_value").setValue(c.md5)}else{if(!d||c.errors){this.gMD5Request.stop();this.gMD5Request=0;this.get("md5").get("md5_value").setValue("N/A")}}},scope:this});this.gMD5Request.start(true);this.gCalcMD5TaskId=a},SetFolderQuickAccessLink:function(e){var c=e.get("isdir");var i=e.get("file_id")+"/";var b;var d={openfile:i};var j=Ext.isObject(d)?Ext.urlEncode({launchParam:Ext.urlEncode(d)}):"";if(c===false){return}b=SYNO.SDS.Utils.Network.getURLprefix();var h="index.cgi";var a=String.format("{0}/"+h+"?launchApp={1}",b,encodeURIComponent("SYNO.SDS.App.FileStation3.Instance"));a=window._urlAppend(a,j);this.folderAccessLinkurl=a;var g=Ext.util.Format.ellipsis(a,50);var f=String.format('<a class="pathlink allowDefCtxMenu" target="_blank" href="{0}">{1}</a>',a,g);this.get("folder_access_link").get("link").setValue(f)},loadData:function(){var c=this.rec;var k,g,h,l,e;var p=0,n=0;var j=false,b=false;var f=0;this.get("md5").hide();this.get("disk_size").hide();if(this.gblMultiFiles){this.get("folder_access_link").hide();var a=c[0].get("filename");var m=c[0].get("real_path").lastIndexOf(a);var o=0,d=0;for(f=0;f<c.length;f++){if(c[f].get("isdir")){o++}else{d++}}k=d+" "+_WFT("common","file")+", "+o+" "+_WFT("common","folder");g=c[0].get("real_path").substr(0,m);h="N/A";for(f=0;f<c.length;f++){if(SYNO.webfm.VFS.isVFSPath(c[f].get("path"))){b=true;break}if(c[f].get("isdir")){j=true;break}p=parseInt(c[f].get("filesize"),10);n+=p}if(!j){l=n}}else{k=c[0].get("filename");g=c[0].get("real_path");if(Ext.isDefined(c[0].get("mt"))){h=(new Date(c[0].get("mt")*1000)).toLocaleString()}else{h="N/A"}if(c[0].get("isdir")){j=true}else{this.get("md5").show();l=c[0].get("filesize");this.sendWebAPI({api:"SYNO.FileStation.Property.CompressSize",method:"get",version:1,params:{file:c[0].get("real_path")},callback:function(u,r,s,q){if(this.isDestroyed){return}if(u&&r.diskSize){var t=r.diskSize;var i=Ext.util.Format.number(t,"0,000");this.get("disk_size").setValue(Ext.util.Format.fileSize(t)+" ("+i+" Bytes)");this.get("disk_size").show()}},scope:this})}if(SYNO.webfm.VFS.isVFSPath(c[0].get("path"))){b=true}if(SYNO.webfm.utils.isLocalSource(this.source)||true===c[0].get("isshare")){this.get("folder_access_link").hide()}else{if(c[0].get("isdir")===true){this.SetFolderQuickAccessLink(c[0]);this.get("folder_access_link").show()}else{this.get("folder_access_link").hide()}}}if(b){if(this.gblMultiFiles||c[0].get("isdir")){this.get("size").hide()}this.get("md5").hide();this.get("folder_access_link").hide()}else{if(j){l=_WFT("common","calculating")+"...";this.CalcFileSize(c)}}if(c.length===1&&SYNO.webfm.utils.isSnapshotShareFolder(c[0].get("path"),c[0].get("is_snapshot"),c[0].get("is_btrfs_subvol"))){this.GetSnapshotDesc(c[0])}e=Ext.util.Format.number(l,"0,000");this.get("name").setValue(k);this.get("real_path").setValue(g);this.get("mod_time").setValue(h);this.get("size").setValue(j?l:Ext.util.Format.fileSize(l)+" ("+e+" Bytes)");if(false===this.gblMultiFiles&&true===c[0].get("isshare")){this.sendWebAPI({api:"SYNO.FileStation.Property.Mtime",method:"get",version:1,params:{file:c[0].get("real_path")},callback:function(s,q,r,i){if(this.isDestroyed){return}if(s&&q.mtime){this.get("mod_time").setValue((new Date(q.mtime*1000)).toLocaleString())}},scope:this})}},checkModified:function(){return false},validateData:function(){return true},collectData:function(){return{}},calcSizeCancel:function(b,a){SYNO.API.currentManager.requestAjaxAPI("SYNO.FileStation.DirSize","stop",2,{async:a,timeout:a?30:10},{taskid:b})},calcMD5Cancel:function(b,a){SYNO.API.currentManager.requestAjaxAPI("SYNO.FileStation.MD5","stop",2,{async:a,timeout:a?30:10},{taskid:b})},handelKillprocess:function(){this.killCalcProcess(false)},killCalcProcess:function(a){if(this.gCalcRequest){this.gCalcRequest.stop();this.gCalcRequest=0;this.calcSizeCancel(this.gCalcSizeTaskId,a)}if(this.gMD5Request){this.gMD5Request.stop();this.gMD5Request=0;this.calcMD5Cancel(this.gCalcMD5TaskId,a)}},onClose:function(){this.killCalcProcess(true);Ext.EventManager.un(window,"unload",this.handelKillprocess,this);SYNO.SDS.StatusNotifier.un("logout",this.handelKillprocess,this);if(SYNO.webfm.utils.isLocalSource(this.source)){if(this.md5ThreadId){var b={threadId:this.md5ThreadId,action:"stopPropertyThread"};AppletProgram.action(b);this.md5ThreadId=null}if(this.sizeThreadId){var a={threadId:this.sizeThreadId,action:"stopPropertyThread"};AppletProgram.action(a);this.sizeThreadId=null}return}}});Ext.define("SYNO.FileStation.PropertyDialog.InfoPage.PosixOwnerFieldset",{extend:SYNO.ux.FieldSet,dsUserList:null,dsGrpList:null,gDefUserVal:null,gDefGrpVal:null,unShow:"----------------",constructor:function(b){this.owner=b.owner;var c=[{xtype:"syno_combobox",fieldLabel:_WFT("filetable","filetable_owner"),name:"cmb_owner",itemId:"cmb_owner",displayField:"name",valueField:"name",triggerAction:"all",mode:"remote",readOnly:b.isShareForceRO,editable:true,resizable:true,pageSize:50,listEmptyText:_WFT("error","error_invalid_user"),grow:true,listWidth:360,maxHeight:360,minChars:1,typeAhead:true},{xtype:"syno_combobox",fieldLabel:_WFT("filetable","filetable_group"),name:"cmb_group",itemId:"cmb_group",displayField:"name",valueField:"name",triggerAction:"all",mode:"remote",readOnly:b.isShareForceRO,editable:true,resizable:true,pageSize:50,listEmptyText:_WFT("error","error_invalid_group"),grow:true,listWidth:360,maxHeight:360,minChars:1,typeAhead:true},{xtype:"syno_checkbox",boxLabel:_WFT("property","privilege_recursive"),hideMode:"display",name:"recursive",itemId:"recursive"}];var a=Ext.apply({title:_WFT("filetable","filetable_owner")+" & "+_WFT("filetable","filetable_group"),border:true,hideMode:"display",synodefaults:{width:300},name:"posixOwnerFieldset",items:c},b);SYNO.FileStation.PropertyDialog.InfoPage.PosixOwnerFieldset.superclass.constructor.call(this,a)},InitUserList:function(){this.dsUserList=new SYNO.API.Store({appWindow:this.owner,autoDestroy:true,api:"SYNO.FileStation.UserGrp",method:"list_user",version:1,baseParams:{type:"all"},reader:new Ext.data.JsonReader({root:"users",totalProperty:"total",id:"name"},[{name:"name",mapping:"name"}]),remoteSort:true,pruneModifiedRecords:true})},InitGrpList:function(){this.dsGrpList=new SYNO.API.Store({appWindow:this.owner,autoDestroy:true,api:"SYNO.FileStation.UserGrp",method:"list_group",version:1,baseParams:{type:"all",name_only:true},reader:new Ext.data.JsonReader({root:"groups",totalProperty:"total",id:"name"},[{name:"name",mapping:"name"}]),remoteSort:false,pruneModifiedRecords:true})},loadData:function(){this.InitUserList();this.InitGrpList();this.LoadUsers();this.LoadGroups();this.LockFields()},LoadUsers:function(){var f=this.rec;var c=this.get("cmb_owner");var a="",e="";var b=0;c.store=this.dsUserList;if(this.gblMultiFiles){var d=false;for(b=0;b<f.length;b++){e=f[b].get("owner");if(a===""){a=e}else{if(a!=e){d=true;break}}}if(d){this.gDefUserVal=this.unShow}else{this.gDefUserVal=a}}else{this.gDefUserVal=f[0].get("owner")}if(this.gDefUserVal===""){this.gDefUserVal=f[0].get("uid")}c.setValue(this.gDefUserVal);delete c.lastQuery},LoadGroups:function(){var e=this.rec;var d=this.get("cmb_group");var g="",a="";var c=0;d.store=this.dsGrpList;var b=(e.length>1);if(b){var f=false;for(c=0;c<e.length;c++){a=e[c].get("group");if(g===""){g=a}else{if(g!=a){f=true;break}}}if(f){this.gDefGrpVal=this.unShow}else{this.gDefGrpVal=g}}else{this.gDefGrpVal=e[0].get("group")}if(this.gDefGrpVal===""){this.gDefGrpVal=e[0].get("gid")}d.setValue(this.gDefGrpVal);delete d.lastQuery},LockFields:function(){this.get("cmb_owner").disable();this.get("cmb_group").disable();this.get("recursive").disable();if(true===_S("is_admin")){this.get("cmb_owner").enable();this.get("cmb_group").enable();if(!this.isShareForceRO){for(var a=0;a<this.rec.length;++a){if(this.rec[a].get("isdir")){this.get("recursive").enable()}}}}},checkModified:function(){var c=this.getComponent("recursive").getValue();var a=this.getComponent("cmb_owner").getValue();var b=this.getComponent("cmb_group").getValue();if(c&&((this.unShow!==a)||(this.unShow!==b))){return true}if((this.gDefUserVal!==a)&&(a!==this.unShow)){return true}if((this.gDefGrpVal!==b)&&(b!==this.unShow)){return true}return false},validateData:function(){var h=this.getComponent("recursive").getValue();var a=this.getComponent("cmb_owner");var e=this.getComponent("cmb_group");var b=a.getValue();var f=e.getValue();if((this.gDefUserVal===b&&!h)||b===this.unShow){b=null}if((this.gDefGrpVal===f&&!h)||f===this.unShow){f=null}var g=false;var d=0;var c=0;if(b!==null&&(this.gDefUserVal!==b)){d=this.dsUserList.getCount();g=false;for(c=0;c<d;c++){if(this.dsUserList.getAt(c).get("name")===b){g=true;break}}if(!g){this.owner.getMsgBox().alert(_WFT("filetable","filetable_properties"),_WFT("acl_editor","error_invalid_user_or_group"));return false}}if(f!==null&&(this.gDefGrpVal!==f)){d=this.dsGrpList.getCount();g=false;for(c=0;c<d;c++){if(this.dsGrpList.getAt(c).get("name")===f){g=true;break}}if(!g){this.owner.getMsgBox().alert(_WFT("filetable","filetable_properties"),_WFT("acl_editor","error_invalid_user_or_group"));return false}}return true},collectData:function(){var e=this.getComponent("recursive").getValue();var a=this.getComponent("cmb_owner");var c=this.getComponent("cmb_group");var b=a.getValue();var d=c.getValue();if((this.gDefUserVal===b&&!e)||b===this.unShow){b=null}if((this.gDefGrpVal===d&&!e)||d===this.unShow){d=null}return{owner:b,group:d,posix_owner_recur:e}},onClose:function(){this.dsUserList.removeAll();this.dsGrpList.removeAll()}});Ext.define("SYNO.FileStation.PropertyDialog.PosixPrivilege",{extend:SYNO.ux.FormPanel,fieldArr:["owner_read","owner_write","owner_execute","group_read","group_write","group_execute","others_read","others_write","others_execute"],constructor:function(b){var a=Ext.apply({layout:"form",trackResetOnLoad:true,waitMsgTarget:true,hideMode:"display",hidden:false,border:false,name:"privilege",items:[{itemId:"fset_posix_mode",xtype:"syno_fieldset",title:_WFT("acl_editor","permission"),hideMode:"display",labelWidth:110,synodefaults:{width:500},items:[{xtype:"syno_compositefield",combineErrors:false,fieldLabel:_WFT("filetable","filetable_owner"),name:"privilege_owner",defaults:{flex:1,height:30},items:[new SYNO.ux.TriModeCheckbox({boxLabel:_WFT("property","privilege_read"),name:"owner_read",value:false,triMode:false}),new SYNO.ux.TriModeCheckbox({boxLabel:_WFT("property","privilege_write"),name:"owner_write",value:false,triMode:false}),new SYNO.ux.TriModeCheckbox({boxLabel:_WFT("property","privilege_execute"),name:"owner_execute",value:false,triMode:false})]},{xtype:"syno_compositefield",combineErrors:false,fieldLabel:_WFT("filetable","filetable_group"),name:"privilege_group",defaults:{flex:1,height:30},items:[new SYNO.ux.TriModeCheckbox({boxLabel:_WFT("property","privilege_read"),name:"group_read",triMode:false}),new SYNO.ux.TriModeCheckbox({boxLabel:_WFT("property","privilege_write"),name:"group_write",triMode:false}),new SYNO.ux.TriModeCheckbox({boxLabel:_WFT("property","privilege_execute"),name:"group_execute",triMode:false})]},{xtype:"syno_compositefield",combineErrors:false,fieldLabel:_WFT("property","privilege_others"),name:"privilege_others",defaults:{flex:1,height:30},items:[new SYNO.ux.TriModeCheckbox({boxLabel:_WFT("property","privilege_read"),name:"others_read",triMode:false}),new SYNO.ux.TriModeCheckbox({boxLabel:_WFT("property","privilege_write"),name:"others_write",triMode:false}),new SYNO.ux.TriModeCheckbox({boxLabel:_WFT("property","privilege_execute"),name:"others_execute",triMode:false})]}]},{xtype:"syno_checkbox",boxLabel:_WFT("property","privilege_recursive"),hideMode:"display",itemId:"mode_recur",name:"mode_recur"}]},b);SYNO.FileStation.PropertyDialog.PosixPrivilege.superclass.constructor.call(this,a)},loadData:function(){this.LoadPrivilege();this.LockFields()},LoadPrivilege:function(){var c=this.rec;var d=this.fieldArr;var b=0;function e(j){var g=0,h=0,f=0;var k={};var i=parseInt(j,10);if(i>=100){g=Math.floor(i/100);i-=g*100}if(i>=10){h=Math.floor(i/10);i-=h*10}f=i;k={owner_read:(g&4)?true:false,owner_write:(g&2)?true:false,owner_execute:(g&1)?true:false,group_read:(h&4)?true:false,group_write:(h&2)?true:false,group_execute:(h&1)?true:false,others_read:(f&4)?true:false,others_write:(f&2)?true:false,others_execute:(f&1)?true:false};return k}function a(l){var h={};var m=[];var k="";var g=0,f;for(g=0;g<d.length;g++){h[d[g]]=null}for(g=0;g<l.length;g++){k=l[g].get("privilege");m=e(k);for(f=0;f<d.length;f++){if(g===0){h[d[f]]=m[d[f]]}if(h[d[f]]!=m[d[f]]){h[d[f]]=null}}}return h}for(b=0;b<this.fieldArr.length;b++){this.form.findField(this.fieldArr[b]).setTriMode(this.gblMultiFiles)}this.form.setValues(a(c))},LockFields:function(){var e=0;var b=_S("is_admin");this.form.findField("mode_recur").disable();if(!this.isShareForceRO&&true===b){for(e=0;e<this.rec.length;++e){if(this.rec[e].get("isdir")){this.form.findField("mode_recur").enable()}}}var f=this.isShareForceRO;var c;var h;for(e=0;e<this.rec.length;e++){if(SYNO.webfm.VFS.isVFSPath(this.rec[e].get("file_id"))&&-1==SYNO.webfm.VFS.SupportChmodList.indexOf(SYNO.webfm.VFS.getSchemaFromPath(this.rec[e].get("file_id")).toLowerCase())){this.form.findField("mode_recur").disable();f=true;break}c=Ext.util.Format.lowercase(this.rec[e].get("file_id"));h=c.indexOf("/",1);if(h>0){c=c.substr(0,h)}if("/photo"===c){f=true;break}}var d;var a=true;for(e=0;e<this.rec.length;e++){if(Ext.isDefined(this.rec[e].get("uid"))){d=this.rec[e].get("uid");if(d!=this.userId){a=false;break}}else{if(this.rec[e].get("owner")!=_S("user")){a=false;break}}}for(e=0;e<this.fieldArr.length;e++){var g=null;g=this.form.findField(this.fieldArr[e]);if(g){if(f||(!b&&!a)){g.disable()}else{g.enable()}}}},checkModified:function(){return this.form.isDirty()},validateData:function(){return true},collectData:function(){var b=this.form;var d=this.fieldArr;var f=this.getComponent("mode_recur").getValue();function c(o){var m=[4,2,1];var g=0;var n=null;var k=0;var h=0;var l=0;if(!o&&!b.findField("privilege_owner").isDirty()&&!b.findField("privilege_group").isDirty()&&!b.findField("privilege_others").isDirty()){return -1}for(k=0;k<d.length;k++){n=null;n=b.findField(d[k]);if(n&&n.getValue()==="true"){g|=m[h]}h++;if(k==2){if(g>0){l=g*100}h=0;g=0}else{if(k==5){if(g>0){l+=g*10}h=0;g=0}else{if(k==(d.length-1)&&g>0){l+=g}}}}return l}function e(){var h=[];var g=0;for(g=0;g<d.length;g++){var j=null,k;j=b.findField(d[g]);if(j){k=-1;if(j.isDirty()){k=j.getValue();switch(k){case"true":k=1;break;case"false":k=0;break;default:k=-1;break}}h[g]=k}}return h.join(":")}var a=-1;if(this.gblMultiFiles){a=e()}else{a=c(f)}return{mode:a,posix_mode_recur:f}},onClose:function(){this.form.reset()}});Ext.define("SYNO.FileStation.PropertyDialog.InfoPage.ACLOwnerFieldset",{extend:SYNO.ux.FieldSet,gDefOwnerVal:null,constructor:function(b){Ext.apply(this,b);var c=[new SYNO.FileStation.PropertyDialog.ACLPrivilege.UserGrpCombo({fieldLabel:_WFT("filetable","filetable_owner"),width:335,listWidth:335,itemId:"owner_cmb",queryParam:"prefix"}),{xtype:"syno_checkbox",itemId:"owner_recur",boxLabel:_WFT("property","privilege_recursive"),hideMode:"display",hidden:_S("diskless"),name:"recursive"}];var a={title:_WFT("filetable","filetable_owner"),border:true,hideMode:"display",name:"aclOwnerFieldset",items:c};SYNO.FileStation.PropertyDialog.InfoPage.ACLOwnerFieldset.superclass.constructor.call(this,a)},loadData:function(){this.get("owner_cmb").setReadOnly(true);this.get("owner_recur").disable();this.sendWebAPI({api:"SYNO.FileStation.Property.ACLOwner",method:"get",version:1,scope:this,params:{file:this.gTargetFiles.split("_SYNOFM_")[0]},callback:function(a,d,c,b){this.afterLoadData(a,d,b)}})},afterLoadData:function(a,e,d){if(this.isDestroyed){return}var f=this.get("owner_cmb");if(_S("is_admin")){f.setReadOnly(false)}if(!a){if(403!=e.code){this.owner.fireEvent("error",SYNO.webfm.utils.getWebAPIErrStr(a,e,d))}else{var c=SYNO.webfm.utils.getWebAPIErrStr(a,e,d);f.setDefaultValue(c,"",c);this.gDefOwnerVal=c}}else{f.setDefaultValue(e.name,e.type,e.value);this.gDefOwnerVal=e.value}if(true!==e.hasPrivilege&&true!==_S("is_admin")){return}f.setReadOnly(this.isShareForceRO);if(!this.isShareForceRO&&this.rec[0].get("isdir")){this.get("owner_recur").enable()}var b=function(h,g){return g.type+":"+g.name};if(_S("is_admin")){f.store=new Ext.data.Store({autoDestroy:true,proxy:new SYNO.API.Proxy({api:"SYNO.Core.ACL",method:"list_owners",version:1}),reader:new Ext.data.JsonReader({root:"owners",totalProperty:"total",id:"value"},[{name:"type"},{name:"name"},{name:"value",convert:b}]),paramNames:{start:"offset",limit:"limit"},remoteSort:true,baseParams:{include_everyone:false,include_owner:false},pruneModifiedRecords:true})}else{if("user"===e.type&&_S("user")===e.name){f.setReadOnly(true)}else{f.mode="local";f.store=new Ext.data.ArrayStore({autoDestroy:true,fields:["type","name","value"],data:[["user",_S("user"),"user:"+_S("user")],[e.type,e.name,e.value]]})}}},checkModified:function(){if(this.getComponent("owner_recur").isDirty()){return true}var a=this.getComponent("owner_cmb");if(a.isDirty()&&this.gDefOwnerVal!==a.getValue()){return true}return false},validateData:function(){var d=this.getComponent("owner_cmb");var b=d.getValue();var c=b.substr(0,b.indexOf(":"));var a=b.substr(b.indexOf(":")+1);if(d.valueNotFound()||a===null||a===""||c===null||c===""){this.owner.getMsgBox().alert(_WFT("error","error_error"),_WFT("error","error_invalid_user"));return false}return true},collectData:function(){if(this.checkModified()){var b=this.getComponent("owner_cmb");var a=b.getValue();return{change_acl_owner:true,acl_owner_type:a.substr(0,a.indexOf(":")),acl_owner:a.substr(a.indexOf(":")+1),acl_owner_recur:this.getComponent("owner_recur").getValue()}}else{return{}}},onClose:function(){this.getTaskRunner().stopAll()}});SYNO.FileStation.PropertyDialog.ACLPermissionTable=[["read_data","r",false],["write_data","w",false],["exe_file","x",false],["append_data","p",false],["delete","d",false],["delete_sub","D",false],["read_attr","a",false],["write_attr","A",false],["read_ext_attr","R",false],["write_ext_attr","W",false],["read_perm","c",false],["change_perm","C",false],["take_ownership","o",false]];SYNO.FileStation.PropertyDialog.ACLInheritTable=[["child_files","f",false],["child_folders","d",false],["this_folder","i",true],["all_descendants","n",true]];SYNO.FileStation.PropertyDialog.ACLUtils=function(){var d=SYNO.FileStation.PropertyDialog.ACLPermissionTable;var b=SYNO.FileStation.PropertyDialog.ACLInheritTable;function a(e,g){var f="";g.each(function(i){var k=i[0],h=i[1],j=i[2];if(e[k]){f+=(j)?"-":h}else{f+=(j)?h:"-"}});return f}function c(g,f){var e={};f.each(function(i){var k=i[0],h=i[1],j=i[2];if(-1!==g.indexOf(h)){e[k]=!(j)}else{e[k]=j}});return e}return{PermissionObjToStr:function(e){return a(e,d)},InheritObjToStr:function(e){return a(e,b)},PermissionStrToObj:function(e){return c(e,d)},InheritStrToObj:function(e){return c(e,b)}}}();Ext.define("SYNO.FileStation.PropertyDialog.ACLPrivilege",{extend:SYNO.ux.GridPanel,ACE_Store:null,editorDialog:null,loadingStatus:"success",isInherieted:false,originInherieted:false,modifiedACL:false,isRealACL:true,hasChangePerm:false,max_explicit_num:200,constructor:function(c){this.isHomes=(c.rec[0].get("filename").toLowerCase()==="homes")&&(c.rec[0].get("isshare")===true);var a=function(f,e){var d=SYNO.FileStation.PropertyDialog.ACLUtils;return d.PermissionObjToStr(e.permission)+d.InheritObjToStr(e.inherit)};this.ACE_Store=new Ext.data.Store({autoDestroy:true,proxy:new SYNO.API.Proxy({api:"SYNO.Core.ACL",method:"get",version:1,appWindow:this,listeners:{beforeload:{fn:function(){this.loadingStatus="loading";this.getEl().mask(_WFT("common","loading"),"x-mask-loading")},scope:this},load:{fn:this.afterProxySuccessLoad,scope:this},exception:{fn:function(f,g,h,e,i,d){this.loadingStatus=_WFT("common","error_system");if(Ext.isDefined(i.code)){this.loadingStatus=SYNO.API.getErrorString(i.code)}this.getEl().mask(this.loadingStatus)},scope:this}}}),reader:new Ext.data.JsonReader({root:"acl",totalProperty:"total",id:"acl",fields:[{name:"user_type",mapping:"owner_type"},{name:"user_name",mapping:"owner_name"},{name:"type",mapping:"permission_type"},{name:"permission",convert:a},{name:"level"}]}),baseParams:{type:"all",file_path:c.gTargetFiles},pruneModifiedRecords:true,aclSort:function(){this.sort([{field:"level",direction:"ASC"},{field:"type",direction:"DESC"},{field:"user_type",direction:"DESC"},{field:"user_name",direction:"ASC"}],"ASC")},listeners:{load:{fn:function(d){this.aclSort()}}}});var b=Ext.apply({store:this.ACE_Store,autoExpandColumn:"user_name",colModel:new Ext.grid.ColumnModel([{header:"",datatIndex:"user_type",width:34,fixed:true,sortable:false,menuDisabled:true,renderer:function(f,e,d){f=d.get("user_type");if("user"===f){return'<div class="acl-grid-item-user" style="width: 26px; height: 26px; margin-left: -4px;"> </div>'}else{return'<div class="acl-grid-item-group" style="width: 26px; height: 26px; margin-left: -4px;"> </div>'}}},{id:"user_name",header:_WFT("acl_editor","user_or_group"),datatIndex:"user_name",width:400,sortable:false,menuDisabled:true,renderer:function(f,e,d,g){return d.get("user_name")}},{header:_WFT("acl_editor","type"),datatIndex:"type",width:80,sortable:false,menuDisabled:true,renderer:function(f,e,d,g){f=d.get("type");if("deny"===f){return _WFT("acl_editor","deny")}else{return _WFT("acl_editor","allow")}}},{header:_WFT("acl_editor","permission"),datatIndex:"permission",width:130,sortable:false,menuDisabled:true,renderer:{fn:this.simplePermission,scope:this}},{header:"level",dataIndex:"level",hidden:true,sortable:false,menuDiabled:true}]),selModel:new Ext.grid.RowSelectionModel({listeners:{selectionchange:{fn:function(d){this.updateToolBarBts()},scope:this}}}),stripeRows:true,tbar:[{xtype:"syno_button",text:_WFT("common","create"),itemId:"addbt",handler:this.onAddBtClick,scope:this},{xtype:"syno_button",text:_WFT("common","delete"),itemId:"deletebt",handler:this.onDeleteBtClickHandler,scope:this,disabled:true},{xtype:"syno_button",text:(c.isShareForceRO)?_WFT("acl_editor","view"):_WFT("common","alt_edit"),itemId:"modifybt",handler:this.onModifyBtClick,scope:this,disabled:true},new SYNO.ux.Button({text:_WFT("mount","adv_opt"),itemId:"advancebt",tabIndex:-1,menu:new SYNO.ux.Menu({items:[{text:_WFT("acl_editor","remove_inherited"),itemId:"removeInherited",handler:this.removeInherited,scope:this},{text:_WFT("acl_editor","make_inherited_explicit"),itemId:"makeInheritedExplicit",handler:this.makeInheritedExplicit,scope:this},{text:_WFT("acl_editor","add_inherited"),itemId:"addInherited",handler:this.addInherited,scope:this},{xtype:"menuseparator",itemId:"inherietMenuSP"},{text:_WFT("acl_editor","effective_permission_inspector"),itemId:"inspector",handler:this.onInspectorBtClick,scope:this}]})})],bbar:[{xtype:"syno_checkbox",boxLabel:_WFT("property","privilege_recursive"),hideMode:"display",itemId:"acl_privilage_recur",listeners:{check:{fn:function(e,d){this.updateAdvancedBt()},scope:this}}}],forceLayout:true,viewConfig:{forceFit:true,getRowClass:function(d,g,f,e){if(d.data.level>0){return"x-grid-record-gray"}}},listeners:{afterlayout:{fn:function(){if("success"===this.loadingStatus){this.getEl().unmask()}else{if("loading"===this.loadingStatus){this.getEl().mask(_WFT("common","loading"),"x-mask-loading")}else{this.getEl().mask(this.loadingStatus)}}},scope:this},rowdblclick:{fn:function(d,g,f){this.onModifyBtClick()},scope:this}}},c);SYNO.FileStation.PropertyDialog.ACLPrivilege.superclass.constructor.call(this,b);this.addClass("acl-grid")},afterProxySuccessLoad:function(b,c,a){this.isRealACL=c.is_acl;if(true===this.isShareForceRO){this.hasChangePerm=false}else{if(true===this.isRealACL){this.hasChangePerm=c.change_permission}else{this.hasChangePerm=false;if(!c.acl_editable){this.hasChangePerm=false}else{if(true===_S("is_admin")){this.hasChangePerm=true}else{if(Ext.isDefined(this.rec[0].get("uid"))){if(this.rec[0].get("uid")===this.userId){this.hasChangePerm=true}}else{if(this.rec[0].get("owner")===_S("user")){this.hasChangePerm=true}}}}}}this.isInherieted=c.is_inherited;this.originInherieted=this.isInherieted;this.updateAdvancedBt();this.updateToolBarBts();if(false===this.hasChangePerm){this.getBottomToolbar().get("acl_privilage_recur").disable()}this.loadingStatus="success";this.getEl().unmask()},getEditorDialog:function(){if(null===this.editorDialog){this.editorDialog=new SYNO.FileStation.PropertyDialog.ACLPrivilege.EditorDialog({owner:this.owner,findAppWindow:this.findAppWindow});this.mon(this.editorDialog,"addACE",this.addACE,this);this.mon(this.editorDialog,"deleteACE",this.deleteACE,this)}return this.editorDialog},loadData:function(){if(this.rec[0].get("isdir")){this.getBottomToolbar().get("acl_privilage_recur").enable()}else{this.getBottomToolbar().get("acl_privilage_recur").disable()}this.ACE_Store.load({scope:this,callback:this.launchEditor})},launchEditor:function(){if(!this.isFirstLoad||!Ext.isObject(this.openConfig)){return}this.isFirstLoad=false;var c="none",b=0,a=0;this.getStore().each(function(d){if(d.get("user_type")===this.openConfig.userType&&d.get("user_name").toLowerCase()===this.openConfig.userName.toLowerCase()){if(c==="once"){c="twice";return false}c="once";a=b}b++},this);if(c==="none"){this.onAddBtClick()}else{if(c==="once"){this.getSelectionModel().selectRow(a);this.onModifyBtClick()}}},checkModified:function(){if(this.modifiedACL){return true}if(this.isInherieted!==this.originInherieted){return true}if(true===this.getBottomToolbar().get("acl_privilage_recur").getValue()){return true}return false},validateData:function(){return true},collectData:function(){var b=[];var c=(this.modifiedACL||!this.isRealACL||(this.isInherieted!==this.originInherieted));var a=SYNO.FileStation.PropertyDialog.ACLUtils;if(c){this.ACE_Store.each(function(d){var e={};if(0!==d.get("level")){return true}e.owner_type=d.get("user_type");if(e.owner_type=="owner"){e.owner_name="Owner"}else{if(e.owner_type=="everyone"){e.owner_name="Everyone"}else{e.owner_name=d.get("user_name")}}e.permission_type=d.get("type");e.permission=a.PermissionStrToObj(d.get("permission").substr(0,13));e.inherit=a.InheritStrToObj(d.get("permission").substr(13,4));b.push(e);return true})}return{change_acl:c,rules:b,inherited:this.isInherieted,acl_recur:this.getBottomToolbar().get("acl_privilage_recur").getValue()}},onClose:function(){this.ACE_Store.removeAll()},checkIfExceedExplicitCount:function(c){var b=0;function a(d){if(0===d.get("level")){++b}}this.ACE_Store.each(a,this);b=b+c;if(b<=this.max_explicit_num){return false}this.owner.getMsgBox().alert(_WFT("error","error_error"),_WFT("acl_editor","acl_rules_reach_limit")+"<br>"+_WFT("acl_editor","acl_rules_reach_limit_report").replace("_count_",b).replace("_maxCount_",this.max_explicit_num));return true},onAddBtClick:function(){if(this.checkIfExceedExplicitCount(1)){return}var a=(arguments.length!==0)?{}:{isFirstLoad:true,openConfig:this.openConfig};this.getEditorDialog().load(Ext.apply({mode:"add",file_id:this.rec[0].get("file_id"),isdir:this.rec[0].get("isdir")},a))},onDeleteBtClickHandler:function(){if(this.isHomes){var e=this.getSelectionModel();var c=e.getSelections();var d=function(f){if("yes"==f){this.onDeleteBtClick()}else{return}};for(var a=0;a<c.length;++a){var b=c[a].data;if(b.user_type==="everyone"&&b.type=="allow"&&2==b.permission.search("x")){this.owner.getMsgBox().confirm(_WFT("common","reminder"),_T("share","warn_delete_homes_everyone_acl"),d,this);return}}}this.onDeleteBtClick()},onDeleteBtClick:function(){var c=this.getSelectionModel();var b=c.getSelections();this.ACE_Store.suspendEvents(false);for(var a=0;a<b.length;++a){this.deleteACE(b[a])}this.ACE_Store.resumeEvents();this.ACE_Store.aclSort();c.selectRow((c.last<c.lastActive)?c.last:c.lastActive);c.selectLastRow();if(false===c.hasSelection()){c.selectLastRow()}},onModifyBtClick:function(){var b=this.getSelectionModel();var a=b.getSelections();if(1!==a.length){return}this.getEditorDialog().load({mode:(a[0].get("level")===0&&this.hasChangePerm)?"edit":"view",aceRC:a[0],file_id:this.rec[0].get("file_id"),isdir:this.rec[0].get("isdir")})},onInspectorBtClick:function(){this.getEditorDialog().load({mode:"inspector",file_id:this.rec[0].get("file_id"),file_path:this.rec[0].get("real_path"),file_name:this.rec[0].get("filename"),isdir:false})},addACE:function(c,b){while(this.mergeACEwithStoreRecords(c)){}var a=new Ext.data.Record(c);if(false===b){this.ACE_Store.add(a)}else{this.ACE_Store.addSorted(a)}this.getSelectionModel().selectRecords([a]);this.modifiedACL=true;this.updateAdvancedBt();if(this.isHomes){if(c.type==="deny"&&2==c.permission.search("x")){this.owner.getMsgBox().alert(_WFT("common","reminder"),_T("share","warn_deny_rule_homes_acl"))}}},deleteACE:function(a){if(0===a.get("level")){this.ACE_Store.remove(a)}this.modifiedACL=true;this.updateAdvancedBt()},mergeACEwithStoreRecords:function(g){var d=false;var a;var h;var b;var e,c;var f=false;for(e=0;e<this.ACE_Store.getCount();++e){a=this.ACE_Store.getAt(e);if(0!==a.get("level")){continue}if(a.get("type")!==g.type||a.get("user_name").toLowerCase()!==g.user_name.toLowerCase()||a.get("user_type")!==g.user_type){continue}h=a.get("permission");f=false;b="";for(c=0;c<17;++c){if((g.permission.charAt(c)!=="-")^(c===15||c===16)){b=b.concat(g.permission.charAt(c))}else{b=b.concat(h.charAt(c))}}if(h===b||g.permission===b){f=true}else{if(h.substr(13,4)===g.permission.substr(13,4)){f=true}else{if(h.substr(0,13)===g.permission.substr(0,13)){if(g.permission.charAt(16)!==h.charAt(16)&&(g.permission.charAt(13)!==h.charAt(13)||g.permission.charAt(14)!==h.charAt(14))){f=false}else{f=true}}else{f=false}}}if(true===f){g.permission=b;this.ACE_Store.removeAt(e);d=true;--e}}return d},removeInherited:function(){this.getStore().filterBy(function(a,b){if(a.get("level")>0){return false}return true});this.isInherieted=false;this.getStore().commitChanges();this.updateAdvancedBt()},makeInheritedExplicit:function(){var a=0;this.getStore().each(function(b){if(b.get("level")>0){++a}},this);if(this.checkIfExceedExplicitCount(a)){return}this.ACE_Store.suspendEvents(false);this.getStore().each(function(b){if(b.get("level")>0){b.set("level",0);this.addACE(b.data,false)}},this);this.ACE_Store.resumeEvents();this.ACE_Store.aclSort();this.getStore().commitChanges();this.isInherieted=false;this.modifiedACL=true;this.updateAdvancedBt()},addInherited:function(){if(!this.el.isMasked()){this.el.mask(_WFT("common","loading"),"x-mask-loading")}this.sendWebAPI({api:"SYNO.Core.ACL",method:"get",version:1,scope:this,params:{type:"inherite",file_path:this.gTargetFiles},callback:function(d,c,b){if(this.isDestroyed){return}if(!d){var a=_WFT("common","error_system");if(Ext.isDefined(c.code)){a=SYNO.API.getErrorString(c.code)}this.el.mask(a);return false}this.getStore().loadData(c,true);this.isInherieted=true;this.updateAdvancedBt();this.el.unmask()}})},simplePermission:function(e,c,b){var f=false;var d=false;var a=false;e=b.get("permission");if(this.rec[0].get("isdir")&&e.substr(13,4)!=="fd--"){return _WFT("acl_editor","perm_custom")}if(e.substr(11,2)==="Co"){a=true}else{if(e.substr(11,2)!=="--"){return _WFT("acl_editor","perm_custom")}}if(e.charAt(0)==="r"&&e.charAt(2)==="x"&&e.charAt(6)==="a"&&e.charAt(8)==="R"&&e.charAt(10)==="c"){f=true}else{if(e.charAt(0)==="r"||e.charAt(2)==="x"||e.charAt(6)==="a"||e.charAt(8)==="R"||e.charAt(10)==="c"){return _WFT("acl_editor","perm_custom")}}if(e.charAt(1)==="w"&&e.charAt(3)==="p"&&e.charAt(4)==="d"&&e.charAt(5)==="D"&&e.charAt(7)==="A"&&e.charAt(9)==="W"){d=true}else{if(e.charAt(1)==="w"||e.charAt(3)==="p"||e.charAt(4)==="d"||e.charAt(5)==="D"||e.charAt(7)==="A"||e.charAt(9)==="W"){return _WFT("acl_editor","perm_custom")}}if(a){if(f&&d){return _WFT("acl_editor","perm_full_control")}else{return _WFT("acl_editor","perm_custom")}}if(f&&d){return _WFT("filetable","filetable_read")+" & "+_WFT("filetable","filetable_write")}if(f){return _WFT("filetable","filetable_read")}if(d){return _WFT("filetable","filetable_write")}return _WFT("acl_editor","perm_custom")},updateToolBarBts:function(){var f=this.getSelectionModel();var e=f.getSelections();var a=true;var d=true;var c=true;if(0>=e.length){a=false;d=false}else{if(1===e.length){a=true;d=true}else{a=true;d=false}}for(var b=0;b<e.length;++b){if(e[b].get("level")!==0){c=false;break}}if(this.hasChangePerm){this.getTopToolbar().get("addbt").enable()}else{this.getTopToolbar().get("addbt").disable()}if(c&&a&&this.hasChangePerm){this.getTopToolbar().get("deletebt").enable()}else{this.getTopToolbar().get("deletebt").disable()}if(d){this.getTopToolbar().get("modifybt").enable();if(this.hasChangePerm&&c){this.getTopToolbar().get("modifybt").setText(_WFT("common","alt_edit"))}else{this.getTopToolbar().get("modifybt").setText(_WFT("acl_editor","view"))}}else{this.getTopToolbar().get("modifybt").disable()}},updateAdvancedBt:function(){var a=this.rec[0].get("isshare");if(this.isInherieted&&this.hasChangePerm&&!a){this.getTopToolbar().get("advancebt").menu.get("removeInherited").show();this.getTopToolbar().get("advancebt").menu.get("makeInheritedExplicit").show()}else{this.getTopToolbar().get("advancebt").menu.get("removeInherited").hide();this.getTopToolbar().get("advancebt").menu.get("makeInheritedExplicit").hide()}if(false===this.isInherieted&&this.hasChangePerm&&!a){this.getTopToolbar().get("advancebt").menu.get("addInherited").show()}else{this.getTopToolbar().get("advancebt").menu.get("addInherited").hide()}if(false===this.hasChangePerm||a){this.getTopToolbar().get("advancebt").menu.get("inherietMenuSP").hide()}else{this.getTopToolbar().get("advancebt").menu.get("inherietMenuSP").show()}if(this.checkModified()){this.getTopToolbar().get("advancebt").menu.get("inspector").setDisabled(true)}else{this.getTopToolbar().get("advancebt").menu.get("inspector").setDisabled(false)}}});Ext.define("SYNO.FileStation.PropertyDialog.ACLPrivilege.EditorDialog",{extend:SYNO.SDS.ModalWindow,permTreeTbl:[["/tree_root/read/read_data","r",true],["/tree_root/write/write_data","w",true],["/tree_root/read/exe_file","x",true],["/tree_root/write/append_data","p",true],["/tree_root/write/delete","d",true],["/tree_root/write/delete_sub","D",true],["/tree_root/read/read_attr","a",true],["/tree_root/write/write_attr","A",true],["/tree_root/read/read_ext_attr","R",true],["/tree_root/write/write_ext_attr","W",true],["/tree_root/read/read_perm","c",true],["/tree_root/admin/change_perm","C",true],["/tree_root/admin/change_owner","o",true]],constructor:function(a){var e=this;function b(){var g=new Ext.data.SimpleStore({fields:["id","state","check","disable"],idIndex:0,data:[["self",_WFT("acl_editor","this_folder"),false,false],["cfolder",_WFT("acl_editor","child_folders"),false,false],["cfile",_WFT("acl_editor","child_files"),false,false],["descendants",_WFT("acl_editor","all_descendants"),false,false]]});var f=function(j,i){return i.type+":"+i.name};var h={layout:"form",autoScroll:false,autoFlexcroll:false,useGradient:false,trackResetOnLoad:true,waitMsgTarget:true,hideMode:"display",hidden:false,border:false,itemId:"info_panel",width:520,height:130,synodefaults:{width:335},items:[{width:325,xtype:"syno_textfield",fieldLabel:_WFT("common","common_filename"),itemId:"file_name",readOnly:true,cls:"selectabletext allowDefCtxMenu"},new SYNO.FileStation.PropertyDialog.ACLPrivilege.UserGrpCombo({fieldLabel:_WFT("acl_editor","user_or_group"),itemId:"cmb_owner",queryParam:"prefix",width:325,listWidth:325,store:new Ext.data.Store({autoDestroy:true,proxy:new SYNO.API.Proxy({api:"SYNO.Core.ACL",method:"list_owners",version:1,appWindow:e}),reader:new Ext.data.JsonReader({root:"owners",totalProperty:"total",id:"value"},[{name:"type"},{name:"name"},{name:"value",convert:f}]),paramNames:{start:"offset",limit:"limit"},remoteSort:true,baseParams:{include_everyone:false,include_owner:false},pruneModifiedRecords:true})}),{xtype:"syno_textfield",fieldLabel:_WFT("acl_editor","inheriet_from"),itemId:"inheriet_from",width:325,readOnly:true,cls:"selectabletext allowDefCtxMenu"},{xtype:"syno_combobox",fieldLabel:_WFT("acl_editor","type"),width:325,itemId:"cmb_type",store:new Ext.data.ArrayStore({fields:["ace_type","type"],data:[[_WFT("acl_editor","allow"),"allow"],[_WFT("acl_editor","deny"),"deny"]]}),value:"allow",displayField:"ace_type",valueField:"type",triggerAction:"all",editable:false,resizable:false,allowBlank:false,forceSelection:true},new SYNO.ux.ComboBox({itemId:"cmb_apply",width:325,labelStyle:"margin-left: 0px; width: 180px;",triggerAction:"all",grow:true,listWidth:325,maxHeight:360,editable:false,fieldLabel:_WFT("acl_editor","apply_to"),store:g,displayField:"state",typeAhead:true,mode:"local",tpl:'<tpl for="."><div class="acl-apply-list x-combo-list-item {[values.disable?"x-item-disabled":""]}" ><span><input type="checkbox" {[values.check?"checked":""]} value="{[values.state]}"/></span><span> {state}</span></div></tpl>',selectOnFocus:true,itemReadOnly:false,onSelect:function(i,j){if(!this.itemReadOnly){i.set("check",!i.get("check"));this.updateStatus()}},cls:"sds-ellipsis",setPermValue:function(m){var k=this.getStore();var j=k.getById("self");var i=k.getById("cfolder");var l=k.getById("cfile");var n=k.getById("descendants");j.set("check",("-"===m.charAt(2)));i.set("check",("d"===m.charAt(1)));l.set("check",("f"===m.charAt(0)));n.set("check",("-"===m.charAt(3)));this.updateStatus()},getPermValue:function(){var m=[];var k=this.getStore();var j=k.getById("self");var i=k.getById("cfolder");var l=k.getById("cfile");var n=k.getById("descendants");m.push(l.get("check")?"f":"-");m.push(i.get("check")?"d":"-");m.push(j.get("check")?"-":"i");m.push(n.get("check")?"-":"n");return m.join("")},updateStatus:function(){var i=false;var j=true;var k=[];this.store.each(function(l){if(l.get("check")){if("cfolder"===l.get("id")||"cfile"===l.get("id")){i=true}if("descendants"!==l.get("id")||i){k.push(l.get("state"))}}else{j=false}});if(j){this.setValue(_WFT("acl_editor","all_scope"))}else{this.setValue(k.join(", "))}Ext.QuickTips.unregister(this.getEl());Ext.QuickTips.register({target:this.getEl(),title:"",text:k.join("<br>")});if(!i){this.store.getById("descendants").set("check",false);this.store.getById("descendants").set("disable",true)}else{this.store.getById("descendants").set("disable",false)}}})],layoutConfig:{trackLabels:true}};return new SYNO.ux.FormPanel(h)}function d(){var f=function(){var h=[{text:_WFT("acl_editor","administration"),id:"admin",children:[{text:_WFT("acl_editor","change_permissions"),id:"change_perm"},{text:_WFT("acl_editor","take_ownership"),id:"change_owner"}]},{text:_WFT("filetable","filetable_read"),id:"read",children:[{text:_WFT("acl_editor","travers_folder_execute_file"),id:"exe_file"},{text:_WFT("acl_editor","list_folder_read_data"),id:"read_data"},{text:_WFT("acl_editor","read_attributes"),id:"read_attr"},{text:_WFT("acl_editor","read_extended_atrributes"),id:"read_ext_attr"},{text:_WFT("acl_editor","read_permissions"),id:"read_perm"}]},{text:_WFT("filetable","filetable_write"),id:"write",children:[{text:_WFT("acl_editor","create_files_write_data"),id:"write_data"},{text:_WFT("acl_editor","create_folders_append_data"),id:"append_data"},{text:_WFT("acl_editor","write_attributes"),id:"write_attr"},{text:_WFT("acl_editor","write_extended_attributes"),id:"write_ext_attr"},{text:_WFT("acl_editor","delete_subfolders_and_files"),id:"delete_sub"},{text:_WFT("acl_editor","delete"),id:"delete"}]}];for(var g=0;g<h.length;++g){h[g].uiProvider=SYNO.FileStation.PropertyDialog.ACLPrivilege.TreeNodeUI;h[g].cls="node_no_display";h[g].leaf=false;for(var i=0;i<h[g].children.length;++i){h[g].children[i].uiProvider=SYNO.FileStation.PropertyDialog.ACLPrivilege.TreeNodeUI;h[g].children[i].cls="node_no_display";h[g].children[i].leaf=true}}return h}();return new SYNO.ux.TreePanel({title:_WFT("acl_editor","permission"),itemId:"perm_tree",height:358,autoHeight:false,enableDD:false,useArrows:true,border:false,rootVisible:false,allNodeCheckable:true,bodyStyle:"padding: 4px 2px 0px 4px;",cls:"acl-tree",loader:new Ext.tree.TreeLoader({preloadChildren:true,clearOnLoad:false}),root:new Ext.tree.AsyncTreeNode({id:"tree_root",expanded:true,children:f}),setAllNodeCheckable:function(h){this.allNodeCheckable=h;var g=this.getRootNode();g.eachChild(function(i){i.getUI().setCheckable(h)})}})}var c=Ext.apply({width:560,height:580,resizable:false,collapsible:false,bodyStyle:"padding: 0 20px 4px 20px;",items:[b(),d()],buttons:[{btnStyle:"blue",text:_WFT("common","ok"),itemId:"ok_btn",handler:this.okHandler,scope:this},{text:_WFT("common","close"),itemId:"close_btn",scope:this,handler:function(){this.hide();this.body.unmask()}}],listeners:{hide:{fn:function(){this.getTaskRunner().stopAll()},scope:this}}},a);SYNO.FileStation.PropertyDialog.ACLPrivilege.EditorDialog.superclass.constructor.call(this,c);this.addClass("acl-permission-win")},adjustDialog:function(){var b=this.getHeight();if(this.get("perm_tree")&&this.get("perm_tree").getEl()){b-=this.body.getBottom()-this.get("perm_tree").getEl().getBottom()-26}var a=SYNO.SDS.Desktop.getEl().getHeight();if(a<b){b=a}this.setHeight(b)},load:function(a){Ext.apply(this,a);this.show().center();this.fillComponent()},fillComponent:function(){this.setupWindow();this.fillFileName();this.fillOwner();this.fillInherietForm();this.fillType();this.fillPermission();this.adjustDialog()},setupWindow:function(){this.getFooterToolbar().getComponent("ok_btn").setVisible(true);if("edit"===this.mode||"add"===this.mode){this.setTitle(_WFT("acl_editor","permission_editor"))}else{if("view"===this.mode){this.setTitle(_WFT("acl_editor","permission_viewer"));this.getFooterToolbar().getComponent("ok_btn").setVisible(false)}else{this.setTitle(_WFT("acl_editor","effective_permission_inspector"));this.getFooterToolbar().getComponent("ok_btn").setVisible(false)}}},fillFileName:function(){var a=this.get("info_panel").get("file_name");if("inspector"!==this.mode){a.hide();return}a.show();a.setValue(this.file_name)},fillOwner:function(){var e=this.get("info_panel").get("cmb_owner");var b="",a="",d="";e.setReadOnly(false);if("edit"===this.mode||"view"===this.mode){b=this.aceRC.get("user_type");a=this.aceRC.get("user_name");d=b+":"+a;e.setDefaultValue(a,b,d);if("view"===this.mode){e.setReadOnly(true)}}else{if(this.isFirstLoad&&"add"===this.mode&&Ext.isObject(this.openConfig)){this.isFirstLoad=false;b=this.openConfig.userType;a=this.openConfig.userName;d=b+":"+a;e.setDefaultValue(a,b,d)}else{e.clearValue();e.clearIconCls()}}if("inspector"===this.mode){this.mon(e,"valueset",this.doInspect,this);e.getStore().setBaseParam("include_builtin",true);e.getStore().setBaseParam("include_everyone",true);e.getStore().setBaseParam("include_owner",false);e.getStore().setBaseParam("include_internal",true);delete e.lastQuery}else{this.mun(e,"valueset",this.doInspect,this);e.getStore().setBaseParam("include_builtin",true);e.getStore().setBaseParam("include_everyone",true);e.getStore().setBaseParam("include_owner",true);e.getStore().setBaseParam("include_internal",true);delete e.lastQuery}var c=false;if(this.owner&&this.owner.rec&&this.owner.rec[0].get("real_path")){c=(1===this.owner.rec[0].get("real_path").indexOf("volumeGluster"))}if(true===c){e.getStore().setBaseParam("auth_type","directory");e.getStore().setBaseParam("include_everyone",false);e.getStore().setBaseParam("include_owner",false);e.getStore().setBaseParam("include_internal",false)}},fillInherietForm:function(){var c=this.get("info_panel").get("inheriet_from");if("inspector"===this.mode){c.hide();return}c.show();var b=this.file_id;if("add"===this.mode||0===this.aceRC.get("level")){b="<"+_WFT("acl_editor","not_inherited")+">"}else{for(var a=0;a<this.aceRC.get("level");++a){b=b.substr(0,b.lastIndexOf("/"))}}c.setValue(b)},fillType:function(){var b=this.get("info_panel").get("cmb_type");if("inspector"===this.mode){b.hide();return}b.show();b.setReadOnly(false);if("edit"===this.mode||"view"===this.mode){var a=this.aceRC.get("type");b.setValue(a);if("view"===this.mode){b.setReadOnly(true)}}else{b.setValue("allow")}},fillPermission:function(){var a=this.get("perm_tree");var c=this.get("info_panel").get("cmb_apply");a.setAllNodeCheckable(true);var b;if("edit"===this.mode||"view"===this.mode){b=this.aceRC.get("permission")}else{if("add"===this.mode){if(this.isdir){b="-------------fd--"}else{b="----------------n"}}else{b="-----------------"}}this.fillApplyCmb(b.substr(13,4));this.fillPermissionTree(b);if("view"===this.mode||"inspector"===this.mode){a.setAllNodeCheckable(false);c.itemReadOnly=true}else{c.itemReadOnly=false}},fillApplyCmb:function(a){var b=this.get("info_panel").get("cmb_apply");if(this.isdir){b.show()}else{b.hide()}b.setPermValue(a)},fillPermissionTree:function(f){var b=this.get("perm_tree");var d=b.allNodeCheckable;b.setAllNodeCheckable(true);var c=true;function e(g,h){if(g){h.ui.onCheckChange((c)?2:1)}}for(var a=0;a<this.permTreeTbl.length;++a){c=(f.charAt(a)===this.permTreeTbl[a][1]);if(this.permTreeTbl[a][2]===false){c=!c}b.selectPath(this.permTreeTbl[a][0],"",e)}b.setAllNodeCheckable(d)},doInspect:function(b){var a=b.getValue();if(b.valueNotFound()||!a||""===a){return}this.body.mask(_WFT("common","loading"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.ACL",method:"inspect",version:1,scope:this,params:{file_path:this.file_path,owner_type:a.substr(0,a.indexOf(":")),owner_name:a.substr(a.indexOf(":")+1)},callback:function(g,f,e){if(this.isDestroyed){return}if(g&&f.permission){var c=SYNO.FileStation.PropertyDialog.ACLUtils;this.fillPermissionTree(c.PermissionObjToStr(f.permission));this.body.unmask()}else{var d=_WFT("common","error_system");if(Ext.isDefined(f.code)){d=SYNO.API.getErrorString(f.code)}this.body.mask(d)}}})},okHandler:function(){if("view"===this.mode||"inspector"===this.mode){this.hide();return}var a=this.getACE();if(null===a){return}this.setStatusBusy({text:_WFT("common","saving")});this.sendWebAPI({api:"SYNO.Core.ACL",method:"check_admin",version:1,scope:this,params:{owner_name:a.user_name,owner_type:a.user_type},callback:function(f,e,d){var b=String.format(_WFT("acl_editor","admin_cannot_set_acl_perm"),d.owner_name?d.owner_name:"");var c=_WFT("common","error_system");this.clearStatusBusy();if(!f){if(Ext.isDefined(e.code)){c=SYNO.API.getErrorString(e.code)}this.setStatusError({text:c,clear:true});return}if(false===e.is_admin){this.doAddACEToList(a);this.hide()}else{this.getMsgBox().alert(_WFT("common","reminder"),b)}}})},doAddACEToList:function(a){if("edit"===this.mode){if(this.isTheSameACE(this.aceRC,a)===false){this.fireEvent("deleteACE",this.aceRC);this.fireEvent("addACE",a)}}else{this.fireEvent("addACE",a)}},getACE:function(){var d=this.get("info_panel").get("cmb_owner");var a=d.getValue();var c=this.get("info_panel").get("cmb_type");var b={user_type:a.substr(0,a.indexOf(":")),user_name:a.substr(a.indexOf(":")+1),level:0,type:c.getValue(),permission:this.getPermission()};if(this.verifyACE(b,d)){return b}else{return null}},getPermission:function(){var b=this.get("perm_tree");var a="";var f="";var d="";function c(h,i){if(h&&i.attributes.checked){a=a+f}else{a=a+d}}for(var e=0;e<this.permTreeTbl.length;++e){if(this.permTreeTbl[e][2]){f=this.permTreeTbl[e][1];d="-"}else{f="-";d=this.permTreeTbl[e][1]}b.selectPath(this.permTreeTbl[e][0],"",c)}var g=this.get("info_panel").get("cmb_apply");a+=g.getPermValue();return a},verifyACE:function(a,b){if(b.valueNotFound()||null===a.user_name||""===a.user_name||null===a.user_type||""===a.user_type){this.setStatusError({text:_WFT("acl_editor","error_invalid_user_or_group"),clear:true});return false}if("-------------"===a.permission.substr(0,13)){this.setStatusError({text:_WFT("acl_editor","error_empty_permission"),clear:true});return false}if(this.isdir&&a.permission.match("--in")){this.get("info_panel").get("cmb_apply").focus();this.get("info_panel").get("cmb_apply").expand();this.setStatusError({text:_WFT("acl_editor","error_empty_apply_to"),clear:true});return false}return true},isTheSameACE:function(a,b){if(a.get("level")===b.level&&a.get("permission")===b.permission&&a.get("type")===b.type&&a.get("user_name")===b.user_name&&a.get("user_type")===b.user_type){return true}return false}});Ext.define("SYNO.FileStation.PropertyDialog.ACLPrivilege.TreeNodeUI",{extend:Ext.tree.TriTreeNodeUI,checkable:true,checkCheckbox:function(a){this.checkbox.checked=this.values[a];this.checkbox.className=this.checkedCls[a];this.node.attributes.checked=this.checkbox.checked},onCheckChange:function(a){if(false===this.checkable){return}this.checkCheckbox(a);if(this.node.firstChild){this.updateChild(this.node.firstChild,a)}if(this.node.parentNode.isRoot!==true){this.updateParent(this.node.parentNode,a)}var b=this.checkbox.checked;this.fireEvent("checkchange",this.node,b)},updateParent:function(d,a){var c=this.getCheckIndex(d);if(a!=c){var b=this.checkchildstate(d);d.getUI().checkCheckbox(b);if(true!==d.parentNode.isRoot){this.updateParent(d.parentNode,b)}}},updateChild:function(b,a){var c=b;do{if(c.getUI().rendered!==true){c.getUI().render()}c.getUI().checkCheckbox(a);if(c.firstChild){this.updateChild(c.firstChild,a)}c=c.nextSibling}while(c)},checkchildstate:function(c){var a=c.firstChild;if(!a){return this.err}var b=this.getCheckIndex(a);while(a){if(this.getCheckIndex(a)!==b){return Ext.tree.TriTreeNodeUI.GRAYSTATE}a=a.nextSibling}return b},onDblClick:function(a){},onSelectedChange:function(a){},onOver:function(a){},setCheckable:function(a){this.checkable=a;this.node.eachChild(function(b){b.getUI().setCheckable(a)})}});Ext.define("SYNO.FileStation.PropertyDialog.ACLPrivilege.IconCombo",{extend:SYNO.ux.ComboBox,defaultValue:null,initComponent:function(){Ext.apply(this,{tpl:'<tpl for="."><div class="x-combo-list-item acl-icon-combo-item '+this.iconClsPrefix+"{"+this.iconClsField+'}" role="option" aria-label="{'+this.displayField+'}" id="{[Ext.id()]}">{'+this.displayField+"}</div></tpl>"});SYNO.FileStation.PropertyDialog.ACLPrivilege.IconCombo.superclass.initComponent.call(this)},onRender:function(b,a){SYNO.FileStation.PropertyDialog.ACLPrivilege.IconCombo.superclass.onRender.call(this,b,a);this.el.addClass("acl-icon-combo-input")},clearIconCls:function(){if(null!==this.iconCls){this.removeClass("acl-icon-combo-icon");this.removeClass(this.iconCls);this.iconCls=null}},setIconCls:function(a){this.clearIconCls();this.addClass("acl-icon-combo-icon");this.iconCls=this.iconClsPrefix+a;this.addClass(this.iconCls)},setValue:function(a){SYNO.FileStation.PropertyDialog.ACLPrivilege.IconCombo.superclass.setValue.call(this,a);var b=this.store.query(this.valueField,this.getValue()).itemAt(0);if(b){this.setIconCls(b.get(this.iconClsField));this.fireEvent("valueset",this)}else{this.clearIconCls()}},setDefaultValue:function(a,b,d){var c=this.valueField;this.valueField=null;SYNO.FileStation.PropertyDialog.ACLPrivilege.IconCombo.superclass.setValue.call(this,a);this.setIconCls(b);this.defaultValue=a;this.value=d;this.valueField=c},assertValue:function(){if(this.getRawValue()!==this.defaultValue){SYNO.FileStation.PropertyDialog.ACLPrivilege.IconCombo.superclass.assertValue.call(this)}},valueNotFound:function(){if(this.lastSelectionText===this.valueNotFoundText){return true}return false}});Ext.define("SYNO.FileStation.PropertyDialog.ACLPrivilege.UserGrpCombo",{extend:SYNO.FileStation.PropertyDialog.ACLPrivilege.IconCombo,labelStyle:"margin-left: 0px; width: 180px;",displayField:"name",iconClsField:"type",iconClsPrefix:"acl-combo-item-",valueField:"value",triggerAction:"all",mode:"remote",pageSize:50,editable:true,listEmptyText:_WFT("acl_editor","error_invalid_user_or_group"),valueNotFoundText:_WFT("acl_editor","error_invalid_user_or_group"),grow:true,maxHeight:360,minChars:1,typeAhead:true});SYNO.FileStation.localSetThreadId=function(b){var a=Ext.getCmp(b.dialogId);if(b.action=="md5"){a.md5ThreadId=b.threadId}else{if(b.action=="size"){a.sizeThreadId=b.threadId}}};SYNO.FileStation.localUpdateEntry=function(e){var d=Ext.getCmp(e.dialogId);var c="N/A";var a;var f;var b;if(e.md5){d.get("md5").get("md5_value").setValue(e.md5);d.md5ThreadId=null}else{if(Ext.isEmpty(e.size)){if(e.size=="N/A"){d.get("size").setValue("N/A")}else{a=parseInt(e.size,10);f=Ext.util.Format.fileSize(a);b=String.format(_WFT("property","file_statistics"),e.files,e.folders);c=f+". "+b;d.get("size").setValue(c)}d.sizeThreadId=null}}};