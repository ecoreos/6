/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.AHA.AdvancedSearchField",{extend:"SYNO.ux.SearchField",initEvents:function(){this.callParent(arguments);this.mon(Ext.getDoc(),"mousedown",this.onMouseDown,this);this.mon(this,"keypress",function(b,a){if(a.getKey()===Ext.EventObject.ENTER){this.searchPanel.setKeyWord(this.getValue());this.searchPanel.onSearch()}},this)},isInnerComponent:function(c,b){var a=false;b.items.each(function(d){if(d instanceof Ext.form.ComboBox){if(d.view&&c.within(d.view.getEl())){a=true;return false}}else{if(d instanceof Ext.form.DateField){if(d.menu&&c.within(d.menu.getEl())){a=true;return false}}else{if(d instanceof Ext.form.CompositeField){if(this.isInnerComponent(c,d)){a=true;return false}}}}},this);return a},onMouseDown:function(b){var a=this.searchPanel;if(a&&a.isVisible()&&!a.isDestroyed&&!a.inEl&&!b.within(a.getEl())&&!b.within(this.searchtrigger)&&!this.isInnerComponent(b,this.searchPanel.getForm())){a.hide()}},onSearchTriggerClick:function(){if(this.searchPanel.isVisible()){this.searchPanel.hide();return}this.searchPanel.getEl().alignTo(this.wrap,"tr-br?",[6,0]);this.searchPanel.show();this.searchPanel.setKeyWord(this.getValue())},onTriggerClick:function(){this.callParent();this.searchPanel.onReset();this.searchPanel.onSearch()}});Ext.define("SYNO.SDS.AHA.SearchFormPanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.dateType={custom:1,today:2,yesterday:4,lastweek:8,lastmonth:16};this.dataRange=[[this.dateType.custom,_T("log","date_custom")],[this.dateType.today,_T("log","date_today")],[this.dateType.yesterday,_T("log","date_yesterday")],[this.dateType.lastweek,_T("log","date_lastweek")],[this.dateType.lastmonth,_T("log","date_lastmonth")]];this.logLevelType={info:"1",warn:"2",error:"3"};this.logLevel=[[this.logLevelType.info,_T("log","info_level")],[this.logLevelType.warn,_T("log","warn_level")],[this.logLevelType.error,_T("log","error_level")]];this.defaultAnimation=["#000",1,{duration:0.35}];Ext.apply(this,a||{});var b=this.fillConfig(a);this.callParent([b]);this.mon(this,"afterlayout",function(){this.defineBehaviors()},this)},initComponent:function(){this.callParent(arguments);this.addEvents("search")},fillConfig:function(b){var a,f,g,e;var c=[];a=this.createKeyword();f=this.createFriendlyDate();g=this.createCustDate();e=this.createLevel();c.push(a);c.push(f);c.push(g);c.push(e);c.push({xtype:"toolbar",border:false,itemId:"btns",id:"btns",toolbarCls:"search-panel-fbar-btnPanel",items:[{xtype:"lctbtext",itemId:"search-loading",text:""},{xtype:"lctbtext",itemId:"msg",height:26,style:"-webkit-text-size-adjust:none;font-size:11px;height:26px;overflow:hidden;",cls:"red-status",text:""},{xtype:"tbfill"},{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_T("log","search"),itemId:"btn_search",handler:this.onSearch,scope:this},{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_T("smart","smart_test_button_stop"),itemId:"btn_stop",hidden:true,handler:this.onStop,scope:this},{xtype:"syno_button",minWidth:80,text:_T("common","reset"),handler:this.onReset,scope:this}]});var d={width:368,heigh:480,floating:true,labelAlign:"left",trackResetOnLoad:true,waitMsgTarget:true,border:true,bodyStyle:"padding: 20px; padding-top: 0px; font-size: 24px;",autoFlexcroll:false,defaults:{hideLabel:true,anchor:"100%"},items:c,listeners:{actionfailed:{fn:function(){this.setMsg("");this.form.reset()},scope:this},beforeshow:{fn:function(){this.doLayout()},single:true},show:{fn:this.doLayout,single:true}},keys:[{key:[10,13],fn:function(){if(!this.isVisible()){return}if(!this.btnSearch.hidden&&!this.btnSearch.disabled){this.onSearch()}else{if(!this.btnStop.hidden&&!this.btnStop.disabled){this.onStop()}}},scope:this}]};return d},setComboBoxValue:function(b,a){this.frameAnimation(b.el,this.defaultAnimation);if(b.setMultiValue){b.setMultiValue(a.split(","))}},getComboBoxValue:function(b){var a=this.getForm().findField(b);return a.getMultiValue?a.getMultiValue().toString():a.getValue()},multiSelect:function(c,e,a,d,b){Ext.applyIf(c,{setMultiValue:function(f){if(!Ext.isArray(f)){f=[f]}this.multiValue=f},getMultiValue:function(){return this.multiValue&&this.multiValue.length>0?this.multiValue:this.getValue().split(",")}});if("more"===e.get("value")){this.attriWin=new SYNO.SDS.LogCenter.MultiSelectedDialog({title:d,combo:c,emptyValue:b,anim:this.defaultAnimation,owner:this.owner.appInst});this.attriWin.showUp();c.collapse();return false}},createTpl:function(){return new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" ext:qtip="{displayText:htmlEncode}">',"{displayText:htmlEncode}","</div>","</tpl>")},logSelect:function(c,a,b){this.setComboBoxValue(c,c.getValue())},createKeyword:function(){return[{xtype:"syno_displayfield",value:_T("log","attr_keyword")+_T("common","colon"),flex:1},{xtype:"syno_textfield",msgTarget:"qtip",validateOnBlur:true,validationEvent:"blur",name:"keyword",flex:2,vaule:""}]},setDate:function(c,b,a){if(a===true){this.frameAnimation(this.form.findField("searchdatefrom").el,this.defaultAnimation);this.frameAnimation(this.form.findField("searchdateto").el,this.defaultAnimation)}this.form.findField("searchdatefrom").setMaxValue(b);this.form.findField("searchdateto").setMinValue(c);this.form.findField("searchdatefrom").setValue(c);this.form.findField("searchdateto").setValue(b)},getFromToDate:function(c){var e,d,b=new Date();if(c===this.dateType.today){e=b;d=b}else{if(c===this.dateType.yesterday){e=b.add(Date.DAY,-1);d=e}else{if(c===this.dateType.lastweek){var a=b.getDay();e=b.add(Date.DAY,-7-a);d=e.add(Date.DAY,6)}else{if(c===this.dateType.lastmonth){b=b.add(Date.MONTH,-1);e=b.getFirstDateOfMonth();d=b.getLastDateOfMonth()}}}}return{from:e,to:d}},friendlyDateSelect:function(c,e,a){var b=e.get("id"),d=this.getFromToDate(b);this.setDate(d.from,d.to,true)},getFriendlyDateStore:function(){var a=this.dataRange;return new Ext.data.ArrayStore({autoDestroy:true,fields:["id","displayText"],data:a})},createFriendlyDate:function(){this.FriendlyDate=new SYNO.ux.ComboBox({mode:"local",editable:false,name:"dateRange",tpl:this.createTpl(),resizable:true,store:this.getFriendlyDateStore(),displayField:"displayText",valueField:"id",triggerAction:"all",lazyRender:true,flex:6,value:this.dateType.custom,listeners:{scope:this,beforequery:function(a){delete a.combo.lastQuery},beforeselect:this.friendlyDateSelect}});return[{xtype:"syno_displayfield",value:_T("log","date_range")+_T("common","colon"),flex:1},this.FriendlyDate]},createCustDate:function(){this.DateFrom=new SYNO.ux.DateField({name:"searchdatefrom",editable:false,format:"m/d/Y",emptyText:_T("log","date_from"),value:"",listeners:{scope:this,select:function(b,a){this.form.findField("searchdateto").setMinValue(a)}}});this.DateTo=new SYNO.ux.DateField({name:"searchdateto",editable:false,format:"m/d/Y",emptyText:_T("log","date_to"),value:"",listeners:{scope:this,select:function(b,a){this.form.findField("searchdatefrom").setMaxValue(a)}}});return[{xtype:"syno_displayfield",value:_T("time","time_date")+_T("common","colon")},{xtype:"syno_compositefield",hideLabel:true,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[this.DateFrom,this.DateTo]}]},getLogLevelStore:function(){var a=this.logLevel.slice(0,this.logLevel.length);if(a.length>1){a.splice(0,0,["",_T("log","log_all")])}return new Ext.data.ArrayStore({autoDestroy:true,fields:["value","displayText"],data:a})},multiLogLevelSelect:function(b,c,a){this.multiSelect(b,c,a,_T("log","logattr"),"")},createLevel:function(){this.LogLevel=new SYNO.ux.ComboBox({xtype:"syno_combobox",mode:"local",editable:false,name:"logLevel",tpl:this.createTpl(),resizable:true,store:this.getLogLevelStore(),displayField:"displayText",valueField:"value",triggerAction:"all",lazyRender:true,flex:3,value:"",listeners:{scope:this,beforequery:function(a){delete a.combo.lastQuery},beforeselect:this.multiLogLevelSelect,select:this.logSelect}});return[{xtype:"syno_displayfield",name:"logLevelLabel",value:_T("log","logattr")+_T("common","colon"),flex:1},this.LogLevel]},hideItems:function(b){var c;if(!Ext.isArray(b)){b=[b]}for(var a=b.length-1;a>=0;a--){c=this.form.findField(b[a]);if(c){c.setVisible(false)}}},frameAnimation:function(a,b){if(a&&a.isVisible()){Ext.Element.prototype.frame.apply(a,b)}},defineBehaviors:function(){var a=this.get("btns");this.btnSearch=a.get("btn_search");this.btnStop=a.get("btn_stop")},setMsg:function(c){var a=this.get("btns");var b=a.get("msg");b.setText(c);if(c.trim()!==""){this.frameAnimation(b.el,this.defaultAnimation)}},setKeyWord:function(a){var b=this.form.findField("keyword");if(b&&Ext.isString(a)){b.setValue(a)}b.focus("",1)},onShowHideBtn:function(a){if(a){this.btnSearch.hide();this.btnStop.show()}else{this.btnSearch.show();this.btnStop.hide()}},onEnableDisableBtn:function(a){if(a){this.btnSearch.enable();this.btnStop.enable()}else{this.btnSearch.disable();this.btnStop.disable()}},isOwnerDestroyed:function(){return(this.owner&&this.owner.isDestroyed)},showMsg:function(b,a){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().alert(b,a)}},hideMsg:function(){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().hide()}},isFieldDirty:function(a){return this.form.findField(a).isDirty()},validateForm:function(){if(!this.form.isValid()){return false}return this.isFieldDirty("searchdatefrom")||this.isFieldDirty("searchdateto")||this.isFieldDirty("keyword")},onSearch:function(c,f){var d,b,i,h,a;var g;d=this.getForm();b=d.findField("keyword").getValue();i=d.findField("searchdatefrom").getRawValue();h=d.findField("searchdateto").getRawValue();a=this.getComboBoxValue("logLevel");g={keyword:b,loglevel:a,datefrom:i?new Date(i+" 00:00:00").getTime()/1000:0,dateto:h?new Date(h+" 23:59:59").getTime()/1000:0};this.fireEvent("search",this,g)},onReset:function(){this.form.items.each(function(a){if(a.isDirty()){this.frameAnimation(a.el,this.defaultAnimation)}},this);this.setMsg("");this.form.reset();this.form.findField("searchdatefrom").setMaxValue(null);this.form.findField("searchdateto").setMinValue(null);this.form.findField("logLevel").multiValue=""}});Ext.define("SYNO.SDS.AHA.Comp.TextItem",{extend:"Ext.Toolbar.TextItem",onRender:function(b,a){this.autoEl={cls:"xtb-text",html:this.text||"","ext:qtip":this.text||""};SYNO.SDS.AHA.Comp.TextItem.superclass.onRender.call(this,b,a)},setText:function(a){SYNO.SDS.AHA.Comp.TextItem.superclass.setText.call(this,a);if(this.rendered){this.el.set({"ext:qtip":a})}}});Ext.reg("lctbtext",SYNO.SDS.AHA.Comp.TextItem);Ext.define("SYNO.SDS.AHA.Instance",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.AHA.AHAMainWindow"});Ext.define("SYNO.SDS.AHA.AHAMainWindow",{extend:"SYNO.SDS.PageListAppWindow",activePage:"SYNO.SDS.AHA.AHAPanelOverview",skipDirtyCheck:false,funcToHelp:{general:"AHAManager/overview.html","SYNO.SDS.AHA.AHAPanelOverview":"AHAManager/overview.html","SYNO.SDS.AHA.AHAPanelConfig":"AHAManager/network.html","SYNO.SDS.AHA.AHAPanelService":"AHAManager/monitor.html","SYNO.SDS.AHA.AHAPanelLogView":"AHAManager/overview.html"},constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){var b={width:SYNO.SDS.AHA.CONF_DEFAULT_WIDTH,height:SYNO.SDS.AHA.CONF_DEFAULT_HEIGHT,minWidth:SYNO.SDS.AHA.CONF_DEFAULT_WIDTH,minHeight:SYNO.SDS.AHA.CONF_DEFAULT_HEIGHT,listItems:[{text:_TT("SYNO.SDS.AHA.Instance","overview","overview"),iconCls:"syno-aha-list-overview",fn:"SYNO.SDS.AHA.AHAPanelOverview"},{text:_TT("SYNO.SDS.AHA.Instance","monitor","monitor"),iconCls:"syno-aha-list-monitoring",fn:"SYNO.SDS.AHA.AHAPanelService"},{text:_TT("SYNO.SDS.AHA.Instance","network","network"),iconCls:"syno-aha-list-networkConfig",fn:"SYNO.SDS.AHA.AHAPanelConfig"},{text:_T("tree","leaf_log"),iconCls:"syno-aha-list-log",fn:"SYNO.SDS.AHA.AHAPanelLogView"}]};Ext.apply(b,a);return b},onBeforeSelect:function(b,c,d){if(!this.skipDirtyCheck){if(d&&d.leaf){var a=this.pageCt.getComponent(d.attributes.fn);if(a&&Ext.isFunction(a.isDirty)&&a.isDirty()){this.getMsgBox().confirm(_TT("SYNO.SDS.AHA.Instance","app","app_name"),_T("common","confirm_lostchange"),function(e){if("yes"===e){this.skipDirtyCheck=true;this.selectPage(c.attributes.fn);this.skipDirtyCheck=false}},this);return false}}}return this.callParent(arguments)},getHelpParam:function(){var a=this.activePage.itemId;var b=this.funcToHelp[a]||this.funcToHelp.general;return b}});Ext.define("SYNO.SDS.AHA.AHAPanelLogView",{extend:"SYNO.ux.GridPanel",itemsPerPage:40,constructor:function(a){var c=this,b;Ext.apply(c,a);b=c.fillConfig(a);c.itemsPerPage=c.appWin.appInstance.getUserSettings(c.itemId+"-dsPageLimit")||c.itemsPerPage;c.callParent([b]);c.mon(c,"resize",function(d,f,e){c.updateFbarItems(f)},c)},onPageActivate:function(){this.onActive()},getPageRecordStore:function(){var a=new Ext.data.SimpleStore({fields:["value","display"],data:[[20,20],[40,40],[100,100],[300,300]]});return a},onChangeDisplayRecord:function(d,e,b){var c=this,a=c.logStore;if(c.itemsPerPage!==d.getValue()){c.itemsPerPage=d.getValue();c.paging.pageSize=c.itemsPerPage;a.load({params:{start:0,limit:c.itemsPerPage}});c.appWin.appInstance.setUserSettings(c.itemId+"-dsPageLimit",c.itemsPerPage)}},initPageComboBox:function(a){var b=new SYNO.ux.ComboBox({name:"page_rec",hiddenName:"page_rec",hiddenId:Ext.id(),store:a,displayField:"display",valueField:"value",triggerAction:"all",value:this.itemsPerPage,editable:false,width:72,mode:"local",listeners:{select:{fn:this.onChangeDisplayRecord,scope:this}}});return b},initPagingToolbar:function(){var a=new SYNO.ux.PagingToolbar({store:this.logStore,displayInfo:true,pageSize:this.itemsPerPage,showRefreshBtn:true,items:["-",_T("common","items_perpage"),this.initPageComboBox(this.getPageRecordStore()),"-",{xtype:"tbtext",text:"",itemId:"infoLevel"},"-",{xtype:"tbtext",text:"",itemId:"warnLevel"},"-",{xtype:"tbtext",text:"",itemId:"errorLevel"},"-"]});return a},initSearchForm:function(){var a=new SYNO.SDS.AHA.SearchFormPanel({cls:"syno-sds-fs-search-panel",renderTo:Ext.getBody(),shadow:false,hidden:true,owner:this});return a},initToolbar:function(){var b=this,a=new SYNO.ux.Toolbar();b.exportButton=new SYNO.ux.SplitButton({xtype:"syno_splitbutton",text:_TT("SYNO.SDS.LogCenter.Instance","logview","btn_export"),handler:b.onExportHtml,scope:b,menu:{items:[{text:_T("log","html_type"),handler:b.onExportHtml,scope:b},{text:_T("log","csv_type"),handler:b.onExportCSV,scope:b}]}});b.searchField=new SYNO.SDS.AHA.AdvancedSearchField({iconStyle:"filter",owner:b});b.searchField.searchPanel=b.searchPanel;a.add(b.exportButton);a.add("->");a.add(b.searchField);return a},initEvents:function(){this.mon(this.searchPanel,"search",this.onSearch,this);this.mon(this,"activate",this.onActive,this);this.mon(this.logStore,"load",this.onAfterStoreLoad,this);this.mon(this.logStore,"beforeload",this.onBeforeStoreLoad,this)},getStore:function(){var a=new SYNO.API.Store({api:"SYNO.Core.AHA.Log",version:1,method:"list",baseParams:{offset:0,limit:-1},appWindow:this.appWin,autoLoad:true,sortInfo:{field:"time",direction:"DESC"},remoteSort:false,reader:new Ext.data.JsonReader({idProperty:"id",root:"log_list",totalProperty:"total",fields:[{name:"level",mapping:"level"},{name:"log_type",mapping:"log_type"},{name:"time",mapping:"time"},{name:"user",mapping:"user"},{name:"event",mapping:"event"}]})});return a},logLevelRenderer:function(a){switch(a){case"emerg":case"alert":case"crit":case"err":return"<span class='red-status'>Error</span>";case"warn":case"warning":case"notice":return"<span class='orange-status'>Warning</span>";case"info":case"debug":return"<span class='green-status'>Information</span>";default:return"Undefined"}},htmlEncodeRender:function(c,b){var a=Ext.util.Format.htmlEncode(c);b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(a)+'"';return a},getColumnModel:function(){var a=new Ext.grid.ColumnModel({columns:[{header:_TT("SYNO.SDS.LogCenter.Instance","logattr","attr_priority"),dataIndex:"level",width:100,align:"center",renderer:this.logLevelRenderer},{header:_T("log","log_time"),dataIndex:"time",width:150,align:"center",renderer:this.htmlEncodeRender},{header:_T("log","log_account"),dataIndex:"user",width:100,align:"center",renderer:this.htmlEncodeRender},{id:"descr",header:_T("log","log_action"),dataIndex:"event",css:"white-space:normal;",width:300,renderer:this.htmlEncodeRender}],defaults:{sortable:false,menuDisabled:false}});return a},fillConfig:function(a){var c=this;c.searchPanel=c.initSearchForm();c.logStore=c.getStore();c.paging=c.initPagingToolbar();var b={border:false,trackResetOnLoad:true,layout:"fit",itemId:"aha_log",tbar:c.initToolbar(),enableColumnMove:false,enableHdMenu:false,bbar:c.paging,store:c.logStore,colModel:c.getColumnModel(),view:new SYNO.ux.FleXcroll.grid.BufferView({rowHeight:27,scrollDelay:30,borderHeight:1}),loadMask:true,stripeRows:true};Ext.apply(b,a);return b},isTheSame:function(b,a){var c;for(c in a){if(a[c]!==b[c]){return false}}return true},onSearch:function(c,d){var b=this,a=b.logStore;if(!b.isTheSame(a.baseParams,d)){Ext.apply(a.baseParams,d);b.loadData()}},onActive:function(){var a=this.logStore,b={datefrom:0,dateto:0,keyword:"",loglevel:""};Ext.applyIf(a.baseParams,b);this.loadData()},loadData:function(){var a=this.logStore,b={start:0,limit:this.itemsPerPage};a.load({params:b})},onBeforeStoreLoad:function(a,b){this.getEl().unmask()},onAfterStoreLoad:function(a,f,c){var e=this,d,b='<div class="{0}" style="width:40px;" ext:qtip="{1}">{2}</div>';if(f.length<1){e.body.mask(_T("log","no_log_available"))}else{e.body.unmask()}d=a.reader.jsonData;e.setLogLevelText(e.getInfoCompoent(),b,"syno-aha-log-info",_T("log","info_level"),d.info_count);e.setLogLevelText(e.getWarnCompoent(),b,"syno-aha-log-warn",_T("log","warn_level"),d.warn_count);e.setLogLevelText(e.getErrorCompoent(),b,"syno-aha-log-err",_T("log","error_level"),d.error_count);e.setPagingToolbar(a,e.paging)},setLogLevelText:function(b,a,c,e,d){if(b){d=d||"0";b.setText(String.format(a,c,e,d))}},getInfoCompoent:function(){return this.paging.getComponent("infoLevel")},getWarnCompoent:function(){return this.paging.getComponent("warnLevel")},getErrorCompoent:function(){return this.paging.getComponent("errorLevel")},setPagingToolbar:function(a,b){this.setPagingToolbarVisible(b,a.getTotalCount()>this.itemsPerPage)},setPagingToolbarVisible:function(a,b){a.setButtonsVisible(true)},updateFbarItems:function(b){var a=0;if(!this.isVisible()){return}if(b<880){for(a=16;a<23;a++){this.paging.items.get(a).hide()}}else{for(a=16;a<23;a++){this.paging.items.get(a).show()}}},onExportCSV:function(){this.onLogSave("csv")},onExportHtml:function(){this.onLogSave("html")},onLogSave:function(a){if(_S("demo_mode")){this.appWin.getMsgBox().alert(this.appWin.title,_JSLIBSTR("uicommon","error_demo"));return}this.saveLog(a)},saveLog:function(c){var f="&title="+_TT("SYNO.SDS.AHA.Instance","uicommon","name"),b="&filename="+_TT("SYNO.SDS.AHA.Instance","uicommon","name");var a=this.logStore,e=a.baseParams,d="/webapi/entry.cgi?api=SYNO.Core.AHA.Log&method=export&version=1";if(e.keyword){d+="&keyword="+a.baseParams.keyword}if(e.datefrom){d+="&datefrom="+a.baseParams.datefrom}if(e.dateto){d+="&dateto="+a.baseParams.dateTo}if(e.loglevel){d+="&loglevel="+a.baseParams.loglevel}if(c){d+="&exporttype="+c}d+=f+b;d=Ext.urlAppend(d);if(!this.downloadiframe){this.downloadiframe=Ext.DomHelper.append(document.body,{tag:"iframe",id:Ext.id(),frameBorder:0,width:0,height:0,css:"display:none;visibility:hidden;height:1px;",src:d})}else{this.downloadiframe.src=d}},destroy:function(){if(this.rowNav){Ext.destroy(this.rowNav);this.rowNav=null}this.callParent([this])}});Ext.define("SYNO.SDS.AHA.AHAPanelService",{extend:"SYNO.ux.FormPanel",tabpanel:null,servicePanel:null,systemPanel:null,networkPanel:null,activePanel:null,PollID:[],PollConfig:[],constructor:function(a){this.servicePanel=new SYNO.SDS.AHA.AHAServiceListPanel({appWin:a.appWin,owner:this,title:_T("connections","service"),node:"service_node"});this.systemPanel=new SYNO.SDS.AHA.AHAServiceListPanel({appWin:a.appWin,owner:this,title:_TT("SYNO.SDS.AHA.Instance","monitor","system"),node:"system_node"});this.networkPanel=new SYNO.SDS.AHA.AHAServiceListPanel({appWin:a.appWin,owner:this,title:_T("network","interface"),node:"network_node"});this.appWin=a.appWin;this.tabpanel=new SYNO.SDS.AHA.TabPanel({appWin:a.appWin,owner:this,tabPanels:[this.systemPanel,this.servicePanel,this.networkPanel]});var b={border:false,cls:"syno-aha-service-detail",itemId:"is_monitored",layout:"fit",style:"padding: 0;",items:[this.tabpanel],fbar:{xtype:"statusbar",hideMode:"visibility",defaultText:"&nbsp;",statusAlign:"left",buttonAlign:"left",items:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","commit"),itemId:"apply",scope:this,handler:this.doCommitSetting},{xtype:"syno_button",text:_T("common","alt_cancel"),itemId:"reset",scope:this,handler:this.onCancel}]}};this.PollConfig.MonitorList={interval:10,immediate:true,webapi:{api:"SYNO.Core.AHA.Monitor",version:1,method:"list",params:{types:["service","network","system"],reload:false}},status_callback:this.handleListMonitorDone,scope:this};this.callParent([b]);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.stopWebapis,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.stopWebapis,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.stopWebapis,this)},getDirtyPage:function(){if(this.servicePanel.isDirty()){return"service"}if(this.systemPanel.isDirty()){return"system"}if(this.networkPanel.isDirty()){return"network"}return null},isDirty:function(){if(this.systemPanel.isDirty()){this.tabpanel.setActiveTab(0);return true}if(this.servicePanel.isDirty()){this.tabpanel.setActiveTab(1);return true}if(this.networkPanel.isDirty()){this.tabpanel.setActiveTab(2);return true}return false},onPageActivate:function(){this.updateServiceWithMask(true);this.startWebapis()},onPageDeactivate:function(){this.stopWebapis()},stopWebapis:function(){this.appWin.pollUnreg(this.PollID.MonitorList)},startWebapis:function(){this.PollID.MonitorList=this.appWin.pollReg(this.PollConfig.MonitorList)},doCommitSetting:function(){var f=this.tabpanel.getActiveTab();var d=null;var c=null;var e=null;var a=[];if("service_node"===f.node){c="service";d=this.servicePanel}else{if("system_node"===f.node){c="system";d=this.systemPanel}else{if("network_node"===f.node){c="network";d=this.networkPanel}}}if(!d.isDirty()){this.setStatusError({text:_T("error","nochange_subject"),clear:true});return}this.setStatusBusy();for(var b=0;b<d.serviceStore.getCount();b++){e=d.serviceStore.getAt(b);a[b]={};a[b].name=e.get("name");a[b].is_monitored=e.get("is_monitored")}this.appWin.sendWebAPI({api:"SYNO.Core.AHA.Monitor",version:1,method:"set",params:{type:c,total:a.length,monitor_infos:a,reload:true},callback:this.handleSetMonitorDone,scope:this})},onCancel:function(){if(this.isDirty()){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("common","confirm_refresh"),function(a){if("yes"===a){this.updateServiceWithMask(true,this.getDirtyPage())}},this)}},handleSetMonitorDone:function(d,b,c,a){this.appWin.clearStatusBusy();if(d){this.updateServiceWithMask(true,c.type);this.setStatusOK()}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"));this.setStatusError()}},handleListMonitorDone:function(f,d,e,b){this.appWin.clearStatusBusy();if(f){for(var a=0;a<d.total;a++){var c={};c.items=d.items[a].monitor_infos;if("service"===d.items[a].type){this.servicePanel.updateServiceWithMaskDone(d.items[a].total,e.reload,c)}else{if("system"===d.items[a].type){this.systemPanel.updateServiceWithMaskDone(d.items[a].total,e.reload,c)}else{if("network"===d.items[a].type){this.networkPanel.updateServiceWithMaskDone(d.items[a].total,e.reload,c)}}}}}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"))}},updateServiceWithMask:function(b,a){if(undefined===a){this.appWin.sendWebAPI({api:"SYNO.Core.AHA.Monitor",version:1,method:"list",params:{types:["service","network","system"],reload:b},callback:this.handleListMonitorDone,scope:this})}else{this.appWin.sendWebAPI({api:"SYNO.Core.AHA.Monitor",version:1,method:"list",params:{types:[a],reload:b},callback:this.handleListMonitorDone,scope:this})}},setStatusError:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","error_system"),iconCls:"syno-ux-statusbar-error",clear:true});this.getFooterToolbar().setStatus(b)},setStatusOK:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","setting_applied"),iconCls:"syno-ux-statusbar-success",clear:true});this.getFooterToolbar().setStatus(b)},setStatusBusy:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","loading"),iconCls:"syno-ux-statusbar-loading"});this.getFooterToolbar().setStatus(b)}});Ext.define("SYNO.SDS.AHA.AHAServiceListPanel",{extend:"SYNO.ux.EditorGridPanel",serviceStore:null,toolbar:null,columnModel:null,enableColumn:null,nodeType:null,nodeOwner:null,constructor:function(b){var a=this;this.nodeType=b.node;this.nodeOwner=b.owner;this.enableColumn=new SYNO.ux.EnableColumn({header:_TT("SYNO.SDS.AHA.Instance","monitor","monitoring"),dataIndex:"is_monitored",id:"is_monitored",menuDisabled:true,sortable:false,width:0.15,align:"center",owner:a,disableSelectAll:("system_node"==b.node),enableFastSelectAll:false,isIgnore:function(e,d){if("system_node"==b.node){if("cell"===e){this.owner.nodeOwner.setStatusError({text:_TT("SYNO.SDS.AHA.Instance","monitor","fixed_setting_cannot_be_changed"),clear:true})}return true}else{if(("all"===e||"cell"===e)&&"error"===d.data.status&&false===d.data.is_monitored){if("network_node"===this.owner.nodeType){this.owner.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_TT("SYNO.SDS.AHA.Instance","monitor","fix_interface_error_before_enabled"))}else{this.owner.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_TT("SYNO.SDS.AHA.Instance","monitor","fix_service_error_before_enabled"))}return true}return false}}});if("service_node"==b.node){this.initForm(_T("connections","service"),false)}else{if("network_node"==b.node){this.initForm(_T("network","interface"),true)}else{if("system_node"==b.node){this.initForm(_TT("SYNO.SDS.AHA.Instance","monitor","system"),true)}}}var c={border:false,store:this.serviceStore,plugins:[this.enableColumn],colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:false}),loadMask:true,stripeRows:true};Ext.apply(c,b);this.callParent([c]);this.getSelectionModel().on("rowselect",function(e,d,f){},this);this.getSelectionModel().on("rowdeselect",function(e,d){},this)},updateServiceWithMaskDone:function(c,b,d){if(this.serviceStore.getCount()!==c||true===b){this.serviceStore.loadData(d,false);this.serviceStore.commitChanges()}else{for(var a=0;a<d.items.length;a++){var e=this.serviceStore.getById(d.items[a].name);if(e){e.set("status",d.items[a].status);if(e.modified&&"is_monitored" in e.modified){continue}if(e.get("is_monitored")===d.items[a].is_monitored){continue}e.set("is_monitored",d.items[a].is_monitored);e.commit()}else{this.serviceStore.loadData(d,false);this.serviceStore.commitChanges();break}}}},initForm:function(d,c){var b=new Ext.data.Store({proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"items",id:"name"},["name","status","is_monitored"]),remoteSort:false});this.serviceStore=b;var a=new Ext.grid.ColumnModel({columns:[{header:d,dataIndex:"name",width:0.25,align:"left",renderer:"network_node"===this.nodeType?this.rendererInterface:SYNO.SDS.AHA.ServiceRenderer},{header:_TT("SYNO.SDS.AHA.Instance","monitor","status"),dataIndex:"status",width:0.1,align:"left",hidden:c,renderer:this.statusRenderer},this.enableColumn],defaults:{sortable:false,menuDisabled:true}});this.columnModel=a},rendererInterface:function(a){return SYNO.SDS.Utils.Network.idToString.apply(this.nodeOwner,[a])},isDirty:function(){var a=0;var b=this.serviceStore.getCount();for(a=0;a<b;a++){var c=this.serviceStore.getAt(a);if(c&&c.modified){if("is_monitored" in c.modified){return true}}}return false},statusRenderer:function(a){if("running"==a){return _TT("SYNO.SDS.AHA.Instance","monitor","running")}else{if("stopped"==a){return _TT("SYNO.SDS.AHA.Instance","monitor","stopped")}else{return _TT("SYNO.SDS.AHA.Instance","monitor","unknown")}}}});Ext.define("SYNO.SDS.AHA.AHAPanelConfig",{extend:"SYNO.ux.FormPanel",mainPanel:null,networkStatusID:null,LanStatusHBID:null,LanStatusID:[],LanStatusNameID:[],LanStatusLanProtID:[],LanStatusWarning:[],LanStatusSpace:null,PollID:[],PollConfig:[],DataReady:[],DataCount:null,constructor:function(a){this.mainPanel=new SYNO.SDS.AHA.AHAIPListPanel({appWin:a.appWin,owner:this,title:_TT("SYNO.SDS.AHA.Instance","uicommon","name"),mode:"general"});this.appWin=a.appWin;this.mainPanel.setConfigPanel(this);this.DataReady.NetworkInfo=false;this.DataReady.RemoteNodeStatus=false;this.PollConfig.NetworkInfo={interval:10,immediate:true,webapi:{api:"SYNO.Core.AHA.Network",version:1,method:"list",params:{additional:["active_speed","is_active_connected","passive_speed","is_passive_connected","is_bond_mode","bond_id","status","is_monitored"]}},status_callback:this.handleGetNetworkDone,scope:this};this.PollConfig.RemoteNodeStatus={interval:5,immediate:true,webapi:{api:"SYNO.Core.AHA.Node",version:1,method:"get",params:{blocked:false,role:["passive"]}},status_callback:this.handleGetRemoteDone,scope:this};var b={border:false,itemId:"networkConfig",layout:"border",style:"padding: 0;",cls:"syno-aha-config-detail",id:this.LanStatusPort=Ext.id(),items:[{xtype:"panel",layout:"vbox",region:"north",id:this.networkStatusID=Ext.id(),style:"padding: 0; width: 100%; height: 230px",items:[{xtype:"syno_displayfield",value:_TT("SYNO.SDS.AHA.Instance","network","network_status"),style:"font-size: 12px; font-color: #505a64; font-weight: bold; padding-top: 38px; padding-bottom: 10px;",border:false},this.createLanStatusPanel()],cls:"syno-aha-config-lan-status-panel",border:false},this.mainPanel]};this.callParent([b]);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.stopWebapis,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.stopWebapis,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.stopWebapis,this)},createLanStatusPanel:function(){return{xtype:"panel",layout:"hbox",style:"padding: 0; height: 158px;",items:[{xtype:"panel",layout:"vbox",border:false,cls:"syno-aha-config-if-lbackground"},{xtype:"panel",layout:"vbox",border:false,id:this.LanStatusID[0]=Ext.id(),items:[{xtype:"syno_displayfield",value:"Heartbeat",cls:"syno-aha-config-lan-hb-name-normal",id:this.LanStatusNameID[0]=Ext.id()},{xtype:"container",id:this.LanStatusLanProtID[0]=Ext.id(),cls:"syno-aha-config-lan-hb-port-normal",border:false}],width:98,cls:"syno-aha-config-if-cbackground"},this.createLanPort(1),this.createLanPort(2),this.createLanPort(3),this.createLanPort(4),{xtype:"panel",layout:"vbox",border:false,id:this.LanStatusSpace=Ext.id(),width:26,cls:"syno-aha-config-if-cbackground"},this.createLanPort(5),this.createLanPort(6),this.createLanPort(7),this.createLanPort(8),{xtype:"panel",layout:"vbox",border:false,width:20,cls:"syno-aha-config-if-cbackground"},{xtype:"panel",layout:"vbox",border:false,cls:"syno-aha-config-if-rbackground"}],border:false}},createLanPort:function(a){return{xtype:"panel",layout:"vbox",border:false,id:this.LanStatusID[a]=Ext.id(),hidden:a<=4?false:true,items:[{xtype:"syno_displayfield",value:"LAN "+a,cls:"syno-aha-config-lan-name-normal",id:this.LanStatusNameID[a]=Ext.id()},{xtype:"container",id:this.LanStatusLanProtID[a]=Ext.id(),cls:"syno-aha-config-lan-port-normal",border:false},{xtype:"panel",id:this.LanStatusWarning[a]=Ext.id(),cls:"syno-aha-netwokr-port-status-warning syno-aha-config-lan-port-warning-position",border:false,hidden:true}],width:66,cls:"syno-aha-config-if-cbackground"}},setLanPortStatus:function(a,b){if(undefined===Ext.getCmp(this.LanStatusLanProtID[a])){return}if(0===a){return}if(2000<b.active_speed){Ext.getCmp(this.LanStatusLanProtID[a]).el.removeClass("syno-aha-config-lan-port-normal");Ext.getCmp(this.LanStatusLanProtID[a]).el.addClass("syno-aha-config-lan-port-10g")}else{Ext.getCmp(this.LanStatusLanProtID[a]).el.removeClass("syno-aha-config-lan-port-10g");Ext.getCmp(this.LanStatusLanProtID[a]).el.addClass("syno-aha-config-lan-port-normal")}if("warning"===b.status){Ext.getCmp(this.LanStatusWarning[a]).el.removeClass("syno-aha-netwokr-port-status-error");Ext.getCmp(this.LanStatusWarning[a]).el.addClass("syno-aha-netwokr-port-status-warning");Ext.getCmp(this.LanStatusWarning[a]).show()}else{if("error"==b.status){Ext.getCmp(this.LanStatusWarning[a]).el.addClass("syno-aha-netwokr-port-status-error");Ext.getCmp(this.LanStatusWarning[a]).el.removeClass("syno-aha-netwokr-port-status-warning");Ext.getCmp(this.LanStatusWarning[a]).show()}else{Ext.getCmp(this.LanStatusWarning[a]).hide()}}},setSelectStatus:function(a,d){var e=null;var f=this.mainPanel.IPListStore.getAt(a);if("-1"!=f.get("bond_status")){var c=this.mainPanel.IPListStore.query("bond_status",f.get("bond_status"),false);var b=0;for(b=0;b<c.getCount();b++){e=Ext.getCmp(this.LanStatusNameID[c.items[b].data.data_id]);if(d){e.addClass("syno-aha-config-lan-name-active")}else{e.removeClass("syno-aha-config-lan-name-active")}}}else{e=Ext.getCmp(this.LanStatusNameID[a]);if(d){e.addClass("syno-aha-config-lan-name-active")}else{e.removeClass("syno-aha-config-lan-name-active")}}},isDirty:function(){var a=0;var c=this.mainPanel.IPListStore.getCount();for(a=0;a<c;a++){var b=this.mainPanel.IPListStore.getAt(a);if(b&&b.dirty){if(b.isModified("enabled")){return true}}}return false},onPageActivate:function(){this.startWebapis();this.appWin.setStatusBusy()},onPageDeactivate:function(){this.stopWebapis();this.mainPanel.getSelectionModel().clearSelections()},stopWebapis:function(){this.appWin.pollUnreg(this.PollID.NetworkInfo);this.appWin.pollUnreg(this.PollID.RemoteNodeStatus)},startWebapis:function(){this.PollID.NetworkInfo=this.appWin.pollReg(this.PollConfig.NetworkInfo);this.PollID.RemoteNodeStatus=this.appWin.pollReg(this.PollConfig.RemoteNodeStatus)},locationGet:function(){var b=window.location.toString();var a=b.indexOf("#");if(-1===a||a===b.length-1){return""}else{return b.substr(a+1)}},sendWebapiForReloadRemoteInfo:function(){this.sendWebAPI({api:"SYNO.Core.AHA.Node",version:1,method:"get",params:{role:["passive"]},callback:this.handleGetRemoteDone,scope:this})},handleGetRemoteDone:function(e,c,d,b){this.DataReady.RemoteNodeStatus=true;if(this.DataReady.NetworkInfo&&this.DataReady.RemoteNodeStatus){this.appWin.clearStatusBusy()}if(e){if("loading"===c.node_infos[0].status){this.mainPanel.columnModel.setColumnHeader(2,_T("common","loading"));var a=function(){this.sendWebapiForReloadRemoteInfo()};a.defer(1000,this)}else{if("offline"===c.node_infos[0].status){this.mainPanel.columnModel.setColumnHeader(2,_TT("SYNO.SDS.AHA.Instance","uicommon","role_offline"))}else{if("passive"==c.node_infos[0].role){this.mainPanel.columnModel.setColumnHeader(2,_TT("SYNO.SDS.AHA.Instance","uicommon","role_passive"))}else{this.mainPanel.columnModel.setColumnHeader(2,_TT("SYNO.SDS.AHA.Instance","uicommon","role_unknown"))}}}}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"));this.stopWebapis()}},handleGetNetworkDone:function(h,f,c,a){this.DataReady.NetworkInfo=true;if(this.DataReady.NetworkInfo&&this.DataReady.RemoteNodeStatus){this.appWin.clearStatusBusy()}var d=0;if(h){var e=[];var g=0;e.items=[];var j=[];this.DataCount=f.total;for(d=0;d<f.total;d++){j[g]={};j[g]["if"]=f.net_infos[d].name;j[g].active_speed=f.net_infos[d].additional.active_speed;j[g].passive_speed=f.net_infos[d].additional.passive_speed;j[g].bond_status=f.net_infos[d].additional.bond_id;j[g].status=f.net_infos[d].additional.status;j[g].is_monitored=f.net_infos[d].additional.is_monitored;j[g].data_id=d;e.items.push(j[g]);Ext.getCmp(this.LanStatusID[d]).hidden=false;Ext.getCmp(this.LanStatusID[d]).show();this.setLanPortStatus(d,j[g]);g++}if(d<6){Ext.getCmp(this.LanStatusSpace).hidden=true;Ext.getCmp(this.LanStatusSpace).hide()}for(;d<9;d++){Ext.getCmp(this.LanStatusID[d]).hidden=true;Ext.getCmp(this.LanStatusID[d]).hide()}if(this.mainPanel.IPListStore.getCount()!==e.items.length){this.mainPanel.IPListStore.loadData(e,false)}else{var b;for(d=0;d<e.items.length;d++){b=null;b=this.mainPanel.IPListStore.getById(e.items[d].data_id);if(b){b.set("if",e.items[d]["if"]);b.set("active_speed",e.items[d].active_speed);b.set("passive_speed",e.items[d].passive_speed);b.set("bond_status",e.items[d].bond_status);b.set("status",e.items[d].status);b.set("is_monitored",e.items[d].is_monitored)}else{this.mainPanel.IPListStore.loadData(e,false);break}}this.mainPanel.IPListStore.commitChanges()}Ext.getCmp(this.LanStatusPort).doLayout();Ext.getCmp(this.networkStatusID).doLayout()}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"));for(d=5;d<9;d++){Ext.getCmp(this.LanStatusID[d]).hidden=true;Ext.getCmp(this.LanStatusID[d]).hide()}this.stopWebapis()}},setStatusError:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","error_system"),iconCls:"syno-ux-statusbar-error",clear:true});this.getFooterToolbar().setStatus(b)},setStatusOK:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","setting_applied"),iconCls:"syno-ux-statusbar-success"});this.getFooterToolbar().setStatus(b)}});Ext.define("SYNO.SDS.AHA.AHAIPListPanel",{extend:"SYNO.ux.GridPanel",IPListStore:null,columnModel:null,btnEditID:null,AHAMainInterface:null,AHAConfigPanel:null,TableTitle:[],constructor:function(a){this.initForm(a);var b={title:a.title,owner:a.owner,region:"center",store:this.IPListStore,border:false,cls:"syno-aha-config-ip-list-detail",colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true,moveEditorOnEnter:false}),loadMask:true,stripeRows:true,width:715};Ext.apply(b,a);this.callParent([b]);this.getSelectionModel().on("rowselect",function(d,c,e){this.changeButtonStatus(d,c)},this);this.getSelectionModel().on("rowdeselect",function(d,c){this.changeButtonStatus(d,c)},this)},setConfigPanel:function(a){this.AHAConfigPanel=a},initForm:function(a){var c;if("general"===a.mode){c="data_id"}else{c="node_if"}var b=new Ext.data.Store({proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"items",id:c},["if","active_speed","passive_speed","bond_status","status","is_monitored","data_id"]),remoteSort:false});this.IPListStore=b;this.columnModel=this.createColumn()},changeButtonStatus:function(b,a){var c=b.getSelected();if(c){this.AHAConfigPanel.setSelectStatus(a,true)}else{this.AHAConfigPanel.setSelectStatus(a,false)}},createColumn:function(){var b=this;var a=new Ext.grid.ColumnModel({columns:[{header:_T("network","interface"),dataIndex:"if",width:0.2,align:"left",renderer:function(e){if("heartbeat"===e){return _TT("SYNO.SDS.AHA.Instance","uicommon","heartbeat")}var c=e.replace(/\w+(\.\d+|)/g,"$1");var d=SYNO.SDS.Utils.Network.idToString.apply(b,[e]);if(""!==c){d=d+" "+String.format(_TT("SYNO.SDS.AHA.Instance","network","vlan_id"),c.replace(".",""))}return d}},{header:_TT("SYNO.SDS.AHA.Instance","uicommon","role_active"),dataIndex:"active_speed",width:0.2,id:"active_speed",align:"left",renderer:function(c){if(-1===c){return _TT("SYNO.SDS.AHA.Instance","network","not_connected")}return(c/1000)+" Gbps"}},{header:_TT("SYNO.SDS.AHA.Instance","uicommon","none"),dataIndex:"passive_speed",width:0.2,id:this.TableTitle.passive_speed=Ext.id(),align:"left",renderer:function(c){if(-1===c){return _TT("SYNO.SDS.AHA.Instance","network","not_connected")}return(c/1000)+" Gbps"}},{header:_T("network","if_bond"),dataIndex:"bond_status",width:0.133,id:"bond_status",align:"left",renderer:function(c){if(-1===c){return""}else{return SYNO.SDS.Utils.Network.idToString.apply(this.nodeOwner,["bond"+c])}}},{header:_TT("SYNO.SDS.AHA.Instance","network","status"),dataIndex:"status",id:"status",width:0.133,align:"left",renderer:function(c){if("normal"===c){c='<font class="syno-aha-service-status-health">'+_TT("SYNO.SDS.AHA.Instance","uicommon","status_normal")+"</font>"}else{if("error"===c){c='<font class="syno-aha-service-status-error">'+_TT("SYNO.SDS.AHA.Instance","uicommon","status_error")+"</font>"}else{if("warning"===c){c='<font class="syno-aha-service-status-error">'+_TT("SYNO.SDS.AHA.Instance","uicommon","status_warning")+"</font>"}else{if("none"===c){c=_TT("SYNO.SDS.AHA.Instance","uicommon","none")}}}}return c}},{header:_TT("SYNO.SDS.AHA.Instance","network","monitored"),dataIndex:"is_monitored",id:"is_monitored",width:0.133,align:"left",renderer:function(c){if(true===c){return _T("common","yes")}else{return _TT("SYNO.SDS.AHA.Instance","uicommon","none")}}}],defaults:{sortable:false,menuDisabled:true}});return a}});Ext.define("SYNO.SDS.AHA.AHAPanelOverview",{extend:"Ext.Panel",statusIconCSSClass:["syno-aha-overview-icon-healthy","syno-aha-overview-icon-danger","syno-aha-overview-icon-standalone","syno-aha-overview-icon-warning","syno-aha-overview-icon-configuring","syno-aha-overview-icon-empty_passive","syno-aha-overview-icon-preparing","syno-aha-overview-icon-loading","syno-aha-overview-icon-undefined"],statusTitleCSSClass:["syno-aha-overview-titleText-healthy","syno-aha-overview-titleText-danger","syno-aha-overview-titleText-standalone","syno-aha-overview-titleText-warning","syno-aha-overview-titleText-configuring","syno-aha-overview-titleText-empty_passive","syno-aha-overview-titleText-preparing","syno-aha-overview-titleText-loading","syno-aha-overview-titleText-undefined"],sysStatusIndex:["healthy","error","standalone","warning","configuring","empty_passive","preparing","loading","undefined"],DSIconCSSClass:["syno-aha-overview-connectionFigure-normal","syno-aha-overview-connectionFigure-warning","syno-aha-overview-connectionFigure-offline","syno-aha-overview-connectionFigure-error","syno-aha-overview-connectionFigure-unknown","syno-aha-overview-connectionFigure-none","syno-aha-overview-connectionFigure-loading","syno-aha-overview-connectionFigure-unknown_server","syno-aha-overview-connectionFigure-boot_error","syno-aha-overview-connectionFigure-default"],DSWarningCSSClass:["syno-aha-overview-link-status-normal","syno-aha-overview-link-status-warning","syno-aha-overview-link-status-offline","syno-aha-overview-link-status-error","syno-aha-overview-link-status-unknown","syno-aha-overview-link-status-none","syno-aha-overview-link-status-loading","syno-aha-overview-link-status-unknown_server","syno-aha-overview-link-status-boot_error","syno-aha-overview-link-status-default"],DSStatus:["normal","warning","offline","error","undefined","none","loading","unknow_server","boot_error","default"],syncDirectionIconCSSClass:["syno-aha-overview-connectionFigure-syncNormal","syno-aha-overview-connectionFigure-syncWarning","syno-aha-overview-connectionFigure-syncStop","syno-aha-overview-connectionFigure-syncNone"],syncLinkStatueCSSClass:["syno-aha-overview-link-status-normal","syno-aha-overview-link-status-warning","syno-aha-overview-link-status-danger","syno-aha-overview-link-status-none"],linkStatueCSSClass:["syno-aha-overview-link-status-normal","syno-aha-overview-link-status-error","syno-aha-overview-link-status-none","syno-aha-overview-link-status-warning"],syncStatus:["normal","warning","error","none"],linkStatus:["normal","error","none","warning"],sysStatus:null,passiveOnline:null,progressFinished:false,tryAddrCount:null,hideMenuFlag:null,triggerMenuFlag:null,activeServer:"",localStatus:null,activeFailedServ:[],activeFailedNet:[],passiveServer:"",remoteStatus:null,passiveFailedServ:[],currentDescList:[],currentDescIndex:0,dataSyncProgress:"",haStatusKey:"",passiveDataUnsync:false,passiveSN:"",actionMenuOn:false,rightConnectionDetailPanelID:null,leftConnectionDetailPanelID:null,rightConnectionDetailPanelSensorID:null,leftConnectionDetailPanelSensorID:null,storageID:[],rnodeID:[],lnodeID:[],PollID:[],PollConfig:[],PageReady:[],localSN:null,remoteSN:null,waitCommandStatus:[],disableNodeSensor:false,loginIPIsStatic:false,switchover_timeout:300,isRemotePassive:true,constructor:function(a){this.appWin=a.appWin;var b=this.fillConfig(a);this.callParent([b]);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.stopWebapis,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.stopWebapis,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.stopWebapis,this);this.mon(Ext.getCmp(this.manageAHABtnID),"menuhide",this.onMenuhide,this);this.mon(Ext.getCmp(this.manageAHABtnID),"menutriggerout",this.onMenutriggerout,this);this.initEvent()},initEvent:function(a){},fillConfig:function(a){var b={border:false,itemId:"overview",layout:"vbox",layoutConfig:{align:"stretch",pack:"start"},items:[this.createBriefOverviewBox(),this.createConnectionOverviewBox()],style:"padding: 0;",cls:"syno-aha-overview-panel"};this.PollConfig.AHAInfo={interval:this.PollConfig.GetAHAInfoInterval=4,immediate:true,webapi:{api:"SYNO.Core.AHA",version:1,method:"get",params:{blocked:false,additional:["recover_remote","sync_status","descriptions","heartbeat_link_status"]}},status_callback:this.handleGetAHADone,scope:this};this.PollConfig.NodeInfo={interval:this.PollConfig.GetNodeInfoInterval=4,immediate:true,webapi:{api:"SYNO.Core.AHA.Node",version:1,method:"get",params:{role:["active","passive"],blocked:false,additional:["physical_position","fan_status","power_status","thermal","memory_size","net_status","storage_status","node_status"]}},status_callback:this.handleGetAHANodeDone,scope:this};this.PollConfig.EncInfo={interval:this.PollConfig.GetEnclosureInfoInterval=5,immediate:true,webapi:{api:"SYNO.Core.AHA.Enclosure",version:1,method:"get",params:{additional:["recover_remote","sync_status","descriptions","heartbeat_link_status"]}},status_callback:this.handleGetAHAEnclosureDone,scope:this};this.rnodeID.storageLinkCSSClass=["syno-aha-overview-storage-right-link-normal","syno-aha-overview-storage-right-link-error","syno-aha-overview-storage-right-link-none","syno-aha-overview-storage-right-link-warning"];this.rnodeID.netLinkCSSClass=["syno-aha-overview-net-right-link-normal","syno-aha-overview-net-right-link-error","syno-aha-overview-net-right-link-none","syno-aha-overview-net-right-link-warning"];this.lnodeID.storageLinkCSSClass=["syno-aha-overview-storage-left-link-normal","syno-aha-overview-storage-left-link-error","syno-aha-overview-storage-left-link-none","syno-aha-overview-storage-left-link-warning"];this.lnodeID.netLinkCSSClass=["syno-aha-overview-net-left-link-normal","syno-aha-overview-net-left-link-error","syno-aha-overview-net-left-link-none","syno-aha-overview-net-left-link-warning"];return SYNO.LayoutConfig.fill(b)},createBriefOverviewPanel:function(){return{xtype:"panel",hideLabel:true,id:this.BriefOverviewPanelID=Ext.id(),layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},width:720,height:200,border:false,items:[this.createStatusIconBox(),this.createStatusMessageBox()]}},createBriefOverviewBox:function(){return{xtype:"panel",hideLabel:true,layout:"vbox",width:752,height:200,layoutConfig:{align:"center"},border:false,items:[this.createBriefOverviewPanel()]}},createStatusIconBox:function(){return{xtype:"panel",layout:"hbox",layoutConfig:{align:"middle"},hideLabel:true,width:258,border:false,cls:"syno-aha-overview-icon",items:[this.createStatusIconPanel()]}},createStatusIconPanel:function(){return{xtype:"panel",hideLabel:true,id:this.statusIconPanelID=Ext.id(),width:128,height:128,border:false,cls:"syno-aha-overview-icon-loading"}},createStatusMessageBox:function(){return{xtype:"panel",hideLabel:true,border:false,id:this.StatusMessageBoxID=Ext.id(),layout:"hbox",layoutConfig:{align:"middle"},items:[this.createStatusMessagePanel()]}},createStatusMessagePanel:function(){return{xtype:"panel",hideLabel:true,width:439,height:155,style:"margin-top: 15px;",layoutConfig:{align:"top"},border:false,items:[{xtype:"syno_displayfield",style:"margin-bottom: 8px;",id:this.statusTitleID=Ext.id(),value:"",cls:"syno-aha-overview-titleText-loading"},{xtype:"panel",hideLabel:true,layout:"hbox",border:false,style:"margin-bottom: 8px;",items:[{xtype:"syno_displayfield",width:378,id:this.statusDescriptionID=Ext.id(),value:"",style:"padding: 0px;"},this.createDescriptionBtn()]},this.createOperationButtonPanel()]}},createDescriptionBtn:function(){return{xtype:"panel",hideLabel:true,cls:"syno-aha-overview-descriptions-btn",border:false,layout:"hbox",layoutConfig:{align:"middle"},items:[{xtype:"button",id:this.prevDescBtnID=Ext.id(),handler:this.onPrevDesc,disabled:_S("demo_mode"),scope:this,hidden:true,cls:"syno-aha-overview-prevDescButton"},{xtype:"button",id:this.nextDescBtnID=Ext.id(),handler:this.onNextDesc,disabled:_S("demo_mode"),scope:this,hidden:true,cls:"syno-aha-overview-nextDescButton"}]}},createOperationButtonPanel:function(){return{xtype:"panel",hideLabel:true,layoutConfig:{align:"stretch",pack:"start"},border:false,items:[new SYNO.ux.SplitButton({id:this.manageAHABtnID=Ext.id(),text:_TT("SYNO.SDS.AHA.Instance","uicommon","manage"),scope:this,handler:this.onSplitButton,disabled:true,hidden:false,menu:new Ext.menu.Menu({items:[{text:_TT("SYNO.SDS.AHA.Instance","overview","switch_server"),scope:this,id:this.switchBtnID=Ext.id(),disabled:false,handler:this.switchOver},{text:_TT("SYNO.SDS.AHA.Instance","overview","update_dsm"),scope:this,id:this.upgradeBtnID=Ext.id(),disabled:false,handler:this.doUpgrade},{text:_TT("SYNO.SDS.AHA.Instance","overview","shutdown_cluster"),scope:this,id:this.shutdownClusterBtnID=Ext.id(),disabled:true,handler:this.shutdownAHA},{text:_TT("SYNO.SDS.AHA.Instance","overview","shutdown_active"),scope:this,id:this.shutdownActiveBtnID=Ext.id(),disabled:false,handler:this.shutdownActive},{text:_TT("SYNO.SDS.AHA.Instance","overview","shutdown_passive"),scope:this,id:this.shutdownPassiveBtnID=Ext.id(),disabled:false,handler:this.shutdownPassive},{text:_TT("SYNO.SDS.AHA.Instance","overview","reboot_active"),scope:this,id:this.rebootActiveBtnID=Ext.id(),handler:this.rebootActive},{text:_TT("SYNO.SDS.AHA.Instance","overview","reboot_passive"),scope:this,id:this.rebootPassiveBtnID=Ext.id(),disabled:false,handler:this.rebootPassive},{text:_TT("SYNO.SDS.AHA.Instance","overview","recovery_remote"),scope:this,id:this.recoveryPassiveBtnID=Ext.id(),disabled:true,handler:this.recoveryPassive},{text:_TT("SYNO.SDS.AHA.Instance","overview","shut_beep_ha"),scope:this,id:this.beepOffHABtnID=Ext.id(),disabled:false,handler:this.shutbeepHA}]})})]}},descRenderer:function(e){var d="";var b=0;var c=[];var a="";if("desc_failed_service_active"===e.key||"desc_failed_service_passive"===e.key){if(""===e.info){a=_T("common","loading")}else{c=this.parseList(e.info);a="";for(b=0;b<c.size();b++){if(""!==a){a=a+", "}a=a+SYNO.SDS.AHA.ServiceRenderer(c[b])}}d=String.format(_TT("SYNO.SDS.AHA.Instance","overview",e.key),a)}else{if("desc_failed_net_active"===e.key||"desc_failed_net_passive"===e.key||"desc_monitored_ifs_no_static_ip"===e.key){if(""===e.info){a=_T("common","loading")}else{c=this.parseList(e.info);a="";for(b=0;b<c.size();b++){if(""!==a){a=a+", "}a=a+SYNO.SDS.Utils.Network.idToString.apply(this,[c[b]])}}d=String.format(_TT("SYNO.SDS.AHA.Instance","overview",e.key),a)}else{if("desc_host_hw_error_active"===e.key||"desc_host_hw_error_passive"===e.key||"desc_enclosure_hw_error"===e.key){if(""===e.info){a=_T("common","loading")}else{c=this.parseList(e.info);a="";for(b=0;b<c.size();b++){if(""!==a){a=a+", "}a=a+_TT("SYNO.SDS.AHA.Instance","uicommon",c[b])}}d=String.format(_TT("SYNO.SDS.AHA.Instance","overview",e.key),a)}else{if("desc_remote_boot_error"===e.key){if(""===e.info){a=_TT("SYNO.SDS.AHA.Instance","overview","boot_error_Unknown")}else{a=_TT("SYNO.SDS.AHA.Instance","overview","boot_error_"+e.info)}d=String.format(_TT("SYNO.SDS.AHA.Instance","overview",e.key),a)}else{if("loading"===e.key){d=""}else{d=this._APPSTR("SYNO.SDS.AHA.Instance","overview",e.key)}}}}}Ext.getCmp(this.statusDescriptionID).setValue(d);Ext.getCmp(this.StatusMessageBoxID).doLayout();Ext.getCmp(this.BriefOverviewPanelID).doLayout()},onNextDesc:function(){var b=this.currentDescList;var a=this.currentDescIndex;if(0>=b.size()){return}if(b.size()>a+1){this.descRenderer(b[a+1]);this.haStatusKey=b[a+1];this.currentDescIndex++;a=this.currentDescIndex}if(b.size()===a+1){Ext.getCmp(this.nextDescBtnID).disable()}if(0<a){Ext.getCmp(this.prevDescBtnID).enable()}},onPrevDesc:function(){var b=this.currentDescList;var a=this.currentDescIndex;if(0>=b.size()){return}if(0<a){this.descRenderer(b[a-1]);this.haStatusKey=b[a-1];this.currentDescIndex--;a=this.currentDescIndex}if(0===a){Ext.getCmp(this.prevDescBtnID).disable()}if(b.size()>a+1){Ext.getCmp(this.nextDescBtnID).enable()}},onMenuhide:function(){this.hideMenuFlag=1},onMenutriggerout:function(){this.triggerMenuFlag=1},onSplitButton:function(a){if(1===this.hideMenuFlag&&0===this.triggerMenuFlag){a.hideMenu()}else{a.showMenu()}this.hideMenuFlag=0;this.triggerMenuFlag=0},createConnectionOverviewPanel:function(){return{xtype:"panel",hideLabel:true,width:752,height:360,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[this.createConnectionOverviewPanelContent(),this.createLeftNodeInfo(),this.createRightNodeInfo(),this.createLeftWarningStatus(),this.createRightWarningStatus(),this.createLeftConnectionDetailPanelSensor(),this.createRightConnectionDetailPanelSensor(),this.createLowerStorageMachine()]}},createConnectionOverviewBox:function(){return{xtype:"panel",hideLabel:true,height:360,layout:"vbox",layoutConfig:{align:"center"},border:false,items:[this.createConnectionOverviewPanel()]}},createConnectionOverviewPanelContent:function(){return{xtype:"panel",hideLabel:true,flex:1,width:752,layout:"vbox",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[this.createUpperGraphicalConnectionFigurePanel(),this.createGraphicalConnectionFigurePanel(),this.createLowerGraphicalConnectionFigurePanel()]}},createLeftNodeInfo:function(){return{xtype:"panel",hideLabel:true,width:376,layoutConfig:{align:"middle"},id:this.lnodeID.DS_name=Ext.id(),border:false,cls:"syno-aha-overview-lnodeinfo",items:[{xtype:"syno_displayfield",value:_TT("SYNO.SDS.AHA.Instance","uicommon","none"),cls:"syno-aha-overview-nodeinfo-nodeID",id:this.lnodeID.role=Ext.id(),border:false},{xtype:"container",height:46,id:this.lnodeID.DS=Ext.id(),cls:"syno-aha-overview-connectionFigure-default",border:false},this.createLeftConnectionDetailPanel()]}},createRightNodeInfo:function(){return{xtype:"panel",hideLabel:true,width:376,layoutConfig:{align:"middle"},cls:"syno-aha-overview-rnodeinfo",id:this.rnodeID.DS_name=Ext.id(),border:false,items:[{xtype:"syno_displayfield",value:_TT("SYNO.SDS.AHA.Instance","uicommon","none"),cls:"syno-aha-overview-nodeinfo-nodeID",id:this.rnodeID.role=Ext.id(),border:false},{xtype:"container",height:46,id:this.rnodeID.DS=Ext.id(),cls:"syno-aha-overview-connectionFigure-offline",border:false},this.createRightConnectionDetailPanel()]}},createRightWarningStatus:function(){return{xtype:"panel",id:this.rnodeID.DSWarning=Ext.id(),cls:"syno-aha-overview-ds-right-status-position syno-aha-overview-link-status-default",border:false}},createLeftWarningStatus:function(){return{xtype:"panel",id:this.lnodeID.DSWarning=Ext.id(),cls:"syno-aha-overview-ds-left-status-position syno-aha-overview-link-status-default",border:false}},createUpperNetworkMachine:function(){return{xtype:"panel",hideLabel:true,layout:"vbox",height:112,width:752,cls:"syno-aha-overview-net-network",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[{xtype:"panel",cls:"syno-aha-overview-net-network-icon",id:this.upperCenterIconID=Ext.id(),border:false,width:752},{xtype:"syno_displayfield",width:752,id:this.upperCenterID=Ext.id(),cls:"syno-aha-overview-net-network-name",value:_TT("SYNO.SDS.AHA.Instance","overview","data_network")}]}},createUpperGraphicalConnectionFigurePanel:function(){return{xtype:"panel",hideLabel:true,height:112,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[this.createUpperNetworkMachine(),{xtype:"panel",hideLabel:true,height:112,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},cls:"syno-aha-overview-net-left-link-position",border:false,items:[{xtype:"panel",id:this.lnodeID.net_link=Ext.id(),cls:"syno-aha-overview-net-link-none",border:false,width:376},{xtype:"panel",id:this.lnodeID.net_warning=Ext.id(),cls:"syno-aha-overview-net-left-link-status-position syno-aha-overview-link-status-none",border:false,width:376}]},{xtype:"panel",hideLabel:true,height:112,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},cls:"syno-aha-overview-net-right-link-position",border:false,items:[{xtype:"panel",id:this.rnodeID.net_link=Ext.id(),cls:"syno-aha-overview-net-link-none",border:false,width:376},{xtype:"panel",id:this.rnodeID.net_warning=Ext.id(),cls:"syno-aha-overview-net-right-link-status-position syno-aha-overview-link-status-none",border:false,width:376}]}]}},createLowerStorageMachine:function(){return{xtype:"panel",hideLabel:true,layout:"vbox",height:220,width:752,cls:"syno-aha-overview-storage",id:this.storageID.name_icon=Ext.id(),layoutConfig:{align:"stretch",pack:"start"},border:false,items:[this.createStorageDetailPanel(),this.createStorageDetailSensor(),{xtype:"syno_displayfield",width:338,id:this.storageID.name=Ext.id(),cls:"syno-aha-overview-storage-name",value:_TT("SYNO.SDS.AHA.Instance","overview","storage")},{xtype:"panel",scope:this,cls:"syno-aha-overview-storage-icon",id:this.storageID.icon=Ext.id(),border:false,width:338},{xtype:"button",scope:this,iconCls:"syno-aha-overview-storage-sensor-icon",cls:"syno-aha-overview-storage-sensor-position",id:this.storageID.sensor=Ext.id(),width:338},{xtype:"panel",id:this.storageID.Warning=Ext.id(),width:36,cls:"syno-aha-overview-storage-status-position syno-aha-overview-link-status-default",border:false}]}},createLowerGraphicalConnectionFigurePanel:function(){return{xtype:"panel",hideLabel:true,height:220,layout:"hbox",layoutConfig:{pack:"start"},border:false,items:[{xtype:"panel",hideLabel:true,height:220,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},cls:"syno-aha-overview-storage-left-link-position",border:false,items:[{xtype:"panel",id:this.lnodeID.storage_link=Ext.id(),cls:"syno-aha-overview-storage-link-none",border:false,width:376},{xtype:"panel",id:this.lnodeID.storage_warning=Ext.id(),cls:"syno-aha-overview-storage-left-link-status-position syno-aha-overview-link-status-none",border:false,width:376}]},{xtype:"panel",hideLabel:true,height:220,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},cls:"syno-aha-overview-storage-right-link-position",border:false,items:[{xtype:"panel",id:this.rnodeID.storage_link=Ext.id(),cls:"syno-aha-overview-storage-link-none",border:false,width:376},{xtype:"panel",id:this.rnodeID.storage_warning=Ext.id(),cls:"syno-aha-overview-storage-right-link-status-position syno-aha-overview-link-status-none",border:false,width:376}]}]}},createGraphicalConnectionFigurePanel:function(){return{xtype:"panel",hideLabel:true,height:73,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[{xtype:"panel",id:this.syncDirectionIconID=Ext.id(),border:false,width:752},{xtype:"panel",id:this.syncDirectionStatusID=Ext.id(),cls:"syno-aha-overview-sync-link-status-position syno-aha-overview-link-status-none",border:false,width:752}]}},createLeftConnectionDetailPanelSensor:function(){return{xtype:"panel",hideLabel:true,cls:"syno-aha-overview-detail-sensor syno-aha-overview-detail-sensor-lnode-position",border:false,id:this.lnodeID.sensor=Ext.id(),width:305,height:80}},createRightConnectionDetailPanelSensor:function(){return{xtype:"panel",hideLabel:true,cls:"syno-aha-overview-detail-sensor syno-aha-overview-detail-sensor-rnode-position",border:false,id:this.rnodeID.sensor=Ext.id(),width:305,height:80}},createStorageDetailSensor:function(){return{xtype:"panel",width:752,id:this.storageID.detailSensor=Ext.id(),cls:"syno-aha-overview-storage-detailSensor",hidden:true}},createStorageDetailPanel:function(){return{xtype:"panel",hideLabel:false,layout:"form",labelSeparator:"",width:752,labelWidth:180,id:this.storageID.detail=Ext.id(),cls:"syno-aha-overview-storage-detail",border:true,hidden:true,items:[{xtype:"syno_displayfield",htmlEncode:false,hideLabel:false,fieldLabel:_TT("SYNO.SDS.AHA.Instance","uicommon","server_fan"),id:this.storageID.fan_status=Ext.id(),value:"N/A"},{xtype:"syno_displayfield",htmlEncode:false,hideLabel:false,fieldLabel:_TT("SYNO.SDS.AHA.Instance","uicommon","server_power"),id:this.storageID.power_status=Ext.id(),labelStyle:"background-color: #f2f4f7;",style:"background-color: #f2f4f7;",value:"N/A"}]}},createLeftConnectionDetailPanel:function(){return{xtype:"panel",hideLabel:false,layout:"form",width:305,labelWidth:152,id:this.lnodeID.detail=Ext.id(),cls:"syno-aha-overview-lnode-detail",border:true,hidden:true,items:[{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.AHA.Instance","uicommon","server_sn"),id:this.lnodeID.sn=Ext.id(),cls:"syno-aha-overview-node-detail-odd",value:""},{xtype:"syno_displayfield",htmlEncode:false,hideLabel:false,fieldLabel:_TT("SYNO.SDS.AHA.Instance","uicommon","server_fan"),id:this.lnodeID.fan_status=Ext.id(),labelStyle:"background-color: #f2f4f7;",style:"background-color: #f2f4f7;",value:""},{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.AHA.Instance","uicommon","server_thermal"),id:this.lnodeID.thermal=Ext.id(),value:""},{xtype:"syno_displayfield",htmlEncode:false,hideLabel:false,fieldLabel:_TT("SYNO.SDS.AHA.Instance","uicommon","server_power"),id:this.lnodeID.power_status=Ext.id(),labelStyle:"background-color: #f2f4f7;",style:"background-color: #f2f4f7;",value:""},{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_T("rsrcmonitor","physical_memory"),id:this.lnodeID.memory_size=Ext.id(),value:""}]}},createRightConnectionDetailPanel:function(){return{xtype:"panel",hideLabel:false,layout:"form",width:305,labelWidth:152,id:this.rnodeID.detail=Ext.id(),cls:"syno-aha-overview-rnode-detail",hidden:true,border:false,items:[{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.AHA.Instance","uicommon","server_sn"),id:this.rnodeID.sn=Ext.id(),value:""},{xtype:"syno_displayfield",htmlEncode:false,hideLabel:false,fieldLabel:_TT("SYNO.SDS.AHA.Instance","uicommon","server_fan"),id:this.rnodeID.fan_status=Ext.id(),labelStyle:"background-color: #f2f4f7;",style:"background-color: #f2f4f7;",value:""},{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.AHA.Instance","uicommon","server_thermal"),id:this.rnodeID.thermal=Ext.id(),value:""},{xtype:"syno_displayfield",htmlEncode:false,hideLabel:false,fieldLabel:_TT("SYNO.SDS.AHA.Instance","uicommon","server_power"),id:this.rnodeID.power_status=Ext.id(),labelStyle:"background-color: #f2f4f7;",style:"background-color: #f2f4f7;",value:""},{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_T("rsrcmonitor","physical_memory"),id:this.rnodeID.memory_size=Ext.id(),value:""}]}},doUpgrade:function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",Ext.apply(this.appWin.findAppWindow().openConfig,{fn:"SYNO.SDS.AdminCenter.Update_Reset.Main"}))},doLanuchSotrageManager:function(){var a=this.appWin.findAppWindow();if(a.getOpenConfig("className")!=="SYNO.SDS.CMS.Application"){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance",Ext.apply(this.appWin.findAppWindow().openConfig,{fn:"SYNO.SDS.StorageManager.StorageDualHeadOverview.Main"}))}},switchOver:function(){var b=this;var a={role:"ha",success_callback:function(){b.switchoverSuccess()},confirm_callback:function(){b.appWin.setStatusBusy();b.sendSwitchOverReq(true)},cancel_callback:function(){b.startWebapis()}};this.stopWebapis();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_TT("SYNO.SDS.AHA.Instance","overview","warning_switchover"),function(c){if("yes"!==c){this.appWin.clearStatusBusy();this.startWebapis()}else{if(this.loginIPIsStatic){this.haltChecker(b,"switchover",a)}else{this.appWin.clearStatusBusy();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_TT("SYNO.SDS.AHA.Instance","overview","warning_switchover_with_non_static_ip"),function(d){if("yes"===d){this.haltChecker(b,"switchover",a)}else{this.appWin.clearStatusBusy();this.startWebapis()}},this)}}},this)},switchoverSuccess:function(){this.setSwitchingNodeInfo(this.lnodeID);this.setSwitchingNodeInfo(this.rnodeID);this.PageReady.waitCommandStartTime=(new Date()).getTime();this.PageReady.waitCommand=true;this.PageReady.NodeData=false;this.waitCommandStatus.activeSN=this.remoteSN;this.waitCommandStatus.is_switchover=true;this.waitCommandStatus.remoteSN=this.localSN;this.waitCommandStatus.switchover_promote_done=false;this.waitingBox({title:_TT("SYNO.SDS.AHA.Instance","uicommon","name"),times:this.switchover_timeout,msg:_TT("SYNO.SDS.AHA.Instance","overview","switching")});SYNO.SDS.StatusNotifier.fireEvent("halt")},sendSwitchOverReq:function(a){this.appWin.sendWebAPI({api:"SYNO.Core.AHA",version:1,method:"switchover",params:{skip_check:a},callback:function(e,c,d,b){if(e){if(""!==this.checkBlocking(c,"switchover")){this.startWebapis();this.appWin.clearStatusBusy();return}this.switchoverSuccess()}else{this.appWin.clearStatusBusy();this.startWebapis();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"))}},scope:this})},shutbeepHA:function(){this.appWin.setStatusBusy();this.appWin.sendWebAPI({api:"SYNO.Core.AHA",version:1,method:"turn_off_beep",params:{},callback:function(d,b,c,a){this.appWin.clearStatusBusy();if(d){}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"))}},scope:this})},getSysMsgBox:function(){if(!this.msgBox||this.msgBox.isDestroyed){this.msgBox=new SYNO.SDS.MessageBoxV5({modal:true,draggable:false,renderTo:document.body})}return this.msgBox.getWrapper()},doRecovery:function(a){this.appWin.sendWebAPI({api:"SYNO.Core.AHA",version:1,method:"recovery",params:{role:a},callback:function(e,c,d,b){if(e){this.PageReady.waitCommandStartTime=(new Date()).getTime();this.waitCommand=true;this.PageReady.NodeData=false;this.waitCommandStatus.remote_is_passive=true;this.waitCommandStatus.timeout=0;this.startWebapis()}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"))}},scope:this})},shutdownSuccess:function(a){if("passive"===a){this.waitCommandStatus.remoteShutdown=true;this.waitCommandStatus.timeout=0;this.PageReady.waitCommandStartTime=(new Date()).getTime();this.PageReady.waitCommand=true;this.PageReady.NodeData=false;this.startWebapis()}else{if("active"===a&&""!==this.remoteSN&&true===this.can_failover){this.waitCommandStatus.activeSN=this.remoteSN;this.PageReady.waitCommandStartTime=(new Date()).getTime();this.PageReady.waitCommand=true;this.PageReady.NodeData=false;this.waitCommandStatus.timeout=0;this.waitingBox({title:_TT("SYNO.SDS.AHA.Instance","uicommon","name"),times:this.switchover_timeout,msg:_TT("SYNO.SDS.AHA.Instance","overview","takeover")});SYNO.SDS.StatusNotifier.fireEvent("halt")}else{this.setObjectClassBySyncStatus(Ext.getCmp(this.syncDirectionIconID),"none",this.syncDirectionIconCSSClass);this.getSysMsgBox().show({closable:false,maxWidth:300,title:_D("product"),msg:_T("system","shutdown_desc2")});SYNO.SDS.StatusNotifier.fireEvent("halt");SYNO.SDS.Desktop.hide()}}},doShutdown:function(a,b){this.appWin.sendWebAPI({api:"SYNO.Core.AHA",version:1,method:"shutdown",params:{role:a,skip_check:b},callback:function(f,d,e,c){if(f){if(""!==this.checkBlocking(d,"shutdown")){this.startWebapis();this.appWin.clearStatusBusy();return}this.shutdownSuccess(a)}else{this.startWebapis();this.appWin.clearStatusBusy();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"))}},scope:this})},shutdownHaltOpt:function(a){var b=this;return{role:a,success_callback:function(){b.shutdownSuccess(a)},confirm_callback:function(){b.appWin.setStatusBusy();b.doShutdown(a,true)},cancel_callback:function(){b.startWebapis()}}},shutdownAHA:function(){var a=this;this.stopWebapis();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_TT("SYNO.SDS.AHA.Instance","overview","warning_shutdown_cluster"),function(b){if("yes"===b){this.haltChecker(a,"shutdown",this.shutdownHaltOpt("ha"))}else{this.appWin.clearStatusBusy();this.startWebapis()}},this)},shutdownActive:function(){var a=this;this.stopWebapis();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_TT("SYNO.SDS.AHA.Instance","overview","warning_shutdown_active"),function(b){if("yes"===b){this.haltChecker(a,"shutdown",this.shutdownHaltOpt("active"))}else{this.appWin.clearStatusBusy();this.startWebapis()}},this)},shutdownPassive:function(){var a=this;this.stopWebapis();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),this.getStringFromRemoteStatus(_TT("SYNO.SDS.AHA.Instance","overview","warning_shutdown_passive"),_TT("SYNO.SDS.AHA.Instance","overview","warning_shutdown_remote")),function(b){if("yes"===b){this.haltChecker(a,"shutdown",this.shutdownHaltOpt("passive"))}else{this.appWin.clearStatusBusy();this.startWebapis()}},this)},recoveryPassive:function(){this.stopWebapis();this.appWin.setStatusBusy();this.doRecovery("passive")},rebootSuccess:function(a){if("passive"===a){this.waitCommandStatus.remoteShutdown=true;this.waitCommandStatus.remoteReboot=true;this.waitCommandStatus.timeout=0;this.PageReady.waitCommandStartTime=(new Date()).getTime();this.PageReady.waitCommand=true;this.PageReady.NodeData=false;this.startWebapis()}else{if("active"===a){this.waitCommandStatus.rebootActive=true;this.PageReady.waitCommandStartTime=(new Date()).getTime();this.PageReady.waitCommand=true;this.PageReady.NodeData=false;this.waitCommandStatus.timeout=0;this.waitingBox({title:_TT("SYNO.SDS.AHA.Instance","uicommon","name"),times:this.switchover_timeout,msg:_TT("SYNO.SDS.AHA.Instance","overview","rebooting_active")});SYNO.SDS.StatusNotifier.fireEvent("halt")}}},doReboot:function(a,b){this.appWin.sendWebAPI({api:"SYNO.Core.AHA",version:1,method:"reboot",params:{role:a,skip_check:b},callback:function(f,d,e,c){if(f){if(""!==this.checkBlocking(d,"reboot")){this.startWebapis();this.appWin.clearStatusBusy();return}this.rebootSuccess(a)}else{this.startWebapis();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"))}},scope:this})},rebootHaltOpt:function(a){var b=this;return{role:a,success_callback:function(){b.rebootSuccess(a)},confirm_callback:function(){b.appWin.setStatusBusy();b.doReboot(a,true)},cancel_callback:function(){b.startWebapis()}}},rebootPassive:function(){var a=this;this.stopWebapis();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),this.getStringFromRemoteStatus(_TT("SYNO.SDS.AHA.Instance","overview","warning_reboot_passive"),_TT("SYNO.SDS.AHA.Instance","overview","warning_reboot_remote")),function(b){if("yes"===b){this.haltChecker(a,"reboot",this.rebootHaltOpt("passive"))}else{this.appWin.clearStatusBusy();this.startWebapis()}},this)},rebootActive:function(){var a=this;this.stopWebapis();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_TT("SYNO.SDS.AHA.Instance","overview","warning_reboot_active"),function(b){if("yes"===b){this.haltChecker(a,"reboot",this.rebootHaltOpt("active"))}else{this.appWin.clearStatusBusy();this.startWebapis()}},this)},onPageActivate:function(){if(this.storageID&&this.storageID.detail&&true===Ext.getCmp(this.storageID.detail).isVisible()){this.handleStorageHideDetail()}this.doLayout();this.startWebapis();this.appWin.setStatusBusy();this.PageReady=[];this.rnodeID.addSensor=false;this.lnodeID.addSensor=false;this.storageID.addSensor=false;this.localSN=null;Ext.getCmp(this.storageID.name).setValue(_TT("SYNO.SDS.AHA.Instance","overview","storage"));SYNO.SDS.Utils.AddTip(Ext.getCmp(this.storageID.name).getEl(),"")},onPageDeactivate:function(){this.PageReady=[];this.stopWebapis()},startWebapis:function(){this.PollID.AHAInfo=this.appWin.pollReg(this.PollConfig.AHAInfo);this.PollID.NodeInfo=this.appWin.pollReg(this.PollConfig.NodeInfo);this.PollID.EncInfo=this.appWin.pollReg(this.PollConfig.EncInfo)},pollSuccess:function(){this.PollConfig.FailedTimes=0},pollFailed:function(a){this.PollConfig.FailedTimes++;if(5<this.PollConfig.FailedTimes){this.PageReady=[];this.setStatusBusy();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"))}},stopWebapis:function(){if(this.PollID.AHAInfo){this.appWin.pollUnreg(this.PollID.AHAInfo)}if(this.PollID.NodeInfo){this.appWin.pollUnreg(this.PollID.NodeInfo)}if(this.PollID.EncInfo){this.appWin.pollUnreg(this.PollID.EncInfo)}this.PageReady.Enclosure=false;this.PageReady.AHA=false;this.PageReady.Node=false},isNodeNotOnline:function(a,b){return""===a||"offline"===b||"none"===b||"switching_failed"==a},renderFanStatus:function(b,c,a){if(this.isNodeNotOnline(b,c)){b="N/A"}else{if("undefined"===a){b='<font class="syno-aha-service-status-warning">'+_TT("SYNO.SDS.AHA.Instance","uicommon","unknown")+"</font>"}else{if("loading"===b){b='<font class="syno-aha-service-status-warning">'+_T("common","loading")+"</font>"}else{if("normal"===b){b='<font class="syno-aha-service-status-health">'+_TT("SYNO.SDS.AHA.Instance","uicommon","status_normal")+"</font>"}else{b='<font class="syno-aha-service-status-error">'+_TT("SYNO.SDS.AHA.Instance","uicommon","fail")+"</font>"}}}}return b},renderPowerStatus:function(b,c,a){if(this.isNodeNotOnline(b,c)){b="N/A"}else{if("undefined"===a){b='<font class="syno-aha-service-status-warning">'+_TT("SYNO.SDS.AHA.Instance","uicommon","unknown")+"</font>"}else{if("loading"===b){b='<font class="syno-aha-service-status-warning">'+_T("common","loading")+"</font>"}else{if("normal"===b){b='<font class="syno-aha-service-status-health">'+_TT("SYNO.SDS.AHA.Instance","uicommon","status_normal")+"</font>"}else{b='<font class="syno-aha-service-status-error">'+_TT("SYNO.SDS.AHA.Instance","uicommon","fail")+"</font>"}}}}return b},renderMemorySize:function(a,b){if(this.isNodeNotOnline(a,b)){a="N/A"}else{a=a+" "+_T("common","size_mb")}return a},renderThermalStatus:function(a,b){if("yes"!==_D("supportsystemperature")||this.isNodeNotOnline(a,b)){return"N/A"}return String.format("{0} {1} / {2} {3}",a,_T("status","celsius"),(a*9/5+32).toFixed(0),_T("status","fahrenheit"))},renderServerDetails:function(a,b){if(""===a){a="N/A"}return a},renderNodeRole:function(a,b){if("offline"===b){a=_TT("SYNO.SDS.AHA.Instance","uicommon","role_offline")}else{if("boot_error"===b){a=_TT("SYNO.SDS.AHA.Instance","uicommon","role_boot_error")}else{if("switching"===b){a=_TT("SYNO.SDS.AHA.Instance","uicommon","role_switching")}else{if("switching_failed"===b){a=_TT("SYNO.SDS.AHA.Instance","uicommon","role_switching_failed")}else{if("upgrading"===b){a=_TT("SYNO.SDS.AHA.Instance","uicommon","role_upgrading")}else{if("recovering"===b){a=_TT("SYNO.SDS.AHA.Instance","uicommon","role_recovering")}else{if("loading"===b){a=_T("common","loading")}else{if("unknow_server"===b){a=_TT("SYNO.SDS.AHA.Instance","uicommon","role_unknown")}else{if("active"===a){a=_TT("SYNO.SDS.AHA.Instance","uicommon","role_active")}else{if("passive"===a){a=_TT("SYNO.SDS.AHA.Instance","uicommon","role_passive")}else{a=_TT("SYNO.SDS.AHA.Instance","uicommon","role_unknown")}}}}}}}}}}return a},parseList:function(a){var b=a.split(",");return b},handleStorageShowDetail:function(){if(!this.isPageDataReady()){return}if(this.hasBeenShowStorageDetail){return}this.hasBeenShowStorageDetail=true;this.disableNodeSensor=true;Ext.getCmp(this.storageID.detail).show();Ext.getCmp(this.storageID.detailSensor).show();Ext.getCmp(this.storageID.name).el.addClass("syno-aha-overview-storage-name-active");Ext.getCmp(this.storageID.name).el.removeClass("syno-aha-overview-storage-name");Ext.getCmp(this.lnodeID.DS_name).el.addClass("syno-aha-overview-lower-index");Ext.getCmp(this.rnodeID.DS_name).el.addClass("syno-aha-overview-lower-index");Ext.getCmp(this.lnodeID.DSWarning).el.addClass("syno-aha-overview-lower-index");Ext.getCmp(this.rnodeID.DSWarning).el.addClass("syno-aha-overview-lower-index");Ext.getCmp(this.lnodeID.sensor).hide();Ext.getCmp(this.rnodeID.sensor).hide()},handleStorageHideDetail:function(){if(false===this.disableNodeSensor){return}this.hasBeenShowStorageDetail=false;this.disableNodeSensor=false;Ext.getCmp(this.storageID.detail).hide();Ext.getCmp(this.storageID.detailSensor).hide();Ext.getCmp(this.storageID.name).el.addClass("syno-aha-overview-storage-name");Ext.getCmp(this.storageID.name).el.removeClass("syno-aha-overview-storage-name-active");Ext.getCmp(this.lnodeID.DS_name).el.removeClass("syno-aha-overview-lower-index");Ext.getCmp(this.rnodeID.DS_name).el.removeClass("syno-aha-overview-lower-index");Ext.getCmp(this.lnodeID.DSWarning).el.removeClass("syno-aha-overview-lower-index");Ext.getCmp(this.rnodeID.DSWarning).el.removeClass("syno-aha-overview-lower-index");Ext.getCmp(this.lnodeID.sensor).show();Ext.getCmp(this.rnodeID.sensor).show();Ext.getCmp(this.lnodeID.detail).hide();Ext.getCmp(this.lnodeID.sensor).el.removeClass("syno-aha-overview-detail-sensor-active");Ext.getCmp(this.lnodeID.DS_name).el.removeClass("syno-aha-overview-higher-index");Ext.getCmp(this.rnodeID.detail).hide();Ext.getCmp(this.rnodeID.sensor).el.removeClass("syno-aha-overview-detail-sensor-active");Ext.getCmp(this.rnodeID.DS_name).el.removeClass("syno-aha-overview-higher-index");Ext.getCmp(this.storageID.icon).el.removeClass("syno-aha-overview-lower-index");Ext.getCmp(this.storageID.Warning).el.removeClass("syno-aha-overview-lower-index");Ext.getCmp(this.storageID.name_icon).el.removeClass("syno-aha-overview-lower-index")},addStorageDetail:function(){var b=this;if(true!==this.storageID.addSensor){var a={btn:false,detail:false};Ext.getCmp(this.storageID.sensor).getEl().on("mouseover",function(){a.btn=true;this.handleStorageShowDetail()},this);Ext.getCmp(this.storageID.sensor).getEl().on("mouseout",function(e,d,f){a.btn=false;if(false===a.detail){b.handleStorageHideDetail()}},this);Ext.getCmp(this.storageID.detailSensor).getEl().on("mouseenter",function(){a.detail=true;this.handleStorageShowDetail()},this);Ext.getCmp(this.storageID.detailSensor).getEl().on("mouseout",function(){a.detail=false;if(false===a.btn){this.handleStorageHideDetail()}},this);Ext.getCmp(this.storageID.sensor).getEl().on("click",function(){this.doLanuchSotrageManager()},this);this.storageID.addSensor=true}},addMachineDetail:function(b,a){if(true!==b.addSensor&&"loading"!==a.status){Ext.getCmp(b.sensor).getEl().on("mouseover",function(){if(this.disableNodeSensor||b.disableSensor){return}Ext.getCmp(b.detail).show();Ext.getCmp(this.storageID.icon).el.addClass("syno-aha-overview-lower-index");Ext.getCmp(this.storageID.Warning).el.addClass("syno-aha-overview-lower-index");Ext.getCmp(this.storageID.name_icon).el.addClass("syno-aha-overview-lower-index");Ext.getCmp(b.sensor).el.addClass("syno-aha-overview-detail-sensor-active");Ext.getCmp(b.DS_name).el.addClass("syno-aha-overview-higher-index");Ext.getCmp(b.DSWarning).el.addClass("syno-aha-overview-higher-1-index");Ext.getCmp(b.sensor).el.addClass("syno-aha-overview-higher-2-index")},this);Ext.getCmp(b.sensor).getEl().on("mouseout",function(){Ext.getCmp(b.detail).hide();Ext.getCmp(this.storageID.icon).el.removeClass("syno-aha-overview-lower-index");Ext.getCmp(this.storageID.Warning).el.removeClass("syno-aha-overview-lower-index");Ext.getCmp(b.sensor).el.removeClass("syno-aha-overview-detail-sensor-active");Ext.getCmp(this.storageID.name_icon).el.removeClass("syno-aha-overview-lower-index");Ext.getCmp(b.DS_name).el.removeClass("syno-aha-overview-higher-index");Ext.getCmp(b.DSWarning).el.removeClass("syno-aha-overview-higher-1-index");Ext.getCmp(b.sensor).el.removeClass("syno-aha-overview-higher-2-index")},this);b.addSensor=true}},sendWebapiForReloadEncInfo:function(){this.sendWebAPI({api:"SYNO.Core.AHA.Enclosure",version:1,method:"get",params:{additional:["recover_remote","sync_status","descriptions","heartbeat_link_status"]},callback:this.handleGetAHAEnclosureDone,scope:this})},sendWebapiForReloadAHANodeInfo:function(){this.sendWebAPI({api:"SYNO.Core.AHA.Node",version:1,method:"get",params:{blocked:false,role:["active","passive"],additional:["physical_position","fan_status","power_status","thermal","memory_size","net_status","storage_status","node_status"]},callback:this.handleGetAHANodeDone,scope:this})},sendWebapiForReloadAHAInfo:function(){this.sendWebAPI({api:"SYNO.Core.AHA",version:1,method:"get",params:{blocked:false,additional:["recover_remote","sync_status","descriptions","heartbeat_link_status"]},callback:this.handleGetAHADone,scope:this})},handleGetAHADone:function(g,e,f,c){if(g){this.pollSuccess();this.PageReady.AHA=true;if(this.isPageReady()){this.appWin.clearStatusBusy()}if(!this.isPageDataReady()){this.setObjectValueBySysStatus(Ext.getCmp(this.statusTitleID),"loading");this.setObjectClassBySysStatus(Ext.getCmp(this.statusTitleID),"loading",this.statusTitleCSSClass);this.setObjectClassBySysStatus(Ext.getCmp(this.statusIconPanelID),"loading",this.statusIconCSSClass);Ext.getCmp(this.manageAHABtnID).disable();var a=function(){this.sendWebapiForReloadAHAInfo()};a.defer(1000,this);this.currentDescIndex=0;this.descRenderer({key:"loading"});this.currentDescList={key:"loading"};Ext.getCmp(this.prevDescBtnID).hide();Ext.getCmp(this.nextDescBtnID).hide();return}if(true!==_S("demo_mode")){Ext.getCmp(this.manageAHABtnID).enable()}if("true"===e.additional.recover_remote){Ext.getCmp(this.recoveryPassiveBtnID).enable()}else{Ext.getCmp(this.recoveryPassiveBtnID).disable()}this.setObjectClassBySysStatus(Ext.getCmp(this.statusTitleID),e.status,this.statusTitleCSSClass);this.setObjectClassBySysStatus(Ext.getCmp(this.statusIconPanelID),e.status,this.statusIconCSSClass);if("upgrading"===this.remoteStatus||"switching"===this.remoteStatus||"recovering"===this.remoteStatus){this.setObjectClassBySyncStatus(Ext.getCmp(this.syncDirectionIconID),"normal",this.syncDirectionIconCSSClass);this.setObjectClassBySyncStatus(Ext.getCmp(this.syncDirectionStatusID),"normal",this.syncLinkStatueCSSClass)}else{if(true!==this.waitCommandStatus.is_switchover){this.setObjectClassBySyncStatus(Ext.getCmp(this.syncDirectionIconID),e.additional.heartbeat_link_status,this.syncDirectionIconCSSClass);this.setObjectClassBySyncStatus(Ext.getCmp(this.syncDirectionStatusID),e.additional.sync_status,this.syncLinkStatueCSSClass)}}this.setObjectValueBySysStatus(Ext.getCmp(this.statusTitleID),e.status);this.can_failover=e.can_failover;this.can_switchover=e.can_switchover;if(e.can_switchover){Ext.getCmp(this.switchBtnID).enable()}else{Ext.getCmp(this.switchBtnID).disable()}if(e.is_remote_boot_done){Ext.getCmp(this.shutdownClusterBtnID).enable()}else{Ext.getCmp(this.shutdownClusterBtnID).disable()}this.loginIPIsStatic=e.login_ip_is_static;var b=0;if("upgrading"===this.remoteStatus||"switching"===this.remoteStatus||"recovering"===this.remoteStatus||true===this.waitCommandStatus.is_switchover){for(b=0;b<e.additional.descriptions.size();b++){if("desc_passive_offline"===e.additional.descriptions[b].key||"desc_heartbeat_link_lost"===e.additional.descriptions[b].key){e.additional.descriptions.splice(b,1);b--}}}if(0===e.additional.descriptions.size()){e.additional.descriptions[0]={key:"loading"}}var d=false;for(b=0;b<e.additional.descriptions.size();b++){if(this.haStatusKey.key===e.additional.descriptions[b].key){this.haStatusKey=e.additional.descriptions[b];this.currentDescIndex=b;d=true;break}}if(!d&&""!==e.additional.descriptions[0].key){this.haStatusKey=e.additional.descriptions[0];this.currentDescIndex=0}this.descRenderer(this.haStatusKey);this.currentDescList=e.additional.descriptions;if(1<this.currentDescList.size()){Ext.getCmp(this.prevDescBtnID).show();Ext.getCmp(this.nextDescBtnID).show()}else{Ext.getCmp(this.prevDescBtnID).hide();Ext.getCmp(this.nextDescBtnID).hide()}if(this.currentDescList.size()>this.currentDescIndex+1){Ext.getCmp(this.nextDescBtnID).enable()}else{Ext.getCmp(this.nextDescBtnID).disable()}if(0<this.currentDescIndex){Ext.getCmp(this.prevDescBtnID).enable()}else{Ext.getCmp(this.prevDescBtnID).disable()}Ext.getCmp(this.StatusMessageBoxID).doLayout();Ext.getCmp(this.BriefOverviewPanelID).doLayout()}else{if(this.PageReady.waitCommand){this.checkCommandTimeout()}else{this.pollFailed("aha")}}},commandTimeout:function(){if(this.PageReady.waitCommand){this.appWin.clearStatusBusy();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"));this.PageReady.waitCommand=false;this.waitCommandStatus=[]}},checkCommandTimeout:function(){this.waitCommandStatus.timeout=(((new Date()).getTime()-this.PageReady.waitCommandStartTime)/1000);if(300<this.waitCommandStatus.timeout){this.appWin.clearStatusBusy();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"));this.PageReady.waitCommand=false;this.waitCommandStatus=[]}},setNodeInfo:function(b,a){if(true===this.waitCommandStatus.is_switchover||"switching"===a.status){this.setSwitchingNodeInfo(b);return}else{if("upgrading"===a.status){this.setUpgradingNodeInfo(b,a);return}else{if("recovering"===a.status){this.setRecoveringNodeInfo(b,a);return}else{if("boot_error"===a.status){this.setBootErrorNodeInfo(b,a);return}}}}Ext.getCmp(b.role).setValue(this.renderNodeRole(a.role,a.status));if("switching_failed"===a.status){a.status="offline"}SYNO.SDS.Utils.AddTip(Ext.getCmp(b.role).getEl(),"");b.disableSensor=false;Ext.getCmp(b.sn).setValue(this.renderServerDetails(a.sn,a.status));Ext.getCmp(b.fan_status).setValue(this.renderFanStatus(a.additional.fan_status,a.status,a.role));Ext.getCmp(b.thermal).setValue(this.renderThermalStatus(a.additional.thermal,a.status));Ext.getCmp(b.power_status).setValue(this.renderPowerStatus(a.additional.power_status,a.status,a.role));Ext.getCmp(b.memory_size).setValue(this.renderMemorySize(a.additional.memory_size,a.status));this.setObjectClassByDSStatus(Ext.getCmp(b.DS),a.status,this.DSIconCSSClass);this.setObjectClassByDSStatus(Ext.getCmp(b.DSWarning),a.status,this.DSWarningCSSClass);this.setObjectClassByLinkStatus(Ext.getCmp(b.storage_link),a.additional.storage_status,b.storageLinkCSSClass);this.setObjectClassByLinkStatus(Ext.getCmp(b.net_link),a.additional.net_status,b.netLinkCSSClass);this.setObjectClassByLinkStatus(Ext.getCmp(b.storage_warning),a.additional.storage_status,this.linkStatueCSSClass);this.setObjectClassByLinkStatus(Ext.getCmp(b.net_warning),a.additional.net_status,this.linkStatueCSSClass);this.addMachineDetail(b,a);this.addStorageDetail()},setBootErrorNodeInfo:function(a){Ext.getCmp(a.role).setValue(this.renderNodeRole("","boot_error"));SYNO.SDS.Utils.AddTip(Ext.getCmp(a.role).getEl(),"");this.setObjectClassByDSStatus(Ext.getCmp(a.DS),"boot_error",this.DSIconCSSClass);this.setObjectClassByDSStatus(Ext.getCmp(a.DSWarning),"boot_error",this.DSWarningCSSClass);a.disableSensor=true},setSwitchingNodeInfo:function(a){Ext.getCmp(a.role).setValue(this.renderNodeRole("","switching"));SYNO.SDS.Utils.AddTip(Ext.getCmp(a.role).getEl(),"");this.setObjectClassByDSStatus(Ext.getCmp(a.DS),"loading",this.DSIconCSSClass);this.setObjectClassByDSStatus(Ext.getCmp(a.DSWarning),"loading",this.DSWarningCSSClass);a.disableSensor=true},setUpgradingNodeInfo:function(b,a){Ext.getCmp(b.role).setValue(this.renderNodeRole(a.role,a.status));SYNO.SDS.Utils.AddTip(Ext.getCmp(b.role).getEl(),"");this.setObjectClassByLinkStatus(Ext.getCmp(b.storage_link),"none",b.storageLinkCSSClass);this.setObjectClassByLinkStatus(Ext.getCmp(b.net_link),"none",b.netLinkCSSClass);this.setObjectClassByLinkStatus(Ext.getCmp(b.storage_warning),"none",this.linkStatueCSSClass);this.setObjectClassByLinkStatus(Ext.getCmp(b.net_warning),"none",this.linkStatueCSSClass);this.setObjectClassByDSStatus(Ext.getCmp(b.DS),"normal",this.DSIconCSSClass);this.setObjectClassByDSStatus(Ext.getCmp(b.DSWarning),"normal",this.DSWarningCSSClass);b.disableSensor=true},setRecoveringNodeInfo:function(b,a){Ext.getCmp(b.role).setValue(this.renderNodeRole(a.role,a.status));SYNO.SDS.Utils.AddTip(Ext.getCmp(b.role).getEl(),"");this.setObjectClassByLinkStatus(Ext.getCmp(b.storage_link),"none",b.storageLinkCSSClass);this.setObjectClassByLinkStatus(Ext.getCmp(b.net_link),"none",b.netLinkCSSClass);this.setObjectClassByLinkStatus(Ext.getCmp(b.storage_warning),"none",this.linkStatueCSSClass);this.setObjectClassByLinkStatus(Ext.getCmp(b.net_warning),"none",this.linkStatueCSSClass);this.setObjectClassByDSStatus(Ext.getCmp(b.DS),"normal",this.DSIconCSSClass);this.setObjectClassByDSStatus(Ext.getCmp(b.DSWarning),"normal",this.DSWarningCSSClass);b.disableSensor=true},getStringFromRemoteStatus:function(a,b){if(false===this.isRemotePassive){return b}return a},setRemoteLabel:function(){Ext.getCmp(this.shutdownPassiveBtnID).setText(this.getStringFromRemoteStatus(_TT("SYNO.SDS.AHA.Instance","overview","shutdown_passive"),_TT("SYNO.SDS.AHA.Instance","overview","shutdown_remote")));Ext.getCmp(this.rebootPassiveBtnID).setText(this.getStringFromRemoteStatus(_TT("SYNO.SDS.AHA.Instance","overview","reboot_passive"),_TT("SYNO.SDS.AHA.Instance","overview","reboot_remote")))},handleGetAHANodeDone:function(f,d,e,c){if(f){this.pollSuccess();this.PageReady.Node=true;if(this.isPageReady()){this.appWin.clearStatusBusy()}for(var b=0;b<d.total;b++){if("passive"===d.node_infos[b].role){this.isRemotePassive=true}else{if("undefined"===d.node_infos[b].role){this.isRemotePassive=false}}if("active"===d.node_infos[b].role){this.localSN=d.node_infos[b].sn;this.localStatus=d.node_infos[b].status}else{this.remoteSN=d.node_infos[b].sn;this.remoteStatus=d.node_infos[b].status;if("loading"!==this.remoteStatus&&this.waitCommandStatus.switchover_promote_done&&this.waitCommandStatus.is_switchover){this.waitCommandStatus.is_switchover=false;this.waitCommandStatus.switchover_promote_done=false}}if(0===d.node_infos[b].additional.physical_position){this.setNodeInfo(this.lnodeID,d.node_infos[b])}else{if(1===d.node_infos[b].additional.physical_position){this.setNodeInfo(this.rnodeID,d.node_infos[b])}}}this.setRemoteLabel();if(this.PageReady.waitCommand){if(this.waitCommandStatus.rebootActive){if(this.waitCommandStatus.counter){this.appWin.clearStatusBusy();this.waitCommandStatus.activeSN="";this.waitCommandStatus.timeout=0;this.waitCommandStatus.rebootActive=false;this.PageReady=[]}this.waitCommandStatus.counter=true}else{if(this.localSN===this.waitCommandStatus.activeSN&&""!==this.localSN){this.waitCommandStatus.activeSN="";this.waitCommandStatus.timeout=0;if(this.waitCommandStatus.is_switchover){this.waitCommandStatus.switchover_promote_done=true}this.PageReady=[]}else{if((""===this.remoteSN||null===this.remoteSN)&&this.waitCommandStatus.remoteShutdown){this.waitCommandStatus.remoteShutdown=false;if(true!==this.waitCommandStatus.remoteReboot){this.appWin.clearStatusBusy();this.waitCommandStatus.timeout=0;this.PageReady=[]}}else{if(!this.waitCommandStatus.remoteShutdown&&this.waitCommandStatus.remoteReboot&&((""!==this.remoteSN&&null!==this.remoteSN)||"boot_error"===this.remoteStatus)){this.appWin.clearStatusBusy();this.waitCommandStatus.timeout=0;this.PageReady=[];this.waitCommandStatus.remoteReboot=false}else{if(this.waitCommandStatus.remote_is_passive&&this.isRemotePassive){this.appWin.clearStatusBusy();this.waitCommandStatus.remote_is_passive=false;this.waitCommandStatus.timeout=0;this.PageReady=[]}}}}}this.checkCommandTimeout()}if(""===this.remoteSN||null===this.remoteSN){Ext.getCmp(this.shutdownPassiveBtnID).disable();Ext.getCmp(this.rebootPassiveBtnID).disable()}else{Ext.getCmp(this.shutdownPassiveBtnID).enable();Ext.getCmp(this.rebootPassiveBtnID).enable()}if(""===this.localSN){var a=function(){this.sendWebapiForReloadAHANodeInfo()};a.defer(1000,this)}else{if(true!==this.PageReady.waitCommand){this.PageReady.NodeData=true}}}else{if(this.PageReady.waitCommand){this.checkCommandTimeout()}else{this.pollFailed("aha_node")}}},setSwitchingEncInfo:function(a){Ext.getCmp(this.storageID.fan_status).setValue(this.renderFanStatus("loading","",""));Ext.getCmp(this.storageID.power_status).setValue(this.renderPowerStatus("loading","",""))},handleGetAHAEnclosureDone:function(e,c,d,b){if(e){this.pollSuccess();this.PageReady.Enclosure=true;if(this.isPageReady()){this.appWin.clearStatusBusy()}if(!this.isPageDataReady()){this.setSwitchingEncInfo();var a=function(){this.sendWebapiForReloadEncInfo()};a.defer(1000,this);return}Ext.getCmp(this.storageID.fan_status).setValue(this.renderFanStatus(c.fan_status,"",""));Ext.getCmp(this.storageID.power_status).setValue(this.renderPowerStatus(c.power_status,"",""));this.setObjectClassByDSStatus(Ext.getCmp(this.storageID.Warning),c.status,this.DSWarningCSSClass)}else{if(this.PageReady.waitCommand){this.checkCommandTimeout()}else{this.pollFailed("enc")}}},isPageReady:function(){return this.PageReady.AHA&&this.PageReady.Node&&this.PageReady.Enclosure&&(false===this.PageReady.waitCommand||undefined===this.PageReady.waitCommand)},isPageDataReady:function(){return this.PageReady.NodeData},setObjectValueBySysStatus:function(b,a){b.setValue(_TT("SYNO.SDS.AHA.Instance","overview",a))},setObjectClassBySyncStatus:function(c,b,a){this.setObjectClassByStatus(c,b,a,this.syncStatus)},setObjectClassByLinkStatus:function(c,b,a){this.setObjectClassByStatus(c,b,a,this.linkStatus)},setObjectClassByDSStatus:function(c,b,a){this.setObjectClassByStatus(c,b,a,this.DSStatus)},setObjectClassBySysStatus:function(c,b,a){this.setObjectClassByStatus(c,b,a,this.sysStatusIndex)},setObjectClassByStatus:function(e,c,b,a){var d=0;for(d=0;d<a.length;d++){if(a[d]!==c){e.removeClass(b[d])}else{e.addClass(b[d])}}},waitingBox:function(d){var e=d.times||10;var a=e;var b=d.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:d.title||"",msg:d.msg||"",width:d.width||240,progress:true,closable:false});this.PageReady.waitingBox=true;this.startPollingActiveServerDown();var c=function(){a--;if((0===a)||(this.progressFinished)){if(Ext.isFunction(d.callback)){d.callback.call(d.scope||this)}this.progressFinished=false;SYNO.SDS.Desktop.getMsgBox().hide();this.commandTimeout();return}if(0===a){a=e}SYNO.SDS.Desktop.getMsgBox().updateProgress(1-a/e,"");if(this.PageReady.waitingBox){c.defer(b,this)}else{SYNO.SDS.Desktop.getMsgBox().hide()}};c.defer(b,this)},startPollingActiveServerDown:function(){this.sendWebAPI({api:"SYNO.Core.AHA.Node",version:1,method:"get",params:{role:["active"],blocked:false},callback:function(d,b,c,a){if(d){if(this.localSN===b.node_infos[0].sn){this.startPollingActiveServerDown.defer(5000,this)}else{this.startPingpong()}}else{this.startPingpong()}},scope:this})},startPingpong:function(){var a=this.addAjaxTask({preventHalt:true,interval:5000,autoJsonDecode:true,url:"webman/pingpong.cgi",startTime:new Date().getTime(),timeLimit:this.switchover_timeout,scope:this,success:function(b,c){if(b&&b.boot_done){a.stop();window.location.href="/"}},failure:function(c,b){}}).start()},checkMsg:function(f,g,b,i){if(undefined===f||(undefined===f.active&&undefined===f.passive)){return""}var h={};var a={};var e=b||{};var j="";var c="";var d="";a.role=this.getStringFromRemoteStatus("running_task_role_passive","running_task_role_remote");if(i){j="running_task_warning";if(f.active&&f.active.blocking_tasks&&""!==f.active.blocking_tasks){h.str=f.active.blocking_tasks}if(f.passive&&f.passive.blocking_tasks&&""!==f.passive.blocking_tasks){a.str=f.passive.blocking_tasks}}else{j="running_task_confirm";if(f.active&&f.active.running_tasks&&""!==f.active.running_tasks){h.str=f.active.running_tasks}if(f.passive&&f.passive.running_tasks&&""!==f.passive.running_tasks){a.str=f.passive.running_tasks}}if(h.str){d="<ul>"+this.getTasks(this.parseList(h.str,","))+"</ul>";c+=String.format(this._APPSTR("SYNO.SDS.AHA.Instance","overview",j),this._APPSTR("SYNO.SDS.AHA.Instance","overview","running_task_role_active"),this._APPSTR("SYNO.SDS.AHA.Instance","overview","running_task_"+g));c+="<br>"+d}if(a.str){d="<ul>"+this.getTasks(this.parseList(a.str,","))+"</ul>";c+=String.format(this._APPSTR("SYNO.SDS.AHA.Instance","overview",j),this._APPSTR("SYNO.SDS.AHA.Instance","overview",a.role),this._APPSTR("SYNO.SDS.AHA.Instance","overview","running_task_"+g));c+="<br>"+d}if(""!==c){if(i){this.appWin.getMsgBox().alert(_D("product"),c+_T("system","try_later_warning"),function(k){if(Ext.isFunction(e.cancel_callback)){e.cancel_callback.call(e.scope||this)}},this)}else{this.appWin.getMsgBox().confirm(_D("product"),c,function(k){if("yes"===k){if(Ext.isFunction(e.confirm_callback)){e.confirm_callback.call(e.scope||this)}}else{if("no"===k){if(Ext.isFunction(e.cancel_callback)){e.cancel_callback.call(e.scope||this)}}}},this)}}return c},checkBlocking:function(b,a){return this.checkMsg(b,a,{},true)},haltChecker:function(a,c,b){this.appWin.sendWebAPI({api:"SYNO.Core.AHA",version:1,method:c,params:{role:b.role},callback:function(g,e,f,d){if(g){if(undefined===e||(undefined===e.active&&undefined===e.passive)){if(Ext.isFunction(b.success_callback)){b.success_callback.call(b.scope||this)}return}if(""!==this.checkMsg(e,c,b,true)){return}if(""!==this.checkMsg(e,c,b,false)){return}}else{if(Ext.isFunction(b.cancel_callback)){b.cancel_callback.call(b.scope||this)}this.appWin.clearStatusBusy();this.startWebapis();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),_T("error","error_error_system"))}},scope:this})},getTasks:function(f,g,c,e){var b=[];var h;var d;var i=g||"<li>";var a=c||"</li>";var j=e||" ";Ext.each(f,function(k){if(-1===k.indexOf(":")){d=k}else{h=k.split(":");if(2===h.length){d=(0===_T(h[0],h[1]).length)?_JSLIBSTR(h[0],h[1]):_T(h[0],h[1])}else{if(3===h.length){d=this._APPSTR(h[0],h[1],h[2])}else{d=this._APPSTR("SYNO.SDS.AHA.Instance","uicommon","unknown")}}}b.push(i+d+a)},this);return b.join(j)},_APPSTR:function(d,b,a){var c=_TT(d,b,a);if(c){return c}return b+":"+a}});Ext.ns("SYNO.SDS.AHA");SYNO.SDS.AHA.CONF_DEFAULT_WIDTH=990;SYNO.SDS.AHA.CONF_DEFAULT_HEIGHT=580;SYNO.SDS.AHA.ServiceRenderer=function(d){var a=["samba","iscsitrg","ftpd","atalk","nfsd","host_error","volume_crash"];var c=[_T("network","wnds_file_service"),_T("helptoc","iscsitrg_manager"),_T("tree","leaf_ftp"),_T("network","apple_subject"),_T("nfs","nfs_title"),_TT("SYNO.SDS.AHA.Instance","monitor","active_host_failed"),_TT("SYNO.SDS.AHA.Instance","monitor","volume_crash")];var b=0;for(b=0;b<a.length;b++){if(a[b]==d){return c[b]}}};Ext.define("SYNO.SDS.AHA.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(a){var b;b=Ext.apply({activeTab:0,items:a.tabPanels},a);this.callParent([b])}});