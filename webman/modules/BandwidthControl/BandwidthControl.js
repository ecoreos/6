/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.namespace("SYNO.SDS.BandwidthControl");SYNO.SDS.BandwidthControl.Settings_CGIURL="modules/BandwidthControl/bandwidth_settings.cgi";SYNO.SDS.BandwidthControl.ProtocolTitle=function(c,e,a,f,d,b){if(c==="FileStation"){return"File Station"}else{if(c==="WebDAV"){return"WebDAV"}else{if(c==="FTP"){return"FTP"}else{if(c==="NetworkBackup"){return"Rsync"}}}}if(a.data.protocol_ui){if(a.data.protocol_ui.indexOf(":")===-1){return a.data.protocol_ui}else{return SYNO.SDS.Utils.GetLocalizedString(a.data.protocol_ui)}}return c};SYNO.SDS.BandwidthControl.MainWindow=Ext.extend(SYNO.SDS.ModalWindow,{local_user_grid:null,local_group_grid:null,_defaultColumnWidth:100,pageSize:25,constructor:function(a){var d=[];d.push(this.initBandwidthGrid({owner:this,protocol:a.protocol,owner_type:"local_user",tab_title:"bandwidth_local_user_tab_title",itemId:"bandwidth_local_user_tab"}));d.push(this.initBandwidthGrid({owner:this,protocol:a.protocol,owner_type:"local_group",tab_title:"bandwidth_local_group_tab_title",itemId:"bandwidth_local_group_tab"}));d.push(this.initBandwidthGrid({owner:this,protocol:a.protocol,owner_type:"domain_user",tab_title:"bandwidth_domain_user_tab_title",itemId:"bandwidth_domain_user_tab"}));d.push(this.initBandwidthGrid({owner:this,protocol:a.protocol,owner_type:"domain_group",tab_title:"bandwidth_domain_group_tab_title",itemId:"bandwidth_domain_group_tab"}));d.push(this.initBandwidthGrid({owner:this,protocol:a.protocol,owner_type:"ldap_user",tab_title:"bandwidth_ldap_user_tab_title",itemId:"bandwidth_ldap_user_tab"}));d.push(this.initBandwidthGrid({owner:this,protocol:a.protocol,owner_type:"ldap_group",tab_title:"bandwidth_ldap_group_tab_title",itemId:"bandwidth_ldap_group_tab"}));var c=new SYNO.ux.TabPanel({plain:true,activeTab:0,items:d});this.tabPanel=c;SYNO.SDS.BandwidthControl.MainWindow.superclass.constructor.call(this,Ext.apply({title:_T("bandwidth","bandwidth_settings"),autoDestroy:true,width:820,height:500,border:false,plain:true,layout:"fit",items:[c],buttons:[{btnStyle:"blue",text:_T("common","commit"),disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",scope:this,handler:this.onApply},{text:_T("common","cancel"),scope:this,handler:this.close}]},a));this.tabPanel.hideTabStripItem("bandwidth_domain_user_tab");this.tabPanel.hideTabStripItem("bandwidth_domain_group_tab");this.tabPanel.hideTabStripItem("bandwidth_ldap_user_tab");this.tabPanel.hideTabStripItem("bandwidth_ldap_group_tab");var b=[{api:"SYNO.Core.Directory.Domain",method:"get",version:1},{api:"SYNO.Core.Directory.Domain",method:"test_dc",version:1},{api:"SYNO.Core.Directory.LDAP",method:"get",version:1}];this.sendWebAPI({params:{},compound:{stopwhenerror:false,params:b},scope:this,callback:function(h,g,f){if(this.isDestroyed){return}var e=g.result;if(!h||g.has_fail){return}if(e[0].data.enable_domain&&e[1].data.test_join_success){this.tabPanel.unhideTabStripItem("bandwidth_domain_user_tab");this.tabPanel.unhideTabStripItem("bandwidth_domain_group_tab")}if(e[2].data.enable_client){this.tabPanel.unhideTabStripItem("bandwidth_ldap_user_tab");this.tabPanel.unhideTabStripItem("bandwidth_ldap_group_tab")}}})},checkDirty:function(){for(var a=0;a<this.tabPanel.items.items.length;++a){if(0<this.tabPanel.items.items[a].getStore().getModifiedRecords().length){return true}}return false},onApply:function(){if(!this.checkDirty()){this.close();return}this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.BandwidthControl",method:"set",version:1,params:this.serializeApplyData(),callback:this.applyDone,scope:this})},onBeforeStoreLoad:function(a,b){this.setStatusBusy();a.getModifiedRecords();if(0>=a.getModifiedRecords().length){return true}this.clearStatusBusy();var d=_T("share","share_save_chg_before_reload");var c=function(e){if(e==="yes"){this.saveBandwidthSetting(a,b)}else{a.rejectChanges();a.load(b)}};this.getMsgBox().confirm(this.title,d,c,this);return false},onStoreLoad:function(){this.clearStatusBusy()},saveBandwidthSetting:function(c,d){var b;var a=function(f){this.getMsgBox().alert(this.title,f)};var e=function(i,g,f){this.clearStatusBusy();var h=SYNO.SDS.CPUtils.reportAjaxResponse(i,b,a,this);if(h&&h.success){c.commitChanges();c.load(d)}};this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.BandwidthControl",method:"set",version:1,params:this.serializeApplyData(),callback:e,scope:this})},serializeApplyData:function(){var b=[];var c=function(e){b.push(e.data)};for(var a=0;a<this.tabPanel.items.items.length;++a){if(0<this.tabPanel.items.items[a].getStore().getModifiedRecords().length){Ext.each(this.tabPanel.items.items[a].getStore().getModifiedRecords(),c)}}var d={bandwidths:b};return d},applyDone:function(c,b,a){this.clearStatusBusy();this.close()},initBandwidthGrid:function(b){var a=function(q,p,r,s,o,n){if(r.get("policy")==="scheduled"){p.attr='style="color:#aaaaaa;"'}return q};var i=new SYNO.ux.NumberField({allowBlank:false,allowNegative:false,allowDecimals:false,validationEvent:"keyup",maxLength:9,validateOnBlur:true});var k=[];k.push({header:_T("bandwidth","bandwidth_account_name"),dataIndex:"name",align:"left",sortable:true});if("user"===b.owner_type.split("_")[1]){k.push({header:_T("bandwidth","bandwidth_preview")+" (UL/DL)",dataIndex:"preview",align:"center",renderer:function(r,q,n,s,p,o){a(r,q,n,s,p,o);return n.data.upload_result+"/"+n.data.download_result}})}k.push({header:_T("bandwidth","bandwidth_up_rate")+" (KB/s)",dataIndex:"upload_limit_1",align:"center",editor:i,renderer:a});k.push({header:_T("bandwidth","bandwidth_down_rate")+" (KB/s)",dataIndex:"download_limit_1",align:"center",editor:i,renderer:a});var e=new SYNO.API.JsonStore({api:"SYNO.Core.BandwidthControl",method:"list",version:1,baseParams:{protocol:b.protocol,owner_type:b.owner_type,offset:0,limit:this.pageSize},fields:["name","protocol","owner_type","policy","schedule_plan","upload_result","upload_limit_1","upload_limit_2","download_result","download_limit_1","download_limit_2"],root:"bandwidths",sortInfo:{field:"name",direction:"ASC"},totalProperty:"total",remoteSort:false,appWindow:this,listeners:{scope:this,beforeload:this.onBeforeStoreLoad,load:this.onStoreLoad}});var h=_T("bandwidth","mode_disable");if("user"===b.owner_type.split("_")[1]){h=_T("bandwidth","mode_disable_user")}var c=new Ext.data.ArrayStore({fields:["display","value"],data:[[h,"disabled"],[_T("bandwidth","mode_enable"),"enabled"],[_T("bandwidth","mode_schedule"),"scheduled"]],autoDestroy:true});k.push({header:_T("bandwidth","mode"),dataIndex:"policy",align:"center",renderer:function(n){if(n==="disabled"||n==="notexist"){return h}if(n==="enabled"){return _T("bandwidth","mode_enable")}if(n==="scheduled"){return _T("bandwidth","mode_schedule")}return n},editor:new SYNO.ux.ComboBox({name:"modeSelect",hiddenName:"modeSelect",typeAhead:true,triggerAction:"all",displayField:"display",valueField:"value",hideLabel:true,id:Ext.id(),editable:false,forceSelection:true,valueNotFoundText:h,store:c,mode:"local"})});k.push({dataIndex:"schedule_plan",align:"center",hidden:true});k.push({dataIndex:"upload_limit_2",align:"center",hidden:true});k.push({dataIndex:"download_limit_2",align:"center",hidden:true});var j=new Ext.grid.ColumnModel(k);j.isCellEditable=function(o,q){var p=e.getAt(q);var n="user"===b.owner_type.split("_")[1]?4:3;if("scheduled"==p.get("policy")&&o!=n){return false}return Ext.grid.ColumnModel.prototype.isCellEditable.call(this,o,q)};var f=new SYNO.ux.Toolbar();var g=_T("bandwidth","schedule_plan_group");if("user"===b.owner_type.split("_")[1]){g=_T("bandwidth","schedule_plan_user")}var m=new SYNO.ux.Button({name:"schedulePlanBtn",text:g,disabled:true,tabIndex:-1,scope:this,handler:function(){var p;p=this.tabPanel.getActiveTab().selModel.getSelected();if(typeof p==="undefined"){return}if(typeof p.data.schedule_plan==="undefined"||p.data.schedule_plan===""){p.data.schedule_plan="111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"}if(typeof p.data.upload_limit_2==="undefined"||p.data.upload_limit_2===""){p.data.upload_limit_2=0}if(typeof p.data.download_limit_2==="undefined"||p.data.download_limit_2===""){p.data.download_limit_2=0}var o={scheduleField:p.data.schedule_plan,defUpRate:p.data.upload_limit_1,defDownRate:p.data.download_limit_1,cusUpRate:p.data.upload_limit_2,cusDownRate:p.data.download_limit_2};var n=new SYNO.SDS.BandwidthControl.SchedulePlanWin({owner:this,winType:"user",blUser:"user"===b.owner_type.split("_")[1]?true:false,scheduleConfig:o,listeners:{scope:this,beforeclose:function(){p.set("schedule_plan",o.scheduleField);p.set("upload_limit_1",o.defUpRate);p.set("download_limit_1",o.defDownRate);p.set("upload_limit_2",o.cusUpRate);p.set("download_limit_2",o.cusDownRate)}}});n.open()}});var l=new SYNO.ux.TextFilter({emptyText:_T("connections","search_connections"),store:e,pageSize:this.pageSize});f.add(m,"->",l);var d={title:_T("bandwidth",b.tab_title),cm:j,ds:e,enableHdMenu:false,enableColumnMove:false,clicksToEdit:1,selModel:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{selectionchange:{fn:function(n){if(n.getCount()>0){m.enable(false)}else{m.disable(false)}},scope:this}}}),listeners:{afterrender:function(){this.getStore().load()}},tbar:f,bbar:new SYNO.ux.PagingToolbar({store:e,pageSize:this.pageSize,displayInfo:true})};Ext.apply(d,b);return new SYNO.ux.EditorGridPanel(d)}});Ext.namespace("SYNO.SDS.BandwidthControl");Ext.define("SYNO.SDS.BandwidthControl.Status",{extend:"SYNO.ux.GridPanel",itemsPerPage:50,multipleSort:false,constructor:function(a){this.appWin=a.appWin;this.appInst=a.appWin.appInstance;var b=Ext.apply({store:this.getStatusStore(),colModel:this.getStatusCM(),tbar:this.getTBar(),bbar:this.getBBar(),sm:new Ext.grid.RowSelectionModel({listeners:{selectionchange:{fn:this.updateToolBarBts,scope:this,buffer:80}}}),listeners:{scope:this,activate:this.onActivate,deactivate:this.onDeactivate,rowcontextmenu:this.showGridCtxMenu,sortchange:this.onGridSortChanged,headermousedown:this.onGridHeaderMouseDown}},a);return this.callParent([b])},getTBar:function(){this.searchField=new SYNO.ux.TextFilter({emptyText:_T("connections","search_connections"),store:this.getStatusStore(),pageSize:this.itemsPerPage,disabled:true});var a=new SYNO.ux.Toolbar({items:[{text:_T("log","log_reload"),itemId:"bt_refresh",disabled:true,handler:function(){this.getEl().mask(_T("common","msg_waiting"),"x-mask-loading");this.pagingToolBar.doRefresh()},scope:this},{text:_T("connections","kick_connection_br"),itemId:"bt_kick1",disabled:true,handler:this.kickConnection,scope:this},"->",this.searchField]});return a},getBBar:function(){if(this.pagingToolBar){return this.pagingToolBar}var a=new SYNO.ux.PagingToolbar({store:this.getStatusStore(),displayInfo:true,pageSize:this.itemsPerPage,refreshText:_T("log","log_reload")});this.pagingToolBar=a;return a},onActivate:function(d){if(this.appWin.hasOpenConfig("is_cms_open")||(d&&d.targetReady)){var c=this.appWin.getTargetData();if(0>c.id){return}else{if("localhost"===c.target_type){this.appWin.openConfig.cms_id=undefined}else{if("client"===c.target_type){this.appWin.openConfig.cms_id=c.id}}}}var b=this.getTopToolbar(),a=this.getStore();this.getEl().mask(_T("common","msg_waiting"),"x-mask-loading");a.removeAll();a.load();this.getUpdateTask().stop();this.getUpdateTask().start();b.getComponent("bt_refresh").enable();this.searchField.enable()},onDeactivate:function(){var a=this.getUpdateTask();if(a){a.stop()}},onGridHeaderMouseDown:function(a,b,c){if(b===0){this.multipleSort=true}},onGridSortChanged:function(b,a){if(!a||!a.field||a.field!=="protocol"){b.store._multiSortInfo=undefined;return}if(!this.multipleSort){return}this.multipleSort=false;var c=[{field:"protocol_desc",direction:a.direction},{field:"transfer_type",direction:"DESC"}];b.store.sort(c,"ASC");b.store._multiSortInfo=c},refresh:function(){this.pagingToolBar.doRefresh()},getUpdateTask:function(){this.updateTask=this.updateTask||this.addTask({id:"task_update_status",interval:10*1000,run:this.refresh,scope:this});return this.updateTask},onChangeItemsPerPage:function(d,c,a){var b=this.itemsPerPageComb.getValue();if(b!=this.itemsPerPage){this.itemsPerPage=b;this.pagingToolBar.pageSize=b;this.searchField.pageSize=b;this.pagingToolBar.moveFirst();this.appInst.setUserSettings("bwstatusItemsPage",this.itemsPerPage)}},getStatusStore:function(){if(this.store){return this.store}var a=new SYNO.API.Store({autoLoad:false,api:"SYNO.Core.BandwidthControl.Status",method:"list",version:1,appWindow:this.appWin,baseParams:{offset:0,limit:this.itemsPerPage},reader:new Ext.data.JsonReader({root:"status",totalProperty:"total"},["pid","protocol","owner_type","name","transfer_type","filename","speed","speed_limit","progress","protocol_desc"]),sortInfo:{field:"owner_type",direction:"DESC"},listeners:{scope:this,load:function(c,b,d){Ext.each(b,function(e){var g=e.get("protocol");var f=this.getProtocolDesc(g);e.set("protocol_desc",f)},this);c.commitChanges();if(c._multiSortInfo){c.sort(c._multiSortInfo,"ASC")}this.getEl().unmask()}},remoteSort:false});this.store=a;this.appWin.addManagedComponent(a);return a},getStatusCM:function(){if(this.cm){return this.cm}var a=new Ext.grid.ColumnModel({columns:[{header:_T("bandwidth","bandwidth_protocol"),dataIndex:"protocol",width:150,renderer:this.protocolRender,align:"left",scope:this},{header:_T("bandwidth","bandwidth_owner_type"),dataIndex:"owner_type",width:10,align:"left",hidden:true},{header:_T("bandwidth","bandwidth_account_name"),dataIndex:"name",width:120,renderer:this.accountNameRender,align:"left"},{header:_T("bandwidth","bandwidth_transfer_type"),dataIndex:"transfer_type",width:10,align:"center",hidden:true},{header:_T("bandwidth","bandwidth_filename"),dataIndex:"filename",width:120,renderer:this.htmlEncodeRender,align:"left"},{header:_T("bandwidth","bandwidth_transfer_speed")+" (KB/s)",dataIndex:"speed",width:100,align:"center"},{header:_T("bandwidth","bandwidth_transfer_speed_limit")+" (KB/s)",dataIndex:"speed_limit",width:100,align:"center"},{header:_T("bandwidth","bandwidth_progress")+" (%)",dataIndex:"progress",width:100,align:"center"}],defaults:{sortable:true,menuDisabled:true}});this.cm=a;return a},getProtocolDesc:function(a){var b;if(a==="FileStation"){b="File Station"}else{if(a==="WebDAV"){b="WebDAV"}else{if(a==="FTP"){b="FTP"}else{if(a==="NetworkBackup"){b="Rsync"}else{b="Unknown"}}}}return b},protocolRender:function(b,a,f){var d=f.get("transfer_type");var e=this.getProtocolDesc(b);var c;if("upload"===d){c='<img src="webman/modules/BandwidthControl/images/default/1x/icon_upload_queue.png" />'}else{c='<img src="webman/modules/BandwidthControl/images/default/1x/icon_download_queue.png" />'}return c+" "+e},htmlEncodeRender:function(d,b,c){var a=Ext.util.Format.htmlEncode(d);b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(a)+'"';return a},accountNameRender:function(e,a,d){var b=d.get("owner_type");var c;if("user"===b){c='<img src="webman/modules/BandwidthControl/images/default/1x/User.png" />'}else{c='<img src="webman/modules/BandwidthControl/images/default/1x/Group.png" />'}return c+" "+e},showGridCtxMenu:function(a,d,b){b.preventDefault();var c=a.getSelectionModel();if(!c.isSelected(d)){c.selectRow(d)}this.getGridCtxMenu().showAt(b.getXY())},getGridCtxMenu:function(){if(!this.BWStatusRowCtxMenu){this.BWStatusRowCtxMenu=new SYNO.ux.Menu({ignoreParentClicks:true,items:[{itemId:"kick_conn1",text:_T("connections","kick_connection"),handler:this.kickConnection,scope:this}]});this.appWin.addManagedComponent(this.BWStatusRowCtxMenu)}return this.BWStatusRowCtxMenu},kickConnection:function(){var d=this.getSelectionModel();var b=d.getSelections();if(0===b.length){return}var c=[];for(var a=0;a<b.length;++a){if("-"===b[a].get("pid")){continue}c.push({pid:b[a].get("pid"),name:b[a].get("name"),transfer_type:b[a].get("transfer_type")})}this.doKickConnection(c)},doKickConnection:function(a){this.getEl().mask(_T("common","msg_waiting"),"x-mask-loading");this.kick_ajax=this.appWin.sendWebAPI({api:"SYNO.Core.BandwidthControl.Status",method:"delete",version:1,single:true,timeout:450000,params:{pid:a},scope:this,callback:function(d,c,b){this.getEl().unmask();if(!d){}this.pagingToolBar.doRefresh();this.kick_ajax=null}})},updateToolBarBts:function(f){var a=0;var c=f.getSelections();var e=this.getTopToolbar();var d=e.getComponent("bt_kick1");var b=this.getGridCtxMenu().get("kick_conn1");if(0===c.length||_S("demo_mode")){d.disable();b.disable();return}for(a=0;a<c.length;++a){if("group"===c[a].get("owner_type")){break}}if(a>=c.length){d.enable();b.enable()}else{d.disable();b.disable()}}});Ext.namespace("SYNO.SDS.BandwidthControl");SYNO.SDS.BandwidthControl.ScheduleSelector=function(f){f=f||{};var i,h,k;var d,j,l=new Ext.lib.Region(0,0,0,0);var b=f.dragSafe===true;this.init=function(p){i=p;i.on("render",o)};function m(){d=[];i.all.each(function(p){d[d.length]=p.getRegion()});j=i.el.getRegion()}function e(){return false}function g(p){return !b||p.target==i.el.dom}function n(p){i.on("containerclick",e,i,{single:true});if(!h){h=i.el.createChild({cls:"x-view-selector"});h.setDisplayed(false)}else{if(h.dom.parentNode!==i.el.dom){i.el.dom.appendChild(h.dom)}}m();i.clearSelections()}function c(v){var z=k.startXY;var D=k.getXY();var B=Math.min(z[0],D[0]);var A=Math.min(z[1],D[1]);var C=Math.abs(z[0]-D[0]);var t=Math.abs(z[1]-D[1]);l.left=B;l.top=A;l.right=B+C;l.bottom=A+t;l.constrainTo(j);h.setRegion(l);for(var s=0,u=d.length;s<u;s++){var p=d[s],q=l.intersect(p);if(q&&!p.selected){p.selected=true;i.select(s,true)}else{if(!q&&p.selected){p.selected=false;i.deselect(s)}}}}function a(p){if(!Ext.isIE){i.un("containerclick",e,i)}if(h){h.setDisplayed(false)}if(i.ownerCt&&i.ownerCt.selectRecords){i.ownerCt.selectRecords(i,d)}}function o(p){k=new Ext.dd.DragTracker({onBeforeStart:g,onStart:n,onDrag:c,onEnd:a});k.initEl(p.el)}};SYNO.SDS.BandwidthControl.ScheduleTable=Ext.extend(Ext.Panel,{CLASS_LIST:["syno-sds-bw2-schedule-td-no-download","syno-sds-bw2-schedule-td-full-speed","syno-sds-bw2-schedule-td-alt-speed"],DAY_STRING_SHORT:[_T("schedule","dayabbre_sun"),_T("schedule","dayabbre_mon"),_T("schedule","dayabbre_tue"),_T("schedule","dayabbre_wed"),_T("schedule","dayabbre_thu"),_T("schedule","dayabbre_fri"),_T("schedule","dayabbre_sat")],constructor:function(a){this.idCount=0;this.currentSpeed="0";this.currentSchedule=[];this.defaultSchedule=[];this.rateId=[];this.rate=[];this.winType=a.winType;for(var c=0;c<24;c++){this.currentSchedule[c]="0"}for(c=0;c<24*7;c++){this.defaultSchedule[c]="1"}var b={cls:"syno-dl-schedule-panel",border:false,width:"100%",layout:"anchor",autoFlexcroll:true,items:this.getItemConfig(a),listeners:a.listeners};Ext.apply(b,a);SYNO.SDS.BandwidthControl.ScheduleTable.superclass.constructor.call(this,b)},initComponent:function(){SYNO.SDS.BandwidthControl.ScheduleTable.superclass.initComponent.call(this);this.addEvents("beforecellchange")},getItemConfig:function(a){this.upperPanel=this.getUpperPanelConfig(a);this.dataView=this.createDataView();return[this.upperPanel,this.dataView]},getUpperPanelConfig:function(a){var d=a.buttons||[];if("service"===a.winType){d.push({label:_T("bandwidth","disable_limit")});d.push({label:_T("bandwidth","bandwidth_enable")})}else{if("user"===a.winType){if(a.blUser){d.push({label:_T("bandwidth","disable_limit_user")})}else{d.push({label:_T("bandwidth","disable_limit_group")})}d.push({label:_T("bandwidth","limit_default")});d.push({label:_T("bandwidth","limit_customize")})}}var e=[];for(var c=0;c<3;c++){e=e.concat(this.getSingleBtnConfig(d[c]||{},c))}var b={xtype:"syno_fieldset",items:[{xtype:"syno_compositefield",cls:"syno-sds-bw2-schedule-btn-compositefield",hideLabel:true,items:e}]};if(false===a.showButtonOnTop){b.items=this.getAdditionalItems(a).concat(b.items)}else{b.items=b.items.concat(this.getAdditionalItems(a))}return b},getSingleBtnConfig:function(b,a){return[{xtype:"button",itemId:a.toString(),pressed:0===a,cls:"syno-sds-bw2-schedule-btn",iconCls:this.getBtnIconCls(a),scope:b.scope||this,handler:b.handler||this.onSpeedButtonClick,hidden:b.hidden||Ext.isEmpty(b.label),disabled:b.disabled||false,text:" "},{xtype:"syno_displayfield",hidden:b.hidden||Ext.isEmpty(b.label),value:b.label}]},getBtnIconCls:function(a){var b="syno-sds-bw2-schedule-btn-";if(0===a){b+="no-download"}else{if(1===a){b+="full-speed"}else{if(2===a){b+="alt-speed"}}}return b},getAdditionalItems:function(a){var b=[];if("user"===this.winType){b=[{xtype:"syno_displayfield",style:"font-weight: bold;",value:_T("bandwidth","limit_default_setting")},{xtype:"syno_compositefield",width:400,labelWidth:190,indent:1,fieldLabel:_T("bandwidth","limit_upload_rate"),items:[{xtype:"syno_numberfield",id:this.rateId[this.idCount++]=Ext.id(),maxlength:9,width:100},{xtype:"syno_displayfield",value:_T("bandwidth","speed_unit")+" ("+_T("bandwidth","limit_desc_0KB")+")",width:300}]},{xtype:"syno_compositefield",width:400,labelWidth:190,indent:1,fieldLabel:_T("bandwidth","limit_download_rate"),items:[{xtype:"syno_numberfield",id:this.rateId[this.idCount++]=Ext.id(),maxlength:9,width:100},{xtype:"syno_displayfield",value:_T("bandwidth","speed_unit")+" ("+_T("bandwidth","limit_desc_0KB")+")",width:300}]},{xtype:"syno_displayfield",style:"font-weight: bold;",value:_T("bandwidth","limit_customize_setting")},{xtype:"syno_compositefield",width:400,labelWidth:190,indent:1,fieldLabel:_T("bandwidth","limit_upload_rate"),items:[{xtype:"syno_numberfield",id:this.rateId[this.idCount++]=Ext.id(),maxlength:9,width:100},{xtype:"syno_displayfield",value:_T("bandwidth","speed_unit")+" ("+_T("bandwidth","limit_desc_0KB")+")",width:300}]},{xtype:"syno_compositefield",width:400,labelWidth:190,indent:1,fieldLabel:_T("bandwidth","limit_download_rate"),items:[{xtype:"syno_numberfield",id:this.rateId[this.idCount++]=Ext.id(),maxlength:9,width:100},{xtype:"syno_displayfield",value:_T("bandwidth","speed_unit")+" ("+_T("bandwidth","limit_desc_0KB")+")",width:300}]}]}b=!Ext.isEmpty(a.customizeItems)?a.customizeItems:b;return b},createDataView:function(){var a=new Ext.DataView({store:this.DAY_STRING_SHORT,multiSelect:true,itemSelector:"td.syno-sds-bw2-schedule-td",tpl:this.createTemplate(),plugins:[new SYNO.SDS.BandwidthControl.ScheduleSelector()],listeners:{scope:this,click:function(f,c,d,b){var e=this.getSpeed();this.setClassToNodeByIndex(c,e);f.deselect(d)},afterrender:function(b){b.days=new Ext.CompositeElementLite();b.hours=new Ext.CompositeElementLite();b.selectAll=new Ext.CompositeElementLite();b.days.fill(Ext.query("td.syno-sds-bw2-schedule-day-td",b.el.dom));b.hours.fill(Ext.query("td.syno-sds-bw2-schedule-hour-td",b.el.dom));b.selectAll.fill(Ext.query("td.syno-sds-bw2-schedule-select-all-td",b.el.dom));Ext.each(b.days.elements,function(f,c,d){var e=Ext.fly(f);this.mon(e,"click",this.onDayClick,this,{index:c});this.mon(e,"mouseenter",this.onDayMouseEnter,this,{index:c});this.mon(e,"mouseleave",this.onDayMouseLeave,this,{index:c})},this);Ext.each(b.hours.elements,function(f,c,d){var e=Ext.fly(f);this.mon(e,"click",this.onHourClick,this,{index:c});this.mon(e,"mouseenter",this.onHourMouseEnter,this,{index:c});this.mon(e,"mouseleave",this.onHourMouseLeave,this,{index:c})},this);Ext.each(b.selectAll.elements,function(f,c,d){var e=Ext.fly(f);this.mon(e,"click",this.onSelectAllClick,this);this.mon(e,"mouseenter",this.onSelectAllMouseEnter,this);this.mon(e,"mouseleave",this.onSelectAllMouseLeave,this)},this)},beforedestroy:function(b){b.days.clear();b.hours.clear();b.selectAll.clear()}}});return a},createTemplate:function(){var c;var f=[];var e='<td class="syno-sds-bw2-schedule-hour-td">{0}</td>';f.push("<tr>");f.push('<td class="syno-sds-bw2-schedule-select-all-td"></td>');for(c=0;c<24;c++){f.push(String.format(e,c))}f.push("</tr>");var a=f.join("\n");f=[];var b='<td class="syno-sds-bw2-schedule-td"></td>';f.push('<tr class="syno-sds-bw2-schedule-tr">');f.push('<td class="syno-sds-bw2-schedule-day-td">{field1}</td>');for(c=0;c<24;c++){f.push(b)}f.push("</tr>");var g=f.join("\n");var d=new Ext.XTemplate('<table class="syno-sds-bw2-schedule-table">',a,'<tpl for=".">',g,"</tpl>","<table>");return d},onSpeedButtonClick:function(b,a){if(b.pressed){return}var c=b.ownerCt.get(this.getSpeed());c.toggle(false);b.toggle(true);this.currentSpeed=b.itemId},getIndexesByDay:function(a){var c=[],b,e=a*24;for(var d=0;d<24;d++){b=e+d;c.push(b)}return c},onDayClick:function(a,c,d){var b=this.getSpeed();if(!d||!Ext.isNumber(d.index)){return}Ext.each(this.getIndexesByDay(d.index),function(g,e,f){this.setClassToNodeByIndex(g,b)},this)},onDayMouseEnter:function(a,b,c){if(!c||!Ext.isNumber(c.index)){return}Ext.fly(b).addClass("syno-sds-bw2-schedule-day-td-over");this.dataView.select(this.getIndexesByDay(c.index))},onDayMouseLeave:function(a,b,c){Ext.fly(b).removeClass("syno-sds-bw2-schedule-day-td-over");this.dataView.clearSelections()},getIndexesByHour:function(a){var c=[],b;for(var d=0;d<7;d++){b=a+(d*24);c.push(b)}return c},onHourClick:function(a,c,d){var b=this.getSpeed();if(!d||!Ext.isNumber(d.index)){return}Ext.each(this.getIndexesByHour(d.index),function(g,e,f){this.setClassToNodeByIndex(g,b)},this)},onHourMouseEnter:function(a,b,c){if(!c||!Ext.isNumber(c.index)){return}Ext.fly(b).addClass("syno-sds-bw2-schedule-hour-td-over");this.dataView.select(this.getIndexesByHour(c.index))},onHourMouseLeave:function(a,b,c){Ext.fly(b).removeClass("syno-sds-bw2-schedule-hour-td-over");this.dataView.clearSelections()},onSelectAllClick:function(b,f,g){var c=[],e=this.getSpeed(),d,a;for(d=0,a=7*24;d<a;d++){c.push(d)}Ext.each(c,function(j,h,i){this.setClassToNodeByIndex(j,e)},this)},onSelectAllMouseEnter:function(a,b,c){Ext.fly(b).addClass("syno-sds-bw2-schedule-select-all-td-over")},onSelectAllMouseLeave:function(a,b,c){Ext.fly(b).removeClass("syno-sds-bw2-schedule-select-all-td-over")},getSpeed:function(){return this.currentSpeed},selectRecords:function(b,c){var f;var e=this.getSpeed();for(var d=0,a=c.length;d<a;d++){f=c[d];if(f.selected){this.setClassToNodeByIndex(d,e)}}b.clearSelections()},setSchedule:function(b){var a=b.split("");if(a.length!==this.dataView.getNodes().length){SYNO.Debug("error! schedule is not the same to element. array length:",a.length,", view size:",this.dataView.getNodes().length);return}Ext.each(a,function(e,c,d){this.setClassToNodeByIndex(c,e)},this)},getSchedule:function(){return this.currentSchedule.join("")},setRate:function(b){for(var a=0;a<this.idCount;a++){Ext.getCmp(this.rateId[a]).setValue(this.rate[a])}},getRate:function(){for(var a=0;a<this.idCount;a++){this.rate[a]=Ext.getCmp(this.rateId[a]).getValue()}},isValid:function(){var a=true;for(var b=0;b<this.idCount;b++){if(!Ext.getCmp(this.rateId[b]).isValid()){a=false}}return a},isDirty:function(){var a=true;for(var b=0;b<this.idCount;b++){if(!Ext.getCmp(this.rateId[b]).isDirty()){a=false}}return a},setClassToNodeByIndex:function(a,b){var c=Ext.fly(this.dataView.getNode(a));if(false===this.fireEvent("beforecellchange",this,a,b,this.currentSchedule[a])){return}c.removeClass(this.CLASS_LIST);c.addClass(this.CLASS_LIST[b]);this.currentSchedule[a]=b}});SYNO.SDS.BandwidthControl.SchedulePlanSetValue=function(b,a){if(typeof a.data.schedule_plan!="undefined"){b.findField("schedule_plan").setValue(a.data.schedule_plan)}};SYNO.SDS.BandwidthControl.SchedulePanelConfig=function(c,e){var d="";if(e=="FileStation"){d=_T("bandwidth","protocol_desc_file_station")}else{if(e=="WebDAV"){d=_T("bandwidth","protocol_desc_webdav")}else{if(e=="FTP"){d=_T("bandwidth","protocol_desc_ftp")}else{if(e=="NetworkBackup"){d=_T("bandwidth","protocol_desc_rsync")}}}}var b=function(f){Ext.getCmp(c.BandwidthSettingBtnId).setDisabled(!f)};c.bandwidthSettingEnable=function(f){Ext.getCmp(c.bandwidth_desc).setDisabled(!f);Ext.getCmp(c.bandwidth_disable).setDisabled(!f);Ext.getCmp(c.bandwidth_enable).setDisabled(!f);Ext.getCmp(c.bandwidth_schedule).setDisabled(!f);if(Ext.getCmp(c.bandwidth_disable).checked){b(false)}};var a={xtype:"panel",layout:"form",border:false,webapi:{api:"SYNO.Core.BandwidthControl.Protocol",methods:{get:"get",set:"set"},params:{get:{protocol:e},set:{protocol:e}},version:1},listeners:{scope:this,afterlayout:function(){var f;f=new SYNO.ux.Utils.EnableRadioGroup(c.getScheduleForm(),e+"_policy",{scheduled:[c.BandwidthSettingScheduleBtn]})}},items:[{xtype:"syno_displayfield",id:c.bandwidth_desc=Ext.id(),value:d},{xtype:"syno_radio",name:e+"_policy",id:c.bandwidth_disable=Ext.id(),inputValue:"disabled",boxLabel:_T("bandwidth","disable_limit_option"),listeners:{check:function(g,f){b(!f)},enable:function(){b(true)},disable:function(){b(false)}}},{xtype:"syno_radio",name:e+"_policy",id:c.bandwidth_enable=Ext.id(),inputValue:"enabled",boxLabel:_T("bandwidth","enable_limit")},{xtype:"syno_compositefield",hideLabel:true,items:[{xtype:"syno_radio",name:e+"_policy",id:c.bandwidth_schedule=Ext.id(),inputValue:"scheduled",boxLabel:_T("bandwidth","schedule_limit"),scope:c,handler:function(g,f){if(f){var h=Ext.getCmp(this.schedule_plan);if(h.getValue()===""){h.setValue("111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111")}}}},{xtype:"syno_button",id:c.BandwidthSettingScheduleBtn=Ext.id(),cls:"syno-sds-set-schedule",indent:1,tabIndex:-1,text:_T("bandwidth","schedule_plan"),scope:this,handler:SYNO.SDS.BandwidthControl.SchedulePlanWinOpen.createDelegate(c,["service"])}]},{xtype:"syno_button",id:c.BandwidthSettingBtnId=Ext.id(),name:"bandwidth_user_btn",text:_T("bandwidth","bandwidth_brief_desc"),scope:this,handler:function(){var f=new SYNO.SDS.BandwidthControl.MainWindow({owner:c.findWindow(),protocol:e});f.open()}},{xtype:"hidden",name:e+"_schedule_plan",id:c.schedule_plan=Ext.id()}]};return a};SYNO.SDS.BandwidthControl.SchedulePlanWinOpen=function(c,e,a){var d;if(c==="service"){d={scheduleField:Ext.getCmp(this.schedule_plan).getValue()}}else{d={scheduleField:e.data.schedule_plan,defUpRate:e.data.upload_limit_1,defDownRate:e.data.download_limit_1,cusUpRate:e.data.upload_limit_2,cusDownRate:e.data.download_limit_2}}var b=new SYNO.SDS.BandwidthControl.SchedulePlanWin({owner:this.findWindow(),winType:c,blUser:a,scheduleConfig:d,listeners:{scope:this,beforeclose:function(){if(c==="service"){Ext.getCmp(this.schedule_plan).setValue(d.scheduleField)}else{e.set("schedule_plan",d.scheduleField);e.set("upload_limit_1",d.defUpRate);e.set("download_limit_1",d.defDownRate);e.set("upload_limit_2",d.cusUpRate);e.set("download_limit_2",d.cusDownRate)}}}});b.open()};SYNO.SDS.BandwidthControl.SchedulePlanWin=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(a){Ext.apply(this,a||{});this.scheduleConfig=a.scheduleConfig;this.winType=a.winType;this.scheduleTable=new SYNO.SDS.BandwidthControl.ScheduleTable(a);var b=this.fillConfig(a);SYNO.SDS.BandwidthControl.SchedulePlanWin.superclass.constructor.call(this,b)},fillConfig:function(a){var b={owner:a.owner,height:this.winType==="user"?550:370,width:678,padding:"0 20px 0 20px",title:_T("schedule","schedule_title"),layout:"fit",items:[this.scheduleTable],buttons:[{btnStyle:"blue",text:_T("common","apply"),scope:this,handler:this.okHandler},{text:_T("common","cancel"),scope:this,handler:function(){this.close()}}]};Ext.apply(b,a);return b},okHandler:function(){var a=this.scheduleTable;if(!a.isValid()){this.setStatusError({text:_T("common","forminvalid"),clear:true})}else{this.scheduleConfig.scheduleField=a.getSchedule();if(this.winType==="user"){a.getRate();this.scheduleConfig.defUpRate=a.rate[0];this.scheduleConfig.defDownRate=a.rate[1];this.scheduleConfig.cusUpRate=a.rate[2];this.scheduleConfig.cusDownRate=a.rate[3]}this.close()}},onShow:function(){if(this.scheduleConfig.scheduleField!==""){this.scheduleTable.setSchedule(this.scheduleConfig.scheduleField)}if(this.winType==="user"){this.scheduleTable.rate[0]=this.scheduleConfig.defUpRate;this.scheduleTable.rate[1]=this.scheduleConfig.defDownRate;this.scheduleTable.rate[2]=this.scheduleConfig.cusUpRate;this.scheduleTable.rate[3]=this.scheduleConfig.cusDownRate;this.scheduleTable.setRate()}}});SYNO.SDS.BandwidthControl.reConstructApiKey=function(d,c,a){var b={};if(undefined===a){return b}if("get"===d){b[c+"_policy"]=a.policy;b[c+"_schedule_plan"]=a.schedule_plan}else{if("set"===d){b.protocol=c;b.policy=a[c+"_policy"];b.schedule_plan=a[c+"_schedule_plan"]}}return b};