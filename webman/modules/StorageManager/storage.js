/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.namespace("SYNO.SDS.StorageManager");Ext.define("SYNO.SDS.StorageManager.DataView",{extend:"SYNO.ux.ExpandableListView",singleExpanded:true,constructor:function(a){var c=this,b;c.expandedItemId={};c.selectedItemId={};c.appWin=a.appWin;c.owner=a.owner;c.usageTpl=a.usageTpl;c.detailTpl=a.detailTpl;c.isCardLayout=a.isCardLayout;b={tpl:this.createTpl(),trackResetOnLoad:false};c.callParent([Ext.apply(b,a)])},createTpl:function(){var b=this;var a=new Ext.XTemplate('<tpl for=".">','<div class="item-wrap" itemId="{id}" id="{id}">','<div class="item-summary">','<div class="item-icon sm-list-icon {iconCls}"></div>','<div class="sm-list-status-icon {statusIconCls}"></div>',"<div>",'<span class="item-title">{displayName}</span>',"{summaryStatus}",'<div class="item-status">{desc}</div>',"</div>",(b.usageTpl)?b.usageTpl.html:"",(b.isCardLayout)?'<div class="sm-list-next-btn"><div class="sm-list-next-img"></div></div>':('<tpl if="property">'+((b.detailTpl)?'<div class="item-toggle"><div class="item-toggle-img"></div></div>':"")+"</tpl>"),"</div>",'<tpl if="property">','<div class="item-detail" style="display:none">',(b.detailTpl)?b.detailTpl.html:"","</div>","</tpl>","</div>","</tpl>",'<div class="x-clear"></div>',{hasValues:function(c){if(!c){return false}return 0<c.length}});return a},getSelectedItemIds:function(){var a,b,c=[];a=this.getSelectedRecords();for(b=0;b<a.length;++b){if(!a[b]){continue}c.push(a[b].get("id"))}return c},getSelectedItems:function(){var c=this,a=c.getSelectedItemIds(),d=c.appWin[c.dataType].data,b=[];Ext.each(a,function(e){if(e in d){if(d[e]){b.push(d[e])}}});return b},getSelectedItem:function(){var b=this;var a=b.getSelectedItems();if(0===a.length){return}return a[0]},onClick:function(d,c,b){this.callParent(arguments);if(!this.isCardLayout){return}var a=Ext.fly(c);if(a&&(a.hasClass("sm-list-next-btn")||a.hasClass("sm-list-next-img"))){this.owner.fireEvent("nextDetail")}},onDblClick:function(c,b,a){if(this.isCardLayout){this.owner.fireEvent("nextDetail");return}this.callParent(arguments)}});Ext.define("SYNO.SDS.StorageManager.FieldSet",{extend:"Ext.form.FieldSet",collapsible:true,animCollapse:true,constructor:function(){this.callParent(arguments);this.addListener("afterrender",this.doLayout.createDelegate(this,[false,true]),this)},onRender:function(b,a){this.callParent(arguments);var c=this.el.select("legend");if(c){c.addListener("mouseover",this.onMouseOverLegend,this);c.addListener("mouseout",this.onMouseOutLegend,this);c.addListener("mousedown",this.onMouseDownLegend,this);c.addListener("mouseup",this.onMouseUpLegend,this);c.addListener("click",this.onClickLegend,this);c.setStyle({display:"block",width:"100%"})}this.addClass("sm-detail-fieldset")},onMouseOverLegend:function(){this.el.select("legend").addClass("sm-fieldset-legend-hover")},onMouseOutLegend:function(){this.el.select("legend").removeClass("sm-fieldset-legend-hover")},onMouseDownLegend:function(){this.el.select("legend").addClass("sm-fieldset-legend-click")},onMouseUpLegend:function(){this.el.select("legend").removeClass("sm-fieldset-legend-click")},onClickLegend:function(){this.ownerCt.ownerCt.fireEvent("prevList")},toggleCollapse:function(a){this.ownerCt.ownerCt.fireEvent("prevList");return this}});SYNO.SDS.StorageManager.UsageTpl=function(){var a=new Ext.XTemplate('<div class="sm-usage">',"<div>{usage}</div>",'<div class="sm-usage-bg">','<div class="sm-usage-bar" style="width:{barWidth}px"></div>',"</div>","</div>");return a};SYNO.SDS.StorageManager.PropertyTpl=function(){var a=new Ext.XTemplate("<div>",'<tpl for="property">',"<dl>",'<dt class="sm-grid-property-name">{name}</dt>','<dt class="sm-grid-property-value">{value}</dt>','<div style="clear:both"></div>',"</dl>","</tpl>",'<div class="x-clear"></div>',"</div>");return a};SYNO.SDS.StorageManager.DiskListTpl=function(c){var b,g,f,e,a,h,d;g=c.title||_T("smart","smart_toolbar_disk_info");b=c.emptyText||_T("volume","volume_status_none");f=String.format('<div class="sm-grid-section-header">{0} {#} - {1} {status}</div>',_T("volume","volume_raid_subgroup"),g);e=String.format('<div class="sm-grid-section-header">{0}</div>',g);a=new Ext.XTemplate('<tpl if="xcount &gt; 1">',f,"</tpl>",'<tpl if="xcount <= 1">',e,"</tpl>");h=new Ext.XTemplate(String.format('<tpl if="this.hasValues(values.{0}) == false">',c.scope),String.format('<div style="padding-left:10px;height:28px;line-height:28px">{0}</div>',b),"</tpl>",String.format('<tpl for="{0}">',c.scope),'<dl class="sm-grid-disk-list-row">','<dt class="sm-grid-disk-list-column" style="width:20%">{container}</dt>','<dt class="sm-grid-disk-list-column" style="width:25%">{name}</dt>','<dt class="sm-grid-disk-list-column" style="width:20%">{size}</dt>','<dt class="sm-grid-disk-list-column" style="width:15%">{driveType}</dt>','<dt class="sm-grid-disk-list-column" style="width:20%">{status}</dt>','<div class="x-clear"></div>',"</dl>","</tpl>");d=new Ext.XTemplate(a.html,'<div class="sm-grid-disk-list">','<div class="sm-grid-disk-list-header">','<dl style="padding-left:10px;">',String.format('<dt class="sm-grid-disk-list-column" style="width:20%">{0}</dt>',_T("volume","volume_e_unit")),String.format('<dt class="sm-grid-disk-list-column" style="width:25%">{0}</dt>',_T("volume","volume_disknumber")),String.format('<dt class="sm-grid-disk-list-column" style="width:20%">{0}</dt>',_T("volume","volume_diskcapacity")),String.format('<dt class="sm-grid-disk-list-column" style="width:15%">{0}</dt>',_T("volume","volume_disk_type")),String.format('<dt class="sm-grid-disk-list-column" style="width:20%">{0}</dt>',_T("volume","volume_diskstatus")),'<div class="x-clear"></div>',"</dl>","</div>",'<div class="sm-grid-disk-list-body">',h.html,"</div>","</div>",'<div class="x-clear"></div>');return d};SYNO.SDS.StorageManager.DetailUsageTpl=function(){var a=new Ext.XTemplate('<tpl for="detailUsage">','<div class="sm-detail-usage-bg">','<div class="sm-detail-usage-bar1" style="width:{bar1Width}%"></div>','<div class="sm-detail-usage-bar2" style="width:{bar2Width}%"></div>',"</div>","</tpl>","<table>","<tr>",'<tpl for="illustrate">','<tpl if="hide != 1">','<td style="vertical-align:bottom">','<div class="sm-illustrate">','<div class="sm-illustrate-text">{text}</div>',"</div>","</td>","</tpl>","</tpl>","</tr>","</table>","<table>","<tr>",'<tpl for="illustrate">','<tpl if="hide != 1">',"<td>",'<div class="sm-illustrate">','<div class="sm-illustrate-bar{#}"></div>',"</div>","</td>","</tpl>","</tpl>","</tr>","</table>","<table>","<tr>",'<tpl for="illustrate">','<tpl if="hide != 1">','<td style="vertical-align:top">',"<tpl if=\"'string' === typeof message && 0 < message.length\">",'<div class="sm-illustrate">','<div class="sm-illustrate-value{#}"><span style="font-size: 10px">{message}</span></div>',"</div>","</tpl>","<tpl if=\"'string' !== typeof message || 0 === message.length\">",'<div class="sm-illustrate">','<div class="sm-illustrate-value{#}">{value}<span style="font-size: 10px">&nbsp;{unit}</span></div>',"</div>","</tpl>","</td>","</tpl>","</tpl>","</tr>","</table>",'<div class="x-clear"></div>');return a};SYNO.SDS.StorageManager.TargetTpl=function(b){var a,d,e,c;d=b.title||_T("smart","smart_toolbar_disk_info");a=b.emptyText||_T("volume","volume_status_none");e=new Ext.XTemplate(String.format('<tpl if="this.hasValues(values.{0}) == false">',b.scope),String.format('<div style="padding-left:10px;height:28px;line-height:28px">{0}</div>',a),"</tpl>",String.format('<tpl for="{0}">',b.scope),'<dl class="sm-grid-disk-list-row">','<dt class="sm-grid-disk-list-column" style="width:50%">{name}</dt>','<dt class="sm-grid-disk-list-column" style="width:50%">{status}</dt>','<div class="x-clear"></div>',"</dl>","</tpl>");c=new Ext.XTemplate(String.format('<div class="sm-grid-section-header">{0}</div>',d),'<div class="sm-grid-disk-list">','<div class="sm-grid-disk-list-header">','<dl style="padding-left:10px;">',String.format('<dt class="sm-grid-disk-list-column" style="width:50%">{0}</dt>',_T("common","name")),String.format('<dt class="sm-grid-disk-list-column" style="width:50%">{0}</dt>',_T("volume","volume_volumestatus")),'<div class="x-clear"></div>',"</dl>","</div>",'<div class="sm-grid-disk-list-body">',e.html,"</div>","</div>",'<div class="x-clear"></div>');return c};SYNO.SDS.StorageManager.SnapshotTpl=function(b){var a,d,e,c;d=b.title||_T("smart","smart_toolbar_disk_info");a=b.emptyText||_T("volume","volume_status_none");e=new Ext.XTemplate(String.format('<tpl if="this.hasValues(values.{0}) == false">',b.scope),String.format('<div style="padding-left:10px;height:28px;line-height:28px">{0}</div>',a),"</tpl>",String.format('<tpl for="{0}">',b.scope),'<dl class="sm-grid-disk-list-row">','<dt class="sm-grid-disk-list-column" style="width:50%">{name}</dt>','<dt class="sm-grid-disk-list-column" style="width:50%">{status}</dt>','<div class="x-clear"></div>',"</dl>","</tpl>");c=new Ext.XTemplate(String.format('<div class="sm-grid-section-header">{0}</div>',d),'<div class="sm-grid-disk-list">','<div class="sm-grid-disk-list-header">','<dl style="padding-left:10px;">',String.format('<dt class="sm-grid-disk-list-column" style="width:50%">{0}</dt>',_T("common","name")),String.format('<dt class="sm-grid-disk-list-column" style="width:50%">{0}</dt>',_T("volume","volume_volumestatus")),'<div class="x-clear"></div>',"</dl>","</div>",'<div class="sm-grid-disk-list-body">',e.html,"</div>","</div>",'<div class="x-clear"></div>');return c};SYNO.SDS.StorageManager.ListTpl=function(b){var a,g,e,c=[],f=[],h,d;g=b.title||_T("smart","smart_toolbar_disk_info");a=b.emptyText||_T("volume","volume_status_none");e=100/b.columns.length;Ext.each(b.columns,function(i){c.push(String.format('<dt class="sm-grid-disk-list-column" style="width:{0}%">{1}</dt>',i.width?i.width:e,i.header));f.push(String.format('<dt class="sm-grid-disk-list-column" style="width:{0}%">{{1}}</dt>',i.width?i.width:e,i.dataIndex))});h=new Ext.XTemplate(String.format('<tpl if="this.hasValues(values.{0}) == false">',b.scope),String.format('<div style="padding-left:10px;height:28px;line-height:28px">{0}</div>',a),"</tpl>",String.format('<tpl for="{0}">',b.scope),'<dl class="sm-grid-disk-list-row">',f.join(""),'<div class="x-clear"></div>',"</dl>","</tpl>");d=new Ext.XTemplate(String.format('<div class="sm-grid-section-header">{0}</div>',g),'<div class="sm-grid-disk-list">','<div class="sm-grid-disk-list-header">','<dl style="padding-left:10px;">',c.join(""),'<div class="x-clear"></div>',"</dl>","</div>",'<div class="sm-grid-disk-list-body">',h.html,"</div>","</div>",'<div class="x-clear"></div>');return d};Ext.define("SYNO.SDS.StorageManager.Dialog.Confirm",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){this.owner=a.owner;this.callback=a.callback;var b={title:a.title||"",width:650,height:a.winHeight+220,layout:"fit",resizable:false,items:[{xtype:"syno_formpanel",items:[]}],buttons:[{xtype:"syno_button",btnStyle:a.confirmBtnStyle||"blue",itemId:"confirm",text:_T("common","apply"),handler:function(){if(this.callback){this.callback()}this.close()},scope:this},{itemId:"cancel",text:_T("common","cancel"),handler:function(){this.close()},scope:this}]};if(a.message){b.items[0].items.push({xtype:"syno_displayfield",html:a.message});b.items[0].items.push({xtype:"syno_displayfield",html:" "})}b.items[0].items.push({xtype:"syno_checkbox",htmlEncode:false,hideLabel:true,boxLabel:String.format('<font class="red-status">{0}</font>',a.confirmText),listeners:{check:function(c,d){if(d){this.getFooterToolbar().get("confirm").enable()}else{this.getFooterToolbar().get("confirm").disable()}},scope:this}});this.callParent([Ext.apply(b,a)])},onOpen:function(){this.callParent(arguments);this.getFooterToolbar().get("confirm").disable()}});Ext.define("SYNO.SDS.StorageManager.SortButton",{extend:"SYNO.ux.Button",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={itemId:"sort",tooltip:_T("pkgmgr","sort"),cls:"syno-sm-sort-btn",menu:{defaults:{checked:false},cls:"syno-pkg-menu syno-ux-searchfield-menu",items:a.menuItems,show:function(e,f,d){if(this.floating){this.parentMenu=d;if(!this.el){this.render();this.doLayout(false,true)}this.items.each(function(g){if(undefined!==c.owner.sortType&&g.itemId!==c.owner.sortType){g.setChecked(false)}else{g.setChecked(true)}},this);this.showAt(this.el.getAlignToXY(e,f||this.defaultAlign,this.defaultOffsets),d)}else{Ext.menu.Menu.superclass.show.call(this)}}}};c.callParent([b])},getMenuClass:function(){return""}});Ext.define("SYNO.SDS.StorageManager.Wizard.iSCSITargetProperty",{extend:"SYNO.ux.FormPanel",constructor:function(a){var d=this,c=function(g){if(!this.ownerCt){return"Failed to find ownerCt"}var e=this.ownerCt.get(this.confirmFor);var f=e.getValue();if((g!==f)&&(f!==SYNO.SDS.StorageManager.ISCSI.FAKE_PWD||g!==SYNO.SDS.StorageManager.ISCSI.FAKE_PWDC)){return _T("pppoe","error_password")}return true},b;d.appWin=a.appWin;d.owner=a.owner;b={title:_T("iscsitrg","iscsitrg_title_basic"),trackResetOnLoad:true,labelWidth:280,fieldWidth:280,border:false,items:[{xtype:"syno_textfield",fieldLabel:_T("common","name"),vtype:"iscsitrgname",maxlength:128,allowBlank:false,name:"name",appWin:d.appWin,validator:function(e){if(e===this.originalValue){return true}else{if(this.appWin.isUniqueTargetName(e)){return true}else{return _T("iscsitrg","iscsitrg_name_exists")}}}},{xtype:"syno_textfield",fieldLabel:"IQN",vtype:"iscsitrgiqn",maxlength:128,allowBlank:false,name:"iqn",appWin:d.appWin,validator:function(e){if(e===this.originalValue){return true}else{if(this.appWin.isUniqueIQN(e)){return true}else{return _T("iscsitrg","iscsitrg_iqn_exists")}}}},{xtype:"syno_checkbox",boxLabel:_T("iscsitrg","iscsitrg_enable_auth_chap"),name:"chap"},{xtype:"syno_textfield",indent:1,fieldLabel:_T("common","name"),allowBlank:false,maxlength:12,name:"username",vtype:"iscsitrg_username"},{xtype:"syno_textfield",textType:"password",indent:1,fieldLabel:_T("common","password"),maxlength:16,name:"password",allowBlank:false,vtype:"iscsitrg_password"},{xtype:"syno_textfield",textType:"password_confirm",indent:1,fieldLabel:_T("user","user_repswd"),maxlength:16,name:"password_confirm",confirmFor:"password",vtype:"iscsitrg_password",validator:c},{xtype:"syno_checkbox",indent:1,boxLabel:_T("iscsitrg","iscsitrg_enable_auth_mutual_chap"),name:"mutual_chap"},{xtype:"syno_textfield",indent:2,fieldLabel:_T("common","name"),maxlength:12,name:"mutual_username",vtype:"iscsitrg_username",allowBlank:false},{xtype:"syno_textfield",textType:"password",indent:2,fieldLabel:_T("common","password"),maxlength:16,name:"mutual_password",vtype:"iscsitrg_password",allowBlank:false},{xtype:"syno_textfield",textType:"password_confirm",maxlength:16,indent:2,fieldLabel:_T("user","user_repswd"),name:"mutual_password_confirm",confirmFor:"mutual_password",vtype:"iscsitrg_password",validator:c}],listeners:{afterlayout:{fn:function(e){var g=e.getForm();var f=new SYNO.ux.Utils.EnableCheckGroup(g,"chap",["username","password","password_confirm","mutual_chap"]);f=new SYNO.ux.Utils.EnableCheckGroup(g,"mutual_chap",["mutual_username","mutual_password","mutual_password_confirm"])},scope:this,single:true}}};if(d.appWin.supportRaidGroup){b.items.push({xtype:"syno_combobox",itemId:"mapping",name:"mapping",hiddenName:"mapping",labelStyle:"margin-left: 0px; width: 180px;",triggerAction:"all",grow:true,maxHeight:360,resizable:false,editable:false,fieldLabel:_T("iscsitrg","iscsitrg_mapped_target"),emptyText:_T("volume","volume_status_none"),store:new Ext.data.JsonStore({autoDestroy:true,idProperty:"tid",fields:["enabled","id","name","ckeckedClass"]}),displayField:"name",valueField:"tid",mode:"local",tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item">','<div class="x-form-check-wrap">','<input type="button" id="sm-lun-prop-trg-map-{tid}" class="syno-ux-checkbox-icon {ckeckedClass}" style="margin-left: 0px;">','<label ext:qtip="{name}" style="line-height:22px;margin-left:28px;">{name}</label>',"</div>","</div>","</tpl>"),selectOnFocus:true,onSelect:function(g,f){var e=!g.get("enabled");g.set("enabled",e);g.set("ckeckedClass",e?"syno-ux-cb-checked":"");this.setValue(this.getDisplayVaule())},getDisplayVaule:function(){var e=[];this.store.each(function(f){if(f.get("enabled")){e.push(f.get("name"))}});Ext.QuickTips.unregister(this.getEl());if(0<e.length){Ext.QuickTips.register({target:this.getEl(),title:"",text:e.join(",<br>")})}if(0===e.length){return _T("volume","volume_status_none")}else{return e.join(", ")}}})}d.callParent([Ext.apply(b,a)])},getMappingCmp:function(){return this.getComponent("mapping")}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateiSCSITargetMain",{extend:"SYNO.SDS.Wizard.ModalWindow",isDataChanged:false,canCreate:false,constructor:function(a){var d=this,c,e,b;d.appWin=a.appWin;d.owner=a.owner;e=d.appWin.getPage("SYNO.SDS.StorageManager.iSCSILun.Main").canCreate()||{};b=d.appWin.disks.getMatched("isNormalTray","isFree");c={title:_T("iscsitrg","iscsitrg_target_create"),width:640,height:570,minHeight:475,minWidth:640,resizable:true,steps:[new SYNO.SDS.StorageManager.Wizard.TargetPropertyStep({appWin:d.appWin,itemId:"target_prop",nextId:"map_luns"}),new SYNO.SDS.StorageManager.Wizard.MapLunStep({appWin:d.appWin,canCreateLun:e.lun_file||e.lun_block||e.lun_block_on_existing_pool,luns:d.appWin.iscsiLuns.getMatched("isISCSI","isNotCrashed"),itemId:"map_luns",nextId:{create:"luntypestep",exists:"summary"}}),new SYNO.SDS.StorageManager.Wizard.CreateTargetSummaryStep({appWin:d.appWin,itemId:"summary",nextId:null})]};if(e.lun_file||e.lun_block||e.lun_block_on_existing_pool){c.steps.push(new SYNO.SDS.StorageManager.Wizard.LunTypeStep({appWin:d.appWin,isAfterCreateTarget:true,isSupportISCSIBlock:d.appWin.isSupportISCSIBlock(),isSupportISCSIFile:d.appWin.isSupportISCSIFile(),isSupportSHR:d.appWin.isSupportSHR(),canCreate:e,itemId:"luntypestep",nextId:{iscsi_file:"lun_file",iscsi_block_general:"disk",iscsi_block_pool:"poolstep"}}))}if(e.lun_file){c.steps.push(new SYNO.SDS.StorageManager.Wizard.FileLunStep({appWin:d.appWin,volumes:d.appWin.volumes.getMatched("isVolume","isWritable","notUsedByGlusterFs"),isAfterCreateTarget:true,itemId:"lun_file",nextId:"summary"}))}c.steps.push(new SYNO.SDS.StorageManager.Wizard.PoolStep({appWin:d.appWin,pools:d.appWin.storagePools.getMatched("isFreeSizeBiggerThan1GB","isWritable","notUsedByGlusterFs"),freeDisks:b,itemId:"poolstep",nextId:{create:"disk",existing:"allocate_size_on_pool_step"}}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.VolumeSizeStep({appWin:d.appWin,itemId:"allocate_size_on_pool_step",nextId:"summary"}));if(e.lun_block){c.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskStep({appWin:d.appWin,free_disks:b,isAfterCreateTarget:true,isSupportRaidCross:d.appWin.isSupportRaidCross(),isNeedSelectSource:!d.appWin.isSupportRaidCross()&&d.appWin.isSupportEbox()&&d.appWin.isEboxPluged(),isOneBay:1===d.appWin.getBayNumber(),itemId:"disk",nextId:{raid_type:"raid_type",single_disk_raid_type:"single_disk_raid_type"},getNext:function(){if(1===this.getIds().length){return this.nextId.single_disk_raid_type}return this.nextId.raid_type}}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.RaidTypeStep({appWin:d.appWin,isAfterCreateTarget:true,itemId:"raid_type",nextId:"check",getNext:function(){return this.nextId}}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.SingleDiskRaidTypeStep({appWin:d.appWin,isOneBay:d.appWin.isSingleBay(),itemId:"single_disk_raid_type",nextId:"check"}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskCheckStep({appWin:d.appWin,itemId:"check",nextId:{summary:"summary",allocate_size_on_pool_step:"allocate_size_on_pool_step"},getNext:function(){if(this.owner.inHistory("poolstep")){return this.nextId.allocate_size_on_pool_step}else{return this.nextId.summary}}}))}d.callParent([Ext.apply(c,a)])},genNewIQN:function(a){return this.appWin.genNewIQN(a)},genNewTargetName:function(){return this.appWin.genNewTargetName()},genNewLunName:function(){return this.appWin.genNewLunName()},getSpaceType:function(){if(this.inHistory("luntypestep")){return this.getStep("luntypestep").getType()}else{throw Error("wrong flow control: get space type")}},getDiskIds:function(){if(this.inHistory("disk")){return this.getStep("disk").getIds()}else{throw Error("wrong flow control: get disk ids")}},isPoolChild:function(){if(this.inHistory("poolstep")){return true}return false},getPoolPath:function(){if(this.inHistory("poolstep")&&this.getStep("poolstep").getValues()==="existing"){return this.getStep("poolstep").getCurRecord().id}return""},getRaidType:function(){var a;if(this.inHistory("lun_file")){return"file"}if(this.inHistory("shrstep")){a=this.getStep("shrstep").getType()}else{if(this.inHistory("raid_type")||this.inHistory("single_disk_raid_type")){if(this.getStep("raid_type").getType()==="shr"){if(this.inHistory("shrstep")){a=this.getStep("shrstep").getType()}else{if(this.getDiskIds().length===1){a="shr_without_disk_protect"}else{a="shr_with_1_disk_protect"}}}else{a=this.getStep("raid_type").getType()}}else{a="basic"}}return a},getLunType:function(){if(this.inHistory("luntypestep")){return this.getStep("luntypestep").getType()}throw Error("wrong flow control: get lun type")},getMappedTargets:function(){var a=["map_target_none","map_new_target","map_exist_target"];if(this.inHistory("luntypestep")){return a[this.getStep("luntypestep").getTargetOpt()]}throw Error("wrong flow control: get lun type mapped targets")},getAllocateSize:function(){var a=0,b=0,c=0;if(this.inHistory("allocate_size_on_pool_step")){a=parseInt(this.getStep("allocate_size_on_pool_step").getValues(),10);b=parseInt(this.getStep("allocate_size_on_pool_step").maxFreeSizeGB,10);if(a===b){c=parseInt(this.getStep("allocate_size_on_pool_step").maxFreeSizeByte,10);a=Math.floor(c/1024/1024)}else{a=parseInt(this.getStep("allocate_size_on_pool_step").getValues(),10)*1024}}return a.toString()},applySettings:function(){var e={};var a=this.getStep("map_luns").getSource();var d=(a==="create")?this.getLunType():"";var b;var c;var f;if("exists"===a){e=this.getStep("target_prop").getForm().getValues();c="SYNO.Core.Storage.iSCSITargets";f="create";e.mapped_luns=this.getStep("map_luns").getLunIds();if("false"===e.chap){delete e.chap}if("false"===e.mutual_chap){delete e.mutual_chap}}else{if("create"===a&&"iscsi_file"===d){c="SYNO.Core.Storage.iSCSILUN";f="create";b=this.getStep("lun_file").getProps();b.size=(parseInt(b.size,10)*1024*1024*1024).toString();e.iscsi_lun=b;e.create_target=this.getStep("target_prop").getForm().getValues();if("false"===e.create_target.chap){delete e.create_target.chap}if("false"===e.create_target.mutual_chap){delete e.create_target.mutual_chap}}else{if("create"===a&&"iscsi_block_general"===d){c="SYNO.Core.Storage.iSCSILUN";f="create_block_lun";e.lun_name=this.getStep("luntypestep").getLunName();e.disk_id=this.getDiskIds();e.is_disk_check=this.inHistory("check")?this.getStep("check").isChecked():false;e.device_type=this.getRaidType();e.spare_disk_count="0";e.create_target=this.getStep("target_prop").getForm().getValues();if("false"===e.create_target.chap){delete e.create_target.chap}if("false"===e.create_target.mutual_chap){delete e.create_target.mutual_chap}}else{if("create"===a&&"iscsi_block_pool"===d){c="SYNO.Core.Storage.iSCSILUN";if(this.getStep("poolstep").getValues()==="existing"){f="create_block_lun_on_pool";e.pool_path=this.getPoolPath()}else{f="create_block_lun";e.is_pool_child=this.isPoolChild();e.disk_id=this.getDiskIds();e.is_disk_check=this.inHistory("check")?this.getStep("check").isChecked():false;e.device_type=this.getRaidType();e.spare_disk_count="0"}e.lun_name=this.getStep("luntypestep").getLunName();e.allocate_size=this.getAllocateSize();e.create_target=this.getStep("target_prop").getForm().getValues();if("false"===e.create_target.chap){delete e.create_target.chap}if("false"===e.create_target.mutual_chap){delete e.create_target.mutual_chap}}else{throw Error("Wrong iSCSI LUN source.")}}}}this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:c,method:f,version:1,params:e,callback:function(h,g){this.clearStatusBusy();if(!h){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,g);return}SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.StorageManager.ISCSI",false);this.isDataChanged=true;this.close()},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.TargetPropertyStep",{extend:"SYNO.SDS.StorageManager.Wizard.iSCSITargetProperty",constructor:function(a){var c=this,b;c.appWin=a.appWin;b={header:false,headline:_T("iscsitrg","iscsitrg_target_create")};this.callParent([Ext.apply(b,a)])},activate:function(){if(this.loaded){return}this.getForm().setValues({iqn:this.appWin.genNewIQN(this.appWin.genNewTargetName()),name:this.appWin.genNewTargetName()});this.loaded=true},getNext:function(){if(!this.getForm().isValid()){return false}return this.nextId},summary:function(c){var a=this.getForm().getValues();var b="";c.append(_T("common","name"),a.name);c.append("IQN",a.iqn);b=_T("iscsitrg","iscsitrg_title_authen");if(a.mutual_chap==="true"){c.append(b,_T("iscsitrg","iscsitrg_auth_mutual_chap"))}else{if(a.chap==="true"){c.append(b,_T("iscsitrg","iscsitrg_auth_chap"))}else{c.append(b,_T("iscsitrg","iscsitrg_auth_none"))}}if(a.chap==="true"){c.append(_T("common","name"),a.username)}if(a.mutual_chap==="true"){c.append(_T("common","name"),a.mutual_username)}}});Ext.define("SYNO.SDS.StorageManager.Wizard.MapLunStep",{extend:"Ext.form.FormPanel",canCreateLun:false,luns:null,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.canCreateLun=a.canCreateLun;b={headline:_T("volume","volume_set_iscsitrg_lun_mapping"),items:[{xtype:"syno_radio",boxLabel:_T("iscsitrg","iscsitrg_lun_create"),name:"lun_source",inputValue:"create",checked:Ext.isDefined(this.canCreateLun)?this.canCreateLun:false,disabled:!this.canCreateLun},{xtype:"syno_radio",boxLabel:_T("iscsitrg","iscsitrg_map_existent_lun"),name:"lun_source",inputValue:"exists",checked:Ext.isDefined(this.canCreateLun)?!this.canCreateLun:true,listeners:{check:function(e,d){if(d){this.ownerCt.getComponent("grid").enable()}else{this.ownerCt.getComponent("grid").disable()}}}},c.map=new SYNO.SDS.StorageManager.Wizard.iSCSILunTargetMap({appWin:c.appWin,header:false,height:200,synotype:"indent_no_label",indent:1,itemId:"grid",disabled:true})]};c.callParent([Ext.apply(b,a)])},getSource:function(){return this.getForm().getValues().lun_source},activate:function(){if("create"===this.getForm().getValues().lun_source){this.getComponent("grid").disable()}else{this.getComponent("grid").enable()}this.map.loadLuns()},getLunIds:function(){return this.map.getLunIds()},getNext:function(){var b=0;var d="";var c=0;var a=this.map.getStore();for(b=0;b<a.getCount();b++){if(a.getAt(b).get("enabled")){c++}}if(c>SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS){d=_T("iscsitrg","iscsitrg_max_lun_per_target");d=String.format(d,SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS,"");this.owner.getMsgBox().alert(this.title,d);return false}return this.nextId[this.getForm().getValues().lun_source]},summary:function(c){var a=this.getSource();var b=this.map.getStore().getModifiedRecords();var d=[];if(a==="create"){return}Ext.each(b,function(e){d.push(e.get("name"))});if(0===d.length){c.append(_T("iscsitrg","iscsitrg_mapped_lun"),_T("system","none_opt"))}else{c.append(_T("iscsitrg","iscsitrg_mapped_lun"),d.toString())}}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateTargetSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",activate:function(){var a=this.owner.getStep("map_luns").getSource();this.callParent(arguments);if("create"!==a||"iscsi_file"===this.owner.getLunType()){return}if(!this.owner.inHistory("disk")||this.owner.inHistory("poolstep")){return}this.owner.setStatusBusy();this.owner.getButton("next").disable();this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",version:1,method:"estimate_size",params:{estimate_for:"create",disk_id:this.owner.getDiskIds(),device_type:this.owner.getRaidType()},callback:function(c,b){this.owner.clearStatusBusy();if(!c){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,b);return}if(!_S("demo_mode")){this.owner.getButton("next").enable()}if(b.str){this.owner.getMsgBox().alert(this.owner.title,b.str)}this.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(b.size))},scope:this})},getNext:function(){this.owner.applySettings();return false},descRenderer:function(e,b,a,g,d,c){var f=e.toString().replace(/<.*?>/g,"");b.attr='ext:qtip="'+f+'"';return e},disableNextInDemoMode:true});Ext.define("SYNO.SDS.StorageManager.Wizard.DeleteTarget",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,target:null,mapped_luns:null,task_luns:[],lunbkp_tasks:[],constructor:function(a){var c=this,b;c.appWin=a.cpp;c.owner=a.owner;c.target=a.target;c.mapped_luns=a.mapped_luns;b={title:_T("common","remove")+": "+_T("tree","leaf_iscsitrg"),width:600,height:475,layout:"fit",items:[{xtype:"form",itemId:"main",border:false,items:[{xtype:"syno_displayfield",hideLabel:true,itemId:"desc",style:"word-wrap:break-word;",value:String.format(_T("iscsitrg","iscsitrg_delete_warning"),this.target.get("name"))},{xtype:"syno_checkbox",boxLabel:_T("iscsitrg","iscsitrg_delete_confirm"),name:"delete_luns",itemId:"delete_luns",listeners:{check:function(e,d){if(d){this.ownerCt.getComponent("grid").enable()}else{this.ownerCt.getComponent("grid").disable()}}}},c.map=new SYNO.SDS.StorageManager.Wizard.iSCSILunTargetMap({height:190,itemId:"grid",header:false,disabled:true})]}],buttons:[{xtype:"syno_button",btnStyle:"red",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","remove"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}],listeners:{afterlayout:function(g){var d=g.getComponent("main").getHeight();var f=g.getComponent("main").getComponent("desc").getHeight();var e=g.getComponent("main").getComponent("delete_luns").getHeight();g.map.setHeight(d-f-e-50);if(g.map.disabled){g.map.enable();g.map.disable()}}}};c.callParent([Ext.apply(b,a)])},onOpen:function(){var a=this,b=[],c={};a.callParent(arguments);Ext.each(a.mapped_luns,function(d){b.push({id:d.getLunId(),name:d.getName(),enabled:false})});a.map.getStore().loadData(b,false);a.setStatusBusy({text:_T("common","loading")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",version:1,method:"load_lunbackup_tasks",params:c,callback:function(e,d){a.clearStatusBusy();if(!e){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);return}a.task_luns=d.taskluns;a.lunbkp_tasks=d.tasks},scope:a})},applySetting:function(a){this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSITargets",method:"remove",version:1,params:a,callback:function(c,b){this.clearStatusBusy();if(!c){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,b);return}this.isDataChanged=true;this.close()},scope:this})},onSave:function(){var d=this;var c=this.getComponent("main").getForm();var f={tid:this.target.id,luns:[],lids:[]};var b="";var a;if(c.getValues().delete_luns==="true"){Ext.each(d.map.getStore().getModifiedRecords(),function(g){var h=d.appWin.iscsiLuns.getMatched(function(){return this.get("iscsi_lun").lid===g.id});if(h.length!==1){SYNO.Debug("lun id is not unique")}f.luns.push({lid:g.id,sid:h[0].id});f.lids.push(g.id);for(a=0;a<this.task_luns.length;a++){if(this.task_luns[a]===g.data.name){b+=this.task_luns[a]+" "}}},this);if(""!==b){var e=String.format(_T("lunbkp","warning_deleting_lun"),b);this.getMsgBox().confirm(this.title,e,function(g){if("yes"!==g){this.close();return}this.applySetting(f)},this);return}}SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this,this.applySetting,[f])},onCancel:function(){this.close()}});Ext.define("SYNO.SDS.StorageManager.Wizard.ManageTarget",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,target:null,luns:null,constructor:function(a){var d=this,b,c;d.appWin=a.appWin;d.owner=a.owner;d.target=a.target;d.prop=new SYNO.SDS.StorageManager.Wizard.iSCSITargetProperty({itemId:"prop",appWin:d.appWin,owner:d});d.advProp=new SYNO.ux.FormPanel(d.configAdvanceForm({itemId:"advance",appWin:d.appWin,owner:d}));d.map=new SYNO.SDS.StorageManager.Wizard.iSCSILunTargetMap({itemId:"map",appWin:d.appWin,owner:d});d.maskEditor=new SYNO.SDS.StorageManager.Wizard.MaskingEditor({itemId:"mask",appWin:d.appWin,owner:d});c=[d.prop,d.advProp];if(!d.appWin.supportRaidGroup){c.push(d.map)}c.push(d.maskEditor);b={title:_T("common","alt_edit"),width:625,height:500,minWidth:625,minHeight:475,resizable:true,layout:"fit",border:false,items:[{itemId:"main",xtype:"syno_tabpanel",activeTab:0,plain:true,hideMode:"offsets",deferredRender:false,items:c}],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};d.callParent([Ext.apply(b,a)])},configPropForm:function(a){var c=function(f){if(!this.ownerCt){return"Failed to find ownerCt"}var d=this.ownerCt.get(this.confirmFor);var e=d.getValue();if((f!==e)&&(e!==SYNO.SDS.StorageManager.ISCSI.FAKE_PWD||f!==SYNO.SDS.StorageManager.ISCSI.FAKE_PWDC)){return _T("pppoe","error_password")}return true};var b=Ext.apply({title:_T("iscsitrg","iscsitrg_title_basic"),xtype:"form",trackResetOnLoad:true,labelWidth:220,synodefaults:{width:250},items:[{synotype:"text",fieldLabel:_T("common","name"),vtype:"iscsitrgname",maxlength:128,allowBlank:false,name:"name",storageMgr:this.owner,validator:function(d){if(d===this.originalValue){return true}else{if(this.storageMgr.isUniqueTargetName(d)){return true}else{return _T("iscsitrg","iscsitrg_name_exists")}}}},{synotype:"text",fieldLabel:"IQN",vtype:"iscsitrgiqn",maxlength:128,allowBlank:false,name:"iqn",storageMgr:this.owner,validator:function(d){if(d===this.originalValue){return true}else{if(this.storageMgr.isUniqueIQN(d)){return true}else{return _T("iscsitrg","iscsitrg_iqn_exists")}}}},{synotype:"check",boxLabel:_T("iscsitrg","iscsitrg_enable_auth_chap"),name:"chap"},{synotype:"text",indent:1,fieldLabel:_T("common","name"),allowBlank:false,maxlength:12,name:"username",vtype:"iscsitrg_username"},{synotype:"password",indent:1,fieldLabel:_T("common","password"),maxlength:16,name:"password",allowBlank:false,vtype:"iscsitrg_password"},{synotype:"password_confirm",indent:1,fieldLabel:_T("user","user_repswd"),maxlength:16,name:"password_confirm",confirmFor:"password",vtype:"iscsitrg_password",validator:c},{synotype:"check",indent:1,boxLabel:_T("iscsitrg","iscsitrg_enable_auth_mutual_chap"),name:"mutual_chap"},{synotype:"text",indent:2,fieldLabel:_T("common","name"),maxlength:12,name:"mutual_username",vtype:"iscsitrg_username",allowBlank:false},{synotype:"password",indent:2,fieldLabel:_T("common","password"),maxlength:16,name:"mutual_password",vtype:"iscsitrg_password",allowBlank:false},{synotype:"password_confirm",maxlength:16,indent:2,fieldLabel:_T("user","user_repswd"),name:"mutual_password_confirm",confirmFor:"mutual_password",vtype:"iscsitrg_password",validator:c}],listeners:{afterlayout:{fn:function(d){var f=d.getForm();var e=new SYNO.SDS.Utils.EnableCheckGroup(f,"chap",["username","password","password_confirm","mutual_chap"]);e=new SYNO.SDS.Utils.EnableCheckGroup(f,"mutual_chap",["mutual_username","mutual_password","mutual_password_confirm"])},scope:this,single:true}}},a);return SYNO.LayoutConfig.fill(b)},configAdvanceForm:function(a){return Ext.apply({title:_T("iscsitrg","iscsitrg_title_adv"),trackResetOnLoad:true,labelWidth:300,items:[{xtype:"syno_displayfield",value:_T("iscsitrg","iscsitrg_form_crc_checksum")},{xtype:"syno_checkbox",indent:1,boxLabel:_T("iscsitrg","iscsitrg_checksum_header"),name:"hdr_chksum",value:false},{xtype:"syno_checkbox",indent:1,boxLabel:_T("iscsitrg","iscsitrg_checksum_data"),name:"data_chksum",value:false},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_checkbox",boxLabel:_T("iscsitrg","iscsitrg_multi_sessions_desc"),name:"multi_sessions",value:false},{xtype:"syno_displayfield",htmlEncode:false,indent:1,value:String.format('<span class="red-status">{0}</span>',_T("iscsitrg","iscsitrg_multi_sessions_warning"))},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_max_recv_segment"),name:"recv_seg_bytes",hiddenName:"recv_seg_bytes",itemId:"recv_seg_bytes",store:[[262144,262144],[65536,65536],[8192,8192],[4096,4096]],editable:false,value:4096},{xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_max_send_segment"),name:"send_seg_bytes",hiddenName:"send_seg_bytes",itemId:"send_seg_bytes",store:[[262144,262144],[65536,65536],[8192,8192],[4096,4096]],editable:false,value:4096}]},a)},configMappingGrid:function(a){var c=new SYNO.EnableColumn({dataIndex:"enabled",width:40,align:"center",bindRowClick:true,enableFastSelectAll:true});var b=Ext.apply({title:_T("iscsitrg","iscsitrg_mapping"),xtype:"grid",plugins:c,columns:[c,{id:"name",header:_T("common","name"),dataIndex:"name",align:"left",sortable:true,renderer:SYNO.SDS.StorageUtils.TipRenderer}],store:new Ext.data.JsonStore({autoDestroy:true,root:"mapped_luns",idProperty:"id",fields:["id","enabled","name"]}),enableHdMenu:false,autoExpandColumn:"name"},a);return b},onOpen:function(){var a=this;a.callParent(arguments);if(a.appWin.supportRaidGroup){a.loadLunsAdv()}else{a.loadLuns()}a.loadForm();a.loadMasking()},loadForm:function(){var b=this,a,c={};c.name=b.target.get("name");c.iqn=b.target.get("iqn");a=b.target.get("auth");c.chap=a.type!=="none"?true:false;c.mutual_chap=a.type==="mutual"?true:false;if(c.chap){Ext.apply(c,{username:a.username,password:SYNO.SDS.StorageManager.ISCSI.FAKE_PWD,password_confirm:SYNO.SDS.StorageManager.ISCSI.FAKE_PWDC})}if(c.mutual_chap){Ext.apply(c,{mutual_username:a.mutual_username,mutual_password:SYNO.SDS.StorageManager.ISCSI.FAKE_PWD,mutual_password_confirm:SYNO.SDS.StorageManager.ISCSI.FAKE_PWDC})}Ext.apply(c,{hdr_chksum:b.target.get("hdr_chksum"),data_chksum:b.target.get("data_chksum"),recv_seg_bytes:b.target.get("recv_seg_bytes"),send_seg_bytes:b.target.get("send_seg_bytes"),multi_sessions:b.target.get("multi_sessions")});if(b.appWin.supportRaidGroup){c.mapping=b.prop.getMappingCmp().getDisplayVaule()}b.prop.getForm().setValues(c);b.advProp.getForm().setValues(c);b.prop.getForm().clearInvalid()},loadLunsAdv:function(){var b=this,a=b.prop.getMappingCmp().getStore(),d=b.target.get("mapped_luns"),c=[];a.removeAll();Ext.each(b.appWin.iscsiLuns.getAll(),function(f){var e=(d.indexOf(f.getLunId())!==-1);switch(f.get("status")){case"deleting":case"creating":return true}if(f.isSinkLun()){return true}c.push({enabled:e,ckeckedClass:e?"syno-ux-cb-checked":"",id:f.get("iscsi_lun").lid,name:f.getName()})},b);c.sort(function(f,e){return f.name>e.name});a.loadData(c,false);a.commitChanges()},loadLuns:function(){var c=this,a=c.map.getStore(),b=c.appWin.iscsiLuns.getAll(),e=c.target.get("mapped_luns"),d=[];a.removeAll();Ext.each(b,function(f){switch(f.get("status")){case"deleting":case"creating":return true}if(f.isSinkLun()){return true}d.push({id:f.getLunId(),name:f.getName(),enabled:(e.indexOf(f.getLunId())!==-1)})},c);d.sort(function(g,f){return g.name>f.name});a.loadData(d,false);a.commitChanges()},loadMasking:function(){var a=this;if(Ext.isArray(a.target.get("masking"))){a.maskEditor.loadData(a.target.json,false)}else{a.maskEditor.disable()}},isDirty:function(){var c=this,b,a=c.maskEditor.getStore();if(c.appWin.supportRaidGroup){b=c.prop.getMappingCmp().getStore()}else{b=c.map.getStore()}if(c.prop.getForm().isDirty()){return true}if(c.advProp.getForm().isDirty()){return true}if(b.getModifiedRecords().length){return true}if(a.getModifiedRecords().length||a.removeFlag){return true}return false},onSave:function(){var d=this,c,b=d.maskEditor.getStore(),f={},a,e="";if(d.appWin.supportRaidGroup){c=d.prop.getMappingCmp().getStore()}else{c=d.map.getStore()}d.maskEditor.stopEditing();d.maskEditor.removeInvalids();if(!d.prop.getForm().isValid()){d.getComponent("main").activate("prop");d.advProp.getForm().isValid();return}else{if(!d.advProp.getForm().isValid()){d.getComponent("main").activate("advance");return}}if(!d.isDirty()){d.close();return}Ext.apply(f,d.prop.getForm().getValues());Ext.apply(f,d.advProp.getForm().getValues());f.mapped_luns=[];for(a=0;a<c.getCount();a++){if(c.getAt(a).get("enabled")){f.mapped_luns.push(c.getAt(a).get("id"))}}if(f.mapped_luns.length>SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS){e=_T("iscsitrg","iscsitrg_max_lun_per_target");e=String.format(e,SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS,"");d.getMsgBox().alert(d.title,e);return}f.masking=[];for(a=0;a<b.getCount();a++){f.masking.push({iqn:b.getAt(a).get("iqn"),permission:b.getAt(a).get("permission")})}f.tid=d.target.id;if("false"===f.chap){delete f.chap}if("false"===f.mutual_chap){delete f.mutual_chap}if(f.hdr_chksum){f.hdr_chksum=("true"===f.hdr_chksum)?"on":"off"}if(f.data_chksum){f.data_chksum=("true"===f.data_chksum)?"on":"off"}if(f.multi_sessions){f.multi_sessions=("true"===f.multi_sessions)?"on":"off"}d.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSITargets",method:"update",version:1,params:f,callback:function(h,g){d.clearStatusBusy();if(!h){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,g);return}d.isDataChanged=true;d.close()},scope:d})},onCancel:function(){var a=this;if(a.isDirty()){a.getMsgBox().confirm(a.title,_T("common","confirm_lostchange"),function(b){if("yes"===b){a.close()}},a);return}a.close()}});Ext.define("SYNO.SDS.StorageManager.Wizard.MaskingEditor",{extend:"SYNO.ux.EditorGridPanel",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("iscsitrg","iscsitrg_masking"),tbar:{defaultType:"syno_button",items:[{itemId:"createBtn",text:_T("common","create"),scope:this,handler:this.onCreate},{itemId:"removeBtn",text:_T("common","delete"),scope:this,disabled:true,handler:this.onRemove}]},columns:[{id:"iqn",header:_T("iscsitrg","iscsitrg_initiator_iqn"),dataIndex:"iqn",align:"left",renderer:SYNO.SDS.StorageManager.ISCSI.Util.renderIQN,editable:false,editor:new SYNO.ux.TextField({vtype:"iscsitrgiqn",maxlength:128,allowBlank:false,listeners:{blur:this.onIQNBlur,scope:this}})},{header:_T("iscsitrg","iscsitrg_permission"),dataIndex:"permission",align:"left",renderer:SYNO.SDS.StorageManager.ISCSI.Util.renderPermission,editor:new SYNO.ux.ComboBox(SYNO.LayoutConfig.fill({triggerAction:"all",forceSelection:true,editable:false,allowBlank:false,store:[["rw",_T("share","share_permission_writable")],["r",_T("share","share_permission_readonly")],["-",_T("share","share_permission_none")]]}))}],selModel:new Ext.grid.RowSelectionModel({listeners:{selectionchange:function(e){var d=e.getSelected();if(!d||d.get("iqn")===SYNO.SDS.StorageManager.ISCSI.DefaultIQN){this.getTopToolbar().getComponent("removeBtn").disable()}else{this.getTopToolbar().getComponent("removeBtn").enable()}},scope:this}}),store:new Ext.data.JsonStore({autoDestroy:true,root:"masking",fields:["iqn","permission"]}),clicksToEdit:1,autoExpandColumn:"iqn",enableHdMenu:false,listeners:{deactivate:function(){this.stopEditing()},scope:this}};c.callParent([Ext.apply(b,a)])},disableAll:function(){var b=this,a=b.getTopToolbar();a.getComponent("createBtn").disable();a.getComponent("removeBtn").disable();b.getColumnModel().setEditable(0,false);b.getColumnModel().setEditable(1,false);b.getSelectionModel().lock()},enableAll:function(){var b=this,a=b.getTopToolbar(),c=b.getSelectionModel().getSelected();a.getComponent("createBtn").enable();if(c&&c.get("iqn")!==SYNO.SDS.StorageManager.ISCSI.DefaultIQN){a.getComponent("removeBtn").enable()}else{a.getComponent("removeBtn").disable()}b.getColumnModel().setEditable(0,false);b.getColumnModel().setEditable(1,true);b.getSelectionModel().unlock()},onIQNBlur:function(c){var d=c.getValue();var a=true;var b=0;this.stopEditing();this.getStore().each(function(e){if(e.get("iqn")===d){b++}});if(b>1){a=false}if(c.isValid()&&a){this.enableAll()}else{if(Ext.isDefined(this.editRow)){this.getStore().getAt(this.editRow).set("iqn","");this.getStore().removeAt(this.editRow)}this.enableAll()}this.editRow=undefined},removeInvalids:function(){var a=this.getStore(),c,b,d={};for(c=a.getCount()-1;c>=0;c--){b=a.getAt(c).get("iqn");if(true!==Ext.form.VTypes.iscsitrgiqn(b)){a.removeAt(c)}else{d[b]=(b in d)?d[b]+1:1}}for(c=a.getCount()-1;c>=0;c--){b=a.getAt(c).get("iqn");if(d[b]>1){a.removeAt(c);d[b]-=1}}},loadData:function(b,a){b.masking.sort(function(d,c){if(d.iqn===SYNO.SDS.StorageManager.ISCSI.DefaultIQN){return -1}else{if(c.iqn===SYNO.SDS.StorageManager.ISCSI.DefaultIQN){return 1}else{return 0}}});this.getStore().loadData(b,a);this.getStore().removeFlag=false},onCreate:function(){var a=this,c=a.getStore().recordType,b=new c({iqn:"",permission:"rw"});a.stopEditing();a.getStore().add(b);a.getView().refresh();a.editRow=a.getStore().getCount()-1;a.getColumnModel().setEditable(0,true);a.startEditing(a.editRow,0);a.disableAll()},onRemove:function(){var d=this,b=d.getSelectionModel().getSelections(),a=d.getStore(),c;for(c=0;c<b.length;c++){a.remove(b[c])}a.removeFlag=true}});Ext.define("SYNO.SDS.StorageManager.Wizard.ISNS",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.isns_enabled=a.enabled;c.isns_address=a.address;c.isServerAvailable=true;b={title:_T("iscsitrg","iscsitrg_isns"),width:450,height:180,minWidth:450,minHeight:180,layout:"fit",items:[{xtype:"syno_formpanel",itemId:"main",border:false,trackResetOnLoad:true,items:[{xtype:"syno_checkbox",name:"enabled",boxLabel:_T("iscsitrg","iscsitrg_isns_enable"),value:0},{xtype:"syno_textfield",name:"address",indent:1,fieldLabel:_T("iscsitrg","iscsitrg_isns_server"),maxlength:128,vtype:"iporhostname",allowBlank:false,validator:function(){return c.isServerAvailable},invalidText:_T("error","error_timeout"),listeners:{change:function(){c.isServerAvailable=true;this.validate();c.clearStatus()}}}]}],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};c.callParent([Ext.apply(b,a)])},getForm:function(){return this.getComponent("main").getForm()},onOpen:function(){var a=this,b;b=new SYNO.ux.Utils.EnableCheckGroup(a.getForm(),"enabled",["address"]);a.callParent(arguments);a.getForm().setValues({enabled:a.isns_enabled});a.getForm().setValues({address:a.isns_address})},onSave:function(){var a={};if(!this.getForm().isDirty()){this.close();return}if(!this.getForm().isValid()){return}a.enabled=this.getForm().findField("enabled").getValue();a.address=this.getForm().findField("address").getValue();this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSIUtils",method:"update_isns",version:1,params:a,callback:function(d,b){this.clearStatusBusy();if(!d){this.isServerAvailable=false;this.getForm().findField("address").validate();var c=_WFT("common","error_system");if(Ext.isDefined(b.code)){c=SYNO.API.getErrorString(b.code)}console.log("failed to updated isns, err="+c);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,b);return}this.isDataChanged=true;this.close()},scope:this})},onCancel:function(){if(this.getForm().isDirty()){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()}});Ext.define("SYNO.SDS.StorageManager.Wizard.iSCSILunProperty",{extend:"SYNO.ux.FormPanel",constructor:function(f){var g=this,b,j,d,k,a,h;var i='<div style="height: 143px;position: relative;"><div class="sm-iscsi-lun-property-frame">{0}{1}</div></div>';var e='<div style="font-weight: bold;line-height: 20px;padding: 8px 12px 4px 12px;">'+_T("iscsitrg","iscsitrg_use_vaai_or_not_title")+"</div>";var c='<div style="width: 570px;line-height: 18px;padding: 0px 12px 8px 12px">'+_T("iscsitrg","iscsitrg_use_vaai_or_not_description")+"</div>";g.extent_size_editable=false;g.isExtentBased=("yes"===_D("support_vaai","no"));g.appWin=f.appWin;g.owner=f.owner;g.mode=f.mode||"edit";g.lunType=f.lunType||"file";g.isAfterCreateTarget=f.isAfterCreateTarget;g.volumes=g.appWin.volumes.getMatched("isVolume","isWritable","isNotCrashed","notUsedByGlusterFs");b={indent:0,xtype:"panel",layout:"hbox",itemId:"size_panel",width:550,border:false,fieldLabel:'<span style="font-weight:bold">'+String.format("{0} ({1})",_T("common","size"),_T("common","size_gb"))+"</span>",items:[{xtype:"syno_numberfield",fieldLabel:String.format("{0} ({1})",_T("volume","volume_totalsize"),_T("common","size_gb")),name:"size",itemId:"size",value:0,width:280,allowDecimals:true,allowBlank:false,validator:function(p){var m;if(this.ownerCt&&this.ownerCt.ownerCt){m=this.ownerCt.ownerCt}else{return"Failed to find ownerCt"}var l=SYNO.SDS.StorageUtils.ISCSITRG_UNIT_GB;var s=m.get("location").getValue();var n=m.get("thin_provision").getValue();var o=m.get("location").getStore().getById(s);var q;var r=1;if(!Ext.isDefined(o)){return true}if(p<this.originalValue||p<r){return _T("iscsitrg","iscsitrg_size_too_small")}if(n){return true}q=m.get("location").originalValue!==s;if(p*l+o.get("size_used")-(q?0:this.originalValue*l)>o.get("size_total")){return _T("iscsitrg","iscsitrg_set_failed_space_not_enough")}return true}},{xtype:"syno_displayfield",width:10,value:" "},{xtype:"syno_button",itemId:"size_max",text:_T("common","max"),handler:function(m,l){this.getForm().findField("size").setValue(this.maxExpandSizeGB)},scope:this}]};j={xtype:"syno_numberfield",fieldLabel:String.format("{0} ({1})",_T("volume","volume_totalsize"),_T("common","size_gb")),name:"size",itemId:"size",value:0,allowBlank:false,validator:function(x){var n;if(this.ownerCt){n=this.ownerCt}else{return"Failed to find ownerCt"}var t=SYNO.SDS.StorageUtils.ISCSITRG_UNIT_GB;var m=n.get("location").getValue();var s=n.get("thin_provision").getValue();var q=n.get("extent_based").getValue();var r=n.get("location").getStore().getById(m);var l;var o=_T("volume","volume_exceed_max_size_msg");var v=0;var u=10;var w=SYNO.SDS.Utils.StorageUtils.ISCSIVAAILUN_EP_SIZE(x*t);var p=1;if(q){p=10}else{p=1}if("create"===n.mode&&x<p){return true}if(x<this.originalValue||x<p){return _T("iscsitrg","iscsitrg_size_too_small")}if(!Ext.isDefined(r)){return true}else{if(s){if(r.get("size_used")==r.get("size_total")){return _T("iscsitrg","iscsitrg_set_failed_space_not_enough")}if(this.ownerCt.isExt4orBtrfsVolume(r.get("fs_type"))){v=1000*1024}else{v=16*1024}if(x>v){return String.format(o,String.format("{0} GB",v))}if(q){if(x<u){return _T("iscsitrg","iscsitrg_size_too_small")}else{if(w>(r.get("size_total")-r.get("size_used"))){return _T("iscsitrg","iscsitrg_set_failed_space_not_enough")}}}if((x*t)>(r.get("size_total")-r.get("size_used"))){g.thinprovisioningWarning=true}else{g.thinprovisioningWarning=false}return true}}l=n.get("location").originalValue!==m;if(x*t+r.get("size_used")-(l?0:this.originalValue*t)>r.get("size_total")){return _T("iscsitrg","iscsitrg_set_failed_space_not_enough")}return true}};a={title:_T("common","properties"),trackResetOnLoad:true,labelWidth:280,fieldWidth:280,items:[{xtype:"syno_textfield",fieldLabel:_T("common","name"),vtype:"iscsilunname",maxlength:128,allowBlank:false,name:"name",appWin:g.appWin,validator:function(l){if(l===this.originalValue){return true}else{if(this.appWin.isUniqueLunName(l)){return true}else{return _T("iscsitrg","iscsitrg_lun_name_exists")}}}},{xtype:"syno_storage_combobox",fieldLabel:_T("volume","volume_raid_location"),name:"location",hiddenName:"location",itemId:"location",forceSelection:true,displayField:"name",descriptionField:"desc",valueField:"id",allowBlank:false,editable:false,store:this.vol_store=new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:["id","name","size_total","size_used","fs_type","numId","desc"],listeners:{load:function(l,m){l.sort("numId","ASC")},scope:this}}),listeners:{select:function(o,r,l){var p=this.ownerCt.getComponent("thin_provision");if(p.disabled&&p.originalValue){p.setValue(r.id===o.originalValue)}this.ownerCt.getForm().isValid();var n=this,q={};q.action="vol_extent_size_get";var m=n.ownerCt.getComponent("location").store.getAt(l).id.toString();q.volpath="/volume"+m.split("_").pop();if(!q.volpath){console.log("params.volpath null!");return}SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:"vol_extent_size_get",version:1,params:q,callback:function(v,u,t,s){u.success=v;this.ownerCt.extentLUNConfigSetup(u)},scope:this})}}},{xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_thin_provisioning"),name:"thin_provision",hiddenName:"thin_provision",itemId:"thin_provision",editable:false,forceSelection:true,allowBlank:false,disabled:true,value:true,store:[[true,_T("common","yes")],[false,_T("common","no")]],listeners:{select:function(m,n,o){if("edit"===this.mode){this.ownerCt.getForm().isValid();this.ownerCt.getComponent("extent_size").enable()}else{var l=this.ownerCt.getComponent("extent_based");l.setDisabled(o);if(o){l.setValue(false);this.ownerCt.getComponent("size").setMinValue(1);this.ownerCt.getComponent("extent_size").disable()}else{if(this.ownerCt.extent_size_editable&&this.ownerCt.getComponent("extent_based").value){this.ownerCt.getComponent("extent_size").enable()}}this.ownerCt.loadVolumes(true)}}}}]};d={xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_file_type"),name:"extent_based",hiddenName:"extent_based",itemId:"extent_based",editable:false,forceSelection:true,allowBlank:false,disabled:true,hidden:!this.isExtentBased,store:[[true,_T("iscsitrg","iscsitrg_advanced")],[false,_T("iscsitrg","iscsitrg_regular")]],listeners:{select:function(n,p,q){this.ownerCt.loadVolumes(true);if(!q){var m=this.ownerCt.getComponent("size");var l=this.ownerCt.get("extent_based").getValue();var o=10;if(l&&m&&m.getValue()<o){m.setValue(o)}if(this.ownerCt.extent_size_editable){this.ownerCt.getComponent("extent_size").enable()}}else{this.ownerCt.getComponent("extent_size").disable()}if(this.ownerCt.get("extent_based").getValue()){this.ownerCt.getComponent("size").setMinValue(10)}else{this.ownerCt.getComponent("size").setMinValue(1)}}}};k={xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_vaai_extent_size"),name:"extent_size",hiddenName:"extent_size",itemId:"extent_size",editable:false,forceSelection:true,allowBlank:false,disabled:true,hidden:!this.isExtentBased,store:[[4096,_T("iscsitrg","iscsitrg_vaai_4k")],[8192,_T("iscsitrg","iscsitrg_vaai_8k")],[16384,_T("iscsitrg","iscsitrg_vaai_16k")],[32768,_T("iscsitrg","iscsitrg_vaai_32k")],[65536,_T("iscsitrg","iscsitrg_vaai_64k")]]};h={hidden:!this.isExtentBased,html:String.format(i,e,c),border:false};if("block"===g.lunType){a.items.push(b)}else{a.items.push(d);a.items.push(k);a.items.push(j)}if(!g.isAfterCreateTarget){a.items.push({xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_mapped_target"),itemId:"mapped_targets",name:"mapped_targets",hiddenName:"mapped_targets",forceSelection:true,editable:false,displayField:"display",valueField:"value",store:new Ext.data.ArrayStore({fields:["value","display"],data:[[0,_T("iscsitrg","iscsitrg_target_create")],[1,_T("iscsitrg","iscsitrg_map_existent_target")],[2,_T("iscsitrg","iscsitrg_auth_none")]]}),value:0})}if("create"===g.mode){a.items.push(h)}g.callParent([Ext.apply(a,f)])},extentLUNConfigSetup:function(a){var c;var b=this.getForm();if("edit"!=this.mode&&this.isExtentBased){this.getComponent("size").minValue=10}else{this.getComponent("size").minValue=1}if(!a.success){if(this.isExtentBased){b.findField("extent_size").enable();this.extent_size_editable=true}}else{c=parseInt(a.extent_size,10);b.findField("extent_size").setValue(c);b.findField("extent_size").disable();this.extent_size_editable=false}},addTip:function(){if("file"===this.lunType&&"yes"===_D("support_vaai","no")){SYNO.SDS.Utils.AddTip(this.getForm().findField("extent_based").getEl(),Ext.util.Format.htmlEncode(_T("iscsitrg","iscsitrg_vaai_notify")));SYNO.SDS.Utils.AddTip(this.getForm().findField("extent_size").getEl(),Ext.util.Format.htmlEncode(_T("iscsitrg","iscsitrg_vaai_extent_size_notify")));SYNO.SDS.Utils.AddTip(this.getForm().findField("location").getEl(),Ext.util.Format.htmlEncode(_T("iscsitrg","iscsitrg_vaai_location_notify")))}SYNO.SDS.Utils.AddTip(this.getForm().findField("thin_provision").getEl(),Ext.util.Format.htmlEncode(_T("iscsitrg","iscsitrg_thin_provisioning_notify")))},loadVolumes:function(b){var m,g,n,l,f,e=[],j=[];var k=SYNO.SDS.StorageUtils;var h=false;var c,d;if("edit"!==this.mode){h=this.getForm().findField("extent_based").getValue();var a=this.getForm().findField("location").getValue();c=this.getForm().findField("location").getStore().getById(a)}for(d=0;d<this.volumes.length;d++){m=parseInt(this.volumes[d].get("size").used,10);g=parseInt(this.volumes[d].get("size").total,10);n=this.volumes[d].get("fs_type");l=parseInt(this.volumes[d].get("num_id"),10);f=this.volumes[d].get("desc");j.push({id:this.volumes[d].id,name:String.format("{0} ({1}: {2} {3})",this.volumes[d].getName(),_T("volume","volume_freesize"),k.GetSizeGB((g-m),0),_T("common","size_gb")),size_total:g,size_used:m,fs_type:n,numId:l,desc:f});if(h&&!this.isExt4orBtrfsVolume(n)){continue}e.push({id:this.volumes[d].id,name:String.format("{0} ({1}: {2} {3})",this.volumes[d].getName(),_T("volume","volume_freesize"),k.GetSizeGB((g-m),0),_T("common","size_gb")),size_total:g,size_used:m,fs_type:n,numId:l,desc:f})}this.vol_store.loadData(e,false);if(0>=this.vol_store.getCount()){SYNO.Debug("no volume can create iSCSI LUN")}if("edit"!==this.mode&&h){if(e.length===0){if(b){this.owner.getMsgBox().alert(this.owner.title,_T("iscsilun","iscsilun_vaai_lun_fs_warning"))}this.getForm().findField("extent_based").setValue(false);e=j;this.vol_store.loadData(e,false)}else{if(c!==undefined&&!this.isExt4orBtrfsVolume(c.get("fs_type"))){this.getForm().findField("location").setValue(this.vol_store.getAt(0).id)}}}},isExt4orBtrfsVolume:function(b){var a=(("ext4"===b||"btrfs"===b)?true:false);return a}});Ext.define("SYNO.SDS.StorageManager.Wizard.iSCSILunTargetMap",{extend:"SYNO.ux.GridPanel",constructor:function(a){var c=this,d,b;c.appWin=a.appWin;d=new SYNO.ux.EnableColumn({dataIndex:"enabled",width:40,align:"center",bindRowClick:true});b={title:_T("iscsitrg","iscsitrg_mapping"),plugins:d,columns:[d,{id:"name",header:_T("common","name"),dataIndex:"name",align:"left",sortable:true,renderer:SYNO.SDS.StorageUtils.TipRenderer}],store:new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:["id","enabled","name"]}),enableHdMenu:false,autoExpandColumn:"name"};c.callParent([Ext.apply(b,a)])},loadTargets:function(b){var e=this,a=e.appWin.iscsiTargets.getAll(),c=e.getStore(),d,g,f=[];b=b||[];Ext.each(a,function(h){switch(h.get("status")){case"deleting":case"creating":return true}g=h.get("tid");d=(-1!==b.indexOf(g));f.push({id:g,name:h.get("name"),enabled:d})},e);c.loadData(f,false);c.commitChanges()},getTargetIds:function(){var a=[];Ext.each(this.getStore().getModifiedRecords(),function(b){a.push(b.id)});return a},loadLuns:function(){var c=this,a=c.getStore(),e=c.target?c.target.get("mapped_luns"):[],b=c.appWin.iscsiLuns.getAll(),d=[];a.removeAll();Ext.each(b,function(f){switch(f.get("status")){case"deleting":case"creating":return true}if(f.isSinkLun()){return true}d.push({id:f.getLunId(),name:f.getName(),enabled:(e.indexOf(f.getLunId())!==-1)})},c);a.loadData(d,false);a.commitChanges()},getLunIds:function(){var a=[];Ext.each(this.getStore().getModifiedRecords(),function(b){a.push(b.id)});return a}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateiSCSILunMain",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var e=this,g,d,f,b,c;e.isDataChanged=false;e.appWin=a.appWin;e.owner=a.owner;g=e.appWin.getPage("SYNO.SDS.StorageManager.iSCSILun.Main").canCreate()||{};d=e.owner.isSupportISCSI()&&e.appWin.getPage("SYNO.SDS.StorageManager.iSCSITrg.Main").canCreate();f=(0<e.appWin.iscsiTargets.count);b=e.appWin.disks.getMatched("isNormalTray","isFree");c={title:_T("iscsilun","iscsilun_create_title"),cls:"sm-wizard-main",width:640,height:600,resizable:false,border:false,steps:[]};if(e.appWin.isSupportISCSI()&&!e.appWin.isVDSM){c.steps.push(new SYNO.SDS.StorageManager.Wizard.LunTypeStep({appWin:e.appWin,isAfterCreateTarget:false,isSupportISCSIBlock:e.appWin.isSupportISCSIBlock(),isSupportISCSIFile:e.appWin.isSupportISCSIFile(),isSupportSHR:e.appWin.isSupportSHR(),canCreate:g,canCreateTarget:d,itemId:"luntypestep",nextId:{iscsi_file:"lun_file",iscsi_block_general:"disk",iscsi_block_pool:"poolstep"}}))}if(e.appWin.isSupportISCSIFile()){c.steps.push(new SYNO.SDS.StorageManager.Wizard.FileLunStep({appWin:e.appWin,owner:e.owner,canCreateTarget:d,itemId:"lun_file",nextId:["map_new_target","mapped_targets","summary"]}))}if(e.appWin.isSupportISCSI()){c.steps.push(new SYNO.SDS.StorageManager.Wizard.CreateTargetStep({appWin:e.appWin,itemId:"map_new_target",nextId:"summary"}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.MapTargetStep({appWin:e.appWin,itemId:"mapped_targets",nextId:"summary"}))}if(e.appWin.isSupportSHR()){c.steps.push(new SYNO.SDS.StorageManager.Wizard.ShrTypeStep({appWin:e.appWin,itemId:"shrstep",nextId:"check"}))}c.steps.push(new SYNO.SDS.StorageManager.Wizard.PoolStep({appWin:e.appWin,pools:e.appWin.storagePools.getMatched("isFreeSizeBiggerThan1GB","isWritable","notUsedByGlusterFs"),freeDisks:b,itemId:"poolstep",nextId:{create:"disk",existing:"allocate_size_on_pool_step"}}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.VolumeSizeStep({appWin:e.appWin,headline:_T("iscsilun","iscsilun_allocate_size_title"),deviceType:"lun",itemId:"allocate_size_on_pool_step",nextId:{create:"map_new_target",map_exist:"mapped_targets",none:"summary"}}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskStep({appWin:e.appWin,free_disks:b,isSupportRaidCross:e.appWin.isSupportRaidCross(),isNeedSelectSource:!e.appWin.isSupportRaidCross()&&e.appWin.isSupportEbox()&&e.appWin.isEboxPluged(),isOneBay:1===e.appWin.getBayNumber(),getNext:function(){var i=this,h=i.getDisks(),k=false,j=false;Ext.each(h,function(l){if(!l.get("is4Kn")){k=true}else{j=true}});if(k&&j){this.owner.getMsgBox().alert(this.owner.title,_T("volume","not_allow_hybrid_hdd"));return false}if(1===this.getIds().length){return this.nextId.single_disk_raid_type}return this.nextId.raid_type},itemId:"disk",nextId:{raid_type:"raid_type",single_disk_raid_type:"single_disk_raid_type"}}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.RaidTypeStep({appWin:e.appWin,itemId:"raid_type",nextId:{shrstep:"shrstep",check:"check"}}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.SingleDiskRaidTypeStep({appWin:e.appWin,isOneBay:e.appWin.isSingleBay(),itemId:"single_disk_raid_type",nextId:"check"}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskCheckStep({appWin:e.appWin,getNext:function(){if(this.owner.getLunType()==="iscsi_block_general"){return this.nextId[this.owner.getLunTypeMappedTargets()]}else{return this.nextId.allocate_size_on_pool_step}},itemId:"check",nextId:{create:"map_new_target",map_exist:"mapped_targets",allocate_size_on_pool_step:"allocate_size_on_pool_step",none:"summary"}}));c.steps.push(new SYNO.SDS.StorageManager.Wizard.CreateLunSummaryStep({appWin:e.appWin,itemId:"summary",nextId:null}));e.callParent([Ext.apply(c,a)])},genNewLunName:function(){return this.owner.genNewLunName()},genNewIQN:function(a){return this.owner.genNewIQN(a)},genNewTargetName:function(){return this.owner.genNewTargetName()},getDiskIds:function(){if(this.inHistory("disk")){return this.getStep("disk").getIds()}else{throw Error("wrong flow control: get disk ids")}},getRaidType:function(){var a;if(this.inHistory("shrstep")){a=this.getStep("shrstep").getType()}else{if(this.inHistory("raid_type")||this.inHistory("single_disk_raid_type")){if(this.getStep("raid_type").getType()==="shr"){if(this.inHistory("shrstep")){a=this.getStep("shrstep").getType()}else{if(this.getDiskIds().length===1){a="shr_without_disk_protect"}else{a="shr_with_1_disk_protect"}}}else{a=this.getStep("raid_type").getType()}}else{a="basic"}}return a},getMappedType:function(){var b=this.getLunType();var a=["create","map_exist","none"];if("iscsi_file"===b&&this.inHistory("lun_file")){return a[this.getStep("lun_file").getTargetOpt()]}else{if(this.inHistory("luntypestep")){return a[this.getStep("luntypestep").getTargetOpt()]}else{throw Error("wrong flow control: get mapped type")}}},getTargetInfo:function(){if(!this.inHistory("map_new_target")){throw Error("wrong flow control: get target info")}return this.getStep("map_new_target").getForm().getValues()},getMappedTargets:function(){if(!this.inHistory("mapped_targets")){throw Error("wrong flow control: get mapped targets")}return this.getStep("mapped_targets").getTargetIds()},getLunType:function(){if(this.appWin.isVDSM){return"iscsi_file"}if(this.inHistory("luntypestep")){return this.getStep("luntypestep").getType()}throw Error("wrong flow control: get lun type")},getLunTypeMappedTargets:function(){var a=["create","map_exist","none"];if(this.inHistory("luntypestep")){return a[this.getStep("luntypestep").getTargetOpt()]}throw Error("wrong flow control: get lun type mapped targets")},getPoolPath:function(){if(this.inHistory("poolstep")&&this.getStep("poolstep").getValues()==="existing"){return this.getStep("poolstep").getCurRecord().id}return""},getAllocateSize:function(){var a=0,b=0,c=0;if(this.inHistory("allocate_size_on_pool_step")){a=parseInt(this.getStep("allocate_size_on_pool_step").getValues(),10);b=parseInt(this.getStep("allocate_size_on_pool_step").maxFreeSizeGB,10);if(a===b){c=parseInt(this.getStep("allocate_size_on_pool_step").maxFreeSizeByte,10);a=Math.floor(c/1024/1024)}else{a=parseInt(this.getStep("allocate_size_on_pool_step").getValues(),10)*1024}}return a.toString()},isPoolChild:function(){if(this.inHistory("poolstep")){return true}return false},applySettings:function(){var d={},c=this.getLunType(),a,b;if("iscsi_file"===c){d.method="create";a=this.getStep("lun_file").getProps();a.size=(parseInt(a.size,10)*1024*1024*1024).toString();d.iscsi_lun=a}else{if("iscsi_block_general"===c){d.method="create_block_lun";d.lun_name=this.getStep("luntypestep").getLunName();d.disk_id=this.getDiskIds();d.is_disk_check=this.inHistory("check")?this.getStep("check").isChecked():false;d.device_type=this.getRaidType();d.spare_disk_count="0";d.is_pool_child=this.isPoolChild();d.pool_path=this.getPoolPath();d.allocate_size=this.getAllocateSize()}else{if("iscsi_block_pool"===c){if(this.getStep("poolstep").getValues()==="existing"){d.method="create_block_lun_on_pool";d.lun_name=this.getStep("luntypestep").getLunName();d.pool_path=this.getPoolPath();d.allocate_size=this.getAllocateSize()}else{b=this.getRaidType();d.method="create_block_lun";d.lun_name=this.getStep("luntypestep").getLunName();d.disk_id=this.getDiskIds();d.is_disk_check=this.inHistory("check")?this.getStep("check").isChecked():false;d.device_type=b;d.spare_disk_count="0";d.is_pool_child=this.isPoolChild();d.pool_path=this.getPoolPath();d.allocate_size=this.getAllocateSize();d.desc=SYNO.SDS.StorageUtils.RaidLevelRender(b)}}}}d.map_type=this.getMappedType();if("create"===d.map_type){d.create_target=this.getTargetInfo();if("false"===d.create_target.chap){delete d.create_target.chap}if("false"===d.create_target.mutual_chap){delete d.create_target.mutual_chap}}else{if("map_exist"===d.map_type){d.mapped_targets=this.getMappedTargets()}}this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:d.method,version:1,params:d,callback:function(f,e){this.clearStatusBusy();if(!f){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(e);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,e);return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));if("create"===d.map_type||"map_exist"===d.map_type){SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.StorageManager.ISCSI",false)}if(e.str){this.getMsgBox().alert(this.title,e.str,this.close,this)}else{this.isDataChanged=true;this.close()}},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.LunTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.loaded=false;c.appWin=a.appWin;c.isAfterCreateTarget=a.isAfterCreateTarget;c.isSupportISCSIFile=c.appWin.isSupportISCSIFile();c.isSupportISCSIBlock=c.appWin.isSupportISCSIBlock();c.isSupportSHR=c.appWin.isSupportSHR();c.canCreateTarget=a.canCreateTarget;c.canCreate=a.canCreate||{};b=c.configForm();c.callParent([Ext.apply(b,a)])},configForm:function(){var a={headline:_T("iscsilun","iscsilun_choose_lun_title"),labelWidth:280,fieldWidth:280,items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_iscsitrg_lun_file"),name:"lunTypeChooser",itemId:"iscsi_file",inputValue:"iscsi_file",disabled:true},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_iscsitrg_lun_file_help")},{xtype:"syno_radio",boxLabel:_T("iscsilun","iscsilun_block_single_on_raid"),name:"lunTypeChooser",itemId:"iscsi_block_general",inputValue:"iscsi_block_general",disabled:true,listeners:{check:function(e,b){var c=e.ownerCt.getComponent("lun_name_general");var g=b?c.enable():c.disable();c=e.ownerCt.getComponent("mapped_targets_general");if(c){g=b?c.enable():c.disable()}}}},{xtype:"syno_displayfield",indent:1,value:_T("iscsilun","iscsilun_block_single_on_raid_help")},{xtype:"syno_textfield",indent:1,fieldLabel:_T("common","name"),disabled:true,vtype:"iscsilunname",maxlength:128,name:"lun_name_general",itemId:"lun_name_general",allowBlank:false,appWin:this.appWin,validator:function(b){if(this.appWin.isUniqueLunName(b)){return true}else{return _T("iscsitrg","iscsitrg_lun_name_exists")}},value:this.appWin.genNewLunName()},{xtype:"syno_combobox",indent:1,fieldLabel:_T("iscsitrg","iscsitrg_mapped_target"),name:"mapped_targets_general",hiddenName:"mapped_targets_general",itemId:"mapped_targets_general",forceSelection:true,editable:false,disabled:true,store:[[0,_T("iscsitrg","iscsitrg_target_create")],[1,_T("iscsitrg","iscsitrg_map_existent_target")],[2,_T("iscsitrg","iscsitrg_auth_none")]],value:0},{xtype:"syno_radio",boxLabel:_T("iscsilun","iscsilun_block_multiple_on_raid"),name:"lunTypeChooser",itemId:"iscsi_block_pool",inputValue:"iscsi_block_pool",disabled:true,listeners:{check:function(e,b){var c=e.ownerCt.getComponent("lun_name_pool");var g=b?c.enable():c.disable();c=e.ownerCt.getComponent("mapped_targets_pool");if(c){g=b?c.enable():c.disable()}}}},{xtype:"syno_displayfield",indent:1,value:_T("iscsilun","iscsilun_block_multiple_on_raid_help")},{xtype:"syno_textfield",indent:1,fieldLabel:_T("common","name"),disabled:true,vtype:"iscsilunname",maxlength:128,name:"lun_name_pool",itemId:"lun_name_pool",allowBlank:false,appWin:this.appWin,validator:function(b){if(this.appWin.isUniqueLunName(b)){return true}else{return _T("iscsitrg","iscsitrg_lun_name_exists")}},value:this.appWin.genNewLunName()},{xtype:"syno_combobox",indent:1,fieldLabel:_T("iscsitrg","iscsitrg_mapped_target"),name:"mapped_targets_pool",hiddenName:"mapped_targets_pool",itemId:"mapped_targets_pool",forceSelection:true,editable:false,disabled:true,store:[[0,_T("iscsitrg","iscsitrg_target_create")],[1,_T("iscsitrg","iscsitrg_map_existent_target")],[2,_T("iscsitrg","iscsitrg_auth_none")]],value:0}]};if(!this.isSupportISCSIFile){a.items.splice(0,2)}if(!this.isSupportISCSIBlock){a.items.splice(2,8)}return a},getType:function(){return this.getForm().getValues().lunTypeChooser},getLunName:function(){if(this.getForm().getValues().lunTypeChooser==="iscsi_block_general"){return this.getForm().getValues().lun_name_general}else{if(this.getForm().getValues().lunTypeChooser==="iscsi_block_pool"){return this.getForm().getValues().lun_name_pool}}},getTargetOpt:function(){if(this.getForm().getValues().lunTypeChooser==="iscsi_block_general"){return this.getForm().getValues().mapped_targets_general}else{if(this.getForm().getValues().lunTypeChooser==="iscsi_block_pool"){return this.getForm().getValues().mapped_targets_pool}}},activate:function(){var c=false;var b=this.getComponent("mapped_targets_general");var a=this.getComponent("mapped_targets_pool");if(this.loaded){return}if(this.canCreate.lun_file&&this.getComponent("iscsi_file")){this.getComponent("iscsi_file").enable();if(!c){this.getComponent("iscsi_file").setValue(true);c=true}}if(this.canCreate.lun_block&&this.getComponent("iscsi_block_general")){this.getComponent("iscsi_block_general").enable();if(!c){this.getComponent("iscsi_block_general").setValue(true);c=true}}if((this.canCreate.lun_block||this.canCreate.lun_block_on_existing_pool)&&this.getComponent("iscsi_block_pool")){this.getComponent("iscsi_block_pool").enable();if(!c){this.getComponent("iscsi_block_pool").setValue(true);c=true}}if(!this.isAfterCreateTarget){if(this.getComponent("iscsi_block_general")){b.getEl().findParentNode(".x-form-item").style.display=""}if(this.getComponent("iscsi_block_pool")){a.getEl().findParentNode(".x-form-item").style.display=""}if(!this.canCreateTarget){if(this.getComponent("iscsi_block_general")){b.getStore().removeAt(0);b.setValue(1)}if(this.getComponent("iscsi_block_pool")){a.getStore().removeAt(0);a.setValue(1)}}}else{if(this.getComponent("iscsi_block_general")){b.getEl().findParentNode(".x-form-item").style.display="none"}if(this.getComponent("iscsi_block_pool")){a.getEl().findParentNode(".x-form-item").style.display="none"}}if(this.appWin.isUpToiSCSILunMaxCount()){this.owner.getMsgBox().alert(this.title,_T("volume","volume_max_iscsitrg_count_warning"))}this.loaded=true},getNext:function(){if(!this.getForm().isValid()){return false}var a=this.getForm().getValues().lunTypeChooser;if("iscsi_block_general"===a){return this.nextId.iscsi_block_general}else{if("iscsi_block_pool"===a){return this.nextId.iscsi_block_pool}else{if("iscsi_file"===a){return this.nextId.iscsi_file}}}},summary:function(b){var a=this.getType();if(!this.isAfterCreateTarget){b.append(_T("volume","volume_space"),_T("volume","volume_iscsitrg_lun"))}if("iscsi_block_general"===a||"iscsi_block_pool"===a){if(!this.isAfterCreateTarget){b.append(_T("common","name"),this.getLunName())}else{b.append(_T("iscsitrg","iscsitrg_mapped_lun"),String.format("{0} ({1})",this.getLunName(),_T("common","create")))}}}});Ext.define("SYNO.SDS.StorageManager.Wizard.FileLunStep",{extend:"SYNO.SDS.StorageManager.Wizard.iSCSILunProperty",isAfterCreateTarget:false,canCreateTarget:false,volumes:null,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.volume=a.volume;c.isAfterCreateTarget=a.isAfterCreateTarget;a.mode="create";b={lunType:"file",isAfterCreateTarget:a.isAfterCreateTarget,headline:_T("volume","volume_set_iscsitrg_property_title")};c.callParent([Ext.apply(b,a)])},getProps:function(){var a=this.getForm().getValues();delete a.mapped_targets;return a},getTargetOpt:function(){return this.getForm().getValues().mapped_targets},activate:function(){var d=this,c=this.getForm();var a=this.getComponent("mapped_targets");if(this.loaded){return}this.loadVolumes();if(!this.isAfterCreateTarget){if(!this.canCreateTarget){a.getStore().removeAt(0);a.setValue(1)}}c.findField("name").setValue(this.appWin.genNewLunName());c.findField("location").setValue(this.vol_store.getAt(0).id);c.findField("thin_provision").enable();if(true===c.findField("extent_based").getValue()){c.findField("size").setValue(10)}else{c.findField("size").setValue(1)}if("yes"===_D("support_vaai","no")){var e={};c.findField("extent_based").enable();e.action="vol_extent_size_get";var b=d.vol_store.getAt(0).id.toString();e.volpath="/volume"+b.split("_").pop();if(!e.volpath){console.log("params.volpath null!");return}SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:"vol_extent_size_get",version:1,params:e,callback:function(i,h,g,f){h.success=i;this.extentLUNConfigSetup(h)},scope:this})}this.addTip();this.loaded=true},getNext:function(){var b=this,a=b.getForm().getValues().mapped_targets;if(!b.getForm().isValid()){return false}if(true===this.thinprovisioningWarning){this.owner.getMsgBox().confirm(this.owner.title,_T("iscsitrg","iscsitrg_thin_provisioning_warning"),function(c){if("yes"===c){if(b.isAfterCreateTarget){b.owner.goNext(b.nextId)}else{b.owner.goNext(b.nextId[a])}}},this.owner)}else{if(b.isAfterCreateTarget){return b.nextId}else{return b.nextId[a]}}return false},summary:function(b){var e=this.getProps();var d=this.vol_store.getById(e.location).get("name");var a=this.isAfterCreateTarget?function(f,g){b.appendSub(f,g)}:function(f,g){b.append(f,g)};if(this.isAfterCreateTarget){b.append(_T("iscsitrg","iscsitrg_mapped_lun"),String.format("{0} ({1})",e.name,_T("common","create")))}else{a(_T("common","name"),e.name)}a(_T("volume","volume_raid_location"),d);a(_T("volume","volume_totalsize"),String.format("{0} ({1})",e.size,_T("common","size_gb")));a(_T("iscsitrg","iscsitrg_thin_provisioning"),"true"===e.thin_provision?_T("common","yes"):_T("common","no"));if("yes"===_D("support_vaai","no")){a(_T("iscsitrg","iscsitrg_vaai"),"true"===e.extent_based?_T("common","yes"):_T("common","no"));if("true"===e.extent_based){var c=this.getForm().findField("extent_size").getValue();a(_T("iscsitrg","iscsitrg_vaai_extent_size"),(c/1024).toString().concat("k"))}}}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateTargetStep",{extend:"SYNO.SDS.StorageManager.Wizard.iSCSITargetProperty",constructor:function(a){var c=this,b;c.appWin=a.appWin;b={header:false,headline:_T("iscsitrg","iscsitrg_target_create")};c.callParent([Ext.apply(b,a)])},activate:function(){if(this.loaded){return}this.getForm().setValues({iqn:this.appWin.genNewIQN(this.appWin.genNewTargetName()),name:this.appWin.genNewTargetName()});this.loaded=true},getNext:function(){if(!this.getForm().isValid()){return false}return this.nextId},summary:function(c){var a=this.getForm().getValues();var b="";c.append(_T("iscsitrg","iscsitrg_mapped_target"),String.format("{0} ({1})",a.name,_T("common","create")));c.appendSub("IQN",a.iqn);b=_T("iscsitrg","iscsitrg_title_authen");if(a.mutual_chap==="true"){c.appendSub(b,_T("iscsitrg","iscsitrg_auth_mutual_chap"))}else{if(a.chap==="true"){c.appendSub(b,_T("iscsitrg","iscsitrg_auth_chap"))}else{c.appendSub(b,_T("iscsitrg","iscsitrg_auth_none"))}}if(a.chap==="true"){c.appendSub(_T("common","name"),a.username)}if(a.mutual_chap==="true"){c.appendSub(_T("common","name"),a.mutual_username)}}});Ext.define("SYNO.SDS.StorageManager.Wizard.MapTargetStep",{extend:"SYNO.SDS.StorageManager.Wizard.iSCSILunTargetMap",constructor:function(a){var c=this,b;c.appWin=a.appWin;b={headline:_T("iscsitrg","iscsitrg_map_existent_target"),itemId:"map",enableHdMenu:false,header:false,height:250};c.callParent([Ext.apply(b,a)])},getMapPanel:function(){return this.getComponent("map")},activate:function(){if(this.loaded){return}this.loadTargets();this.loaded=true},getNext:function(){var g=this,d=0,c="",a="",f,b="",j="",e=g.getStore();var h=function(i){return function(k){return(i===k.get("tid"))}};b=_T("iscsitrg","iscsitrg_max_lun_per_target");for(d=0;d<e.getCount();d++){j=e.getAt(d);if(j.get("enabled")){c=j.get("id");a=j.get("name");f=g.appWin.iscsiTargets.findBy(h(c));if(f&&f.get("mapped_luns").length+1>SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS){b=String.format(b,SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS,"("+a+")");g.owner.getMsgBox().alert(g.title,b);return false}}}return g.nextId},summary:function(b){var a=[];Ext.each(this.getStore().getModifiedRecords(),function(c){a.push(c.get("name"))});b.append(_T("iscsitrg","iscsitrg_mapped_target"),a.join(" ,"))}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateLunSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(a){var b=Ext.apply({headline:_T("volume","volume_wizard_summary_title")},a);this.callParent([b])},activate:function(){this.callParent(arguments);if(!this.owner.inHistory("disk")||this.owner.inHistory("poolstep")){return}this.owner.setStatusBusy();this.owner.getButton("next").disable();this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",version:1,method:"estimate_size",params:{estimate_for:"create",disk_id:this.owner.getDiskIds(),device_type:this.owner.getRaidType()},callback:function(b,a){this.owner.clearStatusBusy();if(!b){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,a);this.owner.getButton("next").disable();return}if(!_S("demo_mode")){this.owner.getButton("next").enable()}if(a.str){this.owner.getMsgBox().alert(this.owner.title,a.str)}this.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(a.size))},scope:this})},getNext:function(){this.owner.applySettings();return false},descRenderer:function(e,b,a,g,d,c){var f=e.toString().replace(/<.*?>/g,"");b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(f)+'"';return e},disableNextInDemoMode:true});Ext.define("SYNO.SDS.StorageManager.Wizard.DeleteLun",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.isDataChanged=false;c.task_luns="";c.lunbkp_tasks="";c.services=undefined;c.appWin=a.appWin;c.owner=a.owner;c.luns=a.luns;b={title:_T("iscsilun","iscsilun_remove_title"),width:640,height:350,resizable:false,layout:"fit",items:[{xtype:"syno_formpanel",itemId:"main",border:false,items:[{xtype:"syno_displayfield",value:"",id:c.descID=Ext.id(),itemId:"desc"},c.grid=new SYNO.SDS.Wizard.SummaryStep({layout:"fit",height:200})]}],buttons:[{xtype:"syno_button",btnStyle:"red",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","remove"),id:c.applyButtonID=Ext.id(),scope:c,handler:c.onDelete},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){var c=this,a=[],b=[];c.callParent(arguments);c.setStatusBusy({text:_T("common","loading")});Ext.each(c.luns,function(d){a.push(d.get("iscsi_lun").lid);b.push(d.get("iscsi_lun").uuid)},c);c.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"load_lunbackup_tasks",version:1,params:{lids:a,uuids:b},callback:function(e,d){c.clearStatusBusy();if(!e){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);return}c.task_luns=d.taskluns;c.lunbkp_tasks=d.tasks;c.loadData(d)},scope:c})},loadData:function(f){var m=this,n=SYNO.SDS.StorageUtils,l=m.grid.getStore(),g,e,d={},h=[],k,a="",b=n.CheckFailedMsg(f.check),c=false;if(1<m.luns.length){l.append(_T("volume","volume_iscsitrg_lun"),m.genLunsStr(m.luns))}else{l.append(_T("volume","volume_iscsitrg_lun"),m.luns[0].getName())}if("hard_failed"===b){c=true;Ext.getCmp(m.applyButtonID).disable();Ext.getCmp(m.descID).setValue(_T("volume","del_hard_check_fail"))}else{if("soft_failed"===b){Ext.getCmp(m.descID).setValue(_T("volume","del_soft_check_fail"))}else{Ext.getCmp(m.descID).setValue(_T("volume","volume_delete_summary_desc"))}}n.CheckMsg(f.check,c,"iscsiluns",l);for(g=0;g<m.luns.length;g++){for(e=0;e<m.task_luns.length;e++){if(m.task_luns[e]===m.luns[g].getName()){if(""!==a){a+=", "}a+=m.lunbkp_tasks[e]}}}if(""!==a){l.append(_T("lunbkp","lun_bkp_task"),a)}if("yes"===_D("support_ssd_cache","no")){Ext.each(m.luns,function(i){d[i.get("id")]=true});Ext.each(m.appWin.ssdCaches.getAll(),function(i){k=i.get("mountSpaceId");if(d[k]){h.push(SYNO.SDS.Utils.StorageUtils.SpaceIDParser(i.get("id")).str)}},m);if(0<h.length){l.append(_T("volume","ssd_cache"),h.join(", "))}}},genLunsStr:function(a){var b=[];Ext.each(a,function(c){b.push(c.getName())});return b.join(", ")},onDelete:function(){SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this,this.onSave)},onSave:function(){var b={};var a=[];Ext.each(this.luns,function(c){a.push(c.get("iscsi_lun").lid)},this);b.lid=a;this.apply(b)},onCancel:function(){this.close()},apply:function(a){this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"remove",version:1,params:a,callback:function(c,b){this.clearStatusBusy();if(!c){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,b);return}this.isDataChanged=true;this.close()},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.EditLun",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,lun:null,volumes:null,targets:null,pool:null,minExpandSizeGB:0,maxExpandSizeGB:0,maxExpandSizeByte:0,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.lun=a.lun;c.pool=a.pool;b={title:_T("common","alt_edit"),width:702,height:320,resizable:false,layout:"fit",plain:true,border:false,items:[{itemId:"main",xtype:"syno_tabpanel",hideMode:"offsets",deferredRender:false,activeTab:0,plain:true,items:[c.lunProp=new SYNO.SDS.StorageManager.Wizard.iSCSILunProperty({appWin:c.appWin,owner:c.owner,itemId:"prop",mode:"edit",isAfterCreateTarget:true,lunType:(c.lun.isFileLun())?"file":"block"}),c.map=new SYNO.SDS.StorageManager.Wizard.iSCSILunTargetMap({appWin:c.appWin,itemId:"map"})]}],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){var a=this;a.callParent(arguments);if(a.lun.isFileLun()){a.lunProp.loadVolumes()}a.loadForm();a.map.loadTargets(a.lun.get("iscsi_lun").mapped_targets);if(a.lun.isCrashed()||a.lun.isSinkLun()){a.getMapPanel().disable()}a.lunProp.addTip()},getPropPanel:function(){return this.lunProp},getMapPanel:function(){return this.getComponent("main").getComponent("map")},getField:function(a){return this.lunProp.getForm().findField(a)},getSizeMaxButton:function(){return this.lunProp.getComponent("size_panel").getComponent("size_max")},loadForm:function(){var f=this,h=SYNO.SDS.StorageUtils,c=f.lun.get("iscsi_lun"),a=f.getPropPanel().getForm(),b,g,j,e,i,d;if(f.lun.isBlockLun()){if(f.lun.isLogicalVolume()){e=parseInt(c.size,10);g=parseInt(f.pool.get("size").total,10);j=parseInt(f.pool.get("size").used,10);i=(g-j)+e;f.maxExpandSizeGB=h.GetSizeGB(i,0);f.lunProp.maxExpandSizeGB=f.maxExpandSizeGB;f.maxExpandSizeByte=i;f.minExpandSizeGB=h.GetSizeGB(e,0);d=f.minExpandSizeGB;f.getField("size").enable();f.getSizeMaxButton().show()}else{f.getSizeMaxButton().disable();d=h.GetSizeGB(c.size,0);f.getField("size").disable()}f.getPropPanel().getForm().setValues({name:c.name,size:d});if(_S("ha_running")){f.getField("name").disable()}if(f.pool&&!(f.pool.isWritable()&&f.pool.isFreeSizeBiggerThan1GB())){f.getField("size").disable();f.getSizeMaxButton().disable()}f.getField("location").disable();f.getField("thin_provision").disable();f.getField("location").hide();f.getField("thin_provision").hide()}else{f.getPropPanel().getForm().setValues({name:c.name,location:c.location,thin_provision:c.thin_provision,size:h.GetSizeGB(c.size,0),extent_based:c.extent_based,extent_size:c.extent_size});b=f.appWin.volumes.data[c.location];if(b&&!b.isWritable()){f.getField("location").setValue(b.getName());f.getField("location").disable();f.getField("size").disable()}if(c.extent_based){f.getField("location").disable()}else{f.getField("location").label.update(_T("volume","volume_raid_location")+":");f.getField("extent_size").hide()}}if(f.lun.isSinkLun()){f.getField("size").disable()}a.clearInvalid()},isDirty:function(){var a=this.getMapPanel().getStore();if(this.getPropPanel().getForm().isDirty()){return true}if(a.getModifiedRecords().length){return true}return false},onSave:function(){var k=this;var b="";var f={};var g,h=this.getMapPanel().getStore();var p="";var o,j,c,e,a,d;var n=function(i){return function(q){return(i===q.get("tid"))}};if(!k.getPropPanel().getForm().isValid()){k.getComponent("main").activate("prop");return}if(!k.isDirty()){k.close();return}if(k.lun.isLogicalVolume()){if(!k.checkLvLunData(f)){return}}b=_T("iscsitrg","iscsitrg_max_lun_per_target");Ext.apply(f,k.getPropPanel().getForm().getValues());c=f.size;if((k.lun.isFileLun()||k.lun.isLogicalVolume())&&Ext.isDefined(c)){if(parseInt(c,10)===parseInt(this.maxExpandSizeGB,10)){o=k.maxExpandSizeByte}else{o=parseInt(c,10)*1024*1024*1024}f.size=o.toString()}d=k.appWin.volumes.data[k.lun.get("iscsi_lun").location];f.mapped_targets=[];for(g=0;g<h.getCount();g++){p=h.getAt(g);if(p.get("enabled")){if(p.dirty){e=p.get("id");a=p.get("name");j=k.appWin.iscsiTargets.findBy(n(e));if(j&&j.get("mapped_luns").length+1>SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS){b=String.format(b,SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS,"("+a+")");k.getMsgBox().alert(k.title,b);return false}}f.mapped_targets.push(h.getAt(g).id)}}f.lid=k.lun.getLunId();if(k.lun.isFileLun()&&(!k.getField("location").disabled&&k.getField("location").originalValue!==f.location)){k.getMsgBox().confirm(k.title,_T("iscsilun","iscsilun_warning_move_location"),function(i){if("yes"===i){k.applySettings(f)}},k);return}else{if(k.lun.isFileLun()&&(o-parseInt(k.lun.get("iscsi_lun").size,10)>(parseInt(d.get("size").total,10)-parseInt(d.get("size").used,10)))){k.getMsgBox().confirm(k.title,_T("iscsitrg","iscsitrg_thin_provisioning_warning"),function(i){if("yes"===i){k.applySettings(f)}},k);return}else{if(k.getPropPanel().getForm().isDirty()){var l=false;if("object"===typeof k.lun.get("vspace_can_do")){for(var m in k.lun.get("vspace_can_do")){if(k.lun.get("vspace_can_do")[m].resize.stopService){l=true;break}}}if(l){k.getMsgBox().confirm(_T("tree","leaf_volume"),_T("volume","volume_all_service_stop"),function(i){if("yes"===i){k.applySettings(f)}},k)}else{k.applySettings(f)}}else{k.applySettings(f)}}}},checkLvLunData:function(e){var b=false;var f=this.getField("size").getValue();var a=String.format("{0}",this.minExpandSizeGB);var c=String.format("{0}",this.maxExpandSizeGB);var d=String.format(_T("volume","volume_valid_range_warning"),a,c);if(f<this.minExpandSizeGB||f>this.maxExpandSizeGB){this.getMsgBox().alert(_T("tree","leaf_volume"),d,function(){this.getField("size").markInvalid(d)},this)}else{b=true}return b},applySettings:function(b){var a=this;a.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"update",version:1,params:b,callback:function(d,c){this.clearStatusBusy();if(!d){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(c);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,c);return}if(0<b.mapped_targets.length){SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.StorageManager.ISCSI",false)}this.isDataChanged=true;this.close()},scope:a})},onCancel:function(){if(this.isDirty()){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()}});Ext.define("SYNO.SDS.StorageManager.Wizard.CloneLun",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,lun:null,volumes:null,targets:null,pool:null,constructor:function(a){var c=this,b;c.owner=a.owner;c.appWin=a.appWin;c.lun=a.lun;b={title:_T("common","alt_edit"),width:640,height:SYNO.SDS.StorageUtils.IsAnyMappedTargetConnected(c.lun.get("iscsi_lun"),c.appWin.iscsiTargets.getAll())?420:320,resizable:false,layout:"fit",plain:true,border:false,items:[new SYNO.SDS.StorageManager.Wizard.AdvFileLunProp({appWin:c.appWin,mode:"clone",data:a.data,lun:a.lun,snapshot:a.snapshot,action:a.action,itemId:"property",border:false,displayExtentLUNTip:true,hiddenFileLunSize:true})],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){this.callParent(arguments);this.getPropPanel().onEdit(this.lun);this.getPropPanel().getForm().setValues({name:this.appWin.genNewLunName()})},getPropPanel:function(){return this.getComponent("property")},isDirty:function(){if(this.getComponent("property").getForm().isDirty()){return true}return false},prepareCloneParams:function(){var b=this,d={},c=[],a=b.getPropPanel().getForm().getValues();b.getPropPanel().getComponent("mapping").getStore().each(function(e){if(e.get("checked")){c.push(e.get("tid"))}});d={iscsi_lun:{name:a.name,mapped_targets:c}};if("cloneSnapShot"===b.action){d.mode="clone";d.api="SYNO.Core.Storage.iSCSILUN";d.method="snapshot";d.parent_lun={lid:b.lun.getLunId(),sid:b.snapshot.sid}}else{d.api="SYNO.Core.Storage.iSCSILUN";d.method="clone";d.parent_lun={lid:b.lun.getLunId()}}return d},onSave:function(){var b=this,a=this.getPropPanel().getForm(),d=a.findField("fileLunSize"),c;if(true!==a.isValid()){if(!d.isValid()){this.getMsgBox().alert(this.title,d.getActiveError(),function(){this.close()},this)}return}b.setStatusBusy({text:_T("common","saving")});c=b.prepareCloneParams();this.sendWebAPI({api:c.api,method:c.method,version:1,params:c,callback:function(f,e){b.clearStatusBusy();if(!f){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,e);return}b.isDataChanged=true;b.close()},scope:b})},onCancel:function(){if(this.isDirty()){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()}});Ext.define("SYNO.SDS.StorageManager.Wizard.TakeSnapshot",{extend:"SYNO.SDS.ModalWindow",constructor:function(b){var e=this,c,a=SYNO.SDS.StorageUtils,d;e.appWin=b.appWin;e.owner=b.owner;e.lun=b.lun;e.mode=b.mode;d=("create"===e.mode&&a.IsAnyMappedTargetConnected(e.lun.get("iscsi_lun"),e.appWin.iscsiTargets.getAll()));c={title:b.title,width:550,height:d?450:250,resizable:false,buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:e,handler:e.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:e,handler:e.onCancel}],items:[e.createFrom(d)]};e.callParent([Ext.apply(c,b)])},getForm:function(){return this.getComponent("snapshot").getForm()},onOpen:function(){var a=this;a.callParent(arguments);a.initValues();a.addTip()},addTip:function(){var a=this;SYNO.SDS.Utils.AddTip(a.getForm().findField("lock").getEl(),Ext.util.Format.htmlEncode(_T("iscsilun","snapshot_lock_notify")))},initValues:function(){var c=this,a=SYNO.SDS.StorageManager.ISCSI.Util,b;if(c.IsCreateMode()){b=new Date();c.getForm().setValues({name:a.genNewSnapShotName(c.lun.get("iscsi_lun").snapshots),time:b.format("Y/m/d H:i:s"),type:"app"})}else{b=new Date(c.snapshot.time*1000);c.getForm().setValues(c.snapshot);c.getForm().setValues({time:b.format("Y/m/d H:i:s")})}},onCancel:function(){if(this.getForm().isDirty()){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()},createFrom:function(a){var c=this;var b={xtype:"form",itemId:"snapshot",border:false,trackResetOnLoad:true,defaults:{width:250,labelWidth:200},items:[{xtype:"syno_displayfield",name:"name",itemId:"name",submitValue:true,fieldLabel:_T("common","name")},{xtype:"syno_textfield",name:"desc",itemId:"desc",maxLength:1023,fieldLabel:_T("share","share_comment")},{xtype:"syno_displayfield",name:"time",fieldLabel:_T("time","time_time"),hideLabel:false},{xtype:"syno_combobox",name:"type",hiddenName:"type",itemId:"type",disabled:(c.IsCreateMode()?false:true),hidden:((a||c.IsEditMode())?false:true),fieldLabel:_T("iscsilun","snapshot_method"),store:[["app",_T("iscsilun","snapshot_application_consistent")],["crash",_T("iscsilun","snapshot_crash_consistent")]]},{xtype:"syno_combobox",name:"lock",hiddenName:"lock",itemId:"lock",disabled:false,hidden:false,fieldLabel:_T("iscsilun","snapshot_lock"),value:true,store:[[true,_T("common","yes")],[false,_T("common","no")]]},{xtype:"syno_displayfield",htmlEncode:false,width:510,hidden:a?false:true,value:String.format('<span class="red-status"> {0}</span>',String.format(_T("iscsilun","clone_snapshot_inconsistent_warning"),c.lun.get("iscsi_lun").name))}]};return b},IsCreateMode:function(){if("create"===this.mode){return true}return false},IsEditMode:function(){if("edit"===this.mode){return true}return false},prepareParams:function(){var e=this,d=e.getForm(),a=d.findField("name").getValue(),g=d.findField("desc").getValue(),c=d.findField("type").getValue(),b=d.findField("lock").getValue(),f;if(e.IsCreateMode()){f={mode:"create",plid:e.lun.get("iscsi_lun").lid,name:a,desc:g,type:c,lock:b}}else{f={mode:"edit",lid:e.lun.get("iscsi_lun").lid,sid:e.snapshot.sid,name:a,desc:g,type:c,lock:b}}return f},IsSnapShotCountExceeded:function(){var a=this.lun.get("iscsi_lun").snapshots.size();if(a>=_D("max_snapshot_per_lun","256")){return true}return false},IsVolumeEnoughForSnapshot:function(){var e=this.lun.get("iscsi_lun"),c=parseInt(e.size,10),b=SYNO.SDS.Utils.StorageUtils.ISCSIVAAILUN_EP_SIZE(c),d=this.appWin.volumes.data[e.location],a=parseInt(d.get("size").total,10)-parseInt(d.get("size").used,10);if(a<=0||b>a){return false}return true},onSave:function(){var c=this,a=String.format(_T("iscsilun","iscsitrg_max_snapshot_per_lun"),_D("max_snapshot_per_lun","256")),b=c.getForm();if(c.IsEditMode()&&!b.isDirty()){c.close();return}if(!b.isValid()){return}if("create"===c.mode){if(c.IsSnapShotCountExceeded()){this.getMsgBox().alert(this.title,a,function(){c.close()});return}if(!c.IsVolumeEnoughForSnapshot()){this.getMsgBox().alert(this.title,_T("iscsitrg","iscsitrg_set_failed_space_not_enough"),function(){c.close()});return}}this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"snapshot",version:1,params:this.prepareParams(),callback:function(e,d){this.clearStatusBusy();if(!e){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);return}this.isDataChanged=true;this.close()},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.Snapshot",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:a.title,layout:"fit",items:[],minWidth:500,minHeight:300,width:700,height:450,buttons:[{text:_T("common","alt_close"),scope:this,handler:this.onCancel}]};c.callParent([Ext.apply(b,a)])},initComponent:function(){this.items.push(this.createPanel());this.callParent(arguments)},getGrid:function(){return this.get("snapshots")},getButton:function(a){return this.getGrid().getTopToolbar().get(a)},initEvents:function(){this.callParent(arguments);this.mon(this.getGrid().getStore(),"update",this.onSelection,this);this.mon(this.getGrid().getStore(),"load",this.onSelection,this)},onSelection:function(c){var d=c.query("enabled",true),e=false,b=SYNO.SDS.StorageManager.ISCSI.Util,a;d.each(function(f){if("Healthy"!==f.data.status.type&&"Unhealthy"!==f.data.status.type){e=true;return false}});if(0!==d.getCount()&&false===e){this.getButton("btDelete").enable()}else{this.getButton("btDelete").disable()}if(1===d.getCount()&&false===e){this.getButton("btEdit").enable()}else{this.getButton("btEdit").disable()}this.getButton("btClone").disable();this.getButton("btRestore").disable();if(1!==d.getCount()||e||b.isUpToiSCSISnapShotActionCount(this.appWin.iscsiLuns.getAll())){return}a=d.get(0);if("Healthy"!==a.data.status.type){return}if(!this.lun.isActioning()&&!this.lun.isSinkLun()){this.getButton("btRestore").enable()}if(!this.owner.isUpToiSCSILunMaxCount()){this.getButton("btClone").enable()}return},onOpen:function(){var a=this;a.callParent(arguments);a.startPollingTask()},onCancel:function(){this.close()},startPollingTask:function(){var a=this;if(!Ext.isDefined(a.storePollingTask)){a.storePollingTask=a.addWebAPITask({api:"SYNO.Core.Storage.iSCSILUN",method:"load_snapshot",version:1,params:{lid:a.lun.get("iscsi_lun").lid},interval:5000,callback:function(c,b){if(!c){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,b);return}a.loadGrid({data:b})},scope:a})}if(true!==a.storePollingTask.running){a.setLoadingMask();a.storePollingTask.start()}},stopPollingTask:function(){var a=this.storePollingTask;if(Ext.isDefined(a)&&true===a.running){a.stop()}},setLoadingMask:function(){this.setStatusBusy({text:_T("common","loading")});this.loadingMask=true},clearLoadingMask:function(){var a=this;if(true===a.loadingMask){a.clearStatusBusy();a.loadingMask=false}},loadGrid:function(d){var c=this,a=c.getGrid().getStore(),b=a.query("enabled",true);Ext.each(d.data,function(e){if(Ext.isDefined(b.key(e.sid))){e.enabled=true}else{e.enabled=false}});a.loadData(d);c.clearLoadingMask()},createPanel:function(){var e=this;var f=new SYNO.ux.EnableColumn({dataIndex:"enabled",width:40,align:"center",commitChanges:false,bindRowClick:true,enableFastSelectAll:true,fixed:true});var a=new Ext.data.JsonStore({autoDestroy:true,pruneModifiedRecords:true,sortInfo:{field:"time",direction:"DESC"},idProperty:"sid",root:"data",fields:["enabled","sid","name","desc","time","status","canClone","type","lock"]});var d=[f,{id:"name",header:_T("common","name"),width:90,dataIndex:"name"},{id:"snapshot_method",header:_T("iscsilun","snapshot_method"),dataIndex:"type",renderer:function(h){return("app"===h?_T("iscsilun","snapshot_application_consistent"):_T("iscsilun","snapshot_crash_consistent"))}},{id:"desc",header:_T("share","share_comment"),dataIndex:"desc",renderer:SYNO.SDS.StorageUtils.TipRenderer},{id:"time",header:_T("time","time_time"),dataIndex:"time",width:155,renderer:function(i){var h=new Date(i*1000);return h.format("Y/m/d H:i:s")}},{id:"status",header:_T("iscsitrg","iscsitrg_status"),dataIndex:"status",width:70,renderer:SYNO.SDS.StorageUtils.SnapShotStatusRender},{id:"lock",header:_T("iscsilun","snapshot_lock"),dataIndex:"lock",width:40,renderer:function(h){return(true===h?'<div class="sm-snapshot-lun-lock"></div>':"")}}];var g={defaultType:"syno_button",items:[{text:_T("iscsilun","clone"),itemId:"btClone",handler:this.snapshotClone,disabled:true,scope:this},{text:_T("common","remove"),itemId:"btDelete",handler:this.snapshotDelete,disabled:true,scope:this},{text:_T("iscsilun","restore"),itemId:"btRestore",handler:this.snapshotRestore,disabled:true,scope:this},{text:_T("common","alt_edit"),itemId:"btEdit",handler:this.snapshotEdit,disabled:true,scope:this}]};var c={forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(h){h.scrollTop=h.scroller.dom.scrollTop},refresh:function(h){h.scroller.dom.scrollTop=h.scrollTop}}};var b={layout:"fit",xtype:"syno_gridpanel",itemId:"snapshots",style:{padding:"0px 12px 0px 16px"},tbar:g,plugins:f,store:a,columns:d,enableHdMenu:false,autoExpandColumn:"desc",viewConfig:c,enableColumnMove:false,cls:"without-dirty-red-grid"};f.onSelectAll=function(){SYNO.ux.EnableColumn.prototype.onSelectAll.apply(this);e.onSelection(a)};return b},snapshotClone:function(){var a=this.getGrid().getStore().query("enabled",true).get(0).data;if(!a.canClone){this.getMsgBox().alert(this.title,_T("iscsitrg","iscsitrg_set_failed_space_not_enough"));return}var b=new SYNO.SDS.StorageManager.Wizard.CloneLun({owner:this,appWin:this.appWin,title:_T("iscsilun","clone"),lun:this.lun,snapshot:a,action:"cloneSnapShot"});b.mon(b,"close",function(){if(b.isDataChanged){this.isDataChanged=true;this.close()}},this,{single:true});b.open()},snapshotDelete:function(){this.getMsgBox().confirm(this.title,_T("common","remove_cfrmrmv"),function(a){if("yes"===a){this.doSnapshotDelete()}},this)},doSnapshotDelete:function(){var b=this,c=b.getGrid().getStore().query("enabled",true),a=[];this.setStatusBusy({text:_T("common","saving")});c.each(function(d){a.push(d.get("sid"))});b.stopPollingTask();this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"snapshot",version:1,params:{mode:"delete",lid:this.lun.get("iscsi_lun").lid,sids:a},callback:function(e,d){this.clearStatusBusy();this.startPollingTask();if(!e){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);return}this.isDataChanged=true},scope:this})},snapshotRestore:function(){var c=this,e=c.getGrid().getStore().query("enabled",true).get(0),d='<span class="red-status">'+String.format(_T("iscsilun","restore_data_lost_warning"),e.get("name"))+"</span><br/>"+String.format(_T("iscsilun","snapshot_restore_confirm"),e.get("name")),a=SYNO.SDS.StorageUtils,f=c.lun.get("iscsi_lun");if(a.IsAnyMappedTargetConnected(f,c.appWin.iscsiTargets.getAll())){var b=String.format('<span class="red-status"> {0} </span><br/><br/>',String.format(_T("iscsilun","online_restore_warning"),c.lun.get("iscsi_lun").name));d=b+d}if(!e.get("canClone")){this.getMsgBox().alert(this.title,_T("iscsitrg","iscsitrg_set_failed_space_not_enough"));return}this.getMsgBox().confirm(this.title,d,function(g){if("yes"===g){this.doSnapshotRestore()}},this)},doSnapshotRestore:function(){var a=this,b=a.getGrid().getStore().query("enabled",true).get(0);a.setStatusBusy({text:_T("common","msg_waiting")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"snapshot",version:1,params:{mode:"restore",lid:this.lun.get("iscsi_lun").lid,sid:b.get("sid")},callback:function(d,c){this.clearStatusBusy();if(!d){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,c);this.close();return}this.isDataChanged=true;this.close()},scope:this})},snapshotEdit:function(){var a=this.getGrid().getStore().query("enabled",true).get(0).data;var b=new SYNO.SDS.StorageManager.Wizard.TakeSnapshot({owner:this,appWin:this.appWin,title:_T("common","alt_edit"),lun:this.lun,mode:"edit",snapshot:a});b.mon(b,"close",function(){if(b.isDataChanged){this.isDataChanged=true;this.setLoadingMask()}},this,{single:true});b.open()}});SYNO.SDS.StorageManager.RTT_ALL=0;SYNO.SDS.StorageManager.RTT_POL_TIME=1;SYNO.SDS.StorageManager.RTT_DEL_OLD=16;Ext.define("SYNO.SDS.StorageManager.Wizard.ScheduleSnapshot",{extend:"SYNO.SDS.ModalWindow",max_snapshot_per_lun:_D("max_snapshot_per_lun","256"),constructor:function(a){var d=this,b=[];d.owner=a.owner;d.appWin=a.appWin;d.lun=a.lun;d.type="Lun";b.push(new SYNO.SDS.StorageManager.Wizard.ScheduleSnapshot.Schedule({appWin:d.appWin,owner:d}));b.push(new SYNO.SDS.StorageManager.Wizard.ScheduleSnapshot.Retention({appWin:d.appWin,owner:d}));b.push(new SYNO.SDS.StorageManager.Wizard.ScheduleSnapshot.Application({appWin:d.appWin,owner:d}));d.tabPanel=new SYNO.SDS.Utils.TabPanel({appWin:d.appWin,owner:d.owner,activeTab:0,items:b});var c={items:[d.tabPanel],width:600,height:460,minWidth:600,minHeight:460,buttons:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","alt_apply"),scope:d,handler:d.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:d,handler:d.onCancel}]};d.callParent([Ext.apply(c,a)]);d.getiSCSILunScheData();if(d.lun.isSinkLun()){d.tabPanel.get("scheduleSnapshot").setDisabled(true);d.tabPanel.get("lunApplication").setDisabled(true);d.tabPanel.setActiveTab("retentionSnapshot")}},getForm:function(a){return this.tabPanel.getItem(a).getForm()},onSave:function(){var b=this,a=b.getForm("retentionSnapshot"),c=_T("snapmgr","err_max_rtt_cfg");if(!a.isValid()){b.tabPanel.setActiveTab("retentionSnapshot");return}if(!b.isRTTCfgValid()){b.tabPanel.setActiveTab("retentionSnapshot");b.getMsgBox().alert(_T("snapmgr","app_title"),String.format(c,b.max_snapshot_per_lun));return}if(a.isDirty()&&(SYNO.SDS.StorageManager.RTT_ALL!==a.findField("policyType").getGroupValue())){b.getMsgBox().confirm(_T("snapmgr","set_schedule"),_T("snapmgr","run_retention_immed"),function(d){if("ok"===d){b.setiSCSILunConf()}},b,Ext.MessageBox.OKCANCEL)}else{b.setiSCSILunConf()}},isRTTCfgValid:function(){var d=this,c=d.getForm("retentionSnapshot"),b=0;var a=function(e){return c.findField(e).getValue()};b=a("hourly")+a("daily")+a("weekly")+a("monthly")+a("yearly");if(b>d.max_snapshot_per_lun){return false}return true},setiSCSILunConf:function(){var b=this,a=b.getGeneralData(),c=b.getScheData();b.setStatusBusy({text:_T("common","msg_waiting")});b.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"set_sched_snapshot",version:1,params:{lid:b.lun.get("iscsi_lun").lid,general:a,schedule:c},callback:function(f,d){if(!f){var e=_T("snapmgr","err_set_sche");b.clearStatusBusy();b.getMsgBox().alert(_T("snapmgr","set_schedule"),e,function(){b.close()},b);b.setStatusError({text:e,clear:true});return false}else{b.setRetention()}},scope:b})},onCancel:function(){this.close()},getiSCSILunScheData:function(){var a=this;a.setStatusBusy({text:_T("common","msg_waiting")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"load_sched_snapshot",version:1,params:{lid:a.lun.get("iscsi_lun").lid},callback:function(e,c){var b={};if(!e){var d=_T("snapmgr","err_get_sche");a.clearStatusBusy();a.getMsgBox().alert(_T("snapmgr","set_schedule"),d,function(){a.close()},a);a.setStatusError({text:d,clear:true});return}else{a.processLunResp(c[0],b);a.tabPanel.items.each(function(f){if(Ext.isFunction(f.updateScheData)){f.updateScheData(b)}},a);a.getRetention()}},scope:a})},processLunResp:function(b,a){a.enable_snapshot_schedule=b.general.task_enabled;a.tid=b.general.tid;a.task_name=b.general.task_name;a.enable_app_consist=("crash"===b.general.snap_type)?false:true;a.schedule=b.schedule},setRetention:function(){var b=this,a=b.tabPanel.getItem("retentionSnapshot").getForm();if(!a.isDirty()){b.clearStatusBusy();b.close();return}var c={type:b.type,name:b.lun.get("iscsi_lun").lid.toString(),policyType:a.findField("policyType").getGroupValue(),hourly:a.findField("hourly").getValue(),daily:a.findField("daily").getValue(),weekly:a.findField("weekly").getValue(),monthly:a.findField("monthly").getValue(),yearly:a.findField("yearly").getValue()};b.sendWebAPI({api:"SYNO.DisasterRecovery.Retention",method:"set",version:1,params:c,scope:b,callback:function(g,e,d){b.clearStatusBusy();if(!g){var f=b.getErrMsg(e.code);b.getMsgBox().alert(_T("snapmgr","set_schedule"),f,function(){b.close()},b);b.setStatusError({text:f,clear:true});return}else{b.close()}}})},getRetention:function(){var a=this;a.sendWebAPI({api:"SYNO.DisasterRecovery.Retention",method:"get",version:1,params:{type:a.type,name:a.lun.get("iscsi_lun").lid.toString()},scope:a,callback:function(e,c,b){a.clearStatusBusy();if(!e){var d=a.getErrMsg(c.code);a.getMsgBox().alert(_T("snapmgr","set_schedule"),d,function(){a.close()},a);a.setStatusError({text:d,clear:true});return}else{a.tabPanel.items.each(function(f){if(Ext.isFunction(f.updateRetData)){f.updateRetData(c)}},a)}}})},getGeneralData:function(){var b=this,a={};var d=b.tabPanel.getItem("scheduleSnapshot").getForm(),c=b.tabPanel.getItem("lunApplication").getForm();a.task_enabled=d.findField("enable_snapshot_schedule").getValue();a.task_name=d.findField("task_name").getValue();a.tid=d.findField("tid").getValue();a.snap_type=c.findField("enable_app_consist").getValue()?"app":"crash";return a},getScheData:function(){var c=this,b=c.tabPanel.getItem("scheduleSnapshot"),a={};a.date_type=0;a.week_name=Ext.getCmp(b.week_name_id).getValue();a.hour=Ext.getCmp(b.hour_id).getValue();a.min=Ext.getCmp(b.min_id).getValue();a.repeat_hour=Ext.getCmp(b.repeat_hour_id).getValue()%100;a.repeat_min=parseInt(Ext.getCmp(b.repeat_hour_id).getValue()/100,10);a.last_work_hour=Ext.getCmp(b.last_work_hour_id).getValue();return a},getErrMsg:function(a){var b;switch(a){case 1001:b=_T("s2s","err_invalid_param_value");break;case 1002:b=_T("snapmgr","err_get_ret_policy");break;case 1003:b=_T("snapmgr","err_set_ret_policy");break;default:b=_T("common","error_system");break}return b}});Ext.define("SYNO.SDS.StorageManager.Wizard.ScheduleSnapshot.Schedule",{extend:"SYNO.SDS.TaskScheduler2.EditSchedulePanel",constructor:function(){var a=this;a.callParent(arguments);a.mon(a,"afterlayout",function(){a.dummy1=new SYNO.ux.Utils.EnableCheckGroup(a.form,"enable_snapshot_schedule",[a.week_name_id,a.hour_id,a.min_id,a.repeat_hour_id,a.last_work_hour_id])},a,{single:true})},fillConfig:function(e){var f=this,d;var g=[];var c=[];for(d=0;d<24;++d){g.push([String.leftPad(String(d),2,"0"),d])}var h=new Ext.data.ArrayStore({fields:["display","value"],data:g});f.addManagedComponent(h);for(d=0;d<60;++d){c.push([String.leftPad(String(d),2,"0"),d])}var a=new Ext.data.ArrayStore({fields:["display","value"],data:c});f.addManagedComponent(a);f.repeat_hour_store=new Ext.data.ArrayStore({fields:["display","value"]});f.addManagedComponent(f.repeat_hour_store);f.last_work_hour_store=new Ext.data.ArrayStore({fields:["display","value"]});f.addManagedComponent(f.last_work_hour_store);var b={title:_T("common","schedule"),itemId:"scheduleSnapshot",border:false,MinInterval:[5,15,30],HourInterval:[1,2,3,4,6,8,12],items:[{xtype:"syno_numberfield",name:"tid",hidden:true},{xtype:"syno_displayfield",name:"task_name",hidden:true},{xtype:"syno_checkbox",name:"enable_snapshot_schedule",boxLabel:_T("iscsilun","snapshot_schedule_enable")},{xtype:"syno_compositefield",fieldLabel:_T("snapmgr","sche_exec_day"),labelWidth:180,width:200,indent:1,items:[{xtype:"syno_schedulefield",id:f.week_name_id=Ext.id(),hideLabel:true,allowBlank:false,editable:false,width:200}]},{xtype:"syno_combobox",store:f.repeat_hour_store,value:0,fieldLabel:_T("snapmgr","sche_repeat_every"),labelWidth:180,displayField:"display",valueField:"value",id:f.repeat_hour_id=Ext.id(),triggerAction:"all",width:200,mode:"local",editable:false,indent:1,listeners:{select:{fn:function(){f.updateLastWorkTimeStore()},scope:f}}},{xtype:"syno_compositefield",fieldLabel:_T("snapmgr","sche_start_at"),labelWidth:180,width:200,indent:1,items:[{xtype:"syno_combobox",store:h,displayField:"display",id:f.hour_id=Ext.id(),valueField:"value",triggerAction:"all",mode:"local",width:92,editable:false,listeners:{select:{fn:function(){f.updateRepeatHourStore();f.updateLastWorkTimeStore()},scope:f}}},{xtype:"syno_displayfield",value:":"},{xtype:"syno_combobox",store:a,displayField:"display",valueField:"value",id:f.min_id=Ext.id(),triggerAction:"all",width:93,mode:"local",editable:false,listeners:{select:{fn:function(){f.updateLastWorkTimeStore()},scope:f}}}]},{xtype:"syno_combobox",store:f.last_work_hour_store,value:0,labelWidth:180,fieldLabel:_T("snapmgr","sche_repeat_until"),displayField:"display",valueField:"value",id:f.last_work_hour_id=Ext.id(),triggerAction:"all",width:200,mode:"local",editable:false,indent:1}]};Ext.apply(b,e);return b},updateLastWorkTimeStore:function(){var a=this;a.callParent(arguments);if(!a.form.findField("enable_snapshot_schedule").getValue()){Ext.getCmp(a.min_id).disable(false)}if(a.last_work_hour_store.totalLength>0){Ext.getCmp(a.last_work_hour_id).setValue(a.last_work_hour_store.getAt(a.last_work_hour_store.totalLength-1).data.value)}},updateScheData:function(b){var a=this,c=b.schedule;Ext.getCmp(a.form.findField("tid").setValue(b.tid));Ext.getCmp(a.form.findField("task_name").setValue(b.task_name));Ext.getCmp(a.week_name_id).setValue(c.week_name);a.form.findField("enable_snapshot_schedule").setValue(b.enable_snapshot_schedule);Ext.getCmp(a.hour_id).setValue(c.hour);Ext.getCmp(a.min_id).setValue(c.min);a.updateRepeatHourStore();Ext.getCmp(a.repeat_hour_id).setValue(c.repeat_hour+c.repeat_min*100);a.updateLastWorkTimeStore();Ext.getCmp(a.last_work_hour_id).setValue(c.last_work_hour)}});Ext.define("SYNO.SDS.StorageManager.Wizard.ScheduleSnapshot.Retention",{extend:"SYNO.ux.FormPanel",MAX_RET_HOURLY:256,MAX_RET_DAILY:256,MAX_RET_WEEKLY:256,MAX_RET_MONTHLY:120,MAX_RET_YEARLY:10,constructor:function(a){var c=this,b;b={title:_T("snapmgr","ret_title"),itemId:"retentionSnapshot",trackResetOnLoad:true,items:[{xtype:"syno_displayfield",value:_T("snapmgr","ret_desp")},{xtype:"syno_radio",name:"policyType",boxLabel:_T("snapmgr","ret_del_old"),inputValue:SYNO.SDS.StorageManager.RTT_DEL_OLD},{xtype:"syno_radio",name:"policyType",id:"ret_all",boxLabel:_T("snapmgr","ret_all_desc"),inputValue:SYNO.SDS.StorageManager.RTT_ALL},{xtype:"syno_radio",name:"policyType",id:"ret_policy",boxLabel:_T("snapmgr","ret_pol_desc"),inputValue:SYNO.SDS.StorageManager.RTT_POL_TIME},{xtype:"syno_compositefield",hideLabel:true,height:28,indent:1,items:[{xtype:"syno_numberfield",value:0,width:90,name:"hourly",me:c,id:c.ret_hourly_id=Ext.id(),minValue:0,maxValue:c.MAX_RET_HOURLY,enableKeyEvents:true,listeners:{keypress:function(f,d){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){d.stopEvent()}},disable:function(){this.reset()}}},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_hourly")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,indent:1,items:[{xtype:"syno_numberfield",value:0,width:90,name:"daily",me:c,id:c.ret_daily_id=Ext.id(),minValue:0,maxValue:c.MAX_RET_DAILY,enableKeyEvents:true,listeners:{keypress:function(f,d){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){d.stopEvent()}},disable:function(){this.reset()}}},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_daily")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,indent:1,items:[{xtype:"syno_numberfield",value:0,width:90,name:"weekly",me:c,id:c.ret_weekly_id=Ext.id(),minValue:0,maxValue:c.MAX_RET_WEEKLY,enableKeyEvents:true,listeners:{keypress:function(f,d){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){d.stopEvent()}},disable:function(){this.reset()}}},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_weekly")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,indent:1,items:[{xtype:"syno_numberfield",value:0,width:90,name:"monthly",me:c,id:c.ret_monthly_id=Ext.id(),minValue:0,maxValue:c.MAX_RET_MONTHLY,enableKeyEvents:true,listeners:{keypress:function(f,d){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){d.stopEvent()}},disable:function(){this.reset()}}},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_monthly")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,indent:1,items:[{xtype:"syno_numberfield",value:0,width:90,name:"yearly",me:c,id:c.ret_yearly_id=Ext.id(),minValue:0,maxValue:c.MAX_RET_YEARLY,enableKeyEvents:true,listeners:{keypress:function(f,d){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){d.stopEvent()}},disable:function(){this.reset()}}},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_yearly")}]}]};c.callParent([Ext.apply(b,a)]);c.mon(c,"afterlayout",function(){var d={};d[SYNO.SDS.StorageManager.RTT_DEL_OLD]=[];d[SYNO.SDS.StorageManager.RTT_ALL]=[];d[SYNO.SDS.StorageManager.RTT_POL_TIME]=[c.ret_hourly_id,c.ret_daily_id,c.ret_weekly_id,c.ret_monthly_id,c.ret_yearly_id];c.dummy1=new SYNO.ux.Utils.EnableRadioGroup(c.form,"policyType",d);SYNO.SDS.Utils.AddTip(Ext.getCmp("ret_all").getEl(),Ext.util.Format.htmlEncode(_T("snapmgr","ret_all_tip")));SYNO.SDS.Utils.AddTip(Ext.getCmp("ret_policy").getEl(),Ext.util.Format.htmlEncode(_T("snapmgr","ret_all_tip")))},c,{single:true})},updateRetData:function(a){this.form.setValues(a)}});Ext.define("SYNO.SDS.StorageManager.Wizard.ScheduleSnapshot.Application",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=_D("upnpmodelname","");var d=String.format(_T("snapmgr","app_link"),c);var b={title:_T("snapmgr","application"),itemId:"lunApplication",items:[{xtype:"syno_checkbox",name:"enable_app_consist",boxLabel:_T("snapmgr","app_desc")},{xtype:"syno_displayfield",htmlEncode:false,value:d}]};this.callParent([Ext.apply(b,a)])},updateScheData:function(a){Ext.getCmp(this.form.findField("enable_app_consist").setValue(a.enable_app_consist))}});Ext.define("SYNO.SDS.StorageManager.Wizard.SnapshotManager",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:a.title,layout:"fit",items:[],minWidt:500,minHeight:300,width:600,height:450,buttons:[{text:_T("common","alt_close"),scope:this,handler:this.onCancel}]};c.callParent([Ext.apply(b,a)])},initComponent:function(){this.items.push(this.createPanel());this.callParent(arguments)},createPanel:function(){var a=new Ext.data.JsonStore({autoDestroy:true,root:"data",fields:["ip","type"]});var d=[{id:"ip",header:_T("common","ip_addr"),dataIndex:"ip"},{id:"type",header:_T("network","interface_type"),dataIndex:"type",renderer:function(e){return _T("iscsilun",e)}}];var c={forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(e){e.scrollTop=e.scroller.dom.scrollTop},refresh:function(e){e.scroller.dom.scrollTop=e.scrollTop}}};var b={layout:"fit",xtype:"syno_gridpanel",itemId:"plugins",style:{padding:"0px 12px 0px 16px"},store:a,columns:d,enableHdMenu:false,viewConfig:c,enableColumnMove:false,cls:"without-dirty-red-grid"};return b},onOpen:function(){var a=this;a.callParent(arguments);a.startPollingTask()},onCancel:function(){this.close()},startPollingTask:function(){var a=this;if(!Ext.isDefined(a.storePollingTask)){a.storePollingTask=a.addWebAPITask({api:"SYNO.Core.Storage.iSCSIUtils",method:"load_plugin",version:1,interval:5000,callback:function(c,b){if(!c){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,b);return}a.loadGrid({data:b})},scope:a})}if(true!==a.storePollingTask.running){a.setLoadingMask();a.storePollingTask.start()}},stopPollingTask:function(){var a=this.storePollingTask;if(Ext.isDefined(a)&&true===a.running){a.stop()}},loadGrid:function(c){var b=this;var a=b.get("plugins").getStore();a.loadData(c);b.clearLoadingMask()},setLoadingMask:function(){this.setStatusBusy({text:_T("common","loading")});this.loadingMask=true},clearLoadingMask:function(){var a=this;if(true===a.loadingMask){a.clearStatusBusy();a.loadingMask=false}}});Ext.namespace("SYNO.SDS.StorageManager.iSCSILun.Dialog");Ext.define("SYNO.SDS.StorageManager.Wizard.AdvLunProp",{extend:"SYNO.ux.FormPanel",activate:function(){this.extent_size_editable=false;if(this.setDefault){this.setSizeCmp();this.setLocationCmp();this.setDefaultSize();this.setMappingCmp();this.setDefault=false;if(this.addTip){this.addTip()}if(this.extentSizeGet){this.extentSizeGet(this.vol_store.getAt(0).id.toString())}}},onEdit:function(a){if(a.isCrashed()||a.isSinkLun()){this.getMappingCmp().disable()}},configPropForm:function(){var e=this,a,d;var f='<div style="height: 143px;position: relative;"><div class="sm-iscsi-lun-property-frame">{0}{1}</div></div>';var c='<div style="font-weight: bold;line-height: 20px;padding: 8px 12px 4px 12px;">'+_T("iscsitrg","iscsitrg_use_vaai_or_not_title")+"</div>";var b='<div style="width: 570px;line-height: 18px;padding: 0px 12px 8px 12px">'+_T("iscsitrg","iscsitrg_use_vaai_or_not_description")+"</div>";a={headline:_T("volume","volume_set_iscsitrg_property_title"),labelWidth:280,fieldWidth:280,trackResetOnLoad:true,items:[]};a.items.push({xtype:"syno_textfield",fieldLabel:_T("common","name"),maxlength:128,allowBlank:false,vtype:"iscsilunname",name:"name",itemId:"name",value:this.appWin.genNewLunName(),appWin:this.appWin,validator:function(g){if(g===this.originalValue){return true}else{if(this.appWin.isUniqueLunName(g)){return true}else{return _T("iscsitrg","iscsitrg_lun_name_exists")}}}},{xtype:"syno_storage_combobox",itemId:"location",name:"location",hiddenName:"location",fieldLabel:_T("volume","volume_raid_location"),lazyRender:true,editable:false,mode:"local",forceSelection:true,allowBlank:false,valueField:"id",displayField:"display",descriptionField:"desc",store:this.vol_store=new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:["id","display","name","desc","available","type","raid_type"]}),listeners:{select:function(k,l,h){if("create"===this.mode&&this.isBlockLun){this.setDefaultSize()}if("edit"===this.mode&&!this.isBlockLun){var g=this.getComponent("thin_provision");if(g.disabled&&g.originalValue){g.setValue(l.id===k.originalValue)}}this.getForm().isValid();if(!this.isBlockLun){var j=this;j.isExtentBased=("yes"===_D("support_vaai","no"));var i=j.getComponent("location").store.getAt(h).id.toString();this.extentSizeGet(i)}},scope:this}});this.configField(a);a.items.push({xtype:"syno_combobox",itemId:"mapping",name:"mapping",hiddenName:"mapping",labelStyle:"margin-left: 0px; width: 180px;",triggerAction:"all",grow:true,maxHeight:360,resizable:false,editable:false,fieldLabel:_T("iscsitrg","iscsitrg_mapped_target"),emptyText:_T("volume","volume_status_none"),store:new Ext.data.JsonStore({autoDestroy:true,idProperty:"tid",fields:["checked","tid","name","mapLunExceed","original","ckeckedClass"]}),displayField:"name",valueField:"tid",mode:"local",tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item">','<div class="x-form-check-wrap">','<input type="button" id="sm-lun-prop-trg-map-{tid}" class="syno-ux-checkbox-icon {ckeckedClass}" style="margin-left: 0px;">','<label ext:qtip="{name}" style="line-height:22px;margin-left:28px;">{name}</label>',"</div>","</div>","</tpl>"),selectOnFocus:true,onSelect:function(k,i){var h;var j=_T("iscsitrg","iscsitrg_max_lun_per_target");j=String.format(j,SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS,k.get("name"));var g=!k.get("checked");if(true===k.get("mapLunExceed")&&true===g&&false===k.get("original")){if(Ext.isDefined(e.ownerCt.getMsgBox)){h=e.ownerCt.getMsgBox()}else{if(Ext.isDefined(e.owner.getMsgBox)){h=e.owner.getMsgBox()}else{return}}h.alert(e.ownerCt.title||e.owner.title,j);return}k.set("checked",g);k.set("ckeckedClass",g?"syno-ux-cb-checked":"");this.setValue(this.getDisplayVaule())},getDisplayVaule:function(){var g=[];this.store.each(function(h){if(h.get("checked")){g.push(h.get("name"))}});Ext.QuickTips.unregister(this.getEl());if(0<g.length){Ext.QuickTips.register({target:this.getEl(),title:"",text:g.join(",<br>")})}if(0===g.length){return _T("volume","volume_status_none")}else{return g.join(", ")}}});d={hidden:!this.isExtentBased,html:String.format(f,c,b),border:false};if("create"===e.mode){a.items.push(d)}return a},extentLUNConfigSetup:function(a){var b=this,c;if(!a.success){if(b.isExtentBased){b.getComponent("extent_size").enable();b.extent_size_editable=true}}else{c=parseInt(a.extent_size,10);b.getComponent("extent_size").setValue(c);b.getComponent("extent_size").disable();b.extent_size_editable=false}},setLocationCmp:function(f,a){var e=this,b=[],g,d,c,h;b=e.prepareLocationData(f);e.getLocCmp().store.loadData(b,false);if(!e.isBlockLun){g=e.getForm().findField("extent_based").getValue();d=e.getLocCmp().getValue();c=e.appWin.volumes.data[d]}h=e.getLocCmp().store.getAt(0);if(h===undefined){if(a){e.owner.getMsgBox().alert(e.owner.title,_T("iscsilun","iscsilun_vaai_lun_fs_warning"))}e.getExtentLUNCmp().setValue(false);e.setLocationCmp()}else{if(!e.isBlockLun&&c!==undefined){if(g&&"ext4"!==c.get("fs_type")&&"btrfs"!==c.get("fs_type")){e.getLocCmp().setValue(h.id)}}else{e.getLocCmp().setValue(h.id)}}},setMappingCmp:function(e){var d=this,b=d.appWin.iscsiTargets.getAll(),a=[],c;Ext.each(b,function(f){switch(f.get("status")){case"deleting":case"creating":return true}if(e&&"edit"===d.mode){c=-1<e.get("iscsi_lun").mapped_targets.indexOf(f.id)}else{c=false}a.push({checked:c,ckeckedClass:c?"syno-ux-cb-checked":"",original:c,tid:f.id,name:f.get("name"),mapLunExceed:(f.get("mapped_luns").length>=SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS)})},d);d.getMappingCmp().getStore().loadData(a,false);d.getMappingCmp().setValue(_T("volume","volume_status_none"))},onLocationChanged:function(){this.setDefaultSize()},getLocCmp:function(){return this.getComponent("location")},getMappingCmp:function(){return this.getComponent("mapping")},getNext:function(){if(!this.getForm().isValid()){return false}return"summary"},summary:function(c){c.append(_T("common","name"),this.getComponent("name").getValue());var a=this.getLocCmp().store.getById(this.getLocCmp().getValue()).get("name");c.append(_T("volume","volume_raid_location"),a);if(!this.isBlockLun){c.append(_T("iscsitrg","iscsitrg_thin_provisioning"),true===this.getThinCmp().getValue()?_T("common","yes"):_T("common","no"));if("yes"===_D("support_vaai","no")){c.append(_T("iscsitrg","iscsitrg_vaai"),"true"===this.getForm().getValues().extent_based?_T("common","yes"):_T("common","no"));if("true"===this.getForm().getValues().extent_based){var d=this.getForm().findField("extent_size").getValue();c.append(_T("iscsitrg","iscsitrg_vaai_extent_size"),(d/1024).toString().concat("k"))}}}c.append(_T("volume","volume_totalsize"),String.format("{0} ({1})",this.sizeCmp.getValue(),_T("common","size_gb")));var b=this.getComponent("mapping").getValue();b=""===b?_T("volume","volume_status_none"):b;c.append(_T("iscsitrg","iscsitrg_mapped_target"),b)}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvBlockLunProp",{extend:"SYNO.SDS.StorageManager.Wizard.AdvLunProp",constructor:function(a){var c=this,b;c.maxFreeSizeGB=0;c.maxFreeSizeByte=0;c.isBlockLun=true;c.setDefault=true;c.sizeTextChanged=false;c.mode="create";c.sizeCmp=undefined;c.appWin=a.appWin;c.owner=a.owner;b=c.configPropForm();c.callParent([Ext.apply(b,a)])},configField:function(a){a.items.push({layout:"hbox",itemId:"size_panel",border:false,fieldLabel:String.format("{0} ({1})",_T("common","size"),_T("common","size_gb")),labelStyle:"line-height: 28px;padding:0px;",bodyStyle:{padding:"0px 0px 0px 0px"},items:[{xtype:"syno_numberfield",name:"blockLunSize",itemId:"blockLunSize",value:0,width:280,allowDecimals:true,allowBlank:false,validator:function(e){if(0===parseInt(e,10)){return true}var c;if(this.ownerCt&&this.ownerCt.ownerCt){c=this.ownerCt.ownerCt}else{return"Failed to find ownerCt"}var b=SYNO.SDS.StorageUtils.ISCSITRG_UNIT_GB;var g=c.get("location").getValue();var d=c.get("location").getStore().getById(g);var f;if(!Ext.isDefined(d)){return true}if(e<this.originalValue||e===0){return _T("iscsitrg","iscsitrg_size_too_small")}f=c.get("location").originalValue!==g;if(e*b+d.get("size_used")-(f?0:this.originalValue*b)>d.get("size_total")){return _T("iscsitrg","iscsitrg_set_failed_space_not_enough")}return true}},{xtype:"syno_displayfield",width:10,value:" "},{xtype:"syno_button",itemId:"size_max",text:_T("common","max"),handler:function(c,b){this.sizeCmp.setValue(this.sizeCmp.maxValue)},scope:this}]})},onEdit:function(c){var b=this,a;b.setSizeCmp();b.setLocationCmp(true);b.setDefaultSize(c);b.setMappingCmp(c);b.getLocCmp().disable();a=b.appWin.storagePools.data[c.get("pool_path")];if("single"===a.get("raidType")){b.getComponent("size_panel").getComponent("size_max").disable()}b.loadForm(c);if(_S("ha_running")){b.getComponent("name").disable()}b.callParent([c])},loadForm:function(j){var f=this,h=SYNO.SDS.StorageUtils,b=j.get("iscsi_lun"),a=f.getForm(),e=0,g,k,d,i,c=f.appWin.storagePools.data[j.get("pool_path")];if(j.isLogicalVolume()){d=parseInt(b.size,10);g=parseInt(c.get("size").total,10);k=parseInt(c.get("size").used,10);i=(g-k)+d;f.maxExpandSizeGB=h.GetSizeGB(i,0);f.minExpandSizeGB=h.GetSizeGB(d,0);e=f.minExpandSizeGB}else{e=h.GetSizeGB(b.size,0)}a.setValues({name:b.name,location:j.get("pool_path"),blockLunSize:e,mapping:f.getMappingCmp().getDisplayVaule()});f.values=f.getForm().getValues();if(f.maxExpandSizeGB!==f.minExpandSizeGB){f.sizeCmp.enable()}else{f.sizeCmp.disable()}if(c&&!(c.isWritable()&&c.isFreeSizeBiggerThan1GB())){f.sizeCmp.disable();f.getComponent("size_panel").getComponent("size_max").disable()}a.clearInvalid()},getValues:function(){var c=this;var b=c.getForm().getValues();var a=c.values;Object.keys(b).each(function(d){a[d]=b[d]});return a},prepareLocationData:function(e){var d=this,b=[],c,a=SYNO.SDS.StorageUtils;if(e){c=d.appWin.storagePools.getMatched(function(){return true})}else{c=d.appWin.storagePools.getMatched("isFreeSizeBiggerThan1GB","isWritable","notUsedByGlusterFs")}c.each(function(f){var g=parseInt(f.get("size").used,10);var h=parseInt(f.get("size").total,10);var i=""===f.get("desc")?"&nbsp":f.get("desc");b.push({id:f.id,display:String.format("{0} ({1}: {2})",a.SpaceIDParser(f.id).str,_T("volume","volume_freesize"),a.SizeRender(h-g)),name:a.SpaceIDParser(f.id).str,desc:i,available:a.SizeRender(h-g),type:a.RaidLevelRender(f.get("device_type")),raid_type:"single"===f.get("raidType")?"Single":"Multiple"})});return b},setSizeCmp:function(){this.sizeCmp=this.getComponent("size_panel").getComponent("blockLunSize")},setDefaultSize:function(g){var e=this,a=SYNO.SDS.StorageUtils,f,c,b;if(g){f=g.get("pool_path");c=e.appWin.storagePools.data[f];var d=parseInt(g.get("iscsi_lun").size,10);b=parseInt(c.get("size").total,10)-parseInt(c.get("size").used,10)+d;this.maxFreeSizeGB=a.GetSizeGB(b,0);this.maxFreeSizeByte=b;this.sizeCmp.minValue=a.GetSizeGB(d,0);this.sizeCmp.maxValue=this.maxFreeSizeGB}else{f=this.getLocCmp().getValue();c=e.appWin.storagePools.data[f];b=parseInt(c.get("size").total,10)-parseInt(c.get("size").used,10);this.maxFreeSizeGB=a.GetSizeGB(b,0);this.maxFreeSizeByte=b;this.sizeCmp.minValue=1;this.sizeCmp.maxValue=this.maxFreeSizeGB}this.sizeCmp.setValue(this.maxFreeSizeGB);if("single"===c.get("raidType")){this.sizeCmp.disable();this.getComponent("size_panel").getComponent("size_max").disable()}else{this.sizeCmp.enable();this.getComponent("size_panel").getComponent("size_max").enable()}}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvFileLunProp",{extend:"SYNO.SDS.StorageManager.Wizard.AdvLunProp",constructor:function(b){var f=this,a=SYNO.SDS.StorageUtils,d,h;f.isExtentBased=("yes"===_D("support_vaai","no"));f.minExtentLUNSize=10;f.isBlockLun=false;f.setDefault=true;f.sizeTextChanged=false;f.mode=b.mode||"create";f.sizeCmp=undefined;f.maxFreeSizeGB=0;f.appWin=b.appWin;f.owner=b.owner;f.displayExtentLUNTip=b.displayExtentLUNTip||false;f.hiddenFileLunSize=b.hiddenFileLunSize||false;d=f.configPropForm();h=b.lun?b.lun.get("iscsi_lun"):null;if("cloneLun"===b.action&&a.IsAnyMappedTargetConnected(h,f.appWin.iscsiTargets.getAll())){d.items.push({xtype:"syno_displayfield",htmlEncode:false,value:String.format('<span class="red-status"> {0}</span>',String.format(_T("iscsilun","clone_snapshot_inconsistent_warning"),h.name))})}f.callParent([Ext.apply(d,b)]);if("edit"!==f.mode&&f.isExtentBased){var g={},e;this.getComponent("extent_based").enable();var c=f.prepareLocationData(true);f.getLocCmp().store.loadData(c,false);if(h){e=h.location}else{if(this.getLocCmp().store.getAt(0)){e=this.getLocCmp().store.getAt(0).id.toString()}}if(e){g.volpath="/volume"+e.split("_").pop();if(!g.volpath){console.log("params.volpath null!");return}SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:"vol_extent_size_get",version:1,params:g,callback:function(m,l,k,i){var j;if(!m){this.getComponent("extent_size").enable()}else{j=parseInt(l.extent_size,10);this.getComponent("extent_size").setValue(j);this.getComponent("extent_size").disable()}},scope:this})}}},configField:function(a){var b=this;a.items.push({xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_thin_provisioning"),name:"thin_provision",hiddenName:"thin_provision",itemId:"thin_provision",editable:false,forceSelection:true,allowBlank:false,disabled:false,value:true,store:[[true,_T("common","yes")],[false,_T("common","no")]],listeners:{select:this.onThinProvisionChanged,scope:this}},{xtype:"syno_numberfield",fieldLabel:String.format("{0} ({1})",_T("volume","volume_totalsize"),_T("common","size_gb")),name:"fileLunSize",itemId:"fileLunSize",value:0,width:280,allowBlank:false,hidden:this.hiddenFileLunSize,validator:function(l){var d=this.ownerCt;var o=parseInt(l,10);var f=1;var g=d.getExtentLUNCmp().getValue();if(g){f=10}else{f=1}if("create"==d.mode&&o<f){return true}var j=SYNO.SDS.StorageUtils.ISCSITRG_UNIT_GB;var m=d.getLocCmp().getValue();var h=d.appWin.volumes.data[m];var i=d.getThinCmp().getValue();var n=SYNO.SDS.Utils.StorageUtils.ISCSIVAAILUN_EP_SIZE(o*j);var c;var e=_T("volume","volume_exceed_max_size_msg");var k=0;if(o<this.originalValue||0===o){return _T("iscsitrg","iscsitrg_size_too_small")}if(!Ext.isDefined(h)){return true}else{if(i){if(g){if(o<d.minExtentLUNSize){return _T("iscsitrg","iscsitrg_size_too_small")}else{if(n>(h.get("size").total-parseInt(h.get("size").used,10))){return _T("iscsitrg","iscsitrg_set_failed_space_not_enough")}}}if(parseInt(h.get("size").used,10)===parseInt(h.get("size").total,10)){return _T("iscsitrg","iscsitrg_set_failed_space_not_enough")}if("ext4"==h.get("fs_type")||"btrfs"==h.get("fs_type")){k=1000*1024}else{k=16*1024}if(o>k){return e.format(String.format("{0} GB",k))}if((o*j)>(parseInt(h.get("size").total,10)-parseInt(h.get("size").used,10))){b.thinprovisioningWarning=true}else{b.thinprovisioningWarning=false}return true}}c=d.getLocCmp().originalValue!==m;if(o*j+parseInt(h.get("size").used,10)-(c?0:this.originalValue*j)>h.get("size").total){return _T("iscsitrg","iscsitrg_set_failed_space_not_enough")}return true}},{xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_file_type"),name:"extent_based",hiddenName:"extent_based",itemId:"extent_based",editable:false,forceSelection:true,allowBlank:false,hidden:!b.isExtentBased,store:[[true,_T("iscsitrg","iscsitrg_advanced")],[false,_T("iscsitrg","iscsitrg_regular")]],listeners:{select:this.onIsExtentLUNChanged,scope:this}},{xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_vaai_extent_size"),name:"extent_size",hiddenName:"extent_size",itemId:"extent_size",editable:false,forceSelection:true,allowBlank:false,disabled:true,hidden:!b.isExtentBased,store:[[4096,_T("iscsitrg","iscsitrg_vaai_4k")],[8192,_T("iscsitrg","iscsitrg_vaai_8k")],[16384,_T("iscsitrg","iscsitrg_vaai_16k")],[32768,_T("iscsitrg","iscsitrg_vaai_32k")],[65536,_T("iscsitrg","iscsitrg_vaai_64k")]]})},addTip:function(){var a=this;if("yes"===_D("support_vaai","no")&&("create"===a.mode||a.displayExtentLUNTip)){SYNO.SDS.Utils.AddTip(a.getForm().findField("extent_based").getEl(),Ext.util.Format.htmlEncode(_T("iscsitrg","iscsitrg_vaai_notify")));SYNO.SDS.Utils.AddTip(a.getForm().findField("extent_size").getEl(),Ext.util.Format.htmlEncode(_T("iscsitrg","iscsitrg_vaai_extent_size_notify")))}SYNO.SDS.Utils.AddTip(a.getForm().findField("location").getEl(),Ext.util.Format.htmlEncode(_T("iscsitrg","iscsitrg_vaai_location_notify")));SYNO.SDS.Utils.AddTip(a.getForm().findField("thin_provision").getEl(),Ext.util.Format.htmlEncode(_T("iscsitrg","iscsitrg_thin_provisioning_notify")))},extentSizeGet:function(a){var b={};b.action="vol_extent_size_get";b.volpath="/volume"+a.split("_").pop();if(!b.volpath){console.log("params.volpath null!");return}SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:"vol_extent_size_get",version:1,params:b,callback:function(f,e,d,c){e.success=f;this.extentLUNConfigSetup(e)},scope:this})},onEdit:function(b){var a=this;a.setSizeCmp();a.setLocationCmp();a.setDefaultSize();a.setMappingCmp(b);a.loadForm(b);a.getLocCmp().setDisabled(a.lun.get("iscsi_lun").extent_based);a.getThinCmp().setDisabled(true);a.getExtentLUNCmp().setDisabled(true);if(!a.getExtentLUNCmp().getValue()){a.getExtentSizeCmp().hide()}if(b.isSinkLun()){this.getComponent("fileLunSize").disable()}a.callParent([b])},loadForm:function(f){var d=this,a=SYNO.SDS.StorageUtils,e=f.get("iscsi_lun"),c=d.getForm(),b=d.appWin.volumes.data[e.location];c.setValues({name:e.name,location:e.location,thin_provision:e.thin_provision,extent_based:e.extent_based,extent_size:e.extent_size,fileLunSize:a.GetSizeGB(e.size),mapping:d.getMappingCmp().getDisplayVaule()});d.values=d.getForm().getValues();if(!b){SYNO.Debug("wrong volume id")}if(b&&!b.isWritable()){d.getLocCmp().disable();d.sizeCmp.disable()}c.clearInvalid()},getValues:function(){var c=this;var b=c.getForm().getValues();var a=c.values;Object.keys(b).each(function(d){a[d]=b[d]});return a},prepareLocationData:function(){var c=this,h=[],e=c.appWin.volumes.getMatched("notUsedByGlusterFs"),f=SYNO.SDS.StorageUtils,d=false,i,g,b,a;d=this.getForm().findField("extent_based").getValue();Ext.each(e,function(j){i=parseInt(j.get("size").used,10);g=parseInt(j.get("size").total,10);b=(""===j.get("desc"))?"&nbsp":j.get("desc");a=j.get("fs_type");if(d&&a!=="ext4"&&a!=="btrfs"){return true}h.push({id:j.id,display:String.format("{0} ({1}: {2})",f.SpaceIDParser(j.id).str,_T("volume","volume_freesize"),f.SizeRender(g-i)),name:f.SpaceIDParser(j.id).str,desc:b,available:f.SizeRender(g-i),type:f.RaidLevelRender(j.get("device_type")),raid_type:"-"})},c);return h},onThinProvisionChanged:function(c,d,a){if("create"===this.mode){var b=this.getComponent("extent_based");if(a){b.setValue(false)}b.setDisabled(!d.json[0])}this.getForm().isValid()},onIsExtentLUNChanged:function(a,b,c){if(b.json[0]){this.getComponent("fileLunSize").minValue=10;if(this.sizeCmp&&this.sizeCmp.getValue()<this.minExtentLUNSize){this.sizeCmp.setValue(this.minExtentLUNSize)}if(this.extent_size_editable){this.getComponent("extent_size").enable()}}else{this.getComponent("fileLunSize").minValue=1;this.getComponent("extent_size").disable()}this.setLocationCmp(false,true)},setSizeCmp:function(){this.sizeCmp=this.getComponent("fileLunSize")},setDefaultSize:function(){var c=this,b=c.appWin.volumes.data[c.getLocCmp().getValue()],d,a=0;if("ext4"==b.get("fs_type")||"btrfs"==b.get("fs_type")){a=1000*1024}else{a=16*1024}if(!c.getThinCmp().getValue()){d=SYNO.SDS.StorageUtils.GetSizeGB(b.get("size").total-b.get("size").used,0);a=a>d?d:a}c.sizeCmp.minValue=1;c.sizeCmp.maxValue=a;if("create"===c.mode){if(c.getExtentLUNCmp().getValue()&&(c.sizeCmp.getValue()<c.minExtentLUNSize)){c.sizeCmp.setValue(this.minExtentLUNSize)}else{c.sizeCmp.setValue(1)}}},getNext:function(){var a=this;if(!a.getForm().isValid()){return false}if(true===a.thinprovisioningWarning){a.owner.getMsgBox().confirm(a.owner.title,_T("iscsitrg","iscsitrg_thin_provisioning_warning"),function(b){if("yes"===b){a.owner.goNext("summary")}},this.owner)}else{return"summary"}return false},getThinCmp:function(){return this.getComponent("thin_provision")},getExtentLUNCmp:function(){return this.getComponent("extent_based")},getExtentSizeCmp:function(){return this.getComponent("extent_size")}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvCreateiSCSILunMain",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var c=this,b,d=false,e=false;c.isDataChanged=false;c.appWin=a.appWin;c.owner=a.owner;if(0<c.appWin.volumes.getMatched("isWritable","notUsedByGlusterFs").length&&c.appWin.isSupportISCSIFile()&&!c.appWin.isUpToiSCSILunMaxCount()){d=true}if(0<c.appWin.storagePools.getMatched("isFreeSizeBiggerThan1GB","isWritable","notUsedByGlusterFs").length&&c.appWin.isSupportISCSIBlock()&&!c.appWin.isUpToiSCSILunMaxCount()&&(!_S("ha_running")||!c.appWin.isUpToHASpaceMaxCount())){e=true}b={title:_T("iscsilun","iscsilun_create_title"),width:700,height:600,resizable:false,border:false,steps:[]};b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvLunTypeStep({appWin:c.appWin,fileLun:d,blockLun:e,itemId:"lunType",nextId:"property"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvBlockLunProp({appWin:c.appWin,data:a.data,mode:"create",itemId:"blockLunProp",nextId:"summary"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvFileLunProp({appWin:c.appWin,owner:c.owner,data:a.data,mode:"create",itemId:"fileLunProp",nextId:"summary"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvCreateLunSummaryStep({appWin:c.appWin,itemId:"summary",nextId:null}));c.callParent([Ext.apply(b,a)])},applySettings:function(){var c={};var a=this.getStep("lunType").getForm().getValues().lunType;var e="file"===a?this.getStep("fileLunProp"):this.getStep("blockLunProp");var i=e.getForm().getValues();var h=e.getComponent("location").getValue();var f=this.appWin.storagePools.getById(h);var b;if(parseInt(e.sizeCmp.getValue(),10)===parseInt(e.maxFreeSizeGB,10)){b=Math.floor(parseInt(e.maxFreeSizeByte,10)/1024/1024)}else{b=parseInt(e.sizeCmp.getValue(),10)*1024}if("file"===a){var d=i.thin_provision;c.method="create";c.iscsi_lun={};c.iscsi_lun.name=i.name;c.iscsi_lun.location=h;c.iscsi_lun.thin_provision=d;c.iscsi_lun.extent_based=i.extent_based;c.iscsi_lun.extent_size=i.extent_size;c.iscsi_lun.size=(parseInt(e.sizeCmp.getValue(),10)*1024*1024*1024).toString()}else{if("single"===f.get("raidType")){c.method="deploy_unused";c.lun_name=i.name;c.space_path=f.get("space_path")}else{c.method="create_block_lun_on_pool";c.lun_name=i.name;c.pool_path=h;c.allocate_size=b.toString()}}var g=[];e.getComponent("mapping").getStore().each(function(j){if(j.get("checked")){g.push(j.get("tid"))}});if(0<g.length){c.map_type="map_exist";c.mapped_targets=g}this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",version:1,params:c,method:c.method,callback:function(k,j){this.clearStatusBusy();if(!k){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(j);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,j);return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));if(j.str){this.getMsgBox().alert(this.title,j.str,this.close,this)}else{this.isDataChanged=true;this.close()}},scope:this})},genNewLunName:function(){return this.owner.genNewLunName()}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvLunTypeStep",{extend:"SYNO.ux.FormPanel",setDefault:true,constructor:function(a){var c=this,b;c.appWin=a.appWin;b={headline:_T("iscsilun","iscsilun_choose_lun_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_iscsitrg_lun_file"),name:"lunType",itemId:"file",inputValue:"file"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_iscsitrg_lun_file_help")},{xtype:"syno_radio",boxLabel:_T("volume","volume_block_lun"),name:"lunType",itemId:"block",inputValue:"block"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_block_lun_desc")}]};c.callParent([Ext.apply(b,a)])},activate:function(){if(!this.setDefault){return}if(!this.fileLun){this.getComponent("file").disable()}if(!this.blockLun){this.getComponent("block").disable()}if(!this.fileLun&&!this.blockLun){this.owner.getButton("next").disable()}if(this.fileLun){this.getComponent("file").setValue(true)}else{this.getComponent("block").setValue(true)}this.setDefault=false},getNext:function(){if(this.getComponent("file").disabled&&this.getComponent("block").disabled){return false}if("block"===this.getForm().getValues().lunType){return"blockLunProp"}return"fileLunProp"},summary:function(a){if("file"===this.getForm().getValues().lunType){a.append(_T("volume","volume_space"),_T("volume","volume_iscsitrg_lun_file"))}else{a.append(_T("volume","volume_space"),_T("volume","volume_block_lun"))}}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvCreateLunSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(a){var c=this,b;c.appWin=a.appWin;b={headline:_T("volume","volume_wizard_summary_title")};this.callParent([Ext.apply(b,a)])},getNext:function(){this.owner.applySettings();return false}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvEditLun",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,lun:null,volumes:null,targets:null,pool:null,constructor:function(a){var d=this,b,c;d.appWin=a.appWin;d.owner=a.owner;d.lun=a.lun;b={title:_T("common","alt_edit"),width:700,height:320,resizable:false,layout:"fit",plain:true,border:false,items:[],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};c={appWin:d.appWin,owner:d,mode:"edit",lun:a.lun,itemId:"property",border:false,displayExtentLUNTip:a.lun.get("iscsi_lun").extent_based};if(a.lun.isBlockSpace()){b.items.push(new SYNO.SDS.StorageManager.Wizard.AdvBlockLunProp(c))}else{b.items.push(new SYNO.SDS.StorageManager.Wizard.AdvFileLunProp(c))}d.callParent([Ext.apply(b,a)])},onOpen:function(){var a=this;a.callParent(arguments);Ext.each(a.appWin.iscsiTargets.getAll(),function(b){b.check=-1<a.lun.get("iscsi_lun").mapped_targets.indexOf(b.tid)},a);a.getPropPanel().onEdit(a.lun);if(a.getPropPanel().addTip){a.getPropPanel().addTip()}},getPropPanel:function(){return this.getComponent("property")},isDirty:function(){var a=this.getComponent("property").getComponent("mapping").getStore();if(this.getComponent("property").getForm().isDirty()){return true}if(a.getModifiedRecords().length){return true}return false},onSave:function(){var f={};var c,b=this.getPropPanel().getMappingCmp().getStore();var d="";var a;var e;if(!this.getPropPanel().getForm().isValid()){return}if(!this.isDirty()){this.close();return}a=this.getPropPanel().getValues();f.name=a.name;if(this.lun.isLogicalVolume()){if(!this.checkLvLunData()){return}e=a.blockLunSize;if("single"!==this.lun.get("raidType")&&Ext.isDefined(e)){if(parseInt(e,10)===parseInt(this.getPropPanel().maxFreeSizeGB,10)){f.size=this.getPropPanel().maxFreeSizeByte.toString()}else{f.size=(parseInt(a.blockLunSize,10)*1024*1024*1024).toString()}}}else{f.size=(parseInt(a.fileLunSize,10)*1024*1024*1024).toString();f.location=a.location}f.mapped_targets=[];for(c=0;c<b.getCount();c++){d=b.getAt(c);if(d.get("checked")){f.mapped_targets.push(parseInt(b.getAt(c).id,10))}}f.lid=this.lun.getLunId();if(this.lun.isFileLun()&&this.getComponent("property").getLocCmp().getValue()!==this.lun.get("iscsi_lun").location){this.getMsgBox().confirm(this.title,_T("iscsilun","iscsilun_warning_move_location"),function(g){if("yes"===g){this.applySettings(f)}},this);return}else{this.applySettings(f)}},checkLvLunData:function(){var b=false;var e=this.getPropPanel().sizeCmp.getValue();var a=String.format("{0}",this.getPropPanel().minExpandSizeGB);var c=String.format("{0}",this.getPropPanel().maxExpandSizeGB);var d=String.format(_T("volume","volume_valid_range_warning"),a,c);if(e<this.getPropPanel().minExpandSizeGB||e>this.getPropPanel().maxExpandSizeGB){this.getMsgBox().alert(_T("tree","leaf_volume"),d,function(){this.getPropPanel().getForm().findField("blockLunSize").markInvalid(d)},this)}else{b=true}return b},applySettings:function(a){this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",version:1,method:"update",params:a,callback:function(c,b){this.clearStatusBusy();if(!c){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(b);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,b);return}this.isDataChanged=true;this.close()},scope:this})},onCancel:function(){if(this.isDirty()){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()}});Ext.namespace("SYNO.SDS.StorageManager.iSCSILun");SYNO.SDS.StorageManager.iSCSILun.IsExceedMaxLunsPerTarget=function(a,f){var c="";var b=0;var e={};for(var d=0;d<a.getCount();d++){c=a.getAt(d).get("tid");e=a.getAt(d).get("mapped_luns");b=e.length+1;if((f==c)&&(b>SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS)){return true}}return false};Ext.define("SYNO.SDS.StorageManager.iSCSILun.Store",{extend:"Ext.data.JsonStore",constructor:function(a){var c=this,b;c.sortField="displayName";c.sortDir="ASC";b={autoDestroy:true,idProperty:"id",fields:["numId","id","iconCls","statusIconCls",{name:"displayName",sortType:"asNaturalUCString"},"desc","usage","barWidth","summaryStatus","property","raidInfo","snapshots","targets","extent_based","extent_size","status","totalSize","location"],listeners:{load:function(){c.sort(c.sortField,c.sortDir)},scope:c}};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.StorageManager.iSCSILun.Main",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;c.view=undefined;c.repair_system_partition_link_id=undefined;c.remove_link_id=undefined;c.repair_link_id=undefined;c.appWin=a.appWin;c.owner=a.appWin;c.sortType="sort_displayName";c.createView();b={border:false,layout:"fit",itemId:"iscsi_lun",tbar:{defaultType:"syno_button",items:[{itemId:"create",text:_T("common","create"),handler:c.onCreate,scope:c},{itemId:"remove",text:_T("common","remove"),handler:c.onDelete,scope:c},{itemId:"edit",text:_T("common","alt_edit"),handler:c.onEdit,scope:c},{itemId:"manage",text:_T("volume","volume_manage"),disabled:true,handler:c.onManage,scope:c},{itemId:"clone",text:_T("iscsilun","clone"),handler:c.onClone,scope:c},{xtype:"syno_button",itemId:"snapshot",text:_T("iscsilun","snapshot"),menu:[{itemId:"takeSnapshot",text:_T("iscsilun","take_snapshot"),handler:c.onTakeSnapshot,scope:c},{itemId:"management",text:_T("iscsilun","snapshot_management"),handler:c.onSnapShotManage,scope:c},{itemId:"schedule_snapshot",text:_T("iscsilun","snapshot_schedule_task"),handler:c.onScheduleSnapshot,scope:c},{itemId:"snapshot_manager_list",text:_T("iscsilun","snapshot_manager_list"),handler:c.onPluginManage,scope:c}]},{itemId:"cancel",text:_T("common","alt_cancel"),handler:c.onCancel,scope:c},"->",new SYNO.SDS.StorageManager.SortButton({appWin:c.appWin,owner:c,menuItems:[{text:_T("volume","volume_sort_by_id"),itemId:"sort_displayName",handler:c.onSort,scope:c},{text:_T("volume","volume_sort_by_status"),itemId:"sort_status",handler:c.onSort,scope:c},{text:_T("volume","volume_sort_by_location"),itemId:"sort_location",handler:c.onSort,scope:c},{text:_T("volume","volume_sort_by_capacity"),itemId:"sort_totalSize",handler:c.onSort,scope:c}]})]},items:c.view,listeners:{activate:c.onActivate,scope:c}};c.callParent([Ext.apply(b,a)])},getHelpParam:function(){return"StorageManager/iscsilun.html"},createView:function(){var e=this,d=SYNO.SDS.StorageManager.PropertyTpl(),g=SYNO.SDS.StorageManager.DiskListTpl({scope:"disks",emptyText:_T("volume","volume_status_none")}),f=SYNO.SDS.StorageManager.DiskListTpl({scope:"spares",title:_T("volume","volume_suitable_spare_disks"),emptyText:_T("volume","volume_no_suitable_spare_disks")}),h=SYNO.SDS.StorageManager.TargetTpl({scope:"targets",title:_T("iscsitrg","iscsitrg_mapped_target"),emptyText:_T("iscsitrg","iscsitrg_mapped_no_targets")}),a=SYNO.SDS.StorageManager.SnapshotTpl({scope:"snapshots",title:_T("iscsilun","snapshot"),emptyText:_T("iscsilun","no_snapshot")}),c,b;c=new Ext.XTemplate('<div class="item-detail-inner">',d.html,'<tpl if="this.hasValues(raidInfo) == true">','<tpl for="raidInfo">',g.html,(e.appWin.supportHotSpare)?f.html:"","</tpl>","</tpl>",h.html,'<tpl if="extent_based">',(e.appWin.disableSnapUI)?"":a.html,"</tpl>","</div>");b={appWin:e.appWin,owner:e,dataType:"iscsiLuns",itemId:"lunView",multiSelect:true,detailTpl:c,store:new SYNO.SDS.StorageManager.iSCSILun.Store(),listeners:{selectionchange:e.onSelectChange,scope:e}};e.view=new SYNO.SDS.StorageManager.DataView(b)},prepareUiData:function(){var b=this,a=b.appWin.iscsiLuns.getAll(),c;delete b.uiData;b.uiData=[];Ext.each(a,function(d){c={};b.prepareSummary(d,c);if(d.isFileLun()){b.prepareFileLunProperty(d,c);b.prepareSnapshot(d,c)}else{b.prepareBlockLunProperty(d,c);b.prepareRaidInfo(d,c)}b.prepareMap(d,c);b.uiData.push(c)},b)},prepareSummary:function(d,c){var b=SYNO.SDS.StorageUtils,a=parseInt(d.get("iscsi_lun").size,10);c.numId=d.get("num_id");c.status=d.get("status");c.totalSize=a;c.location=d.get("iscsi_lun").location;c.id=d.get("id");c.displayName=d.get("iscsi_lun").name;if("cache_missing"===d.get("cacheStatus")){c.summaryStatus=String.format("&nbsp;-&nbsp;{0}",b.StatusNameRender(d.get("cacheStatus")))}else{if("cache_crashed"===d.get("cacheStatus")&&"deleting"!==d.get("status")&&"unmounting_cache"!==d.get("status")){c.summaryStatus=String.format("&nbsp;-&nbsp;{0}",b.StatusNameRender("crashed"))}else{c.summaryStatus=String.format("&nbsp;-&nbsp;{0}",b.StatusNameRender(d.get("status")))}}if(""===c.location){c.desc=""}else{c.desc=String.format(_T("volume","volume_default_desc"),b.SpaceIDParser(c.location).str)+", "}if(d.isSinkLun()){c.iconCls="sm-list-icon-sink-lun";c.desc+=_T("volume","volume_sink_lun")}else{if(d.isFileLun()){c.iconCls="sm-list-icon-file-lun";c.desc+=_T("volume","volume_iscsitrg_lun_file")}else{c.iconCls="sm-list-icon-block-lun";c.desc+=_T("volume","volume_block_lun")}}if(d.get("is_actioning")){c.statusIconCls="sm-list-status-icon-acting"}else{if("crashed"===d.get("status")||"degrade"===d.get("status")||"Unhealthy"===d.get("status")||"cache_crashed"===d.get("cacheStatus")){c.statusIconCls="sm-list-status-icon-crashed"}}},prepareFileLunProperty:function(j,d){var g=this,i=SYNO.SDS.StorageUtils,a,f=j.get("iscsi_lun"),e=g.appWin.volumes.data[f.location],c=i.LunStatusRender(j.get("status"),j.get("progress")),h,b;if(e){if(e.isPoolChild()){h=e.get("pool_path")}else{h=e.id}}b=i.WarningTextRender(j.get("status"),i.SpaceIDParser(h).str);d.property=[{name:_T("volume","volume_volumestatus"),value:c+b},{name:_T("volume","volume_reported"),value:i.SizeRender(f.size)},{name:_T("volume","volume_used"),value:i.SizeRender(parseInt(f.blkNum,10)*512)},{name:_T("iscsitrg","iscsitrg_thin_provisioning"),value:f.thin_provision?_T("common","yes"):_T("common","no")}];if("yes"===_D("support_vaai","no")){d.property.push({name:_T("iscsitrg","iscsitrg_vaai"),value:f.extent_based?_T("common","yes"):_T("common","no")});if(f.extent_based){d.property.push({name:_T("iscsitrg","iscsitrg_vaai_extent_size"),value:(f.extent_size/1024).toString().concat("k")})}}d.property.push({name:_T("volume","volume_raid_location"),value:i.SpaceIDParser(f.location).str});if(f.extent_based){a=SYNO.SDS.StorageManager.ISCSI.Util.LunParentRender(g.appWin.iscsiLuns,f);if(a){d.property.push({name:_T("iscsilun","source"),value:a})}}},prepareBlockLunProperty:function(j,d){var f=this,g=SYNO.SDS.StorageUtils,e=j.get("iscsi_lun"),i=parseInt(e.size,10),h=parseInt(e.size,10),c,b,a;if("cache_missing"===j.get("cacheStatus")){c=g.StatusNameRender(j.get("cacheStatus"))}else{if("cache_crashed"===j.get("cacheStatus")&&"deleting"!==j.get("status")&&"unmounting_cache"!==j.get("status")){c=g.StatusNameRender("crashed")}else{c=g.StatusRender(j.get("status"),j.get("progress"))}}if(f.appWin.supportRaidGroup||j.isPoolChild()){b=g.WarningTextRender(j.get("status"),g.SpaceIDParser(j.get("pool_path")).str)}else{a=(""===e.location)?e.name:g.SpaceIDParser(e.location);b=g.WarningTextRender(j.get("status"),a)}d.property=[{name:_T("volume","volume_raid_title"),value:g.SpaceTypeRender(j.get("device_type"))}];f.renderSuggestions(j,d);if(j.isLogicalVolume()||f.appWin.supportRaidGroup){d.property.push({name:f.appWin.supportRaidGroup?_T("volume","volume_storage_pool"):_T("volume","volume_pool"),value:g.SpaceIDParser(j.get("pool_path")).str})}d.property.push({name:_T("volume","volume_volumestatus"),value:c+b});d.property.push({name:_T("volume","volume_reported"),value:g.SizeRender(h)});d.property.push({name:_T("volume","volume_usedsize"),value:g.SizeRender(i)});d.property.push({name:_T("iscsitrg","iscsitrg_thin_provisioning"),value:e.thin_provision?_T("common","yes"):_T("common","no")})},prepareRaidInfo:function(h,b){var c=this,d=c.appWin.disks.data,j=c.appWin.hotSpares.data,i,a,e=SYNO.SDS.StorageUtils,g=[],f=false;if(h.isLogicalVolume()||c.appWin.supportRaidGroup){return}b.raidInfo=[];i=[];Ext.each(h.get("disks"),function(k){a=d[k];if(!a){return true}if(a.is4Kn()){f=true}i.push({container:"internal"===a.get("container").type?_S("hostname"):a.get("container").str,name:a.get("name"),size:e.SizeRender(a.get("size_total")),driveType:a.get("isSsd")?"SSD":"HDD",status:e.DiskStatusRender(a.get("status"))})});Ext.each(h.get("spares"),function(k){a=d[k.id];k=j[k.id];if(!a||!k){return true}if(a.is4Kn()!==f){return true}g.push({container:"internal"===a.get("container").type?_S("hostname"):a.get("container").str,name:a.get("name"),size:e.SizeRender(a.get("size_total")),driveType:a.get("isSsd")?"SSD":"HDD",status:e.SpareStatusRender(k.get("status").type)})});b.raidInfo.push({disks:i,spares:g})},prepareMap:function(e,c){var b=this,d=e.get("iscsi_lun").mapped_targets,a=[];Ext.each(b.appWin.iscsiTargets.getAll(),function(f){if(-1!==d.indexOf(f.get("tid"))){a.push(f)}},b);if(0<a.length){c.targets=[]}Ext.each(a,function(f){c.targets.push({name:f.get("name"),status:SYNO.SDS.StorageUtils.TargetStatusRender(f.get("status"))})},b)},prepareSnapshot:function(f,e){var c=this,a=f.get("iscsi_lun"),d,b;e.snapshots=[];e.extent_based=a.extent_based;if(!a.extent_based){return}d=function(h){var g=new Date(h*1000);return g.format("Y/m/d H:i:s")};b=function(h,g){return g.time-h.time};a.snapshots.sort(b);Ext.each(a.snapshots,function(h){var i=Ext.util.Format.htmlEncode(h.desc),g=Ext.util.Format.htmlEncode(i);e.snapshots.push({name:String.format('<div class="snapshot-name" ext:qtip="{0}">{0}</div>',h.name),desc:String.format('<div class="snapshot-desc" ext:qtip="{0}">{1}</div>',g,i||"&nbsp"),time:d(h.time),status:SYNO.SDS.StorageUtils.SnapShotStatusRender(h.status)})},c)},renderSuggestions:function(n,d){var e,g="",b="",j={};var a=false;var c=false;var m=false;var k="";var l="";var h="";var f=n.get("suggestions");if(!f||f.length<=0){return}for(e=0;e<f.length;e++){b=SYNO.SDS.StorageUtils.FormatSuggestion(f[e]);if(undefined!==f[e].note){switch(f[e].note){case"system partition failed":j=SYNO.SDS.Utils.clone(f[e]);j.str=b;a=true;break;case"remove crashed pool child":j=SYNO.SDS.Utils.clone(f[e]);j.str=b;c=true;break;case"repair degraded pool child":j=SYNO.SDS.Utils.clone(f[e]);j.str=b;m=true;break;default:continue}}else{g+=String.format('<span class="{0}">{1}{2}</span><br>',f[e].type==="warning"?"red-status":"green-status",b,"")}}if(a){if(Ext.isDefined(this.repair_system_partition_link_id)){}else{this.repair_system_partition_link_id=Ext.id()}k=String.format('&nbsp<a class="link-font" id="{0}" href="#" space_id={2}>{1}</a>',this.repair_system_partition_link_id,_T("volume","volume_repair_syspart"),n.get("id"));g+=String.format('<span class="{0}">{1}{2}</span><br>',j.type==="warning"?"red-status":"green-status",j.str,k);if(k){this.mon(this.view.getStore(),"load",function(){var i=Ext.fly(this.repair_system_partition_link_id);this.mon(i,"click",this.repairSysPartition,this)},this,{single:true})}}else{if(c){if(Ext.isDefined(this.remove_link_id)){}else{this.remove_link_id=Ext.id()}l=String.format('&nbsp<a class="link-font" id="{0}" href="#" space_id={2}>{1}</a>',this.remove_link_id,this.appWin.supportRaidGroup?_T("volume","volume_storage_pool_link"):_T("volume","volume_remove_link"),n.get("pool_path"));g+=String.format('<span class="{0}">{1}{2}</span><br>',j.type==="warning"?"red-status":"green-status",j.str,l);if(l){this.mon(this.view.getStore(),"load",function(){var i=Ext.fly(this.remove_link_id);this.mon(i,"click",this.linkPoolElement,this)},this,{single:true})}}else{if(m){if(Ext.isDefined(this.repair_link_id)){}else{this.repair_link_id=Ext.id()}h=String.format('&nbsp<a class="link-font" id="{0}" href="#" space_id={2}>{1}</a>',this.repair_link_id,this.appWin.supportRaidGroup?_T("volume","volume_storage_pool_link"):_T("volume","volume_repair_link"),n.get("pool_path"));g+=String.format('<span class="{0}">{1}{2}</span><br>',j.type==="warning"?"red-status":"green-status",j.str,h);if(h){this.mon(this.view.getStore(),"load",function(){var i=Ext.fly(this.repair_link_id);this.mon(i,"click",this.linkPoolElement,this)},this,{single:true})}}else{SYNO.Debug("other suggestion")}}}d.property.push({name:_T("volume","volume_status_suggest"),value:g})},onActivate:function(){var b=this,a=b.view.store;b.prepareUiData();a.suspendEvents(true);a.loadData(b.uiData,false);a.resumeEvents();b.resetBtnStatus();if(0<b.view.store.getCount()&&0===b.view.getSelectedItemIds().length){b.view.select(0,true,true)}b.onSelectChange();b.setMask()},onSelectChange:function(){var c=this,a=SYNO.SDS.StorageManager.ISCSI.Util,d,b=c.view.getSelectedItems();c.getButton("remove").hide();c.getButton("edit").hide();c.getButton("manage").hide();c.getButton("clone").hide();c.getButton("snapshot").hide();c.getButton("cancel").hide();if(0===b.length){return}c.getButton("remove").show();c.enableButton("remove",c.canDelete(b));if(1===b.length){d=b[0];if(d.isCreating()||(!d.isPoolChild()&&"data_scrubbing"===d.getProgressStep())){c.getButton("cancel").show();c.enableButton("cancel",c.canCancel(d))}c.getButton("edit").show();c.enableButton("edit",c.canEdit(d));if(d.isBlockLun()&&!d.isLogicalVolume()&&!c.appWin.supportRaidGroup){c.getButton("manage").show();c.enableButton("manage",c.canManage(d))}if(a.SupportSnapshot()&&d.isFileLun()){if(c.canClone(d)){c.getButton("clone").show();c.enableButton("clone",true)}if(!c.appWin.disableSnapUI){c.getButton("snapshot").show();c.enableButton("snapshot",c.canSnapshot(d));if(d.isUnhealthy()||a.isUpToiSCSISnapShotActionCount(c.appWin.iscsiLuns.getAll())||d.isSinkLun()){c.getButton("snapshot").menu.get("takeSnapshot").disable()}else{c.getButton("snapshot").menu.get("takeSnapshot").enable()}}}}},onCreate:function(){var b=this,a;a=(b.appWin.supportRaidGroup)?"AdvCreateiSCSILunMain":"CreateiSCSILunMain";b.openWizard(a,{})},onDelete:function(){var b=this,a=b.view.getSelectedItems();if(0===a.length){return}b.openWizard("DeleteLun",{luns:a})},onEdit:function(){var c=this,d=c.view.getSelectedItem(),b,a;if(!d){return}if(d.isLogicalVolume()){a=c.appWin.storagePools.data[d.get("pool_path")]}b=(c.appWin.supportRaidGroup)?"AdvEditLun":"EditLun";c.openWizard(b,{lun:d,pool:a})},onManage:function(){var c=this,d,a,b;if(c.appWin.supportRaidGroup){return}d=c.view.getSelectedItem();if(!d){return}a=c.getAvailableDisksForAdd(d);b=c.getAvailableDisksForAdd(d,"expand_by_disk");c.openWizard("Manage",{title:_T("iscsilun","iscsilun_manage_title"),spaceType:"iscsilun",api:"SYNO.Core.Storage.iSCSILUN",space:d,disks:a,disksForExpand:b,add_type:c.getValidAddType(d,a),migrate_type:c.getValidMigrateType(d,a)})},onClone:function(){var a=this,b=a.view.getSelectedItem();if(!b){return}a.openWizard("CloneLun",{title:_T("iscsilun","clone"),lun:b,action:"cloneLun"})},onTakeSnapshot:function(){var a=this,b=a.view.getSelectedItem();if(!b){return}a.openWizard("TakeSnapshot",{title:_T("iscsilun","take_snapshot")+" - "+b.get("iscsi_lun").name,lun:b,mode:"create"})},onSnapShotManage:function(){var a=this,b=a.view.getSelectedItem();a.openWizard("Snapshot",{title:_T("iscsilun","snapshot_management")+" - "+b.get("iscsi_lun").name,lun:b})},onScheduleSnapshot:function(){var a=this,b=a.view.getSelectedItem();a.openWizard("ScheduleSnapshot",{title:_T("iscsilun","snapshot_schedule_task")+" - "+b.get("iscsi_lun").name,lun:b})},onPluginManage:function(){var a=this;a.openWizard("SnapshotManager",{title:_T("iscsilun","snapshot_manager_list")})},onCancel:function(){var a=this,d=a.view.getSelectedItem(),c=d.get("id"),b="cancel_iscsilun_create";if("data_scrubbing"===d.getProgressStep()){b="cancel_data_scrubbing"}a.appWin.stopPollTask();a.owner.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",version:1,method:b,params:{space_id:c},callback:function(f,e){this.clearStatusBusy();if(!f){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,e);return}this.setStatusBusy();this.cleanMask=true;this.startPollTask()},scope:a.appWin})},onSort:function(f,d){var c=this,b,a=c.view.store;if(0>f.itemId.indexOf("_")){return}c.sortType=f.itemId;b=f.itemId.split("_")[1];if(a.sortField!==b){a.sortField=b;a.sortDir="ASC"}else{a.sortDir="ASC"===a.sortDir?"DESC":"ASC"}a.sort(a.sortField,a.sortDir);c.onSelectChange()},resetBtnStatus:function(){var a=this;a.getButton("remove").hide();a.getButton("edit").hide();a.getButton("manage").hide();a.getButton("clone").hide();a.getButton("snapshot").hide();a.getButton("cancel").hide();a.enableButton("create",a.canCreate())},setMask:function(){var b=this;if(b.isVisible()&&0===b.view.getStore().getCount()){if(0===b.appWin.storagePools.count&&b.appWin.supportRaidGroup){var d=Ext.id();var a=String.format('<a id="{0}" class="link-font" style="cursor:pointer;">{1}</a>',d,_T("volume","volume_storage_pool_tab"));var c=String.format(_T("volume","volume_no_raid_in_system"),_T("volume","volume_storage_pool"),a);b.body.mask(c,"syno-ux-mask-info");b.mon(Ext.fly(d),"click",function(){b.appWin.selectPage("SYNO.SDS.StorageManager.Pool.Main")},b)}else{b.body.mask(_T("iscsilun","iscsilun_no_luns"),"syno-ux-mask-info")}b.getButton("sort").disable()}if(0<b.view.getStore().getCount()){b.body.unmask();b.getButton("sort").enable()}},setFocus:function(b){var a=this;a.view.focusNode(b);a.view.select(b);if(!a.view.expandedItemId[b]){a.view.doExpand(true,Ext.get(b),true)}},canCreate:function(){var e=this,g=e.appWin.volumes.getMatched("isWritable","notUsedByGlusterFs"),a=e.appWin.disks.getMatched("isNormalTray","isFree"),d=e.appWin.disks.getMatched("isFree","isInEbox"),f=e.appWin.storagePools.getMatched("isFreeSizeBiggerThan1GB","isWritable","notUsedByGlusterFs"),c,b={};if(_S("ha_running")&&e.appWin.isUpToHASpaceMaxCount()){return false}if(e.appWin.isUpToiSCSILunMaxCount()){return false}if(e.appWin.isSupportISCSIFile()&&0<g.length){b.lun_file=true}if(e.appWin.isSupportISCSIBlock()){if(1!==e.appWin.getBayNumber()||0!==d.length){if(!e.appWin.supportRaidGroup&&0<a.length){b.lun_block=true}}if(0<f.length){b.lun_block_on_existing_pool=true}}for(c in b){if(b.hasOwnProperty(c)){return b}}return false},canDelete:function(j){var e=this,g=e.appWin.storagePools.data,f=e.appWin.volumes.data,d,c,b,h,a;if(0===j.length){return false}for(b=0;b<j.length;++b){h=j[b];if(h.isActioning()){return false}a=h.get("can_do");if(h.isLogicalVolume()||(!h.isFileLun()&&e.appWin.supportRaidGroup)){d=g[h.get("pool_path")];if(d.isCrashed()){return false}}if(h.isFileLun()){c=f[h.get("iscsi_lun").location];if(c.isCrashed()){return false}}if(!a["delete"]){return false}}if(e.appWin.isAnyStorageActioning(j)){return false}return true},canEdit:function(a){if(!a||a.isActioning()||a.isCrashed()||a.isUnhealthy()||a.cacheMissing()||a.cacheCrashed()){return false}return true},canManage:function(e){var d=this,c,a,b;if(!e||e.isSinkLun()||e.isActioning()||e.isCrashed()||e.cacheMissing()||e.cacheCrashed()){return false}a=d.getAvailableDisksForAdd(e);b=d.getValidAddType(e,a);for(c in b){if(b[c]){return true}}return false},canClone:function(c){var b=this,a=SYNO.SDS.StorageManager.ISCSI.Util;if(c.isSinkLun()){return false}if(c.isActioning()){return false}if(b.appWin.isUpToiSCSILunMaxCount()){return false}if(!b.canSnapshot(c)){return false}if(c.isUnhealthy()){return false}if(a.isUpToiSCSISnapShotActionCount(b.appWin.iscsiLuns.getAll())){return false}return true},canSnapshot:function(b){var a;if(!b){return false}if(b.isActioning()){return false}if(b.isCrashed()){return false}if(true!==b.get("iscsi_lun").extent_based){return false}a=b.get("status");if("be_cloning"!==a&&"using"!==a&&"snapshotting"!==a&&b.isActioning()){return false}return true},canCancel:function(b){var a;if(!b){return false}if(b.isSinkLun()){return false}if(b.isCreating()){a=b.getProgressStep();if(a==="mk_filesystem"||a==="disk_check"||a==="raid_syncing"||a==="raid_parity_checking"||(a==="waiting"&&!_S("ha_running"))){return true}}else{if("data_scrubbing"===b.getProgressStep()){return true}}return false},getAvailableDisksForAdd:function(i,b){var e=this,h=i.get("minimal_disk_size"),a=i.get("container"),f=[],c=[],g=false,d=function(j){if(-1===i.get("device_type").indexOf("shr")||"expand_by_disk"!==b){return j.isBiggerThan(h)}return j.isBiggerThan(h)||j.isEqualToAny(c)};if(!a||!i.get("can_do")){return f}i.get("disks").each(function(j){var k=e.appWin.disks.data[j];if(!k){return true}if(k.is4Kn()){g=true}c.push(parseInt(k.get("size_total"),10))},this);if(i.get("can_do").raid_cross||i.isExpansion()){f=e.appWin.disks.getMatched(function(){var j=this;return j.isNormalTray()&&j.isFree()&&d(j)&&((j.is4Kn()&&g)||(!j.is4Kn()&&!g))})}else{if("internal"===a){f=e.appWin.disks.getMatched(function(){var j=this;return j.isNormalTray()&&j.isFree()&&j.isInternal()&&d(j)&&((j.is4Kn()&&g)||(!j.is4Kn()&&!g))})}else{if("ebox"===a){f=e.appWin.disks.getMatched(function(){var j=this;return j.isFree()&&j.isInEbox()&&d(j)&&((j.is4Kn()&&g)||(!j.is4Kn()&&!g))})}}}return f},getValidAddType:function(h,a){var g=this,f=h.get("can_do"),e,b,d=false,c;if(!f){return{}}b=g.getValidMigrateType(h,a);for(e in b){if(b[e]){d=true;break}}c=g.getAvailableDisksForAdd(h,"expand_by_disk");return{repair:("repair" in f)&&0<a.length,scrubbing:("data_scrubbing" in f),expand_by_disk:("expand_by_disk" in f)&&f.expand_by_disk<=c.length,expand_with_unalloc_size:("expand_with_unalloc_size" in f)&&(parseInt(f.expand_with_unalloc_size,10)>0),migrate:d}},getValidMigrateType:function(g,a){var b,f,d,e=g.get("can_do"),c={};if(!e||!e.migrate){return{}}e=e.migrate;if("to_raid5+spare" in e){b=e["to_raid5+spare"].split("-");f=parseInt(b[0],10);d=parseInt(b[1],10);c["to_raid5+spare"]=(f<=a.length)&&!_S("ha_running")}return Ext.applyIf(c,{add_mirror:("add_mirror" in e)&&0<a.length,to_raid1:("to_raid1" in e)&&0<a.length&&!_S("ha_running"),to_raid5:("to_raid5" in e)&&e.to_raid5<=a.length&&!_S("ha_running"),to_raid6:("to_raid6" in e)&&e.to_raid6<=a.length&&!_S("ha_running")})},openWizard:function(b,a){var c=this,e;if(c.appWin.isUpToBatchTaskCount()){e=_T("volume","volume_max_batch_task_count").replace("_MAX_TASK_",c.appWin.getMaxBatchTaskCount());c.appWin.getMsgBox().alert(c.title,e,function(){},c);return}var d=new SYNO.SDS.StorageManager.Wizard[b](Ext.apply({appWin:c.appWin,owner:c.owner},a));c.appWin.stopPollTask();c.mon(d,"close",function(){if(Ext.isFunction(d.hideFromOwner)){d.hideFromOwner()}if(d.isDataChanged){c.owner.setStatusBusy();c.body.unmask();c.owner.cleanMask=true}c.appWin.startPollTask()},c,{single:true});d.open()},enableButton:function(c,a){var b=this.getButton(c);if(!b){throw Error("could not get button of id: "+c)}return a?b.enable():b.disable()},disableButtons:function(){Ext.each(arguments,function(d,a,c){var b=this.getButton(d);if(!b){throw Error("could not get button of id: "+d)}b.disable()},this)},getButton:function(a){return this.getTopToolbar().getComponent(a)},repairSysPartition:function(c,b){var a=new Ext.Element(b);var d=a.getAttribute("space_id");this.owner.setStatusBusy({text:_T("common","saving")});this.owner.updater.stop();SYNO.API.Request({webapi:{api:"SYNO.Storage.CGI.Storage",method:"repair_sys_partition",version:"1",params:{space_id:d}},callback:function(h,e,g,f){this.owner.clearStatusBusy();if(e.str){this.owner.getMsgBox().alert(this.title,e.str,function(){this.owner.setStatusBusy();this.owner.cleanMask=true;this.owner.updater.start()},this)}else{this.owner.updater.start()}},scope:this})},linkPoolElement:function(d,c){var b=this,a=new Ext.Element(c),f=a.getAttribute("space_id");b.appWin.selectPage("SYNO.SDS.StorageManager.Pool.Main");b.appWin.getActivePage().setFocus(f)}});Ext.define("SYNO.SDS.StorageManager.Overview.Main",{extend:"SYNO.ux.Panel",numPerPage:3,statusColors:{healthy:"#37a600",caution:"#ff7f00",danger:"#cc1414"},statusText:{healthy:_T("volume","volume_healthy"),caution:_T("volume","volume_caution"),attention:_T("volume","volume_danger")},pieChartPos:["left","center","right"],pieChartColor:{high:{startColor:"#FF737E",middleColor:"#F25056",stopColor:"#E52E2E",fontCls:"red-status"},mid:{startColor:"#FFAA00",middleColor:"#F99100",stopColor:"#F27900",fontCls:"orange-status"},low:{startColor:"#00AAFF",middleColor:"#1792F2",stopColor:"#2E7AE5",fontCls:"blue-status"}},constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.appWin;c.statusDesc={healthy:_T("volume","volume_healthy_desc"),caution:c.appWin.supportRaidGroup?_T("volume","volume_caution_desc"):_T("volume","volume_caution_desc_non_raidgroup"),attention:c.appWin.supportRaidGroup?_T("volume","volume_danger_desc"):_T("volume","volume_danger_desc_non_raidgroup")};c.initialized=false;c.lunBarChartRatio=undefined;c.pageIndex=1;c.totalPageCount=0;c.supportIscsi=("yes"===_D("support_iscsi_target","no"));c.chart=[];c.sysHealth=new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<div style="height:140px;padding-bottom:8px;">','<div class="sm-overview-health-icon sm-overview-health-icon-{status}"></div>','<div class="sm-overview-health-text sm-overview-health-text-{status}">{text}</div>','<div class="sm-overview-health-desc">{desc}</div>',"</div>","</tpl>"),store:c.healthStore=new Ext.data.JsonStore({autoDestroy:true,fields:["status","text","desc"],listeners:{load:function(){if(c.repairSysLinkId){c.mon(Ext.get(c.repairSysLinkId),"click",c.repairSysConfirm,c,{single:true})}},scope:c}})});c.diskInfo=new SYNO.ux.FieldSet({title:_T("volume","volume_disk_information"),collapsible:true,items:new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<tpl for="expansions">','<div class="normal-font" style="margin-left:2px;line-height:24px;">','<div style="width:160px;float:left;">{name}</div>',"<div>","<table>","<tr><td>",'<tpl for="disks">',"<tpl if=\"'empty'!=status\">",'<div class="sm-overview-disk sm-overview-disk-{status}" ext:qtip="{displayName}</br>{usedBy}"></div>',"</tpl>","<tpl if=\"'empty'==status\">",'<div class="sm-overview-disk sm-overview-disk-{status}"></div>',"</tpl>",'<tpl if="xindex &gt; 0 && xindex %12 === 0">',"</td></tr><tr><td>","</tpl>","</tpl>","</td></tr>","</table>","</div>",'<div class="x-clear"></div>',"</div>","</tpl>","<table>","<tr>",'<tpl for="diskInfoStat">','<td style="vertical-align:bottom">','<div class="sm-overview-stat">','<div class="sm-overview-stat-text">{text}</div>','<div class="sm-overview-disk-stat-bar-{type}"></div>','<div class="sm-disk-stat-count sm-disk-stat-count-{type}" style="float:bottom">{count}</div>',"</div>","</td>","</tpl>","</tr>","</table>",'<div class="x-clear"></div>',"</tpl>"),store:c.diskStore=new Ext.data.JsonStore({autoDestroy:true,fields:["expansions","diskInfoStat"]})})});c.volUsage=new SYNO.ux.FieldSet({title:_T("volume","volume_usage"),collapsible:true,listeners:{expand:c.setMask,scope:c},items:new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<div style="position:relative;height:214px;">','<tpl if="3 < volCount">','<div id="sm_overview_vol_prev" class="sm-overview-vol-prev sm-overview-vol-btn"></div>','<div style="position:absolute;left:50%;margin-left:-302px;">',"</tpl>",'<tpl for="volumes">','<div id="sm_overview_vol_{pos}" class="sm-overview-vol sm-overview-vol-{pos}{style}">','<div id="sm_overview_vol_chart_{pos}" class="sm-overview-vol-chart"></div>','<div id="sm_overview_vol_name_{pos}" class="sm-overview-vol-name"></div>','<div id="sm_overview_vol_desc_{pos}" class="sm-overview-vol-desc" style="height:24px"></div>','<div id="sm_overview_vol_text_{pos}" class="sm-overview-vol-text"></div>',"</div>","</tpl>",'<tpl if="3 < volCount">',"</div>",'<div id="sm_overview_vol_next" class="sm-overview-vol-next sm-overview-vol-btn"></div>',"</tpl>","</div>","</tpl>",'<div class="x-clear"></div>',{getCount:function(d){if(!d||!d.length){return 0}return d.length}}),store:c.volStore=new Ext.data.JsonStore({autoDestroy:true,fields:["volCount","volumes"]})})});if(c.supportIscsi){c.lunUsage=new SYNO.ux.FieldSet({title:_T("volume","volume_iscsi_lun_usage"),collapsible:true,items:new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<div style="position:relative;height:44px;margin-right:10px;">','<div class="sm-overview-lun-usage-bg">','<tpl if="usedRatio < 100">','<div class="sm-overview-lun-usage-fg" style="width:{usedRatio}%"></div>',"</tpl>",'<tpl if="100 <= usedRatio">','<div class="sm-overview-lun-usage-fg"></div>',"</tpl>","</div>",'<div class="sm-overview-lun-text">{reported} {reportedUnit}</div>','<div class="sm-overview-lun-cursor"></div>',"</div>","<table>","<tr>",'<tpl for="lunStat">','<td style="vertical-align:bottom">','<div class="sm-overview-stat">','<div class="sm-overview-stat-text">{text}</div>','<div class="sm-overview-lun-stat-bar-{type}"></div>','<div class="sm-overview-lun-stat-value sm-overview-lun-stat-value-{type}">{count}</div>',"</td>","</div>","</tpl>","</tr>","</table>","</tpl>"),store:c.lunStore=new Ext.data.JsonStore({autoDestroy:true,fields:["usedRatio","reported","reportedUnit","lunStat"]})})})}b={itemId:"overview",border:false,autoFlexcroll:true,items:[c.sysHealth],listeners:{activate:c.onActivate,scope:c}};if("yes"===_D("supportraidcross","no")){b.items.push(c.diskInfo)}b.items.push(c.volUsage);if(c.supportIscsi){b.items.push(c.lunUsage)}c.callParent([Ext.apply(b,a)])},getHelpParam:function(){return"StorageManager/overview.html"},onActivate:function(){var a=this;if(!a.appWin.loaded){return}a.prepareUiData();a.healthStore.loadData(a.uiData,false);a.diskStore.loadData(a.uiData,false);a.volStore.loadData(a.uiData,false);if(a.supportIscsi){a.lunStore.loadData(a.uiData,false)}a.doLayout();if(1<a.pageCount){a.mun(Ext.get("sm_overview_vol_prev"),"click");a.mun(Ext.get("sm_overview_vol_next"),"click");a.mon(Ext.get("sm_overview_vol_prev"),"click",function(f,b,c){var d=new Ext.Element(b);if(!d.hasClass("sm-overview-vol-btn-enable")){return}--this.pageIndex;this.drawPieChart()},a);a.mon(Ext.get("sm_overview_vol_next"),"click",function(f,b,c){var d=new Ext.Element(b);if(!d.hasClass("sm-overview-vol-btn-enable")){return}++this.pageIndex;this.drawPieChart()},a)}a.setMask();a.drawPieChart()},prepareUiData:function(){var a=this,b;delete a.uiData;delete a.volumes;a.uiData=[];a.volumes=a.appWin.volumes.getMatched("notUsedByGlusterFs");b={};a.prepareHealth(b);a.prepareSysRepair(b);a.prepareDisk(b);a.prepareVolume(b);if(a.supportIscsi){a.prepareLun(b)}a.uiData.push(b)},prepareHealth:function(b){var a=this;a.systemNeedRepair=false;a.repairSysLinkId=undefined;a.checkSpaceStatus(a.volumes,b);if("healthy"!==b.status){return}if(a.supportIscsi){a.checkSpaceStatus(a.appWin.iscsiLuns.getAll(),b);if("healthy"!==b.status){return}}a.checkSpaceStatus(a.appWin.storagePools.getAll(),b);if("healthy"!==b.status){return}if(a.appWin.supportSsdCache){a.checkSsdCacheStatus(a.appWin.ssdCaches.getAll(),b);if("healthy"!==b.status){return}}if(a.appWin.supportRaid&&a.appWin.env.status.system_crashed){b.status="attention";b.text=a.statusText[b.status];b.desc=_T("error","error_system_abnormal_steps");if("healthy"!==b.status){return}}if(a.appWin.supportSas){if("yes"===_D("support_dual_head")){if(0===this.appWin.AHAInfo.link_status){b.status="caution";b.text=a.statusText[b.status];b.desc=_T("common","loading")}else{if(1!=this.appWin.AHAInfo.link_status){b.status="caution";b.text=a.statusText[b.status];b.desc=_T("volume","volume_cable_connection_abnormal")}}}else{if(!a.checkLinkValid()){b.status="caution";b.text=a.statusText[b.status];b.desc=_T("volume","volume_cable_connection_abnormal")}}if("healthy"!==b.status){return}}a.checkDiskSmart(b)},prepareSysRepair:function(b){var a=this;if(a.appWin.supportRaid){a.checkSysPartition();if(a.systemNeedRepair){a.repairSysLinkId=Ext.id();if("attention"!==b.status){b.status="caution"}b.text=a.statusText[b.status];b.desc+=String.format('{0}<a class="link-font" href="#" id="{1}">{2}</a>',_T("volume","volume_system_partition_fail_desc"),a.repairSysLinkId,_T("volume","volume_system_partition_fail_link"))}}},prepareDisk:function(x){var w=this,n={},u,l,g,b,k,y,q,f,c,t,a,o,r,p,d=0,v=0,h=0,e=0;var m=w.appWin.AHAInfo;var s=function(j,i){return(j.order>i.order)?1:((j.order===i.order)?0:-1)};x.expansions=[];x.diskInfoStat=[];Ext.each(w.appWin.disks.getAll(),function(j){if("disabled"===j.get("portType")){return true}g=j.get("container");if(j.isCacheTray()){return true}if(w.appWin.supportSas){if("ebox"===g.type){q=g.order;if(m){c=m.enclosures[q-1].max_disk;y=String.format("{0} {1}",m.enclosures[q-1].model,q)}else{c=12;var i=g.model.replace("Synology-","");y=String.format("{0} {1}",i,q)}}else{q=0;c=parseInt(_D("maxdisks",0),10);y=_S("hostname")}}else{if("ebox"===g.type){t=g.str.split("-");if(2!=t.length||3>t[0].length){return true}q=parseInt(t[1],10);f=t[0].match(/\d+/);if(!f||0===f.length){return true}c=parseInt(f[0].substr(0,f[0].length-2),10);y=g.str}else{q=0;c=parseInt(_D("maxdisks",0),10);y=_S("hostname")}}if(!n[q]){l={bayNumber:c,name:y,disks:[],nonEmptySlot:{}};n[q]=l}else{l=n[q]}if(""===j.get("used_by")){++h;o="unused"}else{if("hotspare"===j.get("used_by")){++v;o="spare"}else{++d;o="used"}}if("unused"===o){k=_T("volume","unused_size")}else{k=SYNO.SDS.StorageUtils.SpaceIDParser(j.get("used_by")).str}a=parseInt(j.get("order"),10);b=SYNO.SDS.Utils.StorageUtils.UiRenderHelper.DiskNameRenderer(j.get("name"));l.disks.push({status:o,order:a,displayName:b,usedBy:k});l.nonEmptySlot[a]=true},w);if(m){for(p=1;p<=m.enclosures.length;++p){if(!n[p]){c=m.enclosures[p-1].max_disk;y=String.format("{0} {1}",m.enclosures[p-1].model,p);l={bayNumber:c,name:y,disks:[],nonEmptySlot:{}};n[p]=l}else{l=n[p]}for(r=1;r<=l.bayNumber;++r){if(!l.nonEmptySlot[r]){++e;l.disks.push({status:"empty",order:r})}}l.disks.sort(s);x.expansions.push(l)}}else{for(u in n){if(n.hasOwnProperty(u)){l=n[u];for(r=1;r<=l.bayNumber;++r){if(!l.nonEmptySlot[r]){++e;l.disks.push({status:"empty",order:r})}}l.disks.sort(s);x.expansions.push(l)}}}x.diskInfoStat.push({type:"used",text:_T("volume","volume_used_disk"),count:d});x.diskInfoStat.push({type:"spare",text:_T("volume","volume_hot_spare_disk"),count:v});x.diskInfoStat.push({type:"unused",text:_T("volume","volume_unused_disk"),count:h});x.diskInfoStat.push({type:"empty",text:_T("volume","volume_available_slot"),count:e})},prepareVolume:function(d){var c=this,e,b,a;d.volCount=c.volumes.length;d.volumes=[];for(a=0;a<c.pieChartPos.length;++a){b={};e=c.pieChartPos[a];b.style=(3>=d.volCount)?1:2;b.pos=e;d.volumes.push(b)}c.pageCount=Math.ceil(c.volumes.length/c.numPerPage);c.volumes.sort(function(i,g){var h,f;if(0===parseInt(i.get("size").total,10)){h=0}else{h=parseInt(i.get("size").used,10)/parseInt(i.get("size").total,10)}if(0===parseInt(g.get("size").total,10)){f=0}else{f=parseInt(g.get("size").used,10)/parseInt(g.get("size").total,10)}return(h>f)?-1:((h===f)?0:1)})},prepareLun:function(c){var g=this,h=SYNO.SDS.StorageUtils,m=g.appWin.iscsiLuns.getAll(),l,d,k=0,n=0,j=0,b=0,a=0,f=0,e='<span style="font-size:12px"> {0}</span>';c.lunStat=[];for(d=0;d<m.length;++d){l=m[d];if("block"===l.get("iscsi_lun").device_type){k+=parseInt(l.get("iscsi_lun").size,10);n+=parseInt(l.get("iscsi_lun").size,10)}else{k+=parseInt(l.get("iscsi_lun").size,10)}}for(d=0;d<g.volumes.length;++d){n+=parseInt(g.volumes[d].get("eppool_used"),10)}j=(0>k-n)?0:(k-n);b=h.GetSizeUnit(k);a=h.GetSizeUnit(n);f=h.GetSizeUnit(j);c.reported=b.size;c.reportedUnit=b.unit;c.usedRatio=(0===k)?0:n/k*100;c.lunStat.push({type:"reported",text:_T("volume","volume_reported"),count:String.format("{0} {1}",b.size,String.format(e,b.unit))});c.lunStat.push({type:"used",text:_T("volume","volume_used"),count:String.format("{0} {1}",a.size,String.format(e,a.unit))});c.lunStat.push({type:"saved",text:_T("volume","volume_saved"),count:String.format("{0} {1}",f.size,String.format(e,f.unit))})},drawPieChart:function(){var l=this,b,e,f,p,k,d,o,h,j,i,a,m=SYNO.SDS.StorageUtils,c,n,g;l.pageIndex=(l.pageIndex>l.pageCount)?l.pageCount:l.pageIndex;l.pageIndex=(1>l.pageIndex)?1:l.pageIndex;b=(l.pageIndex-1)*l.numPerPage;e=(l.volumes.length<b+l.numPerPage)?l.volumes.length:b+l.numPerPage;if(1<l.pageCount){if(1===l.pageIndex){Ext.get("sm_overview_vol_prev").removeClass("sm-overview-vol-btn-enable");if(!Ext.get("sm_overview_vol_next").hasClass("sm-overview-vol-btn-enable")){Ext.get("sm_overview_vol_next").addClass("sm-overview-vol-btn-enable")}}else{if(l.pageIndex===l.pageCount){Ext.get("sm_overview_vol_next").removeClass("sm-overview-vol-btn-enable");if(!Ext.get("sm_overview_vol_prev").hasClass("sm-overview-vol-btn-enable")){Ext.get("sm_overview_vol_prev").addClass("sm-overview-vol-btn-enable")}}else{if(!Ext.get("sm_overview_vol_prev").hasClass("sm-overview-vol-btn-enable")){Ext.get("sm_overview_vol_prev").addClass("sm-overview-vol-btn-enable")}if(!Ext.get("sm_overview_vol_next").hasClass("sm-overview-vol-btn-enable")){Ext.get("sm_overview_vol_next").addClass("sm-overview-vol-btn-enable")}}}}l.cleanVolUsage();for(;b<e;++b){f=l.volumes[b];p=f.get("size");i=m.GetSizeUnit(p.used);a=m.GetSizeUnit(p.total);if(0===parseInt(p.total,10)){k=0}else{k=parseInt(p.used,10)/parseInt(p.total,10)}if(k>0.9){d="high"}else{if(k>0.8){d="mid"}else{d="low"}}o=l.pieChartColor[d];h=String.format("sm_overview_vol_chart_{0}",l.pieChartPos[b%3]);j=new SYNO.SDS.Utils.canvas.ColorCircleGradient({radius:60,gradientWidth:20,height:120,width:120,canvasConfig:{height:120,width:120},renderTo:h});j.draw(Math.min(k,1));l.chart[b%3]=j;c=String.format("{0} ({1})",m.SpaceIDParser(f.get("id")).str,m.StatusNameRender(f.get("status")));n=String.format('<span class="{0}">{1} {2}</span><span>&nbsp;/&nbsp;{3} {4}</span>',o.fontCls,i.size,i.unit,a.size,a.unit);g=f.get("desc")?f.get("desc"):"";h=String.format("sm_overview_vol_name_{0}",l.pieChartPos[b%3]);Ext.get(h).update(c);h=String.format("sm_overview_vol_desc_{0}",l.pieChartPos[b%3]);if(""===g){Ext.get(h).update("-");Ext.get(h).set({"ext:qtip":""})}else{Ext.get(h).update(g);Ext.get(h).set({"ext:qtip":g})}h=String.format("sm_overview_vol_text_{0}",l.pieChartPos[b%3]);Ext.get(h).update(n)}},cleanVolUsage:function(){var b=this,a;for(a=0;a<b.pieChartPos.length;++a){if(b.chart[a]){b.chart[a].destroy();delete b.chart[a]}Ext.get(String.format("sm_overview_vol_chart_{0}",b.pieChartPos[a])).update("");Ext.get(String.format("sm_overview_vol_name_{0}",b.pieChartPos[a])).update("");Ext.get(String.format("sm_overview_vol_desc_{0}",b.pieChartPos[a])).update("");Ext.get(String.format("sm_overview_vol_text_{0}",b.pieChartPos[a])).update("")}},checkSpaceStatus:function(b,e){var d=this,a="healthy",c;Ext.each(b,function(f){if(f.isLogicalVolume()){if(f.isVolume()){c=d.appWin.storagePools.data[f.get("pool_path")];if(c.isDegrade()||c.isCrashed()){return true}}else{return true}}if(f.isCrashed()){a="attention";return false}if(f.isDegrade()){a="caution"}},d);e.status=a;e.text=d.statusText[a];e.desc=d.statusDesc[a]},checkSsdCacheStatus:function(c,e){var d=this,b="healthy",a=false;Ext.each(c,function(f){if("write"===f.get("mode")||"write_bypass"===f.get("mode")){if(f.isCrashed()){b="attention";return false}else{if(f.isDegrade()){b="caution"}}}else{if("healthy"===b&&f.isCrashed()){b="caution";a=true}}},d);e.status=b;e.text=d.statusText[b];e.desc=a?_T("volume","ssd_cache_crash_desc"):d.statusDesc[b]},checkSysPartition:function(){var d=this,b=d.appWin.env.status;var c;var a=SYNO.SDS.StorageUtils;d.systemNeedRepair=b.system_need_repair;if(!d.systemNeedRepair){return}var e="";for(c=0;c<b.suggestions.length;c++){e+=String.format('<span class="red-status">{0}</span><br>',a.FormatSuggestion(b.suggestions[c]))}d.sysPartitionFailHtml=e},checkLinkValid:function(){var a=this,b=true;Ext.each(a.appWin.enclosures.getAll(),function(c){if(c.get("internal")){if(c.get("ports")[0].linkId!==c.get("ports")[1].linkId||1!==c.get("ports")[0].portNum||2!==c.get("ports")[1].portNum){b=false}}else{if(c.get("ports")[0].linkId!==c.get("ports")[1].linkId||c.get("ports")[2].linkId!==c.get("ports")[3].linkId||3!==c.get("ports")[2].portNum||4!==c.get("ports")[3].portNum){b=false}}return b},a);return b},checkDiskSmart:function(c){var b=this;var a=b.appWin.disks.getAll();Ext.each(a,function(d){if("danger"===d.get("smart_status")||"damage"===d.get("smart_status")){c.status="caution";c.text=b.statusText[c.status];c.desc=_T("smart","smart_error_attention");return false}},b)},setMask:function(){var a=this;if(a.volUsage.collapsed){return}if(0===a.volumes.length){a.volUsage.body.mask(_T("volume","volume_no_volumes"),"syno-ux-mask-info")}else{a.volUsage.body.unmask()}},repairSysConfirm:function(){var a=this.owner.getMsgBox();a.confirm(_T("volume","volume_adddisk2_type_repair"),this.sysPartitionFailHtml,this.repairSysPartition,this,{ok:_T("volume","volume_adddisk2_type_repair"),cancel:_T("common","cancel")})},repairSysPartition:function(a){var b=this;if("ok"!==a){return}b.owner.setStatusBusy();b.owner.cleanMask=true;b.appWin.stopPollTask();SYNO.API.Request({api:"SYNO.Storage.CGI.Storage",method:"repair_system_partition",version:1,callback:function(f,c,e,d){b.owner.clearStatusBusy();if(!f){b.owner.getMsgBox().alert(this.title,_T("common","commfail"))}b.appWin.startPollTask()},scope:b})}});Ext.define("SYNO.SDS.StorageManager.Wizard.DiskStep",{extend:"SYNO.ux.FormPanel",isSupportRaidCross:false,isNeedSelectSource:false,isOneBay:false,isOneBayWithNoEbox:false,space:null,allowBlank:false,filter:undefined,free_disks:null,free_disks_for_expand:null,isAnyInternal:false,isAnyInEbox:false,loaded:false,disks:null,isfirstTimeIn:true,create_mode_id:"createmode",custom_step_id:"customstep",manage_mode_id:"add_type",shr_step_id:"shrstep",check_step_id:"check",raid_type_id:"raid_type",single_disk_raid_type_id:"single_disk_raid_type",summary_step_id:"summary",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.isNeedSelectSource=a.isNeedSelectSource;c.free_disks_for_other=a.free_disks||[];c.free_disks_for_expand=a.free_disks_for_expand||[];c.space=a.space||null;c.validator=a.validator;b={headline:_T("volume","volume_add_diskselect"),labelWidth:200,items:[{layout:"hbox",itemId:"select",border:false,items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_disk_source_internal"),itemId:"internal",name:"container",inputValue:"internal",checked:true,listeners:{check:c.onSelectChanged,scope:c},width:120},{xtype:"syno_radio",boxLabel:_T("volume","volume_disk_source_ebox"),itemId:"ebox",name:"container",inputValue:"ebox",listeners:{check:c.onSelectChanged,scope:c}}]},{xtype:"syno_displayfield",name:"hint",value:_T("volume","volume_need_no_disk_tip")},c.createGrid({itemId:"disks"})]};c.callParent([Ext.apply(b,a)])},createGrid:function(a){var c=new SYNO.ux.EnableColumn({dataIndex:"enabled",id:"enable",bindRowClick:true,sortable:true,align:"center"});var b=Ext.apply({enableHdMenu:false,layout:"fit",cls:"without-dirty-red-grid",plugins:c,columns:[c,{header:_T("volume","volume_disknumber"),dataIndex:"name",width:200},{header:_T("volume","volume_diskmodel"),dataIndex:"model",width:200},{header:_T("volume","volume_disk_type"),dataIndex:"diskType",width:100},{header:_T("volume","4k_hdd"),dataIndex:"is4Kn",width:60,renderer:function(d){if(d){return _T("common","yes")}return _T("common","no")}},{header:_T("volume","volume_diskcapacity"),dataIndex:"size_total",width:140,renderer:SYNO.SDS.StorageUtils.SizeRender}],store:this.disks=new Ext.data.JsonStore({autoDestroy:true,fields:["id","enabled","name","model","size_total","container","numId","diskType","is4Kn"],listeners:{update:function(d,e,f){if(Ext.data.Record.EDIT!==f){return}if(!this.allowBlank){this.checkState()}},scope:this}})},a);return new SYNO.ux.GridPanel(b)},loadDisks:function(){var d=this,c,f,e=[],b=d.isfirstTimeIn,a=this.getSource();for(c=0;c<d.free_disks.length;c++){f=d.free_disks[c];if("ebox"===a&&f.isInternal()){continue}if("internal"===a&&f.isInEbox()){continue}e.push({enabled:b,id:f.get("id"),num_id:f.get("num_id"),name:f.get("name"),model:f.get("model"),size_total:f.get("size_total"),container:f.get("container"),diskType:f.get("isSsd")?"SSD":"HDD",is4Kn:f.get("is4Kn")})}e.sort(function(h,g){if(h.container.order>g.container.order){return 1}if(h.container.order<g.container.order){return -1}if(h.num_id>g.num_id){return 1}if(h.num_id<g.num_id){return -1}return 0});d.disks.loadData(e,false);d.getComponent("disks").setHeight(45+e.length*28)},showAllowEmptyHint:function(a){SYNO.SDS.Utils.DisplayField(this.getForm(),"hint",a)},showSourceSelector:function(a){if(!a){this.getComponent("select").hide()}else{this.getComponent("select").show()}},isInternal:function(a){return"internal"===a.get("container").type},isNeedCrossWarning:function(){var c=false;var d=false;var b,a;if(this.space){a=this.space.get("container");if("cross"===a){return false}if("internal"===a){c=true}else{d=true}}for(b=0;b<this.disks.getCount();b++){if(!this.disks.getAt(b).get("enabled")){continue}if(this.isInternal(this.disks.getAt(b))){c=true}else{d=true}if(c&&d){return true}}return false},isNeedPowerButtonDisableWarning:function(){for(var a=0;a<this.disks.getCount();a++){if(!this.disks.getAt(a).get("enabled")){continue}if(this.disks.getAt(a).get("container").supportPwrBtnDisable){return true}}return false},isSelectAny:function(){for(var a=0;a<this.disks.getCount();a++){if(this.disks.getAt(a).get("enabled")){return true}}return false},isCreateLunBlockOnOneBay:function(){if(this.space){return this.isOneBay&&this.space.isISCSIBlock()}else{if(this.owner.inHistory("luntypestep")){return this.owner.getStep("luntypestep").getType()==="iscsi_block_general"&&this.isOneBay}}return false},getIds:function(){var a=[];this.disks.each(function(b){if(b.get("enabled")){a.push(b.id)}});return a},getNames:function(){var a=[];this.disks.each(function(b){if(b.get("enabled")){a.push(b.get("name"))}});return a},getDisks:function(){var a=[];this.disks.each(function(b){if(b.get("enabled")){a.push(b)}});return a},getStore:function(){return this.disks},getSource:function(){if(this.isNeedSelectSource){return this.getForm().getValues().container}else{if(this.space&&!this.isSupportRaidCross){return this.space.get("container")}else{return"all"}}},diskChooserValidater:function(a,j,d){var e=this;var b=this.getDiskCountLimit(a,j,d);var f=this.getDisks();var c=f.length;var h=false,i=false,g=false;if(0<b.max&&c>b.max){this.owner.getMsgBox().alert(this.owner.title,String.format(_T("volume","volume_max_disks_count"),b.max));return false}if(c<b.min){this.owner.getMsgBox().alert(this.owner.title,String.format(_T("volume","volume_min_disk_count"),b.min));return false}if(this.isDiskExceedMax(f,a)){this.owner.getMsgBox().alert(this.owner.title,_T("volume","volume_disk_3tb_limitation"));return false}Ext.each(a.get("disks"),function(k){h=e.appWin.disks.data[k].is4Kn();return false});Ext.each(f,function(k){if(k.get("is4Kn")){i=true}else{g=true}});if((h&&g)||(!h&&i)){this.owner.getMsgBox().alert(this.owner.title,_T("volume","not_allow_hybrid_hdd"));return false}return true},getDiskCountLimit:function(e,f,g){var d=e?e.get("can_do"):{};var c=0;var a=0;switch(f){case"repair":c=d.repair;break;case"expand":a=d.expand;break}if(Ext.isDefined(g)){switch(g){case"add_mirror":c=d.migrate.add_mirror;break;case"to_raid1":c=d.migrate.to_raid1;break;case"to_raid5+spare":var b=d.migrate["to_raid5+spare"].split("-");a=parseInt(b[0],10);c=parseInt(b[1],10);break;case"to_raid5":a=d.migrate.to_raid5;break;case"to_raid6":a=d.migrate.to_raid6;break}}return{max:c,min:a}},isDiskExceedMax:function(a,d){var c=parseInt(d.get("maximal_disk_size"),10);var e=0;if(undefined===c||0===c){return false}for(var b=0;b<a.length;b++){e=parseInt(a[b].get("size_total"),10);if(c<e){return true}}return false},onSelectChanged:function(){this.loadDisks()},activate:function(){var c=this,b,a;if(c.owner.inHistory("add_type")){if(c.addType!==c.owner.getStep("add_type").getType()){c.addType=c.owner.getStep("add_type").getType();c.free_disks=("expand_by_disk"===c.addType)?c.free_disks_for_expand:c.free_disks_for_other;c.loaded=false}}else{c.free_disks=c.free_disks_for_other}if(c.loaded){return}c.loaded=true;c.showAllowEmptyHint(c.allowBlank);c.showSourceSelector(c.isNeedSelectSource);c.owner.doLayout();c.isAnyInternal=false;c.isAnyInEbox=false;for(b=0;b<c.free_disks.length;b++){if(c.free_disks[b].isInternal()){c.isAnyInternal=true}else{if(c.free_disks[b].isInEbox()){c.isAnyInEbox=true}}}if(c.isNeedSelectSource){a=c.getComponent("select");if(!c.isAnyInternal||c.isCreateLunBlockOnOneBay()){a.getComponent("internal").disable();a.getComponent("ebox").setValue(true)}if(!c.isAnyInEbox){a.getComponent("ebox").disable();a.getComponent("internal").setValue(true)}}c.onSelectChanged()},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);if(this.owner.inHistory("add_type")&&this.isfirstTimeIn){this.loadDisks(false);this.isfirstTimeIn=false}if(this.allowBlank||this.isSelectAny()){this.owner.getButton("next").enable()}else{this.owner.getButton("next").disable()}},getNextId:function(c){var b=this,a;if(b.raidGroup){a=b.nextId}else{if(b.owner.inHistory(b.create_mode_id)&&!b.owner.inHistory(b.custom_step_id)){if(c>=4){a=b.shr_step_id}else{a=b.check_step_id}}else{if((b.owner.inHistory(b.create_mode_id)&&b.owner.inHistory(b.custom_step_id))||0===b.owner.stepStack.length){if(1===c){a=b.single_disk_raid_type_id}else{a=b.raid_type_id}}else{if(b.owner.inHistory(b.manage_mode_id)){a=b.summary_step_id}else{SYNO.Debug("the next page is unknown")}}}}if(a===b.check_step_id){if(2<b.getDisks().length){a=b.owner.getStep("check").getNext()}}return a},getNext:function(){var h=this,c="",f,g;var e=null;var a=false;var d=false;var i=this.getDisks(),j=false,k=false;e=this.getComponent("select");f=this.getIds().length;if(this.isOneBayWithNoEbox||(this.isOneBay&&e.items.get(0).getValue()&&!this.owner.inHistory(h.manage_mode_id))){return h.check_step_id}else{if(this.isOneBay&&!this.owner.inHistory(h.manage_mode_id)){if(1==f){return h.single_disk_raid_type_id}else{return h.raid_type_id}}}if(Ext.isFunction(this.validator)){if(!this.validator()){return false}}Ext.each(i,function(l){if(!l.get("is4Kn")){j=true}else{k=true}});if(j&&k){this.owner.getMsgBox().alert(this.owner.title,_T("volume","not_allow_hybrid_hdd"));return false}if(f===0&&!this.allowBlank){return false}if(!(g=this.getNextId(f))){return false}if(!this.raidGroup&&this.isNeedCrossWarning()){c+=String.format("1. {0}<p>2. {1}",_T("volume","volume_mix_disks_warning"),_T("volume","volume_adddisk_type_two_warning"));d=true}else{c+=_T("volume","volume_adddisk_type_two_warning");d=false}if(!this.raidGroup&&this.isNeedPowerButtonDisableWarning()){a=true}else{a=false}var b=new SYNO.SDS.StorageManager.Volume.Dialog.SpaceCreationWarningWindow({owner:this.owner,warningMsg:c,showPwrChk:a,next_id:g,isCrossRAID:d});b.open();return false},deactivate:function(){this.owner.getButton("next").enable()},summary:function(a){if(this.getNames().length>0){a.append(_T("volume","volume_apply_disk"),this.getNames().join(", "))}}});Ext.define("SYNO.SDS.StorageManager.Wizard.SingleDiskRaidTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b={headline:_T("volume","volume_add_levelselect"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_type_raid_shr"),name:"raid",itemId:"shr",inputValue:"shr",checked:true},{xtype:"syno_displayfield",value:_T("volume","volume_type_description_shr"),itemId:"shr_description",indent:1},{xtype:"syno_radio",boxLabel:_T("volume","volume_generalhd"),name:"raid",itemId:"basic",inputValue:"basic"},{xtype:"syno_displayfield",value:_T("volume","volume_type_description_basic"),indent:1},{xtype:"syno_radio",boxLabel:_T("volume","volume_type_linear"),name:"raid",itemId:"raid_linear",inputValue:"raid_linear"},{xtype:"syno_displayfield",value:_T("volume","volume_type_description_linear"),indent:1}]};b=Ext.apply(b,a);this.callParent([b])},getType:function(){return this.getForm().findField("raid").getGroupValue()},activate:function(){var a=this.getComponent("shr");if((this.owner.inHistory("luntypestep")||this.owner.inHistory("customstep")||this.isOneBay)&&!this.owner.isPoolChild()||_S("ha_running")){a.hide();a.disable();this.getComponent("shr_description").hide();if(a.checked){this.getComponent("basic").setValue(true)}}else{a.enable();a.show();this.getComponent("shr_description").show()}},getNext:function(){return this.nextId},summary:function(b){var a=this.owner.getRaidType();if(a.substr(0,3)!=="shr"){b.append(_T("volume","volume_level"),SYNO.SDS.StorageUtils.DeviceTypeRender(a))}else{b.append(_T("volume","volume_level"),SYNO.SDS.StorageUtils.SpaceTypeRender(a))}}});Ext.define("SYNO.SDS.StorageManager.Wizard.RaidTypeStep",{extend:"SYNO.ux.FormPanel",isOneBay:false,btn_names:["shr","raid_1","raid_5","raid_5+spare","raid_6","raid_10","basic","raid_linear","raid_0"],raidTypeMapping:{3:"raid_5",4:"raid_6"},diskNum:-1,setDefault:true,vgType:null,constructor:function(a){var b={headline:_T("volume","volume_add_levelselect"),items:[{xtype:"syno_displayfield",value:_T("volume","volume_add_tip_dataprotection")},{xtype:"syno_radio",boxLabel:_T("volume","volume_type_raid_shr"),name:"raid",itemId:"shr",inputValue:"shr"},{xtype:"syno_radio",boxLabel:_T("volume","volume_type_raid_1"),name:"raid",itemId:"raid_1",inputValue:"raid_1"},{xtype:"syno_radio",boxLabel:_T("volume","volume_type_raid_5"),name:"raid",itemId:"raid_5",inputValue:"raid_5"},{xtype:"syno_radio",boxLabel:String.format("{0}+Spare",_T("volume","volume_type_raid_5")),name:"raid",itemId:"raid_5+spare",inputValue:"raid_5+spare"},{xtype:"syno_radio",boxLabel:_T("volume","volume_type_raid_6"),name:"raid",itemId:"raid_6",inputValue:"raid_6"},{xtype:"syno_radio",boxLabel:_T("volume","volume_type_raid_10"),name:"raid",itemId:"raid_10",inputValue:"raid_10"},{xtype:"syno_displayfield",value:_T("volume","volume_add_tip_nodataprotection")},{xtype:"syno_radio",boxLabel:_T("volume","volume_generalhd"),name:"raid",itemId:"basic",inputValue:"basic"},{xtype:"syno_radio",boxLabel:_T("volume","volume_type_linear"),name:"raid",itemId:"raid_linear",inputValue:"raid_linear"},{xtype:"syno_radio",boxLabel:_T("volume","volume_type_raid_0"),name:"raid",itemId:"raid_0",inputValue:"raid_0"}]};b=Ext.apply(b,a);this.callParent([b]);this.on("afterlayout",this.addTip,this,{single:true})},addTip:function(){var a=_T("volume","volume_add_mode_systemdefault_help");if(this.owner.appWin.supportHA){a+='<span class="syno-ux-note"><br/>'+_T("common","note")+_T("common","colon")+" </span>"+_T("volume","volume_type_shr_support_note")}SYNO.SDS.Utils.AddTip(this.form.findField("shr").getEl(),a)},getType:function(){if(1===this.owner.getDiskIds().length){return this.owner.getStep("single_disk_raid_type").getType()}return this.getForm().findField("raid").getGroupValue()},disableAllRadioButton:function(){Ext.each(this.btn_names,function(a){this.getComponent(a).disable()},this)},enableButtons:function(){Ext.each(arguments,function(a){if(this.btn_names.indexOf(a)===-1){throw Error("incorrect button name: "+a)}this.getComponent(a).enable()},this)},setDefaultType:function(){var c;var b;var a;if("novg"===this.vgType){a=this.owner.getStep("disk").getIds().length;b=this.raidTypeMapping[a>4?4:a];if(b&&!this.getComponent(b).disabled){this.getComponent(b).setValue(true);return}}for(c=0;c<this.btn_names.length;c++){b=this.btn_names[c];if(!this.getComponent(b).disabled){this.getComponent(b).setValue(true);break}}},activate:function(){this.disableAllRadioButton();if("yes"===_D("support_hotspare","no")){this.getComponent("raid_5+spare").hide()}else{this.getComponent("raid_5+spare").show()}var b="luntypestep";var c="customstep";var e="disk";var d=0;var a=this.getType();if(this.owner.inHistory(e)){d=this.owner.getDiskIds().length}if(d==1){if(!_S("ha_running")){this.enableButtons("basic","shr")}else{this.enableButtons("basic")}}if(d>=2){if(!_S("ha_running")){this.enableButtons("shr","raid_1","raid_0","raid_linear")}else{this.enableButtons("raid_1","raid_0","raid_linear")}}if(d>=3){this.enableButtons("raid_5")}if(d>=4){this.enableButtons("raid_5+spare","raid_6");if(d%2===0){this.enableButtons("raid_10")}}if(d>=5){this.getComponent("raid_1").disable()}if((this.owner.inHistory(b)||this.owner.inHistory(c)||this.isOneBay)&&!this.owner.isPoolChild()){this.getComponent("shr").hide();this.getComponent("shr").disable()}else{this.getComponent("shr").show()}this.setDefault=this.diskNum!==this.owner.getStep("disk").getIds().length;this.diskNum=this.owner.getStep("disk").getIds().length;if((this.owner.inHistory("createmode")&&"single"===this.owner.getStep("customstep").getForm().getValues().customstep)||this.owner.inHistory("luntypestep")&&"iscsi_block_general"===this.owner.getStep("luntypestep").getType()){this.setDefault=this.setDefault?this.setDefault:this.vgType!=="novg";this.vgType="novg"}else{this.setDefault=this.setDefault?this.setDefault:this.vgType!=="vg";this.vgType="vg"}if(this.setDefault){a=null}if(!a){this.setDefaultType()}else{if(this.getComponent(a).disabled){this.setDefaultType()}else{}}},getNext:function(){var a="shrstep";var d="check";var f="disk";var e;var b;var c=this.getForm().findField("raid").getGroupValue();if(this.owner.inHistory(f)){e=this.owner.getDiskIds().length}if(this.getForm().getValues().raid==="shr"){if(e>=4){b=a}else{b=d}}else{b=d}if(b===d){switch(c){case"shr":case"raid_5":case"raid_6":if(2<this.owner.getDiskIds().length){b=this.owner.getStep("check").getNext()}break;default:break}}return b},summary:function(b){var a=this.owner.getRaidType();if(a.substr(0,3)!=="shr"){b.append(_T("volume","volume_level"),SYNO.SDS.StorageUtils.DeviceTypeRender(a))}else{b.append(_T("volume","volume_level"),SYNO.SDS.StorageUtils.SpaceTypeRender(a))}}});Ext.define("SYNO.SDS.StorageManager.Wizard.ShrTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.loaded=false;var b={headline:_T("volume","volume_choose_shr_protect_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_add_tip_dataprotection_by_1_disk"),name:"shrstep",itemId:"shr_with_1_disk_protect",inputValue:"shr_with_1_disk_protect",checked:true},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_type_shr_with_1_disk_protect_help")},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_radio",boxLabel:_T("volume","volume_add_tip_dataprotection_by_2_disks"),name:"shrstep",itemId:"shr_with_2_disk_protect",inputValue:"shr_with_2_disk_protect"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_type_shr_with_2_disks_protect_help")}]};b=Ext.apply(b,a);this.callParent([b])},activate:function(){if(this.loaded){return}this.getComponent("shr_with_1_disk_protect").enable();this.getComponent("shr_with_2_disk_protect").enable();this.getComponent("shr_with_1_disk_protect").setValue(true);this.loaded=true},getNext:function(){return this.owner.getStep("check").getNext()},getType:function(){return this.getForm().getValues().shrstep},summary:function(a){}});Ext.define("SYNO.SDS.StorageManager.Wizard.PoolStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.loaded=false;c.appWin=a.appWin;c.pools=c.appWin.storagePools.getMatched("isFreeSizeBiggerThan1GB","isWritable","notUsedByGlusterFs");c.freeDisks=c.appWin.disks.getMatched("isNormalTray","isFree");b={headline:_T("volume","volume_choose_raid_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_create_raid"),name:"poolstep",itemId:"create",inputValue:"create",checked:true},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_create_raid_help")},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_radio",boxLabel:_T("volume","volume_choose_existing_raid"),name:"poolstep",itemId:"existing",inputValue:"existing"},{xtype:"syno_storage_combobox",fieldLabel:_T("volume","volume_pool"),indent:1,width:250,name:"pools",itemId:"pools",hiddenName:"pools",valueField:"id",displayField:"display",descriptionField:"desc",store:c.poolStore=new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:["id","display","avail","total","desc","raidLevel"]})}]};c.callParent([Ext.apply(b,a)])},activate:function(){var h=this,l=SYNO.SDS.StorageUtils,m=h.appWin.storagePools.getMatched("isFreeSizeBiggerThan1GB","isWritable","notUsedByGlusterFs"),k=h.appWin.disks.getMatched("isNormalTray","isFree"),b=false,f=[],o,j,n,g,e,a,d,c;c=new SYNO.ux.Utils.EnableRadioGroup(h.getForm(),"poolstep",{existing:["pools"]});if(h.loaded){return}if(0===k.length){h.getComponent("create").disable()}else{h.getComponent("create").enable();h.getComponent("create").setValue(true);b=true}if(0===m.length){h.getComponent("existing").disable()}else{for(e=0;e<m.length;++e){a=m[e].get("id");d=m[e].get("device_type");o=m[e].get("size");n=parseInt(o.used,10);j=parseInt(o.total,10);g=j-n;f.push({id:a,display:String.format("{0} ({1}: {2})",l.SpaceIDParser(a).str,_T("volume","volume_freesize"),l.SizeRenderWithFloor(g)),avail:g,total:j,numId:m[e].get("num_id"),desc:m[e].get("desc"),raidLevel:d})}f.sort(function(p,i){return(p.numId>i.numId)?1:((p.numId===i.numId)?0:-1)});h.poolStore.loadData(f);h.getForm().findField("pools").setValue(h.poolStore.getAt(0).get("id"));if(!b){h.getComponent("existing").setValue(true)}}h.loaded=true},getNext:function(){return this.nextId[this.getForm().getValues().poolstep]},getCurRecord:function(){var a=this.getForm().findField("pools").getValue();return this.poolStore.getById(a)},getValues:function(){return this.getForm().getValues().poolstep},summary:function(a){}});Ext.define("SYNO.SDS.StorageManager.Wizard.VolumeSizeStep",{extend:"SYNO.ux.FormPanel",constructor:function(b){var e=this,d;e.deviceType=undefined;e.maxFreeSizeGB=undefined;e.minSizeGB=1;e.maxFreeSizeByte=undefined;e.sizeValueInput=undefined;e.appWin=b.appWin;e.deviceType=b.deviceType;var a=_T("volume","volume_allocate_size_field_name");var c=_T("volume","volume_totalsize");if(e.deviceType=="lun"){a=_T("iscsilun","iscsilun_allocate_size_field_name");c=_T("iscsilun","iscsilun_totalsize")}d={headline:_T("volume","volume_allocate_size_title"),items:[{xtype:"syno_displayfield",value:_T("volume","volume_pool_info_header")},{xtype:"syno_displayfield",indent:1,fieldLabel:_T("common","name"),itemId:"pool_name",value:""},{xtype:"syno_displayfield",indent:1,fieldLabel:_T("volume","volume_totalsize"),itemId:"pool_total",value:""},{xtype:"syno_displayfield",indent:1,fieldLabel:_T("volume","volume_freesize"),itemId:"pool_free",value:""},{xtype:"syno_displayfield",width:10,value:" "},{indent:0,xtype:"panel",layout:"hbox",itemId:"size",border:false,fieldLabel:String.format("{0} ({1})",a,_T("common","size_gb")),labelStyle:"line-height: 28px;padding:0px;",bodyStyle:{padding:"0px 0px 0px 0px"},items:[{xtype:"syno_numberfield",allowDecimals:false,width:100,value:"1",itemId:"size_value"},{xtype:"syno_displayfield",width:10,value:" "},{xtype:"syno_button",itemId:"size_max",text:_T("common","max"),handler:function(g,f){this.SizeValueInput.setValue(this.maxFreeSizeGB)},scope:this}]}]};this.callParent([Ext.apply(d,b)])},getEstimatedSize:function(){var a=this;a.owner.setStatusBusy();a.owner.getButton("next").disable();SYNO.API.Request({api:"SYNO.Storage.CGI.Pool",method:"estimate_size",version:1,params:{estimate_for:"create",disk_id:a.owner.getDiskIds(),device_type:a.owner.getRaidType()},callback:function(i,h,g,c){var b=SYNO.SDS.StorageUtils;var f,d;var e=a.appWin.getMaxVolumeSize(false);a.owner.clearStatusBusy();if(!i){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,h);a.owner.getButton("next").disable();return}if(!_S("demo_mode")){a.owner.getButton("next").enable()}f=d=h.size;if(a.deviceType==="lun"){a.maxFreeSizeGB=b.GetSizeGB(f,0);a.maxFreeSizeByte=f}else{if(parseInt(e,10)<parseInt(f,10)){a.maxFreeSizeGB=b.GetSizeGB(e,0);a.maxFreeSizeByte=parseInt(e,10)}else{a.maxFreeSizeGB=b.GetSizeGB(f,0);a.maxFreeSizeByte=f}if(a.owner.getFsType&&a.owner.getFsType()==="btrfs"){a.minSizeGB=10}else{a.minSizeGB=1}}a.SizeValueInput.setValue(a.maxFreeSizeGB);a.getComponent("pool_name").setValue(b.SpaceIDParser(h.new_pool_path).str);a.getComponent("pool_total").setValue(b.SizeRender(d,2));a.getComponent("pool_free").setValue(String.format("{0} {1}",a.maxFreeSizeGB,_T("common","size_gb")))},scope:a})},activate:function(){var e=this,a=SYNO.SDS.StorageUtils,g,c,b,f,d;e.SizeValueInput=e.getComponent("size").getComponent("size_value");e.getComponent("size").doLayout();if(e.owner.getStep("poolstep").getValues()==="create"){e.getEstimatedSize()}else{f=e.owner.getStep("poolstep").getCurRecord();d=e.appWin.getMaxVolumeSize(false);b=f.get("id");g=f.get("avail");c=f.get("total");if(e.deviceType==="lun"){e.maxFreeSizeGB=a.GetSizeGB(g,0);e.maxFreeSizeByte=g}else{if(parseInt(d,10)<parseInt(g,10)){e.maxFreeSizeGB=a.GetSizeGB(d,0);e.maxFreeSizeByte=parseInt(d,10)}else{e.maxFreeSizeGB=a.GetSizeGB(g,0);e.maxFreeSizeByte=g}if(e.owner.getFsType&&e.owner.getFsType()==="btrfs"){e.minSizeGB=10}else{e.minSizeGB=1}}e.SizeValueInput.setValue(e.maxFreeSizeGB);e.getComponent("pool_name").setValue(a.SpaceIDParser(b).str);e.getComponent("pool_total").setValue(a.SizeRender(c,2));e.getComponent("pool_free").setValue(String.format("{0} {1}",e.maxFreeSizeGB,_T("common","size_gb")))}},getNext:function(){var d=this,b,c,e,a=d.SizeValueInput.getValue();b=String.format("{0}",d.minSizeGB);c=String.format("{0}",d.maxFreeSizeGB);e=String.format(_T("volume","volume_valid_range_warning"),b,c);if(d.maxFreeSizeGB<a||d.minSizeGB>a){d.SizeValueInput.markInvalid(e);return false}if(d.deviceType=="lun"){return d.nextId[d.owner.getLunTypeMappedTargets()]}else{return d.nextId}},getValues:function(){return this.SizeValueInput.getValue()},summary:function(a){a.append(_T("volume","volume_pool"),this.getComponent("pool_name").getValue());a.append(_T("volume","volume_size_allocated"),String.format("{0} {1}",this.SizeValueInput.getValue(),_T("common","size_gb")))}});Ext.define("SYNO.SDS.StorageManager.Wizard.DiskCheckStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b={headline:_T("volume","volume_diskcheck"),items:[{xtype:"syno_radio",boxLabel:String.format("{0} ({1})",_T("common","yes"),_T("volume","volume_recommand")),name:"check",inputValue:"yes",itemId:"check"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_diskcheck_enable_help")},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_radio",boxLabel:String.format("{0}",_T("common","no")),name:"check",inputValue:"no",itemId:"nocheck"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_diskcheck_disable_help")}]};b=Ext.apply(b,a);this.callParent([b])},isChecked:function(){return this.getForm().getValues().check==="yes"},getNext:function(){var a="poolstep";var d="allocate_size_on_pool_step";var b="fsstep";var e="edit_desc";var c;if("yes"===_D("support_btrfs","no")){c=b}else{if(!this.owner.inHistory(a)){c=e}else{c=d}}return this.nextId[c]},summary:function(a){a.append(_T("volume","volume_diskcheck_title"),this.isChecked()?_T("common","yes"):_T("common","no"))},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);var a;if(this.owner.appWin.supportRaidGroup){a=this.owner.getRaidLevel()}else{a=this.owner.getRaidType()}switch(a){case"shr_without_disk_protect":case"basic":case"raid_0":case"raid_linear":case"shr_with_1_disk_protect":this.getComponent("check").setValue(true);break;default:this.getComponent("nocheck").setValue(true)}}});Ext.define("SYNO.SDS.StorageManager.Wizard.EditDescriptionStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.setDefaultDesc=true;var b={headline:_T("volume","volume_edit_description"),items:[{xtype:"syno_textfield",itemId:"desc",name:"desc",fieldLabel:_T("share","share_comment"),width:300,maxLength:64,enableKeyEvents:true,value:"",listeners:{keypress:function(){this.setDefaultDesc=false},scope:this}}]};b=Ext.apply(b,a);this.callParent([b])},getDescription:function(){return this.getComponent("desc").getValue()},getNext:function(){if(!this.getForm().isValid()){return false}return this.nextId},summary:function(a){a.append(_T("share","share_comment"),Ext.util.Format.htmlEncode(this.getDescription()))},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);var i,c,g,f,b;var a,d,h;var e="";if(!this.setDefaultDesc){return}f=false;if(!this.owner.isCreatePool&&!this.appWin.isSingleBay()){a=this.owner.getStep("createmode").getForm().getValues().choose_mode;h=this.owner.getStep("customstep").getForm().getValues().customstep;d=this.owner.getStep("poolstep").getForm().getValues().poolstep;if("custom"===a&&"multiple"===h){if("create"===d){g=this.owner.getStep("allocate_size_on_pool_step").getComponent("pool_name").getValue()}else{c=this.owner.getStep("poolstep").getCurRecord();g=SYNO.SDS.StorageUtils.SpaceIDParser(c.get("id")).str}f=true}}if(f){e+=String.format(_T("volume","volume_default_desc"),g);e+=", "}i=this.owner.getRaidType();e+=SYNO.SDS.StorageUtils.RaidLevelRender(i);if("yes"===_D("support_btrfs","no")&&!this.owner.isCreatePool){if(this.owner instanceof SYNO.SDS.StorageManager.Wizard.CreateVolumeMain){b=this.owner.getStep("fsstep").getFsType();e+=String.format(", {0}",b)}}this.getComponent("desc").setValue(e)}});Ext.define("SYNO.SDS.StorageManager.Wizard.SummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(a){this.isOneBay=false;Ext.apply({},a);this.callParent([a])},activate:function(){var a=this;a.callParent(arguments);if(a.owner.inHistory("createmode")&&a.owner.getStep("createmode").isSelectSHR()){a.getStore().append(_T("volume","volume_level"),SYNO.SDS.StorageUtils.SpaceTypeRender(a.owner.getRaidType()))}else{if(a.isOneBay&&!(a.owner.inHistory("raid_type")||a.owner.inHistory("single_disk_raid_type"))){a.getStore().append(_T("volume","volume_level"),SYNO.SDS.StorageUtils.DeviceTypeRender(a.owner.getRaidType()))}}if(!a.owner.inHistory("disk")||a.owner.inHistory("poolstep")){return}a.owner.setStatusBusy();a.owner.getButton("next").disable();SYNO.API.Request({api:a.owner.api,method:"estimate_size",version:1,params:{estimate_for:"create",disk_id:a.owner.getDiskIds(),space_id:a.owner.space.get("id")},callback:function(g,f,e,c){var d={};var b=a.appWin.getMaxVolumeSize(false);a.owner.clearStatusBusy();if(!g){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);a.owner.getButton("next").disable();return}if(!_S("demo_mode")){a.owner.getButton("next").enable()}a.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(f.size));if(parseInt(f.size,10)>parseInt(b,10)){d.text=_T("error","error_volume_oversize");d.text=String.format(d.text,SYNO.SDS.StorageUtils.SizeRender(b));SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);a.owner.getButton("next").disable();return}},scope:a})},getNext:function(){this.owner.applySettings();return false},disableNextInDemoMode:true});Ext.define("SYNO.SDS.StorageManager.Wizard.Manage",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var c=this;c.isDataChanged=false;c.appWin=a.appWin;c.owner=a.owner;c.spaceType=a.spaceType;c.space=a.space||undefined;c.disks=a.disks||[];c.disksForExpand=a.disksForExpand||[];c.add_type=a.add_type||{};c.migrate_type=a.migrate_type||{};c.api=a.api;c.hasFailedDisk=a.hasFailedDisk||false;var b={title:a.title,cls:"sm-wizard-main",width:640,height:520,minHeight:475,minWidth:640,resizable:true,border:false,steps:[]};if(c.appWin.supportRaidGroup&&"expand_with_unalloc_size"===c.add_type){c.activeStep="summary"}else{c.activeStep="add_type"}b.steps.push(new SYNO.SDS.StorageManager.Wizard.ManageTypeStep({appWin:c.appWin,add_type:c.add_type,hasFailedDisk:c.hasFailedDisk,device_type:c.space.getDeviceType(),spaceType:c.spaceType,itemId:"add_type",nextId:{scrubbing:"scrubbing_type",migrate:"migrate_type",choose_disk:"disk",other:"summary"}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.ScrubbingTypeStep({appWin:c.appWin,itemId:"scrubbing_type",nextId:"summary"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.MigrateTypeStep({appWin:c.appWin,migrate_type:c.migrate_type,migrate_constrain:c.space.get("can_do").migrate,itemId:"migrate_type",nextId:"disk"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskStep({validator:function(){return this.diskChooserValidater(this.owner.space,this.owner.getAddType(),this.owner.getMigrateType())},free_disks:c.disks,free_disks_for_expand:c.disksForExpand,isSupportRaidCross:c.appWin.isSupportRaidCross(),isNeedSelectSource:false,isOneBay:1===c.appWin.getBayNumber(),space:c.space,appWin:c.appWin,itemId:"disk",nextId:{summary:"summary"}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.ManageSummaryStep({appWin:c.appWin,itemId:"summary",nextId:null}));c.callParent([Ext.apply(b,a)])},onOpen:function(){var a=this;a.setActiveStep(a.activeStep);a.callParent(arguments)},getAddType:function(){if(this.inHistory("add_type")){return this.getStep("add_type").getType()}else{if(this.appWin.supportRaidGroup){return this.add_type}else{throw Error("wrong flow control")}}},getScrubbingType:function(){if(this.inHistory("scrubbing_type")){return this.getStep("scrubbing_type").getScrubbingType()}else{return this.getStep("add_type").getScrubbingType()}},getMigrateType:function(){if(this.inHistory("migrate_type")){return this.getStep("migrate_type").getType()}else{return undefined}},getDiskIds:function(){if(this.inHistory("disk")){return this.getStep("disk").getIds()}else{return[]}},getActionType:function(){var a=this.getAddType();if("migrate"===a){return"migrate_"+this.getMigrateType()}else{return a}},applySettings:function(b){var a="";switch(b){case"stop_in_minutes":a=String.format(_T("volume","volume_change_service_stop_in_minutes"),_T("common","ask_cont"));break;default:}if(a!==""){if("iscsilun"!==this.spaceType&&"yes"===_D("support_share_encryption","no")){a=String.format("1. {0}<p>2. {1}",_T("volume","volume_share_encryption_unmount_warning"),a)}this.getMsgBox().confirm(this.title,a,function(c){if("yes"===c){this.sendReuqest()}},this);return}this.sendReuqest()},sendReuqest:function(){var c=this;var g;var f={};var a=this.getDiskIds();var e=this.getAddType();var b=this.getActionType();var d=this.getScrubbingType();f.space_id=this.space.get("id");switch(e){case"repair":g="repair";f.disk_id=a;break;case"data_scrubbing":g=d;if(this.space.isVolume()){f.vol_path=this.space.get("vol_path")}break;case"expand_by_disk":if("iscsilun"===c.spaceType){g="expand_iscsilun_by_add_disk"}else{g="expand_by_add_disk"}f.disk_id=a;break;case"expand_with_unalloc_size":g="expand_unallocated";break;case"migrate":g="migrate";f.migrate_type=b;f.disk_id=a;break;case"expand_unfinished_shr":g="expand_unfinished_shr";break;case"defrag":g="defrag";f.vol_path=this.space.get("vol_path");break;default:SYNO.Debug("unknown add type");return}this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:c.api,method:g,version:1,params:f,callback:function(k,j,i,h){this.clearStatusBusy();if(!k){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(j);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,j);return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));this.isDataChanged=true;this.close()},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.ManageTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var d;var c;this.appWin=a.appWin;this.add_type=undefined;this.device_type=undefined;this.loaded=false;this.spaceType=a.spaceType;c=this.getLabelString();if(this.appWin.supportRaidGroup){d="raidgroup"}else{d=this.spaceType}var b={headline:_T("volume","volume_add_purpose_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_adddisk2_type_repair"),name:"add_type",itemId:"repair",inputValue:"repair"},{xtype:"syno_displayfield",indent:1,itemId:"repair_help",value:c.repair[d]},{xtype:"syno_radio",boxLabel:("yes"===_D("support_btrfs","no"))?_T("volume","start_data_scrubbing"):_T("volume","start_raid_scrubbing"),name:"add_type",itemId:"data_scrubbing",inputValue:"data_scrubbing"},{xtype:"syno_displayfield",name:"add_type_help",itemId:"data_scrubbing_help",indent:1,value:_T("volume","start_data_scrubbing_help")},{xtype:"syno_radio",boxLabel:c.expandByAddDisk[d],name:"add_type",itemId:"expand_by_disk",inputValue:"expand_by_disk"},{xtype:"syno_radio",boxLabel:c.expandWithUnallocSize[d],name:"add_type",itemId:"expand_with_unalloc_size",inputValue:"expand_with_unalloc_size"},{xtype:"syno_radio",boxLabel:c.expandWithUnallocSize[d],name:"add_type",itemId:"expand_unfinished_shr",inputValue:"expand_unfinished_shr"},{xtype:"syno_radio",boxLabel:_T("volume","volume_adddisk2_type_migrate"),name:"add_type",itemId:"migrate",inputValue:"migrate"},{xtype:"syno_radio",boxLabel:_T("volume","start_fs_defrag"),name:"add_type",itemId:"defrag",inputValue:"defrag"}]};this.callParent([Ext.apply(b,a)])},getLabelString:function(){return{repair:{volume:_T("volume","volume_add_type_repair_help"),pool:_T("volume","volume_repair_pool_help"),iscsilun:_T("volume","volume_repair_lun_help"),raidgroup:_T("volume","volume_repair_raidgroup_help")},expandByAddDisk:{volume:_T("volume","volume_adddisk2_type_expand_disk"),pool:_T("volume","volume_expand_pool_by_add_disk"),iscsilun:_T("volume","volume_expand_lun_by_add_disk"),raidgroup:_T("volume","volume_expand_raidgroup_by_add_disk")},expandWithUnallocSize:{volume:_T("volume","volume_adddisk2_type_expand_size"),pool:_T("volume","volume_expand_pool_with_unalloc_size"),iscsilun:_T("volume","volume_expand_lun_with_unalloc_size"),raidgroup:_T("volume","volume_expand_raidgroup_with_unalloc_size")}}},isSHR:function(a){if(a.substr(0,3)==="shr"){return true}else{return false}},getType:function(){return this.getForm().getValues().add_type},getScrubbingType:function(){if("data_scrubbing"===this.getType()){if(this.canDoRaidScrubbing&&!this.add_type.fs_scrubbing){return"data_scrubbing"}else{if(!this.canDoRaidScrubbing&&this.add_type.fs_scrubbing){return"fs_scrubbing"}}}return undefined},activate:function(){var h=false;var g=this.getComponent("repair");var j=this.getComponent("repair_help");var e=this.getComponent("expand_by_disk");var d=this.getComponent("expand_with_unalloc_size");var f=this.getComponent("expand_unfinished_shr");var i=this.getComponent("migrate");var b=this.getComponent("data_scrubbing");var c=this.getComponent("data_scrubbing_help");var a=this.getComponent("defrag");if(this.loaded){return}g.disable();j.disable();e.disable();d.disable();i.disable();f.disable();f.hide();if(this.isSHR(this.device_type)){i.hide()}else{i.show()}this.canDoRaidScrubbing=(!this.add_type.repair&&this.add_type.scrubbing);if(this.canDoRaidScrubbing||this.add_type.fs_scrubbing){b.show();c.show();b.setValue(true);g.hide();j.hide()}else{b.hide();c.hide()}if(this.add_type.defrag){a.enable()}else{a.disable()}if(this.add_type.repair){g.enable();g.setValue(true);j.enable();return}if(this.add_type.expand_unfinished_shr){d.disable();d.hide();c.disable();f.enable();f.setValue(true);f.show();return}else{if(this.add_type.expand_with_unalloc_size){f.disable();f.hide();c.disable();d.enable();d.setValue(true);d.show();return}}if(this.add_type.expand_by_disk){e.enable();e.setValue(true);h=true}if(this.add_type.migrate){i.enable();if(!h){i.setValue(true);h=true}}this.loaded=true},checkRunningvDSM:function(c,f){var d=this,e=d.appWin.volumes.getAll(),b=SYNO.SDS.StorageUtils,a=[];if(c==="pool"){Ext.each(e,function(g){if(f.get("id")===g.get("pool_path")){a.push(g.get("id"))}})}else{if(c==="volume"){a.push(f.get("id"))}else{return false}}if(b.isExistRunningvDSM(e,a)){return true}return false},getNext:function(){var a=this.getType();if(a==="migrate"){if(this.checkRunningvDSM(this.owner.spaceType,this.owner.space)){this.owner.getMsgBox().alert(this.owner.title,_TT("SYNO.SDS.Virtualization.Application","vm","exist_alive_vm_err"));return false}if(this.hasFailedDisk){this.owner.getMsgBox().alert(this.title,_T("volume","volume_migrate_with_failed_disk_alert"));return false}return this.nextId.migrate}else{if(a==="expand_by_disk"||a==="repair"){if(this.checkRunningvDSM(this.owner.spaceType,this.owner.space)){this.owner.getMsgBox().alert(this.owner.title,_TT("SYNO.SDS.Virtualization.Application","vm","exist_alive_vm_err"));return false}return this.nextId.choose_disk}else{if(a=="data_scrubbing"){if(this.canDoRaidScrubbing&&this.add_type.fs_scrubbing){return this.nextId.scrubbing}else{return this.nextId.other}}else{return this.nextId.other}}}}});Ext.define("SYNO.SDS.StorageManager.Wizard.ScrubbingTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b={headline:_T("volume","volume_scrubbing_type_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_scrubbing_type_raid"),name:"scrubbing_type",itemId:"type_raid",inputValue:"type_raid",checked:true},{xtype:"syno_radio",boxLabel:_T("volume","volume_scrubbing_type_fs"),name:"scrubbing_type",itemId:"type_btrfs",inputValue:"type_btrfs"}]};this.callParent([Ext.apply(b,a)])},getScrubbingType:function(){if("type_raid"===this.getForm().getValues().scrubbing_type){return"data_scrubbing"}else{return"fs_scrubbing"}},getNext:function(){return this.nextId}});Ext.define("SYNO.SDS.StorageManager.Wizard.MigrateTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.migrate_type=undefined;this.migrate_constrain=undefined;this.loaded=false;var b={headline:_T("volume","volume_migrate_type_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_migrate_add_mirror"),name:"migrate_type",itemId:"add_mirror",inputValue:"add_mirror"},{xtype:"syno_radio",boxLabel:_T("volume","volume_migrate_to_raid1"),name:"migrate_type",itemId:"to_raid1",inputValue:"to_raid1"},{xtype:"syno_radio",boxLabel:_T("volume","volume_migrate_to_raid5"),name:"migrate_type",itemId:"to_raid5",inputValue:"to_raid5"},{xtype:"syno_radio",boxLabel:_T("volume","volume_migrate_to_raid5_spare"),name:"migrate_type",itemId:"to_raid5+spare",inputValue:"to_raid5+spare"},{xtype:"syno_radio",boxLabel:_T("volume","volume_migrate_to_raid6"),name:"migrate_type",itemId:"to_raid6",inputValue:"to_raid6"}]};this.callParent([Ext.apply(b,a)])},getType:function(){return this.getForm().getValues().migrate_type},activate:function(){var a="",b=false;if(this.loaded){return}b=("yes"===_D("support_hotspare","no"));if(b){this.getComponent("to_raid5+spare").hide()}else{this.getComponent("to_raid5+spare").show()}Ext.each(["add_mirror","to_raid1","to_raid5","to_raid5+spare","to_raid6"],function(c){if(c in this.migrate_type&&this.migrate_type[c]&&!("to_raid5+spare"===c&&b)){this.getComponent(c).enable();a=c}else{this.getComponent(c).disable()}},this);this.getComponent(a).setValue(true);if("add_mirror" in this.migrate_type&&this.migrate_type.add_mirror){this.getComponent("add_mirror").getEl().findParentNode(".x-form-item").style.display="";this.getComponent("to_raid1").getEl().findParentNode(".x-form-item").style.display="none"}else{this.getComponent("add_mirror").getEl().findParentNode(".x-form-item").style.display="none";this.getComponent("to_raid1").getEl().findParentNode(".x-form-item").style.display=""}this.loaded=true},getNext:function(){var a=this.getType();if(("to_raid5"===a&&0===this.migrate_constrain.to_raid5)||("to_raid6"===a&&0===this.migrate_constrain.to_raid6)){if(this.owner.getStep("disk")){this.owner.getStep("disk").allowBlank=true}else{this.owner.getStep("disk").allowBlank=false}}return this.nextId}});Ext.define("SYNO.SDS.StorageManager.Wizard.ManageSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(a){var c=this,b;c.stopServicesType=undefined;c.appWin=a.appWin;c.space=a.space;b={headline:_T("volume","volume_wizard_summary_title")};c.callParent([Ext.apply(b,a)])},activate:function(){var c=this;c.callParent(arguments);var d=c.getStore();var a=SYNO.SDS.StorageUtils;var e=c.owner.getAddType();var b;var f;switch(c.owner.spaceType){case"volume":f=c.volumeEstimateCallBack;break;case"pool":f=c.poolEstimateCallBack;break;case"iscsilun":f=c.lunEstimateCallBack;break}d.append(_T("common","name"),c.owner.space.getName());if(e==="data_scrubbing"){if("fs_scrubbing"===c.owner.getScrubbingType()){b=_T("volume","volume_scrubbing_type_fs")}else{b=_T("volume","volume_scrubbing_type_raid")}}else{b=a.AddDiskTypeRender(e)}if(b){d.append(_T("volume","volume_add_purpose"),b)}if(e==="defrag"){d.append(_T("volume","volume_add_purpose"),_T("volume","start_fs_defrag"))}if(e==="migrate"){b=a.MigrateTypeRender(c.owner.getMigrateType());d.append(_T("volume","volume_migrate_type"),b)}if(e==="data_scrubbing"){if("fs_scrubbing"===c.owner.getScrubbingType()){d.append(_T("volume","notice"),_T("volume","fs_scrubbing_notice"))}else{d.append(_T("volume","notice"),_T("volume","data_scrubbing_notice"))}}if(e==="defrag"){d.append(_T("volume","notice"),_T("volume","fs_defrag_notice"))}if(e==="defrag"){return}c.owner.setStatusBusy();c.owner.getButton("next").disable();SYNO.API.Request({api:c.owner.api,method:"estimate_size",version:1,params:{estimate_for:c.owner.getActionType(),disk_id:c.owner.getDiskIds(),space_id:c.owner.space.get("id")},callback:f,scope:c})},getNext:function(){this.owner.applySettings(this.stopServicesType);return false},volumeEstimateCallBack:function(l,c,d,a){var j=this;var g=SYNO.SDS.StorageUtils;var i={};var e;var m=j.appWin.getMaxVolumeSize(false);var h=j.owner.space.get("size").total;var k;var b=true;var f;j.owner.clearStatusBusy();if(!l){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,c);j.owner.getButton("next").disable();return}if(!_S("demo_mode")){j.owner.getButton("next").enable()}if(j.appWin.supportRaidGroup&&-1<j.owner.space.get("device_type").indexOf("shr")){f=j.appWin.volumes.data[j.owner.space.get("deploy_path")];if(f){e=f.get("max_fs_size")}}else{e=j.owner.space.get("max_fs_size")}j.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(c.size));if("data_scrubbing"===this.owner.getAddType()){return}if(parseInt(e,10)>parseInt(h,10)){k=e}else{k=h}if(parseInt(k,10)>parseInt(m,10)){k=m}if(parseInt(c.size,10)>parseInt(k,10)){i.text=_T("error","error_volume_oversize");i.text=String.format(i.text,g.SizeRender(k));SYNO.SDS.StorageUtils.ReportWebapiFailure(this,i);j.owner.getButton("next").disable();return}if(c.stop_service_type){j.stopServicesType=c.stop_service_type}if(!c.ignore_resize_limit&&parseInt(c.size,10)>parseInt(c.online_resize_limit,10)){b=false}if("none"===c.stop_service_type&&!b){i.text=String.format(_T("volume","volume_fs_resize_notify"),SYNO.SDS.StorageUtils.SizeRender(parseInt(c.online_resize_limit,10)));SYNO.SDS.StorageUtils.ReportWebapiFailure(this,i)}},poolEstimateCallBack:function(d,c,b,a){this.owner.clearStatusBusy();if(!d){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,c);this.owner.getButton("next").disable();return}if(!_S("demo_mode")){this.owner.getButton("next").enable()}this.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(c.size));if(c.stop_service_type){this.stopServicesType=c.stop_service_type}},lunEstimateCallBack:function(e,d,c,b){var a=this;a.owner.clearStatusBusy();if(!e){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);a.owner.getButton("next").disable();return}if(!_S("demo_mode")){a.owner.getButton("next").enable()}a.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(d.size));if(d.stop_service_type){a.stopServicesType=d.stop_service_type}},disableNextInDemoMode:true});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateVolumeMain",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var d=this,c,b;d.supportBtrfs=("yes"===_D("support_btrfs","no"));d.isDataChanged=false;d.appWin=a.appWin;d.owner=a.owner;c=a.option;b={title:_T("volume","volume_add_volmgr_title"),cls:"sm-wizard-main",width:640,height:540,minHeight:540,minWidth:640,resizable:true,border:false,steps:[]};if(d.appWin.isSupportSHR()){b.steps.push(new SYNO.SDS.StorageManager.Wizard.CreateVolumeModeStep({appWin:d.appWin,option:c,itemId:"createmode",nextId:{shr:"disk",custom:"customstep"}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.ShrTypeStep({appWin:d.appWin,itemId:"shrstep",nextId:"check"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.CreateVolumeTypeStep({appWin:d.appWin,option:c,itemId:"customstep",nextId:{single:"disk",multiple:"poolstep"}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.PoolStep({appWin:d.appWin,itemId:"poolstep",nextId:{create:"disk",existing:(d.supportBtrfs)?"fsstep":"allocate_size_on_pool_step"}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.VolumeSizeStep({appWin:d.appWin,itemId:"allocate_size_on_pool_step",deviceType:"volume",nextId:"edit_desc"}))}b.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskStep({appWin:d.appWin,free_disks:d.appWin.disks.getMatched("isNormalTray","isFree"),isSupportRaidCross:d.appWin.isSupportRaidCross(),isNeedSelectSource:!d.appWin.isSupportRaidCross()&&d.appWin.isSupportEbox()&&d.appWin.isEboxPluged(),isOneBay:d.appWin.isSingleBay(),isOneBayWithNoEbox:!d.appWin.isSupportSHR()&&(!d.appWin.isSupportEbox()||!d.appWin.isEboxPluged()),itemId:"disk",nextId:{raid_type:"raid_type",check:"check",shrstep:"shrstep"}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.RaidTypeStep({appWin:d.appWin,isOneBay:d.appWin.isSingleBay(),itemId:"raid_type",nextId:{shrstep:"shrstep",check:"check"}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.SingleDiskRaidTypeStep({appWin:d.appWin,isOneBay:d.appWin.isSingleBay(),itemId:"single_disk_raid_type",nextId:"check"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskCheckStep({appWin:d.appWin,itemId:"check",nextId:{fsstep:"fsstep",edit_desc:"edit_desc",allocate_size_on_pool_step:"allocate_size_on_pool_step"}}));if(d.supportBtrfs){b.steps.push(new SYNO.SDS.StorageManager.Wizard.CreateVolumeFsTypeStep({appWin:d.appWin,itemId:"fsstep",nextId:{allocate_size_on_pool_step:"allocate_size_on_pool_step",edit_desc:"edit_desc"}}))}b.steps.push(new SYNO.SDS.StorageManager.Wizard.EditDescriptionStep({appWin:d.appWin,itemId:"edit_desc",nextId:"summary"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.CreateVolumeSummaryStep({appWin:d.appWin,isOneBay:d.appWin.isSingleBay(),headline:_T("volume","volume_wizard_summary_title"),itemId:"summary",nextId:null}));d.callParent([Ext.apply(b,a)])},isSelectSHR:function(){if(!this.owner.isSupportSHR()||!this.inHistory("shrstep")){return false}return this.getStep("shrstep").isSelectSHR()},getSpaceType:function(){return"volume"},getDiskIds:function(){if(this.inHistory("disk")){return this.getStep("disk").getIds()}else{throw Error("wrong flow control: get disk ids")}},getRaidType:function(){var a;if(this.inHistory("createmode")&&this.getStep("createmode").isSelectSHR()){if(this.inHistory("shrstep")){a=this.getStep("shrstep").getType()}else{if(this.getDiskIds().length===1){a="shr_without_disk_protect"}else{a="shr_with_1_disk_protect"}}}else{if(this.inHistory("raid_type")||this.inHistory("single_disk_raid_type")){if(this.getStep("raid_type").getType()==="shr"){if(this.inHistory("shrstep")){a=this.getStep("shrstep").getType()}else{if(this.getDiskIds().length===1){a="shr_without_disk_protect"}else{a="shr_with_1_disk_protect"}}}else{a=this.getStep("raid_type").getType()}}else{if(this.inHistory("poolstep")&&"existing"===this.getStep("poolstep").getValues()){a=this.getStep("poolstep").getCurRecord().data.raidLevel}else{a="basic"}}}return a},getPoolPath:function(){if(this.inHistory("poolstep")&&this.getStep("poolstep").getValues()==="existing"){return this.getStep("poolstep").getCurRecord().id}return""},getDescription:function(){return this.getStep("edit_desc").getDescription()},isChooseExistingPool:function(){if(this.inHistory("poolstep")&&this.getStep("poolstep").getValues()==="existing"){return true}return false},getFsType:function(){var a=_D("defaultfs","ext4");if(this.inHistory("fsstep")){a=this.getStep("fsstep").getFsType()}return a},getAllocateSizeMB:function(){var a=0,b=0,c=0;if(this.inHistory("allocate_size_on_pool_step")){a=parseInt(this.getStep("allocate_size_on_pool_step").getValues(),10);b=parseInt(this.getStep("allocate_size_on_pool_step").maxFreeSizeGB,10);if(a===b){c=parseInt(this.getStep("allocate_size_on_pool_step").maxFreeSizeByte,10);a=Math.floor(c/1024/1024)}else{a=parseInt(this.getStep("allocate_size_on_pool_step").getValues(),10)*1024}}return a.toString()},isPoolChild:function(){if(this.inHistory("poolstep")){return true}return false},applySettings:function(){var b={};var a,c;if(this.isChooseExistingPool()){c="create_on_existing_pool";b.pool_path=this.getPoolPath();b.fs_type=this.getFsType();b.allocate_size=this.getAllocateSizeMB();b.vol_desc=this.getDescription()}else{a=this.getRaidType();c="create";b.pool_path=this.getPoolPath();b.fs_type=this.getFsType();b.allocate_size=this.getAllocateSizeMB();b.disk_id=this.getDiskIds();b.is_disk_check=this.inHistory("check")?this.getStep("check").isChecked():false;b.device_type=a;b.is_pool_child=this.isPoolChild();b.spare_disk_count="0";b.vol_desc=this.getDescription();b.desc=SYNO.SDS.StorageUtils.RaidLevelRender(a)}this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:c,version:1,params:b,callback:function(g,f,e,d){this.clearStatusBusy();if(!g){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(f);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));this.isDataChanged=true;this.close()},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateVolumeModeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.loaded=false;c.option=a.option||{};c.appWin=a.appWin;c.owner=a.owner;b={headline:_T("volume","volume_add_mode_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_add_mode_systemdefault"),name:"choose_mode",itemId:"shr",inputValue:"shr",disabled:true},{xtype:"syno_displayfield",htmlEncode:false,indent:1,value:_T("volume","volume_add_mode_systemdefault_help")+(this.appWin.supportHA===false?"":'<br/><span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("volume","volume_type_shr_support_note"))},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_radio",boxLabel:_T("volume","volume_add_mode_customized"),name:"choose_mode",itemId:"custom",inputValue:"custom",disabled:true},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_add_mode_customized_help")}]};this.callParent([Ext.apply(b,a)])},isSelectSHR:function(){return this.getForm().getValues().choose_mode==="shr"},activate:function(){if(this.loaded){return}if(this.option.can_create_volume){if(!_S("ha_running")){this.getComponent("shr").enable();this.getComponent("shr").setValue(true)}else{this.getComponent("shr").disable();this.getComponent("custom").setValue(true)}this.getComponent("custom").enable()}else{if(this.option.can_create_volume_on_existing_pool){this.getComponent("shr").disable();this.getComponent("custom").enable();this.getComponent("custom").setValue(true)}else{this.getComponent("shr").disable();this.getComponent("custom").disable()}}this.loaded=true},getNext:function(){return this.nextId[this.getForm().getValues().choose_mode]},summary:function(a){a.append(_T("volume","volume_space"),_T("volume","volume"))}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateVolumeTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.loaded=false;c.option=a.option||{};b={headline:_T("volume","volume_add_purpose_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_add_mode_general_volume"),name:"customstep",itemId:"single",inputValue:"single"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_add_mode_general_volume_help")},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_radio",boxLabel:_T("volume","volume_add_mode_logical_volume"),name:"customstep",itemId:"multiple",inputValue:"multiple"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_add_mode_logical_volume_help")}]};this.callParent([Ext.apply(b,a)])},activate:function(){if(this.loaded){return}if(this.option.can_create_volume){this.getComponent("single").enable();this.getComponent("multiple").enable();this.getComponent("single").setValue(true)}else{if(this.option.can_create_volume_on_existing_pool){this.getComponent("single").disable();this.getComponent("multiple").enable();this.getComponent("multiple").setValue(true)}else{this.getComponent("single").disable();this.getComponent("multiple").disable()}}this.loaded=true},getNext:function(){return this.nextId[this.getForm().getValues().customstep]},summary:function(a){}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateVolumeFsTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.loaded=false;c.option=a.option||{};c.appWin=a.appWin;c.owner=a.owner;b={headline:_T("volume","volume_add_fs_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_add_fs_btrfs"),name:"choose_fs",itemId:"btrfs",inputValue:"btrfs"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_add_fs_btrfs_help")},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_radio",boxLabel:_T("volume","volume_add_fs_ext4"),name:"choose_fs",itemId:"ext4",inputValue:"ext4"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_add_fs_ext4_help")}]};this.callParent([Ext.apply(b,a)])},getFsType:function(){return this.getForm().getValues().choose_fs},activate:function(){if(this.loaded){return}if("btrfs"===_D("defaultfs")){this.getComponent("btrfs").setValue(true)}else{this.getComponent("ext4").setValue(true)}this.loaded=true},getNext:function(){var a="poolstep";var c="allocate_size_on_pool_step";var d="edit_desc";var b;if(this.owner.inHistory(a)){b=c}else{b=d}return this.nextId[b]},summary:function(b){var a=("btrfs"===this.getFsType())?_T("volume","volume_add_fs_btrfs_type"):_T("volume","volume_add_fs_ext4_type");b.append(_T("volume","volume_add_fs_type"),a)}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateVolumeSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(a){this.isOneBay=false;var b={headline:_T("volume","volume_wizard_summary_title")};b=Ext.apply(b,a);this.callParent([b])},activate:function(){var a=this;a.callParent(arguments);if(a.owner.inHistory("createmode")&&a.owner.getStep("createmode").isSelectSHR()){a.getStore().append(_T("volume","volume_level"),SYNO.SDS.StorageUtils.SpaceTypeRender(a.owner.getRaidType()))}else{if(a.isOneBay&&!(a.owner.inHistory("raid_type")||a.owner.inHistory("single_disk_raid_type"))){a.getStore().append(_T("volume","volume_level"),SYNO.SDS.StorageUtils.DeviceTypeRender(a.owner.getRaidType()))}}if(!a.owner.inHistory("disk")||a.owner.inHistory("poolstep")){return}a.owner.setStatusBusy();a.owner.getButton("next").disable();SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:"estimate_size",version:1,params:{estimate_for:"create",disk_id:a.owner.getDiskIds(),device_type:a.owner.getRaidType()},callback:function(g,f,e,b){var d={};var c=a.appWin.getMaxVolumeSize(false);a.owner.clearStatusBusy();if(!g){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);a.owner.getButton("next").disable();return}if(!_S("demo_mode")){a.owner.getButton("next").enable()}a.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(f.size));if(parseInt(f.size,10)>parseInt(c,10)){d.text=_T("error","error_volume_oversize");d.text=String.format(d.text,SYNO.SDS.StorageUtils.SizeRender(a.appWin.getMaxVolumeSize(false)));SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);a.owner.getButton("next").disable();return}},scope:a})},getNext:function(){this.owner.applySettings();return false},descRenderer:function(e,b,a,g,d,c){var f=e.toString().replace(/<.*?>/g,"");b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(f)+'"';return e},disableNextInDemoMode:true});Ext.define("SYNO.SDS.StorageManager.Volume.Dialog.SpaceCreationWarningWindow",{extend:"SYNO.SDS.ModalWindow",title:_T("download","download_warning"),owner:null,powerButtonCheckboxID:null,okButtonID:null,next_id:null,constructor:function(b){var c=this;c.appWin=b.appWin;c.owner=b.owner;c.next_id=b.next_id;c.callParent([c.getConfig(b)]);if(!b.showPwrChk){Ext.getCmp(this.okButtonID).setDisabled(false)}else{Ext.getCmp(this.okButtonID).setDisabled(true)}var a=200;if(b.showPwrChk){a=a+70}this.setHeight(a)},getConfig:function(a){var b=Ext.apply({width:600,layout:"fit",items:[{xtype:"syno_formpanel",items:[{xtype:"syno_displayfield",htmlEncode:false,hideLabel:true,value:a.warningMsg},{xtype:"syno_displayfield",value:" ",hidden:!a.showPwrChk},{xtype:"syno_checkbox",id:this.powerButtonCheckboxID=Ext.id(),boxLabel:_T("volume","eunit_power_button_disabled"),hideLabel:true,handler:this.onClickConfirmReadingCheckbox,hidden:!a.showPwrChk,scope:this}]}],buttons:[{xtype:"syno_button",btnStyle:"red",text:_T("common","ok"),id:this.okButtonID=Ext.id(),scope:this,handler:this.onClickOKButton},{text:_T("common","close"),xtype:"syno_button",scope:this,handler:function(){this.close()}}]},a);return b},onClickConfirmReadingCheckbox:function(){if(true===Ext.getCmp(this.powerButtonCheckboxID).getValue()){Ext.getCmp(this.okButtonID).setDisabled(false)}else{Ext.getCmp(this.okButtonID).setDisabled(true)}return},onClickOKButton:function(){this.owner.goNext(this.next_id);this.close();return}});Ext.define("SYNO.SDS.StorageManager.Wizard.EditVolumeMain",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.isDataChanged=false;c.mode=a.mode||"create";c.volume=a.volume;c.supportBtrfs=("yes"===_D("support_btrfs","no"));b={title:"create"===a.mode?_T("volume","volume_add_volmgr_title"):_T("common","alt_edit"),width:640,height:("create"!==c.mode||c.supportBtrfs)?290:255,resizable:false,layout:"fit",border:false,items:c.propPanel=new SYNO.SDS.StorageManager.Wizard.VolumeProperty({appWin:c.appWin,owner:c,mode:c.mode,volume:c.volume,border:false}),buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){var a=this;a.callParent(arguments);if("create"===a.mode){a.propPanel.onCreate()}else{a.propPanel.onEdit()}},getAllocateSizeMB:function(){var c=this,b=0,a=c.propPanel.getSizeCmp();if(a.getValue()===a.maxValue){b=Math.floor(parseInt(c.propPanel.maxFreeSizeByte,10)/1024/1024)}else{b=parseInt(a.getValue(),10)*1024}return b.toString()},onCancel:function(){var a=this;if("create"===a.mode){a.close();return}if(a.propPanel.getForm().isDirty()){a.getMsgBox().confirm(a.title,_T("common","confirm_lostchange"),function(b){if("yes"===b){a.close()}},a);return}a.close()},onSave:function(){var a=this;if(!a.propPanel.getForm().isValid()){return}if("create"===a.mode){a.saveCreate()}else{a.saveEdit()}},saveCreate:function(){var c=this,f,a=c.appWin.storagePools.getById(c.propPanel.getPoolCmp().getValue()),b=c.appWin.getMaxVolumeSize(a.isMultiRaidsPool()),e=parseInt(c.getAllocateSizeMB(),10)*1024*1024,d={},g;if(e>b){f=_T("error","error_volume_oversize");f=String.format(f,SYNO.SDS.StorageUtils.SizeRender(b));c.getMsgBox().alert(c.title,f);return}if("single"===a.get("raidType")){g="deploy_unused";d.space_path=a.get("space_path")}else{g="create_on_existing_pool";d.pool_path=a.id;d.allocate_size=c.getAllocateSizeMB()}d.vol_desc=c.propPanel.getDescCmp().getValue();d.fs_type=c.propPanel.getFsCmp().getValue();c.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:g,version:1,params:d,callback:function(k,j,i,h){c.clearStatusBusy();if(!k){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(j);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,j);return}c.isDataChanged=true;c.close()},scope:c})},saveEdit:function(){var c=this,a=c.appWin.storagePools.data[c.volume.get("pool_path")],b,g,d,f,e;if(a){b=c.appWin.getMaxVolumeSize(a.isMultiRaidsPool())}else{b=c.appWin.getMaxVolumeSize(false)}if(c.propPanel.sizeCmp.isDirty()){if(parseInt(c.propPanel.sizeCmp.getValue(),10)===c.propPanel.maxExpandSizeGB){d=parseInt(c.propPanel.maxExpandSizeByte,10)}else{d=parseInt(c.propPanel.sizeCmp.getValue(),10)*1024*1024*1024}}else{d=0}if(d>b){e=_T("error","error_volume_oversize");e=String.format(e,SYNO.SDS.StorageUtils.SizeRender(b));c.getMsgBox().alert(c.title,e);return}f=c.propPanel.getDescCmp().getValue();g={space_id:c.propPanel.volume.get("id"),desc:f,new_size:d.toString()};if(!c.propPanel.getForm().isDirty()){c.close()}else{c.applySettings("expand_pool_child",g)}},applySettings:function(c,b){var a=this;a.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:c,version:1,params:b,callback:function(g,f,e,d){a.clearStatusBusy();if(!g){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(f);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);return}a.isDataChanged=true;a.close()},scope:a})}});Ext.define("SYNO.SDS.StorageManager.Wizard.VolumeProperty",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.maxFreeSizeGB=0;c.maxFreeSizeByte=0;c.maxExpandSizeGB=0;c.maxExpandSizeByte=0;c.minExpandSizeGB=0;c.setDefaultDesc=true;c.appWin=a.appWin;c.owner=a.owner;c.mode=a.mode;c.volume=a.volume;b={itemId:"volume_property",trackResetOnLoad:true,layoutConfig:{trackLabels:true},labelWidth:250,items:[{xtype:"syno_storage_combobox",itemId:"pool",name:"pool",fieldLabel:this.appWin.supportRaidGroup?_T("volume","volume_raid_group"):_T("volume","volume_pool"),hidden:this.appWin.isVDSM,lazyRender:true,width:250,editable:false,mode:"local",forceSelection:true,allowBlank:false,valueField:"id",displayField:"display",descriptionField:"desc",store:new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:["id","display","name","desc","size_available","device_type","raid_type"]}),listeners:{select:function(e,f,d){c.onPoolChanged(f.get("id"))},scope:c}},{xtype:"syno_textfield",validateOnBlur:true,validationEvent:"blur",name:"desc",itemId:"desc",enableKeyEvents:true,fieldLabel:_T("share","share_comment"),width:250,maxLength:64},{xtype:"syno_combobox",itemId:"fs_type",name:"fs_type",fieldLabel:_T("volume","volume_add_fs_type"),lazyRender:true,width:250,editable:false,mode:"local",forceSelection:true,allowBlank:false,store:[["btrfs",_T("volume","volume_add_fs_btrfs_type")],["ext4",_T("volume","volume_add_fs_ext4_type")]],listeners:{select:function(e,f,d){if(c.mode==="create"){c.sizeCmp.minValue=(e.getValue()==="btrfs")?10:1}c.onPoolChanged(c.getComponent("pool").value)},scope:c}},{xtype:"syno_displayfield",itemId:"allocated_size_desc",hideLabel:false,disabled:true,disabledClass:"",fieldLabel:String.format("{0} ({1})",_T("volume","volume_pool_usedsize"),_T("common","size_gb")),width:250,value:"100000"},{xtype:"syno_displayfield",itemId:"size_max_desc",hideLabel:false,disabled:true,disabledClass:"",fieldLabel:String.format("{0} ({1})",_T("volume","volume_max_allocatable_size"),_T("common","size_gb")),width:250,value:"200000"},{layout:"hbox",itemId:"size_panel",border:false,fieldLabel:String.format("{0} ({1})",_T("volume","volume_allocate_size_field_name"),_T("common","size_gb")),labelStyle:"line-height: 28px;padding:0px;",bodyStyle:{padding:"0px 0px 0px 0px"},items:[{xtype:"syno_numberfield",allowDecimals:false,validateOnBlur:true,width:250,value:"1",itemId:"size_value",validator:function(e){var d=String.format(_T("volume","volume_valid_range_warning"),c.minValue,c.maxValue);if(c.maxValue<e||c.minValue>e){return d}return true}},{xtype:"syno_displayfield",width:10,value:" "},{xtype:"syno_button",itemId:"size_max",text:_T("common","max"),handler:function(e,d){c.sizeCmp.setValue(c.sizeCmp.maxValue)},scope:c}]}]};c.callParent([Ext.apply(b,a)]);c.descCmp=c.getComponent("desc");c.poolCmp=c.getComponent("pool");c.fsCmp=c.getComponent("fs_type");c.sizeCmp=c.getComponent("size_panel").getComponent("size_value");c.maxSizeBtn=c.getComponent("size_panel").getComponent("size_max");c.maxSizeDesc=c.getComponent("size_max_desc");c.alloSizeDesc=c.getComponent("allocated_size_desc")},onCreate:function(){var e=this,d=e.appWin.storagePools.getMatched("isFreeSizeBiggerThan1GB","isWritable","notUsedByGlusterFs"),f=e.appWin.volumes.getMatched("notUsedByGlusterFs"),c=e.appWin.iscsiLuns.getAll(),b={},a=[];e.mon(e.descCmp,"keypress",function(){e.setDefaultDesc=false},e);if(e.owner.supportBtrfs){e.fsCmp.setValue(_D("defaultfs","ext4"))}else{e.fsCmp.hide();e.fsCmp.disable(true)}Ext.each(f,function(g){if("single"!==g.get("raidType")){return true}b[g.get("pool_path")]=true},e);Ext.each(c,function(g){if("single"!==g.get("raidType")){return true}b[g.get("pool_path")]=true},e);Ext.each(d,function(g){if(!b[g.id]){a.push(g)}},e);a.sort(function(h,g){h=h.json.num_id;g=g.json.num_id;return(h>g)?1:((h<g)?-1:0)});e.preparePoolData(a);e.poolCmp.setValue(e.poolCmp.store.getAt(0).get("id"));e.onPoolChanged(e.poolCmp.store.getAt(0).get("id"));e.alloSizeDesc.hide()},onPoolChanged:function(d){var g=this,c,e="",i=SYNO.SDS.StorageUtils,f=g.appWin.storagePools.data[d],a=g.appWin.getMaxVolumeSize(f.isMultiRaidsPool()),h=f.get("size").total,j=f.get("size").used,b=h-j;if("multiple"===f.get("raidType")){g.sizeCmp.enable();g.maxSizeBtn.enable();if(a<parseInt(b,10)){g.maxFreeSizeGB=i.GetSizeGB(a,0);g.maxFreeSizeByte=a}else{g.maxFreeSizeGB=i.GetSizeGB(b,0);g.maxFreeSizeByte=b}}else{g.sizeCmp.disable();g.maxSizeBtn.disable();g.maxFreeSizeGB=i.GetSizeGB(b,0);g.maxFreeSizeByte=b}if(g.mode==="create"){if(g.owner.supportBtrfs){g.sizeCmp.minValue=(g.fsCmp.getValue()==="btrfs")?10:1}else{g.sizeCmp.minValue=(_D("defaultfs","ext4")==="btrfs")?10:1}}else{g.sizeCmp.minValue=(g.volume.get("fs_type")==="btrfs")?10:1}g.sizeCmp.maxValue=g.maxFreeSizeGB;g.sizeCmp.setValue(g.maxFreeSizeGB);g.maxSizeDesc.setValue(g.maxFreeSizeGB);if(g.setDefaultDesc){if("multiple"===f.get("raidType")){e+=String.format(_T("volume","volume_default_desc"),SYNO.SDS.StorageUtils.SpaceIDParser(f.id).str);e+=", "}e+=SYNO.SDS.StorageUtils.RaidLevelRender(f.get("device_type"));if(g.owner.supportBtrfs){c=this.getComponent("fs_type").getValue();e+=String.format(", {0}",c)}g.descCmp.setValue(e)}},onEdit:function(){var g=this,j=SYNO.SDS.StorageUtils,k=g.appWin.storagePools.getAll(),f,c,e,h,b,i,a,d;if(!g.volume){return}g.fsCmp.hide();g.fsCmp.disable(true);g.preparePoolData(k);if(""===g.volume.get("pool_path")){b=g.appWin.getMaxVolumeSize(false);e=parseInt(g.volume.get("size").used,10);h=parseInt(g.volume.get("size").used,10)}else{f=g.appWin.storagePools.data[g.volume.get("pool_path")];b=g.appWin.getMaxVolumeSize(f.isMultiRaidsPool());e=parseInt(f.get("size").total,10);h=parseInt(f.get("size").used,10)}c=parseInt(g.volume.get("size").total_device,10);i=parseInt(((e-h)+c),10);a=parseInt(g.volume.get("max_fs_size"),10);if(a<i){g.maxExpandSizeGB=j.GetSizeGB(a,0);g.maxExpandSizeByte=a}else{g.maxExpandSizeGB=j.GetSizeGB(i,0);g.maxExpandSizeByte=i}g.minExpandSizeGB=j.GetSizeGB(c,0);if(g.minExpandSizeGB>g.maxExpandSizeGB){g.maxExpandSizeGB=g.minExpandSizeGB;g.maxExpandSizeByte=c}if(g.maxExpandSizeByte>b){g.maxExpandSizeByte=b;g.maxExpandSizeGB=b/1024/1024/1024}d=Ext.util.Format.htmlDecode(g.volume.get("desc"));g.poolCmp.disable();g.getForm().setValues({pool:g.volume.get("pool_path"),desc:d,size_value:g.minExpandSizeGB});g.sizeCmp.maxValue=g.maxExpandSizeGB;g.sizeCmp.minValue=g.minExpandSizeGB;g.maxSizeDesc.setValue(g.maxExpandSizeGB);g.alloSizeDesc.show();g.alloSizeDesc.setValue(g.minExpandSizeGB);if(!f||!f.isFreeSizeBiggerThan1GB()||!f.isWritable){g.sizeCmp.disable();g.maxSizeBtn.disable();return}if(!f||"single"===f.get("raidType")){g.sizeCmp.disable();g.maxSizeBtn.disable()}else{g.sizeCmp.enable();g.maxSizeBtn.enable()}},preparePoolData:function(f){var d=this,c=SYNO.SDS.StorageUtils,b,a,e;d.pools=[];Ext.each(f,function(g){b=parseInt(g.get("size").used,10);a=parseInt(g.get("size").total,10);e=(""===g.get("desc"))?"&nbsp":g.get("desc");d.pools.push({id:g.get("id"),display:c.SpaceIDParser(g.get("id")).str,name:c.SpaceIDParser(g.get("id")).str,desc:e,size_available:c.SizeRender(a-b),device_type:c.RaidLevelRender(g.get("device_type")),raid_type:("single"===g.get("raidType"))?"Single":"Multiple"})},d);d.poolCmp.getStore().loadData(d.pools,false)},getPoolCmp:function(){return this.poolCmp},getDescCmp:function(){return this.descCmp},getSizeCmp:function(){return this.sizeCmp},getFsCmp:function(){return this.fsCmp}});Ext.define("SYNO.SDS.StorageManager.Wizard.DeleteVolume",{extend:"SYNO.SDS.ModalWindow",serviceNameMap:{media:_T("tree","leaf_mediaservice"),itunes:_T("tree","leaf_itunes"),audio:_T("tree","leaf_audio"),photo:_T("tree","leaf_photo"),netbkp:_T("tree","leaf_netbkp"),web:_T("tree","leaf_web"),download:_T("tree","node_download"),mysql:_T("tree","leaf_mysql"),surveillance:_T("tree","leaf_surveillance"),userhome:_T("user","user_home")},constructor:function(a){var c=this,b;c.isDataChanged=false;c.appWin=a.appWin;c.owner=a.owner;c.volumeIds=a.volumeIds||[];c.services=undefined;b={title:_T("volume","volume_delete_volmgr_title"),width:640,height:350,resizable:false,layout:"fit",items:[{xtype:"syno_formpanel",itemId:"main",border:false,items:[{xtype:"syno_displayfield",value:"",id:c.descID=Ext.id(),itemId:"desc"},c.grid=new SYNO.SDS.Wizard.SummaryStep({layout:"fit",height:200})]}],buttons:[{xtype:"syno_button",btnStyle:"red",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","remove"),id:c.applyButtonID=Ext.id(),scope:c,handler:c.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){var c=this,a=SYNO.SDS.StorageUtils,b;c.callParent(arguments);if(0===c.volumeIds.length){return}b=c.grid.getStore();b.append(_T("volume","volume"),a.getVolumeNames(c.volumeIds));c.setStatusBusy();SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:"enum_resource",version:1,params:{space_id:c.volumeIds},callback:function(g,f,e,d){c.clearStatusBusy();if(!g){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);return}c.loadData(f,e)},scope:c})},onSave:function(){var a=this,b,c;b={space_id:a.volumeIds};c='1. <font class="red-status">'+_T("volume","volume_delete_warning")+"</font><br/>2. ";c+=_T("volume","volume_all_service_stop");a.getMsgBox().confirm(_T("tree","leaf_volume"),c,function(d){if("yes"===d){SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(a,a.apply,["delete",b])}},a)},onCancel:function(){this.close()},loadData:function(f,e){var h=this,g=h.grid.getStore(),i=SYNO.SDS.StorageUtils,d={},j=[],a=i.CheckFailedMsg(f.check),c=false,b=function(l){var k=true;l.space_id.each(function(m){if("crashed"!==h.owner.volumes.data[m].get("status")){k=false;return false}});if(k){Ext.getCmp(h.applyButtonID).enable();Ext.getCmp(h.descID).setValue(_T("volume","del_soft_check_fail"))}};if("hard_failed"===a){c=true;Ext.getCmp(h.applyButtonID).disable();Ext.getCmp(h.descID).setValue(_T("volume","del_hard_check_fail"));b(e)}else{if("soft_failed"===a){Ext.getCmp(h.descID).setValue(_T("volume","del_soft_check_fail"))}else{Ext.getCmp(h.descID).setValue(_T("volume","volume_delete_summary_desc"))}}i.CheckMsg(f.check,c,"volumes",g);if(f.services&&f.services.length>0){g.append(_T("volume","volume_warninglistservice"),i.getServiceNames(f.services))}if(f.shares&&f.shares.length>0){g.append(_T("volume","volume_status_warningdelinfo"),i.getNamesString(f.shares));i.CheckMsg(f.check,c,"shares",g)}if(f.iscsiluns&&f.iscsiluns.length>0){g.append(_T("volume","volume_iscsitrg_lun"),i.getNamesString(f.iscsiluns));i.CheckMsg(f.check,c,"iscsiluns",g)}if(f.pkgs&&f.pkgs.length>0){g.append(_T("pkgmgr","title_packages"),i.getNamesString(f.pkgs))}h.services=f.services;if("yes"!==_D("support_ssd_cache","no")){return}Ext.each(h.volumeIds,function(k){d[k]=true});Ext.each(h.appWin.ssdCaches.getAll(),function(k){if(d[k.get("mountSpaceId")]){j.push(SYNO.SDS.Utils.StorageUtils.SpaceIDParser(k.get("id")).str)}},h);if(0<j.length){g.append(_T("volume","ssd_cache"),j.join(", "))}},apply:function(c,b){var a=this;a.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:c,version:1,params:b,callback:function(g,f,e,d){a.clearStatusBusy();if(!g){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);return}SYNO.SDS.StorageUtils.disableServices(a.services);a.isDataChanged=true;a.close()},scope:a})}});Ext.define("SYNO.SDS.StorageManager.Wizard.TrimVolumeProperty",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;c.isScheduleEdited=false;c.isDataChanged=false;c.nextTriggerTime="-";c.origEnableStatus=false;c.appWin=a.appWin;c.owner=a.owner;c.volume=a.volume;c.pool=a.pool;c.supportSSDTrim=a.supportSSDTrim;c.busyee=a.busyee;a.enable=a.supportSSDTrim;b={title:_T("volume","ssd_trim_title"),width:640,height:420,minWidth:300,minHeight:200,layout:"fit",border:false,items:[{xtype:"syno_formpanel",border:false,items:[{xtype:"syno_displayfield",value:_T("volume","ssd_trim_desc")},{xtype:"syno_checkbox",boxLabel:_T("volume","ssd_trim_en"),id:c.enabledId=Ext.id(),handler:c.onClickEnable,hideLabel:true,scope:c},c.grid=new SYNO.SDS.Wizard.SummaryStep({height:130}),{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_displayfield",fieldLabel:_T("schedule","next_trigger_time"),value:c.nextTriggerTime,id:c.nextTriggerTimeId=Ext.id()},{xtype:"syno_button",id:c.editButtonId=Ext.id(),text:_T("wireless_ap","ap_set_schedule"),handler:c.onEdit,scope:c}]}]};c.callParent([Ext.apply(b,a)])},onOpen:function(f){var c=this,a=SYNO.SDS.StorageUtils,d=[],e,b;if(!c.supportSSDTrim){Ext.getCmp(c.enabledId).disable();Ext.getCmp(c.nextTriggerTimeId).disable();Ext.getCmp(c.editButtonId).disable();return}if(c.volume.get("ssd_trim").schedule.next_trigger_time){c.nextTriggerTime=c.volume.get("ssd_trim").schedule.next_trigger_time}else{c.updateNextTriggerTime(false)}c.origEnableStatus=c.volume.get("ssd_trim").enable;Ext.getCmp(c.enabledId).setValue(c.origEnableStatus);if(c.origEnableStatus){Ext.getCmp(c.editButtonId).enable()}else{Ext.getCmp(c.editButtonId).disable()}if(c.pool&&"single"!==c.pool.get("raidType")){e={space_id:c.pool.id};b="SYNO.Storage.CGI.Pool"}else{d.push(c.volume.id);e={space_id:d};b="SYNO.Storage.CGI.Volume";c.grid.getStore().append(_T("volume","volume"),a.getVolumeNames([c.volume]))}f.setStatusBusy();SYNO.API.Request({api:b,method:"enum_resource",version:1,params:e,callback:function(j,i,h,g){f.clearStatusBusy();if(!j){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,i);return}c.loadData(i)},scope:c})},onEdit:function(){var d=this;if(!this.supportSSDTrim){return}var b=new SYNO.SDS.TaskScheduler2.ScheduleDialog({title:_T("schedule","schedule_advance"),listeners:{close:{scope:d,fn:function(){d.schedule=d.owner.schedule;d.isScheduleEdited=d.schedule?true:false;d.updateNextTriggerTime(true)}}},owner:d.owner});d.schedule=d.owner.schedule;var c=this.volume.get("ssd_trim").schedule;var a=this.schedule;var e=this.isScheduleEdited?a:c;b.open(this.scheduleToNew(e))},onClickEnable:function(){var a=Ext.getCmp(this.enabledId).getValue();if(a){Ext.getCmp(this.editButtonId).enable();Ext.getCmp(this.nextTriggerTimeId).setValue(this.nextTriggerTime)}else{Ext.getCmp(this.editButtonId).disable();Ext.getCmp(this.nextTriggerTimeId).setValue("-");this.volume.get("ssd_trim").schedule.next_trigger_time=null}},onSave:function(e){var d={};var b=Ext.getCmp(this.enabledId).getValue();var c=this.volume.get("ssd_trim").schedule;var a=this.schedule;if(!this.supportSSDTrim){e.close();return}if(b==this.origEnableStatus&&!this.isScheduleEdited){e.close();return}d.enable=b;d.space_path=this.pool?this.pool.get("space_path"):this.volume.get("space_path");d.num_id=this.pool?this.pool.get("num_id"):this.volume.get("num_id");d.is_pool_child=this.pool?true:false;if(b){d.schedule=this.isScheduleEdited?this.scheduleToOld(a):c}e.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:"ssd_trim_save",version:1,params:d,callback:function(i,h,g,f){e.clearStatusBusy();if(!i){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,h)}else{this.isDataChanged=true}e.close()},scope:this})},loadData:function(c){var b=this.grid.getStore(),a=SYNO.SDS.StorageUtils;if(c.volumes&&c.volumes.length>0){b.append(_T("volume","volume"),a.getVolumeNames(c.volumes))}},updateNextTriggerTime:function(d){var c=this;var e={};var b=this.volume.get("ssd_trim").schedule;var a=this.schedule;if("-"!==this.nextTriggerTime&&!this.isScheduleEdited){if(d){Ext.getCmp(this.nextTriggerTimeId).setValue(this.nextTriggerTime)}return}e.schedule=this.isScheduleEdited?this.scheduleToOld(a):b;c.busyee.setStatusBusy();SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:"next_trim_time_get",version:1,params:e,callback:function(i,h,g,f){c.busyee.clearStatusBusy();if(!i){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,h);return}this.nextTriggerTime=h.next_trigger_time;if(d){Ext.getCmp(this.nextTriggerTimeId).setValue(this.nextTriggerTime)}},scope:this})},scheduleToNew:function(b){if(b.hasOwnProperty("week_name")){b.week_day=b.week_name;delete b.week_name}if(b.hasOwnProperty("repeat")){b.repeat_data=b.repeat;b.repeat_date=b.repeat;delete b.repeat}if(b.hasOwnProperty("min")){b.minute=b.min;delete b.min}if(!b.hasOwnProperty("date")){var a=new Date();b.date=(a.getYear()+1900)+"/"+(a.getMonth()+1)+"/"+a.getDate();b.repeat_date=0}return b},scheduleToOld:function(a){if(a.hasOwnProperty("week_day")){a.week_name=a.week_day;delete a.week_day}if(a.hasOwnProperty("repeat_data")){a.repeat=a.repeat_data;delete a.repeat_data}if(a.hasOwnProperty("minute")){a.min=a.minute;delete a.minute}if(a.hasOwnProperty("repeat_date")){a.repeat=a.repeat_date;delete a.repeat_date}return a}});Ext.define("SYNO.SDS.StorageManager.Wizard.ExtentSizeProperty",{extend:"SYNO.ux.FormPanel",constructor:function(a){var d=this,c;d.appWin=a.appWin;d.owner=a.owner;d.volume=a.volume;d.volpath=a.volpath;c={title:_T("volume","extent_size_title"),itemId:"extent_size_property",trackResetOnLoad:true,layoutConfig:{trackLabels:true},labelWidth:250,items:[{xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_vaai_extent_size"),itemId:"extent_size",hideLabel:false,editable:false,forceSelection:true,allowBlank:false,width:250,disabled:false,hidden:false,value:8192,store:[[4096,_T("iscsitrg","iscsitrg_vaai_4k")],[8192,_T("iscsitrg","iscsitrg_vaai_8k")],[16384,_T("iscsitrg","iscsitrg_vaai_16k")],[32768,_T("iscsitrg","iscsitrg_vaai_32k")],[65536,_T("iscsitrg","iscsitrg_vaai_64k")]]},{xtype:"syno_displayfield",itemId:"extent_size_already_set",indent:0,value:""},{xtype:"syno_displayfield",itemId:"extent_size_intro",indent:0,value:_T("iscsitrg","iscsitrg_vaai_extent_size_notify")}]};d.callParent([Ext.apply(c,a)]);var b=("yes"===_D("support_vaai","no"));if(!b){d.getForm().findField("extent_size").disable()}},onCreate:function(){},onEdit:function(c){var a=this,b={};if(!a.volume){return}b.action="vol_extent_size_get";b.volpath=a.volpath;c.setStatusBusy({text:_T("common","msg_waiting")});SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:"vol_extent_size_get",version:1,params:b,callback:function(h,g,f,d){var e;if(!h){e=8192}else{e=parseInt(g.extent_size,10)}a.getForm().setValues({extent_size:e});if(h){a.getForm().findField("extent_size").disable();a.getForm().findField("extent_size_already_set").setValue(_T("iscsitrg","iscsitrg_vaai_extent_size_already_set"))}c.clearStatusBusy()},scope:this})},onSave:function(d){var a=this,c,b=a.getForm().findField("extent_size").value;c={extent_size:b,volpath:a.volpath};a.applySettings("vol_extent_size_set",c,d)},applySettings:function(d,c,b){var a=this;b.setStatusBusy({text:_T("common","msg_waiting")});SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:d,version:1,params:c,callback:function(h,g,f,e){b.clearStatusBusy();if(!h){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,g)}b.close()},scope:a})}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvPropVolume",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.volume=a.volume;c.volpath=a.volpath;c.supportSSDTrim=a.supportSSDTrim;c.pool=a.pool;b={title:_T("volume","adv_prop_title"),width:640,height:500,resizable:false,layout:"fit",plain:true,border:false,items:[{itemId:"main",xtype:"syno_tabpanel",hideMode:"offsets",deferredRender:false,activeTab:0,plain:true,items:[]}],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};c.no_ssd_trim_support=("yes"!==_D("support_trim","no"))||("not support"===c.volume.get("ssd_trim").support);c.trimvol=null;if(!c.no_ssd_trim_support){c.trimvol=new SYNO.SDS.StorageManager.Wizard.TrimVolumeProperty({appWin:c.appWin,owner:c.owner,volume:c.volume,pool:c.pool,border:false,frame:false,supportSSDTrim:c.supportSSDTrim,busyee:c,itemId:"trim_p"});b.items[0].items.push(c.trimvol)}c.extszvol=null;if("yes"===_D("support_vaai","no")){c.extszvol=new SYNO.SDS.StorageManager.Wizard.ExtentSizeProperty({appWin:c.appWin,owner:c.owner,volume:c.volume,volpath:c.volpath,border:false,itemId:"extent_size_p"});b.items[0].items.push(c.extszvol)}c.callParent([Ext.apply(b,a)])},onOpen:function(){var a=this;a.callParent(arguments);if(a.trimvol){a.trimvol.onOpen(a)}if(a.extszvol){a.extszvol.onEdit(a)}},onSave:function(){var b=this;if(b.extszvol&&!b.extszvol.getForm().isValid()){return}var c=this.getComponent("main");if(!c){console.log("js tab error: tab not found!");b.close()}var a=c.getActiveTab();if(a){a.onSave(b)}else{console.log("js tab error: invalid tab!");b.close()}},onCancel:function(){var a=this;a.close()}});Ext.define("SYNO.SDS.StorageManager.Space",{check:SYNO.SDS.StorageUtils.check,get:function(a){if(this.json){return this.json[a]}return undefined},getIdProp:function(){return SYNO.SDS.StorageUtils.SpaceIDParser(this.get("id"))},getISCSIProp:function(){return this.isISCSI()?this.get("iscsi_lun"):{}},getStatusStr:function(){return SYNO.SDS.StorageUtils.StatusNameRender(this.get("status"))},getName:function(){if(this.isISCSI()){return this.get("iscsi_lun").name}else{return SYNO.SDS.StorageUtils.SpaceIDParser(this.get("id")).str}},getLunId:function(){if(this.isISCSI()){return this.get("iscsi_lun").lid}else{return undefined}},getVolumeId:function(){if(this.isVolume()){return this.get("id")}else{return undefined}},isVolume:function(){return"volume"===this.getIdProp().type},isISCSI:function(){return"iscsi"===this.getIdProp().type},isActioning:function(){return !!(this.get("is_actioning"))},isDeleting:function(){return"deleting"===this.get("status")},isCreating:function(){return"creating"===this.get("status")},isCrashed:function(){return"crashed"===this.get("status")},isDegrade:function(){return"degrade"===this.get("status")},isNotCrashed:function(){return"crashed"!==this.get("status")},isBgProgressing:function(){return"background"===this.get("status")},isWritable:function(){return !!(this.get("is_writable"))},isExpansion:function(){return 0===this.get("device_type").indexOf("expansion")},isBlockSpace:function(){return this.isVolume()||"block"===this.getISCSIProp().device_type},isBlockLun:function(){return("block"===this.getISCSIProp().device_type)},isFileLun:function(){return("file"===this.getISCSIProp().device_type||"sink"===this.getISCSIProp().device_type)},isSinkLun:function(){return("sink"===this.getISCSIProp().device_type)},isPool:function(){return(this.get("pool_path")===this.id||(""===this.get("pool_path")&&!this.get("vol_path")))},isPoolChild:function(){if(this.isPool()){return false}return this.get("pool_path")&&this.get("pool_path").length>0},isUnhealthy:function(){return"Unhealthy"===this.get("status")},notUsedByGlusterFs:function(){return !this.get("used_by_gluster")},usedByGlusterFs:function(){return this.get("used_by_gluster")||false},cacheMissing:function(){return("cache_missing"===this.get("cacheStatus"))},cacheCrashed:function(){return("cache_crashed"===this.get("cacheStatus"))},getPoolChild:function(){if(this.isPool()){return this.get("pool_child")}return undefined},getPoolID:function(){if(this.isPool()){return this.get("id")}return this.get("pool_path")},isLogicalVolume:function(){if(this.isPool()||!this.get("pool_path")){return false}return this.get("pool_path").length>0},canRepair:function(a){if(0===a.length||-1===a.indexOf(this.get("space_path"))){return true}return false},getDriveType:function(){var a=this.get("drive_type");if(-1===a){return"Unknown"}else{if(0===a){return"HDD"}else{if(1===a){return"SSD"}else{if(2===a){return"Hybrid"}}}}},getDriveTypeStr:function(){var a=this.get("drive_type");if(-1===a){return _T("common","status_unknown")}else{if(0===a){return"HDD"}else{if(1===a){return"SSD"}else{if(2===a){return _T("volume","drv_hybrid")}}}}},canExpandUnalloc:function(){var a=this.get("can_do");if(Ext.isDefined(a.expand_with_unalloc_size)){return true}return false},getDeviceType:function(){return this.get("device_type")},getProgressStep:function(){return this.get("progress").step},isFreeSizeBiggerThan1GB:function(){var b=parseInt(this.get("size").total,10);var a=parseInt(this.get("size").used,10);var c=(b-a)/(1024*1024*1024);return c>=1},notDeployed:function(){if(this.get("deploy_path")){return false}return true},isMultiRaidsPool:function(){var b=this,a=b.get("raids");if(!b.isPool){return false}if(-1<b.get("device_type").indexOf("shr")||!a||!Ext.isArray(a)||1>=a.length){return false}return true}});Ext.define("SYNO.SDS.StorageManager.Volume.Store",{extend:"Ext.ux.data.PagingJsonStore",constructor:function(a){var c=this,b;c.sortField="numId";c.sortDir="ASC";b={autoDestroy:true,idProperty:"id",fields:["numId","id","iconCls","statusIconCls","displayName","desc","usage","barWidth","summaryStatus","property","raidInfo","detailUsage","illustrate","status","totalSize","freeSize"],listeners:{load:function(){c.sort(c.sortField,c.sortDir)},scope:c}};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.StorageManager.Volume.Main",{extend:"SYNO.ux.Panel",pageSize:25,constructor:function(a){var d=this,b,c;d.appWin=a.appWin;d.owner=a.appWin;d.sortType="sort_numId";d.createView();c=d.view.getSelectedItem();b={border:false,layout:"fit",itemId:"volume",tbar:{defaultType:"syno_button",items:[{itemId:"create",text:_T("common","create"),handler:d.onCreate,hidden:d.appWin.isVDSM,scope:d},{itemId:"remove",text:_T("common","remove"),handler:d.onDelete,hidden:d.appWin.isVDSM,scope:d},{itemId:"edit",text:_T("common","alt_edit"),handler:d.onEdit,scope:d},{itemId:"manage",text:_T("volume","volume_manage"),handler:d.onManage,hidden:d.appWin.isVDSM,scope:d},{itemId:"adv_manage",text:_T("volume","volume_manage"),menu:[{itemId:"fs_scrubbing",text:_T("volume","volume_scrubbing_type_fs"),handler:function(){d.onAdvManage("fs_scrubbing")},scope:d},{itemId:"defrag",text:_T("volume","fs_defrag"),handler:function(){d.onAdvManage("defrag")},scope:d}]},{itemId:"expand",text:_T("volume","volume_adddisk2_type_expand"),hidden:!d.appWin.supportRaidGroup,handler:d.onExpand,scope:d},{itemId:"adv_prop",text:_T("volume","adv_prop_title"),disabled:false,handler:d.onAdvProp,scope:d},{itemId:"cancel",text:_T("common","alt_cancel"),handler:d.onCancel,scope:d},"->",new SYNO.SDS.StorageManager.SortButton({appWin:d.appWin,owner:d,menuItems:[{text:_T("volume","volume_sort_by_id"),itemId:"sort_numId",handler:d.onSort,scope:d},{text:_T("volume","volume_sort_by_status"),itemId:"sort_status",handler:d.onSort,scope:d},{text:_T("volume","volume_sort_by_available"),itemId:"sort_freeSize",handler:d.onSort,scope:d},{text:_T("volume","volume_sort_by_capacity"),itemId:"sort_totalSize",handler:d.onSort,scope:d}]})]},bbar:new SYNO.ux.PagingToolbar({store:d.view.store,pageSize:d.pageSize}),items:d.view,listeners:{activate:d.onActivate,scope:d}};d.callParent([Ext.apply(b,a)])},getHelpParam:function(){if(this.appWin.supportRaidGroup){return"StorageManager/space.html"}else{return"StorageManager/volume_diskgroup.html"}},createView:function(){var e=this,c=SYNO.SDS.StorageManager.UsageTpl(),d=SYNO.SDS.StorageManager.PropertyTpl(),g=SYNO.SDS.StorageManager.DiskListTpl({scope:"disks",emptyText:_T("volume","volume_status_none")}),f=SYNO.SDS.StorageManager.DiskListTpl({scope:"spares",title:_T("volume","volume_suitable_spare_disks"),emptyText:_T("volume","volume_no_suitable_spare_disks")}),h=SYNO.SDS.StorageManager.DetailUsageTpl(),b,a;b=new Ext.XTemplate('<div class="item-detail-inner">',d.html,'<tpl if="this.hasValues(raidInfo) == true">','<tpl for="raidInfo">',(e.appWin.isVDSM)?"":g.html,(e.appWin.supportHotSpare)?f.html:"","</tpl>","</tpl>",h.html,"</div>");a={appWin:e.appWin,owner:e,dataType:"volumes",itemId:"volumeView",multiSelect:true,usageTpl:c,detailTpl:b,store:new SYNO.SDS.StorageManager.Volume.Store(),listeners:{selectionchange:e.onSelectChange,scope:e}};e.view=new SYNO.SDS.StorageManager.DataView(a)},prepareUiData:function(){var a=this,b=a.appWin.volumes.getMatched("notUsedByGlusterFs");delete a.uiData;delete a.ssdLinkIdList;a.uiData=[];a.ssdLinkIdList=[];Ext.each(b,function(c){var d={};a.prepareSummary(c,d);a.prepareProperty(c,d);a.prepareRaidInfo(c,d);a.prepareDetail(c,d);a.uiData.push(d)},a)},prepareSummary:function(e,f){var d=this,c=SYNO.SDS.StorageUtils,b=parseInt(e.get("size").used,10),a=parseInt(e.get("size").total,10),g;f.numId=e.get("num_id");f.status=e.get("status");f.totalSize=a;f.freeSize=a-b;f.id=e.get("id");f.displayName=c.SpaceIDParser(e.get("id")).str;f.desc=e.get("desc");f.usage=String.format('<span style="color:#0086E5">{0}</span>&nbsp;/&nbsp;{1}',c.SizeRender(b),c.SizeRender(a));f.barWidth=(0===a)?0:200*b/a;if("cache_missing"===e.get("cacheStatus")){f.summaryStatus=String.format("&nbsp;-&nbsp;{0}",c.StatusNameRender(e.get("cacheStatus")))}else{f.summaryStatus=String.format("&nbsp;-&nbsp;{0}",c.StatusNameRender(e.get("status")))}if("btrfs"===e.get("fs_type")){g="btrfs"}else{g="ext4"}if(e.isLogicalVolume()&&!d.appWin.supportRaidGroup){f.iconCls="sm-list-icon-"+g+"-multi-volume"}else{f.iconCls="sm-list-icon-"+g+"-single-volume"}if(e.get("is_actioning")){f.statusIconCls="sm-list-status-icon-acting"}else{if("crashed"===e.get("status")||"degrade"===e.get("status")){f.statusIconCls="sm-list-status-icon-crashed"}}},prepareProperty:function(f,e){var g=this,h=SYNO.SDS.StorageUtils,j=parseInt(f.get("size").used,10),i=parseInt(f.get("size").total,10),b,k,a;if("cache_missing"===f.get("cacheStatus")){b=h.StatusNameRender(f.get("cacheStatus"))}else{b=h.StatusRender(f.get("status"),f.get("progress"))}if(g.appWin.supportRaidGroup||f.isPoolChild()){a=h.WarningTextRender(f.get("status"),h.SpaceIDParser(f.get("pool_path")).str)}else{a=h.WarningTextRender(f.get("status"),h.SpaceIDParser(f.get("id")).str)}e.property=[];if(!g.appWin.isVDSM){e.property.push({name:_T("volume","volume_raid_title"),value:h.SpaceTypeRender(f.get("device_type"))})}g.renderSuggestions(f,e);if(f.isLogicalVolume()||g.appWin.supportRaidGroup){e.property.push({name:g.appWin.supportRaidGroup?_T("volume","volume_storage_pool"):_T("volume","volume_pool"),value:h.SpaceIDParser(f.get("pool_path")).str})}if(f.get("fs_type")){k="volume_add_fs_"+f.get("fs_type")+"_type";e.property.push({name:_T("volume","volume_add_fs_type"),value:_T("volume",k)})}e.property.push({name:_T("volume","volume_volumestatus"),value:b+a});if(f.get("cache")){var c=Ext.id();var l=String.format('<a class="link-font" href="#" id={0} cache_id={1}>{2}</a>',c,f.get("cache").id,SYNO.SDS.StorageUtils.SpaceIDParser(f.get("cache").id).str);var d=String.format("{0} ({1})",l,SYNO.SDS.StorageUtils.StatusNameRender(f.get("cache").status));g.ssdLinkIdList.push(c);e.property.push({name:_T("volume","ssd_cache"),value:d})}e.property.push({name:_T("volume","volume_totalsize"),value:h.SizeRender(i)});e.property.push({name:_T("volume","volume_usedsize"),value:h.SizeRender(j)});e.property.push({name:_T("volume","volume_freesize"),value:h.SizeRender(i-j)});if(f.get("is_inode_full")){e.property.push({name:_T("volume","volume_available_filenumber"),value:'<span class="red-status">'+f.get("size").free_inode+"</span>"})}if(f.get("disk_failure_number")>0&&f.get("progress").step!=="disk_initialize"){e.property.push({name:_T("volume","volume_disk_failure_number"),value:'<span class="red-status">'+f.get("disk_failure_number")+"</span>"})}},linkTargetElement:function(g,f){var c=this,b=new Ext.Element(f),a=b.getAttribute("cache_id"),d;if(""===a){return}c.appWin.selectPage("SYNO.SDS.StorageManager.SsdCache.Main");d=c.appWin.getActivePage();d.listView.select(a);d.fireEvent("nextDetail")},prepareRaidInfo:function(c,b){var d=this,h=[],e=d.appWin.disks.data,j=d.appWin.hotSpares.data,i,a,f=SYNO.SDS.StorageUtils,g=false;if(c.isLogicalVolume()||d.appWin.supportRaidGroup){return}b.raidInfo=[];i=[];Ext.each(c.get("disks"),function(k){a=e[k];if(!a){return true}if(a.is4Kn()){g=true}i.push({container:"internal"===a.get("container").type?_S("hostname"):a.get("container").str,name:a.get("name"),size:f.SizeRender(a.get("size_total")),driveType:a.get("isSsd")?"SSD":"HDD",status:f.DiskStatusRender(a.get("status"))})});Ext.each(c.get("spares"),function(k){a=e[k.id];k=j[k.id];if(!a||!k){return true}if(a.is4Kn()!==g){return true}h.push({container:"internal"===a.get("container").type?_S("hostname"):a.get("container").str,name:a.get("name"),size:f.SizeRender(a.get("size_total")),driveType:a.get("isSsd")?"SSD":"HDD",status:f.SpareStatusRender(k.get("status").type)})});b.raidInfo.push({disks:i,spares:h})},prepareDetail:function(f,d){var h=SYNO.SDS.StorageUtils,g={lun:parseInt(f.get("eppool_used"),10)},j=parseInt(f.get("size").used,10),i=parseInt(f.get("size").total,10),e=h.GetSizeUnit(g.lun),b=h.GetSizeUnit(j-g.lun),a=h.GetSizeUnit(i-j);var c=function(k){if(0>k.size){k.message=_T("volume","volume_size_calculating")}};c(e);c(b);c(a);d.detailUsage={};i=(0===i)?1:i;d.detailUsage.bar1Width=(j-g.lun)/i*100;d.detailUsage.bar2Width=(0!==g.lun)?g.lun/i*100:0;d.illustrate=[{text:_T("volume","volume_share_folders"),value:b.size,unit:b.unit,message:b.message,hide:0},{text:_T("volume","volume_lun_file"),value:e.size,unit:e.unit,message:e.message,hide:("yes"===_D("support_iscsi_target","no"))?0:1},{text:_T("volume","volume_freesize"),value:a.size,unit:a.unit,message:a.message,hide:0}]},renderSuggestions:function(m,u){var n,l="",g="",e={};var a=false;var f=false;var h=false;var d=false;var c="";var s="";var p="";var q="";var j=m.get("suggestions");var t=SYNO.SDS.StorageUtils;if(!j||j.length<=0){return}for(n=0;n<j.length;n++){g=t.FormatSuggestion(j[n]);if(undefined!==j[n].note){switch(j[n].note){case"system partition failed":e=SYNO.SDS.Utils.clone(j[n]);e.str=g;a=true;break;case"remove crashed pool child":e=SYNO.SDS.Utils.clone(j[n]);e.str=g;f=true;break;case"repair degraded pool child":e=SYNO.SDS.Utils.clone(j[n]);e.str=g;h=true;break;case"fs error need fsck":e=SYNO.SDS.Utils.clone(j[n]);e.str=g;d=true;break;default:continue}}else{l+=String.format('<span class="{0}">{1}{2}</span><br>',j[n].type==="warning"?"red-status":"green-status",g,"")}}if(a){var k=Ext.id();c=String.format('&nbsp<a class="link-font" id="{0}" href="#" space_id={2}>{1}</a>',k,_T("volume","volume_repair_syspart"),m.get("id"));l+=String.format('<span class="{0}">{1}{2}</span><br>',e.type==="warning"?"red-status":"green-status",e.str,c);if(c){this.mon(this.view.getStore(),"load",function(){var i=Ext.fly(k);this.mon(i,"click",this.repairSysPartition,this)},this,{single:true})}}else{if(f){var o=Ext.id();s=String.format('&nbsp<a class="link-font" id="{0}" href="#" space_id={2}>{1}</a>',o,this.appWin.supportRaidGroup?_T("volume","volume_storage_pool_link"):_T("volume","volume_remove_link"),m.get("pool_path"));l+=String.format('<span class="{0}">{1}{2}</span><br>',e.type==="warning"?"red-status":"green-status",e.str,s);if(s){this.mon(this.view.getStore(),"load",function(){var i=Ext.fly(o);this.mon(i,"click",this.linkPoolElement,this)},this,{single:true})}}else{if(h){var b=Ext.id();p=String.format('&nbsp<a class="link-font" id="{0}" href="#" space_id={2}>{1}</a>',b,this.appWin.supportRaidGroup?_T("volume","volume_storage_pool_link"):_T("volume","volume_repair_link"),m.get("pool_path"));l+=String.format('<span class="{0}">{1}{2}</span><br>',e.type==="warning"?"red-status":"green-status",e.str,p);if(p){this.mon(this.view.getStore(),"load",function(){var i=Ext.fly(b);this.mon(i,"click",this.linkPoolElement,this)},this,{single:true})}}else{if(d){var r=Ext.id();q=String.format('&nbsp<a class="link-font" id="{0}" href="#" space_id={2}>{1}</a>',r,_T("volume","volume_do_fsck"),m.get("id"));l+=String.format('<span class="{0}">{1}{2}</span><br>',e.type==="warning"?"red-status":"green-status",e.str,q);if(q){this.mon(this.view.getStore(),"load",function(){var i=Ext.fly(r);this.mon(i,"click",this.showFsckDialog,this)},this,{single:true})}}else{SYNO.Debug("other suggestion")}}}}u.property.push({name:_T("volume","volume_status_suggest"),value:l})},onActivate:function(){var b=this,c,a=b.view.store;b.prepareUiData();if(a.start>=b.uiData.length){c=(b.uiData.length<=b.pageSize)?0:Math.floor(b.uiData.length/b.pageSize)*b.pageSize}else{c=a.start||0}a.lastOptions={params:{limit:b.pageSize,start:c}};a.loadData(b.uiData,false);b.resetBtnStatus();if(0<b.view.store.getCount()&&0===b.view.getSelectedItemIds().length){b.view.select(0,true,true)}if(b.pageSize>=b.uiData.length){b.getBottomToolbar().hide()}else{b.getBottomToolbar().show()}b.doLayout();b.onSelectChange();b.setMask();b.monSsdLink()},monSsdLink:function(){var a=this;a.ssdLinkIdList.forEach(function(b){a.mon(Ext.fly(b),"click",a.linkTargetElement,a,{single:true})})},onSelectChange:function(){var c=this,b,d=c.view.getSelectedItems();c.getButton("remove").hide();c.getButton("edit").hide();c.getButton("manage").hide();c.getButton("adv_manage").hide();c.getButton("expand").hide();c.getButton("adv_prop").hide();c.getButton("cancel").hide();if(0===d.length){return}if(!c.appWin.isVDSM){c.getButton("remove").show();c.enableButton("remove",c.canDelete(d))}if(1===d.length){b=d[0];c.getButton("edit").show();c.enableButton("edit",c.canEdit(b));if(b.isCreating()||(!b.isPoolChild()&&"data_scrubbing"===b.getProgressStep())||("fs_scrubbing"===b.getProgressStep())||("defrag"===b.getProgressStep())){c.getButton("cancel").show();c.enableButton("cancel",c.canCancel(b))}if(!c.appWin.isVDSM){if(!c.appWin.supportRaidGroup){c.getButton("manage").show();c.enableButton("manage",c.canManage(b))}else{if(c.canExpand(b)){c.getButton("expand").show();c.enableButton("expand",true)}}if(c.appWin.supportRaidGroup&&"yes"===_D("support_btrfs","no")){c.getButton("adv_manage").show();c.enableButton("adv_manage","btrfs"===b.get("fs_type")&&"normal"===b.get("status"))}}var e=("yes"!==_D("support_trim","no"))||("not support"===b.get("ssd_trim").support);var a=("yes"===_D("support_vaai","no"));if(!e||a){c.getButton("adv_prop").show();c.enableButton("adv_prop",c.canSetting(b))}else{c.getButton("adv_prop").hide();c.enableButton("adv_prop",false)}}},onCreate:function(){var c=this,b,a;b=c.canCreate();if(!b){return}a=(c.appWin.supportRaidGroup)?"EditVolumeMain":"CreateVolumeMain";c.openWizard(a,{mode:"create",option:b})},onDelete:function(){var c=this,d,a,b;d=c.view.getSelectedItems();if(0===d.length){return}for(b=0;b<d.length;++b){if(d[b].get("used_by_gluster")){c.owner.getMsgBox().alert(c.title,_T("volume","goto_cms_manage_volume"));return}}a=c.view.getSelectedItemIds();c.openWizard("DeleteVolume",{volumeIds:a})},onEdit:function(){var b=this,a;a=b.view.getSelectedItem();if(!a){return}if(a.get("used_by_gluster")){b.owner.getMsgBox().alert(b.title,_T("volume","goto_cms_manage_volume"));return}b.openWizard("EditVolumeMain",{mode:"edit",volume:a})},onManage:function(){var e=this,a,c,f,b,d,g;if(e.appWin.supportRaidGroup){return}b=e.view.getSelectedItemIds();if(0===b.length){return}d=e.appWin.volumes.data[b[0]];if(!d){return}a=e.getAvailableDisksForAdd(d);c=e.getAvailableDisksForAdd(d,"expand_by_disk");f=e.getValidAddType(d,a);g=(0<d.get("disk_failure_number"))?true:false;if(d.get("used_by_gluster")&&!f.repair){e.owner.getMsgBox().alert(e.title,_T("volume","goto_cms_manage_volume"));return}e.openWizard("Manage",{title:_T("volume","volume_manage_title"),spaceType:"volume",api:"SYNO.Storage.CGI.Volume",space:d,disks:a,disksForExpand:c,add_type:f,migrate_type:e.getValidMigrateType(d,a),hasFailedDisk:g})},onAdvManage:function(h){var b=this;var g,f,e;var a=b.view.getSelectedItem();var d={fs_scrubbing:_T("volume","volume_scrubbing_type_fs"),defrag:_T("volume","fs_do_defrag")};var c={fs_scrubbing:_T("volume","fs_scrubbing_notice"),defrag:_T("volume","fs_defrag_notice")};e={vol_path:a.get("vol_path")};f=d[h];g=c[h];b.owner.getMsgBox().confirm(f,g,function(i){if("yes"===i){this.owner.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:h,version:1,params:e,callback:function(m,l,k,j){this.owner.clearStatusBusy();if(!m){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,l)}},scope:this})}},this)},onExpand:function(){var b=this,a=b.view.getSelectedItem();if(!a){return}b.openWizard("Manage",{title:_T("volume","volume_manage_title"),spaceType:"volume",api:"SYNO.Storage.CGI.Volume",space:a,add_type:"expand_with_unalloc_size"})},onAdvProp:function(){var j=this,d,e,k,n,a,h,g,b,f,m=true,c=true;e=j.view.getSelectedItem();if(!e){return}k=e.get("vol_path");var l=function(){j.openWizard("AdvPropVolume",{volume:e,volpath:k,supportSSDTrim:m,pool:f})};if(!e||"not support"===(h=e.get("ssd_trim").support)){m=false}if(m){if(_S("ha_running")){g="ha"}if(j.appWin.supportSsdCache){n=j.appWin.ssdCaches.getAll();for(d=0;d<n.length;++d){a=n[d];if(e.get("vol_path")===a.get("path")){g="cache"}}}if("disabled by time backup"===h){g="backup"}if(g){if("ha"===g){b=_T("volume","ssd_trim_disabled_by_ha")}else{if("cache"===g){b=_T("volume","ssd_trim_disabled_by_cache")}else{if("backup"===g){b=_T("volume","ssd_trim_disabled_by_backup")}}}c=false;j.owner.getMsgBox().alert(_T("volume","ssd_trim_title"),b,l);m=false}if("partial support"===h){c=false;j.owner.getMsgBox().alert(_T("volume","ssd_trim_title"),_T("volume","ssd_trim_not_support_desc"),l);m=false}f=j.appWin.storagePools.data[e.get("pool_path")]}if(c){l()}},onCancel:function(){var c=this,b=c.view.getSelectedItem(),e,a,d;if(!b){return}e=b.get("id");a="";d="cancel_create";c.appWin.stopPollTask();c.owner.setStatusBusy({text:_T("common","saving")});if("data_scrubbing"===b.getProgressStep()){d="cancel_data_scrubbing"}else{if("fs_scrubbing"===b.getProgressStep()){d="cancel_fs_scrubbing";a=b.get("vol_path")}else{if("defrag"===b.getProgressStep()){d="cancel_defrag";a=b.get("vol_path")}}}SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:d,version:1,params:{space_id:e,vol_path:a},callback:function(i,h,g,f){this.clearStatusBusy();if(!i){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,h)}this.setStatusBusy();this.cleanMask=true;this.startPollTask()},scope:c.owner})},onSort:function(f,d){var c=this,b,a=c.view.store;if(0>f.itemId.indexOf("_")){return}c.sortType=f.itemId;b=f.itemId.split("_")[1];if(a.sortField!==b){a.sortField=b;a.sortDir="ASC"}else{a.sortDir="ASC"===a.sortDir?"DESC":"ASC"}a.sort(a.sortField,a.sortDir);c.onSelectChange()},resetBtnStatus:function(){var a=this;a.getButton("remove").hide();a.getButton("edit").hide();a.getButton("manage").hide();a.getButton("expand").hide();a.getButton("adv_prop").hide();a.getButton("cancel").hide();a.enableButton("create",a.canCreate())},setMask:function(){var b=this;if(b.isVisible()&&0===b.view.getStore().getCount()){if(0===b.appWin.storagePools.count&&b.appWin.supportRaidGroup){var d=Ext.id();var a=String.format('<a id="{0}" class="link-font" style="cursor:pointer;">{1}</a>',d,_T("volume","volume_storage_pool_tab"));var c=String.format(_T("volume","volume_no_raid_in_system"),_T("volume","volume_storage_pool"),a);this.body.mask(c,"syno-ux-mask-info");b.mon(Ext.fly(d),"click",function(){b.appWin.selectPage("SYNO.SDS.StorageManager.Pool.Main")},b)}else{this.body.mask(_T("volume","volume_no_volumes"),"syno-ux-mask-info")}this.getButton("sort").disable()}if(0<this.view.getStore().getCount()){this.body.unmask();this.getButton("sort").enable()}},setFocus:function(b){var a=this;a.view.focusNode(b);a.view.select(b);if(!a.view.expandedItemId[b]){a.view.doExpand(true,Ext.get(b),true)}},syncHeight:function(){var b=this.toolbarHeight,c=this.body,a=this.lastSize.height,d;if(this.autoHeight||!Ext.isDefined(a)||a=="auto"){return}if(b!=this.getToolbarHeight()){b=Math.max(0,a-this.getFrameHeight());if(this.getBottomToolbar().isVisible()){b-=12}c.setHeight(b);d=c.getSize();this.toolbarHeight=this.getToolbarHeight();this.onBodyResize(d.width,d.height)}},canCreate:function(){var c=this,a=c.appWin.disks.getMatched("isNormalTray","isFree"),d=c.appWin.storagePools.getMatched("isFreeSizeBiggerThan1GB","isWritable","notDeployed","notUsedByGlusterFs"),b={},e;if(c.appWin.isVDSM){return false}if((_S("ha_running")&&c.appWin.isUpToHASpaceMaxCount())||c.appWin.isUpToVolumeMaxCount()){return false}if(!c.appWin.supportRaidGroup&&0<a.length){b.can_create_volume=true}if(0<d.length){b.can_create_volume_on_existing_pool=true}for(e in b){if(b.hasOwnProperty(e)){return b}}return false},canDelete:function(g){var f=this,e=f.appWin.storagePools.data,b,a,d,c;if(f.appWin.isVDSM){return false}if(0===g.length){return false}for(a=0;a<g.length;++a){d=g[a];if(d.isActioning()){return false}c=d.get("can_do");if(d.isLogicalVolume()||f.appWin.supportRaidGroup){b=e[d.get("pool_path")];if(b.isCrashed()){return false}}if(!c["delete"]){return false}}if(f.appWin.isAnyStorageActioning(g)){return false}return true},canEdit:function(a){if(!a){return false}if(a.isActioning()){return false}if(a.isCrashed()){return false}return true},canManage:function(e){var d=this,c,a,b;if(d.appWin.isVDSM){return false}if(!e){return false}if(e.isActioning()){return false}if(e.isCrashed()){return false}a=d.getAvailableDisksForAdd(e);b=d.getValidAddType(e,a);for(c in b){if(b[c]){return true}}return false},canExpand:function(f){var e=this,d=f.get("can_do"),a=f.get("size"),c,b;if(e.appWin.isVDSM){return false}if(!f||!d||!d.expand_with_unalloc_size){return false}c=parseInt(d.expand_with_unalloc_size,10);b=parseInt(a.total_device,10);return(0<c&&c===b)},canCancel:function(c){var b=this,a;if(b.appWin.isVDSM){return false}if(!c){return false}if(c.isCreating()){a=c.getProgressStep();if(a==="mk_filesystem"||a==="disk_check"||a==="raid_syncing"||a==="raid_parity_checking"||(a==="waiting"&&!_S("ha_running"))){return true}}else{if("data_scrubbing"===c.getProgressStep()||"fs_scrubbing"===c.getProgressStep()||"defrag"===c.getProgressStep()){return true}}return false},canSetting:function(a){if(!a){return false}if(a.isDeleting()||a.isCreating()){return false}if(a.isCrashed()){return false}return true},getAvailableDisksForAdd:function(d,b){var f=this,i=d.get("minimal_disk_size"),a=d.get("container"),g=[],c=[],h=false,e=function(j){if(-1===d.get("device_type").indexOf("shr")||"expand_by_disk"!==b){return j.isBiggerThan(i)}return j.isBiggerThan(i)||j.isEqualToAny(c)};if(!a||!d.get("can_do")){return g}d.get("disks").each(function(j){var k=f.appWin.disks.data[j];if(!k){return true}if(k.is4Kn()){h=true}c.push(parseInt(k.get("size_total"),10))},this);if(d.get("can_do").raid_cross||d.isExpansion()){g=f.appWin.disks.getMatched(function(){var j=this;return j.isNormalTray()&&j.isFree()&&e(j)&&((j.is4Kn()&&h)||(!j.is4Kn()&&!h))})}else{if("internal"===a){g=f.appWin.disks.getMatched(function(){var j=this;return j.isNormalTray()&&j.isFree()&&j.isInternal()&&e(j)&&((j.is4Kn()&&h)||(!j.is4Kn()&&!h))})}else{if("ebox"===a){g=f.appWin.disks.getMatched(function(){var j=this;return j.isFree()&&j.isInEbox()&&e(j)&&((j.is4Kn()&&h)||(!j.is4Kn()&&!h))})}}}return g},getValidAddType:function(c,f){var e=this,a=c.get("can_do"),b,k,d=false,j,h,g;if(!a){return{}}k=e.getValidMigrateType(c,f);for(b in k){if(k[b]){d=true;break}}g=e.getAvailableDisksForAdd(c,"expand_by_disk");if("normal"===c.get("status")){j=("btrfs"===c.get("fs_type")&&"yes"===_D("support_btrfs","no"));h=("btrfs"===c.get("fs_type")&&"yes"===_D("support_btrfs","no"))}else{j=false;h=false}return{repair:("repair" in a)&&0<f.length,scrubbing:("data_scrubbing" in a),fs_scrubbing:j,defrag:h,expand_by_disk:("expand_by_disk" in a)&&a.expand_by_disk<=g.length,expand_with_unalloc_size:("expand_with_unalloc_size" in a)&&(parseInt(a.expand_with_unalloc_size,10)>0),migrate:d,expand_unfinished_shr:("expand_unfinished_shr" in a)}},getValidMigrateType:function(f,a){var b,g,d,e=f.get("can_do"),c={};if(!e||!e.migrate){return{}}e=e.migrate;if("to_raid5+spare" in e){b=e["to_raid5+spare"].split("-");g=parseInt(b[0],10);d=parseInt(b[1],10);c["to_raid5+spare"]=(g<=a.length)&&!_S("ha_running")}return Ext.applyIf(c,{add_mirror:("add_mirror" in e)&&0<a.length,to_raid1:("to_raid1" in e)&&0<a.length&&!_S("ha_running"),to_raid5:("to_raid5" in e)&&e.to_raid5<=a.length&&!_S("ha_running"),to_raid6:("to_raid6" in e)&&e.to_raid6<=a.length&&!_S("ha_running")})},openWizard:function(b,a){var c=this,e;if(c.appWin.isUpToBatchTaskCount()){e=_T("volume","volume_max_batch_task_count").replace("_MAX_TASK_",c.appWin.getMaxBatchTaskCount());c.appWin.getMsgBox().alert(c.title,e,function(){},c);return}var d=new SYNO.SDS.StorageManager.Wizard[b](Ext.apply({appWin:c.appWin,owner:c.owner},a));c.appWin.stopPollTask();c.mon(d,"close",function(){if(Ext.isFunction(d.hideFromOwner)){d.hideFromOwner()}if(d.isDataChanged){c.owner.setStatusBusy();c.body.unmask();c.owner.cleanMask=true}c.appWin.startPollTask()},c,{single:true});d.open()},repairSysPartition:function(c,b){var a=new Ext.Element(b);var d=a.getAttribute("space_id");this.owner.setStatusBusy({text:_T("common","saving")});this.owner.updater.stop();SYNO.API.Request({webapi:{api:"SYNO.Storage.CGI.Storage",method:"repair_sys_partition",version:"1",params:{space_id:d}},callback:function(h,e,g,f){this.owner.clearStatusBusy();if(!h){this.owner.getMsgBox().alert(this.title,_T("common","commfail"));this.owner.updater.start();return}if(e.str){this.owner.getMsgBox().alert(this.title,e.str,function(){this.owner.setStatusBusy();this.owner.cleanMask=true;this.owner.updater.start()},this)}else{this.owner.updater.start()}},scope:this})},showFsckDialog:function(){if(!this.win){this.win=new SYNO.SDS.App.Ext4FsGoWrongApp.DiskScan({appInstance:{getUserSettings:function(){},setUserSettings:function(){}}});this.win.setTitle(_T("volume","volume_fsck_notification"))}this.win.show()},linkPoolElement:function(d,c){var b=this,a=new Ext.Element(c),f=a.getAttribute("space_id");b.appWin.selectPage("SYNO.SDS.StorageManager.Pool.Main");b.appWin.getActivePage().setFocus(f)},getButton:function(a){return this.getTopToolbar().getComponent(a)},enableButton:function(c,a){var b=this.getButton(c);return a?b.enable():b.disable()},disableButtons:function(){var b=this,a;Ext.each(arguments,function(c){a=b.getButton(c);a.disable()},b)}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreatePoolMain",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var d=this,c,b;d.isDataChanged=false;d.appWin=a.appWin;d.owner=a.owner;c=a.option;b={title:_T("volume","volume_raid_create_title"),cls:"sm-wizard-main",width:640,height:540,minHeight:540,minWidth:640,resizable:true,border:false,steps:[],isCreatePool:true};b.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskStep({free_disks:d.appWin.disks.getMatched("isNormalTray","isFree"),isSupportRaidCross:d.appWin.isSupportRaidCross(),isNeedSelectSource:!d.appWin.isSupportRaidCross()&&d.appWin.isSupportEbox()&&d.appWin.isEboxPluged(),isOneBay:1===d.appWin.getBayNumber(),itemId:"disk",nextId:"raid_type"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.RaidTypeStep({itemId:"raid_type",nextId:{shrstep:"shrstep",check:"check"}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.SingleDiskRaidTypeStep({appWin:d.appWin,isOneBay:d.appWin.isSingleBay(),itemId:"single_disk_raid_type",nextId:"check"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.ShrTypeStep({itemId:"shrstep",nextId:"check"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskCheckStep({getNext:function(){return this.nextId},itemId:"check",nextId:"edit_desc"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.EditDescriptionStep({itemId:"edit_desc",nextId:"summary"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.CreatePoolSummaryStep({itemId:"summary",nextId:null}));this.callParent([Ext.apply(b,a)])},getDiskIds:function(){if(this.inHistory("disk")){return this.getStep("disk").getIds()}else{throw Error("wrong flow control: get disk ids")}},getRaidType:function(){var a;if(this.inHistory("shrstep")){a=this.getStep("shrstep").getType()}else{if(this.inHistory("raid_type")||this.inHistory("single_disk_raid_type")){if(this.getStep("raid_type").getType()==="shr"){if(this.inHistory("shrstep")){a=this.getStep("shrstep").getType()}else{if(this.getDiskIds().length===1){a="shr_without_disk_protect"}else{a="shr_with_1_disk_protect"}}}else{a=this.getStep("raid_type").getType()}}else{a="basic"}}return a},getDescription:function(){return this.getStep("edit_desc").getDescription()},isPoolChild:function(){return true},applySettings:function(){var a={};a.disk_id=this.getDiskIds();a.device_type=this.getRaidType();a.is_disk_check=this.getStep("check").isChecked();a.is_pool_child=false;a.allocate_size="0";a.spare_disk_count="0";a.desc=this.getDescription();this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Pool",method:"create",version:1,params:a,callback:function(e,d,c,b){this.clearStatusBusy();if(!e){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(d);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));this.isDataChanged=true;this.close()},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreatePoolSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",disableNextInDemoMode:true,constructor:function(a){var b={headline:_T("volume","volume_wizard_summary_title")};b=Ext.apply(b,a);this.callParent([b])},activate:function(){this.callParent(arguments);this.owner.setStatusBusy();this.owner.getButton("next").disable();SYNO.API.Request({api:"SYNO.Storage.CGI.Pool",method:"estimate_size",version:1,params:{estimate_for:"create",disk_id:this.owner.getDiskIds(),device_type:this.owner.getRaidType()},callback:function(d,c,b,a){this.owner.clearStatusBusy();if(!d){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,c);this.owner.getButton("next").disable();return}if(!_S("demo_mode")){this.owner.getButton("next").enable()}this.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(c.size))},scope:this})},getNext:function(){this.owner.applySettings();return false},descRenderer:function(e,b,a,g,d,c){var f=e.toString().replace(/<.*?>/g,"");b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(f)+'"';return e}});Ext.define("SYNO.SDS.StorageManager.Wizard.DeletePool",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.isDataChanged=false;c.appWin=a.appWin;c.owner=a.owner;c.pool=a.poll;c.services=undefined;b={title:c.appWin.supportRaidGroup?_T("volume","volume_remove_raid_group"):_T("volume","volume_remove_raid_title"),width:640,height:350,resizable:false,layout:"fit",items:[{xtype:"syno_formpanel",itemId:"main",border:false,items:[{xtype:"syno_displayfield",value:"",id:c.descID=Ext.id(),itemId:"desc"},c.grid=new SYNO.SDS.Wizard.SummaryStep({layout:"fit",height:200})]}],buttons:[{xtype:"syno_button",btnStyle:"red",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","remove"),id:c.applyButtonID=Ext.id(),scope:c,handler:c.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){var c=this,a=c.grid.getStore(),e,d,b;c.callParent(arguments);if("single"===c.pool.get("raidType")&&c.pool.get("deploy_path")&&-1<c.pool.get("deploy_path").indexOf("iscsilun")){e=c.appWin.iscsiLuns.data[c.pool.get("deploy_path")];if(!e){return}a.append(_T("tree","leaf_raid"),c.pool.getName());a.append(_T("volume","volume_iscsitrg_lun"),e.get("iscsi_lun").name);if(c.appWin.supportSsdCache&&0<c.appWin.ssdCaches.count){Ext.each(c.appWin.ssdCaches.getAll(),function(f){if(-1<f.get("path").indexOf(e.get("iscsi_lun").name)){a.append(_T("volume","ssd_cache"),_T("volume","ssd_cache")+"("+e.get("iscsi_lun").name+")");return false}},c)}return}if("single"===c.pool.get("raidType")&&c.pool.get("deploy_path")){b="SYNO.Storage.CGI.Volume";d={space_id:[c.pool.get("deploy_path")]}}else{b="SYNO.Storage.CGI.Pool";d={space_id:c.pool.get("id")}}c.setStatusBusy();SYNO.API.Request({api:b,method:"enum_resource",version:1,params:d,callback:function(i,h,g,f){c.clearStatusBusy();if(!i){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,h);return}c.loadData(h,g)},scope:c})},loadData:function(f,e){var j=this,i,l=SYNO.SDS.StorageUtils,k,m={},d={},g=[],h,a=l.CheckFailedMsg(f.check),c=false,b=function(o){var n=true;if("single"===j.pool.get("raidType")&&j.pool.get("deploy_path")){o.space_id.each(function(p){if("crashed"!==j.owner.volumes.data[p].get("status")){n=false;return false}});if(n){Ext.getCmp(j.applyButtonID).enable();Ext.getCmp(j.descID).setValue(_T("volume","del_soft_check_fail"))}}else{if("crashed"===j.owner.storagePools.data[o.space_id].get("status")){Ext.getCmp(j.applyButtonID).enable();Ext.getCmp(j.descID).setValue(_T("volume","del_soft_check_fail"))}}};i=j.grid.getStore();i.append(j.appWin.supportRaidGroup?_T("volume","volume_storage_pool"):_T("volume","volume_pool"),j.pool.getName());if("hard_failed"===a){c=true;Ext.getCmp(j.applyButtonID).disable();Ext.getCmp(j.descID).setValue(_T("volume","del_hard_check_fail"));b(e)}else{if("soft_failed"===a){Ext.getCmp(j.descID).setValue(_T("volume","del_soft_check_fail"))}else{Ext.getCmp(j.descID).setValue(_T("volume","volume_delete_summary_desc"))}}if("single"===j.pool.get("raidType")&&j.pool.get("deploy_path")){k=l.SpaceIDParser(j.pool.get("deploy_path")).str;i.append(_T("volume","volume"),k);l.CheckMsg(f.check,c,"volumes",i);if(j.appWin.supportSsdCache&&0<j.appWin.ssdCaches.count){Ext.each(j.appWin.ssdCaches.getAll(),function(n){if(-1<n.get("path").indexOf(j.pool.get("deploy_path").replace("_",""))){i.append(_T("volume","ssd_cache"),_T("volume","ssd_cache")+"("+k+")");return false}},j)}}if(f.services&&f.services.length>0){i.append(_T("volume","volume_warninglistservice"),l.getServiceNames(f.services))}if(f.shares&&f.shares.length>0){i.append(_T("volume","volume_status_warningdelinfo"),l.getNamesString(f.shares));l.CheckMsg(f.check,c,"shares",i)}if(f.iscsiluns&&f.iscsiluns.length>0){i.append(_T("volume","volume_iscsitrg_lun"),l.getNamesString(f.iscsiluns));l.CheckMsg(f.check,c,"iscsiluns",i)}if(f.volumes&&f.volumes.length>0){i.append(_T("volume","volume"),l.getVolumeNames(f.volumes));l.CheckMsg(f.check,c,"volumes",i)}if(f.pkgs&&f.pkgs.length>0){i.append(_T("pkgmgr","title_packages"),l.getNamesString(f.pkgs))}j.services=f.services;if(!j.appWin.supportSsdCache){return}Ext.each(f.volumes,function(n){m[n.name]=true});Ext.each(f.iscsiluns,function(n){d[n.name]=true});Ext.each(j.appWin.ssdCaches.getAll(),function(n){h=n.get("mountSpaceId");if(m[h]){g.push(String.format("{0}({1})",l.SpaceIDParser(n.get("id")).str,l.SpaceIDParser(h).str))}if(d[l.SpaceIDParser(h).num]){g.push(String.format("{0}({1})",l.SpaceIDParser(n.get("id")).str,l.SpaceIDParser(h).num))}},j);if(0<g.length){i.append(_T("volume","ssd_cache"),g.join(", "))}},onSave:function(){var b=this,c,a,f,e;if("single"===b.pool.get("raidType")&&b.pool.get("deploy_path")&&-1<b.pool.get("deploy_path").indexOf("iscsilun")){var d=b.appWin.iscsiLuns.getById(b.pool.get("deploy_path"));a="SYNO.Storage.CGI.Pool";f="remove_lun";c={lid:[d.get("iscsi_lun").lid]}}else{if("single"===b.pool.get("raidType")&&b.pool.get("deploy_path")){a="SYNO.Storage.CGI.Volume";f="delete";c={delete_space:true,space_id:[b.pool.get("deploy_path")]}}else{a="SYNO.Storage.CGI.Pool";f="delete";c={space_id:b.pool.get("id")}}}e='1. <font class="red-status">'+_T("volume","volume_delete_warning")+"</font><br/>2. "+_T("volume","volume_all_service_stop");b.getMsgBox().confirm(_T("tree","leaf_volume"),e,function(g){if("yes"===g){SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(b,b.applySettings,[a,f,c])}},b)},onCancel:function(){this.close()},applySettings:function(a,c,b){this.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:a,method:c,version:1,params:b,callback:function(g,f,e,d){this.clearStatusBusy();if(!g){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);return}this.disableServices(this.services);this.isDataChanged=true;this.close()},scope:this})},disableServices:function(a){var b={media:undefined,audio:"SYNO.SDS.AudioStation.Application",itunes:undefined,photo:"SYNO.SDS.PhotoStation",web:"SYNO.SDS.WebStation",netbkp:undefined,download:"SYNO.SDS.DownloadStation",mysql:undefined,surveillance:"SYNO.SDS.SurveillanceStation",userhome:undefined,weblocal:undefined};Ext.each(a,function(c){if(Ext.isString(b[c])){SYNO.SDS.StatusNotifier.setServiceDisabled(b[c],true)}})}});Ext.namespace("SYNO.SDS.StorageManager.StoragePool");SYNO.SDS.StorageManager.StoragePool.MaxDiskCount=parseInt(_D("maxdisksperraid","12"),10);SYNO.SDS.StorageManager.StoragePool.RaidLevelDesc={raid1:{min:2,max:4,raidGroup:false},raid5:{min:3,max:65536,raidGroup:true},raid6:{min:4,max:65536,raidGroup:true},raid10:{min:4,max:65536,raidGroup:false},raid0:{min:2,max:65536,raidGroup:false},basic:{min:1,max:1,raidGroup:false},raidlinear:{min:2,max:65536,raidGroup:false}};Ext.define("SYNO.SDS.StorageManager.Wizard.AdvCreatePoolMain",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var c=this,b;c.isDataChanged=false;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("volume","volume_raid_creation_title"),width:700,height:520,minHeight:475,minWidth:700,resizable:true,border:false,steps:[]};b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvPoolTypeStep({appWin:c.appWin,itemId:"raidType",nextId:"property"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvPoolPropertyStep({appWin:c.appWin,itemId:"property",nextId:"advDisk"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvDiskStep({appWin:c.appWin,disks:a.disks,raidType:a.raidType,raidLevel:a.raidLevel,hddType:a.hddType,itemId:"advDisk",nextId:"diskCheck"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskCheckStep({appWin:c.appWin,itemId:"diskCheck",nextId:"summary",getNext:function(){return this.nextId}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvCreatePoolSummaryStep({appWin:c.appWin,itemId:"summary",nextId:null}));c.callParent([Ext.apply(b,a)])},getRaidType:function(){return this.getStep("raidType").getForm().getValues().RaidType},getDesc:function(){return this.getStep("property").getForm().findField("desc").getValue()},getRaidLevel:function(){return this.getStep("property").getForm().findField("level").getValue()},getRaidLimitNum:function(){if(this.inHistory("property")){return this.getStep("property").getComponent("limitNum").getValue()}return undefined},getHddType:function(){return this.getStep("property").getForm().findField("hddType").getValue()},getProperty:function(){var a={};a.desc=this.getStep("property").getForm().findField("desc").getValue();a.raidLevel=this.getRaidLevel();a.hddType=this.getHddType();return a},getDiskIds:function(){return this.getStep("advDisk").getDiskIds()},getDiskGroups:function(){return this.getStep("advDisk").getDiskGroups()},doCheck:function(){return this.getStep("diskCheck").getForm().getValues().check},applySettings:function(){var a={};a.disk_id=this.getDiskIds();a.device_type=this.getRaidLevel();a.is_disk_check="yes"===this.getStep("diskCheck").getForm().getValues().check;a.is_pool_child=false;a.allocate_size="0";a.spare_disk_count="0";a.desc=this.getDesc();a.is_unused="single"===this.getStep("raidType").getForm().getValues().RaidType;a.diskGroups=this.getDiskGroups();a.limitNum=this.getRaidLimitNum().toString();if(1>=a.diskGroups.length){delete a.diskGroups}this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Pool",method:"create",version:1,params:a,callback:function(f,e,d,b){var c="";if(!f){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(e);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,e);this.clearStatusBusy();return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));this.isDataChanged=true;c=String.format(_T("volume","volume_create_vol_lun_hint"),_T("volume","volume_storage_pool"));this.owner.getMsgBox().alert(this.owner.title,c);this.clearStatusBusy();this.close()},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvPoolTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.setDefault=true;c.appWin=a.appWin;b={headline:_T("volume","volume_raid_purpose_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_raid_for_single_volume"),name:"RaidType",itemId:"singleVolume",inputValue:"single"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_raid_for_single_volume_desc")},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_radio",boxLabel:_T("volume","volume_raid_for_multiple_volumes"),name:"RaidType",itemId:"multiple",inputValue:"multiple"},{xtype:"syno_displayfield",indent:1,value:_T("volume","volume_raid_for_multiple_volumes_desc")}]};c.callParent([Ext.apply(b,a)])},getNext:function(){return this.nextId},activate:function(){if(!this.setDefault){return}this.getComponent("singleVolume").setValue(true);this.setDefault=false},summary:function(a){var b="single"===this.getForm().getValues().RaidType?_T("common","no"):_T("common","yes");a.append(_T("volume","volume_multiple_vol_lun_support"),b)}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvPoolPropertyStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.setDefault=true;c.setDefaultDesc=true;c.appWin=a.appWin;c.tabList=[];c.currentRaidType="";c.tabList.push(["SAS","SAS"]);if("no"===_D("support_dual_head","no")){c.tabList.push(["SATA","SATA"])}b={headline:_T("volume","volume_raid_property"),labelWidth:250,items:[{xtype:"syno_textfield",itemId:"desc",name:"desc",fieldLabel:_T("share","share_comment"),maxLength:64,enableKeyEvents:true,value:String.format("{0}: {1}",_T("volume","volume_raid_title"),SYNO.SDS.StorageUtils.RaidLevelRender("raid_1")),listeners:{keypress:function(){this.setDefaultDesc=false},scope:this}},{xtype:"syno_combobox",name:"level",itemId:"level",hiddenName:"level",store:new Ext.data.ArrayStore({data:[["RAID 1","raid_1"],["RAID 5","raid_5"],["RAID 6","raid_6"],["RAID 10","raid_10"],["Basic","basic"],["JBOD","raid_linear"],["RAID 0","raid_0"]],id:"value",fields:["text","value"]}),fieldLabel:_T("volume","volume_raid_title"),displayField:"text",valueField:"value",forceSelection:true,mode:"local",allowBlank:false,listeners:{select:this.onRaidLevelChanged,scope:this}},{xtype:"syno_combobox",name:"hddType",itemId:"hddType",hiddenName:"hddType",store:new Ext.data.ArrayStore({data:c.tabList,id:"value",fields:["text","value"]}),fieldLabel:_T("volume","volume_hdd_type"),displayField:"text",valueField:"value",forceSelection:true,mode:"local",allowBlank:false,hidden:!c.appWin.supportSas||("yes"===_D("support_dual_head","no"))},{xtype:"syno_combobox",name:"limitNum",itemId:"limitNum",hiddenName:"limitNum",hiddenValue:0,store:new Ext.data.ArrayStore({data:[["6",6],["12",12],["24",24]],id:"value",fields:["text","value"]}),fieldLabel:_T("volume","limit_raid_disk_number"),displayField:"text",valueField:"value",mode:"local",allowBlank:false,listeners:{select:this.onLimitedChanged,scope:this}},{xtype:"syno_displayfield",itemId:"minMaxDiskNum",fieldLabel:_T("volume","volume_min_max_disk_number"),value:"3/12"}]};c.callParent([Ext.apply(b,a)])},onRaidLevelChanged:function(d,e,b){var a=d.getValue();var c=this.getComponent("limitNum");if("basic"===a||"raid_1"===a){c.hide();c.setValue(12)}else{c.show()}this.changeDesc()},onLimitedChanged:function(b,c,a){this.changeDesc()},changeDesc:function(){var b=this;var e=b.getComponent("level").getValue();var a=e.replace("_","");var c=SYNO.SDS.StorageManager.StoragePool.RaidLevelDesc[a];var d;if("basic"===a||"raid1"===a){d=c.max}else{d=b.getComponent("limitNum").getValue()}this.getComponent("minMaxDiskNum").setValue(String.format("{0}/{1}",c.min,d));if(this.setDefaultDesc){this.getComponent("desc").setValue(SYNO.SDS.StorageUtils.RaidLevelRender(e))}},getNext:function(){if(!this.getForm().isValid()){return false}return this.nextId},getRaidLevel:function(){return this.getForm().findField("level").getValue()},activate:function(){var b=this;var a=b.owner.getStep("raidType").getForm().getValues().RaidType;if(b.currentRaidType!==a){b.getComponent("level").setValue("raid_5");b.getComponent("limitNum").setValue(12);b.getComponent("limitNum").show("no");if(b.appWin.supportSas){b.getComponent("hddType").setValue("SAS")}else{b.getComponent("hddType").setValue("SATA")}b.currentRaidType=a}b.changeDesc()},summary:function(d){var c=this;var b=c.getRaidLevel();var a=c.getComponent("limitNum").getValue();d.append(_T("share","share_comment"),c.getForm().findField("desc").getValue());if(b.substr(0,3)!=="shr"){d.append(_T("volume","volume_raid_title"),SYNO.SDS.StorageUtils.DeviceTypeRender(b))}else{d.append(_T("volume","volume_raid_title"),SYNO.SDS.StorageUtils.SpaceTypeRender(b))}if(c.appWin.supportSas){d.append(_T("volume","volume_hdd_type"),c.getForm().findField("hddType").getValue())}if("basic"!==b&&"raid_1"!==b){d.append(_T("volume","limit_raid_disk_number"),a)}}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvDiskStep",{extend:"Ext.Panel",constructor:function(a){this.subgroupName=undefined;this.freeDisksPanel=undefined;this.raidDisksPanel=undefined;this.ctrlHold=false;this.shiftHold=false;this.proxy=undefined;this.moving=false;this.lastClickedA=undefined;this.lastClickedS=undefined;this.minSize=0;this.minSizeRequiredDisks=0;this.mode=a.mode||"create";this.disks=a.disks;this.pool=a.pool;this.raidType=a.raidType;this.raidLevel=a.raidLevel;this.raidLimitNum=a.raidLimitNum;this.hddType=a.hddType;this.requiredDiskForSHR=a.repair||0;this.initFreeDiskPanel();this.initRaidDiskPanel();var b={headline:_T("volume","volume_add_diskselect"),description:_T("volume","volume_select_disk_desc"),layout:{type:"hbox",align:"stretch"},bwrapCfg:{cls:"x-panel-bwrap",style:{padding:"8px 20px 4px 20px"}},items:[this.freeDisksPanel,this.raidDisksPanel]};Ext.apply(b,a);this.callParent([b])},initEvents:function(){this.callParent(arguments);this.bindKeyboardEvents();this.mon(this.freeDisksPanel.view.getStore(),"load",this.setMask,this)},setMask:function(){if(0===this.freeDisksPanel.view.getStore().getCount()){this.freeDisksPanel.body.mask(_T("volume","volume_no_available_disks"),"syno-ux-mask-info")}else{this.freeDisksPanel.body.unmask()}},bindKeyboardEvents:function(){var a=this;var b=Ext.getDoc();a.mon(b,"keydown",function(d,c){switch(d.getKey()){case d.CONTROL:this.ctrlHold=true;break;case d.SHIFT:this.shiftHold=true;break;default:return}},a);a.mon(b,"keyup",function(d,c){switch(d.getKey()){case d.CONTROL:this.ctrlHold=false;break;case d.SHIFT:this.shiftHold=false;break;default:return}},a)},initFreeDiskPanel:function(){var b={tpl:this.getFreeDiskTpl(),layout:"fit",store:new Ext.data.JsonStore({autoDestroy:true,root:"containers",fields:["id","name","disks"],listeners:{load:function(){if(Ext.get("freeDisksPanel")){var c=Ext.get("freeDisksPanel").query(".selectable");Ext.each(c,function(h,e,g){var f=new Ext.Element(h);if(f.hasClass("toggle")||f.hasClass("hostname")){return true}this.mon(f,"mousedown",this.onMouseDown,this)},this);var d=Ext.get("freeDisksPanel").query(".toggle");Ext.each(d,function(h,e,g){var f=new Ext.Element(h);this.mon(f,"mousedown",function(k,j){k.stopEvent();var i=new Ext.Element(j);i.parent("div",false).next("ul",false).setVisibilityMode(Ext.Element.DISPLAY);i.parent("div",false).next("ul",false).toggle();i.toggleClass("sds-space-toggle-collapse")},this)},this)}this.doLayout()},scope:this}})};var a=new Ext.DataView(b);this.freeDisksPanel=new Ext.Panel({id:"freeDisksPanel",bodyStyle:{"border-top":"0","border-left":"0","border-bottom":"0","border-right":"1px solid #C8D2Dc"},view:a,flex:48,autoFlexcroll:true,items:a})},getFreeDiskTpl:function(){var a=new Ext.XTemplate("<ul>",'<tpl for=".">','<li class="enclosure sds-space-disk-li">','<div class="sds-space-disk-container owner selectable" side="available" type="enclosure" devId="{id}">','<div class="toggle sds-space-toggle nonselectable"></div>','<span class="hostname">{name}</span>',"</div>","<ul>",'<tpl for="disks">','<li class="sds-space-disk-li">','<div class="sds-space-disk disk selectable" side="available" diskType="{diskType}" owner="{owner}" container="{owner}" size_total="{size_total}" devId="{id}">{shortName} - {diskType} / {driveType} {size} {display4Kn}</div>',"</li>","</tpl>","</ul>","</li>","</tpl>","</ul>");a.compile();return a},initRaidDiskPanel:function(){var b={tpl:this.getRaidDiskTpl(),layout:"fit",store:new Ext.data.JsonStore({autoDestroy:true,root:"raids",fields:["id","disks"],listeners:{load:function(){if(Ext.get("raidDisksPanel")){var c=Ext.get("raidDisksPanel").query(".selectable");Ext.each(c,function(h,e,g){var f=new Ext.Element(h);if(!h.getAttribute("used_by")){this.mon(f,"mousedown",this.onMouseDown,this)}},this);var d=Ext.get("raidDisksPanel").query(".sds-space-disk-remove-icon");Ext.each(d,function(h,e,g){var f=new Ext.Element(h);if(!h.getAttribute("used_by")){this.mon(f,"click",function(j,l,k){var i=[];i.push({dom:l.parentNode});this.dropToAvailable(i)},this)}},this)}this.doLayout()},scope:this}})};var a=new Ext.DataView(b);this.raidDisksPanel=new Ext.Panel({id:"raidDisksPanel",border:false,bodyStyle:{"padding-left":"10px"},view:a,flex:52,autoFlexcroll:true,items:a})},getRaidDiskTpl:function(){var a=new Ext.XTemplate("<ul>",'<tpl for=".">','<li class="sds-space-disk-li">','<div devId="id" class="sds-space-raid owner nonselectable" used_by="{id}">{id}</div>',"<ul>",'<tpl for="disks">','<tpl if="dummy == true">','<li><div class="sds-space-dummy dummy {cls}" used_by="dummy" minSize="{minSize}" raidNum="{raidNum}">','<tpl if="required == true">',_T("volume","volume_required_disk"),"</tpl>",'<tpl if="required == false">',_T("volume","volume_additional_disk"),"</tpl>","</div></li>","</tpl>",'<tpl if="dummy == false">','<li class="sds-space-disk-li">','<div class="sds-space-disk-choosed disk {cls}" diskType="{diskType}" side="pool" owner="{parent.id}" container="{owner}" devId="{id}" size_total="{size_total}" used_by="{used_by}" raidNum="{raidNum}">{shortName} - {diskType} / {driveType} {size} {display4Kn}',"<tpl if=\"cls == 'selectable'\">",'<div class="sds-space-disk-remove-icon"></div>',"</tpl>","</div>","</li>","</tpl>","</tpl>","</ul>","</li>","</tpl>","</ul>");a.compile();return a},onMouseDown:function(d,c){var a=new Ext.Element(c);if(a.hasClass("hostname")){a=a.parent();c=a.dom}if("available"===c.getAttribute("side")){this.lastClickA=a}else{this.lastClickS=a}this.lastClick=a;d.stopEvent();this.checkSelection(c);var b=this;b.lastPos=d.getXY();var f=setTimeout(function(){var e=Ext.getDoc();b.mon(e,"mousemove",b.onMouseMove,b);b.mon(e,"mouseup",b.onMouseUp,b)},50);this.mon(a,"mouseup",function(){clearTimeout(f)},this,{single:true})},checkSelection:function(e){var c=new Ext.Element(e);var a,b;if("available"===e.getAttribute("side")){a=Ext.get("freeDisksPanel");b="lastClickedA"}else{a=Ext.get("raidDisksPanel");b="lastClickedS"}if(!this.ctrlHold&&!this.shiftHold&&!c.hasClass("sds-pool-create-device-selected")){Ext.each(a.query(".sds-pool-create-device-selected"),function(){var g=new Ext.Element(this);g.removeClass("sds-pool-create-device-selected")});c.addClass("sds-pool-create-device-selected")}if(this.shiftHold){if(null===this[b]){c.addClass("sds-pool-create-device-selected")}else{Ext.each(a.query(".sds-pool-create-device-selected"),function(){var g=new Ext.Element(this);g.removeClass("sds-pool-create-device-selected")});var d=this[b].getXY()[1]<c.getXY()[1]?this[b].getXY()[1]:c.getXY()[1];var f=this[b].getXY()[1]>c.getXY()[1]?this[b].getXY()[1]:c.getXY()[1];Ext.each(a.query(".selectable"),function(){var g=new Ext.Element(this);if(g.getXY()[1]>=d&&g.getXY()[1]<=f&&!g.hasClass("nonselectable")){g.addClass("sds-pool-create-device-selected")}})}}else{if(this.ctrlHold){c.toggleClass("sds-pool-create-device-selected")}}this[b]=c},onMouseMove:function(f,d){var b=new Ext.Element(d);var c=f.getXY(),a,h,g;if(b.hasClass("hostname")){b=b.parent();d=b.dom}if(this.lastPos){a=Math.pow(this.lastPos[0]-c[0],2);h=Math.pow(this.lastPos[1]-c[1],2);g=Math.sqrt(a+h)}if(g>15&&!this.proxy){this.moved=true;this.createDragProxy(d)}if(this.proxy){c[0]+=5;c[1]+=5;this.proxy.setXY(c);this.proxy.setStyle({position:"absolute","z-index":"100000",width:"200px"})}if(this.dropHint&&this.dropHint.hasClass("sds-space-dummy-disk-hover")){this.dropHint.removeClass("sds-space-dummy-disk-hover")}if(this.isInDropZone(f,"raidDisks")){Ext.each(Ext.get("raidDisksPanel").query("div"),function(i){var e=new Ext.Element(i);if(e.hasClass("dummy")&&f.getXY()[1]>=e.getXY()[1]&&f.getXY()[1]<=e.getXY()[1]+e.getHeight()){this.dropHint=e;if(!e.hasClass("sds-space-dummy-disk-hover")){e.addClass("sds-space-dummy-disk-hover")}this.dropPos="";return false}if((f.getXY()[1]>=e.getXY()[1])&&(f.getXY()[1]<e.getXY()[1]+e.getHeight()/2)&&!e.hasClass("dummy")&&e.hasClass("selectable")){this.dropHint=e;if(!e.hasClass("sds-space-dummy-disk-hover")){e.addClass("sds-space-dummy-disk-hover")}this.dropPos="top";return false}if((f.getXY()[1]>=e.getXY()[1]+e.getHeight()/2)&&(f.getXY()[1]<e.getXY()[1]+e.getHeight())&&!e.hasClass("dummy")&&e.hasClass("selectable")){this.dropHint=e;if(!e.hasClass("sds-space-dummy-disk-hover")){e.addClass("sds-space-dummy-disk-hover")}this.dropPos="bottom";return false}delete this.dropHint;delete this.dropPos;e.removeClass("sds-space-dummy-disk-hover")},this)}else{delete this.dropHint;delete this.dropPos}},createDropHint:function(a){if(!this.dropHintProxy){this.dropHintProxy=new Ext.Element(Ext.DomHelper.createDom({tag:"div",html:">"}));Ext.getBody().appendChild(this.dropHintProxy)}this.dropHintProxy.setStyle({position:"absolute","z-index":"100000",width:"20px",height:"20px"});this.dropHintProxy.setXY(a)},createDragProxy:function(f){var e;var b;e=new Ext.Element(f);if("available"===f.getAttribute("side")){b=Ext.get("freeDisksPanel")}else{b=Ext.get("raidDisksPanel")}var d=[],a=[],c={};Ext.each(b.query(".sds-pool-create-device-selected"),function(){var g=new Ext.Element(this);if(g.hasClass("owner")){c[this.getAttribute("devId")]=true;d.push(g)}else{if(!c[this.getAttribute("owner")]){a.push(g)}}});d=d.concat(a);d.sort(function(h,g){if(h.getXY()[1]>g.getXY()[1]){return 1}if(h.getXY()[1]<g.getXY()[1]){return -1}return 0});this.proxy=new Ext.Element(Ext.DomHelper.createDom({tag:"div"}));Ext.each(d,function(h){var g=h.parent().dom.cloneNode(true);g.removeAttribute("id");this.proxy.appendChild(g)},this);this.proxy.setStyle({position:"absolute","z-index":"100000",width:"200px"});Ext.getBody().appendChild(this.proxy)},onMouseUp:function(f,d){var a,b=new Ext.Element(d);if(b.hasClass("hostname")){b=b.parent();d=b.dom}if("available"===d.getAttribute("side")){a=Ext.get("freeDisksPanel")}else{a=Ext.get("raidDisksPanel")}if(!this.ctrlHold&&!this.shiftHold&&!this.moved){Ext.each(a.query(".sds-pool-create-device-selected"),function(){var e=new Ext.Element(this);e.removeClass("sds-pool-create-device-selected")});b.addClass("sds-pool-create-device-selected")}if(this.proxy){this.proxy.remove();this.proxy=null}if(this.dropHintProxy){this.dropHintProxy.remove();delete this.dropHintProxy}var c=Ext.getDoc();this.mun(c,"mousemove",this.onMouseMove,this);this.mun(c,"mouseup",this.onMouseUp,this);this.dropSelections(f,d);delete this.lastPos},dropSelections:function(f,d){var c=this.lastClick;var b,a;if("available"===c.dom.getAttribute("side")){b=Ext.get("freeDisksPanel");if(this.isInDropZone(f,"raidDisks")){a=this.getSelectedDisks(b);if(this.dropHint){switch(this.dropPos){case"":this.dropOnDummyAToS(a);break;case"top":this.dropOnTopAToS(a);break;case"bottom":this.dropOnBottomAToS(a);break}}else{if(("raid_5"===this.raidLevel||"raid_6"===this.raidLevel)&&"multiple"===this.owner.getRaidType()){this.dropToTheEndAToSMulti(a)}else{this.dropToTheEndAToS(a)}}}}else{b=Ext.get("raidDisksPanel");a=this.getSelectedDisks(b);if(this.isInDropZone(f,"freeDisks")){this.dropToAvailable(a)}else{if(this.moved){switch(this.dropPos){case"":this.dropOnDummySToS(a);break;case"top":this.dropOnTopSToS(a);break;case"bottom":this.dropOnBottomSToS(a);break}}}}if((("raid_5"===this.raidLevel||"raid_6"===this.raidLevel)&&"multiple"===this.owner.getRaidType())&&"migrate"!==this.owner.add_type){this.checkAddNewDummyRaid()}this.moved=false},dropToTheEndAToSMulti:function(g){if("repair"===this.owner.add_type){return}var b,a,d,e=false,f=0,c;Ext.each(this.RaidDisksData.raids,function(j){var h,k;var l=0,i;if(this.pool&&f<=this.pool.json.raids.length-1){i=this.pool.json.raids[f];l=parseInt(this.pool.json.raids[f].minDevSize,10)}b=this.maxDisks;a=[];Ext.each(j.disks,function(m){if(!m.dummy){a.push(m);--b}},this);c=[];for(d=0;d<g.length;++d){h=g[d].dom.getAttribute("devId");k=this.appWin.disks.data[h];if(k.get("size_total")>=l&&0<b){g[d]=null;this.freeDisks[h].available=false;a.push(this.createDisk(k,f,false,false,true));--b}else{c.push(g[d])}}g=c;e=this.fillDummyDisks(a,f,i);delete j.disks;j.disks=a;++f},this);if(!e&&0<g.length){this.fillOthers(g)}this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},fillDummyDisks:function(a,e,d){var c=false;var b,f=this.maxDisks-a.length;if(d&&"repair"===this.owner.add_type){b=parseInt(d.designedDiskCount,10)-a.length;f=b}else{if(d&&"expand_by_disk"===this.owner.add_type){b=parseInt(d.designedDiskCount,10)-a.length+1}else{if(d&&"migrate"===this.owner.add_type){if("raid_1"===this.raidLevel&&1===parseInt(d.designedDiskCount,10)){b=parseInt(d.designedDiskCount,10)-a.length+1}else{if(this.minDisks>parseInt(d.designedDiskCount,10)){b=this.minDisks-a.length}else{if("raid_1"===this.pool.json.device_type&&"raid_1"!==this.raidLevel){b=this.minDisks-a.length}else{b=parseInt(d.designedDiskCount,10)+1-a.length}}}}else{b=this.minDisks-a.length;if("raid_10"===this.raidLevel&&a.length>this.minDisks&&1===a.length%2){b=1}}}}c=0<f;while(0<f){a.push({raidNum:e,dummy:true,required:0<b,cls:0<b?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--f;--b}return c},fillOthers:function(d){if("migrate"===this.owner.add_type){return}var a;var c=0;var b=0;Ext.each(this.RaidDisksData.raids,function(i){var e=[];var g=false;Ext.each(i.disks,function(j){if(!j.dummy){e.push(j)}else{g=true;return false}},this);if(!g){++b;return true}a=this.maxDisks-e.length;if(this.pool){if(this.pool.json.raids&&this.pool.json.raids[b]){c=parseInt(this.pool.json.raids[b].minDevSize,10)}else{c=parseInt(this.pool.get("minimal_disk_size"),10)}}if("repair"===this.owner.add_type){var h=this.pool.json.raids[b];a=parseInt(h.designedDiskCount,10)-e.length}var f=[];Ext.each(d,function(l){var j=l.dom.getAttribute("devId");var k=this.appWin.disks.data[j];if(k.get("size_total")>=c&&0<a){this.freeDisks[j].available=false;e.push(this.createDisk(k,b,false,false,true));--a}else{f.push(l)}},this);d=f;if("repair"!==this.owner.add_type){this.fillDummyDisks(e,b,null)}delete i.disks;i.disks=e;if(0===d.length){return false}++b},this);if(0<d.length&&"repair"!==this.owner.add_type){this.fillNewRaid(d)}},fillNewRaid:function(g){var c=0,d,e,b,a,f;for(d=0;d<g.length;++d){if(0===c){e=this.RaidDisksData.raids.length;a=[];this.RaidDisksData.raids.push({disks:a,id:String.format(this.subgroupName,(e+1)),raidNum:e});c=this.maxDisks}b=g[d].dom.getAttribute("devId");f=this.appWin.disks.data[b];if(0<c){this.freeDisks[b].available=false;a.push(this.createDisk(f,e,false,false,true));--c}}a=this.RaidDisksData.raids[this.RaidDisksData.raids.length-1].disks;e=this.RaidDisksData.raids.length-1;this.fillDummyDisks(a,e,null)},dropToTheEndAToS:function(d){if("repair"===this.owner.add_type){return}var f=0===this.RaidDisksData.raids.length?0:this.RaidDisksData.raids.length-1;if(!this.RaidDisksData.raids[f]){return}var e=0;var i=f;if(this.pool){if(this.pool.json.raids&&this.pool.json.raids[i]){e=parseInt(this.pool.json.raids[i].minDevSize,10)}else{e=parseInt(this.pool.get("minimal_disk_size"),10)}}var g=[];Ext.each(this.RaidDisksData.raids[f].disks,function(j){if(!j.dummy){g.push(j)}},this);var b;var a;if(this.pool){a=this.pool.json.raids[i]}if(-1<this.raidLevel.indexOf("shr")){b=this.requiredDiskForSHR}else{if(a&&"repair"===this.owner.add_type){b=parseInt(a.designedDiskCount,10)-g.length}else{b=this.maxDisks-g.length}}Ext.each(d,function(l){var j=l.dom.getAttribute("devId");var k=this.appWin.disks.data[j];if(k.get("size_total")>=e&&0<b){this.freeDisks[j].available=false;g.push(this.createDisk(k,i,false,false,true));--b;--this.requiredDiskForSHR}},this);var c,h=this.maxDisks-g.length;if(-1<this.raidLevel.indexOf("shr")){c=this.requiredDiskForSHR;h=c}else{if(a&&"repair"===this.owner.add_type){c=parseInt(a.designedDiskCount,10)-g.length;h=c}else{if(a&&"expand_by_disk"===this.owner.add_type){c=parseInt(a.designedDiskCount,10)-g.length+1}else{if(a&&"migrate"===this.owner.add_type){if("raid_1"===this.raidLevel&&2===parseInt(a.designedDiskCount,10)){c=parseInt(a.designedDiskCount,10)-g.length+1}else{if(this.minDisks>parseInt(a.designedDiskCount,10)){c=this.minDisks-g.length}else{if("raid_1"===this.pool.json.device_type&&"raid_1"!==this.raidLevel){c=this.minDisks-g.length}else{c=parseInt(a.designedDiskCount,10)+1-g.length}}}}else{c=this.minDisks-g.length;if("raid_10"===this.raidLevel&&g.length>this.minDisks&&1===g.length%2){c=1}}}}}while(0<h){g.push({raidNum:i,dummy:true,required:0<c,cls:0<c?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--h;--c}delete this.RaidDisksData.raids[f].disks;this.RaidDisksData.raids[f].disks=g;this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},dropOnDummyAToS:function(g){var l=parseInt(this.dropHint.dom.getAttribute("raidNum"),10);var i=this.RaidDisksData.raids[l];var h=0;var c,d,k;if(this.pool){if(this.pool.json.raids&&this.pool.json.raids[l]){h=parseInt(this.pool.json.raids[l].minDevSize,10)}else{h=parseInt(this.pool.get("minimal_disk_size"),10)}}var j=[];Ext.each(i.disks,function(m){if(!m.dummy){j.push(m)}},this);var b;var a;if(this.pool&&this.pool.json.raids){a=this.pool.json.raids[l]}if(-1<this.raidLevel.indexOf("shr")){b=this.requiredDiskForSHR}else{if(a&&"repair"===this.owner.add_type){b=parseInt(a.designedDiskCount,10)-j.length}else{b=this.maxDisks-j.length}}var f=[];Ext.each(g,function(n){var m=n.dom.getAttribute("devId");c=this.appWin.disks.data[m];if(c.get("size_total")>=h&&0<b){this.freeDisks[m].available=false;j.push(this.createDisk(c,l,false,false,true));--b;--this.requiredDiskForSHR}else{f.push(n)}},this);g=f;k=this.maxDisks-j.length;if(-1<this.raidLevel.indexOf("shr")){d=this.requiredDiskForSHR;k=d}else{if(a&&"repair"===this.owner.add_type){d=parseInt(a.designedDiskCount,10)-j.length;k=d}else{if(a&&"expand_by_disk"===this.owner.add_type){d=parseInt(a.designedDiskCount,10)-j.length+1}else{if(a&&"migrate"===this.owner.add_type){if("raid_1"===this.raidLevel&&2===parseInt(a.designedDiskCount,10)){d=parseInt(a.designedDiskCount,10)-j.length+1}else{if(this.minDisks>parseInt(a.designedDiskCount,10)){d=this.minDisks-j.length}else{if("raid_1"===this.pool.json.device_type&&"raid_1"!==this.raidLevel){d=this.minDisks-j.length}else{d=parseInt(a.designedDiskCount,10)+1-j.length}}}}else{d=this.minDisks-j.length;if("raid_10"===this.raidLevel&&j.length>this.minDisks&&1===j.length%2){d=1}}}}}var e=0<k;while(0<k){j.push({raidNum:l,dummy:true,required:0<d,cls:0<d?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--k;--d}delete i.disks;i.disks=j;if(("raid_5"===this.raidLevel||"raid_6"===this.raidLevel)&&"multiple"===this.owner.getRaidType()){if(!e&&0<g.length){this.fillOthers(g)}}this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},dropOnTopAToS:function(j){var p=parseInt(this.dropHint.dom.getAttribute("raidNum"),10);var l=this.RaidDisksData.raids[p];var k=0;var d,e,o;if(this.pool){if(this.pool.json.raids&&this.pool.json.raids[p]){k=parseInt(this.pool.json.raids[p].minDevSize,10)}else{k=parseInt(this.pool.get("minimal_disk_size"),10)}}var n=[];Ext.each(l.disks,function(i){if(i&&!i.dummy){n.push(i)}},this);var b;var a;if(this.pool&&this.pool.json.raids){a=this.pool.json.raids[p]}if(-1<this.raidLevel.indexOf("shr")){b=this.requiredDiskForSHR}else{if(a&&"repair"===this.owner.add_type){b=parseInt(a.designedDiskCount,10)-n.length}else{b=this.maxDisks-n.length}}var m=[];var h=[];Ext.each(j,function(q){var i=q.dom.getAttribute("devId");d=this.appWin.disks.data[i];if(d.get("size_total")>=k&&0<b){this.freeDisks[i].available=false;m.push(this.createDisk(d,p,false,false,true));--b;--this.requiredDiskForSHR}else{h.push(q)}},this);j=h;var c=n;n=[];for(var g=0;g<c.length;++g){if(c[g].id===this.dropHint.dom.getAttribute("devId")){n=n.concat(m)}n.push(c[g])}o=this.maxDisks-n.length;if(-1<this.raidLevel.indexOf("shr")){e=this.requiredDiskForSHR;o=e}else{if(a&&"repair"===this.owner.add_type){e=parseInt(a.designedDiskCount,10)-n.length;o=e}else{if(a&&"expand_by_disk"===this.owner.add_type){e=parseInt(a.designedDiskCount,10)-n.length+1}else{if(a&&"migrate"===this.owner.add_type){if("raid_1"===this.raidLevel&&2===parseInt(a.designedDiskCount,10)){e=parseInt(a.designedDiskCount,10)-n.length+1}else{if(this.minDisks>parseInt(a.designedDiskCount,10)){e=this.minDisks-n.length}else{if("raid_1"===this.pool.json.device_type&&"raid_1"!==this.raidLevel){e=this.minDisks-n.length}else{e=parseInt(a.designedDiskCount,10)+1-n.length}}}}else{e=this.minDisks-n.length;if("raid_10"===this.raidLevel&&n.length>this.minDisks&&1===n.length%2){e=1}}}}}var f=0<o;while(0<o){n.push({raidNum:p,dummy:true,required:0<e,cls:0<e?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--o;--e}delete l.disks;l.disks=n;if(("raid_5"===this.raidLevel||"raid_6"===this.raidLevel)&&"multiple"===this.owner.getRaidType()){if(!f&&0<j.length){this.fillOthers(j)}}this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},dropOnBottomAToS:function(j){var p=parseInt(this.dropHint.dom.getAttribute("raidNum"),10);var l=this.RaidDisksData.raids[p];var k=0;var d,e,o;if(this.pool){if(this.pool.json.raids&&this.pool.json.raids[p]){k=parseInt(this.pool.json.raids[p].minDevSize,10)}else{k=parseInt(this.pool.get("minimal_disk_size"),10)}}var n=[];Ext.each(l.disks,function(i){if(i&&!i.dummy){n.push(i)}},this);var b;var a;if(this.pool&&this.pool.json.raids){a=this.pool.json.raids[p]}if(-1<this.raidLevel.indexOf("shr")){b=this.requiredDiskForSHR}else{if(a&&"repair"===this.owner.add_type){b=parseInt(a.designedDiskCount,10)-n.length}else{b=this.maxDisks-n.length}}var m=[],h=[];Ext.each(j,function(q){var i=q.dom.getAttribute("devId");d=this.appWin.disks.data[i];if(d.get("size_total")>=k&&0<b){this.freeDisks[i].available=false;m.push(this.createDisk(d,p,false,false,true));--b;--this.requiredDiskForSHR}else{h.push(q)}},this);j=h;var c=n;n=[];for(var g=0;g<c.length;++g){n.push(c[g]);if(c[g].id===this.dropHint.dom.getAttribute("devId")){n=n.concat(m)}}o=this.maxDisks-n.length;if(-1<this.raidLevel.indexOf("shr")){e=this.requiredDiskForSHR;o=e}else{if(a&&"repair"===this.owner.add_type){e=parseInt(a.designedDiskCount,10)-n.length;o=e}else{if(a&&"expand_by_disk"===this.owner.add_type){e=parseInt(a.designedDiskCount,10)-n.length+1}else{if(a&&"migrate"===this.owner.add_type){if("raid_1"===this.raidLevel&&2===parseInt(a.designedDiskCount,10)){e=parseInt(a.designedDiskCount,10)-n.length+1}else{if(this.minDisks>parseInt(a.designedDiskCount,10)){e=this.minDisks-n.length}else{if("raid_1"===this.pool.json.device_type&&"raid_1"!==this.raidLevel){e=this.minDisks-n.length}else{e=parseInt(a.designedDiskCount,10)+1-n.length}}}}else{e=this.minDisks-n.length;if("raid_10"===this.raidLevel&&n.length>this.minDisks&&1===n.length%2){e=1}}}}}var f=0<o;while(0<o){n.push({raidNum:p,dummy:true,required:0<e,cls:0<e?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--o;--e}delete l.disks;l.disks=n;if(("raid_5"===this.raidLevel||"raid_6"===this.raidLevel)&&"multiple"===this.owner.getRaidType()){if(!f&&0<j.length){this.fillOthers(j)}}this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},dropToAvailable:function(b){var a;Ext.each(b,function(f){var c=f.dom.getAttribute("devId");a=parseInt(f.dom.getAttribute("raidNum"),10);for(var e=0;e<this.RaidDisksData.raids[a].disks.length;++e){if(this.RaidDisksData.raids[a].disks[e]&&this.RaidDisksData.raids[a].disks[e].id===c){this.RaidDisksData.raids[a].disks[e]=null;break}}this.freeDisks[c].available=true},this);this.requiredDiskForSHR+=b.length;a=0;Ext.each(this.RaidDisksData.raids,function(f){var c=[];Ext.each(f.disks,function(h){if(h&&!h.dummy){c.push(h)}},this);var d,g;var e;if(this.pool&&this.pool.json.raids){e=this.pool.json.raids[a]}g=this.maxDisks-c.length;if(-1<this.raidLevel.indexOf("shr")){d=this.requiredDiskForSHR;g=d}else{if(e&&"repair"===this.owner.add_type){d=parseInt(e.designedDiskCount,10)-c.length;g=d}else{if(e&&"expand_by_disk"===this.owner.add_type){d=parseInt(e.designedDiskCount,10)-c.length+1}else{if(e&&"migrate"===this.owner.add_type){if("raid_1"===this.raidLevel&&2===parseInt(e.designedDiskCount,10)){d=parseInt(e.designedDiskCount,10)-c.length+1}else{if(this.minDisks>parseInt(e.designedDiskCount,10)){d=this.minDisks-c.length}else{if("raid_1"===this.pool.json.device_type&&"raid_1"!==this.raidLevel){d=this.minDisks-c.length}else{d=parseInt(e.designedDiskCount,10)+1-c.length}}}}else{d=this.minDisks-c.length;if("raid_10"===this.raidLevel&&c.length>this.minDisks&&1===c.length%2){d=1}}}}}while(0<g){c.push({raidNum:a,dummy:true,required:0<d,cls:0<d?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--g;--d}delete f.disks;f.disks=c;++a},this);this.checkLastRAID();this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},dropOnDummySToS:function(f){var l=parseInt(this.dropHint.dom.getAttribute("raidNum"),10);var h=this.RaidDisksData.raids[l];var g=0;var c,d,k;if(this.pool){if(this.pool.json.raids&&this.pool.json.raids[l]){g=parseInt(this.pool.json.raids[l].minDevSize,10)}else{g=parseInt(this.pool.get("minimal_disk_size"),10)}}var b;var a;if(this.pool&&this.pool.json.raids){a=this.pool.json.raids[l]}if(-1<this.raidLevel.indexOf("shr")){b=this.SHRDiskNum}else{if(a&&"repair"===this.owner.add_type){b=parseInt(a.designedDiskCount,10)}else{b=this.maxDisks;Ext.each(h.disks,function(m){if(!m.dummy){--b}},this)}}var e=[];var j=[];Ext.each(f,function(o){var m=o.dom.getAttribute("devId");c=this.appWin.disks.data[m];if(c.get("size_total")>=g&&0<b){var n=parseInt(o.dom.getAttribute("raidNum"),10);e.push({id:c.id,raidNum:n});j.push(this.createDisk(c,l,false,false,true));--b}},this);Ext.each(e,function(n){for(var m=0;m<this.RaidDisksData.raids[n.raidNum].disks.length;++m){if(this.RaidDisksData.raids[n.raidNum].disks[m]&&n.id===this.RaidDisksData.raids[n.raidNum].disks[m].id){this.RaidDisksData.raids[n.raidNum].disks[m]=null}}},this);var i;Ext.each(this.RaidDisksData.raids,function(m){i=[];Ext.each(m.disks,function(n){if(n&&!n.dummy){i.push(n)}},this);delete m.disks;m.disks=i},this);h.disks=h.disks.concat(j);l=0;Ext.each(this.RaidDisksData.raids,function(m){if(this.pool&&this.pool.json.raids){a=this.pool.json.raids[l]}k=this.maxDisks-m.disks.length;if(-1<this.raidLevel.indexOf("shr")){d=this.requiredDiskForSHR;k=d}else{if("repair"===this.owner.add_type){d=parseInt(a.designedDiskCount,10)-m.disks.length;k=d}else{if(a&&"expand_by_disk"===this.owner.add_type){d=parseInt(a.designedDiskCount,10)-m.disks.length+1}else{if(a&&"migrate"===this.owner.add_type){if("raid_1"===this.raidLevel&&2===parseInt(a.designedDiskCount,10)){d=parseInt(a.designedDiskCount,10)-m.disks.length+1}else{if(this.minDisks>parseInt(a.designedDiskCount,10)){d=this.minDisks-m.disks.length}else{if("raid_1"===this.pool.json.device_type&&"raid_1"!==this.raidLevel){d=this.minDisks-m.disks.length}else{d=parseInt(a.designedDiskCount,10)+1-m.disks.length}}}}else{d=this.minDisks-m.disks.length;if("raid_10"===this.raidLevel&&m.disks.length>this.minDisks&&1===m.disks.length%2){d=1}}}}}while(0<k){m.disks.push({raidNum:l,dummy:true,required:0<d,cls:0<d?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--k;--d}++l},this);this.checkLastRAID();this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},dropOnTopSToS:function(e){var k=parseInt(this.dropHint.dom.getAttribute("raidNum"),10);var f=0;var d,g,j;if(this.pool){if(this.pool.json.raids&&this.pool.json.raids[k]){f=parseInt(this.pool.json.raids[k].minDevSize,10)}else{f=parseInt(this.pool.get("minimal_disk_size"),10)}}var c=[];Ext.each(e,function(i){c.push(i.dom.getAttribute("devId"))},this);var h=[];var b=this.maxDisks;var a;if(this.pool&&this.pool.json.raids){a=this.pool.json.raids[k]}if(-1<this.raidLevel.indexOf("shr")){b=this.SHRDiskNum}else{if(a&&"repair"===this.owner.add_type){b=parseInt(a.designedDiskCount,10)}else{b=this.maxDisks}}for(g=0;g<this.RaidDisksData.raids[k].disks.length;++g){if(!this.RaidDisksData.raids[k].disks[g]){continue}if(this.RaidDisksData.raids[k].disks[g].dummy){break}if(this.RaidDisksData.raids[k].disks[g].id===this.dropHint.dom.getAttribute("devId")){Ext.each(e,function(o){var i=o.dom.getAttribute("devId");var n=this.appWin.disks.data[i];if(n.get("size_total")>=f&&0<b){var m=parseInt(o.dom.getAttribute("raidNum"),10);for(var l=0;l<this.RaidDisksData.raids[m].disks.length;++l){if(this.RaidDisksData.raids[m].disks[l]&&this.RaidDisksData.raids[m].disks[l].id===n.id){this.RaidDisksData.raids[m].disks[l]=null;break}}h.push(this.createDisk(n,k,false,false,true));--b}},this)}if(0<b&&this.RaidDisksData.raids[k].disks[g]&&-1===c.indexOf(this.RaidDisksData.raids[k].disks[g].id)){h.push(this.RaidDisksData.raids[k].disks[g]);--b}else{if(0>=b&&this.RaidDisksData.raids[k].disks[g]&&this.freeDisks[this.RaidDisksData.raids[k].disks[g].id]){this.freeDisks[this.RaidDisksData.raids[k].disks[g].id].available=true}}}delete this.RaidDisksData.raids[k].disks;this.RaidDisksData.raids[k].disks=h;Ext.each(this.RaidDisksData.raids,function(i){h=[];Ext.each(i.disks,function(l){if(l&&!l.dummy){h.push(l)}},this);delete i.disks;i.disks=h},this);k=0;Ext.each(this.RaidDisksData.raids,function(i){if(this.pool&&this.pool.json.raids){a=this.pool.json.raids[k]}j=this.maxDisks-i.disks.length;if(-1<this.raidLevel.indexOf("shr")){d=this.requiredDiskForSHR;j=d}else{if("repair"===this.owner.add_type){d=parseInt(a.designedDiskCount,10)-i.disks.length;j=d}else{if(a&&"expand_by_disk"===this.owner.add_type){d=parseInt(a.designedDiskCount,10)-i.disks.length+1}else{if(a&&"migrate"===this.owner.add_type){if("raid_1"===this.raidLevel&&2===parseInt(a.designedDiskCount,10)){d=parseInt(a.designedDiskCount,10)-i.disks.length+1}else{if(this.minDisks>parseInt(a.designedDiskCount,10)){d=this.minDisks-i.disks.length}else{if("raid_1"===this.pool.json.device_type&&"raid_1"!==this.raidLevel){d=this.minDisks-i.disks.length}else{d=parseInt(a.designedDiskCount,10)+1-i.disks.length}}}}else{d=this.minDisks-i.disks.length;if("raid_10"===this.raidLevel&&i.disks.length>this.minDisks&&1===i.disks.length%2){d=1}}}}}while(0<j){i.disks.push({raidNum:k,dummy:true,required:0<d,cls:0<d?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--j;--d}++k},this);this.checkLastRAID();this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},dropOnBottomSToS:function(f){var l=parseInt(this.dropHint.dom.getAttribute("raidNum"),10);var g=0;var d,e,h,k;if(this.pool){if(this.pool.json.raids&&this.pool.json.raids[l]){g=parseInt(this.pool.json.raids[l].minDevSize,10)}else{g=parseInt(this.pool.get("minimal_disk_size"),10)}}var c=[];Ext.each(f,function(i){c.push(i.dom.getAttribute("devId"))},this);var j=[];var b=this.maxDisks;var a;if(this.pool&&this.pool.json.raids){a=this.pool.json.raids[l]}if(-1<this.raidLevel.indexOf("shr")){b=this.SHRDiskNum}else{if(a&&"repair"===this.owner.add_type){b=parseInt(a.designedDiskCount,10)}else{b=this.maxDisks}}for(h=0;h<this.RaidDisksData.raids[l].disks.length;++h){if(!this.RaidDisksData.raids[l].disks[h]){continue}if(this.RaidDisksData.raids[l].disks[h].dummy){break}if(0<b&&this.RaidDisksData.raids[l].disks[h]&&-1===c.indexOf(this.RaidDisksData.raids[l].disks[h].id)){j.push(this.RaidDisksData.raids[l].disks[h]);--b}else{if(0>=b&&this.RaidDisksData.raids[l].disks[h]){this.freeDisks[this.RaidDisksData.raids[l].disks[h].id].available=true}}if(this.RaidDisksData.raids[l].disks[h]&&this.RaidDisksData.raids[l].disks[h].id===this.dropHint.dom.getAttribute("devId")){Ext.each(f,function(o){var i=o.dom.getAttribute("devId");d=this.appWin.disks.data[i];if(d.get("size_total")>=g&&0<b){var n=parseInt(o.dom.getAttribute("raidNum"),10);for(var m=0;m<this.RaidDisksData.raids[n].disks.length;++m){if(this.RaidDisksData.raids[n].disks[m]&&this.RaidDisksData.raids[n].disks[m].id===d.id){this.RaidDisksData.raids[n].disks[m]=null;break}}j.push(this.createDisk(d,l,false,false,true));--b}},this)}}delete this.RaidDisksData.raids[l].disks;this.RaidDisksData.raids[l].disks=j;Ext.each(this.RaidDisksData.raids,function(i){j=[];Ext.each(i.disks,function(m){if(m&&!m.dummy){j.push(m)}},this);delete i.disks;i.disks=j},this);l=0;Ext.each(this.RaidDisksData.raids,function(i){if(this.pool&&this.pool.json.raids){a=this.pool.json.raids[l]}k=this.maxDisks-i.disks.length;if(-1<this.raidLevel.indexOf("shr")){e=this.requiredDiskForSHR;k=e}else{if("repair"===this.owner.add_type){e=parseInt(a.designedDiskCount,10)-i.disks.length;k=e}else{if(a&&"expand_by_disk"===this.owner.add_type){e=parseInt(a.designedDiskCount,10)-i.disks.length+1}else{if(a&&"migrate"===this.owner.add_type){if("raid_1"===this.raidLevel&&2===parseInt(a.designedDiskCount,10)){e=parseInt(a.designedDiskCount,10)-i.disks.length+1}else{if(this.minDisks>parseInt(a.designedDiskCount,10)){e=this.minDisks-i.disks.length}else{if("raid_1"===this.pool.json.device_type&&"raid_1"!==this.raidLevel){e=this.minDisks-i.disks.length}else{e=parseInt(a.designedDiskCount,10)+1-i.disks.length}}}}else{e=this.minDisks-i.disks.length;if("raid_10"===this.raidLevel&&i.disks.length>this.minDisks&&1===i.disks.length%2){e=1}}}}}while(0<k){i.disks.push({raidNum:l,dummy:true,required:0<e,cls:0<e?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--k;--e}++l},this);this.checkLastRAID();this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},checkAddNewRAID:function(h){if("repair"===this.owner.add_type){return}var b=this.RaidDisksData.raids[this.RaidDisksData.raids.length-1].disks;var d=false;var f={};Ext.each(b,function(i){if(i.dummy){d=true;return false}},this);if(d){return}var e=this.RaidDisksData.raids.length;f.id=String.format(this.subgroupName,(e+1));f.raidNum=e;f.disks=[];this.RaidDisksData.raids.push(f);var a=this.maxDisks;Ext.each(h,function(k){if(0===a){return false}var i=k.dom.getAttribute("devId");var j=this.appWin.disks.data[i];this.freeDisks[i].available=false;f.disks.push(this.createDisk(j,e,false,false,true));--a},this);var c=this.minDisks-f.disks.length;if("raid_10"===this.raidLevel&&f.disks.length>this.minDisks&&1===f.disks.length%2){c=1}var g=this.maxDisks-f.disks.length;while(0<g){f.disks.push({raidNum:e,dummy:true,required:0<c,cls:0<c?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--g;--c}this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},checkAddNewDummyRaid:function(){if("repair"===this.owner.add_type){return}var b=true;Ext.each(this.RaidDisksData.raids,function(g){Ext.each(g.disks,function(h){if(h.dummy){b=false;return b}},this);return b},this);if(!b){return}var c=this.minDisks;var f=this.maxDisks;var a=[];var e=this.RaidDisksData.raids.length;var d={};while(0<f){a.push({raidNum:e,dummy:true,required:0<c,cls:0<c?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--f;--c}d.disks=a;d.id=String.format(this.subgroupName,(e+1));d.raidNum=e;this.RaidDisksData.raids.push(d);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},checkLastRAID:function(){if(1===this.RaidDisksData.raids.length){return}var b=this.RaidDisksData.raids[this.RaidDisksData.raids.length-1];var a=true;Ext.each(b.disks,function(c){if(!c.dummy){a=false;return false}},this);if(!a){return}this.RaidDisksData.raids.pop()},isInDropZone:function(f,a){var g={begin:[0,0],end:[0,0]},d;if("freeDisks"===a){var b=Ext.get("freeDisksPanel");d=b.getXY();g.begin[0]=d[0];g.begin[1]=d[1];g.end[0]=d[0]+b.getWidth();g.end[1]=d[1]+b.getHeight()}else{var c=Ext.get("raidDisksPanel");d=c.getXY();g.begin[0]=d[0];g.begin[1]=d[1];g.end[0]=d[0]+c.getWidth();g.end[1]=d[1]+c.getHeight()}d=f.getXY();return((d[0]>=g.begin[0]&&d[1]>=g.begin[1])&&(d[0]<=g.end[0]&&d[1]<=g.end[1]))},getSelectedDisks:function(b){var a=[],c={};Ext.each(b.query(".sds-pool-create-device-selected"),function(){var d=new Ext.Element(this);if(d.hasClass("owner")){c[this.getAttribute("devId")]=true;Ext.each(d.next().query("div"),function(){var e=new Ext.Element(this);a.push(e)})}else{if(!c[this.getAttribute("owner")]){a.push(d)}}});return a},activate:function(){var a={};if(!(this.owner instanceof SYNO.SDS.StorageManager.Wizard.AdvCreatePoolMain)){if(this.raidLevel!==this.owner.getRaidLevel()||this.raidLimitNum!==this.owner.getRaidLimitNum()){a.diskType=this.owner.getHddType();this.raidType=this.owner.getRaidType();this.raidLevel=this.owner.getRaidLevel();this.raidLimitNum=this.owner.getRaidLimitNum();this.getFreeDisks(a);this.initialized=false}}else{if(this.raidType!==this.owner.getRaidType()||this.raidLevel!==this.owner.getRaidLevel()||this.hddType!==this.owner.getHddType()||this.raidLimitNum!==this.owner.getRaidLimitNum()){this.raidType=this.owner.getRaidType();this.raidLevel=this.owner.getRaidLevel();this.raidLimitNum=this.owner.getRaidLimitNum();this.hddType=this.owner.getHddType();a.diskType=this.owner.getHddType().split("_")[0];this.getFreeDisks(a);this.initialized=false}}if(("raid_5"===this.raidLevel||"raid_6"===this.raidLevel)&&"multiple"===this.owner.getRaidType()){this.subgroupName=String.format("{0} ({1} {2})",_T("volume","volume_storage_pool"),_T("volume","volume_raid_subgroup"),"{0}")}else{this.subgroupName=_T("volume","volume_storage_pool")}this.decideMinMaxDiskNumber();if(!this.initialized){this.initialized=true;this.initializeRAIDData()}this.prepareFreeDisksData();this.freeDisksPanel.view.store.loadData(this.FreeDisksData,false);this.raidDisksPanel.view.store.loadData(this.RaidDisksData,false)},decideMinMaxDiskNumber:function(){var a;if(this.owner instanceof SYNO.SDS.StorageManager.Wizard.AdvCreatePoolMain){a=this.owner.getRaidLimitNum()}else{a=this.raidLimitNum}if("raid_1"===this.raidLevel){this.minDisks=2;this.maxDisks=4}if("raid_5"===this.raidLevel){this.minDisks=3;this.maxDisks=a}if("raid_6"===this.raidLevel){this.minDisks=4;this.maxDisks=a}if("raid_10"===this.raidLevel){this.minDisks=4;this.maxDisks=a}if("basic"===this.raidLevel){this.minDisks=1;this.maxDisks=1}if("raid_linear"===this.raidLevel||"raid_0"===this.raidLevel){this.minDisks=2;this.maxDisks=a}},initializeRAIDData:function(){var c,b,d,a,e;this.RaidDisksData={};this.RaidDisksData.raids=[];if(this.pool&&this.pool.json.raids){this.pool.json.raids.sort(this.sortRaid);b=0;Ext.each(this.pool.json.raids,function(f){c={};c.id=String.format(this.subgroupName,(b+1));c.raidNum=b;c.disks=[];this.RaidDisksData.raids.push(c);Ext.each(f.devices,function(g){d=this.appWin.disks.data[g.id];if("crashed"===d.get("status")){return true}c.disks.push(this.createDisk(d,b,false,false,false))},this);c.disks.sort(SYNO.SDS.StorageUtils.DiskSort);if("repair"===this.owner.add_type){a=f.designedDiskCount-f.normalDevCount;e=a}else{if("expand_by_disk"===this.owner.add_type){a=1;e=this.maxDisks-c.disks.length}else{if("migrate"===this.owner.add_type){if("raid_1"===this.raidLevel){a=1}else{if(this.minDisks>parseInt(f.designedDiskCount,10)){a=this.minDisks-c.disks.length}else{if("raid_1"===this.pool.json.device_type&&"raid_1"!==this.raidLevel){a=this.minDisks-c.disks.length}else{a=parseInt(f.designedDiskCount,10)+1-c.disks.length}}}e=this.maxDisks-c.disks.length}else{if("raid_10"===this.raidLevel&&c.disks.length>this.minDisks&&1===c.disks.length%2){a=1}e=a;if(("raid_5"===this.raidLevel||"raid_6"===this.raidLevel)&&"multiple"===this.owner.getRaidType()){e=this.maxDisks-c.disks.length}}}}while(0<e){c.disks.push({raidNum:b,dummy:true,required:0<a,cls:0<a?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--e;--a}++b},this);if(("raid_5"===this.raidLevel||"raid_6"===this.raidLevel)&&"multiple"===this.owner.getRaidType()){this.checkAddNewDummyRaid()}return}else{if("repair"===this.owner.add_type&&-1<this.raidLevel.indexOf("shr")){this.initSHRRAID();return}}this.initialFirstRAID()},initSHRRAID:function(){var b=0,c=this.requiredDiskForSHR;var a={};a.id=String.format(this.subgroupName,(b+1));a.raidNum=b;a.disks=[];this.RaidDisksData.raids.push(a);Ext.each(this.pool.get("disks"),function(d){var e=this.appWin.disks.data[d];if("crashed"===e.get("status")){return true}a.disks.push(this.createDisk(e,b,false,false,false))},this);while(0<c){a.disks.push({raidNum:b,dummy:true,required:true,cls:"sds-space-required-disk nonselectable"});--c}this.SHRDiskNum=a.disks.length},initialFirstRAID:function(){var c={};var b=0;var e="";if(("raid_5"===this.raidLevel||"raid_6"===this.raidLevel)&&"multiple"===this.owner.getRaidType()){e=String.format(this.subgroupName,1)}else{e=this.subgroupName}c.id=e;c.raidNum=b;c.disks=[];this.RaidDisksData.raids.push(c);var a=this.minDisks-c.disks.length;if("raid_10"===this.raidLevel&&c.disks.length>this.minDisks&&1===c.disks.length%2){a=1}var d=this.maxDisks;while(0<d){c.disks.push({raidNum:0,dummy:true,required:0<a,cls:0<a?"sds-space-required-disk nonselectable":"sds-space-dummy nonselectable"});--d;--a}},prepareFreeDisksData:function(){var c={},g=false;if(0<this.minSizeRequiredDisks&&0<this.minSize){var f=0;Ext.each(this.selectedDisk,function(j){if(j.size_total>=this.minSize){++f}},this);var h=[];if(f<this.minSizeRequiredDisks){Ext.each(this.selectedDisk,function(j){if(j.size_total>=this.minSize){h.push(j)}else{j.available=true}},this);g=true}}for(var i in this.freeDisks){if(this.freeDisks.hasOwnProperty(i)){var a=this.freeDisks[i];if(!a.available){continue}var e=a.owner;if(!c[e]){c[e]={};c[e].id=e;c[e].name=0===a.container.order?_S("hostname"):a.container.str;c[e].order=a.container.order;c[e].disks=[]}var b=c[e];b.disks.push(a)}}delete this.FreeDisksData;this.FreeDisksData={};this.FreeDisksData.containers=[];for(i in c){if(c.hasOwnProperty(i)){this.FreeDisksData.containers.push(c[i])}}var d=function(k,j){if(k.order>j.order){return 1}if(k.order<j.order){return -1}return 0};this.FreeDisksData.containers.sort(d);Ext.each(this.FreeDisksData.containers,function(j){j.disks.sort(d)},this)},isValid:function(){if(("raid_5"===this.raidLevel||"raid_6"===this.raidLevel)&&"multiple"===this.owner.getRaidType()){return this.isValidMutiRaid()}else{return this.isValidSingleRaid()}},isValidMutiRaid:function(){var f=this,a=true,d,e,c=false,j=false,h=false;var g=function(i){if(!i.dummy&&i.is4Kn){j=true}else{if(!i.dummy){h=true}}if(!c&&i.dummy){c=true}a=!i.required;return a};for(d=0;d<this.RaidDisksData.raids.length;++d){if(0!==d&&d===this.RaidDisksData.raids.length-1){break}e=this.RaidDisksData.raids[d];Ext.each(e.disks,g,this)}if(j&&h){f.owner.getMsgBox().alert(f.owner.title,_T("volume","not_allow_hybrid_hdd"));return false}if(1===this.RaidDisksData.raids.length){if(!a){this.markupRequiredDisks()}else{this.owner.clearStatus()}return a}var b=true;if(a&&1<this.RaidDisksData.raids.length){e=this.RaidDisksData.raids[this.RaidDisksData.raids.length-1];b=e.disks[0].dummy;if(!b){Ext.each(e.disks,function(i){a=!i.required;return a},this)}}if(a&&c){this.markupAdditionalDisks();return false}else{this.owner.clearStatus()}if(!a){this.markupRequiredDisks()}else{this.owner.clearStatus()}return a},markupRequiredDisks:function(){this.owner.setStatusError({text:_T("volume","volume_fill_all_required_disks"),clear:3000});var a=Ext.get("raidDisksPanel").query(".sds-space-required-disk");Ext.each(a,function(e,b,d){var c=new Ext.Element(e);c.addClass("red-status")})},markupAdditionalDisks:function(){this.owner.setStatusError({text:String.format(_T("volume","volume_fill_all_additional_disks"),this.owner.getRaidLimitNum()),clear:3000});var a=Ext.get("raidDisksPanel").query(".sds-space-dummy");var b=this.RaidDisksData.raids.length-1;Ext.each(a,function(f,c,e){if(b===parseInt(f.getAttribute("raidNum"),10)){return true}var d=new Ext.Element(f);d.addClass("red-status")})},isValidSingleRaid:function(){var c=this,b=true,e=false,d=false;if(!this.RaidDisksData.raids[0]){return false}Ext.each(this.RaidDisksData.raids[0].disks,function(f){if(!f.dummy&&f.is4Kn){e=true}else{if(!f.dummy){d=true}}b=!f.required;return b},this);if(e&&d){c.owner.getMsgBox().alert(c.owner.title,_T("volume","not_allow_hybrid_hdd"));return false}if(!b){this.owner.setStatusError({text:_T("volume","volume_fill_all_required_disks"),clear:3000});var a=Ext.get("raidDisksPanel").query(".sds-space-required-disk");Ext.each(a,function(i,f,h){var g=new Ext.Element(i);g.addClass("red-status")})}else{this.owner.clearStatus()}return b},getNext:function(){if(!this.isValid()){return false}if("raid_5"==this.raidLevel||"raid_6"==this.raidLevel){this.nextId=this.owner.getStep("diskCheck").getNext()}else{this.nextId="diskCheck"}var a=new SYNO.SDS.StorageManager.Volume.Dialog.SpaceCreationWarningWindow({owner:this.owner,warningMsg:_T("volume","volume_adddisk_type_two_warning"),showPwrChk:false,next_id:this.nextId});a.open();return false},getDiskIds:function(){var a=[];if(!this.RaidDisksData){return a}Ext.each(this.RaidDisksData.raids,function(b){Ext.each(b.disks,function(c){if(""===c.used_by&&!c.dummy){a.push(c.id)}})});return a},getDiskGroups:function(){var a=[],b;if("multiple"!==this.owner.getRaidType()||("raid_5"!==this.raidLevel&&"raid_6"!==this.raidLevel)){return a}if("migrate"===this.owner.add_type){return a}if(!this.RaidDisksData){return a}Ext.each(this.RaidDisksData.raids,function(e){var d=[];var f="new_raid",c=true;if(this.pool&&this.pool.json.raids&&this.pool.json.raids[e.raidNum]){f=this.pool.json.raids[e.raidNum].raidPath;c=false}Ext.each(e.disks,function(g){if(""===g.used_by&&!g.dummy){d.push(g.id)}},this);b={isNew:c,disks:d,raidPath:f};if(0<d.length){a.push(b)}},this);return a},getFreeDisks:function(a){var b=this;delete this.freeDisks;b.freeDisks={};if(!b.disks){b.disks=b.appWin.disks.getAll()}Ext.each(b.disks,function(f){var e,g,d;if(!f.isFree()){return true}if(!f.isNormalTray()){return true}if(b.appWin.hotSpares.data[f.id]){return}if(a.diskType&&a.diskType!==f.get("diskType")){return true}if("cache"===f.get("portType")){return}var c;if("internal"===f.get("container").type){c="host"}else{c="expander_"+f.get("container").order}e=f.get("container").order?f.get("container").order+" -":"";g=f.get("order");d=String.format("{0} {1}",e,g);this.freeDisks[f.id]={container:{str:f.get("container").str,type:f.get("container").type,order:f.get("container").order||0},owner:c,device:f.get("device"),diskType:f.get("diskType"),driveType:f.isSSD()?"SSD":"HDD",id:f.id,order:f.get("order"),model:f.get("model"),name:f.get("name"),longName:f.get("longName"),shortName:d,rpm:f.get("rpm"),serial:f.get("serial"),size_total:f.get("size_total"),size:SYNO.SDS.StorageUtils.SizeRender(f.get("size_total")),status:f.get("status"),temp:f.get("temp"),used_by:f.get("used_by"),available:true,dummy:false,is4Kn:f.get("is4Kn"),display4Kn:f.get("is4Kn")?String.format("({0})",_T("volume","4kn")):""}},this)},getNames:function(){var a=[];Ext.each(this.RaidDisksData.raids,function(b){Ext.each(b.disks,function(c){if(!c.dummy&&c.used_by.empty()){a.push(c.longName)}},this)},this);return a},summary:function(b){var a=this.getNames();if(a.length>0){b.append(_T("volume","volume_apply_disk"),a.join(", "))}},createDisk:function(f,d,e,g,c){var b=f.get("container").order?f.get("container").order+" -":"";var h=f.get("order");var a=String.format("{0} {1}",b,h);return{container:{str:f.get("container").str,type:f.get("container").type,order:f.get("container").order||0},device:f.get("device"),diskType:f.get("diskType"),driveType:f.isSSD()?"SSD":"HDD",id:f.id,numId:f.get("num_id"),ctnOder:f.get("container").order,order:f.get("order"),model:f.get("model"),name:f.get("name"),longName:f.get("longName"),shortName:a,rpm:f.get("rpm"),serial:f.get("serial"),size_total:f.get("size_total"),size:SYNO.SDS.StorageUtils.SizeRender(f.get("size_total")),status:f.get("status"),temp:f.get("temp"),used_by:f.get("used_by"),raidNum:d,available:e,dummy:g,cls:c?"selectable":"nonselectable",is4Kn:f.get("is4Kn"),display4Kn:f.get("is4Kn")?String.format("({0})",_T("volume","4kn")):""}},sortRaid:function(f,d){var e=f.raidPath.split("/")[2].split("d")[1];var c=d.raidPath.split("/")[2].split("d")[1];e=parseInt(e,10);c=parseInt(c,10);if(e>c){return 1}if(e<c){return -1}return 0}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvCreatePoolSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(a){var b={headline:_T("volume","volume_wizard_summary_title")};this.callParent([Ext.apply(b,a)])},activate:function(){this.callParent(arguments);this.owner.setStatusBusy();this.owner.getButton("next").disable();var a={};a.estimate_for="create";a.disk_id=this.owner.getDiskIds();a.device_type=this.owner.getRaidLevel();a.diskGroups=this.owner.getDiskGroups();if(1>=a.diskGroups.length){delete a.diskGroups}SYNO.API.Request({api:"SYNO.Storage.CGI.Pool",method:"estimate_size",version:1,params:a,callback:function(e,d,c,b){this.owner.clearStatusBusy();if(!e){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);this.owner.getButton("next").disable();return}if(!_S("demo_mode")){this.owner.getButton("next").enable()}this.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(d.size))},scope:this})},getNext:function(){this.owner.applySettings();return false}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvEditPool",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.isDataChanged=false;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("volume","volume_edit_desc"),items:[new SYNO.ux.FormPanel({itemId:"descPanel",border:false,trackResetOnLoad:true,labelWidth:130,items:[{xtype:"syno_textfield",validateOnBlur:true,validationEvent:"blur",name:"desc",itemId:"desc",fieldLabel:_T("share","share_comment"),width:250,maxLength:64}]})],width:450,height:150,resizable:false,buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:c,handler:c.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){var a=this;a.callParent(arguments);a.getComponent("descPanel").getForm().setValues({desc:Ext.util.Format.htmlDecode(this.pool.get("desc"))})},onSave:function(){if(!this.getComponent("descPanel").getForm().isValid()){return}if(!this.getComponent("descPanel").getForm().isDirty()){this.close();return}var a={space_path:this.pool.get("space_path"),desc:this.getComponent("descPanel").getForm().getValues().desc};this.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Pool",method:"edit_desc",version:1,params:a,callback:function(e,d,c,b){this.clearStatusBusy();if(!e){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);return}this.isDataChanged=true;this.close()},scope:this})},onCancel:function(){if("create"===this.mode){this.close();return}if(this.getComponent("descPanel").getForm().isDirty()){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvManagePool",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var c=this,b,d=0;c.isDataChanged=false;c.pool=undefined;c.disks=undefined;c.manageType=undefined;c.migrateType=undefined;c.appWin=a.appWin;c.owner=a.owner;c.pool=a.pool||null;c.disks=a.disks||[];c.manageType=a.manageType||{};c.migrateType=a.migrateType||{};c.add_type=a.add_type;c.raidLimitNum=a.raidLimitNum;if(a.repair){d=a.repair}b=Ext.apply({title:_T("volume","volume_raid_management_title"),width:700,height:520,minHeight:475,minWidth:700,resizable:true,border:false,steps:[]},a);if("migrate"===c.add_type){c.activeStep="migrate";b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvMigrateTypeStep({appWin:c.appWin,migrateType:c.migrateType,migrateConstrain:c.pool.get("can_do").migrate,itemId:"migrate",nextId:"advDisk"}))}else{if("expand_with_unalloc_size"===c.add_type){c.activeStep="summary"}else{if("data_scrubbing"===c.add_type){c.activeStep="summary"}else{c.activeStep="advDisk"}}}b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvDiskStep({appWin:c.appWin,pool:c.pool,disks:c.disks,raidLimitNum:c.raidLimitNum,repair:d,itemId:"advDisk",nextId:"summary"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.DiskCheckStep({appWin:c.appWin,itemId:"diskCheck",nextId:"summary",getNext:function(){return this.nextId}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.AdvManagePoolSummaryStep({appWin:c.appWin,itemId:"summary",nextId:null}));c.callParent([b])},onOpen:function(){var a=this;a.setActiveStep(a.activeStep);a.callParent(arguments)},getManageType:function(){return this.add_type},getMigrateType:function(){var a=this;if(a.inHistory("migrate")){return a.getStep("migrate").getForm().getValues().migrateType}return undefined},getHddType:function(){return this.appWin.disks.data[this.pool.get("disks")[0]].get("diskType")},getRaidType:function(){return this.pool.get("raidType")},getRaidLevel:function(){if(this.inHistory("migrate")){var a=this.getStep("migrate").getForm().getValues().migrateType;switch(a){case"add_mirror":return"raid_1";case"to_raid1":return"raid_1";case"to_raid5":return"raid_5";case"to_raid6":return"raid_6";default:return""}}else{return this.pool.getDeviceType()}},getRaidLimitNum:function(){var a;if(this.inHistory("migrate")){a=this.getStep("migrate").getComponent("limitNum");if(!a.hidden){return a.getValue()}}return this.pool.get("limited_disk_number")},getDiskIds:function(){return this.getStep("advDisk").getDiskIds()},getDiskGroups:function(){return this.getStep("advDisk").getDiskGroups()},getActionType:function(){var a=this.getManageType();if("migrate"===a){return"migrate_"+this.getMigrateType()}else{return a}},applySettings:function(a){if("single"===this.pool.get("raidType")&&this.pool.get("deploy_path")&&-1<this.pool.get("deploy_path").indexOf("iscsilun")){this.applySettingsLun(a)}else{if("single"===this.pool.get("raidType")&&this.pool.get("deploy_path")){this.applySettingsVolume(a)}else{this.applySettingsPool(a)}}},applySettingsPool:function(b){var a="";switch(b){case"stop_in_minutes":a=String.format(_T("volume","volume_change_service_stop_in_minutes"),_T("common","ask_cont"));break;default:}if(a!==""){if("yes"===_D("support_share_encryption","no")){a=String.format("1. {0}<p>2. {1}",_T("volume","volume_share_encryption_unmount_warning"),a)}this.getMsgBox().confirm(this.title,a,function(c){if("yes"===c){this.sendRequestPool()}},this);return}this.sendRequestPool()},sendRequestPool:function(){var e={},f;var a=this.getDiskIds();var d=this.getDiskGroups();var c=this.getManageType();var b=this.getActionType();e.space_id=this.pool.id;switch(c){case"repair":f="repair";e.disk_id=a;e.diskGroups=d;break;case"data_scrubbing":f="data_scrubbing";e.diskGroups=d;break;case"expand_by_disk":f="expand_by_add_disk";e.disk_id=a;e.diskGroups=d;break;case"expand_with_unalloc_size":f="expand_unallocated";break;case"migrate":f="migrate";e.migrate_type=b;e.disk_id=a;if("raid_5"===this.getRaidLevel()){e.limit_num=this.getStep("migrate").getComponent("limitNum").getValue()}break;default:SYNO.Debug("unknown add type");return}this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Pool",method:f,version:1,params:e,callback:function(j,i,h,g){this.clearStatusBusy();if(!j){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(i);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,i);return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));this.isDataChanged=true;this.close()},scope:this})},applySettingsVolume:function(b){var a="";switch(b){case"stop_in_minutes":a=String.format(_T("volume","volume_change_service_stop_in_minutes"),_T("common","ask_cont"));break;default:}if(a!==""){if("yes"===_D("support_share_encryption","no")){a=String.format("1. {0}<p>2. {1}",_T("volume","volume_share_encryption_unmount_warning"),a)}this.getMsgBox().confirm(this.title,a,function(c){if("yes"===c){this.sendRequestVolume()}},this);return}this.sendRequestVolume()},sendRequestVolume:function(){var e={};var f;var a=this.getDiskIds();var d=this.getDiskGroups();var c=this.getManageType();var b=this.getActionType();e.pool_path=this.pool.id;e.space_id=this.pool.get("deploy_path");switch(c){case"repair":f="repair";e.disk_id=a;e.diskGroups=d;break;case"data_scrubbing":f="data_scrubbing";e.diskGroups=d;break;case"expand_by_disk":f="expand_by_add_disk";e.disk_id=a;e.diskGroups=d;break;case"expand_with_unalloc_size":f="expand_unallocated";break;case"migrate":f="migrate";e.migrate_type=b;e.disk_id=a;e.diskGroups=d;if("raid_5"===this.getRaidLevel()){e.limit_num=this.getStep("migrate").getComponent("limitNum").getValue()}break;default:SYNO.Debug("unknown add type");return}this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:f,version:1,params:e,callback:function(j,i,h,g){this.clearStatusBusy();if(!j){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(i);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,i);return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));this.isDataChanged=true;this.close()},scope:this})},applySettingsLun:function(b){var a="";switch(b){case"stop_in_minutes":a=String.format(_T("volume","volume_change_service_stop_in_minutes"),_T("common","ask_cont"));break;default:}if(a!==""){this.getMsgBox().confirm(this.title,a,function(c){if("yes"===c){this.sendRequestLun()}},this);return}this.sendRequestLun()},sendRequestLun:function(){var e={};var a=this.getDiskIds();var d=this.getDiskGroups();var c=this.getManageType();var b=this.getActionType();e.pool_path=this.pool.id;e.space_id=this.pool.get("deploy_path");switch(c){case"repair":e.method="repair";e.disk_id=a;e.diskGroups=d;break;case"data_scrubbing":e.method="data_scrubbing";e.diskGroups=d;break;case"expand_by_disk":e.method="expand_iscsilun_by_add_disk";e.disk_id=a;e.diskGroups=d;break;case"expand_with_unalloc_size":e.method="expand_iscsilun_unallocated";break;case"migrate":e.method="migrate";e.migrate_type=b;e.disk_id=a;e.diskGroups=d;if("raid_5"===this.getRaidLevel()){e.limit_num=this.getStep("migrate").getComponent("limitNum").getValue()}break;default:SYNO.Debug("unknown add type");return}this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:e.method,version:1,params:e,callback:function(g,f){this.clearStatusBusy();if(!g){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(f);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));if(f.str){this.getMsgBox().alert(this.title,f.str,this.close,this)}else{this.isDataChanged=true;this.close()}},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvMigrateTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.migrateType=undefined;c.migrateConstrain=undefined;c.loaded=false;c.appWin=a.appWin;b={headline:_T("volume","volume_migrate_type_title"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_migrate_add_mirror"),name:"migrateType",itemId:"add_mirror",inputValue:"add_mirror",listeners:{check:this.onMigrateTypeChanged,scope:this}},{xtype:"syno_radio",boxLabel:_T("volume","volume_migrate_to_raid1"),name:"migrateType",itemId:"to_raid1",inputValue:"to_raid1",listeners:{check:this.onMigrateTypeChanged,scope:this}},{xtype:"syno_radio",boxLabel:_T("volume","volume_migrate_to_raid5"),name:"migrateType",itemId:"to_raid5",inputValue:"to_raid5",listeners:{check:this.onMigrateTypeChanged,scope:this}},{xtype:"syno_radio",boxLabel:_T("volume","volume_migrate_to_raid6"),name:"migrateType",itemId:"to_raid6",inputValue:"to_raid6",listeners:{check:this.onMigrateTypeChanged,scope:this}},{xtype:"syno_combobox",fieldLabel:_T("volume","limit_raid_disk_number"),name:"limitNum",itemId:"limitNum",hidden:true,hiddenName:"limitNum",hiddenValue:0,store:new Ext.data.ArrayStore({data:[["6",6],["12",12],["24",24]],id:"value",fields:["text","value"]}),displayField:"text",valueField:"value",mode:"local",allowBlank:false}]};c.callParent([Ext.apply(b,a)])},onMigrateTypeChanged:function(b,c){var a=this.getComponent("limitNum");if("to_raid5"===b.itemId){if(true===c){a.show()}else{a.hide()}}},getType:function(){return this.getForm().getValues().migrateType},activate:function(){var a="";if(this.loaded){return}Ext.each(["add_mirror","to_raid1","to_raid5","to_raid6"],function(b){if(b in this.migrateType&&this.migrateType[b]){this.getComponent(b).enable();a=b}else{this.getComponent(b).disable()}},this);this.getComponent(a).setValue(true);if("add_mirror" in this.migrateType&&this.migrateType.add_mirror){this.getComponent("add_mirror").getEl().findParentNode(".x-form-item").style.display="";this.getComponent("to_raid1").getEl().findParentNode(".x-form-item").style.display="none"}else{this.getComponent("add_mirror").getEl().findParentNode(".x-form-item").style.display="none";this.getComponent("to_raid1").getEl().findParentNode(".x-form-item").style.display=""}this.getComponent("limitNum").setValue(12);this.loaded=true},getNext:function(){var a=this.getType();if(("to_raid5"===a&&0===this.migrateConstrain.to_raid5)||("to_raid6"===a&&0===this.migrateConstrain.to_raid6)){if(this.owner.getStep("advDisk")){this.owner.getStep("advDisk").allowBlank=true}else{this.owner.getStep("advDisk").allowBlank=false}}if("to_raid5"===a){this.owner.getStep("advDisk").raidLimitNum=this.getComponent("limitNum").getValue()}return this.nextId},summary:function(a){if("to_raid5"===this.getType()){a.append(_T("volume","limit_raid_disk_number"),this.getComponent("limitNum").getValue())}}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvManagePoolSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(a){var c=this,b;c.stopServicesType=undefined;c.appWin=a.appWin;b={headline:_T("volume","volume_wizard_summary_title")};c.callParent([Ext.apply(b,a)])},activate:function(){var d=this.getStore();var a=SYNO.SDS.StorageUtils;var c=this.owner.getManageType();var b;this.callParent(arguments);d.append(_T("common","name"),this.owner.pool.getName());b=a.AddDiskTypeRender(c);if(b){d.append(_T("volume","volume_add_purpose"),b)}if(c==="migrate"){b=a.MigrateTypeRender(this.owner.getMigrateType());d.append(_T("volume","volume_migrate_type"),b)}if(c==="data_scrubbing"){d.append(_T("volume","notice"),_T("volume","data_scrubbing_notice"))}this.owner.setStatusBusy();this.owner.getButton("next").disable();if("single"===this.owner.pool.get("raidType")&&this.owner.pool.get("deploy_path")&&-1<this.owner.pool.get("deploy_path").indexOf("iscsilun")){this.getStopServiceTypeLun()}else{if("single"===this.owner.pool.get("raidType")&&this.owner.pool.get("deploy_path")){this.getStopServiceTypeVolume()}else{this.getStopServiceTypePool()}}},getStopServiceTypePool:function(){SYNO.API.Request({api:"SYNO.Storage.CGI.Pool",method:"estimate_size",version:1,params:{estimate_for:this.owner.getActionType(),disk_id:this.owner.getDiskIds(),space_id:this.owner.pool.id,diskGroups:this.owner.getDiskGroups()},callback:function(d,c,b,a){this.owner.clearStatusBusy();if(!d){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,c);this.owner.getButton("next").disable();return}if(!_S("demo_mode")){this.owner.getButton("next").enable()}this.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(c.size));if(c.stop_service_type){this.stopServicesType=c.stop_service_type}},scope:this})},getStopServiceTypeVolume:function(){SYNO.API.Request({api:"SYNO.Storage.CGI.Volume",method:"estimate_size",version:1,params:{estimate_for:this.owner.getActionType(),disk_id:this.owner.getDiskIds(),space_id:this.owner.pool.get("deploy_path"),diskGroups:this.owner.getDiskGroups()},callback:function(j,c,d,b){var f=SYNO.SDS.StorageUtils;var h={};var e=this.appWin.volumes.data[this.owner.pool.get("deploy_path")];var a=e.get("max_fs_size");var k=this.appWin.getMaxVolumeSize(false);var g=e.get("size").total;var i;this.owner.clearStatusBusy();if(!j){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,c);this.owner.getButton("next").disable();return}if(!_S("demo_mode")){this.owner.getButton("next").enable()}this.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(c.size));if(parseInt(a,10)>parseInt(g,10)){i=a}else{i=g}if(parseInt(i,10)>parseInt(k,10)){i=k}if(parseInt(c.size,10)>parseInt(i,10)){h.text=_T("error","error_volume_oversize");h.text=String.format(h.text,f.SizeRender(i));SYNO.SDS.StorageUtils.ReportWebapiFailure(this,h);this.owner.getButton("next").disable();return}if(c.stop_service_type){this.stopServicesType=c.stop_service_type}},scope:this})},getStopServiceTypeLun:function(){this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",version:1,method:"estimate_size",params:{estimate_for:this.owner.getActionType(),disk_id:this.owner.getDiskIds(),space_id:this.owner.pool.get("deploy_path"),diskGroups:this.owner.getDiskGroups()},callback:function(b,a){this.owner.clearStatusBusy();if(!b){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,a);this.owner.getButton("next").disable();return}if(!_S("demo_mode")){this.owner.getButton("next").enable()}if(a.str){this.owner.getMsgBox().alert(this.owner.title,a.str)}this.getStore().append(_T("volume","volume_totalsize"),_T("volume","volume_add_warningabout")+" "+SYNO.SDS.StorageUtils.SizeRender(a.size));if(a.stop_service_type){this.stopServicesType=a.stop_service_type}},scope:this})},getNext:function(){this.owner.applySettings(this.stopServicesType);return false},disableNextInDemoMode:true});Ext.namespace("SYNO.SDS.StorageManager.Pool");Ext.define("SYNO.SDS.StorageManager.Pool.Store",{extend:"Ext.data.JsonStore",constructor:function(a){var c=this,b;c.sortField="numId";c.sortDir="ASC";c.sortType="sort_numId";b={autoDestroy:true,idProperty:"id",fields:["numId","id","iconCls","statusIconCls","displayName","desc","usage","barWidth","summaryStatus","property","raidInfo","detailUsage","illustrate","status","totalSize","freeSize"],listeners:{load:function(){c.sort(c.sortField,c.sortDir)},scope:c}};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.StorageManager.Pool.Main",{extend:"SYNO.ux.Panel",constructor:function(b){var e=this,a,d,c;e.view=undefined;e.appWin=b.appWin;e.owner=b.appWin;e.sortType="sort_numId";e.createView();d={xtype:"syno_button",itemId:"adv_manage",text:_T("volume","volume_manage"),menu:[{itemId:"repair",text:_T("volume","volume_adddisk2_type_repair"),handler:e.onRepair,scope:e},{itemId:"data_scrubbing",text:_T("volume","volume_scrubbing_type_raid"),handler:e.onDataScrubbing,scope:e},{itemId:"addDisks",text:_T("volume","volume_adddisk"),handler:e.onAddDisks,scope:e},{itemId:"expand",text:_T("volume","volume_adddisk2_type_expand"),handler:e.onExpand,scope:e},{itemId:"migrate",text:_T("volume","volume_adddisk2_type_migrate"),handler:e.onMigrate,scope:e},{itemId:"edit",text:_T("volume","volume_edit_desc"),handler:e.onEdit,scope:e}]};a={xtype:"syno_button",itemId:"manage",text:_T("volume","volume_manage"),handler:e.onManage,scope:e};c={border:false,layout:"fit",itemId:"storage_pool",tbar:{defaultType:"syno_button",items:[{itemId:"create",text:_T("common","create"),handler:e.onCreate,scope:e},{itemId:"remove",text:_T("common","remove"),handler:e.onDelete,scope:e},{itemId:"edit",text:_T("volume","volume_edit_desc"),handler:e.onEdit,scope:e},d,a,{itemId:"cancel",text:_T("common","cancel"),handler:e.onCancel,scope:e},"->",new SYNO.SDS.StorageManager.SortButton({appWin:e.appWin,owner:e,menuItems:[{text:_T("volume","volume_sort_by_id"),itemId:"sort_numId",handler:e.onSort,scope:e},{text:_T("volume","volume_sort_by_status"),itemId:"sort_status",handler:e.onSort,scope:e},{text:_T("volume","volume_sort_by_available"),itemId:"sort_freeSize",handler:e.onSort,scope:e},{text:_T("volume","volume_sort_by_capacity"),itemId:"sort_totalSize",handler:e.onSort,scope:e}]})]},items:e.view,listeners:{activate:e.onActivate,scope:e}};e.callParent([Ext.apply(c,b)])},getHelpParam:function(){if(this.appWin.supportRaidGroup){return"StorageManager/raid.html"}else{return"StorageManager/volume_diskgroup.html"}},createView:function(){var e=this,c=SYNO.SDS.StorageManager.UsageTpl(),d=SYNO.SDS.StorageManager.PropertyTpl(),g=SYNO.SDS.StorageManager.DiskListTpl({scope:"disks",emptyText:_T("volume","volume_status_none")}),f=SYNO.SDS.StorageManager.DiskListTpl({scope:"spares",title:_T("volume","volume_suitable_spare_disks"),emptyText:_T("volume","volume_no_suitable_spare_disks")}),h=SYNO.SDS.StorageManager.DetailUsageTpl(),b,a;b=new Ext.XTemplate('<div class="item-detail-inner">',d.html,'<tpl if="this.hasValues(raidInfo) == true">','<tpl for="raidInfo">',g.html,(e.appWin.supportHotSpare)?f.html:"","</tpl>","</tpl>",'<tpl if="detailUsage">',h.html,"</tpl>","</div>");a={appWin:e.appWin,owner:e,dataType:"storagePools",itemId:"poolView",multiSelect:false,singleSelect:true,usageTpl:c,detailTpl:b,store:new SYNO.SDS.StorageManager.Pool.Store(),listeners:{selectionchange:e.onSelectChange,scope:e}};e.view=new SYNO.SDS.StorageManager.DataView(a)},resetBtnStatus:function(){var a=this;a.getButton("remove").hide();a.getButton("adv_manage").hide();a.getButton("manage").hide();a.getButton("cancel").hide();a.enableButton("create",a.canCreate())},setMask:function(){var a=this,b=(a.appWin.supportRaidGroup)?_T("volume","volume_raid_group"):_T("volume","volume_pool"),c=String.format(_T("volume","volume_no_storage_pool"),b);if(a.isVisible()&&0===a.view.getStore().getCount()){a.body.mask(c,"syno-ux-mask-info");a.getButton("sort").disable()}if(0<a.view.getStore().getCount()){a.body.unmask();a.getButton("sort").enable()}},canCreate:function(){var b=this,a=b.appWin.disks.getMatched("isNormalTray","isFree");if(0<a.length){return true}return false},canDelete:function(a){if(!a){return false}if(a.isActioning()){return false}if(!a.get("can_do")["delete"]){return false}return true},canManage:function(e){var f=this,b,a,d,c;if(!e){return false}b=(-1<e.get("device_type").indexOf("shr"))?true:false;if(e.isActioning()){return false}if(e.isCrashed()){return false}if(f.appWin.supportRaidGroup&&!b){a=f.getAvailableDisksForAddRaidGroup(e);d=f.getValidAddTypeRaidGroup(e,a)}else{a=f.getAvailableDisksForAdd(e);d=f.getValidAddType(e,a)}if(!f.appWin.supportRaidGroup||b){for(c in d){if(d[c]){return true}}return false}f.getButton("adv_manage").menu.getComponent("repair").disable();f.getButton("adv_manage").menu.getComponent("data_scrubbing").disable();f.getButton("adv_manage").menu.getComponent("expand").disable();f.getButton("adv_manage").menu.getComponent("addDisks").disable();f.getButton("adv_manage").menu.getComponent("migrate").disable();if(d.repair){f.getButton("adv_manage").menu.getComponent("repair").enable();return true}if(d.data_scrubbing){f.getButton("adv_manage").menu.getComponent("data_scrubbing").enable()}if(d.expand_with_unalloc_size){f.getButton("adv_manage").menu.getComponent("expand").enable();return true}if(d.expand_by_disk&&f.canExpand(e)){f.getButton("adv_manage").menu.getComponent("addDisks").enable()}if(d.migrate&&f.canMigrate(e)){f.getButton("adv_manage").menu.getComponent("migrate").enable()}return true},canMigrate:function(c){var a=c.get("device_type");var b=c.get("limited_disk_number");if(c.isActioning()){return false}if(-1<a.indexOf("shr")){return false}if(b<=c.get("disks").length){return false}return true},canExpand:function(c){var a=c.get("device_type");var b=c.get("limited_disk_number");if(c.isActioning()){return false}if(-1<a.indexOf("shr")){return false}if(b>c.get("disks").length){return true}else{if("multiple"===c.get("raidType")&&("raid_5"===a||"raid_6"===a)){return true}}return false},canCancel:function(a){var b;b=a.getProgressStep();if(a.isCreating()){if(b==="mk_filesystem"||b==="raid_syncing"||b==="raid_parity_checking"||b==="disk_check"||b==="waiting"){return true}}else{if(b==="data_scrubbing"){return true}}return false},prepareUiData:function(){var b=this,a=b.appWin.storagePools.getAll(),c;delete b.uiData;b.uiData=[];Ext.each(a,function(f){var e=0,d=0;c={};if(f.usedByGlusterFs()){Ext.each(b.appWin.volumes.getAll(),function(g){if(f.get("id")===g.get("pool_path")){e+=parseInt(g.get("size").total,10);d+=parseInt(g.get("size").used,10)}},b);f.json.glusterTotalSize=e;f.json.glusterUsedSize=d}b.prepareSummary(f,c);b.prepareProperty(f,c);if(!b.appWin.supportRaidGroup||-1<f.get("device_type").indexOf("shr")){this.prepareRaidInfo(f,c)}else{this.prepareRaidGroupInfo(f,c)}if(f.notUsedByGlusterFs()){b.prepareDetail(f,c)}b.uiData.push(c)},b)},prepareSummary:function(e,f){var g,d,c=SYNO.SDS.StorageUtils,b,a;g=c.SpaceIDParser(e.get("id"));if(e.usedByGlusterFs()){b=parseInt(e.get("glusterUsedSize"),10);a=parseInt(e.get("glusterTotalSize"),10);d=String.format("{0} ({1})",g.str,_T("volume","cluster_storage_unit"));f.iconCls="sm-list-icon-cluster-storage-unit"}else{b=parseInt(e.get("size").used,10);a=parseInt(e.get("size").total,10);d=g.str;f.iconCls="sm-list-icon-storage-pool"}f.numId=e.get("num_id");f.status=e.get("status");f.totalSize=a;f.freeSize=a-b;f.id=e.get("id");f.displayName=d;f.desc=e.get("desc");f.usage=String.format('<span style="color:#0086E5">{0}</span>&nbsp;/&nbsp;{1}',c.SizeRender(b),c.SizeRender(a));f.barWidth=(0===a)?0:200*b/a;f.summaryStatus=String.format("&nbsp;-&nbsp;{0}",c.StatusNameRender(e.get("status")));if(e.get("is_actioning")){f.statusIconCls="sm-list-status-icon-acting"}else{if("crashed"===e.get("status")||"degrade"===e.get("status")){f.statusIconCls="sm-list-status-icon-crashed"}}},prepareProperty:function(e,d){var f=this;var i,g,c;var h=SYNO.SDS.StorageUtils;var b=h.StatusRender(e.get("status"),e.get("progress"));var a=h.WarningTextRender(e.get("status"),h.SpaceIDParser(e.get("id")).str);d.property=[{name:_T("volume","volume_raid_title"),value:h.SpaceTypeRender(e.get("device_type"))}];f.renderSuggestions(e,d);if(f.appWin.supportRaidGroup){d.property.push({name:_T("volume","volume_multiple_vol_lun_support"),value:"single"===e.get("raidType")?_T("common","no"):_T("common","yes")});c=e.get("device_type");if("raid_1"!==c&&"basic"!==c){d.property.push({name:_T("volume","limit_raid_disk_number"),value:e.get("limited_disk_number")})}}d.property.push({name:_T("volume","volume_volumestatus"),value:b+a});if(e.usedByGlusterFs()){i=parseInt(e.get("glusterUsedSize"),10);g=parseInt(e.get("glusterTotalSize"),10);d.property.push({name:_T("volume","volume_totalsize"),value:h.SizeRender(parseInt(e.get("size").total,10))});d.property.push({name:_T("volume","volume_usablesize"),value:h.SizeRender(g)});d.property.push({name:_T("volume","volume_usedsize"),value:h.SizeRender(i)});d.property.push({name:_T("volume","volume_freesize"),value:h.SizeRender(g-i)})}else{i=parseInt(e.get("size").used,10);g=parseInt(e.get("size").total,10);d.property.push({name:_T("volume","volume_totalsize"),value:h.SizeRender(g)});d.property.push({name:_T("volume","volume_usedsize"),value:h.SizeRender(i)});d.property.push({name:_T("volume","volume_freesize"),value:h.SizeRender(g-i)})}if(e.get("disk_failure_number")>0&&e.get("progress").step!=="disk_initialize"){d.property.push({name:_T("volume","volume_disk_failure_number"),value:'<span class="red-status">'+e.get("disk_failure_number")+"</span>"})}},prepareRaidGroupInfo:function(h,s){var q=this,o=q.appWin.disks.data,k=q.appWin.hotSpares.data,m=SYNO.SDS.StorageUtils,f=h.get("raids"),p={1:"normal",2:"degrade",4:"crashed"},d,j,e,g,l,r=false;var n=SYNO.SDS.StorageUtils.DiskSort;var c=function(t,i){if(t.slot>i.slot){return 1}if(t.slot<i.slot){return -1}return 0};s.raidInfo=[];f.sort(function(u,t){var w=u.raidPath;var v=t.raidPath;var i=w.substr(7,w.length-7);var x=v.substr(7,v.length-7);i=parseInt(i,10);x=parseInt(x,10);if(i>x){return 1}if(i<x){return -1}return 0});var a=function(i){var t=o[i.id];if(!t){return true}if(t.is4Kn()){r=true}e.push({container:("internal"===t.get("container").type)?_S("hostname"):t.get("container").str,name:t.get("name"),ctnOder:t.get("container").order,numId:t.get("num_id"),size:m.SizeRender(t.get("size_total")),driveType:t.get("isSsd")?"SSD":"HDD",status:m.DiskStatusRender(t.get("status"))})};var b=function(t){var u=o[t.id];var i=k[t.id];if(!u||!i){return true}if(u.is4Kn()!==r){return true}g.push({container:"internal"===u.get("container").type?_S("hostname"):u.get("container").str,name:u.get("name"),ctnOder:u.get("container").order,numId:u.get("num_id"),size:m.SizeRender(u.get("size_total")),driveType:u.get("isSsd")?"SSD":"HDD",status:m.SpareStatusRender(i.get("status").type)})};for(l=0;l<f.length;++l){d=f[l];if(1===f.length){j=""}else{j=p[d.raidStatus]||"";j=String.format("({0})",m.StatusNameRender(j))}d.devices.sort(c);e=[];Ext.each(d.devices,a,q);e.sort(n);g=[];Ext.each(d.spares,b,q);g.sort(n);s.raidInfo.push({disks:e,spares:g,status:j})}},prepareRaidInfo:function(c,b){var d=this,e=d.appWin.disks.data,j=d.appWin.hotSpares.data,i,a,f=SYNO.SDS.StorageUtils,h=[],g=false;b.raidInfo=[];i=[];Ext.each(c.get("disks"),function(k){a=e[k];if(!a){return true}if(a.is4Kn()){g=true}i.push({container:"internal"===a.get("container").type?_S("hostname"):a.get("container").str,name:a.get("name"),size:f.SizeRender(a.get("size_total")),driveType:a.get("isSsd")?"SSD":"HDD",status:f.DiskStatusRender(a.get("status"))})});Ext.each(c.get("spares"),function(k){a=e[k.id];k=j[k.id];if(!a||!k){return true}if(a.is4Kn()!==g){return true}h.push({container:"internal"===a.get("container").type?_S("hostname"):a.get("container").str,name:a.get("name"),size:f.SizeRender(a.get("size_total")),driveType:a.get("isSsd")?"SSD":"HDD",status:f.SpareStatusRender(k.get("status").type)})});b.raidInfo.push({disks:i,spares:h})},prepareDetail:function(f,c){var h=this,i=SYNO.SDS.StorageUtils,g=h.appWin.detailUsage[f.get("id")]||{lun:0,volume:0},k=parseInt(f.get("size").used,10),j=parseInt(f.get("size").total,10),d=i.GetSizeUnit(g.volume),e=i.GetSizeUnit(g.lun),a=i.GetSizeUnit(j-k);var b=function(l){if(0>l.size){l.message=_T("volume","volume_size_calculating")}};b(d);b(e);b(a);c.detailUsage={};j=(0===j)?1:j;c.detailUsage.bar1Width=g.volume/j*100;c.detailUsage.bar2Width=g.lun/j*100;c.illustrate=[{text:_T("volume","volume"),value:d.size,unit:d.unit,message:d.message,hide:0},{text:_T("volume","volume_lun_block_level"),value:e.size,unit:e.unit,message:e.message,hide:("yes"===_D("support_iscsi_target","no"))?0:1},{text:_T("volume","volume_freesize"),value:a.size,unit:a.unit,message:a.message,hide:0}]},repair_system_partition_link_id:undefined,data_scrubbing_link_id:undefined,renderSuggestions:function(g,d){var e,h="",c="",l={};var a=false;var b=false;var m="";var j="";var f=g.get("suggestions");var k=SYNO.SDS.StorageUtils;if(!f||f.length<=0){return}if("system partition failed"===f[0].note){a=true;if(Ext.isDefined(this.repair_system_partition_link_id)){}else{this.repair_system_partition_link_id=Ext.id()}m=String.format('&nbsp<a class="link-font" id="{0}" href="#" space_id={2}>{1}</a>',this.repair_system_partition_link_id,_T("volume","volume_repair_syspart"),g.id)}for(e=0;e<f.length;e++){c=k.FormatSuggestion(f[e]);if(undefined!==f[e].note&&!a){if("need data scrubbing"===f[e].note){l=SYNO.SDS.Utils.clone(f[e]);l.str=c;b=true}else{continue}}else{h+=String.format('<span class="{0}">{1}{2}</span><br>',f[e].type==="warning"?"red-status":"green-status",c,e===0?m:"")}}if(a){if(m){this.mon(this.view.getStore(),"load",function(){var i=Ext.fly(this.repair_system_partition_link_id);this.mon(i,"click",this.repairSysPartition,this)},this,{single:true})}}else{if(b){if(Ext.isDefined(this.data_scrubbing_link_id)){}else{this.data_scrubbing_link_id=Ext.id()}j=String.format('&nbsp<a class="link-font" id="{0}" href="#" space_id={2}>{1}</a>',this.data_scrubbing_link_id,_T("volume","start_raid_scrubbing"),g.id);h+=String.format('<span class="{0}">{1}{2}</span><br>',l.type==="warning"?"red-status":"green-status",l.str,j);if(j){this.mon(this.view.getStore(),"load",function(){var i=Ext.fly(this.data_scrubbing_link_id);this.mon(i,"click",this.onDataScrubbing,this)},this,{single:true})}}}if(""===h){return}d.property.push({name:_T("volume","volume_status_suggest"),value:h})},onActivate:function(){var b=this,a=b.view.store;b.prepareUiData();a.suspendEvents(true);a.loadData(b.uiData,false);a.resumeEvents();b.resetBtnStatus();if(0<b.view.store.getCount()&&0===b.view.getSelectedItemIds().length){b.view.select(0,true,true)}b.onSelectChange();b.setMask()},onSelectChange:function(){var b=this,a=b.view.getSelectedItem();b.getButton("edit").hide();b.getButton("remove").hide();b.getButton("adv_manage").hide();b.getButton("manage").hide();b.getButton("cancel").hide();if(!a){return}b.getButton("remove").show();b.enableButton("remove",b.canDelete(a));if(!b.appWin.supportRaidGroup||-1<a.get("device_type").indexOf("shr")){b.getButton("edit").show();b.enableButton("edit",true);b.getButton("manage").show();b.enableButton("manage",b.canManage(a))}else{b.getButton("adv_manage").show();b.enableButton("adv_manage",b.canManage(a))}if(a.isCreating()||"data_scrubbing"===a.getProgressStep()){b.getButton("cancel").show();b.enableButton("cancel",b.canCancel(a))}},onCreate:function(){var c=this,b,a;b=c.canCreate();if(!b){return}a=(c.appWin.supportRaidGroup)?"AdvCreatePoolMain":"CreatePoolMain";c.openWizard(a,{option:b})},onDelete:function(){var c=this,a,b,d;a=c.view.getSelectedItemIds();if(0===a.length){return}b=c.appWin.storagePools.data[a[0]];if(!b){return}if(b.usedByGlusterFs()){d=String.format(_T("volume","goto_cms_manage_pool"),c.appWin.supportRaidGroup?_T("volume","volume_storage_pool"):_T("volume","volume_pool"));c.owner.getMsgBox().alert(c.title,d);return}c.openWizard("DeletePool",{pool:b})},onManage:function(){var f=this,g,i,k,l,e,b,c,j;var a,d,h;l=f.view.getSelectedItemIds();if(0===l.length){return}e=f.appWin.storagePools.data[l[0]];if(!e){return}g=f.getAvailableDisksForAdd(e);i=f.getAvailableDisksForAdd(e,"expand_by_disk");k=f.getValidAddType(e,g);j=(0<e.get("disk_failure_number"))?true:false;if(e.usedByGlusterFs()&&!k.repair){b=String.format(_T("volume","goto_cms_manage_pool"),f.appWin.supportRaidGroup?_T("volume","volume_storage_pool"):_T("volume","volume_pool"));f.owner.getMsgBox().alert(f.title,b);return}c={title:_T("volume","volume_manage_title"),spaceType:"volume",api:"SYNO.Storage.CGI.Volume",space:e,disks:g,disksForExpand:i,add_type:k,migrate_type:f.getValidMigrateType(e,g),hasFailedDisk:j};a=e.get("deploy_path");d=a?(-1<a.indexOf("volume")):false;h=a?(-1<a.indexOf("iscsilun")):false;if(f.appWin.supportRaidGroup&&"single"===e.get("raidType")&&d){c.spaceType="volume";c.api="SYNO.Storage.CGI.Volume"}else{if(f.appWin.supportRaidGroup&&"single"===e.get("raidType")&&h){c.spaceType="iscsilun";c.api="SYNO.Core.Storage.iSCSILUN"}else{c.spaceType="pool";c.api="SYNO.Storage.CGI.Pool"}}f.openWizard("Manage",c)},onRepair:function(){var f=this,d=f.view.getSelectedItem(),b,e,a,c,g;if(!d){return}if(f.checkRunningvDSM(d)){f.owner.getMsgBox().alert(f.owner.title,_TT("SYNO.SDS.Virtualization.Application","vm","exist_alive_vm_err"));return}b=(d.get("raids"))?d.get("raids")[0].devices[0].id:d.get("disks")[0];e=f.appWin.disks.data[b].get("diskType");if(f.appWin.supportRaidGroup){a=f.getAvailableDisksForAddRaidGroup(d);c=f.getValidAddTypeRaidGroup(d,a)}else{a=f.getAvailableDisksForAdd(d);c=f.getValidAddType(d,a)}if(d.get("can_do")&&d.get("can_do").repair&&!isNaN(d.get("can_do").repair)){g=parseInt(d.get("can_do").repair,10)}else{g=0}f.openWizard("AdvManagePool",{add_type:"repair",pool:d,disks:a,raidType:d.get("raidType"),raidLevel:d.get("device_type"),raidLimitNum:d.get("limited_disk_number"),hddType:e,repair:g,manageType:c,migrateType:f.getValidMigrateType(d,a)})},onDataScrubbing:function(){var b=this,a=b.view.getSelectedItem();if(!a){return}b.openWizard("AdvManagePool",{add_type:"data_scrubbing",raidLimitNum:a.get("limited_disk_number"),pool:a})},onAddDisks:function(){var f=this,c=f.view.getSelectedItem(),a,b,g,e=c.get("raids")[0],d=f.appWin.disks.data[e.devices[0].id].get("diskType");if(!c){return}if(f.checkRunningvDSM(c)){f.owner.getMsgBox().alert(f.owner.title,_TT("SYNO.SDS.Virtualization.Application","vm","exist_alive_vm_err"));return}if(c.usedByGlusterFs()){g=String.format(_T("volume","goto_cms_manage_pool"),f.appWin.supportRaidGroup?_T("volume","volume_storage_pool"):_T("volume","volume_pool"));f.owner.getMsgBox().alert(f.title,g);return}if(f.appWin.supportRaidGroup){a=f.getAvailableDisksForAddRaidGroup(c);b=f.getValidAddTypeRaidGroup(c,a)}else{a=f.getAvailableDisksForAdd(c);b=f.getValidAddType(c,a)}f.openWizard("AdvManagePool",{add_type:"expand_by_disk",pool:c,disks:a,raidType:c.get("raidType"),raidLevel:c.get("device_type"),raidLimitNum:c.get("limited_disk_number"),hddType:d,manageType:b,migrateType:f.getValidMigrateType(c,a)})},onExpand:function(){var b=this,a=b.view.getSelectedItem();if(!a){return}if(b.checkRunningvDSM(a)){b.owner.getMsgBox().alert(b.owner.title,_TT("SYNO.SDS.Virtualization.Application","vm","exist_alive_vm_err"));return}b.openWizard("AdvManagePool",{pool:a,raidLimitNum:a.get("limited_disk_number"),add_type:"expand_with_unalloc_size"})},onMigrate:function(){var f=this,g,c=f.view.getSelectedItem(),a,b,e=c.get("raids")[0],d=f.appWin.disks.data[e.devices[0].id].get("diskType");if(!c){return}if(0<c.get("disk_failure_number")){this.owner.getMsgBox().alert(this.title,_T("volume","volume_migrate_with_failed_disk_alert"));return}if(c.usedByGlusterFs()){g=String.format(_T("volume","goto_cms_manage_pool"),f.appWin.supportRaidGroup?_T("volume","volume_storage_pool"):_T("volume","volume_pool"));f.owner.getMsgBox().alert(f.title,g);return}if(f.checkRunningvDSM(c)){f.owner.getMsgBox().alert(f.owner.title,_TT("SYNO.SDS.Virtualization.Application","vm","exist_alive_vm_err"));return}if(f.appWin.supportRaidGroup){a=f.getAvailableDisksForAddRaidGroup(c);b=f.getValidAddTypeRaidGroup(c,a)}else{a=f.getAvailableDisksForAdd(c);b=f.getValidAddType(c,a)}f.openWizard("AdvManagePool",{add_type:"migrate",pool:c,disks:a,raidType:c.get("raidType"),raidLevel:c.get("device_type"),raidLimitNum:c.get("limited_disk_number"),hddType:d,manageType:b,migrateType:f.getValidMigrateType(c,a)})},onEdit:function(){var b=this,a=b.view.getSelectedItem();if(!a){return}b.openWizard("AdvEditPool",{pool:a})},onCancel:function(){var e=this,b=e.view.getSelectedItem(),h,g,c,d,a,f;if(!b){return}d=b.get("deploy_path");a=d?(-1<d.indexOf("volume")):false;f=d?(-1<d.indexOf("iscsilun")):false;if(e.appWin.supportRaidGroup&&"single"===b.get("raidType")&&a){c="SYNO.Storage.CGI.Volume"}else{if(e.appWin.supportRaidGroup&&"single"===b.get("raidType")&&f){c="SYNO.Core.Storage.iSCSILUN"}else{c="SYNO.Storage.CGI.Pool"}}h=b.get("id");g="cancel_create";e.appWin.stopPollTask();e.owner.setStatusBusy({text:_T("common","saving")});if("data_scrubbing"===b.getProgressStep()){g="cancel_data_scrubbing"}SYNO.API.Request({api:c,method:g,version:1,params:{space_id:h},callback:function(l,k,j,i){this.clearStatusBusy();if(!l){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,k)}this.setStatusBusy();this.cleanMask=true;this.startPollTask()},scope:this.owner})},onSort:function(f,d){var c=this,b,a=c.view.store;if(0>f.itemId.indexOf("_")){return}c.sortType=f.itemId;b=f.itemId.split("_")[1];if(a.sortField!==b){a.sortField=b;a.sortDir="ASC"}else{a.sortDir="ASC"===a.sortDir?"DESC":"ASC"}a.sort(a.sortField,a.sortDir);c.onSelectChange()},openDialog:function(d,b,a){var e;if(this.owner.isUpToBatchTaskCount()){e=_T("volume","volume_max_batch_task_count").replace("_MAX_TASK_",this.owner.getMaxBatchTaskCount());this.owner.getMsgBox().alert(this.title,e,function(){},this);return}var c=new SYNO.SDS.StorageManager.Pool.Dialog[d](Ext.apply({owner:this.owner},b));this.owner.updater.stop();c.mon(c,"close",function(){if(Ext.isFunction(c.hideFromOwner)){c.hideFromOwner()}if(c.isDataChanged){this.owner.setStatusBusy();this.owner.cleanMask=true}this.owner.updater.start()},this,{single:true});c.open(a)},openWizard:function(b,a){var c=this,e;if(c.appWin.isUpToBatchTaskCount()){e=_T("volume","volume_max_batch_task_count").replace("_MAX_TASK_",c.appWin.getMaxBatchTaskCount());c.appWin.getMsgBox().alert(c.title,e,function(){},c);return}var d=new SYNO.SDS.StorageManager.Wizard[b](Ext.apply({appWin:c.appWin,owner:c.owner},a));c.appWin.stopPollTask();c.mon(d,"close",function(){if(Ext.isFunction(d.hideFromOwner)){d.hideFromOwner()}if(d.isDataChanged){c.owner.setStatusBusy();c.body.unmask();c.owner.cleanMask=true}c.appWin.startPollTask()},c,{single:true});d.open()},setFocus:function(a){var b=this;b.view.focusNode(a);b.view.select(a);if(!b.view.expandedItemId[a]){b.view.toggleDetail(Ext.get(a),true)}},getButton:function(a){return this.getTopToolbar().getComponent(a)},enableButton:function(c,a){var b=this.getButton(c);if(!b){throw Error("could not get button of id: "+c)}return a?b.enable():b.disable()},checkRunningvDSM:function(c){var d=this,e=d.appWin.volumes.getAll(),b=SYNO.SDS.StorageUtils,a=[];Ext.each(e,function(f){if(c.get("id")===f.get("pool_path")){a.push(f.get("id"))}},d);if(b.isExistRunningvDSM(e,a)){return true}return false},getAvailableDisksForAdd:function(e,b){var f=this,i=e.get("minimal_disk_size"),a=e.get("container"),g=[],c=[],h=false,d=function(j){if(-1===e.get("device_type").indexOf("shr")||"expand_by_disk"!==b){return j.isBiggerThan(i)}return j.isBiggerThan(i)||j.isEqualToAny(c)};if(!a||!e.get("can_do")){return g}e.get("disks").each(function(j){var k=f.appWin.disks.data[j];if(!k){return true}if(k.is4Kn()){h=true}c.push(parseInt(k.get("size_total"),10))},this);if(e.get("can_do").raid_cross||e.isExpansion()){g=f.appWin.disks.getMatched(function(){var j=this;return j.isNormalTray()&&j.isFree()&&d(j)&&((j.is4Kn()&&h)||(!j.is4Kn()&&!h))})}else{if("internal"===a){g=f.appWin.disks.getMatched(function(){var j=this;return j.isNormalTray()&&j.isFree()&&j.isInternal()&&d(j)&&((j.is4Kn()&&h)||(!j.is4Kn()&&!h))})}else{if("ebox"===a){g=f.appWin.disks.getMatched(function(){var j=this;return j.isFree()&&j.isInEbox()&&d(j)&&((j.is4Kn()&&h)||(!j.is4Kn()&&!h))})}}}return g},getAvailableDisksForAddRaidGroup:function(f){var g=this,k=g.appWin.hotSpares.data,l=f.get("minimal_disk_size"),b=f.get("container"),e=(f.get("raids"))?f.get("raids")[0]:undefined,c="SAS",h=[],m=false,d,a,j=false;if(undefined!==e){if(0===e.devices.length){return h}for(d=0;d<e.devices.length;++d){a=g.appWin.disks.data[e.devices[0].id];if(!a){continue}m=true;c=a.get("diskType");j=a.is4Kn();break}}else{if(f.get("disks")){a=g.appWin.disks.data[f.get("disks")[0]];m=true;c=a.get("diskType");j=a.is4Kn()}}if(!b||!f.get("can_do")||!m){return h}if(f.get("can_do").raid_cross||0===f.get("device_type").indexOf("expansion")){h=g.appWin.disks.getMatched(function(){var i=this;return i.isNormalTray()&&i.isFree()&&i.isBiggerThan(l)&&i.isSameInterface(c)&&!i.inSpare(k)&&((i.is4Kn()&&j)||(!i.is4Kn()&&!j))})}else{if("internal"===b){h=g.appWin.disks.getMatched(function(){var i=this;return i.isNormalTray()&&i.isFree()&&i.isInternal()&&i.isBiggerThan(l)&&((i.is4Kn()&&j)||(!i.is4Kn()&&!j))})}else{if("ebox"===b){h=g.appWin.disks.getMatched(function(){var i=this;return i.isFree()&&i.isInEbox()&&i.isBiggerThan(l)&&((i.is4Kn()&&j)||(!i.is4Kn()&&!j))})}}}return h},getValidAddType:function(f,a){var h=this,g=f.get("can_do"),e,b,d=false,c;if(!g){return{}}b=h.getValidMigrateType(f,a);for(e in b){if(b[e]){d=true;break}}c=h.getAvailableDisksForAdd(f,"expand_by_disk");return{repair:("repair" in g)&&0<a.length,scrubbing:("data_scrubbing" in g),expand_by_disk:("expand_by_disk" in g)&&g.expand_by_disk<=c.length,expand_with_unalloc_size:("expand_with_unalloc_size" in g)&&(parseInt(g.expand_with_unalloc_size,10)>0),migrate:d,expand_unfinished_shr:("expand_unfinished_shr" in g)}},getValidAddTypeRaidGroup:function(f,a){var e=f.get("can_do"),d,b,c=false;if(!e){return{}}b=this.getValidMigrateType(f,a);for(d in b){if(b[d]){c=true;break}}return{repair:("repair" in e)&&0<a.length,data_scrubbing:("data_scrubbing" in e),expand_by_disk:("expand_by_disk" in e)&&e.expand_by_disk<=a.length,expand_with_unalloc_size:("expand_with_unalloc_size" in e)&&parseInt(e.expand_with_unalloc_size,10)>0,migrate:c}},getValidMigrateType:function(f,a){var b,g,d,e=f.get("can_do"),c={};if(!e||!e.migrate){return{}}e=e.migrate;if("to_raid5+spare" in e){b=e["to_raid5+spare"].split("-");g=parseInt(b[0],10);d=parseInt(b[1],10);c["to_raid5+spare"]=(g<=a.length)&&!_S("ha_running")}return Ext.applyIf(c,{add_mirror:("add_mirror" in e)&&0<a.length,to_raid1:("to_raid1" in e)&&0<a.length&&!_S("ha_running"),to_raid5:("to_raid5" in e)&&e.to_raid5<=a.length&&!_S("ha_running"),to_raid6:("to_raid6" in e)&&e.to_raid6<=a.length&&!_S("ha_running")})},repairSysPartition:function(c,b){var a=new Ext.Element(b);var d=a.getAttribute("space_id");this.owner.setStatusBusy();this.owner.updater.stop();SYNO.API.Request({webapi:{api:"SYNO.Storage.CGI.Storage",method:"repair_sys_partition",version:"1",params:{space_id:d}},callback:function(h,e,g,f){this.owner.clearStatusBusy();if(!h){this.owner.getMsgBox().alert(this.title,_T("common","commfail"));this.owner.updater.start();return}if(e.str){this.owner.getMsgBox().alert(this.title,e.str,function(){this.owner.setStatusBusy();this.owner.cleanMask=true;this.owner.updater.start()},this)}else{this.owner.updater.start()}},scope:this})}});Ext.namespace("SYNO.SDS.TaskScheduler.SMART");Ext.define("SYNO.SDS.StorageManager.Wizard.SmartTest",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;b=Ext.apply({title:_T("smart","smart_toolbar_smart_test"),width:650,height:450,minHeight:380,minWidth:560,layout:"fit",dsmStyle:"v5",items:[this.configForm({itemId:"form"})],buttons:[{text:_T("common","alt_close"),handler:function(){this.close();this.pollingTaskStop()},scope:this}]},a);c.callParent([b])},configForm:function(a){var b=Ext.apply({xtype:"syno_formpanel",trackResetOnLoad:true,border:false,items:[{xtype:"syno_fieldset",collapsible:false,title:_T("smart","smart_toolbar_smart_test"),itemId:"testing",synodefaults:{width:200},items:[{xtype:"syno_displayfield",value:_T("smart","smart_test_desc")},{itemId:"quick_radio",xtype:"syno_radio",boxLabel:_T("smart","smart_quick_test"),name:"testStyle",inputValue:"quick",checked:true},{itemId:"extend_radio",xtype:"syno_radio",boxLabel:_T("smart","smart_extend_test"),name:"testStyle",inputValue:"extend"},{xtype:"syno_displayfield",name:"testingStatus"},{xtype:"syno_button",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",itemId:"apply",text:_T("smart","smart_test_button_start"),handler:this.onApply,scope:this}]},{xtype:"syno_fieldset",collapsible:false,itemId:"status",title:_T("smart","smart_test_result"),labelWidth:300,items:[{xtype:"syno_displayfield",name:"quickTestLog",htmlEncode:false,fieldLabel:_T("smart","smart_quick_test_log")},{xtype:"syno_displayfield",name:"extendTestLog",htmlEncode:false,fieldLabel:_T("smart","smart_extend_test_log")}]}]},a);return b},onOpen:function(a){if(!(this.device=a.device)){throw Error("param error: device is not set")}this.TestLogPollingConf={interval:5,immediate:true,webapi:{api:"SYNO.Core.Storage.Disk",version:1,method:"get_smart_test_log",params:{device:this.device}},status_callback:function(e,c,d,b){if(this.cleanMask){this.clearStatusBusy();this.cleanMask=false}if(!e){this.getMsgBox().alert(_T("tree","node_device"),_T("smart","smart_status_unknow"));this.pollingTaskStop();return}this.fillData(c)},scope:this};this.form=this.getComponent("form").getForm();this.btn=this.getComponent("form").getComponent("testing").getComponent("apply");this.radio_quick=this.getComponent("form").getComponent("testing").getComponent("quick_radio");this.radio_extend=this.getComponent("form").getComponent("testing").getComponent("extend_radio");this.setStatusBusy();this.cleanMask=true;this.pollingTaskStart();this.callParent(arguments)},pollingTaskStart:function(){if(this.TestLogPollingID===undefined){this.TestLogPollingID=this.pollReg(this.TestLogPollingConf)}},pollingTaskStop:function(){if(this.TestLogPollingID!==undefined){this.pollUnreg(this.TestLogPollingID);this.TestLogPollingID=undefined}},testing:undefined,quickTime:undefined,extendTime:undefined,cleanMask:false,fillData:function(c){var a=null;var b,d;a=c.testInfo[0];if(a.quick==="completed"){b=_T("volume","volume_status_normal")}else{if(a.quick==="none"||a.quick==="progress"){b=_T("smart","smart_test_log_nodata")}else{if(a.quick==="damage"){b='<font class="red-status">'+_T("smart","smart_status_damage")+"</font>"}else{if(a.quick==="aborted"){b=_T("smart","smart_status_aborted")}else{if(a.quick==="interrupted"){b=_T("smart","smart_status_interrupted")}else{b='<font class="red-status">'+_T("smart","smart_status_unknow")+"</font>"}}}}}if(a.extend==="completed"){d=_T("volume","volume_status_normal")}else{if(a.extend==="none"||a.extend==="progress"){d=_T("smart","smart_test_log_nodata")}else{if(a.extend==="damage"){d='<font class="red-status">'+_T("smart","smart_status_damage")+"</font>"}else{if(a.extend==="aborted"){d=_T("smart","smart_status_aborted")}else{if(a.extend==="interrupted"){d=_T("smart","smart_status_interrupted")}else{d='<font class="red-status">'+_T("smart","smart_status_unknow")+"</font>"}}}}}if(a.quick==="completed"||a.quick==="damage"||a.quick==="aborted"||a.quick==="interrupted"){if(0<c.quick_last.length){b=b+" ("+c.quick_last+")"}}if(a.extend==="completed"||a.extend==="damage"||a.extend==="aborted"||a.extend==="interrupted"){if(0<c.extend_last.length){d=d+" ("+c.extend_last+")"}}this.form.findField("quickTestLog").setRawValue(b);this.form.findField("extendTestLog").setRawValue(d);this.quickTime=a.quickTime;this.extendTime=a.extendTime;this.testing=a.testing;if(this.testing){if(a.remain!=="-1"){this.form.findField("testingStatus").setRawValue(_T("smart","smart_test_remain")+": "+a.remain)}else{this.form.findField("testingStatus").setRawValue(_T("smart","smart_test_remain")+": "+_T("background_task","task_processing"))}this.radio_quick.getEl().findParentNode("").parentNode.style.display="none";this.radio_extend.getEl().findParentNode("").parentNode.style.display="none";this.btn.setText(_T("smart","smart_test_button_stop"))}else{this.form.findField("testingStatus").setRawValue("");this.radio_quick.getEl().findParentNode("").parentNode.style.display="";this.radio_extend.getEl().findParentNode("").parentNode.style.display="";this.btn.setText(_T("smart","smart_test_button_start"))}},onApply:function(){var c="";var b,a;if(this.testing){this.sendStopRequest();return}c=this.form.findField("testStyle").getGroupValue();if(c==="quick"){b=_T("smart","smart_quick_test");a=String.format(_T("smart","smart_test_time"),_T("smart","smart_quick_test"),this.quickTime)}else{if(c==="extend"){b=_T("smart","smart_extend_test");a=String.format(_T("smart","smart_test_time"),_T("smart","smart_extend_test"),this.extendTime)}}this.sendTestRequest(b,a,c)},sendStopRequest:function(){this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.Disk",version:1,method:"do_smart_test",params:{device:this.device,type:"stop"},callback:function(d,b,c,a){this.clearStatusBusy();if(!d){this.getMsgBox().alert(_T("tree","node_device"),_T("common","error_system"));this.pollingTaskStop();return}this.setStatusBusy();this.cleanMask=true;this.sendWebAPI({api:"SYNO.Core.Storage.Disk",version:1,method:"get_smart_test_log",params:{device:this.device},callback:function(h,f,g,e){if(this.cleanMask){this.clearStatusBusy();this.cleanMask=false}if(!h){this.getMsgBox().alert(_T("tree","node_device"),_T("common","error_system"));this.pollingTaskStop();return}this.fillData(f)},scope:this})},scope:this})},sendTestRequest:function(b,a,c){this.getMsgBox().confirm(b,a,function(d){if(d!=="yes"){return}this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.Disk",version:1,method:"do_smart_test",params:{device:this.device,type:c},callback:function(h,f,g,e){this.clearStatusBusy();if(!h){this.getMsgBox().alert(_T("tree","node_device"),_T("smart","smart_selftest_cmd_exec_failed"));this.pollingTaskStop();return}this.setStatusBusy();this.cleanMask=true;this.sendWebAPI({api:"SYNO.Core.Storage.Disk",version:1,method:"get_smart_test_log",params:{device:this.device},callback:function(l,j,k,i){if(this.cleanMask){this.clearStatusBusy();this.cleanMask=false}if(!l){this.getMsgBox().alert(_T("tree","node_device"),_T("common","error_system"));this.pollingTaskStop();return}this.fillData(j)},scope:this})},scope:this})},this)}});Ext.define("SYNO.SDS.StorageManager.Wizard.HealthInfo",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=new SYNO.SDS.Utils.TabPanel({activeTab:0,items:[new SYNO.SDS.StorageManager.HealthOverview(Ext.apply(a,{appWin:this})),new SYNO.SDS.StorageManager.SmartInfo(Ext.apply(a,{appWin:this})),new SYNO.SDS.StorageManager.HealthHistory(Ext.apply(a,{appWin:this}))]});var b=Ext.apply({title:_T("disk_info","disk_health_info")+" - "+a.name,width:700,height:550,minWidth:600,minHeight:550,layout:"fit",items:c,buttons:[{text:_T("common","alt_close"),handler:this.close,scope:this}]},a);this.callParent([b])}});Ext.define("SYNO.SDS.StorageManager.HealthOverview",{extend:"SYNO.ux.Panel",loaded:false,constructor:function(a){this.owner=a.owner;this.appWin=a.appWin;this.device=a.device;this.diskHealth=new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<div style="height:140px;padding-bottom:8px;">','<div class="sm-overview-health-icon sm-overview-health-icon-{status}"></div>','<div class="sm-overview-health-text sm-overview-health-text-{status}">{text}</div>','<div class="sm-overview-health-desc">{desc}</div>',"</div>","</tpl>"),store:this.healthStore=new Ext.data.JsonStore({autoDestroy:true,fields:["status","text","desc"]})});var b=Ext.apply({title:_T("helptoc","logcenter_overview"),border:false,autoFlexcroll:true,items:[this.diskHealth,{xtype:"syno_fieldset",hidden:true,id:this.statistics_field_id=Ext.id(),title:_T("disk_info","disk_health_statistics"),border:false,labelWidth:300,items:[{xtype:"syno_displayfield",id:this.temp_id=Ext.id(),fieldLabel:_T("status","temperature")},{xtype:"syno_displayfield",id:this.poweron_id=Ext.id(),fieldLabel:_T("disk_info","disk_poweron_hours")},{xtype:"syno_displayfield",id:this.retry_id=Ext.id(),fieldLabel:_T("disk_info","disk_retry_ct")},{xtype:"syno_displayfield",htmlEncode:false,id:this.unc_id=Ext.id(),fieldLabel:_T("disk_info","disk_bad_sector_ct")},{xtype:"syno_displayfield",id:this.idnf_id=Ext.id(),fieldLabel:_T("disk_info","disk_identify_failed_ct")},{xtype:"syno_displayfield",htmlEncode:false,id:this.smart_id=Ext.id(),fieldLabel:_T("smart","smart_status")}]},{border:false,xtype:"syno_fieldset",hidden:true,id:this.description_field_id=Ext.id(),title:_T("pkgmgr","pkgmgr_pkg_description"),items:[{xtype:"syno_displayfield",htmlEncode:false,fieldLabel:"",id:this.system_status_desc_id=Ext.id(),hideLabel:true},{xtype:"syno_displayfield",htmlEncode:false,fieldLabel:"",id:this.system_status_id=Ext.id(),hideLabel:true}]}],listeners:{activate:this.onActivate,scope:this}},a);this.callParent([b])},onActivate:function(a){if(this.loaded){return}this.appWin.setStatusBusy();this.appWin.sendWebAPI({api:"SYNO.Storage.CGI.Smart",method:"update_smartctl_db",version:1});this.appWin.sendWebAPI({api:"SYNO.Storage.CGI.Smart",method:"get_health_info",version:1,params:{device:a.device},scope:this,callback:function(d,c){this.appWin.clearStatusBusy();var b=null;if(!d){this.appWin.getMsgBox().alert(_T("helptoc","logcenter_overview"),_T("status","status_not_available"));return}this.loaded=true;this.appWin.healthInfo=c.healthInfo;b=this.appWin.healthInfo.overview;if(!b){this.appWin.getMsgBox().alert(_T("helptoc","logcenter_overview"),_T("status","status_not_available"));return}this.onLoadSuccess(b)}})},onLoadSuccess:function(f){var d={},c=[],e="",b="",g="",a=SYNO.SDS.StorageUtils;g=this.device.substring(5,this.device.length);b=this.owner.disks.data[g].get("temp");Ext.getCmp(this.temp_id).setValue(a.DiskTemperatureRender(b));Ext.getCmp(this.poweron_id).setValue(f.poweron+" "+_T("usbbackup","usbbkp_hour"));Ext.getCmp(this.retry_id).setValue(f.retry);if(true===f.exc_bsthr){Ext.getCmp(this.unc_id).setValue(String.format('<div class="sm-overview-health-text-caution">{0}</div>',f.unc))}else{Ext.getCmp(this.unc_id).setValue(f.unc)}Ext.getCmp(this.idnf_id).setValue(f.idnf);Ext.getCmp(this.smart_id).setValue(a.smartStatusRender(f.smart));Ext.getCmp(this.statistics_field_id).show();if(f.smart==="damage"||f.smart==="danger"){d.status="attention";d.text=_T("volume","volume_danger");d.desc=_T("disk_info","disk_smart_ng_desc")+"<br>"}else{if(true===f.exc_bsthr){d.status="caution";d.text=_T("disk_info","disk_bad_sector_thr_warn");d.desc=_T("disk_info","disk_bad_sector_thr_warn_desc").replace("{0}",f.unc)+"<br>"}else{d.status="healthy";d.text=_T("volume","volume_healthy");d.desc=_T("disk_info","disk_smart_ok_desc")+"<br>"}}c.push(d);this.healthStore.loadData(c);if("0"==f.retry&&"0"==f.unc&&"0"==f.idnf){this.doLayout();return}Ext.getCmp(this.system_status_desc_id).setValue(String.format(_T("disk_info","disk_err_desc"),_T("disk_info","disk_retry_ct"),_T("disk_info","disk_bad_sector_ct"),_T("disk_info","disk_identify_failed_ct"))+"<br>");e=("0"==f.retry)?"":String.format(_T("disk_info","disk_retry_desc"),f.retry,_T("disk_info","disk_retry_ct"))+"<br><br>";e+=("0"==f.unc)?"":String.format(_T("disk_info","disk_bad_sector_desc"),f.unc,_T("disk_info","disk_bad_sector_ct"))+"<br><br>";e+=("0"==f.idnf)?"":String.format(_T("disk_info","disk_identify_failed_desc"),f.idnf,_T("disk_info","disk_identify_failed_ct"))+"<br><br>";Ext.getCmp(this.system_status_id).setValue(e);Ext.getCmp(this.description_field_id).show();this.doLayout()}});SYNO.SDS.StorageManager.monthOffset=0;SYNO.SDS.StorageManager.convertToMonth=function(a){var b=[_JSLIBSTR("extlang","jan").substr(0,3),_JSLIBSTR("extlang","feb").substr(0,3),_JSLIBSTR("extlang","mar").substr(0,3),_JSLIBSTR("extlang","apr").substr(0,3),_JSLIBSTR("extlang","may").substr(0,3),_JSLIBSTR("extlang","jun").substr(0,3),_JSLIBSTR("extlang","jul").substr(0,3),_JSLIBSTR("extlang","aug").substr(0,3),_JSLIBSTR("extlang","sep").substr(0,3),_JSLIBSTR("extlang","oct").substr(0,3),_JSLIBSTR("extlang","nov").substr(0,3),_JSLIBSTR("extlang","dec").substr(0,3)];return b[(a+SYNO.SDS.StorageManager.monthOffset)%12]};Ext.define("SYNO.SDS.StorageManager.HealthHistory",{extend:"SYNO.ux.Panel",constructor:function(a){this.chartData=null;this.owner=a.owner;this.appWin=a.appWin;this.device=a.device;var c={anchor:"100% 30%",border:false,listeners:{resize:{fn:function(){if(null===this.chartData){return}this.drawChart()},scope:this}}};this.UncPanel=new Ext.Panel(c);this.RetryPanel=new Ext.Panel(c);this.IdnfPanel=new Ext.Panel(c);this.ModeCombo=new SYNO.ux.ComboBox({displayField:"display",valueField:"value",value:"single",store:new Ext.data.ArrayStore({fields:["value","display"],data:[["single",_T("disk_info","disk_history_mode_sigle")],["incremental",_T("disk_info","disk_history_mode_incremental")]]}),listeners:{select:{scope:this,fn:this.modeChange}}});var b=Ext.apply({title:_T("disk_info","disk_history_title"),layout:"fit",dsmStyle:"v5",tbar:{cls:"sm-storage-overview-tbar",items:["->",this.ModeCombo]},items:[{type:"container",layout:"anchor",border:false,items:[this.UncPanel,{xtype:"syno_displayfield"},this.RetryPanel,{xtype:"syno_displayfield"},this.IdnfPanel]}],listeners:{activate:this.onActivate,scope:this}},a);this.callParent([b])},onActivate:function(a){if(!this.appWin.healthInfo||!this.appWin.healthInfo.history){this.appWin.getMsgBox().alert(_T("disk_info","disk_history_title"),_T("status","status_not_available"));return}this.chartData=this.appWin.healthInfo.history;this.displayData=this.chartData.single;SYNO.SDS.StorageManager.monthOffset=this.displayData.offset;this.drawChart()},modeChange:function(){var a=this.ModeCombo.value;this.displayData="incremental"==a?this.chartData.incremental:this.chartData.single;this.drawChart()},genTicks:function(){var a=[],b=0;for(b=0;b<12;b++){a.push([b+1,SYNO.SDS.StorageManager.convertToMonth(b)])}return a},genMouseTrack:function(b){var a=SYNO.SDS.StorageManager.convertToMonth(b.x-1)+": "+b.y;if(b.y<0){a+="<br>"+_T("disk_info","disk_history_unc_tooltip")}return a},getChartOpt:function(a){var b={};b={bars:{show:true,lineWidth:0,fillColor:"#0086e5",fillOpacity:1,barWidth:0.5},xaxis:{color:"#505a64",ticks:this.genTicks()},yaxis:{tickDecimals:0,color:"#505a64",autoscaleMargin:1},shadowSize:0,grid:{verticalLines:false,horizontalLines:true,color:"#b4bec8",tickColor:"#d7e1eb",outlineWidth:1,backgroundColor:"#f5faff"},mouse:{track:true,relative:true,trackDecimals:0,lineColor:null,trackFormatter:this.genMouseTrack},title:a.title,titleCls:"health-history-chart-title"};return b},getChartData:function(b){var c;function a(d){return"0"==d.y?"":d.y}c={data:b,markers:{show:true,position:"ct",labelFormatter:a}};return[c]},drawChart:function(){Flotr.draw(this.UncPanel.body.dom,this.getChartData(this.displayData.retry),this.getChartOpt({title:_T("disk_info","disk_retry_ct")}));Flotr.draw(this.RetryPanel.body.dom,this.getChartData(this.displayData.unc),this.getChartOpt({title:_T("disk_info","disk_bad_sector_ct")}));Flotr.draw(this.IdnfPanel.body.dom,this.getChartData(this.displayData.idnf),this.getChartOpt({title:_T("disk_info","disk_identify_failed_ct")}));this.doLayout()}});Ext.define("SYNO.SDS.StorageManager.SmartInfo",{extend:"SYNO.ux.Panel",constructor:function(a){this.owner=a.owner;this.appWin=a.appWin;var b=Ext.apply({title:_T("smart","smart_toolbar_smart_info"),layout:"fit",border:false,items:[this.configGrid({itemId:"grid"})],listeners:{activate:this.onActivate,scope:this}},a);this.callParent([b])},configGrid:function(a){var b=Ext.apply({layout:"fit",border:false,xtype:"syno_gridpanel",columns:[{header:_T("smart","smart_id"),dataIndex:"id",width:50,sortable:false},{id:"name",header:_T("smart","smart_attribute"),dataIndex:"name",width:150,sortable:false},{header:_T("smart","smart_current"),dataIndex:"current",width:75,sortable:false},{header:_T("smart","smart_worst"),dataIndex:"worst",width:75,sortable:false},{header:_T("smart","smart_threshold"),dataIndex:"threshold",width:75,sortable:false},{header:_T("volume","volume_diskstatus"),dataIndex:"status",width:75,sortable:false,renderer:function(c,e,d){if(d.get("name")==="Airflow_Temperature_Cel"){if(d.get("status")==="In_the_past"){return c}}return"OK"===d.get("status")?c:'<font class="red-status"> '+c+" </font>"}},{header:_T("smart","smart_raw"),dataIndex:"raw",width:150,sortable:false}],viewConfig:{forceFit:true},enableHdMenu:false,autoExpandColumn:"name",sm:new Ext.grid.RowSelectionModel(),store:new Ext.data.JsonStore({root:"smartInfo",fields:["id","name","current","worst","threshold","status","raw"]})},a);return b},onActivate:function(){var a=this.getComponent("grid");if(!this.appWin.healthInfo||!this.appWin.healthInfo.smartInfo){this.appWin.getMsgBox().alert(_T("smart","smart_toolbar_smart_info"),_T("status","status_not_available"));return}a.getStore().loadData(this.appWin.healthInfo)}});Ext.define("SYNO.SDS.StorageManager.Wizard.TaskPanel",{extend:"SYNO.ux.EditorGridPanel",btnEdit:null,btnDel:null,btnRun:null,constructor:function(a){var b=this.fillConfig(a);this.callParent([Ext.apply(b,a)]);this.mon(this.getSelectionModel(),"selectionchange",this.onSelectionChange,this);this.btnEdit=this.getTopToolbar().getComponent("edit");this.btnDel=this.getTopToolbar().getComponent("delete");this.btnRun=this.getTopToolbar().getComponent("run");this.btnSave=this.getTopToolbar().getComponent("save");this.mon(this.enableColumn,"click",this.onChgSaveBtnStat,this);this.mon(this,"headerclick",this.onChgSaveBtnStat,this);this.loadData()},fillConfig:function(a){this.appWin=a.appWin;this.enableColumn=new SYNO.ux.EnableColumn({header:_T("common","enabled"),dataIndex:"enabled",width:50,align:"center",enableFastSelectAll:true});this.columnModel=new Ext.grid.ColumnModel([this.enableColumn,{header:_T("localbkp","localbkp_bkpset_name"),dataIndex:"task_name",renderer:function(d){var c=Ext.util.Format.htmlEncode(d);return'<div ext:qtip="'+Ext.util.Format.htmlEncode(c)+'">'+c+"</div>"},sortable:true},{header:_T("common","action"),dataIndex:"action",renderer:function(c){return c.replace(/#(.*?):(.*?)#/g,function(d,f,e){return _T(f,e)})}},{header:_T("schedule","next_trigger_time"),dataIndex:"next_trigger_time",align:"center",sortable:true}]);this.taskStore=new SYNO.API.Store({api:"SYNO.Storage.CGI.Smart.Scheduler",method:"list",version:1,appWindow:this.appWin,reader:new Ext.data.JsonReader({root:"items",totalProperty:"total"},["enabled","id","can_run","task_name","app_name","simple_edit_form","edit_form","edit_app","action","next_trigger_time"]),sortInfo:{field:"id",direction:"ASC"},remoteSort:false,pruneModifiedRecords:true});this.toolbar=new Ext.Toolbar({defaultType:"syno_button"});this.toolbar.add({text:_T("common","create"),itemId:"create",handler:this.onCreate,scope:this},{text:_T("common","alt_edit"),itemId:"edit",disabled:true,handler:this.onEdit,scope:this},{text:_T("common","delete"),itemId:"delete",disabled:true,handler:this.onDelete,scope:this},{text:_T("common","save"),itemId:"save",disabled:true,handler:this.onSave,scope:this},{text:_T("common","run"),itemId:"run",disabled:true,handler:this.onRun,scope:this});var b={title:_T("schedule","task_scheduler"),header:false,cm:this.columnModel,ds:this.taskStore,height:225,tbar:this.toolbar,autoScroll:true,selModel:new Ext.grid.RowSelectionModel(),plugins:[this.enableColumn]};Ext.apply(b,a);return b},onChgSaveBtnStat:function(){this.setSaveButton(!_S("demo_mode")&&this.isDirty())},isDirty:function(){return this.getStore().getModifiedRecords().length>0},setSaveButton:function(a){this.btnSave[a?"enable":"disable"]()},onSelectionChange:function(){var b=this.getSelectionModel();var a=b.getCount();if(0<a){this.btnDel.enable();this.btnRun.enable()}else{this.btnDel.disable();this.btnRun.disable()}if(1==a){this.btnEdit.enable()}else{this.btnEdit.disable()}},loadData:function(){this.taskStore.removeAll();this.taskStore.load();this.onChgSaveBtnStat()},onOpenEditDialog:function(b){var a=new SYNO.SDS.StorageManager.Wizard.EditDialog({owner:this.owner,owner_grid:this,schedule_id:b,basic_limitation:false});a.open()},onCreate:function(){this.onOpenEditDialog(-1)},onEdit:function(){var b=this.getSelectionModel();var a=b.getSelections();this.onOpenEditDialog(a[0].id)},onSave:function(){if(0===this.getStore().getModifiedRecords().length){return}this.btnSave.disable();var c=[];for(var a=0;a<this.getStore().getModifiedRecords().length;++a){c.push({id:this.getStore().getModifiedRecords()[a].data.id,enabled:this.getStore().getModifiedRecords()[a].data.enabled})}var b={tasks:c};this.getStore().commitChanges();this.owner.setStatusBusy();this.appWin.sendWebAPI({api:"SYNO.Storage.CGI.Smart.Scheduler",method:"change_state",version:1,params:b,scope:this,callback:function(e,d){this.loadData();this.owner.clearStatusBusy()}})},onDelete:function(){var c=this.getSelectionModel().getSelections();var a=[];var f=[];for(var e=0;e<c.length;e++){var b=c[e].data;a.push(b.task_name);f.push(b.id)}var d=new SYNO.SDS.StorageManager.Wizard.TaskPanel.DeleteTaskDialog({owner:this.owner,grid:this,tasks:a.join(", "),taskids:f});d.open()},onRun:function(){var c=this.getSelectionModel();var a=c.getSelections();var d=":";for(var b=0;b<a.length;++b){if(0!==b){d+=","}d+=" "+a[b].data.task_name}this.owner.getMsgBox().confirm(_T("schedule","run_task"),_T("schedule","confirm_run_task")+d,this.runTasks,this)},runTasks:function(c){if("no"===c){return}var d=this.getSelectionModel();var a=d.getSelections();var f=[];var b=0;for(b=0;b<a.length;++b){f.push(a[b].id)}var e={tasks:f};this.owner.setStatusBusy();this.appWin.sendWebAPI({api:"SYNO.Storage.CGI.Smart.Scheduler",method:"run",version:1,params:e,scope:this,callback:function(){this.loadData();this.owner.clearStatusBusy()}})}});Ext.define("SYNO.SDS.StorageManager.Wizard.TaskPanel.DeleteTaskDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(b){var a=this.fillConfig(b);this.deletetaskids=b.taskids;this.callParent([a])},fillConfig:function(b){var a={title:_T("schedule","title_dialog_delete"),closable:false,width:420,height:150,layout:"fit",items:[{xtype:"syno_formpanel",border:false,items:[{xtype:"syno_displayfield",htmlEncode:false,value:_T("schedule","confirm_delete_task")+"<br>"+b.tasks}]}],buttons:[{xtype:"syno_button",btnStyle:"red",text:_T("common","delete"),scope:this,handler:this.onOK},{xtype:"syno_button",btnStyle:"gray",text:_T("common","cancel"),scope:this,handler:this.close}]};return Ext.apply(a,b)},onOK:function(){var a={tasks:this.deletetaskids};this.setStatusBusy();this.sendWebAPI({api:"SYNO.Storage.CGI.Smart.Scheduler",method:"delete",version:1,params:a,scope:this,callback:function(){this.grid.loadData();this.clearStatusBusy()}});this.close()}});Ext.define("SYNO.SDS.StorageManager.Wizard.EditDialog",{extend:"SYNO.SDS.ModalWindow",EditPanelBasic:null,EditPanelSchedule:null,constructor:function(b){var a=this.fillConfig(b);this.callParent([a])},fillConfig:function(c){this.EditPanelBasic=new SYNO.SDS.StorageManager.Disk.Dialog.EditBasicPanel({});this.EditPanelSchedule=new SYNO.SDS.TaskScheduler2.EditSchedulePanel({needTitle:true});var b=new SYNO.ux.TabPanel({activeTab:0,height:400,items:[this.EditPanelBasic,this.EditPanelSchedule]});var a={title:(-1==c.schedule_id)?_T("schedule","create_task"):_T("schedule","edit_task"),width:550,minWidth:550,autoHeight:true,items:b,dsmStyle:"v5",buttons:[{text:_T("common","apply"),scope:this,btnStyle:"blue",handler:this.onClickOK},{text:_T("common","cancel"),scope:this,btnStyle:"gray",handler:this.onClickCancel}]};Ext.apply(a,c);return a},onClickOK:function(){if(!this.EditPanelBasic.isValid()||!this.EditPanelSchedule.isValid()){return}var a={basic:this.EditPanelBasic.getData(),schedule:this.EditPanelSchedule.getData(),app:this.EditPanelBasic.getData()};a.schedule=this.scheduleToOld(a.schedule);this.setStatusBusy();this.sendWebAPI({api:"SYNO.Storage.CGI.Smart.Scheduler",method:"set",version:1,params:a,scope:this,callback:this.applyDone})},applyDone:function(b,a){this.clearStatusBusy();this.owner_grid.loadData();this.close()},onClickCancel:function(){this.close()},onOpen:function(){this.loadTask(this.schedule_id);this.callParent(arguments)},loadTask:function(a){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Storage.CGI.Smart.Scheduler",method:"get",version:1,params:{id:a},scope:this,callback:function(c,b){this.clearStatusBusy();if(!c){this.getMsgBox().alert(_T("schedule","load_task"),_T("schedule","load_task_error"),function(){this.close()},this);return}this.EditPanelBasic.setDataBasic(b.task[0].basic);this.EditPanelBasic.setDataApp(b.task[0].app);this.EditPanelSchedule.setData(this.scheduleToNew(b.task[0].schedule))}})},scheduleToNew:function(a){if(a.hasOwnProperty("week_name")){a.week_day=a.week_name;delete a.week_name}if(a.hasOwnProperty("repeat")){a.repeat_data=a.repeat;a.repeat_date=a.repeat;delete a.repeat}if(a.hasOwnProperty("min")){a.minute=a.min;delete a.min}return a},scheduleToOld:function(a){if(a.hasOwnProperty("week_day")){a.week_name=a.week_day;delete a.week_day}if(a.hasOwnProperty("repeat_data")){a.repeat=a.repeat_data;delete a.repeat_data}if(a.hasOwnProperty("minute")){a.min=a.minute;delete a.minute}if(a.hasOwnProperty("repeat_date")){a.repeat=a.repeat_date;delete a.repeat_date}return a}});Ext.define("SYNO.SDS.StorageManager.Disk.Dialog.EditBasicPanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a=this.fillConfig(b);this.callParent([a])},fillConfig:function(b){this.owner_store=new Ext.data.Store({reader:new Ext.data.JsonReader({root:"owner_store"},["display"])});this.disk_store=new Ext.data.Store({sortInfo:{field:"device",direction:"ASC"},remoteSort:false,reader:new Ext.data.JsonReader({root:"disk_store"},["device","longName"])});var a={title:_T("schedule","basic_info"),items:[{xtype:"syno_fieldset",title:_T("vpnc","basic_setting"),items:[{xtype:"syno_textfield",allowBlank:false,emptyText:"Task name",id:this.task_name_id=Ext.id(),fieldLabel:_T("localbkp","localbkp_bkpset_name"),name:"task_name",width:200,itemId:"task_name",validator:function(c){return c==Ext.util.Format.stripTags(c)}},{xtype:"hidden",name:"id"},{xtype:"syno_combobox",hidden:true,triggerAction:"all",width:200,id:this.task_owner_id=Ext.id(),listWidth:200,fieldLabel:_T("common","owner"),name:"owner",hiddenName:"owner",itemId:"owner",editable:false,valueField:"display",displayField:"display",disabled:true,mode:"local",store:this.owner_store},{xtype:"syno_checkbox",hidden:true,boxLabel:_T("common","enabled"),name:"enabled",itemId:"enabled"}]},{xtype:"syno_fieldset",title:_T("schedule","smart_schedule_type"),items:[{xtype:"syno_radio",boxLabel:_T("smart","smart_quick_test"),id:this.test_style_quick=Ext.id(),name:"test_style",inputValue:"quick"},{xtype:"syno_radio",boxLabel:_T("smart","smart_extend_test"),id:this.test_style_extend=Ext.id(),name:"test_style",inputValue:"extend"}]},{xtype:"syno_fieldset",title:_T("schedule","smart_schedule_range"),items:[{xtype:"syno_radio",boxLabel:_T("schedule","smart_schedule_apply_all"),id:this.test_range_all=Ext.id(),name:"test_range",inputValue:"all",handler:this.Changed,scope:this},{xtype:"syno_radio",boxLabel:_T("schedule","smart_schedule_apply_sel"),id:this.test_range_sel=Ext.id(),name:"test_range",inputValue:"sel",scope:this},{xtype:"syno_superboxselect",hideLabel:true,fieldLabel:"",displayField:"longName",id:this.selected_disks_id=Ext.id(),resizable:true,valueField:"device",name:"selected_disks",triggerAction:"all",mode:"local",store:this.disk_store}]}]};Ext.apply(a,b);return a},Changed:function(d,c){if(c){Ext.getCmp(this.selected_disks_id).setDisabled(true)}else{Ext.getCmp(this.selected_disks_id).setDisabled(false)}},getData:function(){return this.getForm().getValues()},setDataBasic:function(a){this.owner_store.loadData(a);this.getForm().setValues(a)},setDataApp:function(a){this.disk_store.loadData(a);if("quick"===a.test_style){Ext.getCmp(this.test_style_quick).setValue(true)}else{Ext.getCmp(this.test_style_extend).setValue(true)}if("all"===a.test_range){Ext.getCmp(this.test_range_all).setValue(true)}else{Ext.getCmp(this.test_range_sel).setValue(true)}if(a.selected_disks){Ext.getCmp(this.selected_disks_id).setValue(a.selected_disks)}},isValid:function(){if("all"===this.getForm().getValues().test_range&&Ext.getCmp(this.task_name_id).isValid()){return true}else{if(""===Ext.getCmp(this.selected_disks_id).getValue()){this.owner.setStatusError({text:_T("volume","volume_add_warningnodisk"),clear:true});return false}else{return true}}}});Ext.define("SYNO.SDS.StorageManager.Wizard.SecureErase",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.device=a.device;c.owner=a.owner;c.appWin=a.appWin;b=Ext.apply({title:_T("disk_info","disk_secure_erase"),width:550,height:350,minWidth:550,minHeight:350,dsmStyle:"v5",layout:"fit",items:[{xtype:"syno_formpanel",border:false,items:[{xtype:"syno_displayfield",htmlEncode:false,value:String.format(_T("disk_info","disk_secure_erase_desc"),a.erase_time)},{xtype:"syno_checkbox",htmlEncode:false,boxLabel:String.format('<span class="red-status">{0}</span>',_T("disk_info","disk_secure_erase_confirm")),listeners:{check:{scope:this,fn:this.onCheckboxCheck}}}]}],buttons:[{text:_T("common","delete"),itemId:"delete",scope:this,disabled:true,btnStyle:"red",handler:this.onClickDel},{text:_T("common","cancel"),scope:this,btnStyle:"gray",handler:this.onClickCancel}]},a);c.callParent([b])},onClickDel:function(){var a=this;SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(a,a.onSecureEraseCheck)},onClickCancel:function(){this.close()},onCheckboxCheck:function(c,b){var a=this.getFooterToolbar().getComponent("delete");a.setDisabled(!b)},onSecureEraseCheck:function(){var a={device:this.device};this.setStatusBusy();this.sendWebAPI({api:"SYNO.Storage.CGI.Smart",method:"secure_erase",version:1,params:a,scope:this,callback:function(d,c){var b=function(){this.clearStatusBusy();this.close()}.createDelegate(this);this.isDataChanged=true;setTimeout(b,1000)}})}});Ext.define("SYNO.SDS.StorageManager.Disk.Object",{check:SYNO.SDS.StorageUtils.check,get:function(a){if(this.json){return this.json[a]}return undefined},isFree:function(){var b=this.get("status");var a=this.get("container");if("ebox"===a.type&&0===a.order){return false}if(true===this.get("is_erasing")){return false}if(0===b.indexOf("system_crashed")&&""===this.get("used_by")){return true}if(""!==this.get("used_by")){return false}return"not_use"===b||"sys_partition_normal"===b},isBiggerThan:function(a){return a<=parseInt(this.get("size_total"),10)},isInternal:function(){return"internal"===this.get("container").type},isInEbox:function(){return"ebox"===this.get("container").type},isSameInterface:function(a){return a===this.get("diskType")},inSpare:function(b){var a=false;if(b.length){Ext.each(b,function(c){if(c.id===this.id){a=true;return false}},this);return a}return(this.id in b)},notUsedBySpace:function(){var a=this.get("status");if(0===a.indexOf("system_crashed")&&""===this.get("used_by")){return true}if(""!==this.get("used_by")&&"hotspare"!==this.get("used_by")){return false}return"not_use"===a||"sys_partition_normal"===a},isSSD:function(){if("yes"===_D("sata_as_cache","no")){return true}return this.get("isSsd")},isSupported:function(){if("no"===_D("strict_ssd_policy","no")){return true}return this.get("support")},isNormalTray:function(){return("normal"===this.get("portType"))},isCacheTray:function(){return("cache"===this.get("portType"))},canBeSpare:function(){if(true===this.get("is_erasing")){return false}return("esata"!==this.get("portType"))},isEqualToAny:function(a){var c,b;c=parseInt(this.get("size_total"),10);for(b=0;b<a.length;++b){if(a[b]===c){return true}}return false},is4Kn:function(){return this.get("is4Kn")}});Ext.define("SYNO.SDS.StorageManager.Disk.Store",{extend:"Ext.data.JsonStore",constructor:function(a){var c=this,b;b={autoDestroy:true,idProperty:"id",fields:["numId","id","iconCls","statusIconCls","displayName","displayNameHashValue","desc","usage","barWidth","summaryStatus","property","raidInfo","detailUsage","illustrate","status","sizeTotal","sizeFree","firmware","model","totalSize","displayTotalSize","temp","diskType","smartStatus","diskStatus","usedBy","is4Kn","serial","trayStatus","allowJoin","ctnOder"]};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.StorageManager.Disk.Main",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(a){var d=this,c,b;d.appWin=a.appWin;d.owner=a.appWin;b=[new SYNO.SDS.StorageManager.Disk.DiskPanel({appWin:d.appWin,owner:d.owner}),new SYNO.SDS.StorageManager.Disk.LogPanel({appWin:d.appWin,owner:d.owner}),new SYNO.SDS.StorageManager.Disk.SmartScheduler({appWin:d.appWin,owner:d.owner}),new SYNO.SDS.StorageManager.Disk.HddMgr({appWin:d.appWin,owner:d.owner})];c={useDefaultBtn:false,appWin:d.appWin,owner:d.owner,itemId:"disk",activeTab:0,items:b,listeners:{activate:d.onActivate,scope:d}};this.callParent([c])},getHelpParam:function(){return"StorageManager/disk.html"},onActivate:function(){this.getComponent("diskPanel").onActivate()}});Ext.define("SYNO.SDS.StorageManager.Disk.DiskPanel",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b,d=[];c.appWin=a.appWin;c.owner=a.owner;if("yes"===_D("supportsmart","no")){d.push({itemId:"health_info",text:_T("disk_info","disk_health_info"),handler:this.onHealthInfo,disabled:true,scope:this},{itemId:"smart_test",text:_T("smart","smart_toolbar_smart_test"),handler:this.onSmartTest,disabled:true,scope:this})}if("no"===_D("support_dual_head","no")){d.push({itemId:"secure_erase",text:_T("disk_info","disk_secure_erase"),handler:c.onSecureErase,disabled:true,scope:c})}d.push({itemId:"port_enable",text:_T("disk_info","disk_en"),handler:c.onPortEnable,disabled:false,hidden:true,scope:c},"->",{itemId:"gridShowColMenu",menu:c.colMenu=c.onCreateColMenu(),cls:"btn-dropdown",iconCls:"icon-dropdown",hidden:true,scope:c},{cls:"sm-viewmode-btn",xtype:"syno_statebuttongroup",itemId:"display_button_group",activeBtn:0,buttons:[{itemId:"listViewBtn"},{itemId:"gridViewBtn"}],listeners:{scope:c,activebuttonchange:function(e,g){var f=g.itemId;if("listViewBtn"===f){c.layout.setActiveItem(0);c.getButton("gridShowColMenu").hide()}else{c.layout.setActiveItem(1);c.getButton("gridShowColMenu").show()}c.onActivate()}}});c.listView=new SYNO.SDS.StorageManager.Disk.DiskListViewPanel({appWin:c.appWin,owner:c});c.gridView=new SYNO.SDS.StorageManager.Disk.DiskGridViewPanel({appWin:c.appWin,owner:c});b={title:_T("disk_info","disk_disks"),border:false,layout:"card",frame:false,hideMode:"offsets",region:"center",itemId:"diskPanel",tbar:{defaultType:"syno_button",items:d},activeItem:0,items:[c.listView,c.gridView],listeners:{activate:c.onActivate,scope:c}};c.callParent([Ext.apply(b,a)])},onActivate:function(){this.loadUiData()},loadUiData:function(){var b=this,c=b.layout.activeItem,a=c.store;b.prepareUiData();a.suspendEvents(true);a.loadData(b.uiData,false);a.resumeEvents();if(0<a.getCount()&&0===c.getSelectedItemIds().length){c.select(0,true,true)}b.onSelectChange()},prepareUiData:function(){var b=this,c,a=(0===b.appWin.disks.count)?[]:b.appWin.disks.getAll();delete b.uiData;b.uiData=[];Ext.each(a,function(d){c={};if("disabled"===d.get("portType")){b.preparePort(d,c)}else{b.prepareSummary(d,c);b.prepareProperty(d,c)}b.uiData.push(c)},b);b.uiData.sort(SYNO.SDS.StorageUtils.DiskSort)},prepareSummary:function(a,d){var f=this,h=SYNO.SDS.StorageUtils,b=a.get("container"),i=h.GetSizeUnit(parseInt(a.get("size_total"),10)),e,g,c;d.id=a.get("id");d.numId=parseInt(a.get("num_id"),10);d.ctnOder=parseInt(b.order,10);d.displayNameHashValue=d.ctnOder*1000+d.numId;d.totalSize=i.size;if(a.isCacheTray()){d.displayName=_T("volume","dedicated_ssd_cache")}else{d.displayName=SYNO.SDS.Utils.StorageUtils.UiRenderHelper.DiskNameRenderer(a.get("name"))}g=String.format("{0} {1}",d.totalSize,i.unit);if(f.appWin.supportSas){c=String.format("{0} / {1}",a.get("diskType"),(a.get("isSsd"))?"SSD":"HDD")}else{c=(a.get("isSsd"))?"SSD":"HDD"}e=("hotspare"===a.get("used_by"))?"hotspare":a.get("status");d.summaryStatus=String.format("&nbsp;-&nbsp;{0}",h.DiskSummaryStatusRender(e,a.get("smart_status")));d.displayTotalSize=g;d.diskType=c;d.vendor=a.get("vendor");d.model='<span class="allowDefCtxMenu selectabletext">'+a.get("model")+"</span>";d.desc=String.format("{0} {1}, {2} {3}",d.vendor,d.model,g,c);d.iconCls="sm-list-icon-disk";if(d.summaryStatus.match("Erasing")||d.summaryStatus.match("Progress")){d.statusIconCls="sm-list-status-icon-acting"}else{if(d.summaryStatus.match("red-status")||d.summaryStatus.match("orange-status")){d.statusIconCls="sm-list-status-icon-crashed"}}},prepareProperty:function(f,e){var d=this,a=SYNO.SDS.StorageUtils,c=("hotspare"===f.get("used_by"))?"hotspare":f.get("status"),b,g;e.property=[];e.property.push({name:_T("volume","volume_expansion"),value:("internal"===f.get("type"))?_S("hostname"):f.get("container").str});e.usedBy=a.SpaceIDParser(f.get("used_by")).str||"-";e.property.push({name:d.appWin.supportRaidGroup?_T("volume","volume_storage_pool"):_T("volume","volume"),value:e.usedBy});e.diskStatus=a.DiskStatusRender(c);e.property.push({name:_T("volume","volume_diskstatus"),value:e.diskStatus});e.smartStatus=a.smartStatusRender(f.get("smart_status"));if("yes"===_D("supportsmart","no")){e.property.push({name:_T("smart","smart_status"),value:e.smartStatus})}if(0===f.get("temp")){e.temp=_T("common","loading")}else{e.temp=a.DiskTemperatureRender(f.get("temp"))}e.property.push({name:_T("status","temperature"),value:e.temp});b=(!f.get("serial"))?_T("common","loading"):f.get("serial");e.serial=b;e.property.push({name:_T("smart","smart_disk_serial"),value:'<span class="allowDefCtxMenu selectabletext">'+b+"</span>"});g=(!f.get("firm"))?_T("common","loading"):f.get("firm");e.firmware=g;e.property.push({name:_T("smart","smart_disk_firmware"),value:g});e.is4Kn=f.get("is4Kn")?_T("common","yes"):_T("common","no");e.property.push({name:_T("volume","4k_hdd"),value:e.is4Kn})},preparePort:function(a,b){b.id=a.get("id");b.numId=parseInt(a.get("num_id"),10);b.ctnOder=0;b.displayName=String.format("{0} {1}",_T("volume","volume_disk"),a.get("num_id"));b.summaryStatus=String.format('&nbsp;-&nbsp;<span class="red-status">'+_T("disk_info","disk_disable_title")+"</span>");b.iconCls="sm-list-icon-disk";b.model="-";b.displayTotalSize="-";b.temp="-";b.diskType="-";b.smartStatus="-";b.diskStatus=String.format('<span class="red-status">{0}</span>',_T("disk_info","disk_disable_title"));b.usedBy="-";b.is4Kn="-"},getButton:function(a){return this.getTopToolbar().getComponent(a)},isLastSystemDisk:function(d){var c=0,a=this.layout.activeItem.store,b=0;for(b=0;b<a.getCount();b++){var e=a.data.items[b].id;if(true===this.appWin.disks.data[e].get("has_system")){c=c+1}}if(1==c&&true===d.get("has_system")){return true}return false},onSelectChange:function(){var a=this,b=a.layout.activeItem.getSelectedItem();if(!b){return}if("disabled"===b.get("portType")){a.getButton("port_enable").show();if("yes"===_D("supportsmart","no")){Ext.each(["smart_test","health_info"],function(c){a.getButton(c).hide()},a)}if("no"===_D("support_dual_head","no")){a.getButton("secure_erase").hide()}return}a.getButton("port_enable").hide();if("no"===_D("support_dual_head","no")){a.getButton("secure_erase").show();if(true===b.get("is_erasing")){a.getButton("secure_erase").setTooltip(_T("disk_info","disk_secure_erasing"));a.getButton("secure_erase").disable()}else{if(true===b.get("disable_secera")){a.getButton("secure_erase").setTooltip(_T("disk_info","disk_cant_erase_not_support"));a.getButton("secure_erase").disable()}else{if(0>=b.get("erase_time")){a.getButton("secure_erase").setTooltip(_T("disk_info","disk_cant_erase_not_support"));a.getButton("secure_erase").disable()}else{if(!a.appWin.supportSas&&("ebox"===b.get("container").type)){a.getButton("secure_erase").setTooltip(_T("disk_info","disk_cant_erase_eunit"));a.getButton("secure_erase").disable()}else{if(this.isLastSystemDisk(b)){a.getButton("secure_erase").setTooltip(_T("disk_info","disk_cant_erase_last_system"));a.getButton("secure_erase").disable()}else{if(!b.isFree()){a.getButton("secure_erase").setTooltip(_T("disk_info","disk_cant_erase_on_volume"));a.getButton("secure_erase").disable()}else{a.getButton("secure_erase").setTooltip("");a.getButton("secure_erase").enable()}}}}}}}if("yes"===_D("supportsmart","no")){Ext.each(["smart_test","health_info"],function(c){a.getButton(c).show();a.getButton(c).enable()},a);if("SAS"===b.get("diskType")){a.getButton("smart_test").setText(_T("volume","sas_test"));a.getButton("health_info").hide()}else{a.getButton("smart_test").setText(_T("smart","smart_toolbar_smart_test"));a.getButton("health_info").show()}if("unknown"===b.get("smart_status")||true===b.get("is_erasing")){a.getButton("smart_test").disable();a.getButton("health_info").disable()}if(null!==b.get("smart_status").match("%")||-1===b.get("smart_status")){a.getButton("secure_erase").disable()}}},onSmartTest:function(){var a=this,b=a.layout.activeItem.getSelectedItem();if(!b||"yes"!==_D("supportsmart","no")){return}this.openWizard("SmartTest",{device:b.get("device")})},onHealthInfo:function(){var a=this,b=a.layout.activeItem.getSelectedItem();if(!b||"yes"!==_D("supportsmart","no")){return}this.openWizard("HealthInfo",{device:b.get("device"),name:b.get("name")})},onSecureErase:function(){var a=this,b=a.layout.activeItem.getSelectedItem();if(!b){return}this.openWizard("SecureErase",{device:b.get("device"),erase_time:b.get("erase_time")})},openWizard:function(b,a){var c=this,e;if(c.appWin.isUpToBatchTaskCount()){e=_T("volume","volume_max_batch_task_count").replace("_MAX_TASK_",c.appWin.getMaxBatchTaskCount());c.appWin.getMsgBox().alert(c.title,e,function(){},c);return}var d=new SYNO.SDS.StorageManager.Wizard[b](Ext.apply({appWin:c.appWin,owner:c.owner},a));c.mon(d,"close",function(){if(Ext.isFunction(d.hideFromOwner)){d.hideFromOwner()}if(d.isDataChanged){c.appWin.stopPollTask();c.appWin.setStatusBusy();c.appWin.cleanMask=true;c.appWin.startPollTask()}},c,{single:true});d.open(a)},onPortEnable:function(){var a=this,b=a.layout.activeItem.getSelectedItem();if(!b||"disabled"!==b.get("portType")){return}a.appWin.stopPollTask();a.appWin.setStatusBusy();a.appWin.cleanMask=true;this.sendWebAPI({api:"SYNO.Core.Polling.Data",version:1,method:"set",params:{disk_name:b.get("id")},callback:function(){a.appWin.cleanMask=true},scope:a});setTimeout(function(){a.appWin.startPollTask()},5000)},onCreateColMenu:function(){var b=this,a=new SYNO.ux.Menu();a.on({scope:b,beforeshow:b.beforeColMenuShow,itemclick:b.handleHdMenuClick});return a},beforeColMenuShow:function(){var c=this;var a=c.gridView.colModel;c.colMenu.removeAll();for(var b=0;b<a.getColumnCount();b++){if(a.config[b].hideable!==false){c.colMenu.add(new Ext.menu.CheckItem({text:a.getColumnHeader(b),itemId:"col-"+a.getColumnId(b),checked:!a.isHidden(b),disabled:a.config[b].hideable===false,hideOnClick:false}))}}},handleHdMenuClick:function(d){var c=this;var b=c.gridView.colModel;var e=d.getItemId();var a=b.getIndexById(e.substr(4));if(a!=-1){if(d.checked&&b.getColumnsBy(c.gridView.view.isHideableColumn,c).length<=1){return}b.setHidden(a,d.checked)}}});Ext.define("SYNO.SDS.StorageManager.Disk.DiskListViewPanel",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.store=new SYNO.SDS.StorageManager.Disk.Store();c.createView();b={border:false,layout:"fit",itemId:"diskListViewPanel",items:c.view};c.callParent([Ext.apply(b,a)])},createView:function(){var d=this,c=SYNO.SDS.StorageManager.PropertyTpl(),b,a;b=new Ext.XTemplate('<div class="item-detail-inner">',c.html,"</div>");a={appWin:d.appWin,owner:d,dataType:"disks",itemId:"diskListView",multiSelect:false,singleSelect:true,detailTpl:b,store:d.store,listeners:{selectionchange:d.owner.onSelectChange,scope:d.owner}};d.view=new SYNO.SDS.StorageManager.DataView(a)},getSelectedItem:function(){return this.view.getSelectedItem()},getSelectedItemIds:function(){return this.view.getSelectedItemIds()},select:function(){this.view.select.apply(this.view,arguments)}});Ext.define("SYNO.SDS.StorageManager.Disk.DiskGridViewPanel",{extend:"SYNO.ux.GridPanel",constructor:function(a){var d=this,c,b;d.appWin=a.appWin;d.owner=a.owner;c=[{header:_T("volume","volume_disknumber"),dataIndex:"displayNameHashValue",width:150,sortable:true,hideable:false,renderer:this.renderDisplayName},{header:_T("volume","volume_diskmodel"),dataIndex:"model",useHtmlEncodeRender:false,width:140,sortable:true},{header:_T("smart","smart_disk_serial"),dataIndex:"serial",width:140,sortable:true,hidden:true},{header:_T("smart","smart_disk_firmware"),dataIndex:"firmware",width:100,sortable:true,hidden:true},{header:_T("volume","volume_diskcapacity"),width:100,sortable:true,dataIndex:"totalSize",renderer:this.renderTotalSize}];if("yes"===_D("showdisktemperature")){c.push({header:_T("status","temperature"),dataIndex:"temp",width:100})}c.push({header:_T("volume","volume_disk_type"),dataIndex:"diskType",width:100,sortable:true},{header:_T("volume","4k_hdd"),dataIndex:"is4Kn",width:60,sortable:true,hidden:true},{header:_T("smart","smart_status"),useHtmlEncodeRender:false,width:125,sortable:true,dataIndex:"smartStatus",hidden:("yes"!==_D("supportsmart","no"))},{header:_T("volume","volume_diskstatus"),useHtmlEncodeRender:false,width:125,sortable:true,dataIndex:"diskStatus"},{header:d.appWin.supportRaidGroup?_T("volume","volume_storage_pool"):_T("volume","volume"),width:120,sortable:true,dataIndex:"usedBy"});d.colModel=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:c});b={border:false,itemId:"diskGridViewPanel",layout:"fit",store:new SYNO.SDS.StorageManager.Disk.Store(),colModel:d.colModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{selectionchange:d.owner.onSelectChange,scope:d.owner}}),viewConfig:{trackResetOnLoad:false}};d.callParent([Ext.apply(b,a)])},getSelectedItem:function(){var a=this,b=a.getSelectionModel().getSelected();if(!b){return}return a.appWin.disks.data[b.get("id")]},getSelectedItemIds:function(){var a=this,b=a.getSelectionModel().getSelected();if(b){return[b.get("id")]}return[]},select:function(){this.getSelectionModel().selectFirstRow()},renderTotalSize:function(e,b,a,g,d,c,f){return a.data.displayTotalSize},renderDisplayName:function(e,b,a,g,d,c,f){return a.data.displayName}});Ext.define("SYNO.SDS.StorageManager.Disk.SystemRaidDiskGridViewPanel",{extend:"SYNO.ux.GridPanel",constructor:function(a){var d=this,c,b;d.appWin=a.appWin;d.owner=a.owner;d.enableColumn=new SYNO.ux.EnableColumn({header:_T("volume","system_raid_allow_join"),dataIndex:"allowJoin",width:150,align:"center"});c=new Ext.grid.ColumnModel([{header:_T("volume","volume_disknumber"),dataIndex:"displayNameHashValue",width:150,sortable:true,renderer:this.renderDisplayName},{header:_T("volume","volume_diskmodel"),dataIndex:"model",width:140,sortable:true},{header:_T("volume","volume_diskcapacity"),dataIndex:"totalSize",width:100,sortable:true,renderer:this.renderTotalSize},{header:_T("volume","volume_disk_type"),dataIndex:"diskType",width:100,sortable:true},{header:_T("volume","volume_diskstatus"),dataIndex:"diskStatus",width:100,sortable:true,useHtmlEncodeRender:false},{header:_T("volume","system_raid_status"),dataIndex:"trayStatus",width:100,sortable:true,renderer:this.renderTrayStatus},d.enableColumn]);b={border:false,itemId:"systemRaidDiskGridViewPanel",layout:"fit",store:new SYNO.SDS.StorageManager.Disk.Store(),colModel:c,disableSelection:true,enableHdMenu:false,viewConfig:{trackResetOnLoad:false},plugins:[d.enableColumn]};d.callParent([Ext.apply(b,a)])},renderDisplayName:function(e,b,a,g,d,c,f){return a.data.displayName},renderTotalSize:function(e,b,a,g,d,c,f){return a.data.displayTotalSize},renderTrayStatus:function(e,b,a,g,d,c,f){if("join"===e){return _T("volume","system_raid_join")}else{if("not join"===e){return _T("volume","system_raid_not_join")}else{if("ssd cache"===e){return _T("volume","ssd_cache")}else{return e}}}}});Ext.define("SYNO.SDS.StorageManager.Disk.LogPanel",{extend:"SYNO.ux.GridPanel",sm:new Ext.grid.RowSelectionModel(),title:_T("disk_info","disk_logs"),iconCls:"icon-grid",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var e=[];this.store=this.createStore(a);var d=new SYNO.ux.TextFilter({iconStyle:"filter",itemId:"search",store:this.store});e.push({xtype:"syno_button",itemId:"refresh",text:_T("common","refresh"),handler:this.onRefresh,scope:this});e.push("->",d);var c=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:_T("log","log_time"),width:80,dataIndex:"time"},{header:_T("status","status_disk_model"),width:80,dataIndex:"model"},{header:_T("smart","smart_disk_serial"),width:80,dataIndex:"serial"},{header:_T("dsmoption","login_logo_position"),width:60,dataIndex:"position"},{header:_T("notification","notification_title"),width:120,dataIndex:"event"}]});var b={colModel:c,store:this.store,viewConfig:{forceFit:true},tbar:{items:e},listeners:{scope:this,activate:this.onActivate}};Ext.apply(b,a);return b},onActivate:function(){this.getStore().load()},onRefresh:function(){this.getStore().load()},createStore:function(a){return new SYNO.API.JsonStore({api:"SYNO.Storage.CGI.Smart",method:"list",version:1,appWindow:a.appWin,listeners:{exception:{scope:this,fn:this.onStoreException},beforeload:{scope:this,fn:this.onBeforeLoad},datachanged:{scope:this,fn:this.onDataChanged},load:{scope:this,fn:this.onLoad}},root:"diskLog",fields:["time","model","serial","position","event"],autoDestroy:true,defaultSortable:true,scope:this})},onStoreException:function(){this.owner.clearStatusBusy();this.appWin.setStatusError({text:_T("common","commfail")})},onBeforeLoad:function(){this.owner.setStatusBusy()},onDataChanged:function(){this.owner.clearStatusBusy()},onLoad:function(){this.owner.clearStatusBusy()}});Ext.define("SYNO.SDS.StorageManager.Disk.SmartScheduler",{extend:"SYNO.ux.Panel",panel:null,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b=c.fillConfig(a);c.callParent([b])},fillConfig:function(a){this.panel=new SYNO.SDS.StorageManager.Wizard.TaskPanel({appWin:this.appWin,owner:this.owner});var b={title:_T("smart","smart_test_scheduler"),width:800,minWidth:800,minHeight:155,layout:"fit",items:this.panel,listeners:{activate:this.onActivate,scope:this}};Ext.apply(b,a);return b},onActivate:function(){this.panel.loadData()}});Ext.define("SYNO.SDS.StorageManager.Disk.HddMgr",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(b){var a=[];a.push({xtype:"syno_fieldset",itemId:"main",title:_T("smart","cache_management"),items:[{xtype:"syno_checkbox",scope:this,id:this.CacheCheckboxId=Ext.id(),boxLabel:_T("hddsleep","dcache_config"),name:"writeCacheEn",value:true},{xtype:"syno_displayfield",scope:this,id:this.CacheDescdiskId=Ext.id(),value:_T("hddsleep","dcache_desc"),hidden:true},{xtype:"syno_displayfield",scope:this,id:this.CacheDescnoteId=Ext.id(),value:_T("hddsleep","dcache_suggest"),htmlEncode:false,hidden:true}]});if("no"===_D("support_dual_head","no")){a.push({xtype:"syno_fieldset",title:_T("disk_info","disk_health_report_title"),items:[{xtype:"syno_checkbox",scope:this,id:this.HealthCheckboxId=Ext.id(),boxLabel:_T("disk_info","disk_health_report_enable"),name:"healthReportEn"},{xtype:"syno_displayfield",scope:this,htmlEncode:false,id:this.HealthNoteId=Ext.id(),value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+String.format(_T("disk_info","disk_health_report_note"),'<a id="'+Ext.id()+'" class="link-font" href="#">'+_T("controlpanel","leaf_notification")+"</a>"),listeners:{afterrender:function(e){var d=e.el.first("a");if(d){this.mon(d,"click",function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Notification.Main",tab:"mailSettingTab"})},this)}},scope:this},hidden:true},{xtype:"syno_displayfield",fieldLabel:_T("disk_info","disk_health_report_next_time"),id:this.lblNextDateId=Ext.id(),value:"--"},{xtype:"syno_button",scope:this,text:_T("disk_info","disk_health_report_send_now"),id:this.SendReportNowId=Ext.id(),handler:this.onSendReportNow}]})}a.push({xtype:"syno_fieldset",title:_T("disk_info","disk_bad_sector_thr_title"),items:[{xtype:"syno_checkbox",id:this.BSThrChkBxId=Ext.id(),scope:this,boxLabel:_T("disk_info","disk_bad_sector_thr_enable"),name:"BadSctrThrEn"},{xtype:"syno_displayfield",scope:this,value:_T("disk_info","disk_bad_sector_thr_desc")},{xtype:"syno_numberfield",id:this.BSThrNumId=Ext.id(),name:"BadSctrThrVal",fieldLabel:_T("disk_info","disk_bad_sector_thr_value"),validator:function(d){if(0>=d){return"Threshold can't be equal or less than 0"}return true}}]});var c=Ext.apply({title:_T("disk_info","disk_info_general"),useDefaultBtn:true,border:false,items:a,listeners:{activate:this.onActivate,scope:this}},b);this.callParent([c]);this.mon(Ext.getCmp(this.BSThrChkBxId),"check",function(d,e){Ext.getCmp(this.BSThrNumId).setDisabled(!e)},this)},getNextReportDate:function(d){if(!d){return"--"}var a=new Date();var c=a.getFullYear();var b=a.getMonth();if(12===b){c=c+1}b=(b+1)%12;return String.format(_T("login","date_format"),_T("login","mon_"+(b+1)),1,c)+" 00:00:00"},onSendReportNow:function(){var a;this.appWin.setStatusBusy();this.appWin.sendWebAPI({api:"SYNO.Storage.CGI.HddMan",method:"send_health_report",version:1,scope:this,callback:function(c,b){this.appWin.clearStatusBusy();if(c){a=_T("vpnc","sent")}else{a=_T("error","error_error_system")}this.appWin.getMsgBox().alert(_T("notification","notification_email"),a)}})},onActivate:function(){this.appWin.sendWebAPI({api:"SYNO.Storage.CGI.HddMan",method:"get",version:1,scope:this,callback:function(b,a){if(!b){return}this.getForm().setValues(a);Ext.getCmp(this.lblNextDateId).setValue(this.getNextReportDate(a.healthReportEn));Ext.getCmp(this.lblNextDateId).originalValue=Ext.getCmp(this.lblNextDateId).getValue();Ext.getCmp(this.SendReportNowId).setDisabled(!a.healthReportEn);if("no"===_D("support_dual_head","no")){Ext.getCmp(this.HealthCheckboxId).setDisabled(!a.chkMailSetting);Ext.getCmp(this.HealthNoteId).setVisible(!a.chkMailSetting);Ext.getCmp(this.lblNextDateId).setVisible(a.chkMailSetting);Ext.getCmp(this.SendReportNowId).setVisible(a.chkMailSetting)}if(false===a.supportCache){Ext.getCmp(this.CacheCheckboxId).hide();return}Ext.getCmp(this.CacheDescdiskId).setVisible(a.chkDiskWCache);Ext.getCmp(this.CacheDescnoteId).setVisible(!a.chkDiskWCache);Ext.getCmp(this.BSThrNumId).setDisabled(!a.BadSctrThrEn)}})},applyForm:function(){var b=this,a=b.getForm(),c;if(false===b.onBeforeAction(a,"set")){return}c={action:"apply"};if(true===a.getValues().writeCacheEn){c.writeCacheEn=true}if("no"===_D("support_dual_head","no")){if(true===a.getValues().healthReportEn){c.healthReportEn=true}}if(true===a.getValues().BadSctrThrEn){c.BadSctrThrEn=true;c.BadSctrThrVal=a.getValues().BadSctrThrVal}b.setStatusBusy();b.appWin.sendWebAPI({api:"SYNO.Storage.CGI.HddMan",method:"set",version:1,params:c,scope:this,callback:function(e,d){b.clearStatusBusy();if(e){this.getForm().setValues(d);Ext.getCmp(this.SendReportNowId).setDisabled(!d.healthReportEn);Ext.getCmp(this.lblNextDateId).setValue(this.getNextReportDate(d.healthReportEn));Ext.getCmp(this.lblNextDateId).originalValue=Ext.getCmp(this.lblNextDateId).getValue();b.setStatusOK()}else{this.getForm().reset();if(d.errors){b.setStatusError({text:_T(d.errors.errinfo.sec,d.errors.errinfo.key)})}else{b.setStatusError()}}}})}});Ext.define("SYNO.SDS.StorageManager.Disk.SystemRaidPanel",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b,d=[];c.trayData={};c.minDisksCount=999;c.bUpdateSetting=true;c.appWin=a.appWin;c.owner=a.owner;c.gridView=new SYNO.SDS.StorageManager.Disk.SystemRaidDiskGridViewPanel({appWin:c.appWin,owner:c});d.push({xtype:"syno_button",itemId:"syncButton",text:_T("volume","system_raid_sync_conf"),handler:c.onSyncSetting,scope:c});b={title:_T("volume","system_title"),layout:"card",region:"center",itemId:"systemRaidPanel",tbar:{items:d},activeItem:0,items:c.gridView,listeners:{activate:c.onActivate,scope:c}};c.callParent([Ext.apply(b,a)])},onActivate:function(){this.updateButton();if(!this.bUpdateSetting){this.loadUiData(this.trayData.trays)}else{this.owner.setStatusBusy();SYNO.API.Request({api:"SYNO.Storage.CGI.Storage",version:1,method:"load_system_raid",callback:function(d,b,c,a){this.trayData=b;this.minDisksCount=this.trayData.min_disks_count;this.bUpdateSetting=true;this.loadUiData(this.trayData.trays);this.owner.clearStatusBusy()},scope:this});this.bUpdateSetting=false}},updateButton:function(){var a=this.getTopToolbar().getComponent("syncButton");if(this.appWin.env.isSyncSysPartition){a.disable();a.setText(_T("volume","system_raid_in_syncing"))}else{a.enable();a.setText(_T("volume","system_raid_sync_conf"))}},updateStore:function(){var e=this.layout.activeItem.store;var f,d,c,b;var a={};for(f=0;f<e.getCount();f++){d=e.getAt(f);a[d.id]=d}for(f=0;f<this.uiData.length;f++){c=this.uiData[f];d=a[c.id];if(!d){b=new e.recordType(c,c.id);e.insert(f,b);continue}else{d.set("model",c.model);d.set("totalSize",c.totalSize);d.set("displayTotalSize",c.displayTotalSize);d.set("diskType",c.diskType);d.set("diskStatus",c.diskStatus);d.set("trayStatus",c.trayStatus);d.set("isNormal",c.isNormal);d.set("isSynoPartition",c.isSynoPartition);if(d.modified){delete d.modified.model;delete d.modified.totalSize;delete d.modified.displayTotalSize;delete d.modified.diskType;delete d.modified.diskStatus;delete d.modified.trayStatus;delete d.modified.isNormal;delete d.modified.isSynoPartition}}a[c.id]=undefined}for(f=0;f<e.getCount();f++){d=e.getAt(f);if(a[d.id]){e.remove(d)}}},loadUiData:function(b){var c=this;var a=c.layout.activeItem.store;c.prepareUiData(b);a.suspendEvents(true);if(this.bUpdateSetting){a.loadData(c.uiData,false);c.bUpdateSetting=false}else{c.updateStore()}a.resumeEvents()},prepareUiData:function(b){var c=this,d;var a=c.appWin.disks;var e=("yes"===_D("support_dual_head","no"))?true:false;a=(0===a.count)?[]:(e?a.getMatched("isInEbox"):a.getMatched("isInternal","isNormalTray"));delete c.uiData;c.uiData=[];Ext.each(a,function(f){d={};if("disabled"===f.get("portType")){c.preparePort(f,d)}else{c.prepareSummary(f,d,b)}c.uiData.push(d)},c);c.uiData.sort(function(i,h){var g=i.numId,k=h.numId,f=i.ctnOder,j=h.ctnOder;if(f>j){return 1}if(f<j){return -1}if(g>k){return 1}if(g<k){return -1}return 0})},preparePort:function(a,b){b.id=a.get("id");b.numId=parseInt(a.get("num_id"),10);b.ctnOder=0;b.displayName=String.format("{0} {1}",_T("volume","volume_disk"),a.get("num_id"));b.model="-";b.displayTotalSize="-";b.diskType="-";b.diskStatus=String.format('<span class="red-status">{0}</span>',_T("disk_info","disk_disable_title"));b.trayStatus="-";b.allowJoin=true;b.isNormal=false;b.isSynoPartition=false},prepareSummary:function(b,e,d){var g=this,f,i,c;var j=SYNO.SDS.StorageUtils;var a=b.get("container");var h=parseInt(b.get("size_total"),10);e.id=b.get("id");e.numId=parseInt(b.get("num_id"),10);e.ctnOder=parseInt(a.order,10);e.displayNameHashValue=e.ctnOder*1000+e.numId;e.totalSize=h/1024/1024/1024;e.model=b.get("model");if(b.isCacheTray()){e.displayName=_T("volume","dedicated_ssd_cache")}else{e.displayName=SYNO.SDS.Utils.StorageUtils.UiRenderHelper.DiskNameRenderer(b.get("name"))}i=String.format("{0} {1}",e.totalSize.toFixed(2),_T("status","status_disk_size_unit"));if(g.appWin.supportSas){c=String.format("{0} / {1}",b.get("diskType"),(b.get("isSsd"))?"SSD":"HDD")}else{c=(b.get("isSsd"))?"SSD":"HDD"}f=("hotspare"===b.get("used_by"))?"hotspare":b.get("status");e.diskStatus=j.DiskStatusRender(f);e.displayTotalSize=i;e.diskType=c;e.trayStatus=b.get("tray_status");e.allowJoin=g.searchTrayConf(d,e.numId,e.ctnOder);e.isNormal="normal"===f;e.isSynoPartition=b.get("isSynoPartition")},searchTrayConf:function(d,b,a){var c;for(c=0;c<d.length;c++){if(b===d[c].num&&a===d[c].cnrIdx){return d[c].join}}return true},onSyncSetting:function(){var j=this.layout.activeItem.store;var e,h,d,c,m,l;var f=("yes"===_D("support_dual_head","no"))?true:false;var g=this;var k=0;var b=true;var a=[];for(e=0;e<j.getCount();e++){h=j.getAt(e).data;if("ssd cache"===h.trayStatus){continue}if(false===h.allowJoin){b=false;continue}if(false===h.isSynoPartition){a.push(h.displayName)}k++}if(this.minDisksCount>k&&!b){d=String.format(_T("volume","system_raid_min_disk_limit_alert"),this.minDisksCount);this.appWin.getMsgBox().alert("",d);return}if(0<a.length){c=_T("volume","system_raid_create_sys_partition_alert");c+="</br></br>";c+=a.join(", ");l=a.length*20/(f?2.5:6);l=(300<l)?300:l;m=new SYNO.SDS.StorageManager.Dialog.Confirm({owner:this.owner,title:this.owner.title,winHeight:l,confirmBtnStyle:"red",message:c,confirmText:_T("volume","system_raid_create_sys_partition_confirm"),callback:function(){g.sendRequest(j)}});m.open();return}this.sendRequest(j)},sendRequest:function(b){var d,a,c=[];this.appWin.setStatusBusy();for(d=0;d<b.getCount();d++){a=b.getAt(d);c.push({num:a.data.numId,cnrIdx:a.data.ctnOder,allow_join:a.data.allowJoin})}SYNO.API.Request({api:"SYNO.Storage.CGI.Storage",method:"set_system_raid",version:1,params:{trays:c},callback:function(h,e,g,f){if(h){this.appWin.getMsgBox().alert("",_T("tree","okpage"));this.clearDirty();this.appWin.env.isSyncSysPartition=true;this.updateButton()}else{this.appWin.getMsgBox().alert("",_T("router_tc","op_msg_failed_apply"))}this.appWin.clearStatusBusy()},scope:this})},clearDirty:function(){var b=this.layout.activeItem.store;var c,a;for(c=0;c<b.getCount();c++){a=b.getAt(c);a.commit()}}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvCreateTarget",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.isDataChanged=false;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("iscsitrg","iscsitrg_target_create"),width:640,height:475,minHeight:475,minWidth:640,resizable:true,layout:"fit",border:false,items:[new SYNO.SDS.StorageManager.Wizard.iSCSITargetProperty({appWin:c.appWin,owner:c,itemId:"property"})],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:c,handler:c.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){var a=this,b=[];a.callParent(arguments);Ext.each(a.appWin.iscsiLuns.getAll(),function(c){if(c.isSinkLun()){return true}b.push({enabled:false,ckeckedClass:"",id:c.get("iscsi_lun").lid,name:c.get("iscsi_lun").name})},a);b.sort(function(d,c){return d.id>c.id});a.getPropPanel().getMappingCmp().getStore().loadData(b,false);a.getPropPanel().getForm().setValues({iqn:a.appWin.genNewIQN(a.appWin.genNewTargetName()),name:a.appWin.genNewTargetName()})},getPropPanel:function(){return this.getComponent("property")},onCancel:function(){if(this.getComponent("property").getForm().isDirty()||this.getComponent("property").getComponent("mapping").store.getModifiedRecords().length){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()},onSave:function(){if(!this.getPropPanel().getForm().isValid()){return}var b=this.getPropPanel().getMappingCmp().getStore();var c=0;var a,e;for(a=0;a<b.getCount();a++){if(b.getAt(a).get("enabled")){++c}}if(c>SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS){e=_T("iscsitrg","iscsitrg_max_lun_per_target");e=String.format(e,SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS,"");this.owner.getMsgBox().alert(this.title,e);return}var d;d=this.getPropPanel().getForm().getValues();if("false"===d.chap){delete d.chap}d.mapped_luns=[];b.each(function(f){if(f.get("enabled")){d.mapped_luns.push(f.get("id"))}});delete d.mapping;this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSITargets",version:1,method:"create",params:d,callback:function(g,f){this.clearStatusBusy();if(!g){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);return}this.isDataChanged=true;this.close()},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvDeleteTarget",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,target:null,constructor:function(a){var c=this,b;b={title:_T("common","remove")+" "+_T("tree","leaf_iscsitrg"),width:640,height:350,resizable:false,layout:"fit",items:[SYNO.LayoutConfig.fill({xtype:"form",itemId:"main",border:false,items:[{synotype:"desc",value:_T("volume","volume_delete_summary_desc"),itemId:"desc"},this.grid=new SYNO.SDS.Wizard.SummaryStep({height:130})]})],buttons:[{xtype:"syno_button",btnStyle:"red",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","remove"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}],listeners:{afterlayout:function(f){var d=f.getComponent("main").getHeight();var e=f.getComponent("main").getComponent("desc").getHeight();f.grid.setHeight(d-e-5)}}};c.callParent([Ext.apply(b,a)])},loadData:function(b){var a=this.grid.getStore();a.append(_T("tree","leaf_iscsitrg"),this.target.get("name"))},onOpen:function(){this.callParent(arguments);this.loadData()},onSave:function(){var a={tid:this.target.id,luns:[],lids:[]};this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSITargets",version:1,method:"remove",params:a,callback:function(c,b){this.clearStatusBusy();if(!c){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,b);return}this.isDataChanged=true;this.close()},scope:this})},onCancel:function(){this.close()}});Ext.namespace("SYNO.SDS.StorageManager.iSCSITrg");SYNO.SDS.StorageManager.iSCSITrg.MAX_MAPPING_LUNS=256;Ext.define("SYNO.SDS.StorageManager.iSCSITarget",{check:SYNO.SDS.StorageUtils.check,get:function(a){if(this.json){return this.json[a]}return undefined},isISCSIConnected:function(){return"connected"===this.get("status")},isActing:function(){return this.get("status").indexOf("ing")>0}});Ext.define("SYNO.SDS.StorageManager.iSCSITrg.Store",{extend:"Ext.data.JsonStore",constructor:function(a){var c=this,b;c.sortField="numId";c.sortDir="ASC";b={autoDestroy:true,idProperty:"id",fields:["numId","id","iconCls","statusIconCls","displayName","summaryStatus","property","map","mask"],listeners:{load:function(){c.sort(c.sortField,c.sortDir)},scope:c}};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.StorageManager.iSCSITrg.Main",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;c.view=undefined;c.appWin=a.appWin;c.owner=a.appWin;c.createView();b={border:false,layout:"fit",itemId:"iscsi_target",tbar:{defaultType:"syno_button",items:[{itemId:"create",text:_T("common","create"),handler:c.onCreate,scope:c},{itemId:"remove",text:_T("common","remove"),handler:c.onDelete,scope:c},{itemId:"manage",text:_T("common","alt_edit"),handler:c.onManage,scope:c},{tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",itemId:"flip",text:_T("iscsitrg","iscsitrg_enable"),handler:c.onFlip,scope:c},{itemId:"isns",text:_T("iscsitrg","iscsitrg_isns"),handler:c.onISNS,scope:c}]},items:c.view,listeners:{activate:c.onActivate,scope:c}};c.callParent([Ext.apply(b,a)])},getHelpParam:function(){return"StorageManager/iscsitrg.html"},createView:function(){var e=this,d=SYNO.SDS.StorageManager.PropertyTpl(),a=new SYNO.SDS.StorageManager.ListTpl({scope:"map",title:_T("iscsitrg","iscsitrg_mapped_lun"),emptyText:_T("iscsitrg","iscsitrg_mapped_no_luns"),columns:[{header:_T("volume","volume_disknumber"),dataIndex:"logical_unit_number"},{header:_T("common","name"),dataIndex:"name"},{header:_T("volume","volume_totalsize"),dataIndex:"capacity"}]}),f=new SYNO.SDS.StorageManager.ListTpl({scope:"mask",title:_T("iscsitrg","iscsitrg_masking"),columns:[{header:_T("iscsitrg","iscsitrg_initiator_iqn"),dataIndex:"iqn"},{header:_T("iscsitrg","iscsitrg_permission"),dataIndex:"permission"}]}),c,b;c=new Ext.XTemplate('<div class="item-detail-inner">',d.html,a.html,f.html,"</div>");b={appWin:e.appWin,owner:e,dataType:"iscsiTargets",itemId:"targetView",multiSelect:false,singleSelect:true,detailTpl:c,store:new SYNO.SDS.StorageManager.iSCSITrg.Store(),listeners:{selectionchange:e.onSelectChange,scope:e}};e.view=new SYNO.SDS.StorageManager.DataView(b)},prepareUiData:function(){var b=this,a=b.appWin.iscsiTargets.getAll(),c;delete b.uiData;b.uiData=[];Ext.each(a,function(d){c={};b.prepareSummary(d,c);b.prepareProperty(d,c);b.prepareMap(d,c);b.prepareMask(d,c);b.uiData.push(c)},b)},prepareSummary:function(b,a){a.status=b.get("status");a.id=b.get("tid").toString();a.displayName=b.get("name");a.summaryStatus=String.format("&nbsp;-&nbsp;{0}",SYNO.SDS.StorageUtils.TargetStatusRender(b.get("status"),-1));a.iconCls="sm-list-icon-target";a.desc=b.get("iqn")},prepareProperty:function(f,d){var k={none:_T("iscsitrg","iscsitrg_auth_none"),chap:_T("iscsitrg","iscsitrg_auth_chap"),mutual:_T("iscsitrg","iscsitrg_auth_mutual_chap")},h=SYNO.SDS.StorageUtils,b=f.get("status"),g,j=[],e,a,c;d.property=[{name:_T("common","name"),value:f.get("name")},{name:"IQN",value:f.get("iqn")}];if("connected"===b){for(c=0;c<f.get("remote").length;++c){e=f.get("remote")[c].ip;a=f.get("remote")[c].iqn;j.push(String.format("{0}  ({1})",a,e))}g=String.format('<span class="blue-status" style="white-space:pre-warp">{0}</span>',j.join("<br/>"))}else{if("processing"===b||"creating"===b||"deleting"===b){g=h.TargetStatusRender(b,f.get("progress"));if(f.get("progress")>0){g=String.format("{0} {1}",g,h.PercentRender(f.get("progress")))}}else{g=h.TargetStatusRender(b,-1)}}d.property.push({name:_T("volume","volume_iscsitrg_status"),value:g});d.property.push({name:_T("iscsitrg","iscsitrg_title_authen"),value:k[f.get("auth").type]});d.property.push({name:_T("iscsitrg","iscsitrg_multi_sessions"),value:f.get("multi_sessions")?_T("iscsitrg","iscsitrg_enable"):_T("iscsitrg","iscsitrg_disable")});d.property.push({name:_T("iscsitrg","iscsitrg_checksum_header"),value:f.get("hdr_chksum")?_T("iscsitrg","iscsitrg_enable"):_T("iscsitrg","iscsitrg_disable")});d.property.push({name:_T("iscsitrg","iscsitrg_checksum_data"),value:f.get("data_chksum")?_T("iscsitrg","iscsitrg_enable"):_T("iscsitrg","iscsitrg_disable")});d.property.push({name:_T("iscsitrg","iscsitrg_max_recv_segment"),value:f.get("recv_seg_bytes")+" "+_T("common","size_byte")});d.property.push({name:_T("iscsitrg","iscsitrg_max_send_segment"),value:f.get("send_seg_bytes")+" "+_T("common","size_byte")})},prepareMap:function(h,g){var f=this,e=h.get("mapped_luns"),d=h.get("mapped_logical_unit_number"),b;var c=f.appWin.iscsiLuns.getMatched(function(){var i=this.get("iscsi_lun");return(i&&(-1!==e.indexOf(i.lid)))});g.map=[];for(b=0;b<c.length;++b){var a=c[b].get("iscsi_lun");g.map.push({logical_unit_number:d[b],name:a.name,capacity:SYNO.SDS.StorageUtils.SizeRender(a.size)})}},prepareMask:function(f,d){var a=SYNO.SDS.StorageManager.ISCSI.Util.renderPermission,e=SYNO.SDS.StorageManager.ISCSI.Util.renderIQN,b=f.get("masking"),c;d.mask=[];b.sort(function(h,g){if(h.iqn===SYNO.SDS.StorageManager.iSCSITrg.DefaultIQN){return -1}else{if(g.iqn===SYNO.SDS.StorageManager.iSCSITrg.DefaultIQN){return 1}else{return 0}}});for(c=0;c<b.length;++c){d.mask.push({iqn:e(b[c].iqn),permission:a(b[c].permission)})}},onActivate:function(){var b=this,a=b.view.store;b.prepareUiData();a.suspendEvents(true);a.loadData(b.uiData,false);a.resumeEvents();if(0<b.view.store.getCount()&&0===b.view.getSelectedItemIds().length){b.view.select(0,true,true)}b.onSelectChange();b.setMask()},onSelectChange:function(){var a=this,b=a.view.getSelectedItem();a.getButton("remove").hide();a.getButton("manage").hide();a.getButton("flip").hide();a.enableButton("create",a.canCreate());if(!b){return}a.getButton("remove").show();a.getButton("manage").show();a.getButton("flip").show();a.getButton("flip").setText(b.get("enabled")?_T("iscsitrg","iscsitrg_disable"):_T("iscsitrg","iscsitrg_enable"));a.enableButton("remove",a.canDelete(b));a.enableButton("manage",a.canManage(b));a.enableButton("flip",a.canFlip(b))},onCreate:function(){var b=this,a;a=(b.appWin.supportRaidGroup)?"AdvCreateTarget":"CreateiSCSITargetMain";b.openWizard(a,{})},onDelete:function(){var c=this,e=c.view.getSelectedItem(),b,d,a;if(!e){return}b=(c.appWin.supportRaidGroup)?"AdvDeleteTarget":"DeleteTarget";d=e.get("mapped_luns");a=c.appWin.iscsiLuns.getMatched(function(){return this.isISCSI()&&d.indexOf(this.getLunId())!==-1});c.openWizard(b,{target:e,mapped_luns:a})},onManage:function(){var a=this,b=a.view.getSelectedItem();if(!b){return}a.openWizard("ManageTarget",{target:b})},onFlip:function(){var b=this,e=b.view.getSelectedItem(),d=e.get("tid"),a=e.get("enabled"),c=a?"disable":"enable";b.appWin.stopPollTask();b.owner.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Storage.iSCSITargets",method:c,version:1,params:{tid:d},callback:function(g,f){this.clearStatusBusy();if(!g){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);return}SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.StorageManager.ISCSI",a);this.setStatusBusy();this.cleanMask=true;this.startPollTask()},scope:b.owner})},onISNS:function(){var a=this;a.openWizard("ISNS",{enabled:a.appWin.env.isns.enabled,address:a.appWin.env.isns.address})},setMask:function(){if(this.isVisible()&&0===this.view.getStore().getCount()){this.body.mask(_T("iscsitrg","iscsitrg_no_iscsitrg"),"syno-ux-mask-info")}if(0<this.view.getStore().getCount()){this.body.unmask()}},canCreate:function(){return !this.appWin.isUpToiSCSITargetMaxCount()},canDelete:function(a){return !a.isActing()},canManage:function(a){return !a.isActing()},canFlip:function(a){return(!a.isActing()&&!_S("demo_mode"))},openWizard:function(b,a){var c=this,e;if(c.appWin.isUpToBatchTaskCount()){e=_T("volume","volume_max_batch_task_count").replace("_MAX_TASK_",c.appWin.getMaxBatchTaskCount());c.appWin.getMsgBox().alert(c.title,e,function(){},c);return}var d=new SYNO.SDS.StorageManager.Wizard[b](Ext.apply({appWin:c.appWin,owner:c.owner},a));c.appWin.stopPollTask();c.mon(d,"close",function(){if(Ext.isFunction(d.hideFromOwner)){d.hideFromOwner()}if(d.isDataChanged){c.owner.setStatusBusy();c.body.unmask();c.owner.cleanMask=true}c.appWin.startPollTask()},c,{single:true});d.open()},enableButton:function(c,a){var b=this.getButton(c);if(!b){throw Error("could not get button of id: "+c)}return a?b.enable():b.disable()},disableButtons:function(){Ext.each(arguments,function(d,a,c){var b=this.getButton(d);if(!b){throw Error("could not get button of id: "+d)}b.disable()},this)},getButton:function(a){return this.getTopToolbar().getComponent(a)}});Ext.define("SYNO.SDS.StorageManager.Wizard.ManageSpare",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var c=this,b;c.isDataChanged=false;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("volume","volume_spare_manage_wizard_title"),width:910,height:580,border:false,cls:"sm-manage-spare",layout:"fit",steps:[]};b.steps.push(new SYNO.SDS.StorageManager.Wizard.ConfigSpare({appWin:c.appWin,itemId:"edit",nextId:null}));c.callParent([Ext.apply(b,a)])},applySettings:function(a){var b=this;b.setStatusBusy({text:_T("common","saving")});b.sendWebAPI({api:a.api,method:a.method,version:a.version,params:a.params,scope:b,callback:function(e,d,c){b.clearStatusBusy();if(!e){b.getMsgBox().alert(b.title,d.text?d.text:_T("common","error_system"));return}b.isDataChanged=true;b.close()}})}});Ext.define("SYNO.SDS.StorageManager.Wizard.ConfigSpare",{extend:"SYNO.ux.Panel",constructor:function(b){var d=this,a,c;d.appWin=b.appWin;a=d.appWin.disks.getAll();d.spares=d.appWin.hotSpares.getAll();d.createTreeNode(a);d.initRaidGroupPanel();d.initDiskPanel();d.supportRaidCross=("yes"===_D("supportraidcross","no"));c={headline:_T("volume","volume_spare_manage_title"),description:_T("volume","volume_spare_manage_desc"),layout:{type:"hbox",align:"stretch"},bwrapCfg:{cls:"x-panel-bwrap",style:{padding:"8px 20px 4px 20px"}},border:false,items:[d.raidGroupPanel,new Ext.Panel({width:10,bodyStyle:{"border-top":"0","border-left":"1px solid #C8D2Dc","border-bottom":"0","border-right":"0"}}),d.diskPanel]};d.callParent([Ext.apply(c,b)])},initRaidGroupPanel:function(){var a=this;this.raidGroupView=new Ext.DataView({store:new Ext.data.JsonStore({autoDestory:true,root:"pools",idProperty:"id",fields:["id","name","status","type","available","count","desc","sparedDisk"]}),tpl:this.getRaidGroupTpl(),autoHeight:true,itemSelector:"div.sds-space-spare-group-wrapper"});this.raidGroupPanel=new Ext.Panel({itemId:"raidGroup",title:a.appWin.supportRaidGroup?_T("volume","volume_raid_group_status"):_T("volume","volume_space_status"),border:false,width:544,items:this.raidGroupView,autoScroll:true})},getRaidGroupTpl:function(){var a=new Ext.XTemplate('<div style="line-height:28px;">','<div style="float:left;width:120px;"><div class="sm-manage-spare-illustrate-spared"></div><div>'+_T("volume","volume_spared")+"</div></div>",'<div style="float:left;width:120px;"><div class="sm-manage-spare-illustrate-available"></div><div>'+_T("volume","volume_spare_available")+"</div></div>",'<div style="float:left;width:200px;"><div class="sm-manage-spare-illustrate-not-available"></div><div>'+_T("volume","volume_spare_not_available")+"</div></div>","</div>",'<div class="x-clear"></div>',"<div>",'<tpl for=".">','<div class="sm-spare-mgr-spare-wrapper">','<div class="sm-spare-mgr-spare-bg sm-spare-mgr-spare-bg-{status}">','<div class="sm-spare-mgr-spare-fg sm-spare-mgr-spare-fg-{status}"></div>',"</div>",'<div class="sm-spare-mgr-space-name">{name}</div>','<div ext:qtip="{[Ext.util.Format.htmlEncode(values.desc)]}" class="sm-spare-mgr-space-desc">{desc}</div>','<div class="sm-spare-mgr-space-type">{type}</div>',"<tpl if=\"available == 'yes'\">",'<div class="sm-spare-mgr-spared-count">{sparedDisk}</div>','<div class="sm-spare-mgr-spared-string">'+_T("volume","volume_spared_hdd")+"</div>","</tpl>","<tpl if=\"available == 'no'\">",'<div class="sm-spare-mgr-not-available">'+_T("volume","volume_spare_not_available")+"</div>","</tpl>","</div>","</tpl>","</div>","</div>");return a},initDiskPanel:function(){this.diskPanel=new Ext.tree.TreePanel({autoFlexcroll:true,itemId:"disks",title:_T("volume","volume_available_disks"),cls:"sds-space-spare sds-space-spare-available-disks",useArrows:true,border:false,width:310,animate:false,bodyStyle:"overflow-x: hidden;overflow-y:auto;",enableDD:false,rootVisible:false,listeners:{click:this.onClick,dblclick:function(b,c){b.ui.checkbox.checked=b.ui.anchor.hasClassName("x-tree-node-anchor-checked")},scope:this}});var a=new Ext.tree.AsyncTreeNode({draggable:false,expanded:true,id:"fm_root",allowDrop:false,checked:"unchecked",leaf:false,children:this.containers});this.diskPanel.setRootNode(a)},createTreeNode:function(){var d=this,a=[],e={},c,b;Ext.each(d.appWin.disks.getAll(),function(h){var g,f;g=h.get("status");f=h.get("container");if("ebox"===f.type&&0===f.order){return true}if((""===h.get("used_by")&&h.isNormalTray()&&!h.get("is_erasing"))||h.inSpare(this.appWin.hotSpares.data)){a.push(h)}},d);Ext.each(a,function(k){var g="internal"===k.get("container").type?_S("hostname"):k.get("container").str;var f=e[g];if(!f){f={};f.htmlEncode=false;f.text=String.format('<span style="font-weight:bold">{0}</span>',g);f.id=g;f.leaf=false;f.expanded=true;f.checked=true;f.children=[];f.order=(k.get("container").order)?parseInt(k.get("container").order,10):0;e[g]=f}var j=false,i=false;var h=this.appWin.hotSpares.data[k.get("id")];if(h){j=true;if("standby"!==h.get("status").type){i=true}}b=String.format("{0} - {1} {2} {3} {4}",_T("volume","volume_disk")+" "+k.get("num_id"),k.get("diskType"),k.get("isSsd")?"SSD":"HDD",SYNO.SDS.StorageUtils.SizeRender(k.get("size_total")),k.get("is4Kn")?String.format("({0})",_T("volume","4kn")):"");f.checked=f.checked&&j;f.children.push({text:b,id:k.get("id"),leaf:true,checked:j,disabled:i,qtip:b,numId:k.get("num_id")});f.children.sort(function(m,l){return(m.numId>l.numId)?1:((m.numId===l.numId)?0:-1)})},d);d.containers=[];for(c in e){if(e.hasOwnProperty(c)){d.containers.push(e[c])}}d.containers.sort(function(g,f){return(g.order>f.order)?1:((g.order===f.order)?0:-1)})},activate:function(){if(this.appWin.supportRaidGroup){this.processRaidGroup()}else{this.processSpaces()}this.raidGroupView.getStore().loadData(this.data,false);this.setDiskCheckUI();if(0===this.data.pools.length){this.getComponent("raidGroup").body.mask(this.appWin.supportRaidGroup?_T("volume","volume_no_raid_with_protection"):_T("volume","volume_no_space_with_protection"),"syno-ux-mask-info")}else{this.getComponent("raidGroup").body.unmask()}if(0===this.containers.length){this.getComponent("disks").bwrap.mask(_T("volume","volume_no_available_disks"),"syno-ux-mask-info")}else{this.getComponent("disks").body.unmask()}},setDiskCheckUI:function(){this.diskPanel.root.childNodes.each(function(b){var a;if(b.ui.checkbox.checked){a=new Ext.Element(b.ui.anchor);a.addClass("x-tree-node-anchor-checked")}b.childNodes.each(function(c){if(c.ui.checkbox.checked){a=new Ext.Element(c.ui.anchor);a.addClass("x-tree-node-anchor-checked")}},this)},this)},processRaidGroup:function(){var h=this,d={raid_1:1,raid_5:1,raid_6:1,raid_10:1,shr_with_1_disk_protect:1,shr_with_2_disk_protect:1},i=SYNO.SDS.StorageUtils,e,f,a,g=h.appWin.hotSpareConf.disable_repair;var c=this.supportRaidCross&&this.appWin.hotSpareConf.cross_repair;var b=h.appWin.storagePools.getMatched(function(){return this.canRepair(g)},h);h.data={pools:[]};Ext.each(b,function(m){m.spare={};if(!(m.get("device_type") in d)||"crashed"===m.get("status")){return true}if("SSD"!==m.getDriveType()&&"HDD"!==m.getDriveType()){return true}e={};e.type="pool";e.order=m.get("num_id");e.id=m.id;e.name=i.SpaceIDParser(m.id).str;e.desc=m.get("desc");e.raidType=i.RaidLevelRender(m.get("device_type"));a=true;e.sparedDisk=0;e.disks=m.get("disks");e.container=m.get("container");e.driveType=m.getDriveType();var k=h.appWin.disks.getMatched("notUsedBySpace");var n=h.appWin.hotSpares.getAll();var l=(-1!==m.get("device_type").indexOf("shr"));var j;if(l){e.minDiskSize=m.get("minimal_disk_size");if(0<e.disks.length){j=this.appWin.disks.data[e.disks[0]]}n.each(function(o){var p=this.appWin.disks.data[o.id];if(!j){return false}if(!c){if("cross"===e.container||("internal"===e.container&&"internal"!==p.get("container").type)||("ebox"===e.container&&j.get("container").order!==p.get("container").order)){return true}}if("Hybrid"===e.driveType||"Unknown"===e.driveType||("SSD"===e.driveType&&p&&!p.get("isSsd"))||("HDD"===e.driveType&&p&&p.get("isSsd"))){return true}if(p&&parseInt(p.get("size_total"),10)>=parseInt(e.minDiskSize,10)&&p.get("diskType")==="SATA"&&"standby"===o.get("status").type&&p.is4Kn()===j.is4Kn()){if(!m.spare[o.id]){m.spare[o.id]=1;e.sparedDisk++}}},h);Ext.each(k,function(o){if(parseInt(o.get("size_total"),10)>=parseInt(e.minDiskSize,10)&&o.get("diskType")==="SATA"&&o.is4Kn()===j.is4Kn()){e.available="yes";return false}},h)}else{if(0<e.disks.length){j=this.appWin.disks.data[e.disks[0]]}Ext.each(m.get("raids"),function(p){if(a){for(var o=0;o<p.devices.length;++o){f=this.appWin.disks.data[p.devices[o].id];if(!f){continue}break}e.hddType=f?f.get("diskType"):"";e.is4Kn=f.is4Kn();a=false}n.each(function(q){var r=h.appWin.disks.data[q.id];if(!c){if("cross"===e.container||("internal"===e.container&&"internal"!==r.get("container").type)||("ebox"===e.container&&j.get("container").order!==r.get("container").order)){return true}}if("Hybrid"===e.driveType||"Unknown"===e.driveType||("SSD"===e.driveType&&r&&!r.get("isSsd"))||("HDD"===e.driveType&&r&&r.get("isSsd"))){return true}if(r&&parseInt(r.get("size_total"),10)>=parseInt(p.minDevSize,10)&&r.get("diskType")===e.hddType&&r.is4Kn()===e.is4Kn&&"standby"===q.get("status").type){if(!m.spare[q.id]){m.spare[q.id]=1;e.sparedDisk++}}},this);Ext.each(k,function(q){if(parseInt(q.get("size_total"),10)>=parseInt(p.minDevSize,10)&&q.get("diskType")===h.appWin.disks.data[m.get("disks")[0]].get("diskType")&&q.is4Kn()===h.appWin.disks.data[m.get("disks")[0]].is4Kn()){e.available="yes";return false}},h)},h)}delete m.spare;e.orgSparedDisk=e.sparedDisk;e.available=e.available||"no";if(0<e.sparedDisk){e.status="spared"}else{if("yes"===e.available){e.status="available"}else{e.status="not-available"}}e.type=String.format("{0} {1} / {2}",l?"SATA":e.hddType,m.getDriveTypeStr(),e.raidType);h.data.pools.push(e)},h);h.data.pools.sort(function(k,j){if(k.order>j.order){return 1}if(k.order<j.order){return -1}return 0})},processSpaces:function(){var k=this,j=k.appWin.hotSpareConf.disable_repair;var n=SYNO.SDS.StorageUtils;var c=k.supportRaidCross&&k.appWin.hotSpareConf.cross_repair;var e={raid_1:1,raid_5:1,raid_6:1,raid_10:1,shr_with_1_disk_protect:1,shr_with_2_disk_protect:1};k.data={pools:[]};var d=k.appWin.storagePools.getMatched(function(){return this.canRepair(j)},k);var l=k.appWin.volumes.getMatched(function(){return !this.isLogicalVolume()&&this.canRepair(j)},k);var p=k.appWin.iscsiLuns.getMatched(function(){return !this.isLogicalVolume()&&this.canRepair(j)},k);var o=d.concat(l,p);var h,g;for(var f=0;f<o.length;++f){h=o[f];h.spare={};if(!(h.get("device_type") in e)||"crashed"===h.get("status")){continue}if("SSD"!==h.getDriveType()&&"HDD"!==h.getDriveType()){continue}g={};g.order=h.get("num_id");g.id=h.id;g.name=n.SpaceIDParser(h.id).str;g.desc=h.get("desc");g.raidType=n.RaidLevelRender(h.get("device_type"));g.minDiskSize=h.get("minimal_disk_size");g.disks=h.get("disks");g.container=h.get("container");g.driveType=h.getDriveType();g.sparedDisk=0;var m=k.appWin.disks.getMatched("notUsedBySpace");var b=k.appWin.hotSpares.getAll();var a;if(0<g.disks.length){a=k.appWin.disks.data[g.disks[0]]}b.each(function(i){var q=k.appWin.disks.data[i.id];if(!a){return false}if(!c){if("cross"===g.container||("internal"===g.container&&"internal"!==q.get("container").type)||("ebox"===g.container&&a.get("container").order!==q.get("container").order)){return true}}if("Hybrid"===g.driveType||"Unknown"===g.driveType||("SSD"===g.driveType&&q&&!q.get("isSsd"))||("HDD"===g.driveType&&q&&q.get("isSsd"))){return true}if(q&&parseInt(q.get("size_total"),10)>=parseInt(h.get("minimal_disk_size"),10)&&"standby"===i.get("status").type&&q.is4Kn()===a.is4Kn()){if(!h.spare[i.id]){h.spare[i.id]=1;g.sparedDisk++}}},k);Ext.each(m,function(i){if(parseInt(i.get("size_total"),10)>=parseInt(h.get("minimal_disk_size"),10)&&i.is4Kn()===a.is4Kn()){g.available="yes";return false}},k);delete h.spare;g.orgSparedDisk=g.sparedDisk;g.available=g.available||"no";if(0<g.sparedDisk){g.status="spared"}else{if("yes"===g.available){g.status="available"}else{g.status="not-available"}}g.type=String.format("{0} / {1}",h.getDriveTypeStr(),g.raidType);k.data.pools.push(g)}k.data.pools.sort(function(q,i){if(q.order>i.order){return 1}if(q.order<i.order){return -1}return 0})},onClick:function(d,g){var b=new Ext.Element(d.ui.anchor);var c;if(d instanceof Ext.tree.AsyncTreeNode){b.toggleClass("x-tree-node-anchor-checked");c=b.hasClass("x-tree-node-anchor-checked");d.ui.checkbox.checked=c;d.childNodes.each(function(h){var e=new Ext.Element(h.ui.anchor);if(h.disabled){return true}h.ui.checkbox.checked=c;if(c&&!e.hasClass("x-tree-node-anchor-checked")){e.addClass("x-tree-node-anchor-checked")}else{if(!c){e.removeClass("x-tree-node-anchor-checked")}}})}else{b.toggleClass("x-tree-node-anchor-checked");c=b.hasClass("x-tree-node-anchor-checked");d.ui.checkbox.checked=c;var f=new Ext.Element(d.parentNode.ui.anchor);if(!c){d.parentNode.ui.checkbox.checked=false;f.removeClass("x-tree-node-anchor-checked")}else{var a=true;d.parentNode.childNodes.each(function(e){if(!e.ui.checkbox.checked){a=false;return false}});if(a){d.parentNode.ui.checkbox.checked=true;f.addClass("x-tree-node-anchor-checked")}}}if(this.appWin.supportRaidGroup){this.checkRaidGroupSpareCoverage()}else{this.checkSpaceSpareCoverage()}},checkRaidGroupSpareCoverage:function(){var c=this,a=[];var b=this.supportRaidCross&&this.appWin.hotSpareConf.cross_repair;this.diskPanel.root.childNodes.each(function(e){e.childNodes.each(function(f){if(f.ui.checkbox.checked&&!f.disabled){a.push(f.id)}},this)},this);var d=c.appWin.hotSpares;Ext.each(this.data.pools,function(h){var f=c.appWin.storagePools.getById(h.id);var g=(-1!==f.get("device_type").indexOf("shr"));var e;h.sparedDisk=0;h.spare={};if(g){Ext.each(a,function(k){var j=c.appWin.disks.data[k];var i=d[k];if(0===h.disks.length){return true}e=c.appWin.disks.data[h.disks[0]];if(!b){if("cross"===h.container||("internal"===h.container&&"internal"!==j.get("container").type)||("ebox"===h.container&&e.get("container").order!==j.get("container").order)){return true}}if("Hybrid"===h.driveType||"Unknown"===h.driveType||("SSD"===h.driveType&&!j.get("isSsd"))||("HDD"===h.driveType&&j.get("isSsd"))){return true}if(j&&parseInt(j.get("size_total"),10)>=parseInt(h.minDiskSize,10)&&j.get("diskType")==="SATA"&&(!i||"standby"===i.get("status").type)&&j.is4Kn()===e.is4Kn()){if(!h.spare[k]){h.spare[k]=1;h.sparedDisk++}}},this)}else{if(0<h.disks.length){e=this.appWin.disks.data[h.disks[0]]}Ext.each(f.get("raids"),function(i){var j;if(!i.devices||0===i.devices.length){return true}j=c.appWin.disks.data[i.devices[0].id];Ext.each(a,function(m){var l=c.appWin.disks.data[m];var k=d.getById(m);if(!b){if("cross"===h.container||("internal"===h.container&&"internal"!==l.get("container").type)||("ebox"===h.container&&e.get("container").order!==l.get("container").order)){return true}}if("Hybrid"===h.driveType||"Unknown"===h.driveType||("SSD"===h.driveType&&!l.get("isSsd"))||("HDD"===h.driveType&&l.get("isSsd"))){return true}if(l&&parseInt(l.get("size_total"),10)>=parseInt(i.minDevSize,10)&&l.get("diskType")===h.hddType&&(!k||"standby"===k.get("status").type)&&l.is4Kn()===j.is4Kn()){if(!h.spare[m]){h.spare[m]=1;h.sparedDisk++}}},this)},this)}delete h.spare;if(0<h.sparedDisk){h.status="spared"}else{if("yes"===h.available){h.status="available"}else{h.status="not-available"}}},this);this.raidGroupView.getStore().loadData(this.data,false)},checkSpaceSpareCoverage:function(){var a=[];var b=this.supportRaidCross&&this.appWin.hotSpareConf.cross_repair;this.diskPanel.root.childNodes.each(function(d){d.childNodes.each(function(e){if(e.ui.checkbox.checked&&!e.disabled){a.push(e.id)}},this)},this);var c=this.appWin.hotSpares.data;Ext.each(this.data.pools,function(d){d.sparedDisk=0;d.spare={};Ext.each(a,function(h){var g=this.appWin.disks.data[h];var f=c[h];var e;if(0===d.disks.length){return true}e=this.appWin.disks.data[d.disks[0]];if(!b){if("cross"===d.container||("internal"===d.container&&"internal"!==g.get("container").type)||("ebox"===d.container&&e.get("container").order!==g.get("container").order)){return true}}if("Hybrid"===d.driveType||"Unknown"===d.driveType||("SSD"===d.driveType&&g&&!g.get("isSsd"))||("HDD"===d.driveType&&g&&g.get("isSsd"))){return true}if(g&&parseInt(g.get("size_total"),10)>=parseInt(d.minDiskSize,10)&&(!f||"standby"===f.get("status").type)&&e.is4Kn()===g.is4Kn()){if(!d.spare[h]){d.spare[h]=1;d.sparedDisk++}}},this);delete d.spare;if(0<d.sparedDisk){d.status="spared"}else{if("yes"===d.available){d.status="available"}else{d.status="not-available"}}},this);this.raidGroupView.getStore().loadData(this.data,false)},getNext:function(){var d=false;var c=[];var a={};this.diskPanel.root.childNodes.each(function(e){e.childNodes.each(function(f){if(f.ui.checkbox.checked){if(!this.appWin.hotSpares[f.id]){d=true}a[f.id]=true;c.push({path:"/dev/"+f.id,model:this.appWin.disks.data[f.id].get("model")})}},this)},this);if(!d){Ext.each(this.appWin.hotSpares.getAll(),function(e){if(!a[e.id]){d=true;return false}},this)}if(!d){this.owner.close();return false}var b={api:"SYNO.Storage.CGI.Spare",method:"set",version:1,params:{spares:c}};if(0<c.length){this.owner.getMsgBox({btnStyle:"red"}).confirm(this.owner.title,_T("volume","volume_adddisk_type_two_warning"),function(e){if("yes"===e){this.owner.applySettings(b)}},this)}else{this.owner.applySettings(b)}return false}});Ext.define("SYNO.SDS.StorageManager.Wizard.AdvSetSpare",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var d=this,c,b=[];d.supportRaidCross=("yes"===_D("supportraidcross","no"));d.isDataChanged=false;b.push({xtype:"syno_formpanel",trackResetOnLoad:true,title:a.appWin.supportRaidGroup?_T("volume","volume_raid_group"):_T("volume","spare_trg"),appWin:a.appWin,owner:a.owner,width:610,height:375,items:[{xtype:"syno_displayfield",value:a.appWin.supportRaidGroup?_T("volume","spare_trg_desc_raid_group"):_T("volume","spare_trg_desc")},d.grid=d.createSpaceGrid()]});if(d.supportRaidCross){b.push({xtype:"syno_formpanel",trackResetOnLoad:true,title:_T("volume","spare_cross"),appWin:a.appWin,owner:a.owner,itemId:"spare_cross",items:[{xtype:"syno_checkbox",boxLabel:_T("volume","spare_cross_enable"),itemId:"cross_repair"},{xtype:"syno_displayfield",indent:1,value:a.appWin.supportRaidGroup?_T("volume","spare_cross_desc_raid_group"):_T("volume","spare_cross_desc")}]})}c={title:_T("volume","spare_setting_title"),width:650,height:500,resizable:false,layout:"fit",border:false,items:[{xtype:"syno_tabpanel",activeTab:0,itemId:"spare_conf",items:b}],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:d,handler:d.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:d,handler:d.onCancel}]};d.callParent([Ext.apply(c,a)])},createSpaceGrid:function(){var b=new SYNO.ux.EnableColumn({dataIndex:"enabled",id:"enable",bindRowClick:true,sortable:true,align:"center"});var a=Ext.apply({enableHdMenu:false,enableColumnMove:false,layout:"fit",width:590,height:320,style:{padding:"5px 0px 0px 0px"},cls:"without-dirty-red-grid",plugins:b,columns:[b,{header:_T("common","name"),dataIndex:"name",width:200},{header:_T("volume","volume_raid_type"),dataIndex:"raidType",width:150},{header:_T("volume","volume_disk_type"),dataIndex:"diskType",width:150}],store:new Ext.data.JsonStore({autoDestroy:true,fields:["id","enabled","name","raidType","diskType","space_path"],idProperty:"id",root:"spaces"})});return new SYNO.ux.GridPanel(a)},getTabForm:function(a){return this.getComponent("spare_conf").getComponent(a).form},getSpaces:function(){var g=this;var c={raid_1:1,raid_5:1,raid_6:1,raid_10:1,shr_with_1_disk_protect:1,shr_with_2_disk_protect:1};var j=SYNO.SDS.StorageUtils;var b=g.appWin.storagePools.getAll();var h=g.appWin.volumes.getMatched(function(){return !this.isLogicalVolume()});var k=g.appWin.iscsiLuns.getMatched(function(){return !this.isLogicalVolume()&&this.isBlockLun()});var f;if(g.appWin.supportRaidGroup){f=b}else{f=b.concat(h,k)}g.spaceData={spaces:[]};for(var e=0;e<f.length;++e){var d={},a=f[e];if(!(a.get("device_type") in c)){continue}if("SSD"!==a.getDriveType()&&"HDD"!==a.getDriveType()){continue}d.id=a.id;d.enabled=true;d.name=j.SpaceIDParser(a.id).str;d.raidType=j.RaidLevelRender(a.get("device_type"));d.diskType=g.appWin.disks.data[a.get("disks")[0]].get("diskType")+" "+a.getDriveTypeStr();d.space_path=a.get("space_path");g.appWin.hotSpareConf.disable_repair.each(function(i){if(i===d.space_path){d.enabled=false;return false}},g);g.spaceData.spaces.push(d)}g.spaceData.spaces.sort(function(l,i){if(l.id>i.id){return 1}if(l.id<i.id){return -1}return 0})},onOpen:function(){var a=this;a.callParent(arguments);if(a.supportRaidCross){a.getTabForm("spare_cross").setValues(a.appWin.hotSpareConf)}a.getSpaces();a.grid.getStore().loadData(a.spaceData,false)},onSave:function(){var d=this,e={},a=d.grid.getStore(),b=[];if(d.supportRaidCross&&!d.getTabForm("spare_cross").isDirty()&&0===a.getModifiedRecords().length){d.close();return}for(var c=0;c<a.getCount();++c){if(!a.getAt(c).get("enabled")){b.push(a.getAt(c).get("space_path"))}}if(d.supportRaidCross){e.cross_repair=d.getTabForm("spare_cross").findField("cross_repair").getValue()}e.disable_repair=b;d.sendWebAPI({api:"SYNO.Storage.CGI.Spare.Conf",method:"set",version:1,params:e,scope:d,callback:function(h,g,f){d.clearStatusBusy();if(!h){d.getMsgBox().alert(_T("volume","spare_setting_title"),g.text?g.text:_T("common","error_system"));return}d.isDataChanged=true;d.close()}})},onCancel:function(){this.close()}});Ext.define("SYNO.SDS.StorageManager.Spare.Store",{extend:"Ext.data.JsonStore",constructor:function(a){var c=this,b;c.sortField="numId";c.sortDir="ASC";b={autoDestroy:true,idProperty:"id",fields:["numId","id","iconCls","statusIconCls","displayName","summaryStatus","desc","property","spaces"],listeners:{load:function(){c.sort(c.sortField,c.sortDir)},scope:c}};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.StorageManager.HotSpare.Main",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.appWin;c.createView();b={itemId:"hot_spare",border:false,layout:"fit",tbar:{defaultType:"syno_button",items:[{itemId:"manage",text:_T("volume","volume_manage"),handler:this.onManage,scope:this},{itemId:"advset",text:_T("common","configure"),handler:this.onAdvSet,scope:this}]},items:c.view,listeners:{activate:c.onActivate,scope:c}};c.callParent([Ext.apply(b,a)])},getHelpParam:function(){if(this.appWin.supportRaidGroup){return"StorageManager/hotspare2.html"}else{return"StorageManager/hotspare.html"}},createView:function(){var d=this,c,b,a;if(d.appWin.supportRaidGroup){c=new SYNO.SDS.StorageManager.ListTpl({scope:"spaces",title:_T("volume","volume_spare_protected_raid"),emptyText:_T("volume","volume_spare_no_protected_raid"),columns:[{header:_T("common","name"),dataIndex:"name"},{header:_T("volume","volume_raid_subgroup"),dataIndex:"number"},{header:_T("volume","volume_raid_title"),dataIndex:"raidLevel"},{header:_T("volume","volume_diskstatus"),dataIndex:"status"}]})}else{c=new SYNO.SDS.StorageManager.ListTpl({scope:"spaces",title:_T("volume","volume_spare_protected_space"),emptyText:_T("volume","volume_spare_no_protected_space"),columns:[{header:_T("common","name"),dataIndex:"name",width:"20"},{header:_T("volume","volume_raid_title"),dataIndex:"raidLevel",width:"50"},{header:_T("volume","volume_diskstatus"),dataIndex:"status",width:"30"}]})}b=new Ext.XTemplate('<div class="item-detail-inner">',c.html,"</div>");a={appWin:d.appWin,owner:d,dataType:"hotSpares",itemId:"spareView",multiSelect:false,singleSelect:false,selectedClass:"",detailTpl:b,store:new SYNO.SDS.StorageManager.Spare.Store()};d.view=new SYNO.SDS.StorageManager.DataView(a)},prepareUiData:function(){var b=this,d=b.appWin.hotSpares.getAll(),a,c;delete b.uiData;b.uiData=[];for(a=0;a<d.length;++a){c={};b.prepareSummary(d[a],c);if(b.appWin.supportRaidGroup){b.prepareRaidGroup(d[a],c)}else{b.prepareSpaces(d[a],c)}b.uiData.push(c)}},prepareSummary:function(b,e){var d=this,c=d.appWin.disks.data[b.id],a=parseInt(c.get("size_total"),10),f,g;e.id=c.get("id");e.displayName=c.get("name");e.summaryStatus=String.format("&nbsp;-&nbsp;{0}",d.getStatusString(b));f=String.format("{0} {1}",(a/1024/1024/1024).toFixed(2),_T("status","status_disk_size_unit"));if(d.appWin.supportSas){g=String.format("{0} / {1}",c.get("diskType"),(c.get("isSsd"))?"SSD":"HDD")}else{g=(c.get("isSsd"))?"SSD":"HDD"}e.desc=String.format("{0} {1}",f,g);e.iconCls="sm-list-icon-spare"},prepareRaidGroup:function(e,h){var g=this,d={raid_1:1,raid_5:1,raid_6:1,raid_10:1,shr_with_1_disk_protect:1,shr_with_2_disk_protect:1},c=SYNO.SDS.StorageUtils,f=g.appWin.storagePools.getAll(),a=g.appWin.disks.data,b=("repairing"===e.get("status").type);h.spaces=[];Ext.each(f,function(i){var j;if(b&&e.get("status").space_path!==i.get("space_path")){return true}if(!(i.get("device_type") in d)){return true}j=1;Ext.each(i.get("raids"),function(m){var k,l;Ext.each(m.devices,function(n){k=a[n.id];if(k){return false}},this);if(!k){return true}l=a[e.id];if(l&&parseInt(m.minDevSize,10)<=parseInt(e.get("size"),10)&&k.get("diskType")===l.get("diskType")){h.spaces.push({name:c.SpaceIDParser(i.get("id")).str,number:1===i.get("raids").length?"-":j,raidLevel:c.SpaceTypeRender(i.get("device_type")),status:c.StatusRender(i.get("status"),i.get("progress"))})}++j},this)})},prepareSpaces:function(g,b){var e=this,h=SYNO.SDS.StorageUtils,a={raid_1:1,raid_5:1,raid_6:1,raid_10:1,shr_with_1_disk_protect:1,shr_with_2_disk_protect:1},i,f,k,c,d=e.appWin.disks.data,j=d[g.get("id")];i=e.appWin.storagePools.getAll();f=e.appWin.volumes.getMatched(function(){return !this.isLogicalVolume()});k=e.appWin.iscsiLuns.getMatched(function(){return !this.isLogicalVolume()});c=i.concat(f,k);b.spaces=[];Ext.each(c,function(m){var l;if(!(m.get("device_type") in a)){return}if(0===m.get("disks").length){return}l=d[m.get("disks")[0]];if(!l){return true}if("no"===_D("supportraidcross","no")&&l.get("container").type!==j.get("container").type){return true}if(parseInt(m.get("minimal_disk_size"),10)<=parseInt(j.get("size_total"),10)){b.spaces.push({name:h.SpaceIDParser(m.get("id")).str,raidLevel:h.SpaceTypeRender(m.get("device_type")),status:h.StatusRender(m.get("status"),m.get("progress"))})}})},getStatusString:function(g){var e=this,j=SYNO.SDS.StorageUtils,c,a,f,h,d,k,b=false;c=g.get("status");if(e.appWin.supportRaidGroup){if("repairing"===c.type){a=e.appWin.storagePools.getMatched(function(){return g.get("status").space_path===this.get("space_path")});if(0<a.length){b=(-1!==a[0].get("device_type").indexOf("shr"));f=j.SpaceIDParser(a[0].get("id")).str;if(!b){h=a[0].get("raids");for(d=0;d<h.length;++d){if(h[d].raidPath===g.get("status").raid_path){k=(d+1).toString();break}}}}}return b?j.SpareStatusRender(c.type,f):j.SpareStatusRender(c.type,f,k)}else{if("repairing"===g.get("status").type){a=e.findSpace(g.get("status").space_path);if(a){f=j.SpaceIDParser(a.get("id")).str}}return j.SpareStatusRender(c.type,f)}},findSpace:function(g){var e=this,b,d=e.appWin.storagePools.getAll(),f,c,a;f=e.appWin.volumes.getMatched(function(){return !this.isLogicalVolume()});c=e.appWin.iscsiLuns.getMatched(function(){return !this.isLogicalVolume()});a=d.concat(f,c);Ext.each(a,function(h){if(g===h.get("space_path")){b=h;return false}},e);return b},setMask:function(){if(this.isVisible()&&0===this.view.getStore().getCount()){this.body.mask(_T("volume","volume_no_spare"),"syno-ux-mask-info")}if(0<this.view.getStore().getCount()){this.body.unmask()}},onActivate:function(){var b=this,a=b.view.store;b.prepareUiData();a.suspendEvents(true);a.loadData(b.uiData,false);a.resumeEvents();if(0<b.view.store.getCount()&&0===b.view.getSelectedItemIds().length){b.view.select(0,true,true)}b.setMask()},onManage:function(){var b=this;var a=new SYNO.SDS.StorageManager.Wizard.ManageSpare({appWin:b.appWin,owner:b.owner});b.appWin.stopPollTask();a.mon(a,"close",function(){if(Ext.isFunction(a.hideFromOwner)){a.hideFromOwner()}if(a.isDataChanged){this.owner.setStatusBusy();this.body.unmask();this.owner.cleanMask=true}this.appWin.startPollTask()},this,{single:true});a.open()},onAdvSet:function(){var b=this;var a=new SYNO.SDS.StorageManager.Wizard.AdvSetSpare({appWin:b.appWin,owner:b.owner});b.appWin.stopPollTask();a.mon(a,"close",function(){if(Ext.isFunction(a.hideFromOwner)){a.hideFromOwner()}if(a.isDataChanged){this.owner.setStatusBusy();this.owner.cleanMask=true}this.appWin.startPollTask()},this,{single:true});a.open()}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateSsdCache",{extend:"SYNO.SDS.Wizard.ModalWindow",isDataChanged:false,diskStepWarningMsgs:[],estimateMemWarningMsgs:[],constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("volume","volume_ssd_create_wizard_title"),width:640,height:520,minHeight:475,minWidth:640,resizable:true,border:false,steps:[]};if("yes"===_D("support_write_cache","no")){b.steps.push(new SYNO.SDS.StorageManager.Wizard.CacheModeStep({appWin:c.appWin,freeSSDs:a.freeSSDs,itemId:"cacheMode",nextId:"choose"}))}b.steps.push(new SYNO.SDS.StorageManager.Wizard.CreateChooseSsdStep({appWin:c.appWin,volumes:a.volumes,luns:a.luns,freeSSDs:a.freeSSDs,itemId:"choose"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.SsdRaidTypeStep({appWin:c.appWin,itemId:"raidType"}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.CacheSizeStep({appWin:c.appWin,itemId:"size",nextId:null}));c.callParent([Ext.apply(b,a)])},applySettings:function(b,a){this.setStatusBusy();SYNO.API.Request({api:"SYNO.Storage.CGI.Flashcache",method:b,version:1,params:a,callback:function(f,e,d,c){this.clearStatusBusy();if(!f){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(e);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,e);return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));this.isDataChanged=true;this.close()},scope:this})},getCacheMode:function(){var a=this;if(a.inHistory("cacheMode")){return a.getStep("cacheMode").getCacheMode()}else{return"readCache"}},getTargetSpaceId:function(){return this.getStep("choose").getComponent("target").getValue()},getDiskIds:function(){return this.getStep("choose").getIds()},getRaidType:function(){var a=this;if(a.inHistory("raidType")||(a.inHistory("cacheMode")&&"writeCache"===this.getStep("cacheMode").getForm().getValues().cacheMode)){return a.getStep("raidType").getForm().getValues().raid}else{return"raid_0"}},estimateMem:function(){var c=this,b=c.getTargetSpaceId(),a,d;c.estimateMemWarningMsgs=[];if("yes"===_D("support_write_cache","no")){a=c.getCacheMode();if("writeCache"===a){c.estimateMemWarningMsgs.push(_T("volume","write_cache_warning"));c.estimateMemWarningMsgs.push(_T("volume","write_cache_protection_warning"))}}else{a="readCache"}d={cacheMode:a,cache_devices:c.getDiskIds(),reference_path:b,raidType:c.getRaidType()};c.setStatusBusy();SYNO.API.Request({api:"SYNO.Storage.CGI.Flashcache",method:"estimate_mem_size",version:1,params:d,callback:function(h,g,f,e){c.clearStatusBusy();if(!h){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,g);return}if(!g.canCreate){c.getMsgBox().alert(c.title,_T("volume","not_enough_mem_for_cache"));return}c.maxCacheSizeGB=Math.floor(SYNO.SDS.StorageUtils.GetSizeGB(parseInt(g.allowedCacheSize,10),0));c.maxCacheSizeByte=g.allowedCacheSize;c.goNext("size")},scope:c})}});Ext.define("SYNO.SDS.StorageManager.Wizard.CacheModeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.freeSSDs=a.freeSSDs||[];b={headline:_T("volume","volume_add_mode_title"),labelWidth:200,items:[{xtype:"syno_radio",boxLabel:_T("volume","write_cache_option"),name:"cacheMode",itemId:"writeCache",inputValue:"writeCache",disabled:(1>=c.freeSSDs.length)?true:false,checked:(1<c.freeSSDs.length)?true:false},{xtype:"syno_displayfield",indent:1,value:_T("volume","write_cache_desc")},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_radio",boxLabel:_T("volume","read_cache_option"),name:"cacheMode",itemId:"readCache",inputValue:"readCache",checked:(1<c.freeSSDs.length)?false:true},{xtype:"syno_displayfield",indent:1,value:_T("volume","read_cache_desc_new")}]};c.callParent([Ext.apply(b,a)])},getCacheMode:function(){return this.getForm().getValues().cacheMode}});Ext.define("SYNO.SDS.StorageManager.Wizard.CreateChooseSsdStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.freeSSDs=a.freeSSDs||[];c.volumes=a.volumes||null;c.luns=a.luns||null;c.maxSSD=12;b={headline:_T("volume","volume_ssd_create_wizard_headline"),labelWidth:140,items:[{xtype:"syno_storage_combobox",itemId:"target",name:"target",hiddenName:"target",width:180,displayField:"display",descriptionField:"desc",valueField:"id",emptyText:_T("volume","ssd_cache_selection_hint"),fieldLabel:_T("volume","ssd_cache_on"),tpl:new Ext.XTemplate('<tpl for=".">',"<tpl if=\"type == 'volume'\">",'<div ext:qtip="{tooltip:htmlEncode}" class="x-combo-list-item {[values.conflict?"sm-ssd-combo-disabled-list-item":""]}" style="height: 52px">',"</tpl>","<tpl if=\"type == 'lun'\">",'<div ext:qtip="{tooltip:htmlEncode}" class="x-combo-list-item">',"</tpl>",'<div ext:qtip="{tooltip:htmlEncode}" class="sds-combo-list-item-name">{display}</div>','<div ext:qtip="{tooltip:htmlEncode}" class="sds-combo-list-item-description">{desc}</div>',"</div>","</tpl>"),store:new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:["id","display","type","desc","tooltip","conflict"]}),listeners:{select:function(){this.checkState()},beforeselect:function(f,d,e){if(d.data.conflict){return false}},scope:this}},{xtype:"syno_displayfield",width:10,value:" "},c.disks=new SYNO.SDS.StorageManager.Wizard.SsdGrid({appWin:c.appWin,owner:c,itemId:"disks"})]};c.callParent([Ext.apply(b,a)])},loadDisks:function(){var b=this,a,d,c=[];for(a=0;a<b.freeSSDs.length;a++){d=b.freeSSDs[a];c.push({enabled:false,id:d.id,num_id:d.get("num_id"),name:d.get("name"),model:d.get("model"),size_total:d.get("size_total"),container:d.get("container"),diskType:d.get("diskType"),support:d.get("support"),isSsd:d.get("isSsd")})}c.sort(function(f,e){if(f.container.order>e.container.order){return 1}if(f.container.order<e.container.order){return -1}if(f.num_id>e.num_id){return 1}if(f.num_id<e.num_id){return -1}return 0});b.getComponent("disks").setHeight(45+c.length*28);b.disks.getStore().loadData({disks:c},false)},getIds:function(){var a=[];this.disks.getStore().each(function(b){if(b.get("enabled")){a.push(b.id)}});return a},getDiskNums:function(){var a=[];this.disks.getStore().each(function(b){if(b.get("enabled")){a.push(b.get("num_id"))}});return a},getNames:function(){var a=[];this.disks.getStore().each(function(b){if(b.get("enabled")){a.push(b.get("name"))}});return a},getDisks:function(){var a=[];this.disks.getStore().each(function(b){if(b.get("enabled")){a.push(b)}});return a},getStore:function(){return this.disks.getStore()},activate:function(){var b=this,a=0,c=b.getComponent("target"),d=c.getStore();c.clearValue();d.loadData(b.prepareTargetData(),false);while(a<d.getCount()){if(!d.getAt(a).data.conflict){c.setValue(d.getAt(a).id);break}a++}b.loadDisks()},prepareTargetData:function(){var a=[],c;var b=_T("volume","ssd_cache_conflict_with_timebackup");if("yes"===_D("support_write_cache","no")){c=("writeCache"===this.owner.getStep("cacheMode").getForm().getValues().cacheMode)}else{c=false}this.volumes.each(function(d){var f=SYNO.SDS.StorageUtils.SpaceIDParser(d.get("id")).str;var e=c&&d.get("timebackup");var g=d.get("desc");a.push({id:d.get("id"),display:f,type:"volume",desc:g,tooltip:e?String.format(b,f):g,conflict:e})});this.luns.each(function(e){var d=e.get("iscsi_lun").name;a.push({id:e.get("id"),display:d,type:"lun",desc:"",tooltip:d,conflict:false})});return a},checkState:function(){var c=this.getComponent("target"),a=0,b;if("yes"===_D("support_write_cache","no")){b=("writeCache"===this.owner.getStep("cacheMode").getForm().getValues().cacheMode)}else{b=false}SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);this.disks.getStore().each(function(d){if(d.get("enabled")){++a}});if(0===a||this.maxSSD<a||(1===a&&b)||""===c.getValue()){this.owner.getButton("next").disable()}else{this.owner.getButton("next").enable()}},deactivate:function(){this.owner.getButton("next").enable()},getNext:function(){var e=this,c=[],b,g=false,i="size",f=true,h,a=[];if(""===e.owner.getTargetSpaceId()){return}a.push(e.owner.getTargetSpaceId());if(SYNO.SDS.StorageUtils.isExistRunningvDSM(e.volumes,a)){e.owner.getMsgBox().alert(e.owner.title,_TT("SYNO.SDS.Virtualization.Application","vm","exist_alive_vm_err"));return false}e.owner.diskStepWarningMsgs=[];if("yes"===_D("support_write_cache","no")&&"writeCache"===e.owner.getCacheMode()){g=true;i="raidType"}e.disks.getStore().each(function(k){if(k.get("enabled")){c.push(k)}});if(0===c.length||this.maxSSD<c.length||(1===c.length&&g)){return false}b=c[0].get("container").type;Ext.each(c,function(k){if(b!==k.get("container").type){e.owner.diskStepWarningMsgs.push(_T("volume","ssd_mix_disks_warning"));return false}},e);h=function(){e.owner.setStatusBusy();SYNO.API.Request({api:"SYNO.Storage.CGI.Flashcache",method:"check_system_raid",version:1,params:{cache_devices:e.getIds()},callback:function(p,o,n,m){var l,k;e.owner.clearStatusBusy();if(!p){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,o);return}if("warning"===o.sysRaidAct){e.owner.diskStepWarningMsgs.push(_T("volume","volume_sys_raid_remove_warning"))}if("repair"===o.sysRaidAct){l=String.format('<a class="link-font" href="#" id="{0}">{1}</a>',"gotoOverview",_T("helptoc","overview"));k=String.format(_T("volume","volume_sys_raid_repair"),l);e.owner.getMsgBox().alert(e.owner.title,k);e.mon(Ext.fly("gotoOverview"),"click",function(){e.appWin.selectPage("SYNO.SDS.StorageManager.Overview.Main");e.owner.close()},e);return}if(!g){e.owner.estimateMem()}else{e.owner.goNext(i)}},scope:e})};if(1<c.length){var d=c[0].get("model"),j=c[0].get("size");c.each(function(k){if(d!=k.get("model")||j!=k.get("size")){f=false;return}},e)}if(!f){e.owner.getMsgBox().confirm(e.owner.title,_T("volume","hybrid_ssd_warning"),function(k){if("yes"===k){h()}},e)}else{h()}return false},getTargetSpaceInfo:function(){var a=this.getComponent("target"),b;if(!a){return undefined}b=a.getStore().getById(a.getValue());return{type:b.get("type"),id:b.get("id")}}});Ext.define("SYNO.SDS.StorageManager.Wizard.SsdRaidTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b={headline:_T("volume","volume_add_levelselect"),items:[{xtype:"syno_radio",boxLabel:_T("volume","volume_type_raid_1"),name:"raid",itemId:"raid_1",inputValue:"raid_1"},{xtype:"syno_radio",boxLabel:_T("volume","volume_type_raid_5"),name:"raid",itemId:"raid_5",inputValue:"raid_5"},{xtype:"syno_radio",boxLabel:_T("volume","volume_type_raid_6"),name:"raid",itemId:"raid_6",inputValue:"raid_6"}]};b=Ext.apply(b,a);c.callParent([b])},activate:function(){var a=this,b=a.owner.getDiskIds();a.getComponent("raid_1").enable();a.getComponent("raid_5").disable();a.getComponent("raid_6").disable();a.getComponent("raid_1").setValue(true);if(b.length>=3){a.getComponent("raid_5").enable()}if(b.length>=4){a.getComponent("raid_1").disable();a.getComponent("raid_5").setValue(true);a.getComponent("raid_6").enable()}},getNext:function(){this.owner.estimateMem();return false}});Ext.define("SYNO.SDS.StorageManager.Wizard.CacheSizeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){var e=this,c,d,b;var f=("yes"===_D("cache_support_skip_seq_io","no"))?true:false;e.appWin=a.appWin;e.minCacheSizeGB=10;d=[{xtype:"syno_displayfield",value:(-1<_D("unique").indexOf("alpine"))?_T("volume","ssd_cache_size_mem_desc_new"):_T("volume","ssd_cache_size_mem_desc_new2")},{layout:"hbox",itemId:"size",border:false,fieldLabel:String.format("{0} ({1})",_T("volume","volume_allocate_size_field_name"),_T("common","size_gb")),items:[{xtype:"syno_numberfield",allowDecimals:false,validateOnBlur:true,width:150,itemId:"size_value",minValue:e.minCacheSizeGB,maxlength:e.minCacheSizeGB,enableKeyEvents:true,listeners:{keyup:function(h,g){e.updateMemField()},scope:e}},{xtype:"syno_displayfield",width:10,value:" "},{xtype:"syno_button",itemId:"size_max",text:_T("common","max"),handler:function(h,g){e.sizeCmp.setValue(e.sizeCmp.maxValue);e.updateMemField()},scope:e}]},{xtype:"syno_displayfield",itemId:"consumed_mem",fieldLabel:_T("volume","required_mem_size")}];b=[{xtype:"syno_checkbox",htmlEncode:false,boxLabel:_T("volume","cache_skip_seq_io")+"</br>"+_T("volume","cache_skip_seq_io_desc"),name:"skip_seq_io",hidden:!f}];c={labelWidth:200,headline:_T("volume","cache_configuration"),items:[d,b]};e.callParent([Ext.apply(c,a)]);e.sizeCmp=e.getComponent("size").getComponent("size_value");e.memCmp=e.getComponent("consumed_mem")},activate:function(){var c=this,d=c.owner.getStep("choose"),a,b;c.sizeCmp.setValue(c.owner.maxCacheSizeGB);c.sizeCmp.maxValue=c.owner.maxCacheSizeGB;if(c.minCacheSizeGB>c.owner.maxCacheSizeGB){c.sizeCmp.minValue=c.owner.maxCacheSizeGB}c.updateMemField();a=d.getTargetSpaceInfo();if(!a){return}if("lun"===a.type){b=c.owner.appWin.iscsiLuns.data[a.id]}else{b=c.owner.appWin.volumes.data[a.id]}if(!b){return}if(""!==b.get("pool_path")&&!(b=c.owner.appWin.storagePools.data[b.get("pool_path")])){return}if(parseInt(_D("cache_skip_seq_io_min_num_disk","999"),10)<=b.get("disks").length){c.getForm().setValues({skip_seq_io:true})}else{c.getForm().setValues({skip_seq_io:false})}},updateMemField:function(){var d=this,c=SYNO.SDS.StorageUtils.GetSizeUnit,b,a=d.sizeCmp.getValue();a=(""===a)?"0":a;b=c(a*1024*416);d.memCmp.setValue(String.format("{0} {1}",b.size,b.unit));if(!d.getForm().isValid()){d.owner.getButton("next").disable()}else{d.owner.getButton("next").enable()}},getNext:function(){this.applyCache();return false},applyCache:function(f){var k=this,m=k.owner.getStep("choose"),p,a,n=m.getComponent("target"),h=n.getStore().getById(n.getValue()),g,c,l=[],j=false,d,e;if("yes"===_D("support_write_cache","no")){a=k.owner.getStep("cacheMode").getForm().getValues().cacheMode}else{a="readCache"}var b=k.owner.getStep("size").getForm().getValues().skip_seq_io==="true"?true:false;if(k.sizeCmp.getValue()===k.sizeCmp.maxValue){p=k.owner.maxCacheSizeByte;j=true}else{p=parseInt(k.sizeCmp.getValue(),10)*1024*1024*1024}d={cacheMode:a,disk_id:m.getIds(),size:p.toString(),skipSeqIO:b,isMax:j,reference_path:h.get("id"),raidType:k.owner.getRaidType()};g=k.owner.diskStepWarningMsgs.concat(k.owner.estimateMemWarningMsgs);if(0===g.length){c=_T("volume","volume_stop_all_service")}else{l.push(_T("volume","confirm_following_notice")+"<br/><br />");for(e=0;e<g.length;++e){l.push(String.format("{0}. {1} <br/>",e+1,g[e]))}l.push(String.format("{0}. {1} <br/>",e+1,_T("volume","volume_stop_all_service")));c=l.join("")}var o=new SYNO.SDS.StorageManager.Dialog.Confirm({owner:k.owner,title:k.owner.title,message:c,winHeight:(0===g.length)?60:g.length*60,confirmText:_T("volume","format_hd_confirm"),callback:function(){k.owner.applySettings.defer(1,k.owner,["create",d])}});o.open()}});Ext.define("SYNO.SDS.StorageManager.Wizard.CacheAdvisor",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("volume","ssd_cache_advisor"),width:840,height:568,border:false,closable:false,steps:[]};b.steps.push(new SYNO.SDS.StorageManager.Wizard.SelectVolStep({appWin:c.appWin,itemId:"selectVol",nextId:"statResult",checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);this.owner.getButton("next").show();if(!this.volSelected){this.owner.getButton("next").setDisabled(true)}else{this.owner.getButton("next").setDisabled(false)}this.owner.getButton("cancel").setText(_T("common","close"))}}));b.steps.push(new SYNO.SDS.StorageManager.Wizard.StatResultStep({appWin:c.appWin,itemId:"statResult",nextId:null,checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);this.owner.getButton("back").show();this.owner.getButton("back").setDisabled(true);this.owner.getButton("next").hide();this.owner.getButton("cancel").setText(_T("common","close"))}}));c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.StorageManager.Wizard.SelectVolStep",{extend:"Ext.form.FormPanel",volSelected:false,constructor:function(a){var f=this,c,b;var g='<div style="height:162px;position: relative;"><div class="sm-ssd-advisor-frame">{0}{1}</div></div>';var e='<div style="font-weight: bold;line-height: 20px;padding: 8px 12px 4px 12px;">'+_T("volume","ssd_cache_benefit")+"</div>";var d='<div style="width: 776px;line-height: 18px;padding: 0px 12px 8px 12px">'+_T("volume","ssd_cache_benefit_desc")+"</div>";c={headline:_T("volume","ssd_cache_advisor"),description:_T("volume","cache_advisor_sel_vol_step"),labelWidth:300,fieldWidth:300,items:[{xtype:"syno_displayfield",value:_T("volume","cache_advisor_sel_vol_desc"),height:58},{xtype:"syno_storage_combobox",itemId:"spaceId",displayField:"display",descriptionField:"desc",valueField:"id",emptyText:_T("tree","leaf_volume"),fieldLabel:_T("tree","leaf_volume"),store:new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:["id","display","desc"]}),listeners:{select:f.onVolumeChange,scope:f}},{xtype:"syno_displayfield",fieldLabel:_T("volume","cache_enabled"),id:"cacheEnabled"},{xtype:"syno_displayfield",fieldLabel:_T("volume","cache_size"),id:"cacheSize"},{xtype:"syno_displayfield",fieldLabel:_T("volume","cache_write_mode"),id:"cacheMode"},{html:String.format(g,e,d),border:false}]};f.callParent([Ext.apply(c,a)]);b=f.getSpaceIdCmp().getStore();f.mon(b,"load",function(){if(0<b.getCount()&&!f.volSelected){f.getSpaceIdCmp().setValue(b.getAt(0).id);f.onVolumeChange(f.getSpaceIdCmp(),b.getAt(0),0);f.volSelected=true}},f)},activate:function(){var a=this,b=[];if(!a.volSelected){Ext.each(a.appWin.volumes.getMatched("notUsedByGlusterFs"),function(c){b.push({id:c.get("id"),display:SYNO.SDS.StorageUtils.SpaceIDParser(c.get("id")).str,desc:c.get("desc")})});a.getSpaceIdCmp().getStore().loadData(b,false)}},onVolumeChange:function(d,e,a){var c=this,b;c.owner.volId=e.get("id");c.owner.targetCache=undefined;c.appWin.ssdCaches.dataArray.each(function(f){if(c.owner.volId===f.get("mountSpaceId")){b=f;c.owner.targetCache=f;return}});if(undefined!==b){c.owner.cacheRaidId=b.get("SSDPath").substr(b.get("SSDPath").lastIndexOf("/")+1);Ext.getCmp("cacheEnabled").setValue(_T("common","yes"));Ext.getCmp("cacheSize").setValue(SYNO.SDS.StorageUtils.SizeRender(parseInt(b.get("size").total,10)));if("read"===b.get("mode")){Ext.getCmp("cacheMode").setValue(_T("volume","cache_mode_read_only"))}else{Ext.getCmp("cacheMode").setValue(_T("volume","cache_mode_read_write"))}}else{c.owner.cacheRaidId="";Ext.getCmp("cacheEnabled").setValue(_T("common","no"));Ext.getCmp("cacheSize").setValue("--");Ext.getCmp("cacheMode").setValue("--")}},getSpaceIdCmp:function(){return this.getComponent("spaceId")}});Ext.define("SYNO.SDS.StorageManager.Wizard.StatResultStep",{extend:"Ext.form.FormPanel",constructor:function(a){var f=this,c;var g='<div class="sm-ssd-advisor-frame"><div class="sm-ssd-advisor-recomm-range"><div class="sm-ssd-advisor-recomm-left" id="recomm_left">{0}{1}</div><div class="sm-ssd-advisor-recomm-right" id="recomm_right">{2}</div></div></div>';var e='<div style="height: 20px;font-weight: bold;line-height: 20px;padding-bottom: 4px;">'+_T("common","recommendations")+"</div>";var d='<div style="line-height: 18px;" id="recomm_msg"></div>';var b='<div style="padding-top: 14px;height: 20px;line-height: 20px;">'+_T("volume","recomm_size")+'</div><div style="height: 40px;line-height: 40px;"><span style="font-size: 32px;color: #399EE6;" id="recomm_size">0</span><span style="font-size: 16px;color: #399EE6;" id="recomm_unit"> GB</span></div>';c={headline:_T("volume","ssd_cache_advisor"),description:_T("volume","cache_advisor_result_step"),border:false,items:[{layout:"vbox",border:false,items:[{border:false,height:247,width:800,padding:"0px 0px 8px 0px",items:[f.createUpperPanel()]},{border:false,height:104,width:800,html:String.format(g,e,d,b)}]}]};f.callParent([Ext.apply(c,a)]);f.ssdHeatStoreData={heatMap:[{name:_T("volume","data_accessed_hot"),value:0,color:"#FA575D",size:0,unit:"KB",period:_T("volume","data_accessed_in_one_day")},{name:_T("volume","data_accessed_warm"),value:0,color:"#FABB00",size:0,unit:"KB",period:_T("volume","data_accessed_in_one_week")},{name:_T("volume","data_accessed_cold"),value:0,color:"#399EE6",size:0,unit:"KB",period:_T("volume","data_accessed_in_one_month")},{name:_T("volume","data_accessed_archive"),value:0,color:"#8C96A0",size:0,unit:"KB",period:_T("volume","data_accessed_before_one_month")}]};f.mon(f,"activate",function(){if(f.owner.volId){f.description=String.format(_T("volume","cache_advisor_result_step"),SYNO.SDS.StorageUtils.SpaceIDParser(f.owner.volId).str)}},f)},createUpperPanel:function(){var b=this,a;var c='<div class="sm-ssd-heat-property"><div style="float: left;width: 70%;" id="{name}"><div style="background-color: {color}" class="sm-ssd-heat-color"></div><div style="float: left;font-size: 12px">{name}</div></div><div style="float: left;width: 30%;text-align: right;line-height: 24px;height: 24px;"><span style="font-size: 14px;font-weight: bold;">{size}</span><span style="padding-right: 10px;font-size: 12px;"> {unit}</span></div></div>';a={height:240,layout:"hbox",items:[new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<div style="height: 240px;width: 220px;padding-right: 19px;border-right-style: solid;border-right-width: 1px;border-right-color: #D8E1EC;">','<div id="sm_cache_heat_map" class="sm-ssd-heat-map"></div>','<tpl for="heatMap">',c,"</tpl>","</div>","</div>","</tpl>"),height:240,width:240,store:b.ssdHeatStore=new Ext.data.JsonStore({autoDestroy:true,fields:["heatMap"]})}),new SYNO.ux.Panel({width:560,height:240,border:false,items:[{border:false,html:'<div style="line-height: 28px;font-size: 15px;font-weight: normal;color: #0077CC;padding: 0px 0px 8px 20px;">'+_T("volume","recently_accessed_file_size")+"</div>"},{xtype:"syno_gridpanel",itemId:"reportGrid",border:false,padding:"0px 0px 0px 20px",columns:[{header:_T("volume","ssd_cache_static_day"),dataIndex:"access_day",width:180,sortable:false},{header:_T("volume","ssd_cache_static_file_count"),dataIndex:"file_count",width:180,sortable:false},{header:_T("volume","ssd_cache_static_total_file_size"),dataIndex:"file_size",width:180,renderer:SYNO.SDS.StorageUtils.SizeRender,sortable:false}],enableHdMenu:false,store:b.ssdStatStore=new Ext.data.JsonStore({autoDestroy:true,fields:["access_day","file_count","file_size"],listeners:{load:function(d,e){d.sort("access_day","DESC");if(d.getAt(6)){d.remove(d.getAt(6))}},scope:this}})}]})]};return new SYNO.ux.Panel(a)},activate:function(){this.getEl().mask(_T("common","loading"),"x-mask-loading");Ext.get("recomm_right").setStyle({display:"none"});Ext.get("recomm_left").removeClass("sm-ssd-advisor-recomm-left");Ext.get("recomm_left").addClass("sm-ssd-advisor-recomm-all");this.statCheckTask(false)},statCheckTask:function(a){var b=this;if(b.isDestroyed){return}b.owner.getButton("back").setDisabled(true);SYNO.API.Request({api:"SYNO.Storage.CGI.Flashcache",method:"statistics_check",version:1,params:{cacheRaidId:b.owner.cacheRaidId,volumeId:b.owner.volId},recalculate:a,callback:function(g,f,e,d){var c=this;if(c.isDestroyed){return}if(!g){c.owner.close();return}if(!g){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);c.owner.close();return}c.memCacheRatio=1*1024*1024/f.cache_mem_ratio;if(f.statisticsInfo&&f.statisticsInfo.is_processing){if(!d.recalculate){c.getEl().mask(_T("volume","volume_wait_calc_stat"),"x-mask-loading");c.owner.getMsgBox().alert(_T("volume","ssd_cache_advisor"),_T("volume","stat_task_processing_warn"),function(){c.statCheckTask.defer(5000,c,[true])},c)}else{c.statCheckTask.defer(5000,c,[true])}}else{c.getEl().unmask();c.owner.getButton("back").setDisabled(false);c.updateHandler(d,g,f)}},scope:b})},updateHandler:function(a,d,c){var b=this;if(this.isDestroyed){return}if(!d){b.owner.close();return}if(!d){b.owner.close();return}if(undefined===c.statisticsResult){return}if(0<c.statisticsResult.length){b.ssdStatStore.loadData(c.statisticsResult,false);if(!a.recalculate){b.owner.getMsgBox().confirm(_T("volume","ssd_cache_advisor"),String.format(_T("volume","stat_task_recalculate"),c.statisticsTime),function(e){if("yes"===e){b.onCalculate()}},b)}}else{b.onCalculate()}b.updateUI(c,SYNO.API.DecodeParams(a.params))},updateUI:function(j,h){var n=this,k=j.heatMap,l,c,b,m,p,g,f,e,d;var r,q={};var a=SYNO.SDS.StorageUtils.SpaceIDParser(n.owner.volId).str;var o=SYNO.SDS.StorageUtils.GetSizeUnit;if(undefined===k){return}b=n.ssdHeatStoreData.heatMap;for(l=0;l<b.length;++l){c="Level_"+l.toString();if(undefined!==k[c]&&"0"!==k[c]){b[l].value=k[c];f=o(k[c]);b[l].size=Math.floor(f.size);b[l].unit=f.unit}else{b[l].value=0;b[l].size=0;b[l].unit="KB"}}m=parseInt(b[0].value,10);p=parseInt(b[1].value,10);n.ssdHeatStore.loadData([n.ssdHeatStoreData],false);n.drawChart();for(l=0;l<b.length;++l){Ext.get(b[l].name).dom.qtip=b[l].period}if(n.isVolumeDisksAllSSD()){Ext.get("recomm_msg").dom.innerHTML=String.format(_T("volume","recomm_msg_ssd_vol"),a)}else{if(undefined===n.owner.targetCache){if(m+p<j.memAllowedMaxCacheSize){g=m+p}else{if(m<j.memAllowedMaxCacheSize){g=m}else{g=j.memAllowedMaxCacheSize}}if(0===j.memAllowedMaxCacheSize){Ext.get("recomm_msg").dom.innerHTML=String.format(_T("volume","recomm_msg_cannot_create_cache"),a)}else{e=o(g);Ext.get("recomm_right").setStyle({display:"block"});Ext.get("recomm_left").removeClass("sm-ssd-advisor-recomm-all");Ext.get("recomm_left").addClass("sm-ssd-advisor-recomm-left");Ext.get("recomm_size").dom.innerHTML=e.size;Ext.get("recomm_unit").dom.innerHTML=" "+e.unit;if(g<=j.memAllowedCacheSize){Ext.get("recomm_msg").dom.innerHTML=String.format(_T("volume","recomm_msg_create_cache"),a,e.size+" "+e.unit)}else{d=o((g-j.memAllowedCacheSize)/n.memCacheRatio);Ext.get("recomm_msg").dom.innerHTML=String.format(_T("volume","recomm_msg_mem_not_enough"),a,Math.ceil(d.size)+" "+d.unit)}}}else{r=j.histData.FlashCache;n.updateHistData(r,"Current",h.cacheRaidId,0,q);n.updateHistData(r,"Minutely",h.cacheRaidId,q.Current,q);n.updateHistData(r,"Daily",h.cacheRaidId,q.Minutely,q);n.updateHistData(r,"Weekly",h.cacheRaidId,q.Daily,q);n.updateHistData(r,"Monthly",h.cacheRaidId,q.Weekly,q);if(40>q.Monthly){Ext.get("recomm_msg").dom.innerHTML=String.format(_T("volume","recomm_msg_low_hit_rate"),a,q.Monthly)}else{Ext.get("recomm_msg").dom.innerHTML=String.format(_T("volume","recomm_msg_high_hit_rate"),a,q.Monthly)}}}},updateHistData:function(c,a,f,b,e){var d;e[a]=b;if(c[a].success&&c[a][f]){d=c[a][f];if(d.success&&d.read_total>0){e[a]=Math.ceil(d.read_hit*100/d.read_total);if(100<e[a]){e[a]=100}}}},onCalculate:function(){var a=this;a.getEl().mask(_T("volume","volume_wait_calc_stat"),"x-mask-loading");a.owner.getButton("back").setDisabled(true);SYNO.API.Request({api:"SYNO.Storage.CGI.Flashcache",method:"statistics",version:1,params:{volumeId:a.owner.volId},callback:function(e,d,c,b){if(a.isDestroyed){return}if(!e){a.owner.close();return}if(!e){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);a.owner.close();return}this.statCheckTask(true)},scope:a})},drawChart:function(){var b=this,a;a=new SYNO.SDS.StorageManager.FlotrPieChart({collapsible:false,store:b.ssdHeatStore,height:120,hideMode:"offsets",border:false,totalRecords:0,chartType:{grid:{verticalLines:false,horizontalLines:false,outlineWidth:0,labelMargin:0},xaxis:{showLabels:false},yaxis:{showLabels:false},pie:{show:true,lineWidth:0,explode:0,sizeRatio:0.98,fill:true,fillOpacity:1,startAngle:3/4,labelFormatter:function(c){return""}},shadowSize:0,legend:{show:false}},renderTo:"sm_cache_heat_map"})},isVolumeDisksAllSSD:function(){var c=this,a=c.appWin.disks,b=true,d,e;if(c.owner.owner.supportRaidGroup){d=c.appWin.volumes.data[c.owner.volId].get("pool_path");e=c.appWin.storagePools.data[d].get("disks");if(0===e.length){return false}else{e.each(function(f){if(!a.data[f].isSSD()){b=false;return}})}}else{c.appWin.volumes.data[c.owner.volId].get("disks").each(function(f){if(!a.data[f].isSSD()){b=false;return}})}return b}});Ext.define("SYNO.SDS.StorageManager.Wizard.SsdGrid",{extend:"SYNO.ux.GridPanel",MAX_SSD_NUM:12,constructor:function(b){var d=this,a=b.owner,f,c,e;if(isNaN(e=parseInt(_D("max_ssd_number",""),10))){e=d.MAX_SSD_NUM}f=new SYNO.ux.EnableColumn({disableSelectAll:true,dataIndex:"enabled",id:"enable",bindRowClick:true,width:40,sortable:false,align:"center",onCellClick:function(h,i,k){var j=h.getStore(),g=0;j=h.getStore();this.toggleRec(j.getAt(i));j.each(function(l){if(l.get("enabled")){++g}});if(e<g){j.getAt(i).set("enabled",false)}if(this.commitChanges){j.commitChanges()}}});c=Ext.apply({enableHdMenu:false,cls:"without-dirty-red-grid",plugins:f,layout:"fit",columns:[f,{header:_T("volume","volume_disknumber"),dataIndex:"name",width:120},{header:_T("volume","volume_diskcapacity"),dataIndex:"size_total",width:80,renderer:SYNO.SDS.StorageUtils.SizeRender},{header:_T("volume","volume_diskmodel"),dataIndex:"model",width:120}],store:new Ext.data.JsonStore({autoDestroy:true,root:"disks",fields:["id","num_id","enabled","name","model","size_total","container","diskType","support","isSsd"],listeners:{update:function(g,h,i){if(Ext.data.Record.EDIT!==i){return}if(!this.allowBlank){a.checkState()}},scope:this}})},b);d.callParent([c])}});Ext.define("SYNO.SDS.StorageManager.Wizard.RepairSsdCache",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var c=this,b;c.isDataChanged=false;c.appWin=a.appWin;c.owner=a.owner;c.fail_disk_count=a.fail_disk_count;b={title:_T("volume","ssd_cache_repair_wizard_title"),width:600,height:475,minWidth:600,minHeight:475,resizable:true,border:false,steps:[]};b.steps.push(new SYNO.SDS.StorageManager.Wizard.RepairChooseSsdStep({appWin:c.appWin,owner:c.owner,freeSSDs:a.freeSSDs,space_id:a.space_id,ssd_id:a.ssd_id,ssd_path:a.ssd_path,itemId:"disks",nextId:null}));c.callParent([Ext.apply(b,a)])},applySettings:function(b,a){this.setStatusBusy();SYNO.API.Request({api:"SYNO.Storage.CGI.Flashcache",method:b,version:1,params:a,callback:function(f,e,d,c){this.clearStatusBusy();if(!f){SYNO.SDS.StorageUtils.HARemoteCheckErrParsing(e);SYNO.SDS.StorageUtils.ReportWebapiFailure(this,e);return}this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));this.isDataChanged=true;this.close()},scope:this})}});Ext.define("SYNO.SDS.StorageManager.Wizard.RepairChooseSsdStep",{extend:"SYNO.ux.FormPanel",warningMsgs:null,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.freeSSDs=a.freeSSDs||[];c.space_id=a.space_id;c.ssd_id=a.ssd_id;c.ssd_path=a.ssd_path;b={headline:_T("volume","ssd_cache_repair_headline"),labelWidth:200,items:c.disks=new SYNO.SDS.StorageManager.Wizard.SsdGrid({owner:c,itemId:"disks"})};c.callParent([Ext.apply(b,a)])},getIds:function(){var a=[];this.disks.getStore().each(function(b){if(b.get("enabled")){a.push(b.id)}});return a},getDiskNums:function(){var a=[];this.disks.getStore().each(function(b){if(b.get("enabled")){a.push(b.get("num_id"))}});return a},getNames:function(){var a=[];this.disks.getStore().each(function(b){if(b.get("enabled")){a.push(b.get("name"))}});return a},getDisks:function(){var a=[];this.disks.getStore().each(function(b){if(b.get("enabled")){a.push(b)}});return a},getStore:function(){return this.disks.getStore()},activate:function(){this.loadDisks()},loadDisks:function(){var a,c,b=[];for(a=0;a<this.freeSSDs.length;a++){c=this.freeSSDs[a];b.push({enabled:false,id:c.id,num_id:c.get("num_id"),name:c.get("name"),model:c.get("model"),size_total:c.get("size_total"),container:c.get("container"),diskType:c.get("diskType"),support:c.get("support"),isSsd:c.get("isSsd")})}b.sort(function(e,d){if(e.container.order>d.container.order){return 1}if(e.container.order<d.container.order){return -1}if(e.num_id>d.num_id){return 1}if(e.num_id<d.num_id){return -1}return 0});this.getComponent("disks").setHeight(45+b.length*28);this.disks.getStore().loadData({disks:b},false)},checkState:function(){var b=this,a=0;SYNO.SDS.Wizard.Step.prototype.checkState.apply(b,arguments);b.disks.getStore().each(function(c){if(c.get("enabled")){++a}});if(0===a||b.owner.fail_disk_count<a){b.owner.getButton("next").disable()}else{b.owner.getButton("next").enable()}},deactivate:function(){this.owner.getButton("next").enable()},getNext:function(){var c=this,d,b,a;c.warningMsgs="";d={action:"estimate_repair_cache",cache_devices:c.getIds(),reference_path:c.space_id,ssd_id:c.ssd_id,ssd_path:c.ssd_path};c.owner.setStatusBusy();SYNO.API.Request({api:"SYNO.Storage.CGI.Flashcache",method:"estimate_repair",version:1,params:d,callback:function(h,g,f,e){c.owner.clearStatusBusy();if(!h){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,g);return}if(g.sysRaidAct&&"none"!==g.sysRaidAct){if("warning"===g.sysRaidAct){c.warningMsgs=_T("volume","volume_sys_raid_remove_warning");c.openConfirmDialog()}else{if("repair"===g.sysRaidAct){b=String.format('<a class="link-font" href="#" id="{0}">{1}</a>',"gotoOverview",_T("helptoc","overview"));a=String.format(_T("volume","volume_sys_raid_repair"),b);c.owner.getMsgBox().alert(c.owner.title,a);c.mon(Ext.fly("gotoOverview"),"click",function(){c.owner.owner.setActiveFunction("overview");c.owner.close()},c)}}}else{c.openConfirmDialog()}},scope:c.appWin});return false},openConfirmDialog:function(){var a=this,c={disk_id:a.getIds(),reference_path:a.space_id,ssd_id:a.ssd_id,ssd_path:a.ssd_path};var b=new SYNO.SDS.StorageManager.Dialog.Confirm({owner:a.owner,title:a.owner.title,message:(""===a.warningMsgs)?" ":a.warningMsgs,winHeight:0,confirmText:_T("volume","ssd_repair_format_confirm"),callback:function(){a.owner.applySettings.defer(1,a.owner,["repair",c])}});b.open()}});Ext.define("SYNO.SDS.StorageManager.Wizard.CacheSetting",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.skipSeqIO=a.skipSeqIO;c.ssdPath=a.ssdPath;c.mountSpaceId=a.mountSpaceId;b={title:_T("common","configure"),width:450,height:180,minWidth:450,minHeight:180,layout:"fit",items:[{xtype:"syno_formpanel",itemId:"main",border:false,trackResetOnLoad:true,items:[{xtype:"syno_checkbox",name:"skip_seq_io",htmlEncode:false,boxLabel:_T("volume","cache_skip_seq_io")+"</br>"+_T("volume","cache_skip_seq_io_desc"),value:0}]}],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};c.callParent([Ext.apply(b,a)])},getForm:function(){return this.getComponent("main").getForm()},onOpen:function(){var a=this;a.callParent(arguments);a.getForm().setValues({skip_seq_io:a.skipSeqIO})},onSave:function(){var a=this;if(!this.getForm().isDirty()){this.close();return}if(!this.getForm().isValid()){return}this.setStatusBusy();SYNO.API.Request({api:"SYNO.Storage.CGI.Flashcache",method:"configure",version:1,params:{ssdPath:a.ssdPath,mountSpaceId:a.mountSpaceId,skipSeqIO:Boolean(a.getForm().findField("skip_seq_io").getValue())},callback:function(e,d,c,b){this.clearStatusBusy();if(!e){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,d);return}this.isDataChanged=true;this.close()},scope:this})},onCancel:function(){if(this.getForm().isDirty()){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()}});Ext.define("SYNO.SDS.StorageManager.FlotrPieChart",{extend:"Ext.Panel",initialChartType:null,chartType:null,flotr:null,constructor:function(b){var a={margins:{top:0,right:0,bottom:0,left:0},border:false};this.initialChartType=SYNO.SDS.Utils.clone(b.chartType);Ext.apply(a,b);this.callParent([a])},initEvents:function(){this.callParent(arguments);this.mon(this,"afterlayout",function(){if(!this.collapsed&&!this.flotr){this.drawChart()}},this)},genSeries:function(c){var b,a,d=true;if(undefined===this.store||undefined===(a=this.store.getAt(0).data.heatMap)){return}a.each(function(e){if(0!==e.value){d=false;return}});if(!d){for(b=0;b<a.length;b++){c[b]={};c[b].data=[];c[b].data.push([a[b].name,a[b].value]);c[b].Label=a[b].name;c[b].color=a[b].color}}else{c[0]={data:[[_T("volume","data_accessed_archive"),100]],Lable:_T("volume","data_accessed_archive"),color:"#8C96A0"}}},drawChart:function(){var a=[];this.genSeries(a);this.flotr=Flotr.draw(this.body.dom,a,this.chartType)},onResize:function(){this.callParent(arguments);this.drawChart()}});Ext.define("SYNO.SDS.StorageManager.SsdCache.Store",{extend:"Ext.data.JsonStore",constructor:function(a){var c=this,b;c.sortField="numId";c.sortDir="ASC";b={autoDestroy:true,idProperty:"id",fields:["numId","id","iconCls","statusIconCls","displayName","desc","summaryStatus","property","devices","spaces","spaceTitle"],listeners:{load:function(){c.sort(c.sortField,c.sortDir)},scope:c}};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.StorageManager.SsdCache.Main",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.appWin;c.ssdStore=new SYNO.SDS.StorageManager.SsdCache.Store();c.createListPanel();c.createDetailPanel();b={border:false,layout:"card",activeItem:"listPanel",items:[c.listPanel,c.detailPanel],listeners:{activate:c.onActivate,deactivate:c.onDeactivate,nextDetail:function(){var d=c.listView.getSelectedItem();if(undefined!==d&&"umount_ssd"!==d.get("status")){c.detailView.onActivate();c.getLayout().setActiveItem("detailPanel");c.detailView.updateDevListScrollBar()}},prevList:function(){c.getLayout().setActiveItem("listPanel");c.detailView.onDeactivate()},scope:c}};c.callParent([Ext.apply(b,a)])},getHelpParam:function(){return"StorageManager/genericssdcache.html"},createListPanel:function(){var b=this,a;a={appWin:b.appWin,owner:b,dataType:"ssdCaches",itemId:"cacheView",multiSelect:false,singleSelect:true,isCardLayout:true,store:b.ssdStore};b.listView=new SYNO.SDS.StorageManager.DataView(a);b.listPanel=new Ext.Panel({itemId:"listPanel",border:false,items:b.listView,layout:"fit",tbar:{defaultType:"syno_button",items:[{itemId:"create",text:_T("common","create"),handler:b.onCreate,scope:b},{itemId:"repair",text:_T("volume","volume_adddisk2_type_repair"),handler:b.onRepair,scope:b},{itemId:"remove",text:_T("common","remove"),handler:b.onDelete,scope:b},{itemId:"configure",text:_T("common","configure"),hidden:("yes"!==_D("cache_support_skip_seq_io","no")),handler:b.onConfigure,scope:b},{itemId:"statistic",text:_T("volume","ssd_cache_advisor"),handler:b.onStatistic,scope:b}]}})},createDetailPanel:function(){var b=this,a;a={appWin:b.appWin,owner:b,dataType:"ssdCaches",itemId:"detailView"};b.detailView=new SYNO.SDS.StorageManager.DetailView(a);b.detailFieldSet=new SYNO.SDS.StorageManager.FieldSet({title:_T("common","main_page"),items:b.detailView});b.detailPanel=new Ext.Panel({itemId:"detailPanel",border:false,items:b.detailFieldSet})},prepareUiData:function(){var b=this,a=b.appWin.ssdCaches.getAll(),c;delete b.uiData;b.uiData=[];Ext.each(a,function(d){c={};b.prepareSummary(d,c);b.prepareDevices(d,c);b.prepareSpaces(d,c);b.uiData.push(c)},b)},prepareSummary:function(e,f){var c=SYNO.SDS.StorageUtils,b,d,a=parseInt(e.get("size").total,10);if("space_missing"===e.get("cacheStatus")){b=c.StatusNameRender(e.get("cacheStatus"))}else{if("write_bypass"===e.get("mode")){b=c.StatusNameRender("crashed")}else{b=c.StatusRender(e.get("status"),e.get("progress"))}}d=e.id.split("_");if(2===d.length){f.numId=parseInt(d[1],10)}else{f.numId=0}f.id=e.id;f.displayName=c.SpaceIDParser(e.id).str;f.summaryStatus=String.format("&nbsp;-&nbsp;{0}",b);f.desc=String.format("{0} {1}",(a/1024/1024/1024).toFixed(2),_T("status","status_disk_size_unit"));f.iconCls="sm-list-icon-ssdCache";if(e.get("is_actioning")){f.statusIconCls="sm-list-status-icon-acting"}else{if("crashed"===e.get("status")||"degrade"===e.get("status")){f.statusIconCls="sm-list-status-icon-crashed"}}},prepareProperty:function(d,e){var b=SYNO.SDS.StorageUtils,a,c;if("space_missing"===d.get("cacheStatus")){a=b.StatusNameRender(d.get("cacheStatus"))}else{if("write_bypass"===d.get("mode")){a=b.StatusNameRender("crashed")}else{a=b.StatusRender(d.get("status"),d.get("progress"))}}e.property=[{name:_T("common","name"),value:b.SpaceIDParser(d.id).str},{name:_T("volume","ssd_cache_on"),value:b.SpaceIDParser(d.get("mountSpaceId")).str}];if("yes"===_D("support_write_cache","no")){switch(d.get("mode")){case"write":c=_T("volume","cache_mode_read_write");break;case"read":c=_T("volume","cache_mode_read_only");break;default:c="-";break}e.property.push({name:_T("volume","cache_write_mode"),value:c})}e.property.push({name:_T("volume","volume_totalsize"),value:b.SizeRender(parseInt(d.get("size").total,10))});e.property.push({name:_T("volume","ssd_cache_read_hit_ratio"),value:d.get("hit_rate")+" %"});if("yes"===_D("support_write_cache","no")&&"write"===d.get("mode")){e.property.push({name:_T("volume","ssd_cache_write_hit_ratio"),value:d.get("hit_rate_write")+" %"})}e.property.push({name:_T("volume","volume_volumestatus"),value:a});e.property.push({name:_T("volume","volume_ssd_consume_memory"),value:b.SizeRender(parseInt(d.get("memory"),10))});if("yes"===_D("cache_support_skip_seq_io","no")){e.property.push({name:_T("volume","cache_skip_seq_io_capital"),value:d.get("skipSeqIO")?_T("common","yes"):_T("common","no")})}},prepareDevices:function(c,e){var b=this,a=SYNO.SDS.StorageUtils,d;e.devices=[];Ext.each(c.get("disks"),function(f){d=b.appWin.disks.data[f];if(!d){return true}e.devices.push({container:d.get("container").str,name:d.get("name"),size:a.SizeRender(d.get("size_total")),status:a.DiskStatusRender(d.get("status"))})},b);e.devices.sort(function(g,f){if(g.container.str===f.container.str){return(g.id>f.id)?1:((g.id===f.id)?0:-1)}return(g.container.str>f.container.str)?1:((g.container.str===f.container.str)?0:-1)})},prepareSpaces:function(i,c){var d=this,f=SYNO.SDS.StorageUtils,e=i.get("mountSpaceId"),b=f.SpaceIDParser(e),a=("volume"===b.type)?d.appWin.volumes.data[e]:d.appWin.iscsiLuns.data[e],g,h;c.spaces=[];if("volume"===b.type){g=parseInt(a.get("size").total,10);h=parseInt(a.get("size").used,10);c.spaces.push({name:b.str,usedSize:f.SizeRender(h),freeSize:f.SizeRenderWithFloor(g-h),status:f.SizeRender(g)});c.spaceTitle=_T("volume","volume_mount_volume_info")}else{if("iscsi"===b.type){c.spaces.push({name:a.get("iscsi_lun").name,usedSize:"-",freeSize:"-",status:f.SizeRender(parseInt(a.get("iscsi_lun").size,10))});c.spaceTitle=_T("volume","volume_mount_lun_info")}else{return}}},setMask:function(){var a=this.getMaskMsg();if(this.isVisible()&&0===this.listView.getStore().getCount()){this.listView.getEl().mask(a,"syno-ux-mask-info")}if(0<this.listView.getStore().getCount()){this.listView.getEl().unmask()}},getMaskMsg:function(){var b=this,d=b.appWin.disks.getMatched("isSSD","isFree","isSupported"),c,a;if(0===d.length){return _T("volume","cache_no_ssd")}c=b.appWin.volumes.getAll();a=b.appWin.iscsiLuns.getAll();if(0===c.length&&0===a.length){return _T("volume","cache_no_vol")}return _T("volume","volume_no_ssd_caches")},onActivate:function(){var b=this,a=b.listView.store;b.prepareUiData();a.suspendEvents(true);a.loadData(b.uiData,false);a.resumeEvents();b.resetBtnStatus();if(0<a.getCount()&&0===b.listView.getSelectedItemIds().length){b.listView.select(0,true,true);if(1===a.data.length&&true===b.listView.singleExpanded&&true!==b.firstTimeStepIn){b.fireEvent("nextDetail")}}b.firstTimeStepIn=true;b.onSelectChange();b.setMask();b.detailView.onActivate()},onDeactivate:function(){this.detailView.onDeactivate()},onSelectChange:function(){var b=this,a=b.listView.getSelectedItem();b.getButton("remove").hide();b.getButton("repair").hide();b.getButton("configure").hide();if(!a){return}b.getButton("remove").show();b.enableButton("remove",b.canDelete(a));if("yes"===_D("cache_support_skip_seq_io","no")){b.getButton("configure").show();b.enableButton("configure",b.canConfigure(a))}if("yes"===_D("support_write_cache","no")){b.getButton("repair").show();b.enableButton("repair",b.canRepair(a))}},onCreate:function(){var c=this,f,b,e={},d,a;f=c.appWin.disks.getMatched("isSSD","isFree","isSupported");b=function(){if(this.isFileLun&&this.isFileLun()){return false}if(this.isActioning()){return false}if(!this.get("vspace_can_do").flashcache.apply.can_do){return false}if("crashed"===this.get("status")){return false}if(this.usedByGlusterFs()){return false}if(e[this.get("id")]){return false}return true};Ext.each(c.appWin.ssdCaches.getAll(),function(g){e[g.get("mountSpaceId")]=true});d=c.appWin.volumes.getMatched(b);a=c.appWin.iscsiLuns.getMatched(b);c.openWizard("CreateSsdCache",{volumes:d,luns:a,freeSSDs:f})},onDelete:function(){var h=this,e,c=h.listView.getSelectedItem(),i=h.appWin.volumes.getAll(),a=[],g,b,d,f;if(!c){return}g=c.get("mountSpaceId");b=SYNO.SDS.Utils.StorageUtils.SpaceIDParser(c.get("mountSpaceId")).str;a.push(g);if(SYNO.SDS.StorageUtils.isExistRunningvDSM(i,a)){h.owner.getMsgBox().alert(h.owner.title,_TT("SYNO.SDS.Virtualization.Application","vm","exist_alive_vm_err"));return false}d={reference_path:g,ssd_id:c.get("id"),ssd_path:c.get("SSDPath")};if("space_missing"===c.get("cacheStatus")||!c.get("loaded")){delete d.reference_path;h.applySettings("remove",d)}else{e="1. "+String.format(_T("volume","ssd_cache_deattach_confirm"),b)+"<br>";e+="2. "+_T("volume","volume_all_service_stop");f=new SYNO.SDS.MessageBoxV5({owner:h.owner,confirmDelete:function(n,m,k,j,l){var o={yes:{text:_T("common","remove"),btnStyle:"red"},no:{text:_T("common","alt_cancel")}};this.showMsg({title:n,msg:m,buttons:l||o,fn:k,scope:j,icon:Ext.MessageBox.QUESTION,minWidth:this.minWidth});return this}});f.confirmDelete(_T("tree","leaf_volume"),e,function(j){if("yes"===j){if("detailPanel"===h.getLayout().activeItem.itemId){h.fireEvent("prevList")}h.applySettings("remove",d)}},h)}},onConfigure:function(){var c=this;var b=c.listView.getSelectedItem();if(!b){return}var d=b.get("skipSeqIO");var a=b.get("SSDPath");var e=b.get("mountSpaceId");c.openWizard("CacheSetting",{skipSeqIO:d,ssdPath:a,mountSpaceId:e})},onRepair:function(){var b=this,a=b.listView.getSelectedItem();b.openWizard("RepairSsdCache",{freeSSDs:b.getAvailableDisks(a),space_id:a.get("mountSpaceId"),ssd_id:a.id,ssd_path:a.get("SSDPath"),fail_disk_count:a.get("can_do").repair})},onStatistic:function(){var b=this,a;a=new SYNO.SDS.StorageManager.Wizard.CacheAdvisor({appWin:b.appWin,owner:b.owner});b.appWin.stopPollTask();a.mon(a,"close",function(){b.appWin.startPollTask()},b,{single:true});a.open()},onSort:function(b,a){var c;if(0>b.itemId.indexOf("_")){return}c=b.itemId.split("_")[1];c="id"===c?"num_id":c;if(this.listView.store.sortCriteria!==c){this.listView.store.sortCriteria=c;this.listView.store.sortOrder="ASC"}else{this.listView.store.sortOrder="ASC"===this.listView.store.sortOrder?"DESC":"ASC"}this.getTopToolbar().getComponent("sort").menu.items.each(function(d){d.setIconClass(d.itemId===b.itemId?"sds-space-sort-item-checked":"")});this.listView.store.sort();this.restoreUIState()},resetBtnStatus:function(){var a=this;a.enableButton("create",a.canCreate());a.enableButton("statistic",a.canStatistic())},setFocus:function(c){var a=this.listView.select(c);if(!a){return}var b=this.scroll.top+a.getXY()[1]-this.body.getXY()[1];this.body.scrollTo("top",b)},canCreate:function(){var e=this,h,f=e.appWin.volumes.getAll(),d=e.appWin.iscsiLuns.getAll(),c=e.appWin.ssdCaches.getAll(),b=false,a=false,g={};if(e.owner.env.settingSwap){return false}h=e.appWin.disks.getMatched("isSSD","isFree","isSupported");if(0===h.length){return false}Ext.each(c,function(i){g[i.get("mountSpaceId")]=true;if(i.isActioning()){b=true;return false}});if(b){return false}f.each(function(i){if(i.isActioning()){return true}if(!i.get("vspace_can_do").flashcache.apply.can_do){return true}if("crashed"===i.get("status")){return true}if(i.usedByGlusterFs()){return true}if(g[i.get("id")]){return true}a=true;return false});if(!a){d.each(function(i){if(i.isFileLun()){return true}if(i.isActioning()){return true}if(!i.get("vspace_can_do").flashcache.apply.can_do){return true}if("crashed"===i.get("status")){return true}if(g[i.get("id")]){return true}a=true;return false})}return a},canDelete:function(a){var b=this,e,d,c;if(a.isActioning()){return false}e=a.get("mountSpaceId");if("-"===e){return true}if(-1<e.indexOf("volume")){d=b.appWin.volumes.data[e]}else{d=b.appWin.iscsiLuns.data[e]}if(d.isActioning()){return false}c=d.get("vspace_can_do");if(!Ext.isDefined(c.flashcache)||!c.flashcache.remove){return false}return true},canRepair:function(b){var c=this,a;if(b.isActioning()||"space_missing"===b.get("cacheStatus")){return false}if(!Ext.isDefined(b.get("can_do").repair)){return false}if("write_bypass"===b.get("mode")){return false}if(0===b.get("disks").length){return false}a=c.getAvailableDisks(b);return(0<a.length)},canConfigure:function(a){if("umount_ssd"===a.get("status")||"mount_ssd"===a.get("status")){return false}return true},canStatistic:function(){var a=this,b=a.appWin.volumes.getAll();return(0<b.length)},getAvailableDisks:function(b){var c=this,a,d;d=b.get("minimal_disk_size");a=c.appWin.disks.getMatched(function(){var e=this;if(!e.isFree()){return false}if(c.appWin.hotSpares[e.id]){return false}if(!e.isSSD()){return false}if(parseInt(d,10)>parseInt(e.get("size_total"),10)){return false}return true});return a},openWizard:function(b,a){var c=this,e;if(c.appWin.isUpToBatchTaskCount()){e=_T("volume","volume_max_batch_task_count").replace("_MAX_TASK_",c.appWin.getMaxBatchTaskCount());c.appWin.getMsgBox().alert(c.title,e,function(){},c);return}var d=new SYNO.SDS.StorageManager.Wizard[b](Ext.apply({appWin:c.appWin,owner:c.owner},a));c.appWin.stopPollTask();c.mon(d,"close",function(){if(Ext.isFunction(d.hideFromOwner)){d.hideFromOwner()}if(d.isDataChanged){c.owner.setStatusBusy();c.listView.getEl().unmask();c.owner.cleanMask=true}c.appWin.startPollTask()},c,{single:true});d.open()},disableButtons:function(){Ext.each(arguments,function(d,a,c){var b=this.getButton(d);if(!b){throw Error("could not get button of id: "+d)}b.disable()},this)},getButton:function(a){return this.listPanel.getTopToolbar().getComponent(a)},enableButton:function(c,a){var b=this.getButton(c);if(!b){throw Error("could not get button of id: "+c)}return a?b.enable():b.disable()},applySettings:function(c,b){var a=this;a.owner.setStatusBusy();a.owner.cleanMask=true;a.appWin.stopPollTask();SYNO.API.Request({api:"SYNO.Storage.CGI.Flashcache",method:c,version:1,params:b,callback:function(g,f,e,d){a.appWin.startPollTask();if(!g){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,f);return}},scope:a})}});Ext.define("SYNO.SDS.StorageManager.DetailView",{extend:"SYNO.ux.Panel",ssdBlkNum:100,round:1,lightMSec:200,darkMSec:100,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.statusDesc={healthy:_T("volume","cache_healthy_desc"),caution:_T("volume","cache_degraded_desc"),attention:_T("volume","cache_crashed_desc")};c.ssdStore=new Ext.data.JsonStore({autoDestroy:true,fields:["status","name","desc","displayMountOn","mode","memSize","nameStatus","used","available","total","ratio","devInfos","dev_count","raidType"]});c.healthPanel=c.createHealthPanel();c.infoPanel=c.createInfoPanel();c.hitPanel=c.createHitPanel();b={border:false,layout:"vbox",padding:"0 0 0 0",items:[{height:176,border:false,style:"padding-top: 8px;padding-bottom: 16px;",items:c.healthPanel},{border:false,style:"padding-bottom: 12px;",items:c.infoPanel},{height:138,border:false,items:c.hitPanel}]};c.callParent([Ext.apply(b,a)]);c.createSSDBlks();c.initBlinkTask()},createHealthPanel:function(){var b=this,a,d;var c='<div style="line-height: 20px;width:500px;"><div style="float:left;width:180px;"><div style="font-weight: bold;">{0}:</div></div><div style="float:left;width:320px;white-space: nowrap;text-overflow:ellipsis;overflow:hidden;"><div>{1}</div></div></div>';b.ssdCacheHealth=new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<div style="height:152px;">','<div class="sm-ssd-health-icon sm-ssd-health-icon-{status}"></div>',"</div>","</tpl>"),store:b.ssdStore});d={itemId:"property",height:152,padding:"0 0 0 0",border:false,items:[new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<div style="height:116px;padding-bottom:8px;">','<div class="sm-ssd-name-status-text">{nameStatus}</div>','<div class="sm-ssd-name-desc">{desc}</div>',String.format(c,_T("volume","ssd_cache_on"),"{displayMountOn}"),String.format(c,_T("volume","cache_write_mode"),"{mode}"),String.format(c,_T("volume","volume_raid_title"),"{raidType}"),"</div>","</tpl>"),store:b.ssdStore}),{xtype:"syno_button",id:"repair",text:_T("volume","volume_adddisk2_type_repair"),handler:b.onRepair,scope:b},{xtype:"syno_button",id:"remove",text:_T("common","remove"),handler:b.onDelete,scope:b}]};b.ssdProperty=new SYNO.ux.FormPanel(d);a={border:false,layout:"hbox",align:"top",padding:"0 0 0 0",items:[{width:176,border:false,items:b.ssdCacheHealth},{width:500,border:false,items:b.ssdProperty}]};return new SYNO.ux.Panel(a)},createInfoPanel:function(){var e=this,d;var b='<div class="sm-ssd-usage-property" style="top: {2}px;">{0}: {1}</div>';var a='<div class="sm-ssd-dev-info"><span style="font-weight:bold;">{0}</span> {1}</div>';var c='<div class="sm-ssd-mini-dev-info">{0} {1}</div>';d={itemId:"info",width:716,padding:"1px 1px 1px 1px",items:[e.deviceInfo=new Ext.DataView({cls:"sm-ssd-info-panel",tpl:new Ext.XTemplate('<tpl for=".">','<div style="margin-left: 1px;" class="sm-ssd-info-box">','<tpl if="this.getLength(devInfos) <= 2">','<div style="font-size:15px;line-height: 24px;">',_T("volume","ssd_device_info"),"</div>","</tpl>",'<tpl if="this.getLength(devInfos) &gt; 2">','<div style="font-size:15px;line-height: 24px; margin-bottom: 8px">',_T("volume","ssd_device_info"),"</div>",'<div id="ssdMiniDevList" style="height: 112px; padding-bottom: 6px">',"</tpl>",'<tpl for="devInfos">','<tpl if="xcount === 1">','<div style="width: 100%;" align="center">','<div class="sm-ssd-dev-icon">','<div class="sm-ssd-dev-status-{status}"></div>',"</div>",String.format(a,"{name}","({cnr})"),String.format(a,"","{size}"),"</div>","</tpl>",'<tpl if="xcount === 2">','<tpl if="xindex === 1">','<div style="float: left; width: 50%;" align="center">','<div class="sm-ssd-dev-icon">','<div class="sm-ssd-dev-status-{status}"></div>',"</div>",String.format(a,"{name}","({cnr})"),String.format(a,"","{size}"),"</div>","</tpl>",'<tpl if="xindex === 2">','<div style="float: left; width: 50%;" align="center">','<div class="sm-ssd-dev-icon">','<div class="sm-ssd-dev-status-{status}"></div>',"</div>",String.format(a,"{name}","({cnr})"),String.format(a,"","{size}"),"</div>","</tpl>","</tpl>",'<tpl if="xcount &gt; 2">','<div class="sm-ssd-dev-list">','<div class="sm-ssd-mini-dev-icon">','<div class="sm-ssd-mini-dev-status-{status}"></div>',"</div>",'<div style="float: left">',String.format(c,"{name}","({cnr})"),"</div>",'<div style="float: left; right: 18px; position: absolute;">',String.format(c,"","{size}"),"</div>","</div>","</tpl>","</tpl>",'<tpl if="this.getLength(devInfos) &gt; 2">',"</div>","</tpl>","</div>",'<div style="display:table-cell; width:12px;">',"</div>",'<div class="sm-ssd-info-box">','<div style="font-size:15px;line-height: 24px;">',_T("volume","cache_usage"),"</div>",'<div id="sm_cache_usage_chart" class="sm-ssd-usage-pie"></div>','<div style="font-size:15px;line-height: 24px;font-weight: bold;position: absolute;top: 53px;left: 132px;">{name}</div>',String.format(b,_T("volume","volume_usedsize"),"{used}","77"),String.format(b,_T("volume","unused_size"),"{available}","97"),String.format(b,_T("volume","ssd_cache_static_total"),"{total}","117"),"</div>","</tpl>",{getLength:function(f){return f.length||0}}),store:e.ssdStore})]};return new SYNO.ux.Panel(d)},createHitPanel:function(){var c=this,b;var a='<span style="font-size: 32px;color: #1CA600;" id="{0}">{1}</span><span style="font-size: 16px;color: #1CA600;">%</span>';var d='<div class="sm-ssd-hit-property"><span style="padding-left: 10px;">{0}</span><span style="padding-left: 8px;font-size: 20px;color: #0086E5;" id="{1}">{2}</span><span style="font-size: 12px;color: #0086E5;">%</span></div>';b={itemId:"info",width:716,height:138,padding:"1px 1px 1px 1px",items:[c.deviceInfo=new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<div style="margin-left: 1px;" class="sm-ssd-hit-box">','<div style="font-size:15px;line-height: 24px;">',_T("volume","read_hit_rate"),"</div>",'<div style="position: absolute;left: 20px;top: 42px;height: 48px;width: 550px;">','<tpl for="ssdblocks">','<div class="sm-ssd-blk sm-ssd-blk-cold" id="{id}"></div>',"</tpl>","</div>",'<div style="position: absolute;left: 582px;top: 38px;height: 52px;width: 4px;background-color: #D8E1EC;"></div>','<div style="position: absolute;left: 598px;top: 38px;height: 18px;width: 94px;">',_T("rsrcmonitor","realtime"),"</div>",'<div style="position: absolute;left: 598px;top: 56px;height: 34px;width: 94px;">',String.format(a,"Current","{Current}"),"</div>",'<div style="position: absolute;left: 20px;bottom: 10px;height: 28px;width: 672px;">',String.format(d,_T("rsrcmonitor","last_24_hours"),"Daily","{Daily}"),String.format(d,_T("rsrcmonitor","last_7_days"),"Weekly","{Weekly}"),String.format(d,_T("rsrcmonitor","last_30_days"),"Monthly","{Monthly}"),"</div>","</div>","</tpl>"),store:c.ssdHitStore=new Ext.data.JsonStore({autoDestroy:true,fields:["ssdblocks","Current","Daily","Weekly","Monthly"]})})]};return new SYNO.ux.Panel(b)},initBlinkTask:function(){var b=this,a=0,c=[],d;b.blkBlinkTarget0=[];b.blkBlinkTarget1=[];b.blkTrgBase0=[];b.blkTrgBase1=[];while(c.length<b.ssdBlkNum){d=Math.floor(Math.random()*b.ssdBlkNum);if(-1!==c.indexOf(d)){continue}c.push(d)}for(a=0;a<c.length;++a){if(a%2===0){b.blkTrgBase0.push(c[a])}else{b.blkTrgBase1.push(c[a])}}b.counter0=0;b.counter1=0},createSSDBlks:function(){var b=this,a,c;b.hitData={};b.hitData.ssdblocks=[];c=b.hitData.ssdblocks;for(a=0;a<this.ssdBlkNum;++a){c.push({id:"ssdBlk_"+a})}},onActivate:function(){var b=this,d={},c=b.owner.listView.getSelectedItem();var a=Ext.get("ssdMiniDevList");if(!b.appWin.loaded){return}if(!c){b.owner.fireEvent("prevList");return}if(a&&a.dom.fleXdata){b.devScrolled=a.dom.fleXdata.scrollPosition[1][0]}b.targetSSD=c;b.prepareSsdCachedata(d);b.ssdStore.loadData([d],false);window.fleXenv.fleXcrollMain("ssdMiniDevList");a=Ext.get("ssdMiniDevList");if(b.devScrolled&&a&&a.dom&&a.dom.fleXcroll){a.dom.fleXcroll.setScrollPos(false,b.devScrolled)}b.prepareHitData();b.doLayout();b.updateUI(d);b.mon(Ext.fly(b.volLinkId),"click",b.linkTargetElement,b,{single:true});b.blinkTaskStart()},updateDevListScrollBar:function(){window.fleXenv.fleXcrollMain("ssdMiniDevList");this.doLayout()},onDeactivate:function(){var a=this;a.blinkTaskStop();if(a.loadHistPollTask){a.loadHistPollTask.stop();delete a.loadHistPollTask}a.resetUI()},resetUI:function(){var a=this;delete a.hitData;a.createSSDBlks();a.hitData.Current=0;a.hitData.Minutely=0;a.hitData.Daily=0;a.hitData.Weekly=0;a.hitData.Monthly=0;a.ssdHitStore.loadData([a.hitData],false)},blinkTaskStart:function(){var a=this;if(!a.isBlinking){a.isBlinking=true;a.blkLightTask0();a.blkLightTask1.defer(a.round*(a.lightMSec+a.darkMSec)/2,a)}},blinkTaskStop:function(){this.isBlinking=false},prepareHitData:function(){var b=this,a=b.targetSSD;if("space_missing"===a.get("cacheStatus")){return}if(!b.loadHistPollTask){b.loadHistPollTask=b.addWebAPITask({api:"SYNO.Storage.CGI.Flashcache",method:"load_history_data",version:1,interval:2000,params:{cacheRaidId:a.get("SSDPath").substr(a.get("SSDPath").lastIndexOf("/")+1)},callback:function(i,h,g,d){var c=this,e,f=g.cacheRaidId;if(c.isDestroyed||!i){return}if(!i||!h.histData||!h.histData.FlashCache){SYNO.SDS.StorageUtils.ReportWebapiFailure(this,h);return}e=h.histData.FlashCache;c.updateHistData(e,"Current",f,0);c.updateHistData(e,"Minutely",f,c.hitData.Current);c.updateHistData(e,"Daily",f,c.hitData.Minutely);c.updateHistData(e,"Weekly",f,c.hitData.Daily);c.updateHistData(e,"Monthly",f,c.hitData.Weekly);if(true!==c.initHitPanel){c.ssdHitStore.loadData([c.hitData],false);c.initHitPanel=true}},scope:b});b.loadHistPollTask.start()}},updateHistData:function(d,a,f,c){var b=this,e;b.hitData[a]=c;if(d[a]&&d[a].success&&d[a][f]){e=d[a][f];if(e.success&&e.read_total>0){b.hitData[a]=Math.ceil(e.read_hit*100/e.read_total);if(100<b.hitData[a]){b.hitData[a]=100}}}else{b.hitData[a]="--"}if(Ext.get(a)){Ext.get(a).dom.innerHTML=b.hitData[a]}},prepareSsdCachedata:function(e){var h=this,d="healthy",j=SYNO.SDS.StorageUtils,a=h.targetSSD;var i='<a class="{3}" {4} id="{0}" space_id="{1}">{2}</a>';var b='<div style="display:inline" ext:qtip="{0}">{1}</div>';var f,c,g;h.volLinkId=Ext.id();if("read"===a.get("mode")){e.mode=_T("volume","cache_mode_read_only")}else{e.mode=_T("volume","cache_mode_read_write")}if(a.isCrashed()||"write_bypass"===a.get("mode")){d="attention"}else{if(a.isDegrade()){d="caution"}}e.raidType=j.SpaceTypeRender(a.get("device_type"));e.name=j.SpaceIDParser(a.id).str;e.nameStatus=j.SpaceIDParser(a.id).str+" ("+j.StatusNameRender(a.get("status"))+")";e.desc=String.format(h.statusDesc[d],j.SpaceIDParser(a.id).str);if("space_missing"===a.get("cacheStatus")){e.desc=j.StatusNameRender("space_missing")}else{if("repairing"===a.get("status")){e.desc=String.format(_T("volume","cache_repairing_desc"),j.SpaceIDParser(a.id).str)+" "+j.ProgressRender(a.get("progress"))}}e.total=j.SizeRender(parseInt(a.get("size").total,10));if("space_missing"!==a.get("cacheStatus")&&("normal"===a.get("status")||"degrade"===a.get("status"))){e.used=j.SizeRender(parseInt(a.get("size").used,10));e.available=j.SizeRenderWithFloor(parseInt(a.get("size").total,10)-parseInt(a.get("size").used,10));e.ratio=parseInt(a.get("size").used,10)/parseInt(a.get("size").total,10)}else{e.used="--";e.available="--";e.ratio=0}e.status=d;e.dev_count=a.get("dev_count");if("space_missing"===a.get("cacheStatus")){c=String.format(i,h.volLinkId,a.get("mountSpaceId"),"--","normal-font","")}else{c=String.format(i,h.volLinkId,a.get("mountSpaceId"),Ext.util.Format.ellipsis(j.SpaceIDParser(a.get("mountSpaceId")).str,28),"link-font",'href="#"')}f=h.appWin.volumes.data[a.get("mountSpaceId")];if(f&&f.get("desc")){g=f.get("desc");e.displayMountOn=String.format("{0} ({1})",c,String.format(b,Ext.util.Format.htmlEncode(g),g))}else{e.displayMountOn=c}h.getDeviceInfo(e,a.get("disks"))},getDeviceInfo:function(e,d){var c,a=this.owner.owner.disks,b;if(!a){return}e.devInfos=[];for(c=0;c<d.length;++c){b=a.data[d[c]];if(undefined!==b){e.devInfos.push({name:_T("volume","volume_disk")+" "+b.get("num_id"),cnr:b.get("container").str,size:SYNO.SDS.StorageUtils.SizeRender(parseInt(b.get("size_total"),10)),status:b.get("status")})}}while(e.devInfos.length<e.dev_count){e.devInfos.push({name:_T("volume","volume_unknown_expansion"),cnr:"--",size:"--",status:"crashed"})}},updateUI:function(a){this.checkBtnStatus(this.targetSSD);this.drawPieChart(a.ratio)},checkBtnStatus:function(a){Ext.getCmp("repair").setDisabled(!this.owner.canRepair(a));Ext.getCmp("remove").setDisabled(!this.owner.canDelete(a))},drawPieChart:function(b){var a=new SYNO.SDS.Utils.canvas.circlegradient({radius:48,gradientWidth:16,height:96,width:96,canvasConfig:{height:96,width:96},renderTo:"sm_cache_usage_chart"});a.draw(Math.min(b,1))},resetBlinkTarget:function(d,b){var c=this,f,a,e=[];if(undefined===c.hitData||undefined===c.hitData.Current){return e}if(100<c.hitData.Current){c.hitData.Current=100}if(b){f=Math.ceil(c.hitData.Current/2)}else{f=Math.floor(c.hitData.Current/2)}while(e.length<f){a=Math.floor(Math.random()*c.ssdBlkNum/2);if(-1!==e.indexOf(d[a])){continue}e.push(d[a])}return e},blkLightTask0:function(){var b=this,a=0;b.blkBlinkTarget0=b.resetBlinkTarget(b.blkTrgBase0,true);if(undefined===b.blkBlinkTarget0||0===b.blkBlinkTarget0.length){if(b.isBlinking){b.blkLightTask0.defer(1000,b)}return}for(a=0;a<b.blkBlinkTarget0.length;a++){if(a===b.blkBlinkTarget0.length-1){b.blkLight(b.blkBlinkTarget0[a],0,true,true)}else{b.blkLight(b.blkBlinkTarget0[a],0,false,true)}}},blkLightTask1:function(){var b=this,a=0;b.blkBlinkTarget1=b.resetBlinkTarget(b.blkTrgBase1,false);if(undefined===b.blkBlinkTarget1||0===b.blkBlinkTarget1.length){if(b.isBlinking){b.blkLightTask1.defer(1000,b)}return}for(a=0;a<b.blkBlinkTarget1.length;a++){if(a===b.blkBlinkTarget1.length-1){b.blkLight(b.blkBlinkTarget1[a],0,true,false)}else{b.blkLight(b.blkBlinkTarget1[a],0,false,false)}}},blkLight:function(f,a,e,b){var d=this,c=Ext.get("ssdBlk_"+f.toString());if(c){c.addClass("sm-ssd-blk-hit");c.removeClass("sm-ssd-blk-cold");if(b){d.blkDarken.defer(d.lightMSec,d,[f,a,e,b])}else{d.blkDarken.defer(d.lightMSec,d,[f,a,e,b])}}},blkDarken:function(f,a,e,b){var d=this,c=Ext.get("ssdBlk_"+f.toString());if(c){c.removeClass("sm-ssd-blk-hit");c.addClass("sm-ssd-blk-cold")}if(!d.isBlinking){return}if(a<d.round-1){d.blkLight.defer(d.darkMSec,d,[f,++a,e,b])}else{if(e){if(b){d.blkLightTask0()}else{d.blkLightTask1()}}}},linkTargetElement:function(d,c){var b=this,a=new Ext.Element(c),f=a.getAttribute("space_id");if("-"===f){return}if(-1!==f.indexOf("volume_")){b.appWin.selectPage("SYNO.SDS.StorageManager.Volume.Main");b.appWin.getActivePage().setFocus(f)}else{b.appWin.selectPage("SYNO.SDS.StorageManager.iSCSILun.Main");b.appWin.getActivePage().setFocus(f)}},onRepair:function(){this.owner.onRepair()},onDelete:function(){this.owner.onDelete()}});Ext.namespace("SYNO.SDS.StorageManager.StorageOverview");Ext.namespace("SYNO.SDS.StorageManager.StorageOverview.DrawData");SYNO.SDS.StorageManager.StorageOverview.DrawData.Info={height:48,left:18,modelNameLeft:36,portWidth:36,portHeight:16,portGap:6,outPortLeft:183,outPortTop:26,hostOutPortTop:16,outLinkLeft:289,outLinkTop:32,hostOutLinkTop:21,inPortLeft:183,inPortTop:5,linkWidth:6,linkHeight:42,hostlinkHeight:52,linkGap:33,iconWidth:16,iconHeight:16};SYNO.SDS.StorageManager.StorageOverview.DrawData.Hdd={width:52,height:11,initLeft:16,initTop:2,hGap:6,vGap:5};SYNO.SDS.StorageManager.StorageOverview.DrawData.LcmHost={width:260,height:52,left:0,top:0,hddCount:10,hddLayout:[3,3,4],hdd:SYNO.SDS.StorageManager.StorageOverview.DrawData.Hdd,gap:4,info:SYNO.SDS.StorageManager.StorageOverview.DrawData.Info,lightHeight:24,lightLeft:322};SYNO.SDS.StorageManager.StorageOverview.DrawData.Enclosure={width:260,height:52,left:0,top:0,hddCount:12,hddLayout:[4,4,4],hdd:SYNO.SDS.StorageManager.StorageOverview.DrawData.Hdd,gap:4,info:SYNO.SDS.StorageManager.StorageOverview.DrawData.Info,lightHeight:24,lightLeft:322};Ext.define("SYNO.SDS.StorageManager.Enclosure",{check:SYNO.SDS.StorageUtils.check,get:function(a){if(this.json){return this.json[a]}return undefined}});Ext.define("SYNO.SDS.StorageManager.StorageOverview.Main",{extend:"SYNO.ux.Panel",pollTask:null,hdds:null,displayDiskNum:false,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.appWin;b={title:_T("helptoc","Enclosure"),itemId:"storage_overview",border:false,autoFlexcroll:true,tbar:{items:[{xtype:"syno_button",itemId:"DiskNumToggle",text:_T("volume","volume_display_disk_num"),handler:c.onDiskNumber,scope:c}]},items:c.canvas=new Ext.Panel({border:false,height:520}),listeners:{activate:c.onActivate,deactivate:c.onDeactivate,scope:c}};c.callParent([Ext.apply(b,a)])},getHelpParam:function(){return"StorageManager/storage_overview.html"},initEvents:function(){this.callParent(arguments);this.createPollTask()},createPollTask:function(){this.pollTask=this.addWebAPITask({webapi:{api:"SYNO.Storage.CGI.Enclosure",method:"load",version:1},interval:6000,scope:this,callback:this.pollTaskHandler})},startPollTask:function(){this.pollTask.start()},stopPollTask:function(){this.pollTask.stop()},pollTaskHandler:function(e,c,d,b){if(this.owner.cleanMask){this.owner.clearStatusBusy();this.owner.cleanMask=false}if(!e){return}var a=c.enclosures;if(!a){return}a=this.findTopology(a);this.renderEnclosure(a)},renderEnclosure:function(b){this.canvas.body.update("");delete this.hdds;this.hdds=[];var c=9;var d;var h=_D("sas_enclosure_max")-1;var e={top:c,left:4};Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sm-storage-overview-bg-upper",style:{top:"5px"}});for(var g=0;g<h;g++){d=63+56*g;Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sm-storage-overview-bg-mid",style:{top:d+"px"}})}d=63+56*h;Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sm-storage-overview-bg-bottom",style:{top:d+"px"}});if(d>520){this.canvas.setHeight(d+70)}for(g=0;g<b.length;g++){var a;if(b[g].isLcm){a=SYNO.SDS.StorageManager.StorageOverview.DrawData.LcmHost}else{a=SYNO.SDS.StorageManager.StorageOverview.DrawData.Enclosure}if(!a){continue}a.left=e.left;a.top=e.top;var j=0===g%2;var f=g===b.length-1;this.checkSystemStatus(b[g]);this.renderHardwareAndStatus(b[g],a,j);this.renderPortAndLink(b[g],a,f);this.renderHdd(b[g],a);this.renderSystemLight(b[g],a);e.top+=a.gap+a.height}this.doLayout()},checkSystemStatus:function(c){var a,b=true;for(a=0;a<c.powers.length;a++){if(0===c.powers[a].status){b=false;break}}if(b){for(a=0;a<c.fans.length;a++){if(0===c.fans[a].status){b=false;break}}}c.isGood=b},renderHardwareAndStatus:function(i,a,l){var m=i.isLcm?"sds-enclosures2-host-lcm":"sds-enclosures2-enclosure";var k=i.isGood?"good":"bad";var c=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:m,style:{left:a.left+"px",top:a.top+"px"}}));var d,j,g,f;a.width=c.getWidth();a.height=c.getHeight();var h=a.top+a.height/2-a.info.height/2;m=String.format("sds-enclosures2-infoleft-{0}",k);d=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:m,style:{top:h+"px"}}));m=String.format("sds-enclosures2-infocenter-{0}",k);j=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:m,style:{top:h+"px"}}));m=String.format("sds-enclosures2-inforight-{0}",k);g=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:m,style:{top:h+"px"}}));m=i.isGood?"sds-enclosures2-info-modelName-good":"sds-enclosures2-info-modelName-bad";var e=i.modelName.replace("Synology-","");var b=i.isInternal?_S("hostname"):String.format("{0} {1}",e,i.id);f=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",html:b,cls:m,style:{top:h+"px"},"ext:qtip":b}))},renderPortAndLink:function(h,a,f){var n=a.left+a.width+a.info.left;var j=a.top+a.height/2-a.info.height/2;var m,b,c,d,l,k,g;if(h.isInternal){Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-info-port-out",style:{top:j+a.info.hostOutPortTop+"px"}})}else{Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-info-port-in",style:{top:j+a.info.inPortTop+"px"}});Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-info-port-out",style:{top:j+a.info.outPortTop+"px"}})}for(var e=0;e<h.ports.length;e++){if((e<2&&!h.isInternal)){continue}d=false;if(h.isInternal){if(f){if("0"===h.ports[0].linkId&&"0"===h.ports[1].linkId){continue}m="sds-enclosures2-info-disconnected-long";b=a.info.hostOutLinkTop;c=a.info.hostlinkHeight}else{d=2===h.ports[e].portType&&h.ports[e].linkPortNum===h.ports[e].portNum;m=d?"sds-enclosures2-info-connected-long":"sds-enclosures2-info-disconnected-long";b=a.info.hostOutLinkTop;c=a.info.hostlinkHeight}}else{if(f){if("0"===h.ports[2].linkId&&"0"===h.ports[3].linkId){continue}m="sds-enclosures2-info-disconnected";b=a.info.outLinkTop;c=a.info.linkHeight}else{d=2===h.ports[e].portType&&h.ports[e].linkPortNum+2===h.ports[e].portNum;m=d?"sds-enclosures2-info-connected":"sds-enclosures2-info-disconnected";b=a.info.outLinkTop;c=a.info.linkHeight}}l=a.info.linkWidth*(e%2)+a.info.linkGap*(e%2);Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:m,style:{left:n+a.info.outLinkLeft+l+"px",top:j+b+"px"}});if(!d){k=n+a.info.outLinkLeft+l+a.info.linkWidth/2-a.info.iconWidth/2-1;g=j+b+c/2-a.info.iconHeight/2;Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-info-disconnected-icon",style:{left:k+"px",top:g+"px"}})}}},renderHdd:function(k,a){var l,h=a.hdd.initTop+a.top;var g=0;for(var d=0;d<a.hddLayout.length;d++){l=a.hdd.initLeft+a.left;for(var c=0;c<a.hddLayout[d];c++){var f=Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-hdd",style:{left:l+"px",top:h+"px","font-size":"11px"}});var b=new Ext.Element(f);b.owner=this;b.order=g+1;b.status=(g<k.disks.length&&0!==k.disks[g].id)?1:0;if(this.displayDiskNum&&0!==b.status){var e=b.order<10?"0"+b.order:b.order;f.innerHTML=e;f.style.border="2px solid"}this.hdds.push(b);l+=a.hdd.hGap+a.hdd.width;g++}h+=a.hdd.vGap+a.hdd.height}},renderSystemLight:function(d,b){var c=this,a;a=new Ext.Element(Ext.DomHelper.append(c.canvas.body,{tag:"div",cls:d.isGood?"sds-enclosures2-info-light-good":"sds-enclosures2-info-light-bad",style:{top:b.top+b.height/2-b.lightHeight/2+"px"}}));a.on("click",c.onShowSysInfo,{appWin:c.appWin,owner:c.owner,panel:c,data:d})},onActivate:function(){var a=this;a.canvas.body.update("");a.owner.setStatusBusy();a.owner.cleanMask=true;a.appWin.stopPollTask();a.startPollTask()},onDeactivate:function(){this.appWin.startPollTask();this.stopPollTask()},onDiskNumber:function(){this.displayDiskNum=!this.displayDiskNum;var d=this.displayDiskNum?_T("volume","volume_hide_disk_num"):_T("volume","volume_display_disk_num");this.getTopToolbar().getComponent("DiskNumToggle").setText(d);for(var b=0;b<this.hdds.length;b++){if(0!==this.hdds[b].status){var a=this.hdds[b].order<10?"0"+this.hdds[b].order:this.hdds[b].order;var c=this.hdds[b].dom;c.innerHTML=this.displayDiskNum?a:"";c.style.border=this.displayDiskNum?"2px solid":""}}},onShowSysInfo:function(){var d=[],c,a,b;var e=String.format("{0} {1} / {2} {3}",this.data.temperature,_T("status","celsius"),this.panel.C2F(this.data.temperature).toFixed(0),_T("status","fahrenheit"));d.push({item:_T("status","temperature"),status:e});for(c=0;c<this.data.powers.length;c++){a=1===this.data.powers[c].status?'<font class="green-status">'+_T("volume","volume_status_normal")+"</font>":'<font class="red-status">'+_T("common","status_abnormal")+"</font>";d.push({item:_T("tree","leaf_powermgr")+this.data.powers[c].num,status:a})}for(c=0;c<this.data.fans.length;c++){a=1===this.data.fans[c].status?'<font class="green-status">'+_T("volume","volume_status_normal")+"</font>":'<font class="red-status">'+_T("common","status_abnormal")+"</font>";d.push({item:_T("system","system_fan")+this.data.fans[c].num,status:a})}b=new SYNO.SDS.StorageManager.Wizard.StorageOverviewInfo({appWin:this.appWin,owner:this.owner,panel:this.panel,data:d});this.panel.mon(b,"close",function(){this.panel.startPollTask()},this,{single:true});this.panel.stopPollTask();b.open()},findTopology:function(b){var f,h,c=0,j={};for(f=0;f<b.length;f++){if(b[f].isInternal){h=b[f];break}}var l=h.uniqueId,d=null;for(f=0;f<h.ports.length;f++){h.ports[f].portType="0"===h.ports[f].linkId?3:2;if(!d&&2===h.ports[f].portType){d=h.ports[f].linkId}}if(2<=h.ports.length){if(3!==h.ports[0].portType&&3!==h.ports[1].portType&&h.ports[0].linkId!==h.ports[1].linkId){h.ports[1].portType=4}}j[l]=true;var g=[];g.push(h);do{if(1===b.length){break}var m=false;for(f=0;f<b.length;f++){if(b[f].uniqueId===d&&undefined===j[d]){h=b[f];m=true;break}}if(!m){break}var k=h.ports,e=0;for(f=0;f<k.length;f++){if(k[f].linkId===l&&2>e){k[f].portType=1;e++}else{if(k[f].linkId===l&&2<=e){k[f].portType=4}else{if("0"===k[f].linkId){k[f].portType=3}else{k[f].portType=-1}}}}d="0";e=0;for(f=0;f<k.length;f++){if(-1===k[f].portType){if("0"===d){d=k[f].linkId}if(k[f].linkId===d){k[f].portType=2}else{k[f].portType=4}}}g.push(h);l=h.uniqueId;j[l]=true;c++;var a=true;for(f=0;f<k.length;f++){if(1===k[f].portType&&!k[f].valid){a=false;break}}if(!a){break}}while(c<b.length-1);return g},C2F:function(a){return(a*9/5+32)}});Ext.define("SYNO.SDS.StorageManager.Wizard.StorageOverviewInfo",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("home","home_subject"),width:400,height:320,layout:"fit",dsmStyle:"v5",border:false,items:[{layout:"fit",xtype:"syno_gridpanel",border:false,columns:[{header:_T("smart","smart_attribute"),dataIndex:"item",width:200,sortable:false},{header:_T("relayservice","status"),dataIndex:"status",width:200,useHtmlEncodeRender:false,sortable:false}],store:new Ext.data.JsonStore({autoDestroy:true,fields:["item","status"],data:a.data})}],buttons:[{xtype:"syno_button",text:_T("common","alt_close"),handler:this.close,scope:this}]};c.callParent([Ext.apply(b,a)])}});Ext.namespace("SYNO.SDS.StorageManager.StorageDualHeadOverview");Ext.namespace("SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData");SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData.Info={height:48,left:18,modelNameLeft:36,portWidth:36,portHeight:16,portGap:6,outPortLeft:183,outPortTop:26,hostOutPortTop:16,outLinkLeft:289,outLinkTop:32,hostOutLinkTop:21,inPortLeft:183,inPortTop:5,linkWidth:6,linkHeight:42,hostlinkHeight:52,linkGap:33,iconWidth:16,iconHeight:16};SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData.Hdd={width:52,height:11,initLeft:16,initTop:2,hGap:6,vGap:5};SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData.Host={width:260,height:52,left:0,top:0,gap:4,info:SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData.Info,lightHeight:24,lightLeft:322,firstOffsetLeft:534};SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData.RS10613xsp={width:260,height:52,left:0,top:0,hddCount:10,hddLayout:[3,3,4],hdd:SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData.Hdd,gap:4,info:SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData.Info,lightHeight:24,lightLeft:322};SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData.Enclosure={width:260,height:52,left:0,top:0,hddCount:12,hddLayout:[4,4,4],hdd:SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData.Hdd,gap:4,info:SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData.Info,lightHeight:24,lightLeft:322};Ext.define("SYNO.SDS.StorageManager.StorageDualHeadOverview.Main",{extend:"SYNO.ux.Panel",pollTask:null,hdds:null,displayDiskNum:false,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.appWin;b={itemId:"storage_overview",border:false,autoFlexcroll:true,tbar:{items:[{xtype:"syno_button",itemId:"DiskNumToggle",text:_T("volume","volume_display_disk_num"),handler:c.onDiskNumber,scope:c}]},items:c.canvas=new Ext.Panel({border:false,height:975}),listeners:{activate:c.onActivate,deactivate:c.onDeactivate,scope:c}};c.callParent([Ext.apply(b,a)])},getHelpParam:function(){return"StorageManager/storage_overview.html"},initEvents:function(){this.callParent(arguments);this.createPollTask()},createPollTask:function(){this.pollTask=this.addWebAPITask({webapi:{api:"SYNO.Storage.CGI.DualEnclosure",method:"load",version:1},interval:6000,scope:this,callback:this.pollTaskHandler})},startPollTask:function(){this.pollTask.start()},stopPollTask:function(){this.pollTask.stop()},pollTaskHandler:function(e,c,d,b){if(this.owner.cleanMask){this.owner.clearStatusBusy();this.owner.cleanMask=false}if(!e){return}var a=c.AHAInfo;if(!a){return}this.renderEnclosure(a)},renderSlots:function(a){var b=a.enc_cnt+a.host_cnt-2;var c;Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sm-storage-overview-bg-upper",style:{top:"5px"}});for(var d=0;d<b;d++){c=58+56*d;Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sm-storage-overview-bg-mid",style:{top:c+"px"}})}c=58+56*b;Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sm-storage-overview-bg-bottom",style:{top:c+"px"}})},renderEnclosure:function(c){this.canvas.body.update("");delete this.hdds;this.hdds=[];var d=9;var e={top:d,left:4};var j=[];var b=c.enclosures;var g;var k;var h;var a;var l;var f;this.renderSlots(c);for(g=0;g<c.host_cnt;++g){k=(c.hosts[g].host_type&24)>>3;j[k-1]=c.hosts[g]}for(g=1;g>=0;g--){h="Host";a=SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData[h];l=0===g%2;f=g===c.enc_cnt-1;if(!a||!j[g]||!j[g].host_type||j[g].modelname.empty()){continue}a.left=e.left;a.top=e.top+13;j[g].offsetLeft=(1==g)?true:false;j[g].isInternal=true;j[g].isGood=true;j[g].isSingle=(c.host_cnt==2)?false:true;this.checkSystemStatus(j[g]);this.renderHardwareAndStatus(j[g],a,l);this.renderPortAndLink(j[g],a,f);this.renderHostSystemLight(j[g],a);e.top+=a.gap+a.height+26}for(g=0;g<c.enc_cnt;g++){h="Enclosure";a=SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData[h];if(!a){continue}a.left=e.left;a.top=e.top;l=0===g%2;f=g===c.enc_cnt-1;b[g].isInternal=false;b[g].id=g+1;this.checkSystemStatus(b[g]);this.renderHardwareAndStatus(b[g],a,l);this.renderPortAndLink(b[g],a,f);this.renderHdd(b[g],a);this.renderSystemLight(b[g],a);e.top+=a.gap+a.height}this.setCanvasHeight(c,b,e.top);this.doLayout()},setCanvasHeight:function(c,g,a){var f=0;var b="Enclosure";var e=SYNO.SDS.StorageManager.StorageDualHeadOverview.DrawData[b];for(var d=0;d<g[c.enc_cnt-1].links.length;d++){if(0!==g[c.enc_cnt-1].links[d]){f=e.info.linkHeight;break}}this.canvas.setHeight(a+f)},checkSystemStatus:function(c){var a,b=true;for(a=0;a<c.powers.length;a++){if(0===c.powers[a]){b=false;break}}if(b){for(a=0;a<c.fans.length;a++){if(0===c.fans[a]||-1===c.fans[a]){b=false;break}}}c.isGood=b},renderHardwareAndStatus:function(h,a,k){var l=h.isInternal?"sds-enclosures-dual-host":"sds-enclosures2-enclosure";var j=h.isGood?"good":"bad";var c=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:l,style:{left:a.left+"px",top:a.top+"px"}}));var d,i,f,e;a.width=c.getWidth();a.height=c.getHeight();var g=a.top+a.height/2-a.info.height/2;l=String.format("sds-enclosures2-infoleft-{0}",j);d=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:l,style:{top:g+"px"}}));l=String.format("sds-enclosures2-infocenter-{0}",j);i=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:l,style:{top:g+"px"}}));l=String.format("sds-enclosures2-inforight-{0}",j);f=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:l,style:{top:g+"px"}}));l=h.isGood?"sds-dual-enclosures2-info-modelName-good":"sds-dual-enclosures2-info-modelName-bad";var b=h.isInternal?h.modelname:h.model+" "+h.id;e=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",html:b,cls:l,style:{top:g+"px"},"ext:qtip":b}))},renderPortAndLink:function(m,a,h){var r=a.left+a.width+a.info.left;var n=a.top+a.height/2-a.info.height/2;var q,b,d,f,p,o,k;var e,l;if(m.isInternal){var j=Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-info-port-out1U-2",style:{top:n+a.info.hostOutPortTop+"px"}});if(m.offsetLeft){j.style.left=a.firstOffsetLeft+"px";j.className="sds-enclosures2-info-port-out1U-1"}}else{Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-info-port-in",style:{top:n+a.info.inPortTop+"px"}});Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-info-port-out",style:{top:n+a.info.outPortTop+"px"}})}for(var g=0;g<m.links.length;g++){var c=g;f=false;if(m.isInternal){if(h){if(0===m.links[0]){continue}f=(2===m.links[g]);e=f?"sds-enclosures2-info-connected-long":"sds-enclosures2-info-disconnected-long";l=f?"sds-enclosures2-info-connected-long1U":"sds-enclosures2-info-disconnected-long1U";q=(m.offsetLeft&&!m.isSingle)?l:e;c=(m.offsetLeft)?g+1:g;b=a.info.hostOutLinkTop;d=a.info.hostlinkHeight}else{f=(2===m.links[g]);e=f?"sds-enclosures2-info-connected-long":"sds-enclosures2-info-disconnected-long";l=f?"sds-enclosures2-info-connected-long1U":"sds-enclosures2-info-disconnected-long1U";q=(m.offsetLeft&&!m.isSingle)?l:e;c=(m.offsetLeft)?g+1:g;b=a.info.hostOutLinkTop;d=a.info.hostlinkHeight}}else{if(h){if(0===m.links[g]){continue}f=(2===m.links[g]);q=f?"sds-enclosures2-info-connected-long":"sds-enclosures2-info-disconnected-long";b=a.info.outLinkTop;d=a.info.linkHeight}else{f=(2===m.links[g]);q=f?"sds-enclosures2-info-connected":"sds-enclosures2-info-disconnected";b=a.info.outLinkTop;d=a.info.linkHeight}}p=a.info.linkWidth*(c%2)+a.info.linkGap*(c%2);Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:q,style:{left:r+a.info.outLinkLeft+p+"px",top:n+b+"px"}});if(!f){o=r+a.info.outLinkLeft+p+a.info.linkWidth/2-a.info.iconWidth/2-1;k=n+b+d/2-a.info.iconHeight/2;Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-info-disconnected-icon",style:{left:o+"px",top:k+"px"}})}}},renderHdd:function(m,a){var n,l=a.hdd.initTop+a.top;var k=0;for(var f=0;f<a.hddLayout.length;f++){n=a.hdd.initLeft+a.left;for(var e=0;e<a.hddLayout[f];e++){var o,h,b;var c=1;var d=8;if(m.disks[k]&d||m.disks[k]&c){o="sds-enclosures2-hdd"}h=Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:o,style:{left:n+"px",top:l+"px","font-size":"11px"}});b=new Ext.Element(h);b.owner=this;b.order=k+1;b.status=!!m.disks[k];if(this.displayDiskNum&&b.status){var g=b.order<10?"0"+b.order:b.order;h.innerHTML=g;h.style.border="2px solid"}this.hdds.push(b);n+=a.hdd.hGap+a.hdd.width;k++}l+=a.hdd.vGap+a.hdd.height}},renderSystemLight:function(d,b){var c=this,a;a=new Ext.Element(Ext.DomHelper.append(c.canvas.body,{tag:"div",cls:d.isGood?"sds-enclosures2-info-light-good":"sds-enclosures2-info-light-bad",style:{top:b.top+b.height/2-b.lightHeight/2+"px"}}));a.on("click",c.onShowSysInfo,{appWin:c.appWin,owner:c.owner,panel:c,data:d})},renderHostSystemLight:function(d,b){var c=this,a;a=new Ext.Element(Ext.DomHelper.append(c.canvas.body,{tag:"div",cls:d.isGood?"sds-enclosures2-info-light-good":"sds-enclosures2-info-light-bad",style:{top:b.top+b.height/2-b.lightHeight/2+"px"}}));a.on("click",c.onShowHostSysInfo,{appWin:c.appWin,owner:c.owner,panel:c,data:d})},onActivate:function(){var a=this;a.canvas.body.update("");a.owner.setStatusBusy();a.owner.cleanMask=true;a.appWin.stopPollTask();a.startPollTask()},onDeactivate:function(){this.appWin.startPollTask();this.stopPollTask()},onDiskNumber:function(){this.displayDiskNum=!this.displayDiskNum;var d=this.displayDiskNum?_T("volume","volume_hide_disk_num"):_T("volume","volume_display_disk_num");this.getTopToolbar().getComponent("DiskNumToggle").setText(d);for(var b=0;b<this.hdds.length;b++){if(this.hdds[b].status){var a=this.hdds[b].order<10?"0"+this.hdds[b].order:this.hdds[b].order;var c=this.hdds[b].dom;c.innerHTML=this.displayDiskNum?a:"";c.style.border=this.displayDiskNum?"2px solid":""}}},onShowSysInfo:function(){var g=[],e,c,b,d;var a=2;var f=this.data.fans.length/2;g.push({item:_T("common","enc_serial"),status:this.data.sn});var h=String.format("{0} {1} / {2} {3}",this.data.temperature,_T("status","celsius"),this.panel.C2F(this.data.temperature).toFixed(0),_T("status","fahrenheit"));g.push({item:_T("status","temperature"),status:h});for(e=0;e<this.data.powers.length;e++){b=1===this.data.powers[e]?'<font class="green-status">'+_T("volume","volume_status_normal")+"</font>":'<font class="red-status">'+_T("common","status_abnormal")+"</font>";g.push({item:_T("tree","leaf_powermgr")+(e+1),status:b})}for(e=0;(e+a-1)<this.data.fans.length;e+=a){b='<font class="green-status">'+_T("volume","volume_status_normal")+"</font>";for(c=0;c<a;c++){if(1!=this.data.fans[e+c]){b='<font class="red-status">'+_T("common","status_abnormal")+"</font>";break}}g.push({item:String.format(_T("system","system_module_fan"),(e<f)?1:2,((e%f)/a)+1),status:b})}d=new SYNO.SDS.StorageManager.Wizard.StorageDualHeadOverviewInfo({appWin:this.appWin,owner:this.owner,panel:this.panel,data:g});this.panel.mon(d,"close",function(){this.panel.startPollTask()},this,{single:true});this.panel.stopPollTask();d.open()},onShowHostSysInfo:function(){var c=[],a,b;c.push({item:_T("common","enc_serial"),status:this.data.sn});var d=String.format("{0} {1} / {2} {3}",this.data.temperature,_T("status","celsius"),this.panel.C2F(this.data.temperature).toFixed(0),_T("status","fahrenheit"));c.push({item:_T("status","temperature"),status:d});a=1===this.data.powers[0]?'<font class="green-status">'+_T("volume","volume_status_normal")+"</font>":'<font class="red-status">'+_T("common","status_abnormal")+"</font>";c.push({item:_T("tree","leaf_powermgr"),status:a});a=1===this.data.fans[0]?'<font class="green-status">'+_T("volume","volume_status_normal")+"</font>":'<font class="red-status">'+_T("common","status_abnormal")+"</font>";c.push({item:_T("system","fan_status"),status:a});b=new SYNO.SDS.StorageManager.Wizard.StorageDualHeadOverviewInfo({appWin:this.appWin,owner:this.owner,panel:this.panel,data:c});this.panel.mon(b,"close",function(){this.panel.startPollTask()},this,{single:true});this.panel.stopPollTask();b.open()},C2F:function(a){return(a*9/5+32)}});Ext.define("SYNO.SDS.StorageManager.Wizard.StorageDualHeadOverviewInfo",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("home","home_subject"),width:400,height:126+28*a.data.length,resizable:false,layout:"fit",dsmStyle:"v5",border:false,items:[{layout:"fit",xtype:"syno_gridpanel",border:false,columns:[{header:_T("smart","smart_attribute"),dataIndex:"item",width:200,sortable:false},{header:_T("relayservice","status"),dataIndex:"status",width:200,useHtmlEncodeRender:false,sortable:false}],store:new Ext.data.JsonStore({autoDestroy:true,fields:["item","status"],data:a.data})}],buttons:[{xtype:"syno_button",text:_T("common","alt_close"),handler:this.close,scope:this}]};c.callParent([Ext.apply(b,a)])}});Ext.namespace("SYNO.SDS.StorageManager.Limits");SYNO.SDS.StorageManager.Limits.MAX_SNAPSHOT_ACTIONING_COUNT=8;Ext.Loader.load("webman/modules/Utils/circleGradient.js");Ext.define("SYNO.SDS.StorageManager.Store",{constructor:function(a){var b=this;b.count=0;b.data={};b.dataArray=[];b.callParent([a])},getAll:function(){return this.dataArray},getMatched:function(){var c=this,b,e,a=arguments,d=[];for(b in c.data){if(c.data.hasOwnProperty(b)){e=c.data[b];if(e.check.apply(e,a)){d.push(e)}}}d.sort(function(g,f){g=g.get("id");f=f.get("id");return(g>f)?1:((g<f)?-1:0)});return d},isAnyMatched:function(){var a=arguments;return(undefined!==this.findBy(function(b){return b.check.apply(b,a)}))},findBy:function(a){var c=this,b,d;for(b in c.data){if(c.data.hasOwnProperty(b)){d=c.data[b];if(a(d)){return d}}}return undefined},getById:function(a){return this.data[a]},prepareArray:function(){var b=this,a;for(a in b.data){if(b.data.hasOwnProperty(a)){b.dataArray.push(b.data[a])}}b.dataArray.sort(function(d,c){return(d.get("num_id")>c.get("num_id"))?1:((d.get("num_id")===c.get("num_id"))?0:-1)})}});Ext.define("SYNO.SDS.StorageManager.Instance",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.StorageManager.MainWindow",shouldNotifyMsg:function(a,b){return !this.window||this.window.isDestroyed||!this.window.isVisible()||this.window.shouldNotifyMsg(a,b)}});Ext.define("SYNO.SDS.StorageManager.MainWindow",{extend:"SYNO.SDS.PageListAppWindow",activePage:"SYNO.SDS.StorageManager.Overview.Main",constructorMap:{volumes:SYNO.SDS.StorageManager.Space,storagePools:SYNO.SDS.StorageManager.Space,iscsiLuns:SYNO.SDS.StorageManager.Space,ssdCaches:SYNO.SDS.StorageManager.Space,disks:SYNO.SDS.StorageManager.Disk.Object,hotSpares:SYNO.SDS.StorageManager.Disk.Object,iscsiTargets:SYNO.SDS.StorageManager.iSCSITarget,enclosures:SYNO.SDS.StorageManager.Enclosure},smartStatusCache:{},constructor:function(a){var c=this,b,d;c.supportRaid=("yes"===_D("supportraid","no"));c.supportSas=("yes"===_D("supportsas","no"));c.supportRaidGroup=("yes"===_D("supportraidgroup","no"));c.supportIscsi=("yes"===_D("support_iscsi_target","no"));c.supportHotSpare=("yes"===_D("support_hotspare","no"));c.supportSsdCache=("yes"===_D("support_ssd_cache","no"));c.supportHA=("yes"===_D("support_ha","no"));c.disableSnapUI=("yes"===_D("support_dr_snap","no")&&"yes"!==_D("enable_old_snap_ui","no"));c.isVDSM=("kvmx64"===_D("synobios"));c.cleanMask=false;c.update_err_count=0;c.lunblockcount=0;c.activeModule=undefined;c.loaded=false;c.env=undefined;c.volumes={count:0};c.storagePools={count:0};c.disks={count:0};c.iscsiLuns={count:0};c.iscsiTargets={count:0};c.hotSpares={count:0};c.ssdCaches={count:0};c.enclosures={count:0};d=c.getListItems();b={cls:"syno-app-storage-manager",dsmStyle:"v5",width:984,height:580,minWidth:984,minHeight:502,listItems:d};b=Ext.apply(b,a);c.callParent([b]);Ext.each(d,function(f){var e=Ext.getClassByName(f.fn);c.pageCt.items.add(new e({itemId:f.fn,appWin:c,owner:c}))},c)},getListItems:function(){var a=this,c=[];c=[{text:_T("helptoc","overview"),iconCls:"icon-overview",fn:"SYNO.SDS.StorageManager.Overview.Main"}];if(a.supportRaidGroup){c.push({text:_T("volume","volume_storage_pool"),iconCls:"icon-raid-group",fn:"SYNO.SDS.StorageManager.Pool.Main"});c.push({text:_T("tree","leaf_volume"),iconCls:"icon-volume",fn:"SYNO.SDS.StorageManager.Volume.Main"});if(a.supportIscsi){c.push({text:_T("tree","leaf_iscsilun"),iconCls:"icon-iscsi-lun",fn:"SYNO.SDS.StorageManager.iSCSILun.Main"});c.push({text:_T("tree","leaf_iscsitrg"),iconCls:"icon-iscsi-target",fn:"SYNO.SDS.StorageManager.iSCSITrg.Main"})}c.push({text:_T("tree","leaf_hddmgr"),iconCls:"icon-hdd-management",fn:"SYNO.SDS.StorageManager.Disk.Main"})}else{c.push({text:_T("tree","leaf_volume"),iconCls:"icon-volume",fn:"SYNO.SDS.StorageManager.Volume.Main"});if("yes"===_D("supportraid","no")){c.push({text:_T("volume","volume_pool"),iconCls:"icon-raid-group",fn:"SYNO.SDS.StorageManager.Pool.Main"})}if(!a.isVDSM){c.push({text:_T("tree","leaf_hddmgr"),iconCls:"icon-hdd-management",fn:"SYNO.SDS.StorageManager.Disk.Main"})}if(a.supportIscsi){c.push({text:_T("tree","leaf_iscsilun"),iconCls:"icon-iscsi-lun",fn:"SYNO.SDS.StorageManager.iSCSILun.Main"});c.push({text:_T("tree","leaf_iscsitrg"),iconCls:"icon-iscsi-target",fn:"SYNO.SDS.StorageManager.iSCSITrg.Main"})}}if(a.supportHotSpare){c.push({text:_T("volume","volume_hot_spare"),iconCls:"icon-hot-spare",fn:"SYNO.SDS.StorageManager.HotSpare.Main"})}if(a.supportSas){var b;if("yes"===_D("support_dual_head","no")){b="SYNO.SDS.StorageManager.StorageDualHeadOverview.Main"}else{if(_S("is_dual_chain")){b="SYNO.SDS.StorageManager.StorageDualChainOverview.Main"}else{b="SYNO.SDS.StorageManager.StorageOverview.Main"}}c.push({text:_T("volume","volume_storage_overview"),iconCls:"icon-expansion",fn:b})}if(a.supportSsdCache){c.push({text:_T("volume","ssd_cache"),iconCls:"icon-ssd-cache",fn:"SYNO.SDS.StorageManager.SsdCache.Main"})}return c},launchPageOnOpen:function(b){var a=this;if(a.checkModalOrMask()){return}a.openParams=b;if(!a.loaded){a.selectPage(a.activePage)}else{a.selectPage(b.fn);if("CloneLun"===b.dlg){a.openCloneLunDialog(b)}}a.openParams=null},onOpen:function(b){var c=this,a=false;c.callParent(arguments);c.pollTask=c.createPollTask(c.pollResultHandler.createSequence(function(g,d,f,e){if(b&&!a){if(b.tabname){c.onOpenHDDWCacheForm()}else{if(b.fn&&(b.fn!==c.activePage)){c.selectPage(b.fn);if("CloneLun"===b.dlg){c.openCloneLunDialog(b)}}}a=true}},c));c.mon(SYNO.SDS.StatusNotifier,"redirect",c.stopPollTask,c);c.mon(SYNO.SDS.StatusNotifier,"logout",c.stopPollTask,c);c.mon(SYNO.SDS.StatusNotifier,"halt",c.stopPollTask,c);c.setStatusBusy();c.cleanMask=true;c.pollTask.start()},onRequest:function(a){this.callParent(arguments);if(a&&a.tabname){this.onOpenHDDWCacheForm()}},openCloneLunDialog:function(a){var c=this;c.activePage.setFocus(a.params.lun_id);var b=new SYNO.SDS.StorageManager.Wizard.CloneLun({owner:c,appWin:c,title:_T("iscsilun","clone"),lun:c.iscsiLuns.data[a.params.lun_id],snapshot:a.params.snapshot,action:"cloneSnapShot"});b.open()},onOpenHDDWCacheForm:function(){this.selectPage("SYNO.SDS.StorageManager.Disk.Main")},onClose:function(){var a=this.callParent(arguments);this.pollTask.stop();if(this.getPage("SYNO.SDS.StorageManager.SsdCache.Main")){this.getPage("SYNO.SDS.StorageManager.SsdCache.Main").onDeactivate()}return a},getPage:function(a){return this.pageCt.getComponent(a)},getDesktopHeight:function(){return SYNO.SDS.Desktop.getEl().getHeight()},createPollTask:function(a){return this.addWebAPITask({webapi:{api:"SYNO.Storage.CGI.Storage",method:"load_info",version:1},interval:6000,callback:a||this.pollResultHandler,scope:this})},stopPollTask:function(){var a=this;if(a.pollTask){a.pollTask.stop()}},startPollTask:function(){var a=this;if(a.pollTask){a.pollTask.start()}},pollResultHandler:function(g,f,e,b){var c=this,d,a;if(c.cleanMask){c.clearStatusBusy();c.cleanMask=false}if(!g){this.update_err_count+=1;if(this.update_err_count<3){SYNO.Debug("tolerant connection fail, retry");return}}else{this.update_err_count=0}if(!g){c.getMsgBox().alert(c.title,f.text,c.close,c);c.pollTask.stop();return}if(c.supportRaid&&f.env.status.system_crashed&&!SYNO.SDS.StorageManager.SystemCrashWarned){SYNO.SDS.StorageManager.SystemCrashWarned=true;c.getMsgBox().alert(c.title,_T("error","error_system_abnormal_steps"))}d=c.volumes.count;a=c.storagePools.count;delete c.env;delete c.detailUsage;delete c.spaceUsedByGluster;delete c.AHAInfo;c.env=f.env;c.AHAInfo=f.AHAInfo;c.detailUsage={};c.spaceUsedByGluster={};c.lunblockcount=0;c.processData(f);if(c.volumes.count<d||c.storagePools.count<a){SYNO.SDS.StatusNotifier.fireEvent("thirdpartychanged")}c.loaded=true;c.getActivePage().onActivate()},processData:function(c){var b=this,a;b.env=c.env;b.hotSpareConf=c.hotSpareConf;for(a in c){if(c.hasOwnProperty(a)){if("env"===a||"success"===a||"AHAInfo"===a||"hotSpareConf"===a){continue}if(c[a]){if("volumes"===a){b.processVolume(a,c[a])}else{if("iscsiLuns"===a){b.processIscsiLun(a,c[a])}else{if("ports"===a){b.processPort(c[a]);continue}else{b.processOthers(a,c[a])}}}b[a].count=c[a].length}}}Ext.each(b.storagePools.getAll(),function(d){d.json.used_by_gluster=b.spaceUsedByGluster[d.get("id")]||false},b)},initStore:function(a){var b=this;delete b[a];b[a]=new SYNO.SDS.StorageManager.Store()},processVolume:function(f,h){var e=this,a,g,j,c,d=e.constructorMap.volumes;e.initStore(f);for(var b=0;b<h.length;++b){a=h[b];g=a.pool_path;j=parseInt(a.size.total_device,10);if(!e.detailUsage[g]){e.detailUsage[g]={lun:0,volume:0}}e.detailUsage[g].volume+=j;if(a.used_by_gluster){e.spaceUsedByGluster[g]=true}a.desc=Ext.util.Format.htmlDecode(a.desc);a.desc=Ext.util.Format.htmlEncode(a.desc);c=new d();c.json=a;c.id=a.id;e.volumes.data[a.id]=c}e.volumes.prepareArray();e.volumes.count=h.length},processIscsiLun:function(e,g){var d=this,h,f,j,b,c=d.constructorMap.iscsiLuns;d.initStore(e);d.lunblockcount=0;for(var a=0;a<g.length;++a){h=g[a];f="";j=0;if("block"===h.iscsi_lun.device_type){f=h.pool_path;j=parseInt(h.iscsi_lun.size,10);d.lunblockcount++;if(!d.detailUsage[f]){d.detailUsage[f]={lun:0,volume:0}}d.detailUsage[f].lun+=j}b=new c();b.json=h;b.id=h.id;d.iscsiLuns.data[h.id]=b}d.iscsiLuns.prepareArray();d.iscsiLuns.count=g.length},processPort:function(a){var d=this,c,e,f,b={},h,g=d.constructorMap.disks;for(c=0;c<a.length;c++){e=a[c];f=new g();f.json={};b.order=0;b.str=e.port_type;b.type="internal";f.json.container=b;f.json.size_total="0";f.json.status=e.port_type;f.json.used_by=e.port_type;f.json.portType=e.port_type;f.json.id=e.port_name;f.json.num_id=e.port_num;f.json.order=e.port_num;h=e.port_name;f.id=e.port_name;d.disks.data[h]=f}d.disks.dataArray=[];d.disks.prepareArray();d.disks.count+=a.length},processOthers:function(b,a){var d=this,c,e,f,h,g=d.constructorMap[b];d.initStore(b);for(c=0;c<a.length;++c){e=a[c];if(g){f=new g()}else{f={}}f.json=e;if("iscsiTargets"===b){h=e.tid;f.id=e.tid}else{h=e.id;f.id=e.id}if("disks"===b){if(!e.smart_status&&d.smartStatusCache[h]){f.json.smart_status=d.smartStatusCache[h]}else{d.smartStatusCache[h]=e.smart_status}}if("storagePools"===b){e.desc=Ext.util.Format.htmlDecode(e.desc);e.desc=Ext.util.Format.htmlEncode(e.desc)}d[b].data[h]=f}d[b].prepareArray();d[b].count=a.length},isSupportISCSI:function(){return this.isSupportISCSIFile()||this.isSupportISCSIBlock()},isSupportISCSIFile:function(){if("yes"===_D("support_iscsi_target")){return true}else{if("lio"===_D("support_iscsi_target")){return true}}return false},isSupportISCSIBlock:function(){if("yes"===_D("support_iscsi_target_block")&&!this.isSingleBay()){return true}return false},isSingleBay:function(){var a=parseInt(_D("maxdisks",1),10);return(1===a)},isSupportSHR:function(){return this.env&&this.env.support.sysdef},isUpToVolumeMaxCount:function(){var b=this,a=parseInt(_D("max_volumes",10),10);if(!b.volumes){return false}return(b.volumes.count>=a)},isUpToiSCSILunMaxCount:function(){var b=this,a=parseInt(_D("max_iscsiluns",10),10);if(!b.iscsiLuns){return false}return(b.iscsiLuns.count>=a)},isUpToHASpaceMaxCount:function(){var b=this,a=parseInt(_D("max_ha_spacecount",10),10);if(!b.volumes){return(b.lunblockcount>=a)}return(b.volumes.count+b.lunblockcount>=a)},isUpToiSCSITargetMaxCount:function(){var b=this,a=parseInt(_D("max_iscsitrgs",10),10);if(!b.iscsiTargets){return false}return(b.iscsiTargets.count>=a)},isUpToBatchTaskCount:function(){if(this.env&&this.env.batchtask){if(Ext.isDefined(this.env.batchtask.remain_task)&&(0===this.env.batchtask.remain_task)){return true}}return false},getMaxBatchTaskCount:function(){if(this.env&&this.env.batchtask&&Ext.isDefined(this.env.batchtask.max_task)){return this.env.batchtask.max_task}return undefined},isSupportRaidCross:function(){return this.env&&this.env.support.raid_cross},isSupportEbox:function(){return this.env&&this.env.support.ebox},isSupportSysRaidCustomization:function(){return("yes"===_D("support_dual_head","no"))||(5<=this.getBayNumber())},isEboxPluged:function(){return this.env&&this.env.ebox&&this.env.ebox.length},getBayNumber:function(){return this.env?parseInt(this.env.bay_number,10):1},getMaxVolumeSize:function(a){var b=this;if(!b.env){return 0}if("yes"===_D("unlimited_volume_size")){return 65536*1024*1024*1024*1024}if(b.supportRaidGroup&&a&&b.env.ram_enough_for_fs_high_end){return parseInt(b.env.max_fs_bytes_high_end,10)}else{return parseInt(b.env.max_fs_bytes,10)}},getUniqueKey:function(){return this.env?this.env.unique_key:""},genNewIQN:function(e){var a=_S("hostname");a=a.replace(/_/g,"-");a=a.replace(/\+/g,"p");var d="iqn.2000-01.com.synology:"+a+"."+e;var f="."+this.getUniqueKey();var b=d;var c=1;while(!this.isUniqueIQN(b+f)){b=d+(c++)}return b+f},genNewTargetName:function(){var b="Target-";var a,c=0;while(!this.isUniqueTargetName(a=b+(++c))){}return a},genNewLunName:function(){var b="LUN-";var a,c=0;while(!this.isUniqueLunName(a=b+(++c))){}return a},isUniqueIQN:function(a){return !this.iscsiTargets.isAnyMatched(function(){return(this.get("iqn")===a)})},isUniqueTargetName:function(a){return !this.iscsiTargets.isAnyMatched(function(){return(this.get("name")===a)})},isUniqueLunName:function(a){return !this.iscsiLuns.isAnyMatched(function(){return(this.get("iscsi_lun").name===a)})},shouldNotifyMsg:function(a,b){return true},isAnyStorageActioning:function(a){var b;if(!a){return false}for(b=0;b<a.length;++b){if(a[b].isActioning()){return true}}return false}});Ext.namespace("SYNO.SDS.StorageManager.StorageDualChainOverview");Ext.namespace("SYNO.SDS.StorageManager.StorageDualChainOverview.DrawData");SYNO.SDS.StorageManager.StorageDualChainOverview.DrawData.LinkInfo={height:48,left:18,inPortTop:5,linkWidth:6,linkGap:33,iconWidth:16,iconHeight:16,outPortTop:26,outLinkTop:31,longLinkHeight:98,shortLinkHeight:42,hostOutPortTop:16,hostOutLinkTop:21,hostLongLinkHeight:52,hostShortLinkHeight:108,chain1PortLeft:172,chain2PortLeft:264,chain1LinkLeft:197,chain2LinkLeft:289};SYNO.SDS.StorageManager.StorageDualChainOverview.DrawData.Rack={top:5,upperHeight:58,midHeight:56,bottomHeight:62,bottomWhite:7};SYNO.SDS.StorageManager.StorageDualChainOverview.DrawData.Hdd={width:52,height:11,initLeft:16,initTop:2,hGap:6,vGap:5};SYNO.SDS.StorageManager.StorageDualChainOverview.DrawData.Enclosure={width:260,height:52,left:4,top:0,topOffset:9,hddCount:12,hddLayout:[4,4,4],hdd:SYNO.SDS.StorageManager.StorageDualChainOverview.DrawData.Hdd,gap:4,linkInfo:SYNO.SDS.StorageManager.StorageDualChainOverview.DrawData.LinkInfo,lightHeight:24,lightLeft:322};SYNO.SDS.StorageManager.StorageDualChainOverview.LinkType={UNCHECK:-1,IN:1,OUT:2,NO:3,ILLEGAL:4};Ext.define("SYNO.SDS.StorageManager.StorageDualChainOverview.Main",{extend:"SYNO.ux.Panel",pollTask:null,hdds:null,displayDiskNum:false,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.appWin;b={title:_T("helptoc","Enclosure"),itemId:"storage_overview",border:false,autoFlexcroll:true,tbar:{items:[{xtype:"syno_button",itemId:"DiskNumToggle",text:_T("volume","volume_display_disk_num"),handler:c.onDiskNumber,scope:c}]},items:c.canvas=new Ext.Panel({border:false}),listeners:{activate:c.onActivate,deactivate:c.onDeactivate,scope:c}};c.callParent([Ext.apply(b,a)])},getHelpParam:function(){return"StorageManager/storage_overview.html"},initEvents:function(){this.callParent(arguments);this.createPollTask()},createPollTask:function(){this.pollTask=this.addWebAPITask({webapi:{api:"SYNO.Storage.CGI.Enclosure",method:"load",version:1},interval:6000,scope:this,callback:this.pollTaskHandler})},startPollTask:function(){this.pollTask.start()},stopPollTask:function(){this.pollTask.stop()},pollTaskHandler:function(j,e,c,a){if(this.owner.cleanMask){this.owner.clearStatusBusy();this.owner.cleanMask=false}if(!j){return}var b=e.enclosures;if(!b){return}this.renderRack();var h=this.findTopology(b,1);var g=this.findTopology(b,2);var i=h.length<g.length?h.length:g.length;var d=h.length>1;var f=g.length>1;this.renderHost(b,d,f);this.renderExternal(h,i);this.renderExternal(g,i);this.doLayout()},renderRack:function(){this.canvas.body.update("");var d=SYNO.SDS.StorageManager.StorageDualChainOverview.DrawData.Rack;delete this.hdds;this.hdds=[];var b=d.top;var a=_D("sas_enclosure_max")-1;Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sm-storage-overview-bg-upper",style:{top:b+"px"}});b+=d.upperHeight;for(var c=0;c<a;c++){Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sm-storage-overview-bg-mid",style:{top:b+"px"}});b+=d.midHeight}Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sm-storage-overview-bg-bottom",style:{top:b+"px"}});b+=d.bottomHeight;this.canvas.setHeight(b+d.bottomWhite)},renderHost:function(c,b,a){var e=SYNO.SDS.StorageManager.StorageDualChainOverview.DrawData.Enclosure;e.top=e.topOffset;for(var d=0;d<c.length;d++){if(!c[d].isInternal){continue}if(c[d].chain==1){this.checkSystemStatus(c[d]);this.renderHardwareAndStatus(c[d],e);this.renderPort(c[d],e);this.renderHostLink(c[d],e,b,a);this.renderHdd(c[d],e);this.renderSystemLight(c[d],e)}else{this.renderHostLink(c[d],e,a,b)}}},renderExternal:function(c,g){var e=SYNO.SDS.StorageManager.StorageDualChainOverview.DrawData.Enclosure;var a,b;for(var d=0;d<c.length;d++){if(c[d].isInternal){continue}b=false;if(c[d].chain==1){if(d<g){a=2*d-1;b=true}else{a=g+d-1}}else{if(d<g-1){a=2*d;b=true}else{a=g+d-1}}e.top=e.topOffset+(e.gap+e.height)*a;var f=d===c.length-1;this.checkSystemStatus(c[d]);this.renderHardwareAndStatus(c[d],e);this.renderPort(c[d],e);this.renderLink(c[d],e,f,b);this.renderHdd(c[d],e);this.renderSystemLight(c[d],e)}},checkSystemStatus:function(c){var a,b=true;for(a=0;a<c.powers.length;a++){if(0===c.powers[a].status){b=false;break}}if(b){for(a=0;a<c.fans.length;a++){if(0===c.fans[a].status){b=false;break}}}c.isGood=b},renderHardwareAndStatus:function(h,a){var k="sds-enclosures2-enclosure";var j=h.isGood?"good":"bad";Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:k,style:{left:a.left+"px",top:a.top+"px"}});var c,i,f,e;var g=a.top+a.height/2-a.linkInfo.height/2;k=String.format("sds-enclosures2-infoleft-{0}",j);c=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:k,style:{top:g+"px"}}));k=String.format("sds-enclosures2-infocenter-{0}",j);i=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:k,style:{top:g+"px"}}));k=String.format("sds-enclosures2-inforight-{0}",j);f=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:k,style:{top:g+"px"}}));k=h.isGood?"sds-enclosures2-info-modelName-good":"sds-enclosures2-info-modelName-bad";var d=h.modelName.replace("Synology-","");var b=h.isInternal?_S("hostname"):String.format("{0} {1}",d,h.id);e=new Ext.Element(Ext.DomHelper.append(this.canvas.body,{tag:"div",html:b,cls:k,style:{top:g+"px"},"ext:qtip":b}))},renderPort:function(f,c){var b=c.top+c.height/2-c.linkInfo.height/2;var e=c.left+c.width+c.linkInfo.left;var a=1===f.chain?c.linkInfo.chain1PortLeft:c.linkInfo.chain2PortLeft;var d="sds-enclosures2-info-port-out-short";var g="sds-enclosures2-info-port-in-short";if(f.isInternal){Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:d,style:{top:b+c.linkInfo.hostOutPortTop+"px",left:e+c.linkInfo.chain1PortLeft+"px"}});Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:d,style:{top:b+c.linkInfo.hostOutPortTop+"px",left:e+c.linkInfo.chain2PortLeft+"px"}})}else{Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:g,style:{top:b+c.linkInfo.inPortTop+"px",left:e+a+"px"}});Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:d,style:{top:b+c.linkInfo.outPortTop+"px",left:e+a+"px"}})}},renderHostLink:function(m,b,e,a){var j=b.left+b.width+b.linkInfo.left;var o=b.top+b.height/2-b.linkInfo.height/2;var n=m.chain;var s=1===n?b.linkInfo.chain1LinkLeft:b.linkInfo.chain2LinkLeft;var c,g,f,r,d,k,l,q;var h=SYNO.SDS.StorageManager.StorageDualChainOverview.LinkType;if(2===n&&a){q=true}else{q=false}for(var p=0;p<m.ports.length;p++){r=false;if(!e){if("0"===m.ports[0].linkId&&"0"===m.ports[1].linkId){continue}c=q?"sds-enclosures2-info-disconnected-long1U":"sds-enclosures2-info-disconnected-long"}else{r=h.OUT===m.ports[p].portType&&m.ports[p].linkPortNum===m.ports[p].portNum;if(r){c=q?"sds-enclosures2-info-connected-long1U":"sds-enclosures2-info-connected-long"}else{c=q?"sds-enclosures2-info-disconnected-long1U":"sds-enclosures2-info-disconnected-long"}}g=b.linkInfo.hostOutLinkTop;f=q?b.linkInfo.hostLongLinkHeight:b.linkInfo.hostShortLinkHeight;d=b.linkInfo.linkWidth*(p%2)+b.linkInfo.linkGap*(p%2);Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:c,style:{left:j+s+d+"px",top:o+g+"px"}});if(!r){k=j+s+d+b.linkInfo.linkWidth/2-b.linkInfo.iconWidth/2-1;l=o+g+f/2-b.linkInfo.iconHeight/2;Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-info-disconnected-icon",style:{left:k+"px",top:l+"px"}})}}},renderLink:function(k,a,h,e){var q=a.left+a.width+a.linkInfo.left;var m=a.top+a.height/2-a.linkInfo.height/2;var b=1===k.chain?a.linkInfo.chain1LinkLeft:a.linkInfo.chain2LinkLeft;var l=SYNO.SDS.StorageManager.StorageDualChainOverview.LinkType;var p,c,d,f,o,n,j;for(var g=0;g<k.ports.length;g++){if((g<2&&!k.isInternal)){continue}f=false;if(h){if("0"===k.ports[2].linkId&&"0"===k.ports[3].linkId){continue}}else{f=l.OUT===k.ports[g].portType&&k.ports[g].linkPortNum+2===k.ports[g].portNum}if(e){p=f?"sds-enclosures2-info-connected-sas":"sds-enclosures2-info-disconnected-sas"}else{p=f?"sds-enclosures2-info-connected":"sds-enclosures2-info-disconnected"}c=a.linkInfo.outLinkTop;d=e?a.linkInfo.longLinkHeight:a.linkInfo.shortLinkHeight;o=a.linkInfo.linkWidth*(g%2)+a.linkInfo.linkGap*(g%2);Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:p,style:{left:q+b+o+"px",top:m+c+"px"}});if(!f){n=q+b+o+a.linkInfo.linkWidth/2-a.linkInfo.iconWidth/2-1;j=m+c+d/2-a.linkInfo.iconHeight/2;Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-info-disconnected-icon",style:{left:n+"px",top:j+"px"}})}}},renderHdd:function(k,a){var l,h=a.hdd.initTop+a.top;var g=0;for(var d=0;d<a.hddLayout.length;d++){l=a.hdd.initLeft+a.left;for(var c=0;c<a.hddLayout[d];c++){var f=Ext.DomHelper.append(this.canvas.body,{tag:"div",cls:"sds-enclosures2-hdd",style:{left:l+"px",top:h+"px","font-size":"11px"}});var b=new Ext.Element(f);b.owner=this;b.order=g+1;b.status=0!==k.disks[g].id?1:0;if(this.displayDiskNum&&0!==b.status){var e=b.order<10?"0"+b.order:b.order;f.innerHTML=e;f.style.border="2px solid"}this.hdds.push(b);l+=a.hdd.hGap+a.hdd.width;g++}h+=a.hdd.vGap+a.hdd.height}},renderSystemLight:function(d,b){var c=this,a;a=new Ext.Element(Ext.DomHelper.append(c.canvas.body,{tag:"div",cls:d.isGood?"sds-enclosures2-info-light-good":"sds-enclosures2-info-light-bad",style:{top:b.top+b.height/2-b.lightHeight/2+"px"}}));a.on("click",c.onShowSysInfo,{appWin:c.appWin,owner:c.owner,panel:c,data:d})},onActivate:function(){var a=this;a.canvas.body.update("");a.owner.setStatusBusy();a.owner.cleanMask=true;a.appWin.stopPollTask();a.startPollTask()},onDeactivate:function(){this.appWin.startPollTask();this.stopPollTask()},onDiskNumber:function(){this.displayDiskNum=!this.displayDiskNum;var d=this.displayDiskNum?_T("volume","volume_hide_disk_num"):_T("volume","volume_display_disk_num");this.getTopToolbar().getComponent("DiskNumToggle").setText(d);for(var b=0;b<this.hdds.length;b++){if(0!==this.hdds[b].status){var a=this.hdds[b].order<10?"0"+this.hdds[b].order:this.hdds[b].order;var c=this.hdds[b].dom;c.innerHTML=this.displayDiskNum?a:"";c.style.border=this.displayDiskNum?"2px solid":""}}},onShowSysInfo:function(){var d=[],c,a,b;var e=String.format("{0} {1} / {2} {3}",this.data.temperature,_T("status","celsius"),this.panel.C2F(this.data.temperature).toFixed(0),_T("status","fahrenheit"));d.push({item:_T("status","temperature"),status:e});for(c=0;c<this.data.powers.length;c++){a=1===this.data.powers[c].status?'<font class="green-status">'+_T("volume","volume_status_normal")+"</font>":'<font class="red-status">'+_T("common","status_abnormal")+"</font>";d.push({item:_T("tree","leaf_powermgr")+this.data.powers[c].num,status:a})}for(c=0;c<this.data.fans.length;c++){a=1===this.data.fans[c].status?'<font class="green-status">'+_T("volume","volume_status_normal")+"</font>":'<font class="red-status">'+_T("common","status_abnormal")+"</font>";d.push({item:_T("system","system_fan")+this.data.fans[c].num,status:a})}b=new SYNO.SDS.StorageManager.Wizard.StorageOverviewInfo({appWin:this.appWin,owner:this.owner,panel:this.panel,data:d});this.panel.mon(b,"close",function(){this.panel.startPollTask()},this,{single:true});this.panel.stopPollTask();b.open()},findTopology:function(c,b){var g,j,d=0,k={};var m=SYNO.SDS.StorageManager.StorageDualChainOverview.LinkType;for(g=0;g<c.length;g++){if(c[g].isInternal&&c[g].chain==b){j=c[g];break}}var n=j.uniqueId,e=null;for(g=0;g<j.ports.length;g++){j.ports[g].portType="0"===j.ports[g].linkId?m.NO:m.OUT;if(!e&&m.OUT===j.ports[g].portType){e=j.ports[g].linkId}}if(m.NO!==j.ports[0].portType&&m.NO!==j.ports[1].portType&&j.ports[0].linkId!==j.ports[1].linkId){j.ports[1].portType=m.ILLEGAL}k[n]=true;var h=[];h.push(j);do{if(1===c.length){break}var o=false;for(g=0;g<c.length;g++){if(c[g].uniqueId===e&&undefined===k[e]){j=c[g];o=true;break}}if(!o){break}var l=j.ports,f=0;for(g=0;g<l.length;g++){if(l[g].linkId===n&&2>f){l[g].portType=m.IN;f++}else{if(l[g].linkId===n&&2<=f){l[g].portType=m.ILLEGAL}else{if("0"===l[g].linkId){l[g].portType=m.NO}else{l[g].portType=m.UNCHECK}}}}e="0";f=0;for(g=0;g<l.length;g++){if(m.UNCHECK===l[g].portType){if("0"===e){e=l[g].linkId}if(l[g].linkId===e){l[g].portType=m.OUT}else{l[g].portType=m.ILLEGAL}}}h.push(j);n=j.uniqueId;k[n]=true;d++;var a=true;for(g=0;g<l.length;g++){if(m.IN===l[g].portType&&!l[g].valid){a=false;break}}if(!a){break}}while(d<c.length-1);return h},C2F:function(a){return(a*9/5+32)}});Ext.define("SYNO.SDS.StorageManager.Wizard.StorageOverviewInfo",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("home","home_subject"),width:400,height:320,layout:"fit",dsmStyle:"v5",border:false,items:[{layout:"fit",xtype:"syno_gridpanel",border:false,columns:[{header:_T("smart","smart_attribute"),dataIndex:"item",width:200,sortable:false},{header:_T("relayservice","status"),dataIndex:"status",width:200,useHtmlEncodeRender:false,sortable:false}],store:new Ext.data.JsonStore({autoDestroy:true,fields:["item","status"],data:a.data})}],buttons:[{xtype:"syno_button",text:_T("common","alt_close"),handler:this.close,scope:this}]};c.callParent([Ext.apply(b,a)])}});