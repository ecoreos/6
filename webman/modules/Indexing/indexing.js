/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.FileIndexing.Instance",{extend:"SYNO.SDS.AppInstance",trayItem:[],initInstance:function(a){this.trayItem[0]=new SYNO.SDS.FileIndexing.Tray({AppInstance:this});this.addInstance(this.trayItem);this.trayItem[0].open(a)}});Ext.define("SYNO.SDS.FileIndexing.Tray",{extend:"SYNO.SDS.Tray.ArrowTray",initPanel:function(){var b=this;var a=new SYNO.SDS.FileIndexing.Panel({module:b});return a},onMouseDown:function(b){var a=this.panel.combobox.list;if(typeof(a)!="undefined"&&b.within(a.dom)){return}return this.callParent(arguments)}});Ext.define("SYNO.SDS.FileIndexing.Panel",{extend:"SYNO.SDS.Tray.Panel",constructor:function(a){this.module=a.module;this.pauseIconCls="sds-tray-item-pause-file-indexing";this.startIconCls="sds-tray-item-start-file-indexing";this.comboboxId=Ext.id();this.actionBtnId=Ext.id();this.statusInfoId=Ext.id();this.statusIconId=Ext.id();this.navigateLinkId=Ext.id();var b=Ext.apply({module:a.module,cls:"syno-file-indexing-tray",title:_T("fileindex","indexing_progress"),width:360,autoHeight:true,renderTo:document.body,defaults:{width:340},tpl:this.createTpl(),data:{navigateLink:_T("fileindex","view_index_list"),navigateLinkId:this.navigateLinkId,note:_T("fileindex","resource_note"),noteLabel:_T("common","note")+_T("common","colon")+" ",comboboxId:this.comboboxId,actionBtnId:this.actionBtnId,statusInfoId:this.statusInfoId,statusIconId:this.statusIconId},listeners:{afterrender:function(){this.createComboBox();this.actionBtn=new SYNO.ux.Button({renderTo:this.actionBtnId,enableToggle:true,toggleHandler:function(c,d){c.disable();if(d){this.sendPauseReq()}else{this.sendResumeReq()}},scope:this});this.navigateLink=Ext.get(this.navigateLinkId);this.navigateLink.on("click",function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.MediaIndex.Main",tab:"fileIndex"});this.hide()},this)},scope:this}},a);this.callParent([b]);this.startPollingTask()},createComboBox:function(){var a=new Ext.data.ArrayStore({fields:["value","display"],data:[[1,String.format(_T("thumb_conv_progress","delay_hours"),1)],[3,String.format(_T("thumb_conv_progress","delay_hours"),3)],[6,String.format(_T("thumb_conv_progress","delay_hours"),6)],[0,String.format(_T("thumb_conv_progress","delay_forever"))]]});this.combobox=new SYNO.ux.ComboBox({renderTo:this.comboboxId,store:a,displayField:"display",valueField:"value",value:1,width:290})},createTpl:function(){var a=['<div class="status-wrap">','<div id="{statusIconId}" class="status-icon"></div>','<div class="status-info-wrap">','<div id="{statusInfoId}" class="status-info">Indexing</div>','<div id="{navigateLinkId}" class="navigate-link link-font">{navigateLink}</div>',"</div>","</div>",'<div class="action-wrap">','<div id={comboboxId} class="delay-combobox"></div>','<div id={actionBtnId} class="action-btn"></div>','<div class="clear"></div>',"</div>",'<div class="note-wrap normal-font">','<div ><span class="note-font">{noteLabel}</span>{note}</div>',"</div>"];return a},textAnimate:function(c,b,a){switch(a){case 1:c.innerHTML=b+".&nbsp;&nbsp;";break;case 2:c.innerHTML=b+"..&nbsp;";break;case 3:c.innerHTML=b+"...";break;default:c.innerHTML=b+"&nbsp;&nbsp;&nbsp;";break}this.delay(500,null,null,[c,b,(a+1)%4])},toIndexing:function(){if(true===this.isIndexing){return}var b=_T("fileindex","indexingwithoutdot");var a=Ext.get(this.statusInfoId).dom;if(!this.statusDelayedTask){this.statusDelayedTask=new Ext.util.DelayedTask(this.textAnimate)}this.statusDelayedTask.delay(0,null,this.statusDelayedTask,[a,b,0]);Ext.fly(this.statusIconId).removeClass("pause");this.combobox.enable();this.module.setIconClass(this.startIconCls);this.isIndexing=true},toPause:function(){if(false===this.isIndexing){return}var b=_T("fileindex","paused");var a=Ext.get(this.statusInfoId).dom;if(this.statusDelayedTask){this.statusDelayedTask.cancel()}a.innerHTML=b;Ext.fly(this.statusIconId).addClass("pause");this.combobox.disable();this.module.setIconClass(this.pauseIconCls);this.isIndexing=false},startPollingTask:function(){this.pollingTask=this.addWebAPITask({api:"SYNO.Core.FileIndexing",method:"get_status",version:1,scope:this,callback:function(d,b,c,a){if(d){this.onStatusChange(b.status)}},interval:5000});this.pollingTask.start(true)},onStatusChange:function(a){if("processing"===a){this.module.setTaskButtonVisible(true);this.actionBtn.toggle(false,true);this.toIndexing()}else{if("finished"===a){this.onClose()}else{if("paused"===a){this.module.setTaskButtonVisible(true);this.actionBtn.toggle(true,true);this.toPause()}}}},onClose:function(){this.module.setTaskButtonVisible(false);this.module.onClose()},sendPauseReq:function(){this.sendWebAPI({api:"SYNO.Core.FileIndexing",method:"pause",version:1,params:{length:this.combobox.getValue()},scope:this,callback:function(d,b,c,a){this.actionBtn.enable();if(d){this.toPause()}}})},sendResumeReq:function(){this.sendWebAPI({api:"SYNO.Core.FileIndexing",method:"resume",version:1,scope:this,callback:function(d,b,c,a){this.actionBtn.enable();if(d){this.toIndexing()}}})}});