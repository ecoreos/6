/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.SupportForm");SYNO.SDS.SupportForm.Module=Ext.extend(Object,{constructor:function(){},activate:function(){},deactivate:function(){return true},getPanel:function(){return null},getAbsoluteURL:function(a){return String.format("{0}/{1}",this.jsConfig.jsBaseURL,a)},getHelpParam:Ext.emptyFn});Ext.ns("SYNO.SDS.SupportForm");SYNO.SDS.SupportForm.FormModule=Ext.extend(SYNO.SDS.SupportForm.Module,{constructor:function(a){SYNO.SDS.SupportForm.FormModule.superclass.constructor.call(this);this.createPanel(a)},getPanel:function(){return this.panel},createPanel:function(a){var b={cp:a.cp,module:this,border:false,frame:false,autoScroll:false,autoFlexcroll:false,header:false,useDefaultBtn:false,webapi:{api:"SYNO.Core.SupportForm.Form",methods:{get:"get",set:"set"},version:1},layout:"fit",items:[{xtype:"syno_panel",region:"center",itemId:"form_iframe",padding:"0 0 0 0",id:"form_iframe",name:"form_iframe",hidden:true,autoFlexcroll:false,html:String.format('<iframe id="iframe_form" src="about:blank" frameborder="0" marginheight="0" marginwidth="0" width="100%" height="100%"></iframe>')}]};this.panel=new SYNO.SDS.SupportForm.FormPanel(b)},activate:function(){this.cp.setStatusBusy();this.panel.loadForm()},deactivate:function(){this.panel.el.unmask();Ext.getDom("iframe_form").src="about:blank"}});SYNO.SDS.SupportForm.FormPanel=Ext.extend(SYNO.SDS.Utils.FormPanel,{constructor:function(a){SYNO.SDS.SupportForm.FormPanel.superclass.constructor.call(this,a)},processReturnData:function(d,c,b){for(var a=0;a<c.result.length;a++){if(c.result[a].api=="SYNO.Core.SupportForm.Form"&&c.result[a].method=="get"){this.getFormCB(c.result[a].data)}}},getFormCB:function(f){var g=String.format("{0}//{1}/webapi/entry.cgi?api=SYNO.Core.SupportForm.Form&method=upload&version=1",window.location.protocol,window.location.host);var d=f.server_baseurl;var b;var e="";var c="";var a=this.cp.getOpenConfig("extra");if(a){e=a.pkg_id;c=a.pkg_version}if(Ext.getDom("iframe_form").src==="about:blank"){var h=setTimeout((function(){this.el.mask(_T("support_center","error_connect"),"syno-ux-mask-info");this.cp.clearStatusBusy();Ext.getCmp("form_iframe").setVisible(false);Ext.getDom("iframe_form").src="about:blank"}).createDelegate(this),60000);Ext.EventManager.on(Ext.getDom("iframe_form"),"load",function(){if(h){clearTimeout(h);h=null;Ext.getCmp("form_iframe").setVisible(true);this.cp.clearStatusBusy()}else{if(Ext.getDom("iframe_form").src==="about:blank"){Ext.EventManager.removeAll(Ext.getDom("iframe_form"))}else{var i;Ext.EventManager.removeAll(Ext.getDom("iframe_form"));i=this.getFrameResponse();Ext.getCmp("form_iframe").setVisible(false);Ext.getDom("iframe_form").src="about:blank";if(i.success){if(i.data.msg!==""){this.cp.getMsgBox().alert(_T("support_center","title"),i.data.msg)}else{if(i.data.attach){this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","send_attach"))}else{this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","success_send_form"))}}}else{if(i.error.code==4703){this.cp.getMsgBox().alert(_T("support_center","title"),i.error.errors.result.msg)}else{if(i.error.code==4701){this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","error_connect"))}else{this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","error_system"))}}}this.loadForm()}}},this);b={dsm_user:this._S("user"),sn:f.sn,model:f.model,dsm_version:f.version,pseudo_sn:f.pseudo_sn,pseudo_model:f.pseudo_model,pseudo_dsm_version:f.pseudo_dsm_version,timestamp:f.timestamp,theme:_S("theme_cls"),lang:_S("lang"),supportform_version:2,buildphase:f.buildphase,isdemo:this._S("demo_mode")?true:false,pkg_id:e,pkg_version:c,user_agnet:navigator.userAgent,url:Ext.urlAppend(g)};this.sendWebAPI({api:"SYNO.Core.MyDSCenter.Account",method:"get",version:1,scope:this,callback:function(i,j){if(true===i&&Ext.isDefined(j.email)){b.my_ds_username=j.email}Ext.getDom("iframe_form").setAttribute("src",String.format(d+"/support/dsm_supportform/index.php?{0}",Ext.urlEncode(b)))}})}else{this.cp.clearStatusBusy()}},getFrameResponse:function(){var g={};try{var f=Ext.getDom("iframe_form");var c=f.contentWindow.document||f.contentDocument||window.frames.iframe_form.document;var a,d;if(!c||!c.body){throw {message:"Failed to get iframe body"}}if((a=c.body.firstChild)&&/pre/i.test(a.tagName)){d=a.textContent}else{if((a=c.getElementsByTagName("textarea")[0])){d=a.value}else{d=c.body.textContent||c.body.innerText}}g=Ext.decode(d)}catch(b){g={success:false,error:(b.message||b.description).trim()}}return g}});Ext.ns("SYNO.SDS.SupportForm");SYNO.SDS.SupportForm.RemoteModule=Ext.extend(SYNO.SDS.SupportForm.Module,{constructor:function(a){SYNO.SDS.SupportForm.RemoteModule.superclass.constructor.call(this);this.createPanel(a)},getPanel:function(){return this.panel},createPanel:function(a){var b={cp:a.cp,module:this,border:false,frame:false,autoScroll:true,header:false,useDefaultBtn:true,webapi:{api:"SYNO.Core.SupportForm.Service",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_fieldset",title:_T("support_center","fieldset_remote"),itemId:"remote_fieldset",name:"remote_fieldset",id:"remote_fieldset",items:[{xtype:"syno_displayfield",hideLabel:true,value:_T("support_center","remote_desc")},{xtype:"syno_checkbox",boxLabel:_T("support_center","support_channel_chkbox"),itemId:"enable_support_channel",name:"enable_support_channel"},{xtype:"syno_displayfield",fieldLabel:_T("support_center","expired_date"),htmlEncode:false,name:"expiredate",labelWidth:280,indent:1,value:"--"},{xtype:"syno_displayfield",fieldLabel:_T("support_center","sns_identifier_key"),name:"sns_identifier_key",labelWidth:280,selectable:true,indent:1,value:"--"}]},{xtype:"syno_fieldset",title:_T("support_center","support_log_tool_title"),itemId:"log_tools",name:"log_tools",id:"log_tools",items:[{xtype:"syno_checkbox",boxLabel:_T("support_center","support_log_level_up"),itemId:"log_level_up",name:"log_level_up"},{xtype:"syno_checkbox",boxLabel:_T("support_center","support_fan_debug_mode"),itemId:"fan_debug_en",name:"fan_debug_en"},{xtype:"syno_checkbox",boxLabel:_T("support_center","support_system_stat_dump"),itemId:"sysstat_dump_en",name:"sysstat_dump_en"}]},{xtype:"syno_fieldset",title:_T("support_center","fieldset_log"),itemId:"log_fieldset",name:"log_fieldset",id:"log_fieldset",items:[{xtype:"syno_displayfield",hideLabel:true,value:_T("support_center","log_desc")},{xtype:"syno_button",btnStyle:"default",id:"log_btn",text:_T("support_center","log_generate_btn"),autoWidth:true,scope:this,disabled:a.cp._S("demo_mode"),tooltip:a.cp._S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",handler:this.doDownload}]}]};this.panel=new SYNO.SDS.SupportForm.ServicePanel(b)},activate:function(){this.panel.loadForm()},deactivate:function(){return !this.panel.isFormDirty()},onDownloadFail:function(){this.wait.hide();this.cp.getMsgBox().alert(_T("download","download_failed"),_T("download","download_msg_action_failed"))},doDownload:function(e,b,c,a){var d=[];this.wait=this.cp.getMsgBox().wait(_T("relayservice","file_downloading"));if(this.panel.getFilterComponent()){this.panel.getFilterComponent().items.each(function(f){if(true===f.getValue()){d.push(f.itemId)}},this)}this.cp.sendWebAPI({scope:this,webapi:{api:"SYNO.Core.SupportForm.Log",version:1,method:"collect",params:{app_list:d}},callback:function(g,f){if(!g){this.onDownloadFail();return}this.taskId=f.task_id;this.startPolling()}})},startPolling:function(){this.pollingId=this.cp.pollReg({webapi:{api:"SYNO.Core.SupportForm.Log",method:"status",version:1,params:{task_id:this.taskId}},interval:5,status_callback:this.onPollingDone,scope:this})},stopPolling:function(){if(Ext.isDefined(this.pollingId)){this.cp.pollUnreg(this.pollingId);delete this.pollingId}},onPollingDone:function(c,b,a){if(!c){this.stopPolling();this.onDownloadFail();return}if(!b.finished){return}this.stopPolling();this.wait.hide();this.onCollectDone(b.path)},onCollectDone:function(a){this.cp.downloadWebAPI({scope:this,webapi:{api:"SYNO.Core.SupportForm.Log",version:1,method:"download",params:{path:a}},callback:function(c,b){if(!c){this.onDownloadFail()}}})}});SYNO.SDS.SupportForm.ServicePanel=Ext.extend(SYNO.SDS.Utils.FormPanel,{constructor:function(a){this.filter_prefix="filter_";SYNO.SDS.SupportForm.ServicePanel.superclass.constructor.call(this,a)},processReturnData:function(d,c,b){for(var a=0;a<c.result.length;a++){if(c.result[a].api=="SYNO.Core.SupportForm.Service"&&c.result[a].method=="get"){if(c.result[a].data.expiredate!=="--"){c.result[a].data.expiredate='<font class="syno-supportform-expire">'+c.result[a].data.expiredate+"</font>"}this.updateFilterComponent(c.result[a].data.app_list)}}SYNO.SDS.SupportForm.ServicePanel.superclass.processReturnData.call(this,d,c,b);this.doLayout()},processParams:function(e,d){var c={},b;if("set"!==e){return SYNO.SDS.SupportForm.ServicePanel.superclass.processParams.call(this,e,d)}if(!Ext.isArray(d)||!Ext.isObject(d[0])||"set"!==d[0].method||Ext.isEmpty(d[0].params)){return d}b=d[0].params;for(var a in b){if(!a.startsWith(this.filter_prefix)){c[a]=b[a]}}d[0].params=c;return d},updateFilterComponent:function(e){var b=this.cp.getOpenConfig("extra");var c=Ext.isObject(b)?b.pkg_id:"";var a=this.getComponent("log_fieldset"),d=[];if(Ext.isEmpty(a)||Ext.isEmpty(e)){return}if(!Ext.isEmpty(this.filterComponent)){a.remove(this.filterComponent);delete this.filterComponent}e.each(function(f){d.push({xtype:"syno_checkbox",itemId:f.id,name:this.filter_prefix+f.id,boxLabel:f.name,checked:f.enable||(f.id===c),listeners:{scope:this,check:this.checkItemEnable}})},this);this.filterComponent=new Ext.form.CheckboxGroup({columns:2,hideLabel:true,items:d,isDirty:function(){return false}});a.insert(1,this.filterComponent);a.doLayout()},getFilterComponent:function(){return this.filterComponent},checkItemEnable:function(){var a=false;this.filterComponent.items.each(function(b){if(b.getValue()){a=true;return false}});Ext.getCmp("log_btn").setDisabled(_S("demo_mode")||!a)}});Ext.ns("SYNO.SDS.SupportForm");SYNO.SDS.SupportForm.Application=Ext.extend(SYNO.SDS.AppInstance,{appWindowName:"SYNO.SDS.SupportForm.MainWindow"});SYNO.SDS.SupportForm.MainWindow=Ext.extend(SYNO.SDS.AppWindow,{constructor:function(a){this.appInstance=a.appInstance;var b=this.fillConfig(a);SYNO.SDS.SupportForm.MainWindow.superclass.constructor.call(this,b)},fillConfig:function(a){var b={layout:"border",cls:"syno-app-support-form",dsmStyle:"v5",minWidth:940,minHeight:580,width:960,height:580,border:false,plain:true,items:[this.moduleList=new SYNO.SDS.SupportForm.ModuleList({region:"west",width:250,appWin:this}),this.moduleCt=new SYNO.ux.Panel({layout:"card",padding:"0 0 0 16px",border:false,frame:false,hideMode:"offsets",cls:"syno-app-support-form-module-ct",region:"center",appWin:this})]};Ext.apply(b,a);return b},getModule:function(d){var c=this.moduleCt;var a=c.getComponent(d);var b;if(a){b=a.module}else{var e;e=Ext.getClassByName(d);e.prototype.jsConfig=this.jsConfig;b=new e({cp:this});b.cp=this;a=b.getPanel();a.module=b;a.itemId=d;c.add(a);b.title=a.title;b.height=a.height}return b},activateModule:function(b,c){if(b&&b.activate){var a=b.getPanel();if(a instanceof Ext.TabPanel&&Ext.isFunction(a.setActiveTab)){a.setActiveTab(0)}b.activate(c)}},startModule:function(b,c){var a;a=this.getModule(b);if(!a){return false}this.moduleCt.layout.setActiveItem(b);this.activateModule(a,c)},deactivateModule:function(b,c){var a=this.getModule(b);if(a&&a.deactivate){return a.deactivate(c)}},onActivate:function(){var b=Ext.getDom("iframe_form");if(b){var a=Ext.get(b.parentNode).query(".sds-shim-for-iframe");Ext.each(a,function(c){Ext.removeNode(c)})}SYNO.SDS.SupportForm.MainWindow.superclass.onActivate.apply(this,arguments)},onDeactivate:function(){var a=document.createElement("div");a.addClassName("sds-shim-for-iframe");Ext.get(Ext.getDom("iframe_form").parentNode).appendChild(a);SYNO.SDS.SupportForm.MainWindow.superclass.onDeactivate.apply(this,arguments)},onClose:function(){if(this.isSkipDeactivateCheck()){this.clearSkipDeactivateCheck();return true}var b,a=true;b=this.moduleList.getSelectionModel().getSelectedNode().attributes.fn;if(b){a=this.deactivateModule(b);if(false===a){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(c){if("yes"===c){this.setSkipDeactivateCheck();this.close()}},this)}}return a},isSkipDeactivateCheck:function(){return !!this.skipDeactivateCheckFlag},setSkipDeactivateCheck:function(){this.skipDeactivateCheckFlag=true},clearSkipDeactivateCheck:function(){this.skipDeactivateCheckFlag=false}});SYNO.SDS.SupportForm.ModuleList=Ext.extend(SYNO.ux.ModuleList,{constructor:function(a){var b=this.fillConfig(a);SYNO.SDS.SupportForm.ModuleList.superclass.constructor.call(this,b);this.getSelectionModel().on("selectionchange",this.onModuleListSelect,this);this.getSelectionModel().on("beforeselect",this.onBeforeSelect,this)},fillConfig:function(a){var b={itemId:"module_list",padding:"4px 16px 0 12px",dataUrl:String.format("{0}/modules/modules.json",a.appWin.jsConfig.jsBaseURL),listeners:{scope:this,single:true,load:function(){(function(){this.selectModule("SYNO.SDS.SupportForm.FormModule")}).defer(200,this)}}};Ext.apply(b,a);return b},onBeforeSelect:function(a,b,e){if(!e){return true}if(this.appWin.isSkipDeactivateCheck()){this.appWin.clearSkipDeactivateCheck();return true}var d,c=true;d=e.attributes.fn;if(d){c=this.appWin.deactivateModule(d);if(false===c){this.appWin.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(f){if("yes"===f){this.appWin.setSkipDeactivateCheck();this.appWin.moduleList.selectModule(b.attributes.fn)}},this)}}return c},onModuleListSelect:function(a,c){var b;if(!c.leaf){return}b=c.attributes.fn;if(b){this.appWin.startModule(b)}else{this.appWin.getMsgBox().alert(this.appWin.title,"not implemented yet")}}});