/* Copyright (c) 2016 Synology Inc. All rights reserved. */

tinymce.PluginManager.add("filestation_attachment",function(b,a){b.addButton("filestation_attachment",{tooltip:"Attach file",icon:"attachment",onclick:function(e,d,g){var f=new SYNO.SDS.Utils.FileChooser.Chooser({owner:b.owner,usage:{type:"open",multiple:true},title:_T("texteditor","Open"),height:500,enumGluster:true,folderToolbar:false,listeners:{scope:this,choose:function(i,h,c){b.plugins.filestation_attachment.addAttach(i,h,c)},close:function(){}}});f.show()}});this.attachArray=[];this.initMode=function(d){var f=d.getDoc();var e=f.createElement("link");var c=f.getElementsByTagName("head")[0];e.type="text/css";e.rel="stylesheet";e.href="/scripts/ext-3/ux/ux-all.css";c.appendChild(e);e=f.createElement("link");e.type="text/css";e.rel="stylesheet";e.href="/webman/modules/TinyMCE/js/tinymce/skins/synostyle/skin.min.css";c.appendChild(e);f.body.style.minHeight="180px"};this.getAttachArray=function(){return this.attachArray};this.clearAttachArray=function(){this.attachArray.length=0};this.addAttach=function(l,k,c){var f=0,g=b.ownerCt;if(!g.fireEvent("beforeAddAttach",g,l,k,c)){return}for(f=0;f<k.records.length;f++){var e=0,h=false,d=k.records[f];for(e=0;e<this.attachArray.size();e++){if(this.attachArray[e].path===d.data.path){h=true;break}}if(!h){this.addAttachRecord(d.data)}}l.close()};this.addAttachRecord=function(h){var i=b.getDoc();var d=i.createElement("div");var f=i.createElement("a");f.className="syno-ux-superboxselect-item-close";f.id=Ext.id();f.style.marginTop="2px";var g=function(m){var n=["btyes","KB","MB"];var l=0;while(1024<=m){m=m/1024;l=l+1}return parseFloat(m.toFixed(1))+" "+n[l]};var c=Ext.util.Format.htmlEncode(h.path.substr(h.path.lastIndexOf("/")+1));d.innerHTML='<div title="'+c+'" style="max-width:350px;overflow:hidden;float:left;text-overflow:ellipsis; white-space:nowrap;">'+c+'</div><a style="color:grey; margin-left:5px"> ('+g(h.filesize)+")</a>";d.tag=h.path;d.appendChild(f);d.className="syno-ux-superboxselect-item mail-attachment-item";i.getElementsByTagName("html")[0].appendChild(d);var k=parseInt(i.body.style.minHeight.substr(0,i.body.style.minHeight.length-2),10);if(k>85){k-=30;i.body.style.minHeight=k+"px"}this.attachArray.push(h);var j=function(o,n){var m=0;var r=o.target.parentElement;var q=b.getDoc();var p=r.tag;q.getElementsByTagName("html")[0].removeChild(r);for(m=0;m<this.attachArray.size();m++){if(p===this.attachArray[m].path){break}}this.attachArray.splice(m,1);var l=parseInt(q.body.style.minHeight.substr(0,q.body.style.minHeight.length-2),10);if(l>=180){return}l+=30;q.body.style.minHeight=l+"px"};var e=Ext.get(f);e.on("click",j,this)}});