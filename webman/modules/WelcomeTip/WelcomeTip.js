/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.App.WelcomeTip.Instance",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.App.WelcomeTip.Main",fullsize:true,shouldLaunch:function(){var a=SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.WelcomeTip.Instance","tip_dsm50_hide")||!(_S("is_admin"))||(_S("demo_mode")===true);return !a}});Ext.define("SYNO.SDS.App.WelcomeTip.Main",{extend:"SYNO.SDS.AppWindow",blDetectSpeed:true,constructor:function(a){this.tipPanel=new SYNO.SDS.App.WelcomeTip.TipPanel({owner:this,appWin:this,itemId:"tip"});var b=this.fillConfig(a);this.callParent([b]);this.center();this.checkEthernet()},fillConfig:function(a){var b={title:_T("welcome","welcome_app_title"),cls:"syno-sds-welcome-tip welcome-tip-bg",border:false,toggleMinimizable:false,maximized:true,resizable:false,header:false,showHelp:false,layout:"fit",renderTo:document.body,items:[this.tipPanel]};Ext.apply(b,a);return b},checkEthernet:function(){this.sendWebAPI({api:"SYNO.Core.Network.Ethernet",method:"list",version:1,params:{},callback:this.onListEthernetInfo,scope:this})},onListEthernetInfo:function(c,b){var a;if(c===true){for(a=0;a<b.length;a++){if(b[a].status==="connected"&&b[a].speed<1000){this.blDetectSpeed=false}}}this.isEthernetInfoReady=function(){return true}},isEthernetInfoReady:function(){return false},onOpen:function(){SYNO.SDS.ShowDesktop();this.appInstance.setUserSettings("tip_dsm50_hide",true);SYNO.SDS.UserSettings.syncSave();this.callParent(arguments)},onClose:function(){if(true!==this.blDetectSpeed&&!SYNO.SDS.Utils.isInVirtualDSM()){SYNO.SDS.SystemTray.notifyMsg("",_T("helptoc","network"),_T("welcome","tip_network_speed"),0)}SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{},false)},onDestroy:function(){var a=Ext.get("sds-desktop").child(".sds-desktop-shortcut").dom;a.removeChild(a.firstChild)}});Ext.define("SYNO.SDS.App.WelcomeTip.TipPanel",{extend:"SYNO.ux.Panel",shortcutTransparentDom:null,updateTaskDone:false,constructor:function(a){var b=this.fillConfig(a);this.callParent([b]);if(SYNO.SDS.Desktop.isItemUpdated===true){this.createMask(a)}else{this.mon(SYNO.SDS.Desktop,"desktopupdated",this.createMask.createDelegate(this,[a]),this)}},fillConfig:function(b){var a,e=0,f=[],d=[{tipCls:"",tipTitle:_T("welcome","tip_title"),tipDesc:_T("welcome","tip_main_menu")},{tipCls:"SYNO.SDS.PkgManApp.Instance",tipTitle:_T("welcome","tip_title"),tipDesc:_T("welcome","tip_pkg_center")},{tipCls:"SYNO.SDS.AdminCenter.Application",tipTitle:_T("welcome","tip_title"),tipDesc:_T("welcome","tip_control_panel")}];for(a=0;a<d.length;++a){if(this.findTipIcon(d[a].tipCls)===true||d[a].tipCls===""){++e;f.push(this.createPanel(d[a],e))}}this.totalPage=e;var c={cls:"welcome-tip-panel",layout:"card",activeItem:"tip_1",items:f,listeners:{afterlayout:{fn:function(){if(!this.bgEl){this.bgEl=document.createElement("div");this.bgEl.addClassName("welcome-tip-bg-inner");this.el.insertFirst(this.bgEl)}},scope:this}}};Ext.apply(c,b);return c},createMask:function(){if(this.updateTaskDone===false){this.updateTaskDone=true;this.shortcutTransparentDom=document.createElement("div");this.shortcutTransparentDom.addClassName("transparent-board");Ext.get("sds-desktop").child(".sds-desktop-shortcut").insertFirst(this.shortcutTransparentDom);Ext.get(this.shortcutTransparentDom).on("click",this.gotoNext,this)}},createPanel:function(d,f){var a=String.format("tip_{0}",f);var c=d.tipDesc||"";var e=String.format(d.tipTitle,f)||"";var b=new SYNO.ux.Panel({itemId:a,tipCls:d.tipCls,cls:"welcome-tip-content-panel",owner:this,items:[{xtype:"box",cls:"welcome-tip-panel-right-content",html:String.format('<div class="welcome-tip-title">{0}</div><div class="welcome-tip-desc">{1}</div>',e,c)},{xtype:"box",cls:("tip_1"===a?"welcome-tip-panel-top-arrow":"welcome-tip-panel-left-arrow"),html:'<div class="welcome-tip-panel-arrow-transform"></div>'}],listeners:{afterrender:{fn:function(){this.getEl().on("click",function(){Ext.getCmp(this.id).owner.gotoNext()})},scope:b},show:{fn:function(){if("tip_1"===this.itemId){this.tipIconEl=Ext.get("sds-taskbar-startbutton").child("button");this.tipIconEl.addClass("sds-hide-badge");return}var h=SYNO.SDS.Desktop.iconItems,g=this.owner.owner.el.getStyle("zIndex"),j;for(j=0;j<h.size();j++){if(h[j].className==this.tipCls){if(h[j].el.hasClass("launch-icon")){this.tipIconEl=h[j].el}else{this.tipIconEl=h[j].el.child(".launch-icon")}this.tipIconEl.setStyle({zIndex:parseInt(g,10)+1});this.tipIconEl.addClass("glow-app");break}}},scope:b},afterlayout:{fn:function(){var h=this.items.items[1].el,j=this.items.items[0].el,i,k;if(!this.tipIconEl||!h||!j){return}var g=this.owner.owner.el.getStyle("zIndex");if("tip_1"===this.itemId){k=this.tipIconEl;h.anchorTo(k,"t-b",[0,0]);j.anchorTo(h,"tl-bl",[-32,0]);i=this.items.items[2].el;i.anchorTo(k,"t-t",[0,0])}else{k=this.tipIconEl.child(".image");h.anchorTo(k,"l-r",[14,0]);j.anchorTo(h,"l-r",[0,0]);i=Ext.get(this.owner.shortcutTransparentDom);i.setStyle({zIndex:parseInt(g,10)+2});i.anchorTo(k,"t-t",[0,0])}},scope:b},hide:{fn:function(){if(this.tipIconEl){this.tipIconEl.setStyle({zIndex:"auto"});this.tipIconEl.removeClass("glow-app")}},scope:b},beforedestroy:{fn:function(){var g=this.items.items[1].el,h=this.items.items[0].el;g.removeAnchor();h.removeAnchor();Ext.get("sds-taskbar-startbutton").child("button").removeClass("sds-hide-badge")},scope:b}}});if("tip_1"===a){b.add({xtype:"box",cls:"transparent-board taskbarbtn"})}return b},findTipIcon:function(c){var b;var a=SYNO.SDS.Desktop.iconItems;for(b=0;b<a.size();++b){if(a[b].className==c){return true}}return false},gotoNext:function(){var b=this,c=this.getLayout().activeItem.itemId,a=c.replace(/(tip_)(\d)/,function(g,f,d){var e=parseInt(d,10)+1;if(e<=b.totalPage){return f+e}return});if(a.match(/tip_\d/)){this.getLayout().setActiveItem(a)}else{this.getLayout().activeItem.hide();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.AdminCenter.Application","activeScreen","basic");this.owner.close()}}});