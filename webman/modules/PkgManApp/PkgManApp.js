/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.PkgManApp.Action");SYNO.SDS.PkgManApp.Action={};Ext.apply(SYNO.SDS.PkgManApp.Action,{_isQuickInstll:function(a){var b=(false!==a.qinst);if(this._isUpgradable(a.id)){b=false!==a.qupgrade}if(a&&a.info&&a.info.blqinst===false){b=false}return b},_isUpgradable:function(c){if(!this._getSynoServerObj().blUpgradeList){return false}var a=false;var b=this._getSynoServerObj().store.getById(c);if(b){a=b.get("blupgrade")}else{if(this._getOtherServerObj().blUpgradeList){b=this._getOtherServerObj().store.getById(c);if(b){a=b.get("blupgrade")}}}return a},_IsInstalling:function(a){if(!a){return false}if(a.status==="installing"||a.status==="upgrading"){return true}if(a.info&&a.info.installing){return true}return false},_GetProcessStatus:function(a,b){var c,d=true;switch(a){case"installing":c=_T("pkgmgr","installing");if(b){c=Math.floor(b*100)+"% "+c}break;case"upgrading":c=_T("pkgmgr","upgrading");if(b){c=Math.floor(b*100)+"% "+c}break;case"uninstalling":c=_T("background_task","task_processing")+"...";break;case"starting":c=_T("pkgmgr","starting");break;case"stopping":c=_T("pkgmgr","stopping");break;default:d=false;break}return{status:a,msg:c,blProcessing:d}},_getUpgradeRec:function(a){return this._isUpgradable(a)?(this._getAvalRec(a)):null},_isRepairable:function(a){return(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(a))&&((this._getSynoServerObj().blUpgradeList&&this._getSynoServerObj().store.getById(a.id))||(this._getOtherServerObj().blUpgradeList&&this._getOtherServerObj().store.getById(a.id)))},_getAvalRec:function(a){return(this._getSynoServerObj().store.getById(a)||this._getOtherServerObj().store.getById(a))},_onRequestInstall:function(b,c){var a=0;if(this._isUpgradable(b.get("id"))){a=1}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Installation.Download",method:"check",version:1,timeout:3600000,params:{taskid:"@SYNOPKG_DOWNLOAD_"+b.get("id")},callback:function(f,e){this.clearStatusBusy();var d=this._getSynoServerObj().store.getById(b.get("id"))||this._getOtherServerObj().store.getById(b.get("id"));if(!f){if(!e||!e.code){this._onResetInstPkgs();d.set("progress",0);this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"));return}else{this._onCheckPKGFail(e,b.get("dname"));d.set("progress",0)}}else{this._prepareVolume(a,e,c,d)}},scope:this})},_onRequestCancelDownload:function(b){this.setStatusBusy();var a=SYNO.SDS.PackageTaskMgr.getTask("@SYNOPKG_DOWNLOAD_"+b.get("id"));if(a){a.cancel()}else{b.set("progress",0);this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"cancel",version:1,params:{taskid:"@SYNOPKG_DOWNLOAD_"+b.get("id")},callback:function(d,c){this._onLoadPkgStore(b.get("id"),false,(function(){this.clearStatusBusy()}).createDelegate(this))},scope:this})}},_onCheckInstall:function(c,d,b){var a=!Ext.isFunction(d);if(a){this.setStatusBusy()}this._onCheckEnv(b,c,function(n,h){if(a){this.clearStatusBusy()}if(!n){if(!h||!h.code){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"),function(){if(Ext.isFunction(d)){d()}},this)}else{this._onCheckEnvFail(h,c,d,{fn:this._onCheckInstall,args:[c,d,b],scope:this})}return}var l=(false!==this._isQuickInstll(c.data)&&false!==c.get("start")&&false!==c.get("qstart"));var m=[];if(!h.volume_count||0===h.volume_count){if(Ext.isDefined(SYNO.API.GetKnownAPI("SYNO.Core.CMS.Info"))&&Ext.isDefined(SYNO.API.GetKnownAPI("SYNO.Core.Storage.Volume"))&&"cluster"===c.get("install_type")){var g=[{api:"SYNO.Core.Package.Setting",method:"get",version:1},{api:"SYNO.Core.Storage.Volume",method:"list",version:1,params:{offset:0,limit:-1,location:"internal"}},{api:"SYNO.Core.CMS.Info",method:"get",version:1,params:{additional:["gluster_role"]}},{api:"SYNO.Core.Storage.Volume",method:"list",version:1,params:{offset:0,limit:-1,location:"internal",option:"include_glusterfs_used"}}];if(a){this.setStatusBusy()}this.sendWebAPI({compound:{stopwhenerror:false,params:g},scope:this,callback:function(D,w,u,p){if(a){this.clearStatusBusy()}if(!D||w.has_fail){this._onResetInstPkgs();var y=SYNO.API.Util.GetFirstErrorIndex(w);if(1===y){var v=SYNO.API.Util.GetFirstError(w);this.getMsgBox().alert("",SYNO.API.Erros.core[v.code]||_T("common","commfail"));return}}var B=SYNO.API.Util.GetValByAPI(w,"SYNO.Core.Storage.Volume","list","volumes"),C,x,q,A,E,s;if(B&&0===B.length){C=B.length;s=SYNO.API.Util.GetValByAPI(w,"SYNO.Core.CMS.Info","get","additional");if(s&&(A=s.gluster_role)&&(A&1)&&(A&2)){q=SYNO.API.Util.GetValByIndex(w,3,"volumes");if(q){C=q.length;for(x=0;x<C;x++){E=q[x];if(E&&!E.readonly&&E.size_free_byte>209715200){m.push({mount_point:E.volume_path,name:String.format("{0} ({1}{2} {3})",_T("pkgmgr","brick"),_T("volume","volume_freesize"),_T("common","colon"),SYNO.SDS.StorageUtils.SizeRender(E.size_free_byte,10)),description:E.description});break}}}}}else{for(x=0;x<C;x++){E=B[x];m.push({mount_point:E.volume_path,name:SYNO.SDS.Utils.StorageUtils.VolumeNameSizeRenderer(E),description:E.description})}}if(0===m.length){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","volume_no_volumes"),function(i){if("ok"===i){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}this._onResetInstPkgs()});return}var r=this._isUpgradable(c.get("id"));if(m.length<=1){var t=(m?m[0].mount_point:"");if(r||!l){this._onRequestQuickInstall(c,t,this._isRepairable(c.data)?true:undefined,d)}else{if(Ext.isFunction(d)){this._onRequestQuickInstall(c,t,true,d)}else{this._onRequestQuickInstall(c,t,true)}}}else{var z=new SYNO.SDS.PkgManApp.WizardDialog({owner:this,mode:r?1:0},{id:c.get("id"),name:c.get("dname"),version:c.get("version"),description:c.get("desc"),maintainer:c.get("maintainer"),distributor:c.get("distributor"),support_url:c.get("support_url"),startable:l,pkgqinst:true,pkgqinstrec:c,install_type:c.get("install_type")});z.mon(z,"beforeclose",function(){this.installing_fore_pkg=null;if(Ext.isFunction(d)){(function(){d()}).defer(100)}if(!z.isFinished){this._onResetInstPkgs()}},this,{single:true});if(!z.isDestroyed){z.open()}}}});return}else{this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","volume_no_volumes"),function(i){if("ok"===i){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}this._onResetInstPkgs()});return}}var e=this._isUpgradable(c.get("id"));if(!h.volume_list||h.volume_list.length<=1||!Ext.isEmpty(h.volume_path)){var f=!Ext.isEmpty(h.volume_path)?h.volume_path:(h.volume_list?h.volume_list[0].mount_point:"");if(e||!l){this._onRequestQuickInstall(c,f,this._isRepairable(c.data)?true:undefined,d)}else{if(Ext.isFunction(d)){this._onRequestQuickInstall(c,f,true,d)}else{this._onRequestQuickInstall(c,f,true)}}}else{for(var j=0;j<h.volume_count;j++){var o=h.volume_list[j];m.push({mount_point:o.mount_point,name:o.display,description:o.desc})}var k=new SYNO.SDS.PkgManApp.WizardDialog({owner:this,mode:e?1:0,volumes:m},{id:c.get("id"),name:c.get("dname"),version:c.get("version"),description:c.get("desc"),maintainer:c.get("maintainer"),distributor:c.get("distributor"),support_url:c.get("support_url"),startable:l,pkgqinst:true,pkgqinstrec:c,install_type:c.get("install_type")});k.mon(k,"beforeclose",function(){this.installing_fore_pkg=null;if(Ext.isFunction(d)){(function(){d()}).defer(100)}if(!k.isFinished){this._onResetInstPkgs()}},this,{single:true});if(!k.isDestroyed){k.open()}}})},_onRequestQuickInstall:function(e,c,b,f){var a=!Ext.isFunction(f);if(a){this.setStatusBusy()}var d={name:e.get("id"),url:e.get("link"),checksum:e.get("md5"),filesize:e.get("size"),blqinst:this._isQuickInstll(e.data),type:e.get("type"),volume_path:c,installrunpackage:b};this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"install",version:1,params:d,callback:function(j,i){if(a){this.clearStatusBusy()}if(!j||!i){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"));return}if(i&&0>i.progress){this._onResetInstPkgs();var g={msg:_T("error","error_error_system"),callback:Ext.emptyFn};if(i.code){g=this._onCheckPKGFailMsg(e.get("dname"),i,_T("error","error_error_system"))}this.getMsgBox().alert(e.get("dname")||_T("tree","leaf_packagemanage"),g.msg,g.callback,this)}else{this.fireEvent("pollinginstpage");this._onLoadPkgStore(e.get("id"),false,(function(){}).createDelegate(this));var h=new SYNO.SDS.PkgManApp.DownloadAction({owner:this,data:i,id:e.get("id"),foreground:false});if(Ext.isFunction(f)){this.mon(h,"finish",function(){f();return true},this,{single:true})}}},scope:this})},_onCheckEnv:function(b,c,d){var a=true;if(b&&false===b.blCheckDep){a=false}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"check",version:1,params:{depsers:c.get("depsers"),deppkgs:c.get("deppkgs"),conflictpkgs:c.get("conflictpkgs"),version:c.get("version"),size:c.get("size"),id:c.get("id"),blupgrade:this._isUpgradable(c.get("id")),install_type:c.get("install_type"),blCheckDep:a},scope:this,callback:function(f,e){this.clearStatusBusy();if(Ext.isFunction(d)){d.apply(this,arguments)}}})},_onRequestDownload:function(c,b,d,a){b=Ext.isBoolean(b)?b:this._isQuickInstll(c.data);this.setStatusBusy();this._onCheckEnv(a,c,function(f,e){this.clearStatusBusy();if(!f){if(!e||!e.code){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"),function(){if(Ext.isFunction(d)){d()}},this)}else{this._onCheckEnvFail(e,c,d,{fn:this._onRequestDownload,args:[c,b,d,a],scope:this})}return}if(!b&&e.is_occupied){this.getMsgBox().alert(c.get("dname"),_T("pkgmgr","error_occupied"),function(){if(Ext.isFunction(d)){d()}},this);return}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"install",version:1,timeout:3600000,params:{name:c.get("id"),url:c.get("link"),checksum:c.get("md5"),filesize:c.get("size"),type:c.get("type"),blqinst:b,operation:this._isUpgradable(c.get("id"))?"upgrade":"install"},callback:function(j,h){this.clearStatusBusy();if(!j||!h){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"),function(){},this);return}if(h&&0>h.progress){this._onResetInstPkgs();if(h.code&&4502==h.code){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","volume_no_volumes"),function(k){if("ok"===k){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}});return}var i=_T("error","error_error_system");if(h.code){i=SYNO.API.getErrorString(h.code)}this.getMsgBox().alert(_T("tree","leaf_packagemanage"),i,function(){if(Ext.isFunction(d)){d()}},this)}else{this.fireEvent("pollinginstpage");this._onLoadPkgStore(c.get("id"),false);var g=new SYNO.SDS.PkgManApp.DownloadAction({owner:this,data:h,id:c.get("id"),foreground:true});if(Ext.isFunction(d)){this.mon(g,"finish",function(){this._onRequestInstall(c,d);return false},this,{single:true})}}},scope:this})})},_onResetInstPkgs:function(){this.fore_pkg=[];this.back_pkg=[];this.installing_fore_pkg=null;SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView").refresh()},_onClickInstall:function(c){var b={},f=c.get("id"),e=[];b[c.get("id")]={rec:c};if(!this._onParsePkgs(b,e)){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","missing_pkgs")+"<br>"+e.join(", "));return}var d="",a;for(a in b){if(b.hasOwnProperty(a)){if(a===f){continue}if(""!==d){d+=", "}if(b[a].rec){d+=b[a].rec.get("dname")}else{d+=a}}}if(d){this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),String.format(_T("pkgmgr","install_depended_pkgs"),d,c.get("dname")),function(g,h){if(g==="yes"){this._onCheckInstallAll(b,this._getDepSers(b),this._getInstallType(b))}else{this._onResetInstPkgs()}},this)}else{this._onCheckInstallAll(b,this._getDepSers(b),this._getInstallType(b))}},_onClickUpdateAll:function(a){if(!Ext.isEmpty(this._getInstallAll_Background())){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","error_occupied"));return}var b={},c=[];this._getUpgradePkg(a,this._getSynoServerObj().store,b);this._getUpgradePkg(a,this._getOtherServerObj().store,b);if(!this._onParsePkgs(b,c)){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","missing_pkgs")+"<br>"+c.join(", "));return}this._onCheckInstallAll(b,this._getDepSers(b),this._getInstallType(b))},_onParsePkgs:function(c,d){if(!this._getAllDepPkg(c,d)){return false}var a=[];this._genDepGraphNodes(c,a);var b=SYNO.SDS.PkgManApp.Utils.tsort(a);b.splice(b.length-1,1);this._getForeAndBackPkg(c,b);return true},_getForeAndBackPkg:function(d,a){var f=d;var e;this.back_pkg=this.back_pkg||[];this.fore_pkg=this.fore_pkg||[];for(var c=0;c<a.length;c++){e=f[a[c]];if(e){if(-1===this.fore_pkg.indexOf(e.rec.id)){this.fore_pkg.push(e.rec.id)}}}for(var b in f){if(f.hasOwnProperty(b)){e=f[b];if(e){if(-1===this.back_pkg.indexOf(e.rec.id)&&-1===this.fore_pkg.indexOf(e.rec.id)){this.back_pkg.push(e.rec.id)}}}}},_getUpgradePkg:function(a,b,d){var c=b.snapshot||b.data;c.each(function(g){var f=g.get("progress"),e;if(((a&&this._isRepairable(g.data))||(!a&&g.get("blupgrade")))&&(!Ext.isNumber(f)||!(f>0&&f<1))){e=g.get("id");if(!d.hasOwnProperty(e)){d[e]={rec:g}}}},this)},_getAllDepPkg:function(e,g){if(Ext.isEmpty(e)){return false}var f,d,c,b;for(var a in e){if(e.hasOwnProperty(a)){if(e[a].checked){continue}e[a].checked=true;f=e[a].rec;d=f.get("deppkgs")||{};for(c in d){if(d.hasOwnProperty(c)){if(!e.hasOwnProperty(c)){b=this._getSynoServerObj().store.getById(c)||this._getOtherServerObj().store.getById(c);if(!b){if(-1===g.indexOf(c)){g.push(c)}continue}if(!this._IsInstNormal(c)){e[c]={rec:b};this._getAllDepPkg(e,g)}}}}}}if(!Ext.isEmpty(g)){return false}return true},_IsInstNormal:function(a){var b=this._getInstalledStore().getById(a);if(!b){return false}b=this._getSynoServerObj().store.getById(a)||this._getOtherServerObj().store.getById(a);if(!b||b.get("blupgrade")||this._isRepairable(b.data)){return false}return true},_IsAllInstNormal:function(b){var a;for(a in b){if(b.hasOwnProperty(a)){if(!this._IsInstNormal(a)){return false}}}return true},_IsInstingOrInsted:function(c){var b,d,a;if(Ext.isEmpty(c)){return true}for(b in c){if(c.hasOwnProperty(b)){d=this._getSynoServerObj().store.getById(b)||this._getOtherServerObj().store.getById(b);if(!d){continue}a=d.get("progress");if(a>0&&a<=1){return true}d=this._getInstalledStore().getById(b);if(d){return true}}}return false},_IsInsting_Background:function(){return this._IsInstingOrInsted(this._getInstallAll_Background())},_IsInsting_Foreground:function(){return this._IsInstingOrInsted(this._getInstallAll_Foreground())},_genDepGraphNodes:function(e,a){if(Ext.isEmpty(e)){return}var f,d,c;for(var b in e){if(e.hasOwnProperty(b)){f=e[b].rec;if(!this._isFirstBuy(f)&&this._isQuickInstll(f.data)&&this._IsAllInstNormal(f.get("deppkgs"))){continue}a.push([f.get("id"),""]);d=f.get("deppkgs")||{};for(c in d){if(d.hasOwnProperty(c)){a.push([c,f.get("id")])}}}}},_getDepSers:function(d){var f=[],e,c,b;for(var a in d){if(d.hasOwnProperty(a)){e=d[a].rec;if(!Ext.isEmpty(e.get("depsers"))){c=e.get("depsers").split(" ");for(b=0;b<c.length;b++){if(-1==f.indexOf(c[b])){f.push(c[b])}}}}}return f.join(" ")},_getInstallType:function(c){var d,a="";for(var b in c){if(c.hasOwnProperty(b)){d=c[b].rec;if(d.get("install_type")){a=d.get("install_type");break}}}return a},_onCheckInstallAll:function(d,b,f){var e=true,c=0;for(var a in d){if(d.hasOwnProperty(a)){c++;if(c>=2){e=false;break}}}if(e||(Ext.isEmpty(b)&&Ext.isEmpty(f))){this._onInstallAll();return}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"check",version:1,timeout:3600000,params:{depsers:b,install_type:f},callback:function(h,g){this.clearStatusBusy();if(!h){if(!g){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"))}else{this._onResetInstPkgs();this._onCheckPKGFail(g)}return}if(0<this._getInstallAll_Foreground().length&&g.is_occupied){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","error_occupied"));return}this._onInstallAll();SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView").refresh()},scope:this})},_onInstallAll:function(){if(!Ext.isEmpty(this.fore_pkg)&&!Ext.isEmpty(this.fore_pkg[0])){this._onInstallAll_Foreground()}else{this._onInstallAll_Background()}},_onInstallAll_Foreground:function(){if(Ext.isEmpty(this.fore_pkg)||Ext.isEmpty(this.fore_pkg[0])){return}if(this.installing_fore_pkg&&-1!==this.fore_pkg.indexOf(this.installing_fore_pkg)){return}var a=this.fore_pkg[0];this.installing_fore_pkg=a;this._onInstallAll_One(a,false)},_onInstallAll_Background:function(){if(Ext.isEmpty(this.back_pkg)||Ext.isEmpty(this.back_pkg[0])){return}var c;for(c=0;c<this.back_pkg.length;c++){var b=this.back_pkg[c];if(!b){continue}var d=this._getSynoServerObj().store.getById(b)||this._getOtherServerObj().store.getById(b);var a=d.get("progress");if(((a>0&&a<1)||-1===a)){continue}this._onInstallAll_One.defer(80,this,[b,true])}this.back_pkg=[]},_isHasUpgradable:function(a){var b=false;var c=a.snapshot||a.data;c.each(function(e){var d=e.get("progress");if(e.get("blupgrade")&&!(d>0&&d<1)){b=true;return false}});return b},_getInstallAll_Foreground:function(){return this.fore_pkg||[]},_getInstallAll_Background:function(){return this.back_pkg||[]},_onInstallAll_One:function(c,e,d){if(this.isDestroyed){return}d=d||0;var b=this._getSynoServerObj().store.getById(c)||this._getOtherServerObj().store.getById(c);if(!b){this._onInstallAll();return}var a=b.get("progress");var f=b;var g=(function(){if(this.isDestroyed){return}var h;if(-1!==(h=this.fore_pkg.indexOf(c))){this.fore_pkg.splice(h,1);this.installing_fore_pkg=null}this._onLoadOtherPkgStore(false);this._onLoadSynoPkgStore(false);this.fireEvent("pollinginstpage");this._onInstallAll()}).createDelegate(this);if(1!==a&&a>0){if(e){g()}else{if(180>=d){d++;this._onInstallAll_One.defer(1000,this,[c,e,d])}else{this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","error_occupied"));return}}}else{if(f.data.source==="syno"&&this._isFirstBuy(f)){this._onRequestSynoPkg(f,e,a,g)}else{if(e){if(a===1){g()}else{this._onCheckInstall(f,g)}}else{this._onRequestDownload(f,e,g)}}}},_onLoadPkgStore:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView");a.onLoadPkgStore.apply(a,arguments)},_onLoadOtherPkgStore:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView");a.onLoadOtherPkgStore.apply(a,arguments)},_onLoadSynoPkgStore:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView");a.onLoadSynoPkgStore.apply(a,arguments)},_onRefresh:function(a){a=Ext.isBoolean(a)?a:false;this.setNeedForceReload(true);this._onLoadOtherPkgStore(true,false);this._onLoadSynoPkgStore(true,false);this.fireEvent("pollinginstpage");this.loadCfg()},_getSynoServerObj:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView");return a.synoObj},_getOtherServerObj:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView");return a.otherObj},_getInstalledStore:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView");return a.getStore()},_prepareVolume:function(d,a,e,c){var b=new SYNO.SDS.PkgManApp.WizardDialog({owner:this,mode:d,type:c?c.get("type"):undefined},a);b.mon(b,"beforeclose",function(){this.installing_fore_pkg=null;if(Ext.isFunction(e)){(function(){e()}).defer(100)}if(!b.isFinished){this._onResetInstPkgs()}},this,{single:true});b.open()},_onRequestSynoPkg:function(d,g,b,i,e){var f={};for(var h in SYNO.SDS.PkgManApp.Config){if(SYNO.SDS.PkgManApp.Config.hasOwnProperty(h)){if("myds_id"===h||"auth_key"===h||"serial"===h){f[h]=SYNO.SDS.PkgManApp.Config[h]}else{var c=h.substr(0,3);if("ds_"===c){f[h]=SYNO.SDS.PkgManApp.Config[h]}}}}var a=(function(k,l,j){if(b===1){if(g){if(Ext.isFunction(i)){i()}else{this._onLoadPkgStore(d.get("id"),false)}}else{this._onRequestDownload(d,g,i,j)}}else{if(g){this._onCheckInstall(d,i,j)}else{this._onRequestDownload(d,g,i,j)}}}).createDelegate(this);this.setStatusBusy();this._onCheckEnv(e,d,function(k,j){this.clearStatusBusy();if(!k){if(!j){this._onResetInstPkgs();this.getMsgBox().alert(d.get("dname")||_T("tree","leaf_packagemanage"),_T("error","error_error_system"),function(){if(Ext.isFunction(i)){i()}},this)}else{this._onCheckEnvFail(j,d,i,{fn:this._onRequestSynoPkg,args:[d,g,b,i,e],scope:this})}return}if(!g&&j.is_occupied){this._onResetInstPkgs();this.getMsgBox().alert(d.get("dname"),_T("pkgmgr","error_occupied"));if(Ext.isFunction(i)){i()}return}if(d.data.source!=="syno"||!this._isFirstBuy(d)){a.call(this,this,j,e)}else{this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.MyDS",method:"get",version:1,params:{},callback:function(o,n){var l;if(this.isDestroyed){return}this.clearStatusBusy();if(o&&Ext.isDefined(n)&&Ext.isDefined(n.myds_id)){Ext.apply(SYNO.SDS.PkgManApp.Config,n);this._showMyDSDialog(f,d,a,j,e)}else{if(Ext.isDefined(n)&&4571==n.code){l=new SYNO.SDS.MyDSCenter.LoginDialog({owner:this.owner});this.mon(l,"login_success",function(){this.mun(l,"cancel_login",this._onResetInstPkgs,this);this._showMyDSDialog(f,d,a,j,e)},this);this.mon(l,"cancel_login",this._onResetInstPkgs,this);l.show()}else{this._onResetInstPkgs();var m=_T("common","error_system");if(n.code){m=SYNO.API.getErrorString(n.code)}this.getMsgBox().alert(this.title,m,function(){},this)}}},scope:this})}})},_onClickSynoPkgActionBtn:function(c,a){var b=c.get("progress");if(!Ext.isDefined(a)){a=false}if(this._IsInstalling(c.data)){this._onLoadPkgStore(c.get("id"),false)}else{if(b>0){if(!a){this._onRequestCancelDownload(c)}}else{this._onClickInstall(c)}}},_isFirstBuy:function(b){var a=b.data;if(!Ext.isEmpty(a.status)||b.data.source!=="syno"){return false}if(0!==a.type){return true}return false},_onStartPkg:function(b){this.setStatusBusy();var a={id:b.id,dsm_apps:b.get("dsm_apps")?b.get("dsm_apps").split(" "):[]};this.sendWebAPI({api:"SYNO.Core.Package.Control",method:"start",version:1,timeout:3600000,params:a,scope:this,callback:function(f,c,e,d){this.clearStatusBusy();this._handleApplyDone(f,c,e,d)}})},_onStopPkg:function(a){this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),_T("pkgmgr","pkgmgr_pkg_stop_warn"),function(b,d){if(b=="yes"){this.setStatusBusy();var c={id:a.id};this.sendWebAPI({api:"SYNO.Core.Package.Control",method:"stop",version:1,timeout:3600000,params:c,scope:this,callback:function(h,e,g,f){this.clearStatusBusy();this._handleApplyDone(h,e,g,f)}})}},this)},_onUninstallPkg:function(b,c){if(b.get("pkgisuninstui")){var a=new SYNO.SDS.PkgManApp.UninstallWizardDialog({owner:this,packagename:b.id,dsm_apps:b.get("dsm_apps")});a.mon(a,"uninstalldone",function(){c()},this);a.open()}else{this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),_T("pkgmgr","pkgmgr_pkg_uninstall_warn"),function(d,f){if(d=="yes"){this.setStatusBusy();var e={id:b.id};this.sendWebAPI({api:"SYNO.Core.Package.Uninstallation",method:"uninstall",version:1,params:e,timeout:3600000,scope:this,callback:function(k,g,j,h){if(c){c()}if(h&&h.params&&h.params.id){var i=this._getInstalledStore().getById(h.params.id);if(i){this._getInstalledStore().remove(i)}}this.clearStatusBusy();this._handleApplyDone(k,g,j,h)}})}},this)}},_showLog:function(b){var a=new SYNO.SDS.PkgManApp.LogDialog({owner:this},b);a.open()},_showMyDSDialog:function(a,e,f,d,b){var c=new SYNO.SDS.PkgManApp.MyDSDialog({owner:this,myds_params:Ext.apply({appId:e.get("id")},a),type:e.data.type,listeners:{scope:this,payevent:f.createDelegate(this,[this,d,b]),payfailed:this._onResetInstPkgs}});c.show()}});SYNO.SDS.PkgManApp.ActionUtils={};Ext.apply(SYNO.SDS.PkgManApp.ActionUtils,{_onCheckPKGFail:function(a,c,d){var b=this._onCheckPKGFailMsg(c,a,undefined);if(Ext.isFunction(d)){d=Ext.createInterceptor(b.callback,d,this)}else{d=b.callback}this.getMsgBox().alert(c||_T("tree","leaf_packagemanage"),b.msg,d,this);this._onResetInstPkgs()},_onCheckEnvFail:function(a,e,f,b){var d=e.get("dname");var c=this._onCheckPKGFailMsg(d,a,undefined);if(Ext.isFunction(f)){f=Ext.createInterceptor(c.callback,f,this)}else{f=c.callback}if(a&&a.code===4552&&a.errors.packages){this.getMsgBox().confirm(d||_T("tree","leaf_packagemanage"),String.format(_T("pkgmgr","error_upgrade_dep_statable_packages"),d,a.errors.packages),function(g){if("yes"===g){if(b.args){b.args[b.args.length-1]={blCheckDep:false}}b.fn.apply(b.scope,b.args||[])}else{this._onResetInstPkgs()}},this)}else{this.getMsgBox().alert(d||_T("tree","leaf_packagemanage"),c.msg,f,this);this._onResetInstPkgs()}},_notifyServiceStatus:function(k,e,f,b){var l=false,c=false;if(!f){return}var d=SYNO.API.Util.GetReqByAPI(b,"SYNO.Core.Package","get","id")||f.id;var j=SYNO.API.Util.GetValByAPI(e,"SYNO.Core.Package","get");var a=f.method;if(b&&b.params&&b.params.method){a=b.params.method}var g=(e.result)?e.result.length:0;for(var h=0;h<g;h++){if(e.result[h].method==="install"&&e.result[h].success===true){l=true}else{if(e.result[h].method==="start"&&e.result[h].success===true){c=true}}}if(l){a="install"}else{if(c){a="start"}}this._notifyPackage(d,a,j||e,f);SYNO.SDS.StatusNotifier.fireEvent("thirdpartychanged",d,a)},_handleApplyDone:function(a,e,d,b){if(a&&e&&!e.has_fail){if(SYNO.API.Util.GetValByAPI(e,"SYNO.Core.Package.Installation","install","reboot")){this._showDoneMessage(a,e,d,b);SYNO.SDS.System.RebootWithMsg(_T("pkgmgr","reboot_warn"))}else{this._showDoneMessage(a,e,d,b)}}else{this._showErrMsg(e,b,d)}var c=SYNO.SDS.PkgManApp.Window;c.setStatusBusy();c.mon(c.pollingTask,"callback",function(){c.clearStatusBusy();this._onLoadOtherPkgStore(true);this._onLoadSynoPkgStore(true)},this,{single:true});c.fireEvent("pollinginstpage")},_notifyPackage:function(a,c,b,d){var e=[];if(d&&Ext.isArray(d.dsm_apps)){e=d.dsm_apps}else{if(b&&b.dsm_apps){e=b.dsm_apps.split(" ")}else{if(b&&b.additional&&b.additional.dsm_apps){e=b.additional.dsm_apps.split(" ")}}}SYNO.SDS.StatusNotifier.on("jsconfigLoaded",function(){if(("install"===c||"upgrade"===c)&&!Ext.isEmpty(e)){SYNO.SDS.AppView.notifyInstalled(e);Ext.each(e,function(g){var f=SYNO.SDS.Config.FnMap[g];if(f&&f.config&&f.config.useCSPRule){if(!SYNO.SDS.Config.CheckCSPRefresh){SYNO.SDS.Config.CheckCSPRefresh=[]}SYNO.SDS.Config.CheckCSPRefresh.push(g)}})}else{SYNO.SDS.AppView.refresh()}},this,{single:true,delay:100})},_parseDepPkg:function(a){var f="";for(var b in a){if(a.hasOwnProperty(b)){if(f!==""){f+=", "}var e=this._getAvalRec(b),d=e?e.get("dname"):b,c="";for(var g in a[b]){if(a[b].hasOwnProperty(g)){switch(Ext.util.Format.htmlDecode(g)){case">=":c=String.format(_T("pkgmgr","version_bigger_equal"),d,a[b][g]);break;case"<=":c=String.format(_T("pkgmgr","version_less_equal"),d,a[b][g]);break;case"=":c=String.format(_T("pkgmgr","version_equal"),d,a[b][g]);break;case">":c=String.format(_T("pkgmgr","version_bigger"),d,a[b][g]);break;case"<":c=String.format(_T("pkgmgr","version_less"),d,a[b][g]);break;default:c=d;break}break}}f+=(c||d)}}return f},_onCheckPKGFailMsg:function(f,a,b){a=a||{};a=a.error||a;var e=b||_T("user","user_file_upload_fail");var h=Ext.emptyFn;var g;if(a.code){g=a.code;if(Ext.isObject(a.errors)){a=a.errors}}switch(g){case 4520:e=_T("error","error_space_not_enough");break;case 4502:case 4503:e=(4502==g)?_T("error","volume_no_volumes"):_T("error","volume_creating");h=function(i){if("ok"===i){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}};break;case 4504:e=_T("pkgmgr","error_sys_no_space");break;case 4521:e=_T("pkgmgr","pkgmgr_file_not_package");break;case 4528:e=String.format(_T("pkgmgr","pkgmgr_pkg_not_support_platform"),_D("product"));break;case 4536:e=_T("pkgmgr","incompatible");break;case 4523:e=String.format(_T("pkgmgr","pkgmgr_pkg_required_newer_version"),a.firmware);break;case 4527:e=String.format(_T("pkgmgr","port_conflict"),a.adminport);break;case 4522:e=_T("pkgmgr","broken_package");break;case 4526:var c=this._parseDepPkg(a.uninstall_packages);if(!Ext.isEmpty(a.unstart_packages)&&!Ext.isEmpty(c)){e=_T("pkgmgr","depend_uninst_unstart")+"<br>"+c+", "+a.unstart_packages}else{if(!Ext.isEmpty(a.unstart_packages)){e=_T("pkgmgr","depend_unstart")+"<br>"+a.unstart_packages}else{e=_T("pkgmgr","depend_packages")+"<br>"+c}}break;case 4531:e=_T("pkgmgr","pkgmgr_not_syno_publish");break;case 4532:e=_T("pkgmgr","pkgmgr_unknown_publisher");break;case 4533:e=_T("pkgmgr","pkgmgr_no_signature");break;case 4534:e=_T("pkgmgr","pkgmgr_cert_expired");break;case 4535:e=_T("pkgmgr","broken_package");break;case 4582:e=String.format(_T("pkgmgr","error_stop_dep_packages"),a.packages);break;case 4547:case 4552:if(f){e=String.format(_T("pkgmgr","error_upgrade_dep_packages_with_name"),a.packages,f)}else{e=String.format(_T("pkgmgr","error_upgrade_dep_packages"),a.packages)}break;case 4524:e=String.format(_T("pkgmgr","conflict_packages"),a.packages);break;case 4525:var d=this._decodeServiceErr(a.services);e=d.msg;h=d.callback;break;case 4530:e=_T("pkgmgr","error_occupied");break;case 4505:e=_T("error","no_external_devices");break;default:e=SYNO.SDS.PkgManApp.Utils.getWebAPIErr(false,a,{},f)}if(f){e=f+":<br>"+e}return{msg:e,callback:h}},_showDoneMessage:function(k,f,g,b){var e="",m="",n,l,h,d;if(b&&b.params){var j=false;var c=SYNO.API.Util.GetValByAPI(f,"SYNO.Core.Package","get","additional");if(c&&"running"===c.status){j=true}var a=SYNO.API.Util.GetReqByIndex(b,0,"method");switch(a){case"uninstall":e=_T("pkgmgr","pkgmgr_pkg_uninstall_success");break;case"install":if(1===this.mode){e=j?"":_T("pkgmgr","pkgmgr_pkg_upgrade_wizard_done")}else{e=j?"":_T("pkgmgr","pkgmgr_pkg_install_wizard_done")}break;case"upgrade":e=j?"":_T("pkgmgr","pkgmgr_pkg_upgrade_wizard_done");break;default:break}}if(Ext.isArray(f.result)){n=f.result;for(h=0;h<n.length;h++){d=SYNO.API.Util.GetValByIndex(f,h,"message");if(!d||d===m){continue}e+=(e?"<br>":"")+d;m=d}}else{if(f.message){e+=(e?"<br>":"")+f.message}}if(Ext.isDefined(f.worker_message)){e+=(e?"<br>":"")+SYNO.SDS.PkgManApp.Utils.localizeWorkerMsg(f.worker_message)}if(e){l=this.dname||this.pkgName||_T("tree","leaf_packagemanage");this.getMsgBox().alert(l,e,function(){this.isFinished=true;if(this.goNext){this.goNext(null)}},this)}else{this.isFinished=true;if(this.goNext){this.goNext(null)}}if(g){this._notifyServiceStatus(k,f,g,b)}},_decodeServiceErr:function(d){var f="SYNO.SDS.AdminCenter.WebServices.Main",e,g="",b=_T("controlpanel","leaf_service");if(Ext.isArray(d)){var a=0;for(var c=0;c<d.length;c++){switch(d[c]){case"ssh":a|=SYNO.SDS.PkgManApp.SERVICE.PKG_SERVICES_SSH;break;case"pgsql":a|=SYNO.SDS.PkgManApp.SERVICE.PKG_SERVICES_PGSQL;break}}d=a}if(d&SYNO.SDS.PkgManApp.SERVICE.PKG_SERVICES_SSH){f="SYNO.SDS.AdminCenter.TerminalSNMP.Main";g=_T("pkgmgr","require_sshd");b=_T("tree","leaf_terminal");e="terminal"}else{if("yes"===_D("usbstation","no")&&d&SYNO.SDS.PkgManApp.SERVICE.PKG_SERVICES_PGSQL){f="SYNO.SDS.AdminCenter.SystemDatabase.Main";g=_T("pkgmgr","require_pgsql");b=_T("metadata","metadata_title");e=undefined}else{if(d&SYNO.SDS.PkgManApp.SERVICE.PKG_SERVICES_PGSQL){return{msg:_T("pkgmgr","wait_pgsql"),callback:function(){if(this.goNext){this.goNext(null)}}}}}}g+=(g?"<br>":"")+String.format(_T("pkgmgr","prompt_enable_serviece"),b);return{msg:g,callback:function(h){if("ok"===h){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:f,tab:e});if(this.goNext){this.goNext(null)}}}}},_showErrMsg:function(n,b,g){var m;var f=_T("error","error_error_system"),k=this.dname||this.pkgName||_T("tree","leaf_packagemanage"),e;if(n){f="";var d=SYNO.API.Util.GetFirstError(n),l=true,j,i,a;if(d){j=SYNO.API.Util.GetFirstErrorIndex(n);i=SYNO.API.Util.GetReqByIndex(b,j,"api");if("SYNO.Core.Package.Control"===i){a=SYNO.API.Util.GetReqByIndex(b,j,"method");if(0===j){f=("start"===a)?_T("pkgmgr","pkgmgr_pkg_start_failed"):_T("pkgmgr","pkgmgr_pkg_stop_failed")}else{l=true;f=this.mode?_T("pkgmgr","pkgmgr_pkg_upgrade_wizard_done"):_T("pkgmgr","pkgmgr_pkg_install_wizard_done")}}else{if(i==="SYNO.Core.Package"){if(SYNO.API.Util.GetReqByAPI(b,"SYNO.Core.Package.Control","start")){f=_T("pkgmgr","pkgmgr_pkg_start_failed")}else{if(SYNO.API.Util.GetReqByAPI(b,"SYNO.Core.Package.Control","stop")){f=_T("pkgmgr","pkgmgr_pkg_stop_failed")}else{f=this.mode?_T("pkgmgr","pkgmgr_pkg_upgrade_wizard_done"):_T("pkgmgr","pkgmgr_pkg_install_wizard_done")}}}else{if(i==="SYNO.Core.Package.Installation"){a=SYNO.API.Util.GetReqByIndex(b,j,"method");if("install"===a){if(this.dname||this.pkgName){f=String.format((this.mode?_T("pkgmgr","upgrade_pkg_fail"):_T("pkgmgr","install_pkg_fail")),this.dname||this.pkgName,"")}else{f=this.mode?_T("pkgmgr","upgrade_fail"):_T("pkgmgr","install_fail")}}}}}e=d.code;d=d.errors||d;switch(e){case 4502:f=_T("error","volume_no_volumes");m=function(o){if("ok"===o){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}};break;case 4503:f=_T("error","volume_creating");m=function(o){if("ok"===o){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}};break;case 4525:var h=this._decodeServiceErr(d.services);if(l){f=_T("pkgmgr","pkgmgr_pkg_start_failed")+"<br>"}f+=h.msg;m=h.callback;break;case 4562:f=String.format(_T("pkgmgr","error_uninst_dep_packages"),d.packages);break;case 4547:if(this.dname||this.pkgName){f=String.format(_T("pkgmgr","error_upgrade_dep_packages_with_name"),d.packages,this.dname||this.pkgName)}else{f=String.format(_T("pkgmgr","error_upgrade_dep_packages"),d.packages)}break;case 4552:a=SYNO.API.Util.GetReqByIndex(b,j,"method");var c=SYNO.API.Util.GetReqByIndex(b,j,"force");if(a==="install"&&c===false&&b.compound){this.getMsgBox().confirm(this.dname||_T("tree","leaf_packagemanage"),String.format(_T("pkgmgr","error_upgrade_dep_statable_packages"),this.dname||this.pkgName,d.packages),function(o){if("yes"===o){this.setStatusBusy();SYNO.API.Util.GetReqByIndex(b,j).params.force=true;this.sendWebAPI({timeout:3600000,compound:b.compound,scope:this,callback:function(s,p,r,q){this.clearStatusBusy();this._handleApplyDone(s,p,r,q)}})}},this);return}if(this.dname||this.pkgName){f=String.format(_T("pkgmgr","error_upgrade_dep_packages_with_name"),d.packages,this.dname||this.pkgName)}else{f=String.format(_T("pkgmgr","error_upgrade_dep_packages"),d.packages)}break;case 4582:f=String.format(_T("pkgmgr","error_stop_dep_packages"),d.packages);break;case 4546:f=String.format(_T("pkgmgr","downgrade_version"),d.current_version,d.install_version);break;case 4583:f=String.format(_T("pkgmgr","version_less_than_limit"),d.current_version,d.require_version);break;case 4548:f=String.format(_T("pkgmgr","version_less_than_limit"),d.current_version,d.require_version);break;default:f=SYNO.SDS.PkgManApp.Utils.getWebAPIErr(false,SYNO.API.Util.GetFirstError(n),{},this.dname||this.pkgName,f);break}}if(d.message&&""!==d.message){f+=(f?"<br>":"")+SYNO.SDS.PkgManApp.Utils.localizeMsg(d.message,d.message,this.dsm_apps)}if(Ext.isDefined(d.worker_message)){f+=(f?"<br>":"")+SYNO.SDS.PkgManApp.Utils.localizeWorkerMsg(d.worker_message)}if(f===""){f=_T("error","error_error_system")}}this.getMsgBox().alert(k,f,m||function(){var o=SYNO.API.Util.GetReqByIndex(b,0,"method");if(this.goNext&&(o!=="install"||e===4580)){this.goNext(null)}},this);SYNO.SDS.reloadJSConfig()}});SYNO.SDS.PkgManApp.DownloadAction=Ext.extend(Ext.util.Observable,{constructor:function(a,d){this.owner=a.owner;this.foreground=a.foreground;this.id=a.id;if(!d){var b=a.data.taskid||a.data.data.taskid;d=SYNO.SDS.PackageTaskMgr.addWebAPITask({id:b,interval:1200,query:{api:"SYNO.Core.Package.Installation",method:"status",version:1,params:{task_id:b}},cancel:{api:"SYNO.Core.Package.Installation",method:"cancel",version:1,params:{taskid:b}}})}d.addCallback(this.onDownloadCallBack,this);var c=this.owner._getSynoServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id);if(this.foreground){this.showProgress(c.get("dname"),c.get("dname")+": "+_T("download","download_task_downloading"),(function(){var f=this.owner._getSynoServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id);this.onSetProgress(f,0);d.cancel()}).createDelegate(this))}var e;if(c){c.set("progress",0.00001);if((this.blupgrad=c.get("blupgrade"))){e=this.owner._getInstalledStore().getById(c.get("id"));if(e){e.commit()}}}this.addEvents({finish:true});SYNO.SDS.PkgManApp.DownloadAction.constructor.call(this)},onDownloadCallBack:function(b,d,f,c,e){if(this.owner.isDestroyed){if("cancel"!==d&&f){this.owner._notifyPackage(this.id,this.blupgrad?"upgrade":"install",e);SYNO.SDS.StatusNotifier.fireEvent("thirdpartychanged",this.id,this.blupgrad?"upgrade":"install")}return}var a=this.owner._getSynoServerObj().store.getById(this.id)?this.owner._getSynoServerObj().store:this.owner._getOtherServerObj().store;if(!a||a.isDestroyed){return}if("cancel"===d){return this.onCancelTask(b,e)}else{if(f){this.onFinishTask(c,e)}else{if(c||(e&&e.installing)){this.onProgressTask(c,e)}}}},onCancelTask:function(a,c){var d=this.owner._getSynoServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id),b=true;if(this.foreground){this.owner._onResetInstPkgs();this.owner.getMsgBox().hide()}var e=d?d.get("blupgrade"):false;if(c&&c.code){this.owner.getMsgBox().alert(_T("tree","leaf_packagemanage"),SYNO.API.getErrorString(c.code));if(4506===c.code){b=false;a.restart(true)}}else{if(d){this.onSetProgress(d,0)}}SYNO.SDS.PkgManApp.Window.clearStatusBusy();this.owner._onLoadPkgStore(this.id,false,function(){if(e){this.fireEvent("pollinginstpage")}});return b},onFinishTask:function(b,c){var d=this.owner._getSynoServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id);if(d){this.onSetProgress(d,Ext.isDefined(b)?b:1)}var e=d?d.get("blupgrade"):false;var a=this.owner.addTask({interval:1000,run:function(){var f=this.id;this.owner._onLoadPkgStore(this.id,false,function(){if(e){this.fireEvent("pollinginstpage");d=this._getInstalledStore().getById(f);if(d){d.commit()}}});a.remove()},scope:this}).start(false);if(this.owner._getSynoServerObj().store.getById(this.id)){this.owner._getSynoServerObj().blRefresh=false}else{this.owner._getOtherServerObj().blRefresh=false}if(this.foreground){this.owner.getMsgBox().hide();if(!c||!c.success){this.owner.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","download_fail"));this.owner._onResetInstPkgs();return}if(false!==this.fireEvent("finish")){this.owner._onRequestInstall(d)}}else{this.owner._notifyPackage(this.id,e?"upgrade":"install",c);SYNO.SDS.StatusNotifier.fireEvent("thirdpartychanged",this.id,e?"upgrade":"install");this.fireEvent("finish")}},onProgressTask:function(a,d){var e=this.owner._getSynoServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id);if(d&&d.success&&e){this.onSetProgress(e,a,d)}if(this.foreground&&a){var c=(a*100).toFixed(0);var b;b="<center>"+c+"&#37;</center>";this.owner.getMsgBox().updateProgress(a,b,this.msg)}},showProgress:function(e,d,a){this.msg=d;var c={title:e,msg:d,width:300,progress:true,progressText:"<center>0&#37;</center>",closable:false,buttons:Ext.Msg.CANCEL,fn:a};var b=this.owner.getMsgBox();this.owner.mon(this.owner.msgBox,"beforeshow",SYNO.SDS.PkgManApp.Utils.setGlobalValue,this);this.owner.mon(this.owner.msgBox,"beforeclose",SYNO.SDS.PkgManApp.Utils.cleanGlobalValue,this);b.show(c)},onSetProgress:function(c,b,d){if(c&&d){c.data.info=d}c.data.progress=b;c.commit();var e=this.owner._getInstalledStore().getById(c.get("id"));if(e){e.commit()}if(d&&d.dsm_apps){var a=d.dsm_apps.split(" ");Ext.each(a,function(f){var g=SYNO.SDS.AppMgr.getByAppName(f);Ext.each(g,function(h){h.destroy()});SYNO.SDS.JSLoad.RemoveJSSatusByAppName(f)})}}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.SortButton=Ext.extend(SYNO.ux.Button,{constructor:function(a){SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.SortButton",this);var b=this.fillConfig(a);SYNO.SDS.PkgManApp.SortButton.superclass.constructor.call(this,b)},fillConfig:function(a){var c=this;var b={tabIndex:-1,itemId:"sort",tooltip:_T("pkgmgr","sort"),cls:"syno-pkg-sort-btn",menu:{defaults:{checked:false},cls:"syno-pkg-menu syno-ux-searchfield-menu",items:[{group:"filter",itemId:"filter_all",text:_T("pkgmgr","class_all")},{group:"filter",itemId:"filter_installed",text:_T("pkgmgr","filter_installed")},"-",{group:"type",itemId:"type_name",text:_T("pkgmgr","sort_by_name")},{group:"type",itemId:"type_popularity",text:_T("pkgmgr","sort_by_recent_popularity")}],listeners:{scope:this,itemclick:this.onSortMenuItemClick},show:function(e,f,d){if(this.floating){this.parentMenu=d;if(!this.el){this.render();this.doLayout(false,true)}c.onSortMenuBeforeShow(this);this.showAt(this.el.getAlignToXY(e,f||this.defaultAlign,this.defaultOffsets),d)}else{Ext.menu.Menu.superclass.show.call(this)}}}};Ext.apply(b,a);return b},getMenuClass:function(){return""},onSortMenuItemClick:function(c,b){if(c.itemId.substr(0,5)=="type_"){this.setSortType(c.itemId)}else{this.setTypeFilter(c.itemId)}var d=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var a=d.getActiveItem();if(a.onActivate){a.onActivate(true)}},onSortMenuBeforeShow:function(c){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var b=SYNO.SDS.PkgManApp.Utils,d=a.getCurId();if(d===b._INSTALLED_ID||d===b._UPDATE_ID){return}c.items.each(function(e){e.show();if(d===b._CAT_COMMUNITY_ID){if(!e.setIconClass||e.itemId.substr(0,5)=="type_"){e.hide()}}if(e.setChecked){e.setChecked((e.itemId===this.getSortType()||e.itemId===this.getTypeFilter()))}},this)},getSortType:function(){return this._sortType||"type_name"},setSortType:function(a){this._sortType=a},getTypeFilter:function(){return this._typeFilter||"filter_all"},setTypeFilter:function(a){this._typeFilter=a},setAllFilter:function(){this.setTypeFilter("filter_all")},setSortButtonDisabled:function(a){this.setDisabled(a)},sortStore:function(d){var c="dname",b="ASC",e=this.getSortType();if(e==="type_popularity"){c="recent_download_count";b="DESC"}var f=function(g,h){if(g.data.maintainer.indexOf("Synology")==h.data.maintainer.indexOf("Synology")){if(Ext.isNumber(g.data[c])){return g.data[c]-h.data[c]}else{return g.data[c].localeCompare(h.data[c])}}return h.data.maintainer.indexOf("Synology")-g.data.maintainer.indexOf("Synology")};var a=function(g,h){if(g.data.maintainer.indexOf("Synology")==h.data.maintainer.indexOf("Synology")){if(Ext.isNumber(g.data[c])){return h.data[c]-g.data[c]}else{return h.data[c].localeCompare(g.data[c])}}return h.data.maintainer.indexOf("Synology")-g.data.maintainer.indexOf("Synology")};d.data.sort("ASC",("ASC"==b)?f:a);d.fireEvent("datachanged",this)}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.TermConfirmDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(a){Ext.apply(this,a);var b=Ext.apply({owner:a.owner,resizable:false,minimizable:false,maximizable:false,closable:false,stateful:false,footer:true,title:_T("tree","leaf_packagemanage"),cls:"x-window-dlg",items:[{xtype:"syno_formpanel",items:[{xtype:"syno_displayfield",htmlEncode:false,value:a.msg||String.format(_T("pkgmgr","termsofservice_desc"),String.format('<a href="{0}" target="_blank" class="pathlink">{1}</a>',SYNO.SDS.PkgManApp.TOFURL,_T("pkgmgr","termsofservice")))},{ctCls:"syno-pkg-termdlg-check",xtype:"syno_checkbox",itemId:"option",boxLabel:_T("pkgmgr","termsofservice_accept"),listeners:{check:{fn:function(d,c){this.btnOK.setDisabled(!c)},scope:this}}}]}],fbar:new Ext.Toolbar({items:[this.btnOK=new SYNO.ux.Button({btnStyle:"blue",id:this.btnOKId=Ext.id(),text:_T("common","ok"),scope:this,disabled:true,handler:this.onClickOK}),{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.onClickClose}],enableOverflow:false}),keys:[{key:27,fn:this.onClickClose,scope:this}]},a);SYNO.SDS.PkgManApp.TermConfirmDialog.superclass.constructor.call(this,b)},onClickOK:function(){this.owner.appInstance.setUserSettings(SYNO.SDS.PkgManApp.Config.termofservice,true);this.owner.appInstance.setUserSettings(SYNO.SDS.PkgManApp.Config.termofservice_4_2,true);this.close()},onClickClose:function(){this.owner.close()}});Ext.namespace("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.LogDialog=Ext.extend(SYNO.SDS.ModalWindow,{title:_T("pkgmgr","log_title"),constructor:function(a,b){SYNO.SDS.PkgManApp.Utils._initWinWrappers.call(this,a);SYNO.SDS.PkgManApp.LogDialog.superclass.constructor.call(this,Ext.apply(a,{width:620,height:350,minWidth:600,plain:true,layout:"fit",items:[{itemId:"grid",xtype:"grid",stripeRows:true,hideHeaders:true,columns:[{header:_T("status","header_value"),width:300,sortable:false,dataIndex:"name"}],store:this.getLogStore(),viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:function(c,f,e,d){e.body="<p>"+c.data.value+"</p>";return"x-grid3-row-expanded"}},listeners:{scope:this,buffer:100,afterlayout:function(){this.onSendRequest(b)}}}],buttons:[{text:_T("common","close"),scope:this,handler:this.close}]}))},getLogStore:function(b){var a=new Ext.data.ArrayStore({fields:["name","value"]});return a},onSendRequest:function(a){this.setStatusBusy();this.get("grid").getGridEl().unmask();this.sendWebAPI({api:"SYNO.Core.Package.Log",method:"get",version:1,params:{name:a},scope:this,callback:function(d,c){if(this.isDestroyed){return}this.clearStatusBusy();var b=[];if(!Ext.isEmpty(c.pkglog)){b.push(["",this.renderLog(c.pkglog)]);this.get("grid").getStore().loadData(b)}else{this.get("grid").getGridEl().mask(_T("photo_viewer","no_data"),"")}}})},renderLog:function(a){return'<div style="white-space: pre;">'+a+"</div>"}});Ext.namespace("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.WizardDialog=Ext.extend(SYNO.SDS.Wizard.ModalWindow,{constructor:function(c,a){SYNO.SDS.PkgManApp.Utils._initWinWrappers.call(this,c);this.upload_task_id=null;this.uploadFilename=null;this.isFinished=false;this.mode=c.mode;this.orimode=this.mode;this.type=c.type;var b=[];if(!a){b.push(this.getBasicPanel({itemId:"uploadStep",nextId:"licenceStep"}))}if(!a||a.licence){b.push(this.getLicencePanelConfig({itemId:"licenceStep",nextId:"volumeStep"}))}b.push(this.getVolumePanelConfig({itemId:"volumeStep",nextId:"applyStep"}));b.push(this.getInfoPanelConfig({itemId:"applyStep",nextId:null}));SYNO.SDS.PkgManApp.WizardDialog.superclass.constructor.call(this,Ext.apply(c,{dsmStyle:"v5",title:(this.orimode===3)?_T("pkgmgr","install_upgrade_title"):(this.orimode?_T("pkgmgr","pkgmgr_pkg_upgrade"):_T("pkgmgr","pkgmgr_pkg_install")),width:700,height:500,steps:b}));this.mon(this,"beforeshow",function(){SYNO.SDS.PkgManApp.Window.loadCfg();SYNO.SDS.PkgManApp.Utils.setGlobalValue()});Ext.EventManager.on(window,"unload",this.onSyncCleanTmp,this);SYNO.SDS.StatusNotifier.on("logout",this.onSyncCleanTmp,this);this.mon(this,"beforeclose",function(){this.onAsyncCleanTmp();SYNO.SDS.PkgManApp.Utils.cleanGlobalValue()},this);if(a){if(a.errmsg){var e;if(a&&a.dname){e=a.dname}this._onCheckPKGFail(a,e)}else{this.onCheckPKGDone(a,false)}return}var d=this.getStep("uploadStep").getForm();d.on("actioncomplete",function(f,h){Ext.get(this.id).unmask();if(!h.success||!h.result){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_unknown"));return}var g=h.result.data;this.mode=("non_installed"!==g.additional.status)?1:0;this.onCheckPKGDone(g,true)},this);d.on("actionfailed",function(f,g){this._onCheckPKGFail(g.result)},this)},onCheckPKGDone:function(a,f){var b=SYNO.SDS.PkgManApp.Utils;this.upload_task_id=b.getValue(a,"task_id");this.uploadFilename=a.filename;this.pkgName=b.getValue(a,"id");this.dname=b.getValue(a,"name");this.pkgVersion=b.getValue(a,"version");this.desc=b.getValue(a,"description");this.maintainer=b.getValue(a,"maintainer");this.pkgDistributor=b.getValue(a,"distributor");this.pkgLicence=b.getValue(a,"licence");this.pkgCanRun=!b.getValue(a,"install_reboot")&&b.getValue(a,"startable");this.pkgqinst=a.pkgqinst;this.pkgqinstrec=a.pkgqinstrec;this.install_type=b.getValue(a,"install_type");this.dsm_apps=[];var d=b.getValue(a,"dsm_apps");if(Ext.isString(d)){this.dsm_apps=d.split(" ")}this.isUploaed=true;var e=b.getValue(a,"install_pages");if(e){var c=this.parseCustomui(e);c[c.length-1].nextId="applyStep";this.customuiIds=this.appendSteps(c)}else{this.customuiIds=undefined}if(!Ext.isEmpty(SYNO.SDS.PkgManApp.Config.def_void)){this.installVolume=SYNO.SDS.PkgManApp.Config.def_void}if(this.orimode<2){this.blUpgrade=this.orimode===1}else{this.blUpgrade=b.getValue(a,"status")!=="non_installed"}var h=this.dname||this.pkgName||"";if(h){h+=" - "}if(this.blUpgrade){this.setTitle(h+_T("pkgmgr","pkgmgr_pkg_upgrade"))}else{this.setTitle(h+_T("pkgmgr","pkgmgr_pkg_install"))}Ext.get(this.id).mask(_T("common","msg_waiting"),"x-mask-loading");var g=[{api:"SYNO.Core.Package.Setting.Volume",method:"get",version:1},{api:"SYNO.Core.Storage.Volume",method:"list",version:1,params:{offset:0,limit:-1,location:"internal"}}];if(Ext.isDefined(SYNO.API.GetKnownAPI("SYNO.Core.CMS.Info"))&&Ext.isDefined(SYNO.API.GetKnownAPI("SYNO.Core.Storage.Volume"))&&"cluster"===this.install_type){g.push({api:"SYNO.Core.CMS.Info",method:"get",version:1,params:{additional:["gluster_role"]}},{api:"SYNO.Core.Storage.Volume",method:"list",version:1,params:{offset:0,limit:-1,location:"internal",option:"include_glusterfs_used"}})}this.install_cluster=false;this.sendWebAPI({compound:{stopwhenerror:false,params:g},scope:this,callback:function(v,o,m,j){Ext.get(this.id).unmask();if(!v||o.has_fail){var q=SYNO.API.Util.GetFirstErrorIndex(o);if(1===q){var n=SYNO.API.Util.GetFirstError(o);this.getMsgBox().alert("",SYNO.API.Erros.core[n.code]||_T("common","commfail"));return}}var u=SYNO.API.Util.GetValByAPI(o,"SYNO.Core.Storage.Volume","list","volumes"),t=[],s,p,k,r,w,l;this.installVolume=SYNO.API.Util.GetValByAPI(o,"SYNO.Core.Package.Setting.Volume","get","default_vol");if(u&&0===u.length){l=SYNO.API.Util.GetValByAPI(o,"SYNO.Core.CMS.Info","get","additional");if(l&&(r=l.gluster_role)&&(r&1)&&(r&2)){k=SYNO.API.Util.GetValByIndex(o,3,"volumes");if(k){s=k.length;for(p=0;p<s;p++){w=k[p];if(w&&!w.readonly&&w.size_free_byte>209715200){t.push({mount_point:w.volume_path,name:String.format("{0} ({1}{2} {3})",_T("pkgmgr","brick"),_T("volume","volume_freesize"),_T("common","colon"),SYNO.SDS.StorageUtils.SizeRender(w.size_free_byte,10)),description:w.description});this.installVolume=w.volume_path;break}}this.install_cluster=true}}}else{if(u){s=u.length;for(p=0;p<s;p++){w=u[p];t.push({mount_point:w.volume_path,name:SYNO.SDS.Utils.StorageUtils.VolumeNameSizeRenderer(w),description:w.description})}}}if(Ext.isEmpty(t)&&"system"!==this.install_type){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","volume_no_volumes"),function(i){if("ok"===i){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}this.goNext(null)},this);return}this.volumes=t;if(b.getValue(a,"licence")){this.goNext("licenceStep",f)}else{if(this.volumes&&this.volumes.length>1&&!this.blUpgrade&&(this.install_cluster||Ext.isEmpty(this.installVolume))&&"system"!==this.install_type){this.goNext("volumeStep",f)}else{if(this.customuiIds&&this.customuiIds.length>0){this.goNext(this.customuiIds[0],f)}else{if(f){this.goNext("applyStep",f)}else{if(this.goNext("applyStep",f)){this.goNext(this.getActiveStep().getNext(),f)}}}}}}})},parseCustomui:function(pkgcustomui){if(Ext.isString(pkgcustomui)){try{pkgcustomui=Ext.decode(decodeURIComponent(pkgcustomui))}catch(e){pkgcustomui=Ext.decode(window.unescape(pkgcustomui))}}var step_title,i,j,type,synotype,steps=[],desc,textType;for(i=0;i<pkgcustomui.length;i++){if(!Ext.isArray(pkgcustomui[i].items)){continue}var item,items=pkgcustomui[i].items,compitems=[],config,key,keys=["labelHtmlEncode","labelStyle","style"],pkguicfg=pkgcustomui[i];for(j=0;j<items.length;j++){type=items[j].type;textType=undefined;if(type==="multiselect"){synotype="syno_checkbox"}else{if(type==="singleselect"){synotype="syno_radio"}else{if(type==="textfield"){synotype="syno_textfield"}else{if(type==="password"){synotype="syno_textfield";textType="password"}else{if(type==="combobox"){synotype="syno_combobox"}else{if(!type&&!items[j].subitems&&Ext.isString(items[j].desc)){keys=keys.concat(["htmlEncode"]);item=items[j];config={xtype:"syno_displayfield",htmlEncode:false,value:SYNO.SDS.Utils.GetLocalizedString(item.desc,this.dsm_apps[0])||item.desc};for(key in keys){if(item[key]){config[key]=item[key]}}compitems.push(config)}else{continue}}}}}}if(!Ext.isArray(items[j].subitems)){continue}var subitems=items[j].subitems;var v;if(items[j].desc){compitems.push({xtype:"syno_displayfield",htmlEncode:false,value:SYNO.SDS.Utils.GetLocalizedString(items[j].desc,this.dsm_apps[0])||items[j].desc})}for(var k=0;k<subitems.length;k++){item=subitems[k];config={xtype:synotype,name:(type==="singleselect")?("radiogroup_"+j):item.key,htmlEncode:false,itemId:item.key};if(textType){Ext.apply(config,{textType:textType})}if(type==="password"||type==="textfield"||type==="combobox"){config.width=285;if(type==="combobox"){var id=Ext.id();Ext.apply(config,Ext.apply(item,{id:id}));if(Ext.isObject(item.api_store)){config.mode="remote";config.store=new SYNO.API.JsonStore(Ext.apply(item.api_store,{autoDestroy:true,autoLoad:true,appWindow:this,listeners:{single:true,load:function(store,records){if(records&&records[0]&&records[0].id){var combo=Ext.getCmp(id);if(combo){combo.setValue(records[0].id)}}}}}));delete config.api_store}}else{Ext.apply(config,item)}if(item.emptyText){config.emptyText=item.emptyText}if(item.defaultValue){config.value=item.defaultValue}if(Ext.isObject(item.validator)){v=item.validator;if(Ext.isBoolean(v.allowBlank)){config.allowBlank=v.allowBlank}if(Ext.isNumber(v.minLength)){config.minLength=v.minLength}if(Ext.isNumber(v.maxLength)){config.maxLength=v.maxLength}if(Ext.isString(v.vtype)){config.vtype=v.vtype}if(Ext.isObject(v.regex)&&Ext.isString(v.regex.expr)){try{var regex;eval(String.format("regex = {0};",v.regex.expr));config.regex=regex;if(Ext.isString(v.regex.errorText)){config.regexText=Ext.util.Format.htmlEncode(v.regex.errorText)}}catch(e){SYNO.Debug(e);return true}}if(Ext.isString(v.fn)){config.fnstring=v.fn;config.validator=function(val){try{var fn;eval(String.format("fn = function(){0};",this.fnstring));var ret=fn(val,this,this.ownerCt);return Ext.isString(ret)?Ext.util.Format.htmlEncode(ret):ret}catch(e){SYNO.Debug(e);return true}}}}}else{if(Ext.isBoolean(item.defaultValue)){config.checked=item.defaultValue}if(Ext.isObject(item.validator)){v=item.validator;if(Ext.isString(v.fn)){config.fnstring=v.fn;config.getErrors=function(val){try{var fn;eval(String.format("fn = function(){0};",this.fnstring));var r=fn(this.getValue(),this,this.ownerCt);if(Ext.isBoolean(r)){return r===false?[""]:[]}if(Ext.isString(r)){try{this.ownerCt.ownerCt.owner.getMsgBox().alert(_T("tree","leaf_packagemanage"),r)}catch(e){}}return Ext.isString(r)?Ext.util.Format.htmlEncode(r):[]}catch(e){SYNO.Debug(e);return[]}}}}}desc=SYNO.SDS.Utils.GetLocalizedString(item.desc,this.dsm_apps[0])||item.desc;if(desc){config.boxLabel=config.fieldLabel=desc}if(k===0&&type==="singleselect"){config.checked=true}if(items[j].desc){config.indent=1}if(type==="combobox"){keys=keys.concat(["autoSelect","displayField","editable","forceSelection","handleHeight","listAlign","listEmptyText","listWidth","maxHeight","minChars","minHeight","minListWidth","mode","pageSize","queryDelay","queryParam","resizable","selectOnFocus","store","title","triggerAction","typeAhead","typeAheadDelay","valueField"])}if(type==="password"||type==="textfield"||type==="combobox"){keys=keys.concat(["blankText","grow","growMax","growMin","htmlEncode","maxLengthText","minLengthText"])}keys=keys.concat(["autoScroll","disabled","height","hidden","invalidText","margins","preventMark","width"]);for(key in keys){if(item[key]){config[key]=item[key]}}config.listeners={buffer:100,check:function(){if(pkguicfg.invalid_next_disabled&&this.ownerCt&&this.ownerCt.getForm){this.ownerCt.owner.getButton("next").setDisabled(!this.ownerCt.getForm().isValid())}},change:function(field,newValue,oldValue){if(pkguicfg.invalid_next_disabled&&this.ownerCt&&this.ownerCt.getForm){this.ownerCt.owner.getButton("next").setDisabled(!this.ownerCt.getForm().isValid())}}};compitems.push(config)}}step_title=pkguicfg.step_title;config={headline:SYNO.SDS.Utils.GetLocalizedString(step_title,this.dsm_apps[0])||step_title,xtype:"syno_formpanel",border:false,items:compitems,labelWidth:200,checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);if(pkguicfg.invalid_next_disabled&&this.getForm){this.owner.getButton("next").setDisabled(!this.getForm().isValid())}},activate:function(){if(pkguicfg.activeate){var fn;eval(String.format("fn = function(){0};",pkguicfg.activeate));fn(this,this.ownerCt)}},deactivate:function(action){if(pkguicfg.deactivate){var fn;eval(String.format("fn = function(){0};",pkguicfg.deactivate));var r=fn(this,this.ownerCt,action);if(Ext.isBoolean(r)){return r}}if(action==="next"&&this.getForm&&!this.getForm().isValid()){return false}return true}};steps.push(config)}return steps},getBasicPanel:function(a){var b=new SYNO.SDS.Utils.FormPanel(Ext.apply({labelWidth:200,headline:_T("pkgmgr","pkgmgr_pkg_install_wizard_upload_title"),description:_T("service","service_file_nofileselected_tip"),webapi:{api:"SYNO.Core.Package.Installation",method:"upload",version:1},fileUpload:true,border:false,items:[{xtype:"hidden",name:"additional",value:Ext.encode(["description","maintainer","distributor","startable","dsm_apps","status","install_reboot","install_type"])},{fieldLabel:_T("common","file"),xtype:"syno_filebutton",name:"file"}],activate:function(){this.owner.isUploaed=false;if(this.owner.orimode===3){this.owner.setTitle(_T("pkgmgr","install_upgrade_title"))}if(a.itemId==="uploadStep"){this.owner.onSendCleanTmp(true)}},getNext:function(){if(this.owner.isUploaed){return this.nextId}var d=this.getForm().findField("file").getValue();if(d===""){this.owner.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_nochoosefile"));return false}var f=0;var h=["spk"];var c=d.toString().split(".");var g=c.pop();if(g!==undefined){for(var e=0;e<h.length;e++){if(g.toLowerCase()==h[e]){f=1;break}}}if(f){Ext.get(this.owner.id).mask(_T("common","msg_waiting"),"x-mask-loading");this.getForm().doAction("submit")}else{this.owner.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","pkgmgr_file_not_package"))}return false}},a));return b},getLicencePanelConfig:function(a){var b=Ext.apply({hideMode:"offsets",headline:_T("pkgmgr","license_title"),description:_T("pkgmgr","license_desc_short"),xtype:"syno_formpanel",border:false,items:[{hideLabel:true,xtype:"syno_textarea",name:"licence",autoCreate:{tag:"textarea",autocomplete:"off",wrap:"Physical"},readOnly:true,cls:"selectabletext allowDefCtxMenu",width:650,height:220,value:""},{xtype:"syno_checkbox",boxLabel:_T("pkgmgr","license_accept"),name:"checklicence",listeners:{scope:this,check:function(c,d){this.getButton("next").setDisabled(!d)}}}],checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);this.getForm().findField("checklicence").setValue(false);this.owner.getButton("next").setDisabled(true)},activate:function(){try{this.getForm().findField("licence").setValue(decodeURIComponent(this.owner.pkgLicence))}catch(c){this.getForm().findField("licence").setValue(window.unescape(this.owner.pkgLicence))}},getNext:function(){var c;if(this.owner.volumes.length>1&&!this.owner.blUpgrade&&Ext.isEmpty(this.owner.installVolume)&&"system"!==this.owner.install_type){c="volumeStep"}else{if(this.owner.customuiIds&&this.owner.customuiIds.length>0){c=this.owner.customuiIds[0]}else{c="applyStep"}}return c}},a);return b},getVolumePanelConfig:function(a){var d=new Ext.data.Record.create([{name:"name"},{name:"mount_point"},{name:"description"}]),b,f;this.volumeStore=new Ext.data.ArrayStore({fields:["mount_point","name","description"],data:[]});var c=new SYNO.ux.StorageComboBox({store:this.volumeStore,name:"voulme_list",displayField:"name",descriptionField:"description",valueField:"mount_point",mode:"local",editable:false,hideLabel:true,triggerAction:"all",width:285});var e=Ext.apply({headline:_T("pkgmgr","pkgmgr_pkg_install_wizard_selectvol_title"),xtype:"syno_formpanel",border:false,items:[c,{xtype:"syno_displayfield",height:195},{xtype:"syno_checkbox",boxLabel:_T("pkgmgr","be_default_vol"),name:"be_default_vol"}],activate:function(){this.owner.blSetDefaultVol=false;var g=!this.owner.install_cluster;var h=this.getForm().findField("be_default_vol");h.setVisible(g);if(!c.getValue()){this.owner.volumeStore.removeAll();if(this.owner.volumes){for(b=0;b<this.owner.volumes.length;b++){f=new d({name:this.owner.volumes[b].name,mount_point:this.owner.volumes[b].mount_point,description:Ext.util.Format.htmlEncode(this.owner.volumes[b].description)});this.owner.volumeStore.add(f)}c.setValue(this.owner.volumes[0].mount_point)}}},getNext:function(){var g=this.getForm().findField("be_default_vol").getValue();var j=this.getForm().findField("voulme_list").getValue();if(this.owner.blSetDefaultVol){this.owner.installVolume=j;return(this.owner.customuiIds&&this.owner.customuiIds.length>0)?this.owner.customuiIds[0]:"applyStep"}this.owner.setStatusBusy({text:_T("common","saving")});var i=this.owner.volumeStore.findExact("mount_point",j);var h=g?this.owner.volumeStore.getAt(i).get("mount_point"):"";this.owner.sendWebAPI({api:"SYNO.Core.Package.Setting.Volume",method:"set",version:1,params:{default_vol:h},scope:this.owner,callback:function(l,k){this.clearStatusBusy();if(!l){if(!k||!k.code){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"))}else{this.getMsgBox().alert(_T("tree","leaf_packagemanage"),SYNO.API.getErrorString(k.code))}return}this.blSetDefaultVol=true;this.goNext(this.getActiveStep().getNext())}});return false}},a);return e},getInfoPanelConfig:function(a){var b=_T("pkgmgr","pkgmgr_pkg_install_wizard_summary_desc");if(this.mode){b=_T("pkgmgr","pkgmgr_pkg_upgrade_wizard_summary_desc")}var c=Ext.apply({headline:_T("pkgmgr","pkgmgr_pkg_install_wizard_summary_title"),description:b,xtype:"syno_formpanel",items:[{xtype:"syno_gridpanel",border:false,stripeRows:true,height:250,viewConfig:{getRowClass:function(d){if(d.data.id==="description"){return"syno-pkg-wizard-desc"}return""}},columns:[{header:_T("status","header_item"),width:100,sortable:false,dataIndex:"name",renderer:function(f,e){var d=Ext.util.Format.htmlEncode(f);e.attr='ext:qtip="'+Ext.util.Format.htmlEncode(d)+'"';return d}},{header:_T("status","header_value"),width:220,sortable:false,dataIndex:"value",renderer:function(f,e){var d=Ext.util.Format.htmlEncode(f);e.attr='ext:qtip="'+Ext.util.Format.htmlEncode(d)+'"';return d}}],store:this.getDetailsStore()},{xtype:"syno_checkbox",boxLabel:_T("pkgmgr","install_runpackage"),name:"installrunpackage"}],activate:function(){this.owner.loadInfo();var e=this.owner.pkgCanRun&&!this.owner.blUpgrade;var d=this.getForm().findField("installrunpackage");d.setVisible(e);d.setValue(e)},getNext:function(){var e=this.getForm().findField("installrunpackage").getValue();if(this.owner.pkgqinst){var d=this.owner.owner;var i=this.owner.pkgqinstrec;var g=this.owner.installVolume;this.owner.goNext(null);d._onRequestQuickInstall(i,g,e);return false}var k=this.owner.blUpgrade?_T("pkgmgr","upgrading"):_T("pkgmgr","installing");this.owner.setStatusBusy({text:k});var f=this.owner.getComponent("steps");var j=[{api:"SYNO.Core.Package.Installation",method:"install",version:1,params:{volume_path:this.owner.installVolume,extra_values:Ext.encode(this.owner.getCustData(f)),type:this.type||0,force:this.owner.getStep("uploadStep")?false:true}}];if(this.owner.upload_task_id){j[0].params.task_id=this.owner.upload_task_id}else{j[0].params.path=this.owner.uploadFilename}if(e){j.push({api:"SYNO.Core.Package.Control",method:"start",version:1,params:{id:this.owner.pkgName,type:"install"}})}j.push({api:"SYNO.Core.Package",method:"get",version:1,params:{id:this.owner.pkgName,additional:["status","dsm_apps"]}});var h=function(r,p,o,m,l){if(this.owner.isDestroyed||o!==this.owner.pkgName){return}var n;var q=this.owner._GetProcessStatus(l,m);if(q.blProcessing){if(l==="stopping"){n=_T("pkgmgr","upgrading")}else{n=q.msg}}else{if(m){n=Math.floor(m*100)+"% "+k;this.owner.el.mask(Math.floor(m*100)+"% "+k,"x-mask-loading")}}this.owner.el.mask(n||k,"x-mask-loading")};this.sendWebAPI({timeout:3600000,compound:{stopwhenerror:true,params:j},scope:this,callback:function(o,l,n,m){if(!(o&&l&&!l.has_fail)){this.owner.el.unmask()}this.mun(this.owner.owner,"pollingprogress",h,this);this.owner.clearStatusBusy();this.owner._handleApplyDone(o,l,n,m)}});if(this.owner.dsm_apps){Ext.each(this.owner.dsm_apps,function(l){var m=SYNO.SDS.AppMgr.getByAppName(l);Ext.each(m,function(n){n.window.close()});SYNO.SDS.JSLoad.RemoveJSSatusByAppName(l)})}this.owner.owner.fireEvent("pollinginstpage");this.mon(this.owner.owner,"pollingprogress",h,this);return false}},a);return c},getCustData:function(a){var b={};Ext.each(this.customuiIds,function(e){var c=a.get(e).getForm();var d={};c.items.each(function(g){if("displayfield"!==g.getXType()&&"syno_displayfield"!==g.getXType()){d[g.itemId]=g.getValue()}});Ext.apply(b,d)},this);return b},getDetailsStore:function(){this.store=new Ext.data.JsonStore({autoLoad:false,autoDestroy:true,root:"items",fields:["id","name","value"]});return this.store},loadInfo:function(){var b=[{id:"name",name:_T("pkgmgr","pkgmgr_pkg_name"),value:this.dname||this.pkgName},{id:"version",name:_T("pkgmgr","pkgmgr_pkg_version"),value:this.pkgVersion},{id:"maintainer",name:_T("pkgmgr","pkgmgr_pkg_maintainer"),value:this.maintainer}];if(this.pkgDistributor){b.push({id:"distributor",name:_T("pkgmgr","pkgmgr_pkg_distributor"),value:this.pkgDistributor})}if(this.install_type==="system"){b.push({id:"volume",name:_T("pkgmgr","pkgmgr_pkg_install_volume"),value:_T("pkgmgr","system_volume")})}else{if(this.volumes&&1<=this.volumes.length){for(var a=0;a<this.volumes.length;a++){if(this.volumes[a].mount_point==this.installVolume){b.push({id:"volume",name:_T("pkgmgr","pkgmgr_pkg_install_volume"),value:this.volumes[a].name});break}}}}b.push({id:"description",name:_T("pkgmgr","pkgmgr_pkg_description"),value:this.desc});this.store.loadData({items:b})},onSyncCleanTmp:function(){Ext.EventManager.un(window,"unload",this.onSyncCleanTmp,this);SYNO.SDS.StatusNotifier.un("logout",this.onSyncCleanTmp,this);this.onSendCleanTmp(false)},onAsyncCleanTmp:function(){Ext.EventManager.un(window,"unload",this.onSyncCleanTmp,this);SYNO.SDS.StatusNotifier.un("logout",this.onSyncCleanTmp,this);this.onSendCleanTmp(true)},onSendCleanTmp:function(a){var b;if(this.uploadFilename){b={path:this.uploadFilename};this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"delete",version:1,params:b,async:a,timeout:a?30000:1000})}else{if(this.upload_task_id){b={task_id:this.upload_task_id};this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"clean",version:1,params:b,async:a,timeout:a?30000:1000})}}this.uploadFilename=null;this.upload_task_id=null}});SYNO.SDS.PkgManApp.UninstallWizardDialog=Ext.extend(SYNO.SDS.PkgManApp.WizardDialog,{constructor:function(a){SYNO.SDS.PkgManApp.Utils._initWinWrappers.call(this,a);this.packagename=a.packagename;this.dsm_apps=[];if(a.dsm_apps){this.dsm_apps=a.dsm_apps.split(" ")}SYNO.SDS.PkgManApp.WizardDialog.superclass.constructor.call(this,Ext.apply(a,{dsmStyle:"v5",title:_T("tree","leaf_packagemanage"),width:700,height:500,steps:[this.getBasicPanel({itemId:"confirmStep",nextId:true})]}));this.mon(this,"beforeshow",function(){SYNO.SDS.PkgManApp.Utils.setGlobalValue()});this.mon(this,"beforeclose",function(){SYNO.SDS.PkgManApp.Utils.cleanGlobalValue()},this)},getBasicPanel:function(a){var b=Ext.apply({headline:_T("pkgmgr","pkgmgr_pkg_uninstall"),xtype:"syno_formpanel",border:false,items:[{xtype:"syno_displayfield",value:_T("pkgmgr","pkgmgr_pkg_uninstall_warn")}],getNext:function(){this.owner.loadUIfile();return false}},a);return b},loadUIfile:function(){Ext.get(this.id).mask(_T("common","msg_waiting"),"x-mask-loading");var a={id:this.packagename,additional:["uninstall_pages"]};this.sendWebAPI({api:"SYNO.Core.Package",method:"get",version:1,params:a,scope:this,callback:this.handelloadUIfileDone})},handelloadUIfileDone:function(f,b,e,d){Ext.get(this.id).unmask();if(!f||!b.additional||!b.additional.uninstall_pages){this._showErrMsg(b);return}var c=b.additional.uninstall_pages;if(c){var a=this.parseCustomui(c);a[a.length-1].getNext=function(){var h=this.owner.getActiveStep(),g;if(h){g=h.getItemId();if(Ext.isFunction(h.deactivate)){if(false===h.deactivate("next")){return false}}}this.owner.setStatusBusy();var i={id:this.owner.packagename,extra_values:Ext.encode(this.owner.getCustData(this.owner.getComponent("steps")))};this.sendWebAPI({api:"SYNO.Core.Package.Uninstallation",method:"uninstall",version:1,params:i,timeout:3600000,scope:this,callback:function(m,j,l,k){if(!this.owner.isDestroyed&&m){this.fireEvent("uninstalldone")}this.owner.clearStatusBusy();this.owner._handleApplyDone(m,j,l,k)}});return false};this.customuiIds=this.appendSteps(a)}else{this.customuiIds=undefined}if(this.customuiIds&&this.customuiIds.length>0){this.goNext(this.customuiIds[0])}else{this._showErrMsg()}}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.SettingDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(a){var b=new Ext.data.SimpleStore({fields:["mount_point","display","size_free","description"],data:[]});SYNO.SDS.PkgManApp.SettingDialog.superclass.constructor.call(this,Ext.apply(a,{dsmStyle:"v5",title:_T("download","download_table_heading_setting"),width:700,height:580,layout:"fit",border:false,items:[{xtype:"syno_tabpanel",plain:true,itemId:"tab",activeTab:0,deferredRender:false,items:[{xtype:"syno_formpanel",itemId:"general",border:false,trackResetOnLoad:true,title:_T("common","general"),items:[this.vol_fieldset=new SYNO.ux.FieldSet({xtype:"syno_fieldset",title:_T("pkgmgr","default_vol"),hidden:true,items:[{xtype:"syno_displayfield",value:_T("pkgmgr","default_vol_desc")},{xtype:"syno_storage_combobox",itemId:"default_vol",name:"default_vol",fieldLabel:_T("pkgmgr","default_vol"),store:b,displayField:"display",descriptionField:"description",valueField:"mount_point",grow:true,width:300,indent:0,tpl:new Ext.XTemplate('<tpl for=".">',"<tpl if=\"mount_point === 'no_default_vol'\">",'<div class="x-combo-list-item" style="height: 26px">',"</tpl>","<tpl if=\"mount_point !== 'no_default_vol'\">",'<div ext:qtip="{description:htmlEncode}" class="x-combo-list-item" style="height: 52px">',"</tpl>",'<div class="sds-combo-list-item-name">{display}</div>','<div class="sds-combo-list-item-description">{description}</div>',"</div>","</tpl>"),listeners:{scope:this,select:function(e){var f=e.ownerCt.ownerCt.form.findField("volume_status_text");f.hide();var c=e.getStore();var d=c.findExact("mount_point",e.getValue());if(0!==d&&209715200>=parseInt(c.getAt(d).get("size_free"),10)){f.setValue('<font color="red">'+_T("status","status_no_space")+"</font>");f.show()}else{if(!e.isDirty()&&(!Ext.isEmpty(f.originalValue))){f.setValue(f.originalValue);f.show()}}}}},{fieldLabel:"",labelStyle:"color:red;width:180px",xtype:"syno_displayfield",name:"volume_status_text",value:""}]}),{xtype:"syno_fieldset",title:_T("tree","leaf_notification"),items:[{xtype:"syno_displayfield",value:_T("pkgmgr","notification_desc")},{xtype:"syno_checkbox",name:"enable_email",boxLabel:_T("autoblock","autoblock_notify")},{xtype:"syno_checkbox",name:"enable_dsm",boxLabel:_T("pkgmgr","desktop_notification")}]},{xtype:"syno_fieldset",title:_T("pkgmgr","trust_level"),items:[{xtype:"syno_displayfield",value:_T("pkgmgr","allow_pkg_publisher")},{xtype:"syno_radio",name:"trust_level",inputValue:0,boxLabel:_T("common","synology")},{xtype:"syno_radio",name:"trust_level",inputValue:1,boxLabel:_T("pkgmgr","synology_trust_developer")},{xtype:"syno_radio",name:"trust_level",inputValue:2,boxLabel:_T("pkgmgr","disable_trust_level")}]}]},{xtype:"syno_formpanel",itemId:"channel",border:false,trackResetOnLoad:true,title:_T("pkgmgr","update_channel"),items:[{xtype:"syno_displayfield",value:_T("pkgmgr","update_channel_desc"),htmlEncode:false},{xtype:"syno_checkbox",boxLabel:_T("pkgmgr","update_channel_beta_yes"),name:"update_channel"}]},this.createPackageUpdatePanel(),this.createFeedGridPanel(),this.createKeyringGridPanel()]}],buttons:[{text:_T("common","ok"),scope:this,handler:this.saveHandler},{text:_T("common","close"),scope:this,handler:this.closeHandler}],keys:[{key:[10,13],fn:this.saveHandler,scope:this},{key:27,fn:this.closeHandler,scope:this}],listeners:{scope:this,single:true,afterlayout:this.onAfterLayout}}));this.defineBehaviors()},defineBehaviors:function(){this.channelForm=this.get("tab").get("channel");this.generalForm=this.get("tab").get("general");this.grid=this.get("tab").get("grid")},createFeedStore:function(){return new Ext.data.Store({autoLoad:true,autoDestroy:true,remoteSort:false,proxy:new SYNO.API.Proxy({api:"SYNO.Core.Package.Feed",method:"list",version:1}),reader:new Ext.data.JsonReader({root:"items",id:"feed"},[{name:"name"},{name:"feed"}]),listeners:{scope:this,load:function(a){this.owner.loadCfg()}}})},colRender:function(g,d,f,c,e,a){var b=Ext.util.Format.htmlEncode(g);d.attr='ext:qtip="'+Ext.util.Format.htmlEncode(b)+'"';return b},sourceRender:function(h,e,g,d,f,a){var c=a.reader.jsonData.items[d];if(c.user_added){h=_T("rsrcmonitor","cpu_user")}else{if(c.source){h=c.source[0]}else{h=_T("common","synology")}}var b=Ext.util.Format.htmlEncode(h);e.attr='ext:qtip="'+Ext.util.Format.htmlEncode(b)+'"';return b},createKeyStore:function(){return new Ext.data.Store({autoLoad:true,autoDestroy:true,proxy:new SYNO.API.Proxy({api:"SYNO.Core.Package.Feed.Keyring",method:"list",version:1}),reader:new Ext.data.JsonReader({root:"items",id:"keyring"},[{name:"name"},{name:"length"},{name:"algorithm"},{name:"fingerprint"},{name:"source"}]),listeners:{scope:this,load:function(a){this.owner.loadCfg()}}})},createKeyringGridPanel:function(){this.keystore=this.createKeyStore();var a={title:_T("certificate","certificate"),itemId:"keygrid",store:this.keystore,autoExpandColumn:"fingerprint",enableColumnMove:false,enableHdMenu:false,stripeRows:true,colModel:new Ext.grid.ColumnModel([{header:_T("common","name"),dataIndex:"name",id:"name",renderer:this.colRender},{header:_T("pkgmgr","key_length"),dataIndex:"length",id:"length",renderer:this.colRender},{header:_T("pkgmgr","key_algorithm"),dataIndex:"algorithm",width:120,id:"algorithm",renderer:this.colRender},{header:_T("pkgmgr","key_fingerprint"),dataIndex:"fingerprint",id:"fingerprint",renderer:this.colRender},{header:_T("helpbrowser","help_source"),dataIndex:"source",id:"source",renderer:this.sourceRender}]),selModel:new Ext.grid.RowSelectionModel({listeners:{scope:this,buffer:100,selectionchange:this.updateBtn}}),tbar:{items:[{xtype:"syno_button",text:_T("nfs","nfs_kerberos_import_keys"),itemId:"addkey",scope:this,handler:this.onAddKeyHandler},{xtype:"syno_button",text:_T("common","delete"),itemId:"delkey",disabled:true,scope:this,handler:function(c){var b=c.ownerCt.ownerCt;if(!this.isSelectUserKeys(b.getSelectionModel().getSelections())){this.getMsgBox().alert(this.title,_T("pkgmgr","error_remove_syno_cert"));return}this.onDeleteHandler(c,"keyring","fingerprint")}}]}};return new SYNO.ux.GridPanel(a)},onAddKeyHandler:function(){var a=new SYNO.SDS.PkgManApp.KeyringDialog({owner:this},{jsConfig:this.jsConfig,success:function(){this.keystore.reload()},scope:this});a.show()},isSelectUserKeys:function(c){for(var a=0;a<c.size();++a){var b=c[a].json;if(true!==b.user_added){return false}}return true},onDeleteHandler:function(d,a,b){var c=d.ownerCt.ownerCt;var f=c.getSelectionModel();var e=f.getSelections();if(e.length<1){return}this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),_T("common","remove_cfrmrmv"),function(h){if("yes"==h){var j=[];for(var g=0;g<e.length;g++){j.push(e[g].get(b))}this.setStatusBusy({text:_T("filetable","filetable_deleting")});var k={list:Ext.encode(j)};this.sendWebAPI({api:"feed"==a?"SYNO.Core.Package.Feed":"SYNO.Core.Package.Feed.Keyring",method:"delete",params:k,callback:this.onDeleteDone,version:1,scope:this})}},this);return},createFeedGridPanel:function(){var a=this.createFeedStore();this.feedstore=a;var b={title:_T("pkgmgr","feed_server"),itemId:"grid",store:a,autoExpandColumn:"feed",enableColumnMove:false,enableHdMenu:false,stripeRows:true,colModel:new Ext.grid.ColumnModel({columns:[{header:_T("common","name"),dataIndex:"name",width:100,renderer:this.colRender},{header:_T("pkgmgr","feed"),dataIndex:"feed",id:"feed",renderer:this.colRender}]}),selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{scope:this,buffer:100,selectionchange:this.updateBtn}}),tbar:{items:[{xtype:"syno_button",text:_T("common","add"),itemId:"add",scope:this,handler:function(){this.onEditHandler()}},{xtype:"syno_button",text:_T("common","alt_edit"),itemId:"edit",disabled:true,scope:this,handler:function(){this.onEditHandler(this.get("tab").get("grid").getSelectionModel().getSelected())}},{xtype:"syno_button",text:_T("common","delete"),itemId:"delete",disabled:true,scope:this,handler:function(d){this.onDeleteHandler(d,"feed","feed")}}]}};var c=new SYNO.ux.GridPanel(b);return c},onEditHandler:function(b){var a=new SYNO.SDS.PkgManApp.FeedDialog({owner:this},{jsConfig:this.jsConfig,blEdit:b?true:false,success:function(){this.feedstore.reload();this.keystore.reload()},scope:this});a.load(b)},updateBtn:function(d){if(this.isDestroyed){return}var b=d.grid;var e=b.getTopToolbar();var a=b.getSelectionModel();var c=a.getSelections();if("grid"===d.grid.itemId){e.getComponent("delete").setDisabled(c.length===0);e.getComponent("edit").setDisabled(c.length!==1)}else{if("keygrid"===d.grid.itemId){e.getComponent("delkey").setDisabled(c.length===0)}}},onSetVolField:function(d){var c=this.generalForm.form;if(!d.volume_list||1>=d.volume_list.length||(!d.volume_list&&!d.volume_status)){this.vol_fieldset.hide();return}this.vol_fieldset.show();var b=c.findField("default_vol").store;var a=[["no_default_vol",_T("pkgmgr","no_default_vol"),undefined,""]];Ext.each(d.volume_list,function(h,f,g){a.push([h.mount_point,h.display,h.size_free,Ext.util.Format.htmlEncode(h.desc)])},this);b.loadData(a);if(Ext.isEmpty(d.default_vol)){c.setValues({default_vol:"no_default_vol"})}else{c.setValues({default_vol:d.default_vol});if(!Ext.isEmpty(d.volume_status)){var e=_T("volume","volume_status_crashed");if("no_space"===d.volume_status){e=_T("status","status_no_space")}c.setValues({volume_status_text:'<font color="red">'+e+"</font>"})}}},onAfterLayout:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Setting",method:"get",version:1,callback:function(b,a){if(!b||!a){this.getMsgBox().alert(this.title,_T("error","error_error_system"));return}this.generalForm.getForm().setValues(a);this.channelForm.getForm().setValues(a);this.updateAllForm.getForm().setValues(a);this.updateAllForm.getForm().setValues({autoupdateall:a.autoupdateall?"autoupdateall_all":"autoupdateall_some"});this.mailset=a.mailset;this.onSetVolField(a);this.clearStatusBusy()},scope:this})},saveHandler:function(){var a=this.generalForm.getForm();if(!this.mailset&&a.findField("enable_email").getValue()){this.getMsgBox().show({title:this.title,msg:_T("pkgmgr","pkg_email_set_err"),buttons:Ext.MessageBox.OKCANCEL,fn:function(b){if("ok"==b){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Notification.Main"})}this.close()},scope:this});return}if(!this.isAnyFormDirty()){this.close();return}this.onSendSaveHandler()},onSendSaveHandler:function(){var h=this.channelForm.getForm(),e=this.generalForm.getForm(),b=this.updateAllForm.getForm(),d=[];this.setStatusBusy({text:_T("common","saving")});var i=b.findField("autoupdateall").getValue(),g=b.findField("enable_autoupdate").getValue();var c={update_channel:h.findField("update_channel").getValue()?"beta":"stable",enable_email:e.findField("enable_email").getValue(),enable_dsm:e.findField("enable_dsm").getValue(),trust_level:e.findField("trust_level").getGroupValue(),enable_autoupdate:g,autoupdateall:i};if(g&&!i){var f=this.updateAllGrid.getStore().getModifiedRecords();if((f&&f.length)||b.findField("autoupdateall").isDirty()){this.updateAllGrid.getStore().each(function(j){if(j.data.autoupdate){d.push(j.id)}});c.packages=Ext.encode(d)}}var a=e.findField("default_vol");if(a.isDirty()){Ext.apply(c,{default_vol:a.getValue()})}this.sendWebAPI({api:"SYNO.Core.Package.Setting",method:"set",version:1,timeout:3600000,params:c,callback:function(n,m){if(this.isUpdateChannelSwitched()){this.setForceReload()}if(!n){this.clearStatusBusy();if(!m||!m.code){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"));return}else{this.getMsgBox().alert(_T("tree","leaf_packagemanage"),SYNO.API.getErrorString(m.code))}}else{this.owner.loadCfg((function(){this.clearStatusBusy();this.close()}).createDelegate(this))}if(g){var l=SYNO.SDS.PkgManApp.Window;var k=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");if(1===k.getCurIndex()){var j=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewDetail");j.onActivate()}l.fireEvent("pollinginstpage")}},scope:this})},closeHandler:function(){if(this.isAnyFormDirty()){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(a){if("yes"==a){this.close()}else{return}},this)}else{this.close()}},isUpdateChannelSwitched:function(){var a=this.channelForm.getForm().findField("update_channel");return a.isDirty()},setForceReload:function(){if(this.owner._onRefresh){this.owner._onRefresh()}},isAnyFormDirty:function(){var a=this.getAllForms(),b=false;if(this.updateAllForm.getForm().isDirty()){return true}if(!Ext.isEmpty(this.updateAllGrid.getStore().getModifiedRecords())){return true}Ext.each(a,function(e,c,d){if(e.isDirty()){b=true;return false}},this);return b},getAllForms:function(){var a=[],b=this.get("tab");b.items.each(function(f,c,e){if(!f.getForm){return}var d=f.getForm();a.push(d)},this);return a},onDeleteDone:function(d,c,b,a){this.clearStatusBusy();if(!d){if(!c||!Ext.isDefined(c.code)){this.setStatusError()}else{this.setStatusError({text:SYNO.API.getErrorString(c.code)})}}else{if("SYNO.Core.Package.Feed"===a.params.api){this.grid.getStore().reload();this.keystore.reload()}else{if("SYNO.Core.Package.Feed.Keyring"===a.params.api){this.keystore.reload()}}}},getUpdateStore:function(){if(this.update_store){return this.update_store}this.update_store=new SYNO.API.Store({autoLoad:true,proxy:new SYNO.API.Proxy({api:"SYNO.Core.Package",method:"list",version:1,listeners:{scope:this,beforeload:function(a,b){var c=a.activeRequest.read;if(c){Ext.Ajax.abort(c)}}}}),sortInfo:{field:"name",direction:"ASC"},baseParams:{additional:["silent_upgrade","autoupdate"]},reader:new Ext.data.JsonReader({root:"packages",id:"id"},[{name:"id"},{name:"name"},{name:"silent_upgrade",mapping:"additional.silent_upgrade"},{name:"autoupdate",mapping:"additional.autoupdate"}])});return this.update_store},createPackageUpdatePanel:function(){this.updateAllColumn=new SYNO.ux.EnableColumn({bindRowClick:true,dataIndex:"autoupdate",align:"center",width:40,sortable:false,hideable:false,menuDisabled:true,enableFastSelectAll:true,isIgnore:function(c,b){if(!b.data.silent_upgrade){return true}return false},renderer:function(d,b,c){if(!c.data.silent_upgrade){d="disabled";b.css="x-item-disabled"}return String.format('<div class="syno-ux-grid-enable-column-{0}">&nbsp;</div>',("disabled"===d?"disabled":d?"checked":"unchecked"))}});var a={loadMask:true,disabled:true,margins:{left:30,right:30},region:"center",itemId:"grid",store:this.getUpdateStore(),autoExpandColumn:"name",enableColumnMove:false,enableHdMenu:false,stripeRows:true,plugins:[this.updateAllColumn],colModel:new Ext.grid.ColumnModel({columns:[this.updateAllColumn,{id:"name",header:_T("common","name"),dataIndex:"name",width:100,renderer:function(h,e,g,d,f,b){var c=Ext.util.Format.htmlEncode(h);e.attr='ext:qtip="'+Ext.util.Format.htmlEncode(c)+'"';return c}}]})};this.updateAllGrid=new SYNO.ux.GridPanel(a);return{title:_T("pkgmgr","auto_update"),layout:"border",items:[this.updateAllForm=new SYNO.ux.FormPanel({height:"auto",region:"north",xtype:"syno_formpanel",trackResetOnLoad:true,autoFlexcroll:false,items:[{xtype:"syno_checkbox",boxLabel:_T("pkgmgr","auto_update_enable"),name:"enable_autoupdate",listeners:{scope:this,check:function(d,c){var b=this.updateAllForm.getForm();b.findField("autoupdateall_some").setDisabled(!c);b.findField("autoupdateall_all").setDisabled(!c);if(!c){this.updateAllGrid.setDisabled(!c);this.updateAllNote.setDisabled(!c)}else{if(b.findField("autoupdateall_some").getValue()){this.updateAllGrid.setDisabled(false);this.updateAllNote.setDisabled(false)}}}}},{xtype:"syno_displayfield",value:String.format(_T("pkgmgr","auto_update_desc"),_D("product")),indent:1},{dataIndex:"autoupdateall_all",disabled:true,xtype:"syno_radio",boxLabel:_T("pkgmgr","auto_update_all_packages"),checked:true,name:"autoupdateall",hideLabel:true,inputValue:"autoupdateall_all",indent:1},{dataIndex:"autoupdateall_some",disabled:true,xtype:"syno_radio",boxLabel:_T("pkgmgr","auto_update_some_packages"),name:"autoupdateall",hideLabel:true,inputValue:"autoupdateall_some",indent:1,listeners:{scope:this,check:function(d,c){if(c&&0===this.update_store.getTotalCount()){this.update_store.load()}var b=d.disabled||!c;this.updateAllGrid.setDisabled(b);this.updateAllNote.setDisabled(b)}}}]}),this.updateAllGrid,this.updateAllNote=new SYNO.ux.DisplayField({region:"south",xtype:"syno_displayfield",value:_T("pkgmgr","auto_update_note"),indent:1})]}}});SYNO.SDS.PkgManApp.KeyringDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(b,a){Ext.apply(this,a||{});this.owner=b.owner;var c=this.fillConfig(b);SYNO.SDS.PkgManApp.KeyringDialog.superclass.constructor.call(this,c);this.defineBehaviors()},fillConfig:function(a){var b={owner:a.owner,width:550,height:180,constrainHeader:true,monitorResize:true,title:_T("certificate","import_crt"),layout:"fit",items:[this.initFormConfig()],buttons:[{text:_T("common","ok"),handler:this.onApplyHandler,scope:this},{text:_T("common","cancel"),handler:this.close,scope:this}],keys:[{key:27,fn:this.close,scope:this}]};Ext.apply(b,a);return b},initFormConfig:function(){var a={xtype:"syno_formpanel",itemId:"formpanel",trackResetOnLoad:true,labelAlign:"left",border:false,labelWidth:150,fileUpload:true,url:SYNO.API.currentManager.getBaseURL("SYNO.Core.Package.Feed.Keyring","add",1),items:[{xtype:"syno_displayfield",value:_T("pkgmgr","import_cert_desc")},{xtype:"syno_filebutton",fieldLabel:_T("common","file"),name:"upload_keyring",itemId:"file"}],listeners:{actioncomplete:{scope:this,fn:this.onActionComplete},actionfailed:{scope:this,fn:this.onActionFailed}}};return a},defineBehaviors:function(){this.form=this.get("formpanel").form},onApplyHandler:function(){var a=this.form;if(!a.isValid()){return}if(!a.isDirty()){this.close()}else{this.setStatusBusy({text:_T("common","saving")});a.doAction("apply")}},onActionComplete:function(b,a){this.clearStatusBusy();this.success.call(this.scope);this.close()},onActionFailed:function(c,b){this.clearStatusBusy();var a=b.result;this.setStatusError({text:SYNO.API.getErrorString(a.code)})}});SYNO.SDS.PkgManApp.FeedDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(b,a){Ext.apply(this,a||{});this.owner=b.owner;var c=this.fillConfig(b);SYNO.SDS.PkgManApp.FeedDialog.superclass.constructor.call(this,c);this.defineBehaviors()},fillConfig:function(a){var b={owner:a.owner,width:550,height:210,minWidth:100,minHeight:120,collapsible:false,autoScroll:false,constrainHeader:true,monitorResize:true,title:this.blEdit?_T("common","alt_edit"):_T("common","add"),layout:"fit",items:[this.initFormConfig()],buttons:[{text:_T("common","ok"),handler:this.onApplyHandler,scope:this},{text:_T("common","cancel"),handler:this.onCloseHandler,scope:this}],keys:[{key:[10,13],fn:this.onApplyHandler,scope:this},{key:27,fn:this.onCloseHandler,scope:this}]};Ext.apply(b,a);return b},initFormConfig:function(){var a={xtype:"syno_formpanel",itemId:"formpanel",labelAlign:"left",trackResetOnLoad:true,waitMsgTarget:true,border:false,labelWidth:150,items:[{xtype:"syno_textfield",itemId:"name",fieldLabel:_T("common","name"),name:"name",width:320},{xtype:"syno_textfield",itemId:"feed",allowBlank:false,fieldLabel:_T("pkgmgr","feed"),name:"feed",width:320}]};return a},defineBehaviors:function(){this.form=this.get("formpanel").form},onCloseHandler:function(){this.close()},onApplyHandler:function(){var a=this.form;if(!a.isValid()){return}if(a.isDirty()){var b={name:Ext.util.Format.trim(a.findField("name").getValue()),feed:Ext.util.Format.trim(a.findField("feed").getValue())};if(this.blEdit){Ext.apply(b,{oriname:a.findField("name").originalValue,orifeed:a.findField("feed").originalValue})}var c={list:Ext.encode(b)};this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Package.Feed",params:c,version:1,method:this.blEdit?"set":"add",callback:this.SaveDone,scope:this})}else{this.onCloseHandler()}},load:function(a){if(a){this.form.loadRecord(a)}this.show()},SaveDone:function(c,b){this.clearStatusBusy();if(!c){if(!b||!Ext.isDefined(b.code)){this.setStatusError({text:_T("error","save"),clear:true})}else{this.setStatusError({text:SYNO.API.getErrorString(b.code)})}}else{var a=this.owner;this.success.call(this.scope);this.close();if(b&&b.has_keyrings){a.getMsgBox().alert(_T("report","title_global_setting"),_T("pkgmgr","trust_feed_server_keys"))}}}});Ext.ns("SYNO.SDS.PkgManApp.Utils");Ext.apply(SYNO.SDS.PkgManApp.Utils,{mode:{open:"open",more:"more"},init:(function(){var b=SYNO.SDS.PkgManApp.Utils;b._INSTALLED_ID="installed";b._UPDATE_ID="update";b._CAT_ALL_ID="all";b._CAT_BACKUP_ID="backup";b._CAT_MULTIMEDIA_ID="multimedia";b._CAT_BUSINESS_ID="bussiness";b._CAT_SECURITY_ID="security";b._CAT_UTILITES_ID="utilities";b._CAT_DEVTOOLS_ID="devtools";b._CAT_PRODUCTIVITY_ID="productivity";b._CAT_COMMUNITY_ID="community";b._CAT_RECOMMEND_ID="recommend";b._INSTALLED_CLASS="installed";b._SYNO_SERVER_CLASS="synoserver";b._COMMUNITY_CLASS=b._CAT_COMMUNITY_ID;b._RECOMMEND_CLASS=b._CAT_RECOMMEND_ID;b.SEC_CFG={};b.SEC_CFG[b._INSTALLED_ID]={text:_T("pkgmgr","install_packages"),type:"installed",data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewGrid",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._UPDATE_ID]={text:_T("pkgmgr","upgradable"),data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewGrid",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._RECOMMEND_CLASS]={text:_T("pkgmgr","recommend"),data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.Recommend",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._CAT_ALL_ID]={text:_T("pkgmgr","class_all"),data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewList",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._CAT_BACKUP_ID]={category:1,text:_T("pkgmgr","class_backup"),data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewList",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._CAT_MULTIMEDIA_ID]={category:2,text:_T("pkgmgr","class_multimedia"),data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewList",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._CAT_BUSINESS_ID]={category:4,text:_T("pkgmgr","class_business"),data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewList",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._CAT_SECURITY_ID]={category:16,text:_T("pkgmgr","class_security"),data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewList",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._CAT_UTILITES_ID]={category:8,text:_T("pkgmgr","class_utilities"),data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewList",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._CAT_PRODUCTIVITY_ID]={category:128,text:_T("pkgmgr","class_productivity"),data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewList",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._CAT_DEVTOOLS_ID]={category:64,text:_T("pkgmgr","class_dev"),data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewList",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};b.SEC_CFG[b._COMMUNITY_CLASS]={text:_T("pkgmgr","class_community"),type:"3rd_server",data:[{index:0,layoutCfg:"SYNO.SDS.PkgManApp.ViewList",status:{}},{index:1,layoutCfg:"SYNO.SDS.PkgManApp.ViewDetail",status:{}}]};var a=function(e){var d=["installed","update","recommend"];return(-1==d.indexOf(e))?false:true};b.SEC_LIST=[];for(var c in b.SEC_CFG){if(b.SEC_CFG.hasOwnProperty(c)){if(SYNO.SDS.isNVR&&!a(c)){return}else{if(SYNO.SDS.isNVR&&c==="recommend"){b.SEC_CFG[c].text=_T("pkgmgr","class_all")}}b.SEC_CFG[c].id=c;b.SEC_LIST.push(c)}}}),getEllipsis:function(a,h,g,i,e){if(Ext.isEmpty(g)){return""}i=i||this;var c=i.ellipsisEl;if(!c){c=Ext.getBody().createChild();c.position("absolute");c.setLeftTop(-1000,-1000);c.setStyle("overflow","visible");c.setStyle("white-space","normal");c.setStyle("font-size","12px");c.setStyle("line-height","18px");c.setSize(a,"auto");i.ellipsisEl=c;if(i){i.on("destroy",function(){Ext.destroy(i.ellipsisEl);i.ellipsisEl=null},i,{single:true})}}var d=c.getWidth();if(a!=d){c.setWidth(a)}var b=e||g.length;c.update(g);var f=3;while(g.length>10&&c.getHeight()>h){b=b-f;g=g.substr(0,b)+"...";c.update(g)}return g},localizeMsg:function(e,a,f){var d,c,b;e=e.replace(/[\r\n]+/g,"");c=e.split(":");if(c.length<2){return e}d=c[0]+":"+c[1];b=this.getFirstDsmAppName(f);c[1]=SYNO.SDS.Utils.GetLocalizedString(d,b);if(a&&a!==""&&(!c[1]||c[1]===d)){return a}c.shift();return String.format.apply(String,c)},localizeArrMsg:function(f,b,c){var d=[];if(!Ext.isArray(f)){f=[f]}for(var a=0;a<f.length;a++){if(Ext.isString(f[a])){d.push(SYNO.SDS.Utils.GetLocalizedString(f[a],c))}else{d.push(f[a])}}var e=String.format.apply(String,d);if(b){return Ext.util.Format.stripTags(e)}else{return e}},localizeWorkerMsg:function(b){var c=function(g){var d=(Ext.isString(g.message))?g.message:"";var f=(Ext.isString(g.message_i18n))?g.message_i18n.split(":",3):[];var e=(Ext.isArray(g.args))?g.args:[];if(f.size()===2){e.unshift(_T(f[0],f[1]))}else{if(f.size()===3){e.unshift(_TT(f[0],f[1],f[2]))}else{return d}}return String.format.apply(String,e)||d};var a="";if(!Ext.isArray(b)){return""}Ext.each(b,function(d){var e=(Ext.isObject(d))?c(d):"";if(!e.empty()){a+=(a.empty())?e:"<br>"+e}});return a},getFirstDsmAppName:function(b){var a;if(Ext.isArray(b)){if(b.length>0){return b[0]}}else{if(Ext.isString(b)){a=b.split(" ");if(a.length>0){return a[0]}}else{return""}}},tsort:function(d){var c={},b=[],a={};var e=function(h){this.id=h;this.afters=[]};Ext.each(d,function(h){var j=h[0],i=h[1];if(!c[j]){c[j]=new e(j)}if(!c[i]){c[i]=new e(i)}c[j].afters.push(i)});var g=function(j,h){var i=c[j],k=i.id;if(a[j]){return}if(!Ext.isArray(h)){h=[]}h.push(k);a[j]=true;Ext.each(i.afters,function(l){if(h.indexOf(l)>=0){SYNO.Debug("cycle: "+l+" is in "+k);return}g(l.toString(),SYNO.Util.copy(h))});b.unshift(k)};for(var f in c){if(c.hasOwnProperty(f)){g(f,c[f])}}return b},getWebAPIErr:function(b,g,d,f,c){if(!b){if(g&&g.code<400){return SYNO.API.CheckResponse(b,g,d)}else{var a=g,e;if(g.code&&Ext.isObject(g.errors)){a=g.errors}switch(g.code){case 4500:case 4501:return c||_T("error","error_error_system");case 4502:return _T("pkgmgr","pkgmgr_space_not_ready");case 4503:return _T("error","volume_creating");case 4504:return _T("pkgmgr","error_sys_no_space");case 4505:return _T("error","no_external_devices");case 4520:return _T("error","error_space_not_enough");case 4521:return _T("pkgmgr","pkgmgr_file_not_package");case 4522:return _T("pkgmgr","broken_package");case 4523:return String.format(_T("pkgmgr","pkgmgr_pkg_required_newer_version"),a.firmware);case 4524:return String.format(_T("pkgmgr","conflict_packages"),a.packages);case 4525:break;case 4526:break;case 4527:return String.format(_T("pkgmgr","port_conflict"),a.port);case 4528:return String.format(_T("pkgmgr","pkgmgr_pkg_not_support_platform"),_D("product"));case 4529:return _T("pkgmgr","pkgmgr_pkg_cannot_upgrade");case 4530:return _T("pkgmgr","error_occupied");case 4536:return _T("pkgmgr","incompatible");case 4540:return _T("pkgmgr","pkgmgr_file_install_failed");case 4541:return _T("pkgmgr","upgrade_fail");case 4542:return _T("error","error_error_system");case 4543:return _T("pkgmgr","pkgmgr_file_not_package");case 4544:return _T("pkgmgr","pkgmgr_pkg_install_already");case 4545:return _T("pkgmgr","pkgmgr_pkg_not_available");case 4546:break;case 4547:case 4552:if(f){return String.format(_T("pkgmgr","error_upgrade_dep_packages_with_name"),a.packages,f)}return String.format(_T("pkgmgr","error_upgrade_dep_packages"),a.packages);case 4548:return _T("pkgmgr","install_version_less_than_limit");case 4549:return _T("pkgmgr","depend_cycle");case 4550:break;case 4551:break;case 4560:return _T("pkgmgr","pkgmgr_pkg_uninstall_failed");case 4561:break;case 4562:break;case 4580:return _T("pkgmgr","pkgmgr_pkg_start_failed");case 4581:return _T("pkgmgr","pkgmgr_pkg_stop_failed");case 4582:break;case 4583:break;case 4584:if(!Ext.isEmpty(a.unstart_packages)){return _T("pkgmgr","start_depend_unstart")+"<br>"+a.unstart_packages}break}if(!e){return c||_T("error","error_error_system")}}}},_initWinWrappers:function(a){this._getOwner=function(){if(this.owner){return this.owner}else{if(a&&a.owner){return(this.owner=a.owner)}}return(this.owner=SYNO.SDS.PkgManApp.Window)};Ext.each(["_getAbsoluteURL","_getEllipsis"],function(b){this[b]=function(){var c=SYNO.SDS.PkgManApp.Window;return c[b].apply(c,arguments)}},this);Ext.each(["_getCurId","_getHistoryInfo"],function(b){this[b]=function(){var c=SYNO.SDS.PkgManApp.Util;return c[b].apply(SYNO.SDS.PkgManApp.Window,arguments)}},this);Ext.iterate(SYNO.SDS.PkgManApp.Action,function(b,c){if(Ext.isFunction(c)){this[b]=function(){var d=SYNO.SDS.PkgManApp.Window;return c.apply(d,arguments)}}},this);Ext.iterate(SYNO.SDS.PkgManApp.ActionUtils,function(b,c){if(Ext.isFunction(c)){if(this instanceof SYNO.SDS.PkgManApp.UninstallWizardDialog||this instanceof SYNO.SDS.PkgManApp.WizardDialog){this[b]=c.createDelegate(this)}else{this[b]=function(){var d=SYNO.SDS.PkgManApp.Window;return c.apply(d,arguments)}}}},this)},_getCurId:function(){return SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr").getCurId()},_getHistoryInfo:function(){return SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr").getHistoryInfo()},_getEllipsis:function(a,h,g,i,e){if(Ext.isEmpty(g)){return""}i=i||this;var c=i.ellipsisEl;if(!c){c=Ext.getBody().createChild();c.position("absolute");c.setLeftTop(-1000,-1000);c.setStyle("overflow","visible");c.setStyle("white-space","normal");c.setStyle("font-size","11px");if(Ext.isChrome){c.setStyle("-webkit-text-size-adjust","none")}c.setSize(a,"auto");i.ellipsisEl=c;if(i){i.on("destroy",function(){Ext.destroy(i.ellipsisEl);i.ellipsisEl=null},i,{single:true})}}var d=c.getWidth();if(a!=d){c.setWidth(a)}var b=e||g.length;c.update(g);var f=13;while(g.length>10&&c.getHeight()>h){b=b-f;g=g.substr(0,b)+"...";c.update(g)}return g},encodedMsg:function(c,a){var b=c;if(!Ext.isDefined(c)){b=""}else{if(a){b=Ext.util.Format.stripTags(b)}}return Ext.util.Format.htmlEncode(b)},gotoScroll:function(a,b){if(a&&a.dom&&a.dom.fleXcroll){(function(){a.dom.fleXcroll.scrollToElement(b)}).defer(Ext.isIE?500:300)}},isOnlyInstStatus:function(a){if(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(a)){}else{if(!Ext.isEmpty(a.status)&&!a.blupgrade){return true}}return false},isBrokenStatus:function(b){if(Ext.isEmpty(b)){return false}var a=b;if(Ext.isObject(b)){a=b.status;if(Ext.isObject(b.additional)){a=b.status||b.additional.status}}return"broken"===a||"version_limit"===a||"non_support"===a||"builtin"===a||"non_support_dsm_version"===a},getBrokenStatus:function(b){if(Ext.isEmpty(b)){return false}var a=b;if(Ext.isObject(b)){a=b.status;if(Ext.isObject(b.additional)){a=b.status||b.additional.status}}return a},getBrokenStr:function(a){if("version_limit"===SYNO.SDS.PkgManApp.Utils.getBrokenStatus(a)){return _T("pkgmgr","pkgmgr_pkg_upgrade")}return _T("pkgmgr","repair")},isBuyable:function(a){return(a&&0!==a.type&&a.price&&0!==parseFloat(a.price))},getValue:function(b,a){if(!Ext.isObject(b)){return b||""}if(b.additional&&b.additional[a]){return b.additional[a]}return b[a]||""},setGlobalValue:function(){SYNO.SDS.PkgManApp.isRunningPkgForeground=true},cleanGlobalValue:function(){SYNO.SDS.PkgManApp.isRunningPkgForeground=undefined}});SYNO.SDS.PkgManApp.ModalWindow=Ext.extend(SYNO.SDS.ModalWindow,{_getAbsoluteURL:function(){return this._getOwner()._getAbsoluteURL.apply(this._getOwner(),arguments)},_getOwner:function(){if(this.owner){return this.owner}return(this.owner=SYNO.SDS.PkgManApp.Window)}});SYNO.SDS.PkgManApp.SearchField=Ext.extend(SYNO.ux.SearchField,{width:212,constructor:function(a){SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.SearchField",this);var b=this.fillConfig(a);SYNO.SDS.PkgManApp.SearchField.superclass.constructor.call(this,b)},fillConfig:function(a){var b={itemId:"global_search",enableKeyEvents:true,listeners:{scope:this,keypress:function(d,c){if(c.getKey()==Ext.EventObject.ENTER){this.blEnter=true;if(SYNO.SDS.PkgManApp.Utils._INSTALLED_ID!==this.getSearchFilter()){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SortButton").setAllFilter()}this.blReset=false;this.onActiveItem();this.blReset=undefined}}}};Ext.apply(b,a);return b},onTriggerClick:function(){if(!this.disabled){SYNO.SDS.PkgManApp.SearchField.superclass.onTriggerClick.apply(this,arguments);this.onTriggerAction(false)}},onTriggerAction:function(a){if(!this.disabled){if(false!==a&&false!==this.blReset&&this.getValue()){this.setValue("");this.filter()}var c=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var b=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ListPanel");if(b.getSelectedId()===this.getSearchFilter()&&!(c.getActiveItem() instanceof SYNO.SDS.PkgManApp.ViewDetail)){this.onActiveItem()}}},onActiveItem:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");a.onGotoPanel(this.getSearchFilter(),0)},getSearchText:function(){return this.getValue().trim()},getMenu:function(){if(this.menu){return this.menu}return(this.menu=new SYNO.ux.Menu({defaults:{group:"filter",scope:this},items:[{text:_T("pkgmgr","class_all"),checked:true,itemId:SYNO.SDS.PkgManApp.Utils._CAT_ALL_ID,checkHandler:this.setSearchFilter},{text:_T("pkgmgr","class_community"),checked:false,itemId:SYNO.SDS.PkgManApp.Utils._COMMUNITY_CLASS,checkHandler:this.setSearchFilter},{text:_T("pkgmgr","install_packages"),checked:false,itemId:SYNO.SDS.PkgManApp.Utils._INSTALLED_ID,checkHandler:this.setSearchFilter}],listeners:{scope:this,beforeshow:function(b){var a=b.items.get(SYNO.SDS.PkgManApp.Utils._COMMUNITY_CLASS);if(!SYNO.SDS.PkgManApp.Config.blOtherServer&&a.checked){b.items.get(SYNO.SDS.PkgManApp.Utils._CAT_ALL_ID).setChecked(true)}a.setVisible(SYNO.SDS.PkgManApp.Config.blOtherServer)}}}))},setSearchFilter:function(b){var a=b.itemId;if(a===this.gSearchFilter){return}this.gSearchFilter=a},getSearchFilter:function(){return this.gSearchFilter||SYNO.SDS.PkgManApp.Utils._CAT_ALL_ID}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.ListPanel=Ext.extend(SYNO.ux.ModuleList,{constructor:function(a){SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.ListPanel",this);SYNO.SDS.PkgManApp.Utils._initWinWrappers.call(this,a);var b=this.fillConfig(Ext.apply({selModel:new Ext.tree.DefaultSelectionModel({onNodeClick:function(c,d){this.select(c);if(c==this.selNode){this.fireEvent("selectionchange",this,c)}},listeners:{selectionchange:{fn:function(d,c){d.tree.onModuleListSelect(d,c)}}}})},a));SYNO.SDS.PkgManApp.ListPanel.superclass.constructor.call(this,b);this.mon(this,"afterrender",function(){var e=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView");for(var d in e.stores){if(e.stores.hasOwnProperty(d)){var c=e.stores[d];e.mon(c,"add",this.onUpdateNum,this,{buffer:500});e.mon(c,"load",this.onUpdateNum,this,{buffer:500});e.mon(c,"clear",this.onUpdateNum,this,{buffer:500});e.mon(c,"remove",this.onUpdateNum,this,{buffer:500});e.mon(c,"update",this.onUpdateNum,this,{buffer:500});e.mon(c,"datachanged",this.onUpdateNum,this,{buffer:500})}}},this,{single:true})},fillConfig:function(a){var b={cls:"syno-pkg-list",listItems:this.configSelectItems(),tbar:{height:28,hidden:SYNO.SDS.isNVR?true:false,items:[this.getSearchField()]},baseAttrs:{getTpl:this.getTpl.createDelegate(this)},listeners:{afterrender:{single:true,scope:this,buffer:80,fn:function(){if(!this.getSelectedId()){this.selectFirstItem()}}}}};Ext.apply(b,a);return b},getSearchField:function(){return this.searchfield?this.searchfield:(this.searchfield=new SYNO.SDS.PkgManApp.SearchField())},configSelectItems:function(){var a=[],c=[];var b=0;Ext.each(SYNO.SDS.PkgManApp.Utils.SEC_LIST,function(e){var d=SYNO.SDS.PkgManApp.Utils.SEC_CFG;if(b>1){c.push(d[e])}else{a.push(d[e])}b++},this);a.push({id:"explore",type:"split",text:_T("pkgmgr","explore_title"),expandable:false,disabled:true,items:c});return a},onModuleListSelect:function(a,b){if(!b.leaf){return}this.onListSelect(b.attributes)},onListSelect:function(a){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SearchField").onTriggerAction();this.onSwitchPanel(a)},onSwitchPanel:function(b){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");if(0!==a.getCurIndex()&&b.id===a.getCurId()){a.onGotoBack()}else{a.onGotoPanel(b.id)}},getTpl:function(e,g,c,f,b){var d=new Ext.XTemplate('<li class="x-tree-node"><div ext:tree-node-id="'+g.id+'" class="x-tree-node-el x-tree-node-leaf x-unselectable {[this.getCls(values)]}" unselectable="on"><span class="x-tree-node-indent">',e.indentMarkup,'</span><img alt="" src="'+e.emptyIcon+'" class="x-tree-ec-icon x-tree-elbow" /><img alt="" src="'+(c.icon||e.emptyIcon||"")+'" class="x-tree-node-icon '+(c.icon?" x-tree-node-inline-icon":"")+("{[this.getIconCls(values)]}")+'" unselectable="on" />'+(Ext.isBoolean(c.checked)?('<input class="x-tree-node-cb" type="checkbox" '+(c.checked?'checked="checked" />':"/>")):"")+'<a hidefocus="on" class="x-tree-node-anchor" href="'+(Ext.isGecko?"":"#")+'" tabIndex="1" ><span unselectable="on">'+g.text+'</span></a></div><ul class="x-tree-node-ct" style="display:none;"></ul></li>',{compiled:true,disableFormats:true,getCls:this.getCls.createDelegate(this),getIconCls:this.getIconCls.createDelegate(this)});return d.apply(c)},getCls:function(a){if(a.type==="split"){return String.format("syno-pkg-list-type-{0}",a.type)}return String.format("syno-pkg-list-item syno-pkg-list-{0}",a.id)},getIconCls:function(a){if(a.type==="split"){return""}switch(a.id){case"installed":return"icon-installed";case"update":return"icon-update-and-reset";case"all":return"icon-dsm-apps";case"backup":return"icon-backup";case"multimedia":return"icon-media-library";case"bussiness":return"icon-business";case"security":return"icon-security";case"utilities":return"icon-utilities";case"devtools":return"icon-dev-tool";case"productivity":return"icon-productivity";case"community":return"icon-community";case"recommend":return SYNO.SDS.isNVR?"icon-dsm-apps":"icon-recommend"}return""},getFirstItem:function(){var b=null;if(this.activeItem){b=this.getNodeById(this.activeItem)}else{var a=this.getRootNode();if(a&&a.childNodes&&a.childNodes[0]){return a.childNodes[0]}}return b},selectFirstItem:function(){var a=this.getFirstItem();if(a){this.getSelectionModel().select(a)}},selectItemById:function(b){var a=this.getNodeById(b);if(a){this.getSelectionModel().select(a)}},getSelectedId:function(){var a=this.getSelectionModel().getSelectedNode();if(a){return a.id}else{return""}},checkOtherSever:function(){var a=this.getNodeById("community");if(a){var b=SYNO.SDS.PkgManApp.Config.blOtherServer;if(b){a.getUI().show()}else{a.getUI().hide()}if(a===this.getSelectionModel().getSelectedNode()&&!b){this.selectFirstItem()}this.updateScrollbar(this.body.dom)}},onUpdateNum:function(){var g=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView");var c=0,a=function(h){if(h.data.blupgrade){c++}};for(var d in g.stores){if(g.stores.hasOwnProperty(d)){var b=g.stores[d];var f=b.snapshot||b.data;f.each(a)}}var e=this.getNodeById("update");if(e&&e.attributes.number!==c){e.attributes.number=c;if(0===c){this.clearNotification("update")}else{this.setNotification("update",c)}}}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.ViewDetail=Ext.extend(Ext.Container,{constructor:function(a){SYNO.SDS.PkgManApp.Utils._initWinWrappers.call(this,a);var b=this.fillConfig(a);SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.ViewDetail",this);SYNO.SDS.PkgManApp.ViewDetail.superclass.constructor.call(this,b)},fillConfig:function(a){var c=this;var b={cls:"syno-pkg-detail-panel",layout:"border",border:false,items:[{applyLayout:function(d){if(d.height<=0){d.height=1}if(d.width<=0){d.width=1}if(this.isCollapsed){this.applyLayoutCollapsed(d)}else{this.panel.setPosition(d.x,d.y);this.panel.setSize(d.width,d.height)}},itemId:"center",region:"center",xtype:"container",border:false,layout:{type:"column"},listeners:{scope:this,buffer:300,afterrender:function(d){this.updateScrollbar()},resize:function(d){this.updateScrollbar()}},items:[{item:"cetner",width:160,xtype:"container",style:"margin-right:16px;margin-top:20px",border:false,layout:"auto",items:[this.imageContainer=new Ext.Container({xtype:"container",cls:"syno-pkg-meta-icon",border:false,height:124,html:""}),this.btnContainer=new Ext.Container({xtype:"container",defaults:{xtype:"syno_button",style:"margin-bottom:4px;",width:160},items:[{itemId:"install",text:_T("pkgmgr","pkgmgr_pkg_install"),hidden:true,handler:this.onAction,scope:this},{itemId:"buy",text:_T("pkgmgr","myds_pay_buy"),hidden:true,handler:this.onAction,scope:this},{itemId:"try",text:_T("pkgmgr","myds_pay_trail"),hidden:true,handler:this.onAction,scope:this},{btnStyle:"green",itemId:"upgrade",text:_T("pkgmgr","pkgmgr_pkg_upgrade"),hidden:true,handler:this.onAction,scope:this},{btnStyle:"orange",itemId:"repair",text:_T("pkgmgr","repair"),hidden:true,handler:this.onAction,scope:this},{btnStyle:"orange",itemId:"repair_version",text:_T("pkgmgr","pkgmgr_pkg_upgrade"),hidden:true,handler:this.onAction,scope:this},{btnStyle:"grey",itemId:"installing",text:_T("pkgmgr","installing"),disabled:true,hidden:true},{btnStyle:"grey",itemId:"upgrading",text:_T("pkgmgr","upgrading"),disabled:true,hidden:true},{btnStyle:"grey",itemId:"starting",text:_T("pkgmgr","starting"),disabled:true,hidden:true},{btnStyle:"grey",itemId:"stopping",text:_T("pkgmgr","stopping"),disabled:true,hidden:true},{itemId:"cancel",text:_T("common","cancel"),hidden:true,handler:this.onAction,scope:this},{btnStyle:"grey",itemId:"waiting",text:_T("vpnc","waiting"),disabled:true,hidden:true}]}),this.actionStatus=new Ext.Container({style:"margin: 3px auto 3px auto;",cls:"syno-pkg-status",html:""}),this.actionBtn=new SYNO.ux.Button({style:"margin-bottom:2px;",width:160,itemId:"action",hidden:true,text:_T("common","action"),menu:{width:160,items:[{itemId:"start",text:_T("pkgmgr","pkgmgr_pkg_start"),handler:function(){var e=this._getInstalledStore().getById(this.pkgname);if(e){this._onStartPkg(e)}else{var d=SYNO.SDS.PkgManApp.Window;d.mon(d.pollingTask,"callback",function(){var f=this._getInstalledStore().getById(this.pkgname);if(f){this._onStartPkg(f)}},this,{single:true});d.fireEvent("pollinginstpage")}},scope:this},{itemId:"stop",text:_T("pkgmgr","pkgmgr_pkg_stop"),handler:function(){var e=this._getInstalledStore().getById(this.pkgname);if(e){this._onStopPkg(e)}else{var d=SYNO.SDS.PkgManApp.Window;d.mon(d.pollingTask,"callback",function(){var f=this._getInstalledStore().getById(this.pkgname);if(f){this._onStopPkg(f)}},this,{single:true});d.fireEvent("pollinginstpage")}},scope:this},{itemId:"uninstall",text:_T("pkgmgr","pkgmgr_pkg_uninstall"),handler:function(){var d=(function(g){this._onUninstallPkg(g,(function(){var h=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var i=SYNO.SDS.PkgManApp.Utils;if(i._INSTALLED_ID===h.getCurId()||i._UPDATE_ID===h.getCurId()){h.onGotoBack()}}).createDelegate(this))}).createDelegate(this);var f=this._getInstalledStore().getById(this.pkgname);if(f){d(f)}else{var e=SYNO.SDS.PkgManApp.Window;e.mon(e.pollingTask,"callback",function(){var g=this._getInstalledStore().getById(this.pkgname);if(g){d(g)}},this,{single:true});e.fireEvent("pollinginstpage")}},scope:this}]}}),{xtype:"form",border:false,items:[this.checkAuto=new SYNO.ux.Checkbox({name:"autoupdate",boxLabel:_T("pkgmgr","auto_update_one"),listeners:{buffer:1000,scope:this,check:function(e,d){if(!e.isDirty()){return}this.sendWebAPI({single:true,api:"SYNO.Core.Package.Setting.Update",method:d?"add":"delete",version:1,params:{id:this.pkgname},scope:this});e.originalValue=d;var f=this._getInstalledStore().getById(this.pkgname);f.data.autoupdate=d}}})]},this.detailform=new Ext.form.FormPanel({cls:"syno-pkg-form-detail",border:false,xtype:"form",style:"margin: 2px 0 14px 0;border:solid 1px #C8D2DC;",padding:14,defaults:{xtype:"displayfield",htmlEncode:true,labelSeparator:""},labelSeparator:"",labelAlign:"top",items:[{cls:"syno-pkg-pay-type",name:"price",fieldLabel:_T("pkgmgr","myds_pay_price"),setRawValue:function(d){if(!Ext.isEmpty(d)&&d!==0){d="USD&nbsp;$"+d}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}},{name:"status",fieldLabel:_T("pkgmgr","pkgmgr_pkg_status"),setRawValue:function(d){var e=c.renderStatus(d,c.data);if(this.rendered){d=(Ext.isEmpty(d)?"":d);this.el.dom.innerHTML=e;return d}return(this.value=d)}},{name:"maintainer",fieldLabel:_T("pkgmgr","pkgmgr_pkg_maintainer"),setRawValue:function(d){if(d&&c.data&&!Ext.isEmpty(c.data.maintainer_url)){d=c.renderURL(c.data.maintainer_url,d)}else{d=Ext.util.Format.htmlEncode(d)}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}},{name:"distributor",fieldLabel:_T("pkgmgr","pkgmgr_pkg_distributor"),setRawValue:function(d){if(d&&c.data&&!Ext.isEmpty(c.data.distributor_url)){d=c.renderURL(c.data.distributor_url,d)}else{d=Ext.util.Format.htmlEncode(d)}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}},{name:"version",fieldLabel:_T("pkgmgr","pkgmgr_pkg_version")},{name:"pkgtarget",fieldLabel:_T("pkgmgr","pkgmgr_pkg_install_volume")},{name:"download_count",fieldLabel:_T("pkgmgr","download_count"),setRawValue:function(d){d=c.convertDownloadCountToStr(d);return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}},{name:"pkgadminporturl",cls:"syno-pkg-info-url",fieldLabel:_T("pkgmgr","pkgmgr_pkg_adminurl"),setRawValue:function(d){return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}},{name:"log",htmlEncode:false,fieldLabel:_T("pkgmgr","log_title"),value:String.format("<a>{0}</a>",_T("pkgmgr","log_btn")),listeners:{render:function(d){c._getOwner().mon(this.el,"click",function(){this._showLog(c.pkgname)},c._getOwner())},single:true,buffer:80}},{xtype:"container",html:""}]}),this.surpportform=new Ext.form.FormPanel({style:"margin: 14px 25px;",border:false,autoHeight:true,hideLabels:true,defaults:{xtype:"displayfield"},items:[{overCls:"x-item-over",cls:"syno-pkg-report-field",name:"support_url",setRawValue:function(d){d='<table width="100%" height="100%" cellspacing="0" class="x-table-layout"><tbody><tr><td class="x-table-layout-cell" style="width:20px;"><div class="syno-pkg-report-icon"></div></td><td class="x-table-layout-cell">'+c.renderURL(d,_T("pkgmgr","support"))+"</td></tr></tbody></table>";return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}},{overCls:"x-item-over",cls:"syno-pkg-help-field",name:"pkghelpurl",setRawValue:function(d){d='<div class="syno-pkg-help-icon"></div>'+c.renderURL(d,_T("pkgmgr","pgk_help_title"));return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}}]})]},this.screenform=new Ext.form.FormPanel({cls:"syno-pkg-detail-panel-right",columnWidth:1,border:false,autoHeight:true,hideLabels:true,defaults:{xtype:"displayfield",htmlEncode:true},style:"margin-right:18px;",margins:{left:18,right:18},items:[{name:"dname",style:"font-weight:bold;font-size:15px;color:#0086e5;height:20px;text-align:center;padding-bottom:5px;overflow:visible;margin-top:3px;",setRawValue:function(d){if(this.htmlEncode){d=Ext.util.Format.htmlEncode(d)}if(d&&c.data&&c.data.beta){d=d+'<span class="syno-pkg-beta">&nbsp;'+_T("pkgmgr","beta")+"</span>"}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}},this.screenContainer=new Ext.Container({xtype:"container",width:"100%",layoutConfig:{type:"vbox",align:"stretch",pack:"start"},border:false,defaults:{width:"100%"},items:[{activeItem:0,flex:1,itemId:"screen-ct",height:360,border:false,layout:"card",items:[{itemId:0,xtype:"container",html:this.onSetLoading(),listeners:{scope:this,single:true,render:function(d){this.mon(d.el,"click",function(h){var g=h.getTarget();if(!g){return}var f=Ext.get(g);if(!f){return}if(f.is("img.syno-pkg-screen-img")){this.onClickSreenShot(0)}},this)}}},{itemId:1,xtype:"container",html:this.onSetLoading(),listeners:{scope:this,single:true,render:function(d){this.mon(d.el,"click",function(h){var g=h.getTarget();if(!g){return}var f=Ext.get(g);if(!f){return}if(f.is("img.syno-pkg-screen-img")){this.onClickSreenShot(1)}},this)}}},{itemId:2,xtype:"container",html:this.onSetLoading(),listeners:{scope:this,single:true,render:function(d){this.mon(d.el,"click",function(h){var g=h.getTarget();if(!g){return}var f=Ext.get(g);if(!f){return}if(f.is("img.syno-pkg-screen-img")){this.onClickSreenShot(2)}},this)}}},{itemId:3,xtype:"container",html:this.onSetLoading(),listeners:{scope:this,single:true,render:function(d){this.mon(d.el,"click",function(h){var g=h.getTarget();if(!g){return}var f=Ext.get(g);if(!f){return}if(f.is("img.syno-pkg-screen-img")){this.onClickSreenShot(3)}},this)}}}]},{itemId:"screen-btn-ct",height:32,width:"100%",cls:"syno-pkg-screen-btn-ct",border:false,layout:"table",layoutConfig:{columns:4},defaults:{height:32},items:[{xtype:"button",itemId:0,cls:"syno-pkg-screen-btn",template:new Ext.Template('<em class="{2}" unselectable="on"><button style="background-color:transparent;border-width:0;margin:0;" type="{0}"></button></em>'),scope:this,handler:this.onChangeScreeShotPanel,listeners:{scope:this,mouseover:this.onChangeScreeShotPanel}},{xtype:"button",itemId:1,cls:"syno-pkg-screen-btn",template:new Ext.Template('<em class="{2}" unselectable="on"><button style="background-color:transparent;border-width:0;margin:0;" type="{0}"></button></em>'),scope:this,handler:this.onChangeScreeShotPanel,listeners:{scope:this,mouseover:this.onChangeScreeShotPanel}},{xtype:"button",itemId:2,cls:"syno-pkg-screen-btn",template:new Ext.Template('<em class="{2}" unselectable="on"><button style="background-color:transparent;border-width:0;margin:0;" type="{0}"></button></em>'),scope:this,handler:this.onChangeScreeShotPanel,listeners:{scope:this,mouseover:this.onChangeScreeShotPanel}},{xtype:"button",itemId:3,cls:"syno-pkg-screen-btn",template:new Ext.Template('<em class="{2}" unselectable="on"><button style="background-color:transparent;border-width:0;margin:0;" type="{0}"></button></em>'),scope:this,handler:this.onChangeScreeShotPanel,listeners:{scope:this,mouseover:this.onChangeScreeShotPanel}}]},{height:6,width:"100%",style:"margin-bottom:10px;overflow:hidden;height:9px;width: 100%;",xtype:"container",html:'<div style="width:100%;height:1px;box-shadow: 0px 1px 6px rgba(0,0,0,0.25);-moz-box-shadow: 0px 1px 6px rgba(0,0,0,0.25);-webkit-box-shadow: 0px 1px 6px rgba(0,0,0,0.25);"></div>'}]}),{name:"changelog",cls:"syno-pkg-info-changelog",setRawValue:function(d){var e=c._getUpgradeRec(c.pkgname);if(e){d=e.get("changelog");var f=e?e.get("version"):c.data.version;d="<b>"+String.format(_T("pkgmgr","pkgmgr_pkg_changelog"),f||"")+" : </b>\n"+d;d=d.replace(/\n/g,"<br />");this.show()}else{d="";this.hide()}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}},{name:"desc",cls:"syno-pkg-info-desc",setRawValue:function(d){if(this.htmlEncode){d=Ext.util.Format.htmlEncode(d)}if(d){d="<b>"+_T("pkgmgr","pkgmgr_pkg_description")+" : </b>\n"+d;d=d.replace(/\n/g,"<br />")+"<br />&nbsp;"}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}}]})]}],listeners:{scope:this,activate:this.onActivate,deactivate:this.onDeactivate}};Ext.apply(b,a);return b},updateScrollbar:function(a){if(this.isDestroyed){return}var c=this.get("center").el.dom;var b=this;if(b.isVisible()){if(c&&c.fleXcroll){if(a){this.doLayout();c.fleXcroll.setScrollPos(false,0)}c.fleXcroll.updateScrollBars();if(!a){c.fleXcroll.setScrollPos(0,0,true)}}else{if(c){fleXenv.fleXcrollMain(c)}}}},onActivate:function(){this.onLoadData()},onDeactivate:function(){if(this.pollingStatus){this.pollingStatus.remove()}this.getImageLoader().stop();if(this.getReqId){Ext.Ajax.abort(this.getReqId);this.getReqId=null}},setFieldValues:function(b,a){b=b.getForm();b.items.each(function(d){var c=a[d.name];if(Ext.isEmpty(c)||(Ext.isNumber(c)&&c===0)){d.hide()}else{d.show()}});b.setValues(a)},convertDownloadCountToStr:function(c){var b="0",a;if(!Ext.isNumber(c)||c===0){return b}if(c<1000){return c}a=Math.floor(c/1000);b="000+";while(a>1000){b=String.leftPad((a%1000).toString(),3,"0")+","+b;a=Math.floor(a/1000)}b=a.toString()+","+b;return b},renderStatus:function(c,e){if(e){var b=this._isUpgradable(e.id);var g=false,d;var a=this._isRepairable(e);if(a||b){d=this._getAvalRec(e.id);if(d){g=(0<d.data.progress&&1>d.data.progress);if(g||(this._IsInstalling(d.data))){if("version_limit"===SYNO.SDS.PkgManApp.Utils.getBrokenStatus(c)){c="upgrading"}else{c=a?"repairing":"upgrading"}}}}}var f='<font style="color:';switch(c){case"stop":f+='#666666;">'+_T("pkgmgr","pkgmgr_pkg_stopped");break;case"running":f+='#78c52d;">'+_T("pkgmgr","pkgmgr_pkg_running");break;case"installing":f+='#78c52d;">'+_T("pkgmgr","installing");break;case"upgrading":f+='#78c52d;">'+_T("pkgmgr","upgrading");break;case"repairing":f+='#78c52d;">'+_T("pkgmgr","repairing");break;case"uninstalling":f+='#78c52d;">'+_T("background_task","task_processing")+"...";break;case"starting":f+='#78c52d;">'+_T("pkgmgr","starting");break;case"stopping":f+='#78c52d;">'+_T("pkgmgr","stopping");break;default:if(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(c)){if("version_limit"===SYNO.SDS.PkgManApp.Utils.getBrokenStatus(c)){f+='#f4982d;">'+_T("pkgmgr","status_version_limit")}else{f+='#EB5F5F;">'+_T("pkgmgr","pkgmgr_pkg_broken")}}else{f+='#EB5F5F;">'+_T("status","status_not_available")}break}return(f+"</font>")},renderURL:function(a,b){return String.format('<a target="_blank" href="{0}">{1}</a>',a,b||Ext.util.Format.htmlEncode(a))},getActionStatus:function(f){var h=this._isQuickInstll(f);var b=this._isUpgradable(f.id);var k=false;var d=b?"upgrade":"install";if(h&&-1!==this._getInstallAll_Background().indexOf(f.id)){d="waiting"}var e="";if(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(f)){d="broken"}else{if(!Ext.isEmpty(f.status)&&!b){d="installed"}}var i=this._GetProcessStatus(f.status);if(i.blProcessing){d=f.status}else{if(this._IsInstalling(f)){d=b?"upgrading":"installing"}}if(Ext.isDefined(f.progress)&&f.progress){if(f.progress==1){}else{if(f.progress>0){if(!(this._IsInstalling(f))){d=b?"upgradedcancel":"installedcancel"}if(0.00001>=f.progress){e=_T("vpnc","waiting")}else{e=Math.floor(f.progress*100)+"%&nbsp;";if(this._IsInstalling(f)){if(i.blProcessing){e+=i.msg}else{e+=b?_T("pkgmgr","upgrading"):_T("pkgmgr","installing")}}else{e+=_T("download","download_task_downloading")}}}else{if(f.progress<0){k=true;d=b?"upgrade":"install";e=b?_T("pkgmgr","upgrade_pkg_fail"):_T("pkgmgr","install_pkg_fail");e=String.format(e,f.dname,"")}}}}var a,c,g;if(f.info&&f.progress<0){c=f.info;k=true;e=this._IsInstalling(f)?_T("pkgmgr","install_pkg_fail"):_T("pkgmgr","download_pkg_fail");e=String.format(e,f.dname,"");g=f.dname+":&nbsp;";if(c.sec&&c.key){e=g+_T(c.sec,c.key)+"&nbsp;"}else{if(c.errmsg){a=this._onCheckPKGFailMsg(f.dname,c);e+=a.msg}}if(c.message&&""!==c.message){e+=SYNO.SDS.PkgManApp.Utils.localizeMsg(c.message,c.message)}}var j=e;if(!k&&!Ext.isEmpty(e)){j="<div><font style='color:#78c52d;' ext:qtip='"+e+"'>";j+="&nbsp;";j+=e;j+="</font></div>"}return{actionstatus:d,statustext:j,callback:a?a.callback:undefined}},onUpdateStatus:function(){if(!this.pollingStatus||this.pollingStatus.removed){this.pollingStatus=this.addTask({interval:500,run:function(){this.onUpdateStatusCallBack()},scope:this})}this.pollingStatus.restart(true)},getIcon:function(c){var b=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var d=SYNO.SDS.PkgManApp.Utils;var a;if(d._INSTALLED_ID===b.getCurId()||d._UPDATE_ID===b.getCurId()){a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView").getIcon(c,128,true)}else{a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView").getIcon(c,128,true)}return String.format("<div>{0}</div>",a)},onAction:function(a){var b=this.pkgname;var c=this._getSynoServerObj().store.getById(b)||this._getOtherServerObj().store.getById(b);this._onClickSynoPkgActionBtn(c)},getPkgData:function(){var d=this.pkgname;var c=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr"),a,f;var e=SYNO.SDS.PkgManApp.Utils;a=this._getInstalledStore().getById(d);f=this._getSynoServerObj().store.getById(d)||this._getOtherServerObj().store.getById(d);var b={};if(e._INSTALLED_ID===c.getCurId()||e._UPDATE_ID===c.getCurId()){if(!a){c.onGotoBack();return false}if(f){Ext.apply(b,f.data)}Ext.apply(b,a.data)}else{if(!f){c.onGotoBack();return false}if(a){Ext.apply(b,a.data)}Ext.apply(b,f.data);if(a&&a.data.pkgstatus){b.pkgstatus=a.data.pkgstatus}}if(!a&&!f){return false}return b},isCommunityPage:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var b=SYNO.SDS.PkgManApp.Utils,c=a.getCurId();return(b._CAT_COMMUNITY_ID===c)},onUpdateStatusCallBack:function(){var g=this.get("center").getHeight();var d,m,a="";if(false===(d=this.getPkgData())){return}this.setFieldValues(this.detailform,d);this.setFieldValues(this.screenform,d);if(d.pkgtarget){m=d.pkgtarget;a=(Ext.isEmpty(m.path)?"":m.path);if(m.is_brick){a=_T("pkgmgr","brick")}else{if(a){if(a.substr(0,20)==="/usr/local/packages/"){a=_T("pkgmgr","system_volume")}else{a=a.substr(1,a.indexOf("/",1)-1)}}}}this.detailform.getForm().setValues({pkgtarget:a});var b=this.detailform.getForm().findField("log");if(!Ext.isEmpty(d.status)){b.show()}else{b.hide()}var f=this.actionBtn.menu.items;var j=false;f.get("stop").hide();f.get("start").hide();this.actionBtn.enable();if(((false!==d.qinst)&&-1!==this._getInstallAll_Background().indexOf(d.id))||j||(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(d))){this.actionBtn.disable()}else{if(false===d.pkgstartable){f.get("stop").hide();if("stop"===d.status){f.get("start").show()}}else{if("running"===d.status){f.get("stop").show()}else{if("stop"===d.status){f.get("start").show()}else{f.get("stop").hide();f.get("start").hide()}}}}var e=this.getActionStatus(d);var l=this.btnContainer;for(var c=0;c<this.btnContainer.items.length;c++){l.items.items[c].hide()}this.actionStatus.hide();this.actionBtn.enable();this.actionBtn.hide();switch(e.actionstatus){case"installed":case"upgraded":this.actionBtn.show();break;case"upgrading":this.actionBtn.show();this.actionBtn.disable();l.get("upgrading").show();break;case"starting":this.actionBtn.show();this.actionBtn.disable();l.get("starting").show();break;case"stopping":this.actionBtn.show();this.actionBtn.disable();l.get("stopping").show();break;case"installing":l.get("installing").show();break;case"upgradedcancel":this.actionBtn.show();this.actionBtn.disable();l.get("cancel").show();break;case"installedcancel":l.get("cancel").show();break;case"waiting":l.get("waiting").show();break;case"broken":l.get("repair").hide();l.get("repair_version").hide();if(this._isRepairable(d)){if("version_limit"===SYNO.SDS.PkgManApp.Utils.getBrokenStatus(d)){l.get("repair_version").show()}else{l.get("repair").show()}}this.actionBtn.show();break;case"upgrade":this.actionBtn.show();l.get("upgrade").show();break;case"install":var h=SYNO.SDS.PkgManApp.Utils.isBuyable(d)&&!this.isCommunityPage();if(!this.isCommunityPage()&&d&&0!==d.type&&(Ext.isEmpty(d.status)&&!(d.price&&0!==parseFloat(d.price)))){l.get("try").show()}else{if(h){l.get("buy").show()}else{l.get("install").show()}}break;default:break}if(!Ext.isEmpty(e.statustext)){this.actionStatus.show();this.actionStatus.getEl().dom.innerHTML=e.statustext}else{this.actionStatus.getEl().dom.innerHTML="";this.actionStatus.hide()}if(_S("demo_mode")){this.actionBtn.disable()}if(this.actionBtn.menu.isVisible()){this.actionBtn.menu.doLayout()}var k=this.get("center").getHeight();if(k!==g){this.doLayout();this.updateScrollbar.defer(300,this)}},onLoadData:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var b=a.getHistoryInfo();this.pkgname=b.data.id;this.data=this.getPkgData()||{};this.onSetScreenShotPanel();this.setFieldValues(this.surpportform,this.data);this.imageContainer.el.dom.innerHTML=this.getIcon(this.data);this.onUpdateStatus();var c=this._getInstalledStore().getById(this.pkgname);if(c&&this.data.silent_upgrade){this.checkAuto.show();this.checkAuto.setValue(this.data.autoupdate);this.checkAuto.originalValue=this.data.autoupdate||false;this.getReqId=this.sendWebAPI({api:"SYNO.Core.Package",method:"get",version:1,params:{id:this.pkgname,additional:["autoupdate"]},scope:this,callback:function(h,g,f,e){if(this.isDestroyed){return}this.getReqId=null;if(h&&g&&g.additional){var d=g.additional.autoupdate;if(this.data.autoupdate!==d&&this.data.autoupdate===this.checkAuto.getValue()){this.checkAuto.setValue(d);this.checkAuto.originalValue=d}}}})}else{this.checkAuto.hide()}this.updateScrollbar.defer(300,this,[true])},onSetScreenShotPanel:function(){var a=this.data.snapshot||[];var c={},g=[];var j=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var h=SYNO.SDS.PkgManApp.Utils,b=j.getCurId(),d;if(h._INSTALLED_ID===b||h._UPDATE_ID===b||h._CAT_COMMUNITY_ID===b){if(this.pkgname){c=this._getSynoServerObj().store.getById(this.pkgname)||this._getOtherServerObj().store.getById(this.pkgname);if(!c){this.screenContainer.hide();return}g=c.data.snapshot||[];a=[];for(d=0;d<g.length;d++){a.push(g[d].replace(encodeURI(c.data.version),encodeURI(this.data.version)))}}}if(Ext.isEmpty(a)){this.screenContainer.hide();return}var f=this.screenContainer.get("screen-ct");f.layout.setActiveItem(0);this.screenContainer.show();var e=this.screenContainer.get("screen-btn-ct");e.items.each(function(k,i){if(Ext.isEmpty(a[i])){k.hide()}else{k.show();this.onSetSreenShot(i,this.data,a[i],g[i])}k.removeClass("syno-pkg-screen-btn-active")},this);e.items.items[0].addClass("syno-pkg-screen-btn-active")},onClickSreenShot:function(a){var c=this.screenContainer.get("screen-btn-ct");var b=a+1;for(;b<c.items.items.length;b++){if(c.items.items[b].isVisible()){this.onChangeScreeShotPanel(c.items.items[b]);return}}this.onChangeScreeShotPanel(c.items.items[0])},onChangeScreeShotPanel:function(a){var c=this.screenContainer.get("screen-btn-ct");var b=this.screenContainer.get("screen-ct");var d;c.items.each(function(f,e){if(e===a.itemId){f.addClass("syno-pkg-screen-btn-active")}else{f.removeClass("syno-pkg-screen-btn-active")}d=b.get(e).el;if(d&&d.hasClass("syno-pkg-screen-img-ct")){d.removeClass("syno-pkg-screen-display")}});b.layout.setActiveItem(a.itemId);d=b.get(a.itemId).el;if(d&&d.hasClass("syno-pkg-screen-img-ct")){d.addClass("syno-pkg-screen-display")}},onSetSreenShot:function(d,g,c,a){var b=this.getScreenShot(d,g,c,a);var h=false;var e=this.screenContainer.get("screen-ct");var f=e.get(d).el;this.getImageLoader().load(b,{load:(function(i){h=true;if(f&&f.dom){(function(){var j=(i.height||354)+6;j=(j>366)?366:j;f.addClass(["syno-pkg-screen-img-ct","syno-pkg-screen-display"]);e.setHeight(j);f.setHeight(j);f.dom.innerHTML=String.format('<div style="width: 600px;height: {0}px;text-align: center;margin: auto;vertical-align: middle;"><img class="syno-pkg-screen-img" src={1} /></div>',j,b)}).defer(30)}}).createDelegate(this),error:(function(){if(f&&f.dom){Ext.destroy(f.dom.children[0]);f.dom.innerHTML=""}}).createDelegate(this)});if(!h){f.dom.innerHTML=this.onSetLoading()}},getScreenShot:function(c,d,b,a){var f=SYNO.API.currentManager.getBaseURL(a?"SYNO.Core.Package.Screenshot":"SYNO.Core.Package.Screenshot.Server","get",1);var e=Ext.urlAppend(f,Ext.urlEncode(SYNO.API.EncodeParams({name:d.id,ver:d.version,link:b,index:c})));if(a){e=Ext.urlAppend(e,Ext.urlEncode(SYNO.API.EncodeParams({newlink:a})))}return e},onSetLoading:function(a){return"<div style='display:table;height:360px;width:100%;text-align:center;'><div class='syno-pkg-screen-loading' style='display:table-cell;vertical-align:middle;'><table cellspacing=\"0\" style=\"width: auto;margin: auto;\"><tbody><tr><td><div class=\"syno-pkg-screen-loading-icon\"></div></td><td>&nbsp;"+_T("common","loading")+"</td></tr></tbody></table></div></div>"},onSetMsg:function(a){return"<div style='display:table;height:360px;width:100%;text-align:center;'><div class='syno-pkg-screen-loading' style='display:table-cell;vertical-align:middle;'>"+a||"</div></div>"},getImageLoader:function(){return this.imageload||(this.imageload=new SYNO.SDS.Utils.ImageLoad())}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.BasicDataView=Ext.extend(SYNO.SDS.Utils.DataView.LazyDataView,{delay:0,constructor:function(a){this.init();var b=this.fillConfig(a);SYNO.SDS.PkgManApp.BasicDataView.superclass.constructor.call(this,b)},init:function(){SYNO.SDS.PkgManApp.Utils._initWinWrappers.apply(this,arguments)},afterRender:function(){SYNO.SDS.PkgManApp.BasicDataView.superclass.afterRender.apply(this,arguments)},fillConfig:Ext.emptyFn,getTpl:Ext.emptyFn,onLoadStore:Ext.emptyFn,getStore:Ext.emptyFn,onDeactivate:Ext.emptyFn,onActivate:function(){this.onLoadStore(0)},encodedMsg:function(b,a){return SYNO.SDS.PkgManApp.Utils.encodedMsg(b,a)},onUpdate:function(f,a){var c=this.store.indexOf(a);if(c>-1){var d=this.all.elements[c],e=this.bufferRender([a],c)[0];if(!Ext.isWebKit){this.onUpdateDefer(a,d,e)}else{var b=Ext.DomQuery.selectNode("img.syno-pkg-icon-img",e);if(b.complete){this.onUpdateDefer(a,d,e)}else{b.onload=this.onUpdateDefer.createDelegate(this,[a,d,e,b]);b.onerror=this.onUpdateDefer.createDelegate(this,[a,d,e,b])}}}},onUpdateDefer:function(f,c,d,b){var a=this.store.indexOf(f);if(a===-1){return}if(b){b.onload=b.onerror=null}if(!this.all.elements[a]){return}var e=this.isSelected(a);this.all.replaceElement(a,d,true);if(e){this.selected.replaceElement(c,d);this.all.item(a).addClass(this.selectedClass)}this.updateIndexes(a,a)},getBtnTemplate:function(f,b,e,d){var a=String.format("aria-label='{0} {1}'",f,d?d:"");var c='<span cellspacing="0" class="x-btn syno-ux-button '+(b||"syno-ux-button-grey")+(e?" x-item-disabled":"")+' x-btn-noicon" style="width: auto; margin-left: 0px;"><em class=" x-unselectable" unselectable="on"><button type="button" class=" x-btn-text" '+a+">"+f+"</button></em></span>";return c},refresh:function(){this.clearSelections(false,true);if(!this.store){return}var c=this.getTemplateTarget(),a=this.store.getRange();c.update("");if(this.maskEl){Ext.destroy(this.maskEl);delete this.maskEl;this.maskEl=null}if(a.length<1){if(!this.deferEmptyText||this.hasSkippedEmptyText){if(!this.maskEl){var b=this._getAbsoluteURL("package_center_256.png","images");this.maskEl=Ext.DomHelper.append(this.moudle.getEl().dom,{tag:"div",style:"position:absolute;top:50%;left:50%;margin-left:-125px;margin-top:-125px;z-index:1000;width:250px;",children:[{tag:"img",style:"display: block;margin: 0 auto;width:132px;height:132px;",onmousedown:"return false;",src:b},{tag:"div",style:"text-align:center;color:#8c96a0;font-size: 14px;font-weight: bold;",html:Ext.isFunction(this.getEmptyText)?this.getEmptyText():this.emptyText}]},true)}}this.all.clear()}else{this.tpl.overwrite(c,this.collectData(a,0,"all"));this.all.fill(Ext.query(this.itemSelector,c.dom));this.updateIndexes(0)}this.hasSkippedEmptyText=true;this.onUpdateUI.defer(300,this)},onUpdateUI:function(){this.updateScrollbar()},onStoreLoad:function(){}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.ViewList=Ext.extend(Ext.Container,{constructor:function(a){SYNO.SDS.PkgManApp.Utils._initWinWrappers.call(this,a);SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.ViewList",this);var b=this.fillConfig(a);SYNO.SDS.PkgManApp.ViewList.superclass.constructor.call(this,b)},fillConfig:function(a){this.dataView=new SYNO.SDS.PkgManApp.ViewListDataView({moudle:this});var b={cls:"syno-pkg-viewlist",boxMinHeight:1,boxMinWidth:1,border:false,layout:"fit",items:[this.dataView,{xtype:"container",height:0,cls:"syno-pkg-view-list-top-broder",html:""}],listeners:{scope:this,activate:this.onActivate,deactivate:this.onDeactivate,afterlayout:{fn:this.onAdustUI,scope:this,buffer:100},resize:{fn:this.onAdustUI,scope:this,buffer:100}}};Ext.apply(b,a);return b},onActivate:function(){this.dataView.onActivate.apply(this.dataView,arguments)},onDeactivate:function(){this.dataView.onDeactivate()},onAdustUI:function(){this.setTopBorder();this.setTopBorder.defer(80,this)},setTopBorder:function(){this.synoTopBorderEl=Ext.get("syno-pkg-source-synology-top-border");this.thirdTopBorderEl=Ext.get("syno-pkg-source-thirdparty-top-border");if((!this.synoTopBorderEl&&!this.thirdTopBorderEl)||this.isDestroyed){return}var b;if(SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView").isCommunityPage()){b=this._getOtherServerObj().store}else{b=this._getSynoServerObj().store}var h=0,g=0;for(var c=0;c<b.data.items.length;++c){if(0<=b.data.items[c].data.maintainer.indexOf("Synology")){++h}else{++g}}var e=SYNO.SDS.PkgManApp.Config.LIST_PKG_CELL_WIDTH-1;var a=Math.floor(this.dataView.getWidth()/e);var d=Math.min(h,a);var f=Math.min(g,a);if(this.synoTopBorderEl){this.synoTopBorderEl.setWidth(d*e+(d?1:0))}if(this.thirdTopBorderEl){this.thirdTopBorderEl.setWidth(f*e+(f?1:0))}}});SYNO.SDS.PkgManApp.ViewListDataView=Ext.extend(SYNO.SDS.PkgManApp.BasicDataView,{images:{},init:function(){this.synoObj={blUpgradeList:false,blFirstLoadStore:false,blRefresh:false};this.otherObj={blUpgradeList:false,blFirstLoadStore:false,blRefresh:false};SYNO.SDS.PkgManApp.ViewListDataView.superclass.init.apply(this,arguments);SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.ViewListDataView",this)},fillConfig:function(a){var b={cls:"syno-pkg-view",tpl:this.getTpl(),disabled:_S("demo_mode"),itemSelector:"div.syno-pkg-template",itemId:"dataview",store:this.getStore(),listeners:{scope:this,click:this.onClickPkgServerPanel,afterlayout:{buffer:300,scope:this,fn:this.onUpdateUI},resize:{buffer:300,scope:this,fn:this.onUpdateUI},activate:this.onActivate,deactivate:this.onDeactivate}};Ext.apply(b,a);return b},onClickPkgServerPanel:function(g,h,a,i){if(_S("demo_mode")||g.disabled){return false}var k=i.getTarget();if(!k){return false}var f=Ext.get(k);if(!f){return false}var b=g.getStore().getAt(h);if(!b){return false}var c;if(f.is("span.x-item-disabled")){}else{if((c=f.findParent("span.syno-ux-button",7))){if(!Ext.fly(c).hasClass("x-item-disabled")){var d=b.data;if(SYNO.SDS.PkgManApp.Utils.mode.open===d.open){if(d.dsm_apps){var j=d.dsm_apps;if(!Ext.isArray(d.dsm_apps)){j=d.dsm_apps.split(" ")}if(j&&j[0]){SYNO.SDS.AppLaunch(j[0])}}else{if(d.url&&d.url[0]){window.open(d.url[0],"_blank","")}}return}this._onClickSynoPkgActionBtn(b)}}else{this.onGotoNext(b)}}},getImageLoader:function(){return this.imageloader||(this.imageloader=new SYNO.SDS.Utils.ImageLoad())},onLoadItem:function(d){var c=d.select("img.syno-pkg-icon-img"),a;if(c.elements.length){a=c.elements[0];if(a){var b=a.getAttribute("url"),e=a.getAttribute("src");if(b===e){return}a.src=b;this.images[b]=true;this.getImageLoader().load(b,{error:{error:(function(f){if(this.isDestroyed){return}var g=this._getAbsoluteURL();f.src=g+"/"+SYNO.SDS.PkgManApp.Config.DEFICON_72}).createDelegate(this)}})}}},getIcon:function(c,k,b,d){var h=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var f=SYNO.SDS.PkgManApp.Utils,a=h.getCurId();k=k||72;var i=(k===72);var j=SYNO.API.currentManager.getBaseURL("SYNO.Core.Package.Thumb.Server","get",1);var g=SYNO.SDS.UIFeatures.test("isRetina");var e;if(g){e=this._getAbsoluteURL(SYNO.SDS.PkgManApp.Config.DEFICON_256)}else{e=this._getAbsoluteURL(i?SYNO.SDS.PkgManApp.Config.DEFICON_72:SYNO.SDS.PkgManApp.Config.DEFICON_256)}if(g&&!Ext.isEmpty(c.thumbnail_retina)&&c.thumbnail_retina[0]){e=Ext.urlAppend(j,Ext.urlEncode(SYNO.API.EncodeParams({name:c.id,ver:c.version,link:i?c.thumbnail_retina[0]:(c.thumbnail_retina[1]||c.thumbnail_retina[0]),size:i?144:256,bls:f._CAT_COMMUNITY_ID!==a})))}else{if(!Ext.isEmpty(c.thumbnail)&&c.thumbnail[0]){e=Ext.urlAppend(j,Ext.urlEncode(SYNO.API.EncodeParams({name:c.id,ver:c.version,link:i?c.thumbnail[0]:(c.thumbnail[1]||c.thumbnail[0]),size:k,bls:f._CAT_COMMUNITY_ID!==a})))}else{if(!c.icon||c.icon===""){}else{if(j===c.icon.substr(0,j.length)){e=c.icon}else{if(c.icon.substr(0,7)==="http://"){e=window.location.protocol+c.icon.substr(5)}else{if(c.icon.substr(0,8)==="https://"){e=window.location.protocol+c.icon.substr(6)}else{if(!Ext.isEmpty(c.icon)){e=Ext.urlAppend(j,Ext.urlEncode(SYNO.API.EncodeParams({name:c.id,ver:c.version,size:k,bls:f._CAT_COMMUNITY_ID!==a})))}}}}}}}if(b||this.images[e]||(d&&d<17)){return String.format('<img class="syno-pkg-icon-img" url={0} src={0} />',e)}return String.format('<img class="syno-pkg-icon-img" url={0} />',e)},getTilte:function(a){return this.encodedMsg(a.dname)},getSource:function(a){if("synology"==a.source){return _T("pkgmgr","synology")}else{return _T("pkgmgr","thirdparty")}},getSourceClass:function(a){if("synology"==a.source){return"syno-pkg-source-synology-icon"}else{return"syno-pkg-source-thirdparty-icon"}},getSourceId:function(a){if("synology"==a.source){return"syno-pkg-source-synology-top-border"}else{return"syno-pkg-source-thirdparty-top-border"}},getTilteQTip:function(a){return this.encodedMsg(a.dname,true)+this.getBetaTitle(a)},getBetaTitle:function(b,a){var c=b.beta?(" "+this.encodedMsg(_T("pkgmgr","beta"))):"";if(c&&a){return'<div class="syno-pkg-beta-label"></div>'}return c},getDesc:function(a){return this.encodedMsg(a.maintainer||a.distributor)},getDescQTip:function(a){return this.encodedMsg(a.maintainer||a.distributor,true)},getPkgType:function(a){if(this.isCommunityPage()){return""}if(a&&0!==a.type){if(!Ext.isEmpty(a.status)){return""}else{if(a.price&&0!==parseFloat(a.price)){return"USD&nbsp;$"+a.price}}}return""},getActionBtn:function(b){var a=this.getActionTemplate(b);return a.actiontext},getActionStatus:function(d){var b=this.getActionTemplate(d,true);var a=b.statustext;if(d.progress<0){if(!this.modalWin||this.modalWin.length===0){a="";this._getOwner().getMsgBox().alert(_T("tree","leaf_packagemanage"),b.statustext,function(){if(b.callback){b.callback()}this._getOwner().fireEvent("pollinginstpage");this.getStore().onLoadPkgStore(false)},this)}else{if(d.qinst){SYNO.SDS.SystemTray.notifyMsg("SYNO.SDS.PkgManApp.Instance",_T("tree","leaf_packagemanage"),b.statustext)}}}else{if(!d.progress){var c=this.getPkgType(d);if(!Ext.isEmpty(c)){a='<span class="syno-pkg-pay-type">'+c+"</span>"}}}return a},getTpl:function(){return new Ext.XTemplate('<tpl for="."><table class="syno-pkg-group-hearder x-table-layout"><tbody><tr style="{[this.hideIfCommunity(values)]}"><td class="{[this.getSourceClass(values)]}"><span class="syno-pkg-source-header-text">{[this.getSource(values)]}</span></td></tr></tbody></table><div id="{[this.getSourceId(values)]}" class="syno-pkg-view-list-top-border"></div><div class="syno-pkg-view-list-region"><tpl for="items"><div class="syno-pkg-template"><table width="126" height="100%" cellspacing="0" class="x-table-layout"><tbody><tr><td class="x-table-layout-cell syno-pkg-cell syno-pkg-name"><div class="syno-pkg-title-container"><div class="syno-pkg-name-container"><span ext:qtip="{[this.getTilteQTip(values)]}">{[this.getTilte(values)]}</span></div><div class="syno-pkg-desc sds-ellipsis"><span ext:qtip="{[this.getDescQTip(values)]}">{[this.getDesc(values)]}</span></div></td></tr><td class="x-table-layout-cell"><div class="syno-pkg-icon">{[this.getIcon(values, undefined, undefined, xindex)]}{[this.getBetaTitle(values, true)]}</div></td></tr><tr><td class="x-table-layout-cell syno-pkg-cell syno-pkg-btn"><table cellspacing="0"><tbody><tr><td>{[this.getActionBtn(values)]}</td></tr></tbody></table></td></tr><tr><td class="x-table-layout-cell syno-pkg-cell" style="text-align: center;height:34px;max-width:128px">{[this.getActionStatus(values)]}</td></tr></tbody></table></div></tpl></div><div style="margin-bottom:15px;margin-top:16px;height:12px;display:inline-block;width:100%;"></tpl>'+String.format('<center><a href="{0}" target="_blank" class="syno-pkg-info-tof pathlink">{1}</a></center>',SYNO.SDS.PkgManApp.TOFURL,_T("pkgmgr","termsofservice"))+"</div>",{compiled:true,disableFormats:true,getTilte:this.getTilte.createDelegate(this),getTilteQTip:this.getTilteQTip.createDelegate(this),getBetaTitle:this.getBetaTitle.createDelegate(this),getDesc:this.getDesc.createDelegate(this),getDescQTip:this.getDescQTip.createDelegate(this),getIcon:this.getIcon.createDelegate(this),getActionBtn:this.getActionBtn.createDelegate(this),getActionStatus:this.getActionStatus.createDelegate(this),getSource:this.getSource.createDelegate(this),getSourceClass:this.getSourceClass.createDelegate(this),getSourceId:this.getSourceId.createDelegate(this),hideIfCommunity:this.hideIfCommunity.createDelegate(this)})},collectData:function(a,g,d){var b=[],f=[],e=[],c;var h=this.isCommunityPage();for(c=0;c<a.length;++c){if(!h&&0<=a[c].data.maintainer.indexOf("Synology")){e.push(a[c].data)}else{f.push(a[c].data)}}if(0!==e.length){b.push({source:"synology",items:e})}if(0!==f.length){b.push({source:"thirdparty",items:f})}return b},hideIfCommunity:function(a){return this.isCommunityPage()?"display:none;":""},onActivate:function(d){if(!d){if(!this.blLoading&&0===this.getStore().getTotalCount()){this.getStore().reload()}if(this.blLoading){this.onMaskPanel()}}var e=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SearchField");e.enable();this.onFilterStore();var b=this.moudle;var c=b.getEl();if(c&&c.isMasked()){var a=c.first("div.ext-el-mask-msg");if(a){a.center(c)}}},onDeactivate:function(){},getStore:function(){if(this.stores){if(this.store!==this.stores[this.getCurClass()]){this.bindStore(this.stores[this.getCurClass()])}return this.stores[this.getCurClass()]}this.stores={};this.createStores();return(this.stores[this.getCurClass()])},createStores:function(){var a=SYNO.SDS.PkgManApp.Utils;this.synoObj.store=this.createStore({itemId:a._SYNO_SERVER_CLASS,onLoadPkgStore:this.onLoadSynoPkgStore.createDelegate(this,[],true)},this.synoObj);this.otherObj.store=this.createStore({itemId:a._COMMUNITY_CLASS,onLoadPkgStore:this.onLoadOtherPkgStore.createDelegate(this,[],true)},this.otherObj)},createStore:function(a,c){var b=new Ext.data.Store(Ext.apply({autoLoad:true,autoDestroy:false,remoteSort:false,baseParams:{blloadothers:SYNO.SDS.PkgManApp.Utils._CAT_COMMUNITY_ID===a.itemId},proxy:new SYNO.API.Proxy({api:"SYNO.Core.Package.Server",method:"list",version:1,listeners:{scope:this,beforeload:function(d,e){e.blforcereload=this._getOwner().isNeedForceReload();c.beforeloadtime=new Date().getTime()},load:function(f,h,e){c.blUpgradeList=true;if(h&&h.blupgrade){this._getOwner().fireEvent("pollinginstpage");SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView").refresh()}if(c===this.synoObj&&h.recommend){var g=false;g=(!c.blFirstLoadStore&&c===this.synoObj&&!SYNO.SDS.PkgManApp.Config.has_packages&&(((new Date().getTime())-c.beforeloadtime)<8000));(function(){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.RecommendList").getStore().loadData(h);if(g){var i=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");i.onGotoPanel("recommend")}}).defer(80)}if(SYNO.SDS.PkgManApp.Utils._CAT_COMMUNITY_ID!==a.itemId){if(!this.synoObj.store.isDestroyed){this.synoObj.store.each(function(i){if(this._IsInstalling(i.data)){this._getOwner().fireEvent("pollinginstpage");return false}},this)}}else{if(!this.otherObj.store.isDestroyed){this.otherObj.store.each(function(i){if(this._IsInstalling(i.data)){this._getOwner().fireEvent("pollinginstpage");return false}},this)}}if(!c.blFirstLoadStore){if(c===this.synoObj){SYNO.API.Request({api:"SYNO.Core.Package.Server",method:"check",version:1})}if(!this.otherObj.blFirstLoadStore&&!this.synoObj.blFirstLoadStore){var d=(c===this.synoObj)?this.otherObj.store:this.synoObj.store;this.mon(d,"load",function(){var m,k;for(m in SYNO.SDS.PackageTaskMgr.tasks){if(SYNO.SDS.PackageTaskMgr.tasks.hasOwnProperty(m)){k=SYNO.SDS.PackageTaskMgr.getTask(m);var j="@SYNOPKG_DOWNLOAD_";var l=this._getAvalRec(m.substr(j.length));if(l){var i;i=new SYNO.SDS.PkgManApp.DownloadAction({owner:this,id:l.get("id")},k)}else{k.cancel()}}}},this,{single:true,buffer:80})}c.blFirstLoadStore=true}}}}),reader:new Ext.data.JsonReader({root:"data",totalProperty:"total",id:"id"},[{name:"id"},{name:"dname",sortType:function(d){if(!d){return""}return d.toLowerCase()}},{name:"desc"},{name:"desc_enu"},{name:"changelog"},{name:"version"},{name:"icon"},{name:"link"},{name:"md5"},{name:"size",type:"int"},{name:"progress",type:"float"},{name:"info"},{name:"qinst",type:"boolean"},{name:"qupgrade",type:"boolean"},{name:"qstart",type:"boolean"},{name:"depsers"},{name:"deppkgs"},{name:"conflictpkgs"},{name:"start",type:"boolean"},{name:"maintainer"},{name:"maintainer_url"},{name:"distributor"},{name:"distributor_url"},{name:"blupgrade"},{name:"beta"},{name:"thirdparty"},{name:"download_count",type:"int"},{name:"recent_download_count",type:"int"},{name:"support_url"},{name:"status"},{name:"type",type:"int"},{name:"price",type:"float"},{name:"thumbnail"},{name:"thumbnail_retina"},{name:"snapshot"},{name:"install_type"},{name:"category",type:"int"},{name:"source"},{name:"dsm_apps"},{name:"url"},{name:"open"}]),listeners:{scope:this,beforeload:this.onBeforeLoadStore,load:this.onAfterLoadStore,exception:this.onExceptionLoadStore,clear:{buffer:300,scope:this,fn:this.onUpdateUI}}},a));this.stores[a.itemId]=b;this.addManagedComponent(b);return b},onBeforeLoadStore:function(a,b){this.blLoading=true;a.loading=true},onAfterLoadStore:function(a){this.blLoading=false;a.loading=false;this.moudle.onAdustUI();this.onFilterStore();this.onUnmaskPanel();this._getOwner().fireEvent("pollinginstpage");SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView").refresh()},onFilterStore:function(){var i=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var f=SYNO.SDS.PkgManApp.Utils,a=i.getCurId();if(f._INSTALLED_ID===a||f._UPDATE_ID===a){return}var c=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SortButton");c.enable();var g=c.getTypeFilter()!=="filter_installed";var b=f.SEC_CFG[a].category;var h=!(f._CAT_COMMUNITY_ID===a||f._CAT_ALL_ID===a);var e=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SearchField");var d=e.getSearchText()||"";d=d.toLowerCase();this.getStore().filterBy(function(j){if(!g&&SYNO.SDS.PkgManApp.Utils.isOnlyInstStatus(j.data)){return false}if(h&&!(j.get("category")&b)){return false}if(!Ext.isEmpty(d)){return(j.data.dname&&j.data.dname.toLowerCase().indexOf(d)!=-1)||(j.data.id.toLowerCase().indexOf(d)!=-1)||(j.data.desc&&j.data.desc.toLowerCase().indexOf(d)!=-1)||(j.data.desc_enu&&j.data.desc_enu.toLowerCase().indexOf(d)!=-1)||(j.data.changelog&&j.data.changelog.toLowerCase().indexOf(d)!=-1)||(j.data.maintainer&&j.data.maintainer.toLowerCase().indexOf(d)!=-1)}return true});if(f._CAT_COMMUNITY_ID!==a){c.sortStore(this.getStore())}else{this.getStore().sort("dname","ASC")}this.onUpdateUI.defer(300,this);this.moudle.onAdustUI()},onMaskPanel:function(d){var a=this.moudle;var b=a.getEl();if(b){var c=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.Recommend");if(d){b.mask(d);c.getEl().mask(d)}else{b.mask(_T("common","loading"),"x-mask-loading");SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewDetail").getEl().mask(_T("common","loading"),"x-mask-loading");c.getEl().mask(_T("common","loading"),"x-mask-loading")}}},onUnmaskPanel:function(){var a=this.moudle;var b=a.getEl();if(b&&b.isMasked()){b.unmask()}SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewDetail").getEl().unmask();SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.Recommend").getEl().unmask()},onExceptionLoadStore:function(g,h,b,j,c,i){this.blLoading=false;g.loading=false;this.onUnmaskPanel();var a;if(c.responseText){var d;try{d=Ext.util.JSON.decode(c.responseText)}catch(f){}a=_T("common","commfail");if(d&&d.errinfo){a=_T(d.errinfo.sec,d.errinfo.key)}}else{a=_T("common","commfail")}this.onMaskPanel(a)},isCommunityPage:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var b=SYNO.SDS.PkgManApp.Utils,c=a.getCurId();return(b._CAT_COMMUNITY_ID===c)},getActionTemplate:function(t,r,a){var o=this._isQuickInstll(t);var b=this._isUpgradable(t.id);var d=SYNO.SDS.PkgManApp.Utils.isBuyable(t)&&!this.isCommunityPage();var m=b?_T("pkgmgr","pkgmgr_pkg_upgrade"):(d?_T("pkgmgr","myds_pay_buy"):_T("pkgmgr","pkgmgr_pkg_install"));if(!this.isCommunityPage()&&t&&0!==t.type&&(Ext.isEmpty(t.status)&&!(t.price&&0!==parseFloat(t.price)))){m=_T("pkgmgr","myds_pay_trail")}var k="";var i=false;var s=(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(t));var g=false;var u=(b?"syno-ux-button-green":"");var f='<div class="syno-pkg-button-container" ';t.open=0;if(s){u="syno-ux-button-orange";m=SYNO.SDS.PkgManApp.Utils.getBrokenStr(t)}if(o&&-1!==this._getInstallAll_Background().indexOf(t.id)){g=true;m=_T("vpnc","waiting")}if(s){}else{if(!Ext.isEmpty(t.status)&&!b){if(t.dsm_apps){if(!Ext.isArray(t.dsm_apps)){t.dsm_apps=t.dsm_apps.split(" ")}if(SYNO.SDS.StatusNotifier.isAppEnabled(t.dsm_apps[0])){t.open=SYNO.SDS.PkgManApp.Utils.mode.open}}else{if(t.url&&t.url[0]){t.open=SYNO.SDS.PkgManApp.Utils.mode.open}}if(SYNO.SDS.PkgManApp.Utils.mode.open===t.open){m=_T("pkgmgr","open");u="syno-pkg-button-open syno-ux-button-grey"}else{if(a){m=_T("pkgmgr","more_info");t.open=SYNO.SDS.PkgManApp.Utils.mode.more}else{m=_T("pkgmgr","status_installed");g=true}}}}var c=this._GetProcessStatus(t.status);if(c.blProcessing){k=c.msg;g=true}else{if(this._IsInstalling(t)){k=b?_T("pkgmgr","upgrading"):_T("pkgmgr","installing");g=true}}if(Ext.isDefined(t.progress)&&t.progress){if(0<t.progress){if(a){m=_T("pkgmgr","more_info");t.open=SYNO.SDS.PkgManApp.Utils.mode.more}else{m=_T("common","cancel")}}if(t.progress==1){}else{if(t.progress>0){u="syno-ux-button-grey";if(0.00001>=t.progress){k=_T("vpnc","waiting")}else{k=Math.floor(t.progress*100)+"%&nbsp;";if(this._IsInstalling(t)){if(c.blProcessing){k+=c.msg}else{k+=b?_T("pkgmgr","upgrading"):_T("pkgmgr","installing")}}else{k+=_T("download","download_task_downloading")}}}else{if(t.progress<0){i=true;k=b?_T("pkgmgr","upgrade_pkg_fail"):_T("pkgmgr","install_pkg_fail");k=String.format(k,t.dname,"");m=b?_T("pkgmgr","pkgmgr_pkg_upgrade"):_T("pkgmgr","pkgmgr_pkg_install")}}}}var j,q,n;if(r&&t.info&&t.progress<0){q=t.info;i=true;k=this._IsInstalling(t)?_T("pkgmgr","install_pkg_fail"):_T("pkgmgr","download_pkg_fail");k=String.format(k,t.dname,"");n=t.dname+":<br>";if(q.error){var l;try{l=Ext.decode(q.error)}catch(p){}k=n+SYNO.SDS.PkgManApp.Utils.localizeArrMsg(l)}else{if(q.sec&&q.key){k=n+_T(q.sec,q.key)+"&nbsp;"}}if(q.message&&""!==q.message){k+=SYNO.SDS.PkgManApp.Utils.localizeMsg(q.message,q.message)}delete t.info}if(_S("demo_mode")){g=true;f+=(' ext:qtip="'+_JSLIBSTR("uicommon","error_demo")+'"')}f+=">"+this.getBtnTemplate(m,u,g,t.dname)+"</div>";var h=k;if(!i&&k){h="<span class='syno-pkg-status'>";h+="<font style='color:#78c52d;' ext:qtip='"+k+"'>";h+="&nbsp;";h+=k;h+="</font></span>"}return{actiontext:f,statustext:h,callback:j?j.callback:undefined}},onLoadPkgStore:function(d,a,c){var b=this.synoObj.store.getById(d);if(b){this.onLoadSynoPkgStore(a,c)}else{this.onLoadOtherPkgStore(a,c)}},onLoadOtherPkgStore:function(a,b){this.onLoadPkgStoreFn(this.otherObj,a,b)},onLoadSynoPkgStore:function(a,b){this.onLoadPkgStoreFn(this.synoObj,a,b)},onLoadPkgStoreFn:function(b,a,c){b.blRefresh=true;if(a){this.onMaskPanel()}if(false===c){b.store.reload()}else{b.store.load({callback:c||function(e,d,f){this.onLoadPkgStoreCallback(b,a,e,d,f)},scope:this})}this.moudle.onAdustUI()},onLoadPkgStoreCallback:function(d,a,c,b,e){if(a){this.onUnmaskPanel()}this._getOwner().fireEvent("pollinginstpage")},onSyncGroupSettings:function(){if(false!==this.synoObj.blRefresh){this.onLoadSynoPkgStore(false)}if(false!==this.otherObj.blRefresh){this.onLoadOtherPkgStore(false)}},getCurClass:function(){var b=SYNO.SDS.PkgManApp.Utils;var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr").getCurId();a=(a==b._CAT_COMMUNITY_ID)?b._CAT_COMMUNITY_ID:b._SYNO_SERVER_CLASS;return a},onGotoNext:function(a){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr").onGotoNext(a.data)},setTof:function(){var b=Ext.fly(Ext.DomQuery.selectNode("a.pathlink",this.getEl().dom));if(b&&this.getEl().dom.fleXdata){var a=this.getEl().dom.fleXdata.scrollPosition[1][1];if(false!==a){b.setStyle("position","static")}else{b.setStyle("position","absolute");b.setStyle("bottom",-(this.getEl().getBottom()-this.getTemplateTarget().getBottom()-12)+"px");b.setStyle("left",(((this.getWidth()-b.getWidth())/2)-4)+"px")}}},updateScrollbar:function(){SYNO.SDS.PkgManApp.ViewListDataView.superclass.updateScrollbar.apply(this,arguments);this.setTof();this.setTof.defer(500,this)},onUpdateUI:function(){this.updateScrollbar()},getEmptyText:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SearchField");var b=a.getSearchText()||"";if(b){return _T("search","no_search_result")}return _T("pkgmgr","non_available_packages")},refresh:function(){SYNO.SDS.PkgManApp.ViewListDataView.superclass.refresh.apply(this,arguments);this.onUpdateUI()}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.ViewGrid=Ext.extend(Ext.Container,{constructor:function(a){SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.ViewGrid",this);var b=this.fillConfig(a);SYNO.SDS.PkgManApp.ViewGrid.superclass.constructor.call(this,b)},fillConfig:function(a){this.dataView=new SYNO.SDS.PkgManApp.ViewGridDataView({moudle:this});var b={cls:"syno-pkg-viewgrid",boxMinHeight:1,boxMinWidth:1,border:false,layout:"fit",items:[this.dataView,{xtype:"container",height:0,cls:"syno-pkg-view-grid-top-border",html:""}],listeners:{scope:this,activate:this.onActivate,deactivate:this.onDeactivate}};Ext.apply(b,a);return b},onActivate:function(){this.dataView.onActivate()},onDeactivate:function(){this.dataView.onDeactivate()}});SYNO.SDS.PkgManApp.ViewGridDataView=Ext.extend(SYNO.SDS.PkgManApp.BasicDataView,{images:{},init:function(){SYNO.SDS.PkgManApp.Utils._initWinWrappers.call(this);SYNO.SDS.PkgManApp.ViewGridDataView.superclass.init.apply(this,arguments);SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView",this)},fillConfig:function(a){var b={cls:"syno-pkg-view syno-pkg-install-view",tpl:this.getTpl(),disabled:_S("demo_mode"),itemSelector:"div.syno-pkg-template",itemId:"dataview",store:this.getStore(),listeners:{scope:this,click:this.onClickInstalledPkgPanel,resize:{buffer:300,scope:this,fn:this.onUpdateUI},activate:this.onActivate,deactivate:this.onDeactivate}};Ext.apply(b,a);return b},getEmptyText:function(){if(!this.blFirstLoad){return""}var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SearchField");var b=a.getSearchText()||"";if(b){return _T("search","no_search_result")}return(this.isUpgradePage()?_T("pkgmgr","non_upgradable_packages"):_T("pkgmgr","non_inst_packages"))},onClick:function(d){SYNO.SDS.PkgManApp.ViewGridDataView.superclass.onClick.apply(this,arguments);if(_S("demo_mode")){return false}var c=d.getTarget("div.syno-pkg-group-btn",this.getTemplateTarget());if(!c){return false}var b=Ext.get(c);if(!b){return false}var a=b.child("span.syno-ux-button-orange")?true:false;this._onClickUpdateAll(a)},onClickInstalledPkgPanel:function(a,b,f,h){if(_S("demo_mode")||a.disabled){return false}var d=h.getTarget();if(!d){return false}var c=Ext.get(d);if(!c){return false}var g=this.collectrec[b];if(!g){return false}var i;if(c.is("a.syno-pkg-info-url")){if(!c.dom.href){SYNO.SDS.AppLaunch("SYNO.SDS.SupportForm.Application",{extra:{pkg_id:g.id,pkg_version:g.version}})}}else{if((i=c.findParent("span.syno-ux-button-green",11))){if(Ext.fly(i).hasClass("x-item-disabled")){return false}if(!this._isUpgradable(g.id)){return false}this._onClickSynoPkgActionBtn(this._getAvalRec(g.id))}else{if((i=c.findParent("span.syno-ux-button-orange",11))||(i=c.findParent("span.syno-ux-button-grey",11))){if(Ext.fly(i).hasClass("x-item-disabled")){return false}this._onClickSynoPkgActionBtn(this._getAvalRec(g.id))}else{this.onGotoNext(g)}}}},getImageLoader:function(){return this.imageloader||(this.imageloader=new SYNO.SDS.Utils.ImageLoad())},onLoadItem:function(d){var c=d.select("img.syno-pkg-icon-img"),a;if(c.elements.length){a=c.elements[0];if(a){var b=a.getAttribute("url"),e=a.getAttribute("src");if(b===e){return}a.src=b;this.images[b]=true;this.getImageLoader().load(b,{error:{error:(function(f){if(this.isDestroyed){return}var g=this._getAbsoluteURL();f.src=g+"/"+SYNO.SDS.PkgManApp.Config.DEFICON_72}).createDelegate(this)}})}}},getIcon:function(e,b,d,a){b=b||72;var f=SYNO.SDS.UIFeatures.test("isRetina");if(f){b=(72===b)?144:256}var c=Ext.urlAppend(SYNO.API.currentManager.getBaseURL("SYNO.Core.Package.Thumb","get",1),Ext.urlEncode(SYNO.API.EncodeParams({name:e.id,ver:e.version,size:b})));if(d||this.images[c]||(a&&a<7)){return String.format('<img class="syno-pkg-icon-img" url={0} src={0} />',c)}return String.format('<img class="syno-pkg-icon-img" url={0} />',c)},getTilte:function(a){return this.encodedMsg(a.dname)},getTilteQTip:function(a){return this.encodedMsg(a.dname,true)+this.getBetaTitle(a)},getBetaTitle:function(b,a){var c=b.beta?(" "+this.encodedMsg(_T("pkgmgr","beta"))):"";if(c&&a){return'<div class="syno-pkg-beta-label"></div>'}return c},getVersion:function(a){if(!_S("demo_mode")&&(a.pkgreporturl||a.support_center)){if(a.support_center){return String.format('<a class="syno-pkg-info-url">{0}</a>',_T("pkgmgr","report"))}return String.format('<a href="{0}" target="_blank" class="allowDefCtxMenu syno-pkg-info-url">{1}</a>',a.pkgreporturl,_T("pkgmgr","report"))}return'<span class="syno-pkg-info-version">'+this.encodedMsg(a.version)+"</span>"},getDesc:function(c,b){var a=(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(c));if(a){switch(c.status){case"version_limit":return _T("pkgmgr","broken_version_desc");case"builtin":return _T("pkgmgr","buildin_desc");case"non_support":return String.format(_T("pkgmgr","pkgmgr_pkg_not_support_platform"),_D("product"));case"non_support_dsm_version":return _T("pkgmgr","incompatible");default:return _T("pkgmgr","broken_desc")}}return this.encodedMsg(c.desc,b)},getDescQTip:function(a){return this.getDesc(a,true)},getActionBtn:function(e){var b=this._isRepairable(e);if(!this.isUpgradePage()&&!b){return""}var d=this._getAvalRec(e.id);var a=this._isUpgradable(e.id);var f="";if((a||b)&&d){var c=this.getActionTemplate(d.data);f=c.actiontext;if(d.data.progress<0){}else{if(c.statustext){f+=c.statustext}}}return f},getStatus:function(e){var c=e.status;var b=this._isUpgradable(e.id);var g=false,d;var a=this._isRepairable(e);if(a||b){d=this._getAvalRec(e.id);if(d){g=(0<d.data.progress&&1>d.data.progress);if(g||this._IsInstalling(d.data)){if("version_limit"===SYNO.SDS.PkgManApp.Utils.getBrokenStatus(c)){c="upgrading"}else{c=a?"repairing":"upgrading"}}}}var f='<font class="syno-pkg-status" style="color:';switch(c){case"stop":f+='#666666;">'+_T("pkgmgr","pkgmgr_pkg_stopped");break;case"running":f+='#78c52d;">'+_T("pkgmgr","pkgmgr_pkg_running");break;case"installing":f+='#78c52d;">'+_T("pkgmgr","installing");break;case"upgrading":f+='#78c52d;">'+_T("pkgmgr","upgrading");break;case"repairing":f+='#78c52d;">'+_T("pkgmgr","repairing");break;case"uninstalling":f+='#78c52d;">'+_T("background_task","task_processing")+"...";break;case"starting":f+='#78c52d;">'+_T("pkgmgr","starting");break;case"stopping":f+='#78c52d;">'+_T("pkgmgr","stopping");break;default:if(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(c)){if("version_limit"===SYNO.SDS.PkgManApp.Utils.getBrokenStatus(c)){f+='#f4982d;">'+_T("pkgmgr","status_version_limit")}else{f+='#EB5F5F;">'+_T("pkgmgr","pkgmgr_pkg_broken")}}else{f+='#EB5F5F;">'+_T("status","status_not_available")}break}return(f+"</font>")},getGroupHeaderStyle:function(a){return""},isUpgradePage:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var b=SYNO.SDS.PkgManApp.Utils,c=a.getCurId();return(b._UPDATE_ID===c)},getGroupText:function(a){if(this.isUpgradePage()){return String.format(_T("pkgmgr","status_update_title"),a.items.length)}if("1_installed"===a.inst_type){return _T("pkgmgr","status_installed_title")}else{if("2_upgradable"===a.inst_type){return String.format(_T("pkgmgr","status_update_title"),a.items.length)}else{if("0_broken"===a.inst_type){return _T("pkgmgr","status_broken_title")}}}return""},getGroupBtn:function(d){if(_S("demo_mode")){return""}var a,e;if(d.inst_type==="0_broken"&&d.items){a="syno-ux-button-orange";e=_T("pkgmgr","repair_all");var c=false;Ext.each(d.items,function(f){var g=this._getSynoServerObj().store.getById(f.id)||this._getOtherServerObj().store.getById(f.id);if(g){c=true;return false}},this);if(!c){return""}}else{if(d.inst_type=="2_upgradable"){a="syno-ux-button-green";e=_T("pkgmgr","update_all")}else{return""}}var b='<div class="syno-pkg-group-btn syno-pkg-btn" style=""><span cellspacing="0" class="x-btn syno-ux-button '+(a||"syno-ux-button-default")+' x-btn-noicon" style="width: auto; margin-left: 0px;"><em class=" x-unselectable" unselectable="on"><button type="button" class=" x-btn-text">'+e+"</button></em></span></div>";return b},getRowClass:function(b){var a=this.getStore().indexOfId(b.id);if(0===a){return"x-grid3-row-first"}a--;var c=this.getStore().getAt(a);if(c&&c.data.status!==b.status&&SYNO.SDS.PkgManApp.Utils.isBrokenStatus(c.data.status)&&("stop"===b.status||"running"===b.status)&&!this.isUpgradePage()){return"x-grid3-row-first"}},getTpl:function(){return new Ext.XTemplate('<tpl for="."><div class="syno-pkg-grid-group x-grid-group x-dataview" style="display:inline-block; width:100%;"><div class="x-grid-group-hd " style="{[this.getGroupHeaderStyle(values)]}"><table class="syno-pkg-group-hearder x-table-layout" width="100%" height="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="syno-pkg-group-hearder-ml" style="width:0"></td><td class="syno-pkg-group-hearder-mc" style="width:100%;" align="left">&nbsp;<span class="syno-pkg-group-hearder-text">{[this.getGroupText(values)]}</span></td><td align="right" class="syno-pkg-group-hearder-mr" style="display:block;width:200px;" align="right">{[this.getGroupBtn(values)]}</td></tr></tbody></table></div></div><div class="x-grid-group-body"><tpl for="items"><div class="syno-pkg-template x-grid3-row {[this.getRowClass(values)]}" ><table class="x-grid3-row-table" border="0" cellspacing="0" cellpadding="0" style="width:100%; height:90px;"><tbody><tr><td class="x-grid3-col x-grid3-cell x-grid3-col-icon" style="width:68px;" tabindex="0"><div class="syno-pkg-icon">{[this.getIcon(values, undefined, undefined, xindex)]}{[this.getBetaTitle(values, true)]}</div></td><td class="x-grid3-col x-grid3-cell syno-pkg-title" tabindex="0"><div class="syno-pkg-name sds-ellipsis"><span ext:qtip="{[this.getTilteQTip(values)]}">{[this.getTilte(values)]}</span></div><div class="sds-ellipsis">{[this.getStatus(values)]}</div><div class="sds-ellipsis">{[this.getVersion(values)]}</div></td><td class="x-grid3-col x-grid3-cell " style="" tabindex="0"><div class="syno-pkg-desc"><span ext:qtip="{[this.getDescQTip(values)]}">{[this.getDesc(values)]}</span></td><td class="x-grid3-col x-grid3-cell" style="width:114px;padding-left:14px;padding-right:10px;text-align:center;" tabindex="0">{[this.getActionBtn(values)]}</td></tr></tbody></table></div></tpl></div></tr></tbody></tbody></div>',"</div>","</tpl>",{compiled:true,disableFormats:true,getRowClass:this.getRowClass.createDelegate(this),getTilte:this.getTilte.createDelegate(this),getTilteQTip:this.getTilteQTip.createDelegate(this),getBetaTitle:this.getBetaTitle.createDelegate(this),getDesc:this.getDesc.createDelegate(this),getDescQTip:this.getDescQTip.createDelegate(this),getIcon:this.getIcon.createDelegate(this),getVersion:this.getVersion.createDelegate(this),getActionBtn:this.getActionBtn.createDelegate(this),getStatus:this.getStatus.createDelegate(this),getGroupHeaderStyle:this.getGroupHeaderStyle.createDelegate(this),getGroupText:this.getGroupText.createDelegate(this),getGroupBtn:this.getGroupBtn.createDelegate(this)})},onActivate:function(){var c=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SortButton");c.disable();var e=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SearchField");e.enable();this.onFilterStore();var b=this.moudle;var d=b.getEl();if(d&&d.isMasked()){var a=d.first("div.ext-el-mask-msg");if(a){a.center(d)}}},onFilterStore:function(){var b=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var d=SYNO.SDS.PkgManApp.Utils,f=b.getCurId();if(!(d._INSTALLED_ID===f||d._UPDATE_ID===f)){return}var c=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SearchField");var e=c.getSearchText()||"";e=e.toLowerCase();var a=0;this.getStore().filterBy(function(g){if(!Ext.isEmpty(e)&&!((g.data.dname&&g.data.dname.toLowerCase().indexOf(e)!=-1)||(g.data.id.toLowerCase().indexOf(e)!=-1)||(g.data.desc&&g.data.desc.toLowerCase().indexOf(e)!=-1)||(g.data.desc_enu&&g.data.desc_enu.toLowerCase().indexOf(e)!=-1)||(g.data.changelog&&g.data.changelog.toLowerCase().indexOf(e)!=-1)||(g.data.maintainer&&g.data.maintainer.toLowerCase().indexOf(e)!=-1))){return false}if(d._UPDATE_ID===f){a++;return this._isUpgradable(g.data.id)}return true},this);this.onUpdateUI.defer(300,this);this.moudle.doLayout()},onDeactivate:function(){},getStore:function(){if(this.store){return this.store}this.store=new SYNO.API.Store({autoLoad:false,remoteSort:false,proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"packages",id:"id"},[{name:"id"},{name:"dname",mapping:"name"},{name:"desc",mapping:"additional.description"},{name:"desc_enu",mapping:"additional.description_enu"},{name:"version"},{name:"status",mapping:"additional.status"},{name:"progress",mapping:"additional.installing_progress"},{name:"maintainer",mapping:"additional.maintainer"},{name:"maintainer_url",mapping:"additional.maintainer_url"},{name:"distributor",mapping:"additional.distributor"},{name:"distributor_url",mapping:"additional.distributor_url"},{name:"pkghelpurl",mapping:"additional.help_url"},{name:"pkgadminporturl",convert:function(b,a){var e=a.additional.url;if(!e){return""}var c="";for(var d=0;d<e.length;d++){c+=String.format("<a href='{0}' target='_blank'>{0}</a>",e[0]);if(d>0){c+=";"}}return c}},{name:"pkgstartable",type:"boolean",mapping:"additional.startable"},{name:"pkgisuninstui",mapping:"additional.is_uninstall_pages"},{name:"icon"},{name:"pkgreporturl",mapping:"additional.report_beta_url"},{name:"support_center",mapping:"additional.support_center"},{name:"beta",type:"boolean",mapping:"additional.beta"},{name:"support_url",mapping:"additional.support_url"},{name:"dsm_apps",mapping:"additional.dsm_apps"},{name:"pkgtarget",mapping:"additional.installed_info"},{name:"install_type",mapping:"additional.install_type"},{name:"inst_type"},{name:"blupgrade"},{name:"autoupdate",mapping:"additional.autoupdate"},{name:"silent_upgrade",mapping:"additional.silent_upgrade"}]),listeners:{scope:this,beforeload:this.onBeforeLoadStore,load:this.onAfterLoadStore,exception:this.onExceptionLoadStore,clear:{buffer:300,scope:this,fn:this.onUpdateUI}}});return this.store},onBeforeLoadStore:function(a,b){this.onMaskPanel()},onAfterLoadStore:function(){this.onUnmaskPanel();this.onFilterStore()},onMaskPanel:function(c){var a=this.moudle;var b=a.getEl();if(c){b.mask(c,"")}else{b.mask(_T("common","loading"),"x-mask-loading");SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewDetail").getEl().mask(_T("common","loading"),"x-mask-loading")}},onUnmaskPanel:function(){var a=this.moudle;var b=a.getEl();if(b.isMasked()){b.unmask()}SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewDetail").getEl().unmask()},onExceptionLoadStore:function(a,b){this.onUnmaskPanel();var f;if(b&&b.responseText){var d;try{d=Ext.util.JSON.decode(b.responseText)}catch(c){}f=_T("common","commfail");if(d&&d.errinfo){f=_T(d.errinfo.sec,d.errinfo.key)}}else{f=_T("common","commfail")}this.onMaskPanel(f)},onExceptionData:function(a,c){var b=SYNO.SDS.PkgManApp.Utils.getWebAPIErr(false,a,c);this.onMaskPanel(b)},getActionTemplate:function(g){var k=this._isQuickInstll(g);var b=this._isUpgradable(g.id);var e=b?_T("pkgmgr","pkgmgr_pkg_upgrade"):_T("pkgmgr","pkgmgr_pkg_install");var f="";var m=false;var h=(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(g));var d=h?"syno-ux-button-orange":"syno-ux-button-green";var i=false;var c='<div class="syno-pkg-btn';if(h){e=SYNO.SDS.PkgManApp.Utils.getBrokenStr(g)}if(k&&-1!==this._getInstallAll_Background().indexOf(g.id)){i=true;e=_T("vpnc","waiting")}var j=this._GetProcessStatus(g.status);if(j.blProcessing){f=j.msg;i=true}else{if(this._IsInstalling(g)){f=b?_T("pkgmgr","upgrading"):_T("pkgmgr","installing");i=true}}if(Ext.isDefined(g.progress)&&g.progress){if(0<g.progress){e=_T("common","cancel")}if(g.progress==1){}else{if(g.progress>0){d=" syno-ux-button-grey";if(0.00001>=g.progress){f=_T("vpnc","waiting")}else{f=Math.floor(g.progress*100)+"%<br>";if(this._IsInstalling(g)){if(j.blProcessing){f+=j.msg}else{f+=b?_T("pkgmgr","upgrading"):_T("pkgmgr","installing")}}else{f+=_T("download","download_task_downloading")}}}else{if(g.progress<0){m=true;f=b?_T("pkgmgr","upgrade_pkg_fail"):_T("pkgmgr","install_pkg_fail");f=String.format(f,g.dname,"");if(h){e=SYNO.SDS.PkgManApp.Utils.getBrokenStr(g)}else{e=b?_T("pkgmgr","pkgmgr_pkg_upgrade"):_T("pkgmgr","pkgmgr_pkg_install")}}}}}var a;if(g&&g.progress<0){m=true;f=this._IsInstalling(g)?_T("pkgmgr","install_pkg_fail"):_T("pkgmgr","download_pkg_fail");f=String.format(f,g.dname,"")}if(_S("demo_mode")){i=true;c+=('" ext:qtip="'+_JSLIBSTR("uicommon","error_demo"))}c+='">'+this.getBtnTemplate(e,d,i,g.dname)+"</div>";var l=f;if(!m&&f){l="<div class='syno-pkg-status'>";l+="<font style='color:#78c52d;display:table;margin:auto;' ext:qtip='"+f+"'>";l+="&nbsp;";l+=f;l+="</font></div>"}return{actiontext:c,statustext:l,callback:a?a.callback:undefined}},onGotoNext:function(a){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr").onGotoNext(a)},collectData:function(f,o,l){var b=[],h=0,k=f.length;var e=[];var c=[];var j=[];var p=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr");var n=SYNO.SDS.PkgManApp.Utils,d=p.getCurId();var a=false;for(;h<k;h++){var g=f[h].data;if(n._UPDATE_ID===d){a=this._isUpgradable(g.id)}if(n._UPDATE_ID!==d&&(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(g))){j.push(g)}else{if(a){c.push(g)}else{e.push(g)}}}var m=function(i,q){return i.dname.toLowerCase().localeCompare(q.dname.toLowerCase())};if("all"===l){this.collectrec=[]}if(!Ext.isEmpty(j)){j=j.sort(m);b[b.length]={inst_type:"0_broken",items:j};if("all"===l){this.collectrec=this.collectrec.concat(j)}}if(!Ext.isEmpty(c)){c=c.sort(m);b[b.length]={inst_type:"2_upgradable",items:c};if("all"===l){this.collectrec=this.collectrec.concat(c)}}if(!Ext.isEmpty(e)){e=e.sort(m);b[b.length]={inst_type:"1_installed",items:e};if("all"===l){this.collectrec=this.collectrec.concat(e)}}return b},onUpdateDefer:function(g,d,e,b){var a=-1;for(var c=0;c<this.collectrec.length;c++){if(this.collectrec[c].id===g.id){a=c;break}}if(a===-1){return}if(b){b.onload=b.onerror=null}if(!this.all.elements[a]){return}var f=this.isSelected(a);this.all.replaceElement(a,e,true);if(f){this.selected.replaceElement(d,e);this.all.item(a).addClass(this.selectedClass)}this.updateIndexes(a,a)},onLoadData:function(m,d){if(!m){this.getStore().removeAll();return}var o=m.packages;var c=false,g;var b;if(!this.blFirstLoad){this.blFirstLoad=true}if(!o||0===o.length){this.getStore().removeAll();return}for(var h=0;h<o.length;h++){o[h].inst_type="1_installed";if(SYNO.SDS.PkgManApp.Utils.isBrokenStatus(o[h])){o[h].inst_type="0_broken";continue}}var n=function(e,i){if(e.inst_type!==i.inst_type){if(e.inst_type==="0_broken"){return -1}if(i.inst_type==="0_broken"){return 1}if(e.inst_type==="1_installed"){return -1}if(i.inst_type==="1_installed"){return 1}if(i.inst_type==="2_upgradable"){return -1}if(e.inst_type==="2_upgradable"){return 1}return 0}return e.name.toLowerCase().localeCompare(i.name.toLowerCase())};o=o.sort(n);var q;try{q=this.getStore().reader.readRecords({packages:o})}catch(l){}if(!q){return}o=q.records;if(d.blforcereload||(o.length!=this.getStore().getTotalCount())){c=true}else{for(var f=0;f<o.length;f++){var k=this.getStore().getById(o[f].id);if(!k){c=true;break}if(k.get("inst_type")!==o[f].data.inst_type){c=true;break}var a=false;for(var p in k.data){if(k.data[p]!=o[f].data[p]){a=true;k.data[p]=o[f].data[p]}}g=(this._getSynoServerObj().store.getById(o[f].id)||this._getOtherServerObj().store.getById(o[f].id));b=false;if(g&&g.get("blupgrade")){b=true}if(b!==k.data.blupgrade){k.data.blupgrade=b;c=true;break}if(a){k.commit()}}}if(c){this.getStore().loadData(m)}this.onFilterStore()}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.Recommend=Ext.extend(Ext.Container,{constructor:function(a){SYNO.SDS.PkgManApp.Utils._initWinWrappers.call(this,a);SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.Recommend",this);var b=this.fillConfig(a);SYNO.SDS.PkgManApp.Recommend.superclass.constructor.call(this,b)},fillConfig:function(a){this.dataView=new SYNO.SDS.PkgManApp.RecommendList({moudle:this});var b={cls:"syno-pkg-recommend",boxMinHeight:1,boxMinWidth:1,border:false,layout:"fit",items:[this.dataView],listeners:{scope:this,activate:this.onActivate,deactivate:this.onDeactivate}};Ext.apply(b,a);return b},onActivate:function(){this.dataView.onActivate.apply(this.dataView,arguments)},onDeactivate:function(){this.dataView.onDeactivate()}});SYNO.SDS.PkgManApp.RecommendList=Ext.extend(SYNO.SDS.PkgManApp.BasicDataView,{init:function(){SYNO.SDS.PkgManApp.RecommendList.superclass.init.apply(this,arguments);SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.RecommendList",this)},fillConfig:function(a){var b={cls:"syno-pkg-recommend-view",tpl:this.getTpl(),disabled:_S("demo_mode"),itemSelector:"div.syno-pkg-template",itemId:"dataview",store:this.getStore(),listeners:{scope:this,click:this.onClickPkgServerPanel,activate:this.onActivate,deactivate:this.onDeactivate}};Ext.apply(b,a);return b},onClickPkgServerPanel:function(g,h,a,i){if(_S("demo_mode")||g.disabled){return false}var k=i.getTarget();if(!k){return false}var f=Ext.get(k);if(!f){return false}var b=g.getStore().getAt(h);if(!b){return false}b=this._getSynoServerObj().store.getById(b.data.id);var c;if(f.is("span.x-item-disabled")){}else{if((c=f.findParent("span.syno-ux-button",7))){if(!Ext.fly(c).hasClass("x-item-disabled")){var d=b.data;if(SYNO.SDS.PkgManApp.Utils.mode.open===d.open){if(d.dsm_apps){var j=d.dsm_apps;if(!Ext.isArray(d.dsm_apps)){j=d.dsm_apps.split(" ")}if(j&&j[0]){SYNO.SDS.AppLaunch(j[0])}}else{if(d.url&&d.url[0]){window.open(d.url[0],"_blank","")}}return}else{SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr").onGotoNext(b.data);if(SYNO.SDS.PkgManApp.Utils.mode.more!==d.open){this._onClickSynoPkgActionBtn(b)}}}}else{if(f.findParent("div.syno-pkg-button-container",7)){}else{SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr").onGotoNext(b.data)}}}},getIcon:function(b){var c=SYNO.API.currentManager.getBaseURL("SYNO.Core.Package.Thumb.Server","get",1);var a=Ext.urlAppend(c,Ext.urlEncode(SYNO.API.EncodeParams({name:b.id,ver:b.version,link:!Ext.isEmpty(b.thumbnail_retina)?b.thumbnail_retina[1]:b.thumbnail[1],size:256})));return String.format('<img class="syno-pkg-icon-img" src={0} />',a)},getTilte:function(a){return this.encodedMsg(a.dname)},getBetaTitle:function(a){return a.beta?('<span class="syno-pkg-beta">'+this.encodedMsg(_T("pkgmgr","beta"))+"</span>"):""},getDesc:function(e,d){if(Ext.isCrhome){return this.encodedMsg(e.desc)}var a=54,c=246;if(d>SYNO.SDS.PkgManApp.Config.RECOMMEND_LIST_BIG_NUMBER){a=72;c=164}var f=e.desc,b;if(this.desclength&&f.length<this.desclength/2){return f}b=SYNO.SDS.PkgManApp.Utils.getEllipsis(c,a,f,this,this.desclength);if(!this.desclength||b.length>this.desclength){this.desclength=b.length}return b},getActionBtn:function(b){var c=this._getSynoServerObj().store.getById(b.id);var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView").getActionTemplate(c.data,false,true);return a.actiontext},getMatainer:function(a){return this.encodedMsg(a.maintainer||a.distributor)},getSmallTpl:function(b,a,c){return'<tr class="syno-pkg-upper-region syno-pkg-upper-region-'+(a-SYNO.SDS.PkgManApp.Config.RECOMMEND_LIST_BIG_NUMBER)+'"><td class="x-table-layout-cell"><span class="syno-pkg-icon">'+this.getIcon(b)+'</span></td></tr><tr><td class="x-table-layout-cell syno-pkg-name-container"><span class="syno-pkg-name sds-ellipsis">'+this.getTilte(b)+"</span>"+this.getBetaTitle(b)+'</td></tr><tr><td class="x-table-layout-cell"><span class="syno-pkg-matainer">'+this.getMatainer(b)+'</span></td></tr><tr><td class="x-table-layout-cell"><span class="syno-pkg-desc">'+this.getDesc(b,a)+'</span></td></tr><tr><td class="x-table-layout-cell syno-pkg-button-cell">'+this.getActionBtn(b)+"</td></tr>"},getBigTpl:function(b,a,c){return'<tr class="syno-pkg-upper-region syno-pkg-upper-region-'+a+'"><td class="x-table-layout-cell"><span class="syno-pkg-icon">'+this.getIcon(b)+'</span><span class="syno-pkg-name-container"><span class="syno-pkg-name">'+this.getTilte(b)+"</span>"+this.getBetaTitle(b)+'</span></td></tr><tr class="syno-pkg-bottom-region"><td class="x-table-layout-cell syno-pkg-desc-td"><span class="syno-pkg-desc-container"><span class="syno-pkg-desc">'+this.getDesc(b,a)+"</span></span>"+this.getActionBtn(b)+"</td></tr>"},getEachTpl:function(b,a,c){if(a<=SYNO.SDS.PkgManApp.Config.RECOMMEND_LIST_BIG_NUMBER){return this.getBigTpl(b,a,c)}return this.getSmallTpl(b,a,c)},getCls:function(c,b,d){if(b<=SYNO.SDS.PkgManApp.Config.RECOMMEND_LIST_BIG_NUMBER){return"syno-pkg-template"}var a=(((SYNO.SDS.PkgManApp.Config.RECOMMEND_LIST_BIG_NUMBER+1)===b)?"syno-pkg-template-first":"")+" syno-pkg-template syno-pkg-template-small";if(b==d){a+=" syno-pkg-template-last"}return a},getPreDiv:function(b,a,c){if(a<=SYNO.SDS.PkgManApp.Config.RECOMMEND_LIST_BIG_NUMBER){return'<div class="'+this.getCls(b,a,c)+'">'}return'<div class="syno-pkg-template-container"><div class="'+this.getCls(b,a,c)+'">'},getPostDiv:function(b,a,c){if(a<=SYNO.SDS.PkgManApp.Config.RECOMMEND_LIST_BIG_NUMBER){return"</div>"}return"</div></div>"},getTpl:function(){return new Ext.XTemplate('<tpl for=".">{[this.getPreDiv(values, xindex, xcount)]}<table width="100%" height="100%" cellspacing="0" class="x-table-layout"><tbody>{[this.getEachTpl(values, xindex, xcount)]}</tbody></table>{[this.getPostDiv(values, xindex, xcount)]}</tpl>',{compiled:true,disableFormats:true,getPreDiv:this.getPreDiv.createDelegate(this),getPostDiv:this.getPostDiv.createDelegate(this),getEachTpl:this.getEachTpl.createDelegate(this)})},onActivate:function(){var c=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SortButton");c.disable();var e=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.SearchField");e.enable();var b=this.moudle;var d=b.getEl();if(d&&d.isMasked()){var a=d.first("div.ext-el-mask-msg");if(a){a.center(d)}}},onDeactivate:function(){},getStore:function(){if(this.store){return this.store}this.store=new Ext.data.Store({autoLoad:true,autoDestroy:false,remoteSort:false,proxy:new Ext.data.MemoryProxy(),reader:new Ext.data.JsonReader({root:"recommend",id:"id"},[{name:"id"},{name:"dname"},{name:"version"},{name:"desc"},{name:"maintainer"},{name:"distributor"},{name:"thumbnail"},{name:"thumbnail_retina"},{name:"open"}])});return this.store},getEmptyText:function(){return _T("pkgmgr","non_available_packages")}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.CardPanel=Ext.extend(Ext.Panel,{constructor:function(b){SYNO.SDS.PkgManApp.Utils._initWinWrappers.call(this,b);SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.CardPanel",this);this.pathBar=new SYNO.SDS.PkgManApp.PathBar({cls:"syno-pkg-ux-pathtoolbar"});SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.PathBar",this.pathBar);var d=(function(){var f=0;a.items.each(function(h){if(true!==h.hidden){try{f+=h.getOuterSize().width}catch(i){}}});f-=this.pathBar.getWidth();var e=a.getWidth()-a.getResizeEl().getPadding("lr")-2;var g=e-f;if(g>0){this.pathBar.setWidth(g)}}).createDelegate(this);var a=new Ext.Toolbar({hidden:true,height:23,toolbarCls:"syno-pkg-toolbar",itemId:"topToolbar",enableOverflow:false,items:[this.pathBar],listeners:{buffer:100,show:d,resize:d,scope:this}});this.detail=new SYNO.SDS.PkgManApp.ViewDetail({itemId:"detail"});this.list=new SYNO.SDS.PkgManApp.ViewList({itemId:"list",forceLayout:true});this.grid=new SYNO.SDS.PkgManApp.ViewGrid({itemId:"grid",forceLayout:true});this.recommendlist=new SYNO.SDS.PkgManApp.Recommend({itemId:"recommend",forceLayout:true});var c={style:"padding-left:14px;padding-right:0px;padding-bottom:1px;",activeItem:0,layout:"card",tbar:a,items:[this.grid,this.list,this.detail,this.recommendlist],border:false,cls:"syno-pkg-card"};Ext.apply(c,b);SYNO.SDS.PkgManApp.CardPanel.superclass.constructor.call(this,c)}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.PathBar=Ext.extend(Ext.BoxComponent,{activeButton:null,enableScroll:true,scrollIncrement:0,scrollRepeatInterval:400,scrollDuration:0.35,animScroll:true,buttonWidthSet:false,allowDomMove:false,constructor:function(a){SYNO.SDS.PkgManApp.PathBar.superclass.constructor.apply(this,arguments)},addPathButton:function(f,e,c,g,b,d,a){return this.addButton(f,e,c,g,b,d,a)},updatePathButton:function(e,d,c,f,b,a){return this.updateButton(e,d,c,f,b,a)},addPathButtons:function(c){var b=(this.items.length<c.length)?c.length:this.items.length;var d=c.length-1;for(var a=0;a<b;a++){if(a<this.items.length&&a<c.length){this.updatePathButton(a,c[a].text,c[a].tooltip,c[a].callback,c[a].scope,a===d)}else{if(a<c.length){this.addPathButton(this.items.length,c[a].text,c[a].tooltip,c[a].callback,c[a].scope,a===0,a===d)}else{this.removePathButtons(a,b);break}}}this.setActiveButton(this.items[this.items.length-1])},removePathButtons:function(b,a){this.removeButtons(b,a)},onRender:function(){SYNO.SDS.PkgManApp.PathBar.superclass.onRender.call(this,arguments);this.mon(this,"resize",this.delegateUpdates);this.items=[];var a=Ext.get(this.el);this.stripWrap=a.createChild({cls:"ux-pathbuttons-strip-wrap",cn:{tag:"ul",cls:"ux-pathbuttons-strip"}});this.stripSpacer=a.createChild({cls:"ux-pathbuttons-strip-spacer"});this.strip=new Ext.Element(this.stripWrap.dom.firstChild);this.edge=this.strip.createChild({tag:"li",cls:"ux-pathbuttons-edge"});this.strip.createChild({cls:"x-clear"});this.addEvents("updatepath")},addButton:function(c,f,i,e,h,b,g){var d=this.strip.createChild({tag:"li"},this.edge);var a=new SYNO.SDS.PkgManApp.PathBar.PathButton(this,d,c,f,i,e,h,b,g);this.items.push(a);if(!this.buttonWidthSet){this.lastButtonWidth=a.container.getWidth()}this.addManagedComponent(a);return a},updateButton:function(f,e,d,g,c,b){var a=this.items[f];a.updateButton(e,d,g,c,b)},removeButtons:function(f,e){var a;var c;for(var b=f;b<e;b++){c=this.items[b];a=document.getElementById(c.container.id);this.removeManagedComponent(c);c.purgeListeners();c.destroy();a.parentNode.removeChild(a)}var d=[];for(b=0;b<f;b++){d.push(this.items[b])}this.items=d;this.delegateUpdates()},setActiveButton:function(a){this.activeButton=a;this.delegateUpdates()},delegateUpdates:function(){if(this.enableScroll&&this.rendered){this.onAutoScroll()}},onAutoScroll:function(){var e=this.items.length;var c=this.el.dom.clientWidth;var d=this.stripWrap;var b=d.dom.offsetWidth;var f=this.getScrollPos();var a=this.edge.getOffsetsTo(this.stripWrap)[0]+f;if(!this.enableScroll||e<1||b<20){return}d.setWidth(c);if(a<=c){d.dom.scrollLeft=0;if(this.scrolling){this.scrolling=false;this.el.removeClass("x-pathbuttons-scrolling");this.scrollLeft.hide();this.scrollRight.hide()}}else{if(!this.scrolling){this.el.addClass("x-pathbuttons-scrolling")}c-=d.getMargins("lr");d.setWidth(c>20?c:20);if(!this.scrolling){if(!this.scrollLeft){this.createScrollers()}else{this.scrollLeft.show();this.scrollRight.show()}}this.scrolling=true;if(f>(a-c)){d.dom.scrollLeft=a-c}else{this.scrollToButton(this.activeButton,false)}this.updateScrollButtons()}},createScrollers:function(){var c=this.el.dom.offsetHeight;var a=this.el.insertFirst({cls:"ux-pathbuttons-scroller-left"});a.setHeight(c);a.addClassOnOver("ux-pathbuttons-scroller-left-over");this.leftRepeater=new Ext.util.ClickRepeater(a,{interval:this.scrollRepeatInterval,handler:this.onScrollLeft,scope:this});this.scrollLeft=a;var b=this.el.insertFirst({cls:"ux-pathbuttons-scroller-right"});b.setHeight(c);b.addClassOnOver("ux-pathbuttons-scroller-right-over");this.rightRepeater=new Ext.util.ClickRepeater(b,{interval:this.scrollRepeatInterval,handler:this.onScrollRight,scope:this});this.scrollRight=b},getScrollWidth:function(){return this.edge.getOffsetsTo(this.stripWrap)[0]+this.getScrollPos()},getScrollPos:function(){return parseInt(this.stripWrap.dom.scrollLeft,10)||0},getScrollArea:function(){return parseInt(this.stripWrap.dom.clientWidth,10)||0},getScrollAnim:function(){return{duration:this.scrollDuration,callback:this.updateScrollButtons,scope:this}},getScrollIncrement:function(){return(this.scrollIncrement||this.lastButtonWidth+2)},scrollToButton:function(e,a){if(!e.el.dom){return}e=e.el.dom.parentNode;if(!e){return}var c=e;var g=this.getScrollPos(),d=this.getScrollArea();var f=Ext.fly(c).getOffsetsTo(this.stripWrap)[0]+g;var b=f+c.offsetWidth;if(f<g){this.scrollTo(f,a)}else{if(b>(g+d)){this.scrollTo(b-d,a)}}},scrollTo:function(b,a){this.stripWrap.scrollTo("left",b,a?this.getScrollAnim():false);if(!a){this.updateScrollButtons()}},onScrollRight:function(){var a=this.getScrollWidth()-this.getScrollArea();var c=this.getScrollPos();var b=Math.min(a,c+this.getScrollIncrement());if(b!=c){this.scrollTo(b,this.animScroll)}},onScrollLeft:function(){var b=this.getScrollPos();var a=Math.max(0,b-this.getScrollIncrement());if(a!=b){this.scrollTo(a,this.animScroll)}},updateScrollButtons:function(){var a=this.getScrollPos();this.scrollLeft[a===0?"addClass":"removeClass"]("ux-pathbuttons-scroller-left-disabled");this.scrollRight[a>=(this.getScrollWidth()-this.getScrollArea())?"addClass":"removeClass"]("ux-pathbuttons-scroller-right-disabled")}});SYNO.SDS.PkgManApp.PathBar.PathButton=function(a,b,f,i,l,h,k,d,g){var c=d?this.firstBtnCls:"";var j=g?this.lastBtnCls:"";var e=Ext.isFunction(h)?h:Ext.emptyFn;SYNO.SDS.PkgManApp.PathBar.PathButton.superclass.constructor.call(this,{height:20,text:i,itemId:f,renderTo:b,tooltip:l,clickEvent:"mousedown",listeners:{click:{fn:e,scope:k||this}},template:new Ext.Template('<table cellspacing="0" class="x-btn '+c+" "+j+' {3}"><tbody><tr>','<td class="ux-pathbutton-left"></td>','<td class="ux-pathbutton-center"><em class="{5}" unselectable="on">','<button class="x-btn-text {2}" type="{1}">{0}</button>',"</em></td>",'<td class="ux-pathbutton-right"></td>',"</tr></tbody></table>")});if(d){this.setIconClass("syno-pkg-home-icon")}};Ext.extend(SYNO.SDS.PkgManApp.PathBar.PathButton,Ext.Button,{firstBtnCls:"x-first-btn",lastBtnCls:"x-last-btn",updateButton:function(e,d,f,c,b){var a=Ext.isFunction(f)?f:Ext.emptyFn;this.purgeListeners();this.mon(this,"click",a,c||this);this.setText(e);this.setTooltip(d);if(b){this.addClass(this.lastBtnCls)}else{this.removeClass(this.lastBtnCls)}}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.MainPanel=Ext.extend(Ext.Panel,{constructor:function(a){SYNO.SDS.PkgManApp.Utils._initWinWrappers.call(this,a);var b=this.fillConfig(a);SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.MainPanel",this);SYNO.SDS.PkgManApp.MainPanel.superclass.constructor.call(this,b)},fillConfig:function(a){this.listPanel=new SYNO.SDS.PkgManApp.ListPanel({itemId:"list",region:"west"});this.mainCardPanel=new SYNO.SDS.PkgManApp.CardPanel({itemId:"grid",region:"center"});var b={border:false,layout:"border",cls:"syno-pkg-panel",bodyCssClass:"syno-pkg-panel-body",width:800,height:500,monitorResize:true,items:[this.listPanel,{xtype:"panel",border:false,frame:false,region:"center",layout:"fit",tbar:this.createTBar(),items:[this.mainCardPanel]}]};Ext.apply(b,a);return b},createTBar:function(){var a=[{xtype:"container",width:18},{xtype:"syno_button",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("pkgmgr","install_upgrade_title"),handler:function(){this._prepareVolume(3)},scope:this},{xtype:"syno_button",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","refresh"),handler:this._onRefresh,scope:this},{xtype:"syno_button",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("download","download_table_heading_setting"),handler:function(){var c=new SYNO.SDS.PkgManApp.SettingDialog({owner:SYNO.SDS.PkgManApp.Window});c.show()},scope:this},"->",this.getSortButton(),{xtype:"container",width:8}];var b=new Ext.Toolbar({cls:"syno-pkg-win-toolbar syno-sds-container-btn",items:a});return b},getSortButton:function(){return this.sortBtn?this.sortBtn:(this.sortBtn=new SYNO.SDS.PkgManApp.SortButton())}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.PathHistoryMgr=Ext.extend(Ext.util.Observable,{init:function(){this.objHistory={};Ext.each(SYNO.SDS.PkgManApp.Utils.SEC_LIST,function(a){this.pushHistory(a,{id:a},0)},this)},constructor:function(a){this.init();SYNO.SDS.PkgManApp.Window.addPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr",this);SYNO.SDS.PkgManApp.PathHistoryMgr.superclass.constructor.call(this,a)},onGotoNext:function(b,a){var c=this.getCurId();if(this.pushHistory(c,{id:c,data:SYNO.Util.copy(b||{})},a)){this.onGotoPanel(c)}},onGotoBack:function(a){if(0===a){return}if(!a){var b=(this.getHistoryInfo(this.curID,this.objHistory[this.curID].length-2));if(b){a=b.index}else{a=0}}this.onGotoPanel(this.curID,a)},getCurIndex:function(){if(this.objHistory[this.curID]){var a=this.getHistoryInfo(this.curID,this.objHistory[this.curID].length-1);if(a){return a.index}}return 0},getCfg:function(b,e,a){var d=SYNO.SDS.PkgManApp.Utils.SEC_CFG[e].data;if(!d){return false}for(var c=a;c<d.length;c++){if(d[c].subtype===b){break}}return SYNO.Util.copy(d[c])},onSetGotoCfg:function(d,c,b){this.oldID=this.curID||d;this.curID=d;if(Ext.isDefined(c)){var a=[];Ext.each(this.objHistory[d],function(e){if(e.index>c){return false}if(!Ext.isFunction(b)||b(e)){a.push(e)}if(e.index===c){return false}});this.objHistory[d]=SYNO.Util.copy(a)}},onGotoPanel:function(c,a){if(-1===SYNO.SDS.PkgManApp.Utils.SEC_LIST.indexOf(c)){c=(SYNO.SDS.isNSM||SYNO.SDS.isNVR)?"recommend":"all"}if(Ext.isDefined(a)){var b=SYNO.SDS.PkgManApp.Utils.SEC_CFG[c].data;if(!b){return false}}this.onSetGotoCfg(c,a);this.setMainItem(c);this.updatePathBar();SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ListPanel").selectItemById(c)},pushHistory:function(d,c,a){if(!this.objHistory[d]){this.objHistory[d]=[]}var b=SYNO.SDS.PkgManApp.Utils.SEC_CFG[d].data;if(!b){return false}if(!Ext.isDefined(a)){a=this.getHistoryInfo().index+1}if(!b[a]){return false}this.objHistory[d][this.objHistory[d].length]=Ext.apply(SYNO.Util.copy(b[a]),SYNO.Util.copy(c||{}));return true},getCardPanel:function(){return SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.CardPanel")},setMainItem:function(d){var a=this.objHistory[d][this.objHistory[d].length-1].layoutCfg;var c=this.getCardPanel().layout.activeItem,b=SYNO.SDS.PkgManApp.Window.getPanelScope(a);this.fireEvent("beforeactivate",this,b,this.objHistory[d][this.objHistory[d].length-1]);if(c!==b){this.oldActiveItem=c;this.getCardPanel().layout.setActiveItem(b)}else{if(b.onActivate){b.onActivate()}}this.fireEvent("activate",this,b,this.objHistory[d][this.objHistory[d].length-1])},getLastActiveItem:function(){return this.oldActiveItem||this.getActiveItem()},getActiveItem:function(){return this.getCardPanel().layout.activeItem},getOldId:function(){return this.oldID||SYNO.SDS.PkgManApp.Utils.SEC_LIST[0]},getCurId:function(){return this.curID||SYNO.SDS.PkgManApp.Utils.SEC_LIST[0]},getCurClass:function(){var b=this.getCurId;var a=SYNO.SDS.PkgManApp.Utils;switch(b){case a._INSTALLED_ID:return a._INSTALLED_CLASS;case a._CAT_COMMUNITY_ID:return a._SYNO_SERVER_CLASS;default:return a._COMMUNITY_CLASS}},getHistoryInfo:function(b,a){if(!Ext.isDefined(b)){b=this.getCurId()}if(!Ext.isDefined(a)){a=this.objHistory[b].length-1}return this.objHistory[b][a]},onClickBtn:function(a){this.onGotoPanel(a.id,a.index)},updatePathBar:function(){var b=this.getHistoryInfo();if("SYNO.SDS.PkgManApp.ViewDetail"===b.layoutCfg){this.getCardPanel().getTopToolbar().show();var a=[{text:_T("common","back"),callback:this.onClickBtn.createDelegate(this,[this.getHistoryInfo(this.curID,0)])}];SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathBar").addPathButtons(a)}else{this.getCardPanel().getTopToolbar().hide()}this.getCardPanel().doLayout()}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.Instance=Ext.extend(SYNO.SDS.AppInstance,{appWindowName:"SYNO.SDS.PkgManApp.MainWindow",constructor:function(){SYNO.SDS.PkgManApp.Utils.init();SYNO.SDS.PkgManApp.Instance.superclass.constructor.apply(this,arguments)}});SYNO.SDS.PkgManApp.MainWindow=Ext.extend(SYNO.SDS.AppWindow,{constructor:function(b){this.panellist={};Ext.apply(this,SYNO.SDS.PkgManApp.Action);Ext.apply(this,SYNO.SDS.PkgManApp.ActionUtils);SYNO.SDS.PkgManApp.Window=this;var c=this.fillConfig(b);SYNO.SDS.PkgManApp.MainWindow.superclass.constructor.call(this,c);var a=this.body.mask();a.setOpacity(1);this.loadCfg(function(){this.delayConstructor(c)});this.mon(SYNO.SDS.StatusNotifier,"syncGroupSettings",function(){var d=(SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView"))?0:80;(function(){if(SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView")){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView").onSyncGroupSettings()}}).defer(d);this.fireEvent("pollinginstpage")},this);this.mon(this,"pollinginstpage",this.onRestartPollingInst,this,{buffer:500})},loadCfg:function(a){a=a||Ext.emptyFn;this.sendWebAPI({api:"SYNO.Core.Package.Info",method:"get",version:1,scope:this,callback:function(c,b){if(!c||!b||Ext.isEmpty(b.myPayBaseURL)){if(!b.code){this.getMsgBox().alert(this.title,_T("common","commfail"))}else{this.getMsgBox().alert(this.title,SYNO.API.getErrorString(b.code))}}else{Ext.apply(SYNO.SDS.PkgManApp.Config,b);Ext.apply(SYNO.SDS.PkgManApp.Config,{myDSURL:SYNO.SDS.PkgManApp.Config.myPayBaseURL+"/api/purchase5_1.html"});this.checkOtherSever()}a.call(this)}})},checkOtherSever:function(){var a=SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ListPanel");if(a){a.checkOtherSever()}},isAlwaysOnTop:function(){return(this.modalWin&&this.modalWin.length!==0&&this.modalWin instanceof SYNO.SDS.PkgManApp.MyDSDialog)},fillConfig:function(b){var d=880;var a=360;var c={dsmStyle:"v5",layout:"fit",cls:"syno-pkg-win",minWidth:d,minHeight:a,boxMinHeight:a,boxMinWidth:d,width:1033,height:580,html:""};Ext.apply(c,b);return c},delayConstructor:function(a){if(this.isDestroyed){return}if(!this.rendered){this.delayConstructor.defer(10,this,arguments);return}this.body.unmask();this.getPathMgr();var b=[];b.push(this.mainpanel=new SYNO.SDS.PkgManApp.MainPanel({header:false,itemId:"main"}));this.removeAll();this.add(b);this.doLayout();this.checkOtherSever()},onRestartPollingInst:function(){if(this.isDestroyed){return}this.pollingTask.reqId=null;this.pollingTask.restart(true)},_getAbsoluteURL:function(a,b){if(!a){return this.jsConfig.jsBaseURL}return b?String.format("{0}/{1}/{2}",this.jsConfig.jsBaseURL,b,a):(String.format("{0}/{1}",this.jsConfig.jsBaseURL,a))},_getEllipsis:function(c,a,d,b){return SYNO.SDS.PkgManApp.Utils._getEllipsis(c,a,d,this,b)},addPanelScope:function(b,a){this.panellist[b]=a},getPanelScope:function(a){if(a in this.panellist){return this.panellist[a]}return null},getPathMgr:function(){if(this.pathMgr){return this.pathMgr}return(this.pathMgr=new SYNO.SDS.PkgManApp.PathHistoryMgr())},onRequest:function(a){SYNO.SDS.PkgManApp.MainWindow.superclass.onRequest.apply(this,arguments);if(!a||!a.action){return}if(SYNO.SDS.PkgManApp.isRunningPkgForeground){SYNO.SDS.Desktop.getMsgBox().alert("title",_T("pkgmgr","busy_alert"));return}this.beforeAction(a)},onOpen:function(e){SYNO.SDS.PkgManApp.MainWindow.superclass.onOpen.apply(this,arguments);this.createPollingTask(e);var d=this.getTaskRunner();this.mon(d,"beforestart",function(h){if(this.pollingTask===h&&this.isNeedForceReload()){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView").onMaskPanel();this.mon(h,"callback",function(){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView").onUnmaskPanel()},this,{single:true});h.reqConfig.params.blforcereload=true;this.setNeedForceReload(false)}},this);if(!_S("demo_mode")){var b=false,g,c=500,a=205;if(true!==this.appInstance.getUserSettings(SYNO.SDS.PkgManApp.Config.termofservice_4_2)){b=true;g=String.format(_T("pkgmgr","termsofservice_new_desc"),String.format('<a href="{0}" target="_blank" class="pathlink">{1}</a>',SYNO.SDS.PkgManApp.TOFURL,_T("pkgmgr","termsofservice")))}if(true!==this.appInstance.getUserSettings(SYNO.SDS.PkgManApp.Config.termofservice)){b=true;g=String.format(_T("pkgmgr","termsofservice_desc"),String.format('<a href="{0}" target="_blank" class="pathlink">{1}</a>',SYNO.SDS.PkgManApp.TOFURL,_T("pkgmgr","termsofservice")));if("cht"===_S("lang")||"chs"===_S("lang")){a=175;c=450}}if(b){var f=new SYNO.SDS.PkgManApp.TermConfirmDialog({owner:this,msg:g,width:c,height:a});f.show()}}},getPollingInterval:function(){if(this.blProcessing){return 3000}if(this.modalWin&&this.modalWin[0]&&this.modalWin[0].jsConfig&&this.modalWin[0].jsConfig.jsID==="SYNO.SDS.PkgManApp.WizardDialog"){return 3000}return 15000},createPollingTask:function(a){if(this.pollingTask){return this.pollingTask}if(!this.firstLoadInstPkg){this.setStatusBusy()}this.pollingTask=this.addWebAPITask({id:"pkgManPollingTask",interval:this.getPollingInterval.createDelegate(this),api:"SYNO.Core.Package",method:"list",version:1,params:{additional:["description","description_enu","icon","beta","distributor","distributor_url","maintainer","maintainer_url","url","dsm_apps","help_url","report_beta_url","support_center","startable","status","installed_info","support_url","is_uninstall_pages","install_type","autoupdate","silent_upgrade","installing_progress"]},callback:function(d,b,c){if(!this.firstLoadInstPkg){this.clearStatusBusy.defer(100,this)}if(this.isDestroyed){this.onStopPolling();return}if(!d&&(!b||b.isTimeout||b.isAbort||b.statusText==="communication failure")){this.fireEvent.defer(3000,this,["pollinginstpage"]);return}if(!this.firstLoadInstPkg){this.firstLoadInstPkg=true}this.onProcessPolling(d,b,c);if(a.action){this.beforeAction(a);a=null}},scope:this})},onProcessPolling:function(h,m,t){if(!m||!m.packages){return}var e=this._getInstalledStore(),o=false;var k=e.reader.readRecords(m);var a=k.records,s,d=false,b=false;this.blProcessing=false;if(k.records.length!=e.getTotalCount()){o=true}else{for(s=0;s<a.length;s++){var p=a[s].id,u=e.getById(p),f,r,q,n=false,i,l=false;if(!u){o=true;break}i=a[s];f=i.get("progress");r=this._IsInstalling(i.data);q=i.get("status");l=u.get("progress")!==f||u.get("status")!==q;for(var v in u.data){if(u.data.hasOwnProperty(v)){if(u.data[v]!==i.get(v)){u.data[v]=i.get(v)}n=true}}if(n){u.commit()}if(l){if(!n){u.data.status=i.get("status");u.data.progress=f;u.commit()}var c=this._getSynoServerObj().store.getById(p)||this._getOtherServerObj().store.getById(p);if(c){if(c.data.info){c.data.info.installing=r}else{if(this._getSynoServerObj().store.getById(p)){d=true}else{b=true}}c.data.status=q;c.data.progress=f;c.commit()}this.fireEvent("pollingprogress",this,i.data,p,f,q)}if(r||this._GetProcessStatus(i.data.status).blProcessing||f>0){this.fireEvent("pollingprogress",this,i.data,p,f,q);this.blProcessing=true}}}if(o){for(s=0;s<a.length;s++){if(this._IsInstalling(a[s].data)){this.blProcessing=true;break}}var g=(SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView"))?0:80;if(!h){(function(){if(SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView")){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView").onExceptionData(m,t)}}).defer(g)}else{(function(){if(SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView")){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView").onLoadData(m,t)}}).defer(g)}}else{if(SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView")){SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.ViewGridDataView").onFilterStore(m,t)}}if(this.blProcessing){if(d){this._getSynoServerObj().store.reload()}if(b){this._getOtherServerObj().store.reload()}}},onStopPolling:function(){if(this.pollingTask){this.pollingTask.stop()}},setNeedForceReload:function(a){this.needForceReload=!!a},isNeedForceReload:function(){return this.needForceReload},onClose:function(){if(this.isUpdating()&&!(window.confirm(_T("pkgmgr","close_updateall_confirm")))){return false}this.pollingTask.remove();if(this.polling_background_pkg){this.polling_background_pkg.remove()}SYNO.SDS.PkgManApp.MainWindow.superclass.onClose.apply(this,arguments)},onActivate:function(){this.fireEvent("pollinginstpage");SYNO.SDS.PkgManApp.MainWindow.superclass.onActivate.apply(this,arguments)},onDeactivate:function(){if(!this.isVisible()){this.pollingTask.stop()}SYNO.SDS.PkgManApp.MainWindow.superclass.onDeactivate.apply(this,arguments)},isUpdating:function(){return(!this._IsInsting_Background())},delayedMask:function(b,a,d,c){this.mask(0,d,c);this.setMaskMsgVisible(false);this.setMaskOpacity(b)},setStatusBusy:function(c,b,a){c=c||{};Ext.applyIf(c,{text:_T("common","loading"),iconCls:"x-mask-loading"});b=b||0.4;a=0;this.delayedMask(b,a,c.text,c.iconCls)},beforeAction:function(d){var c=this.getPathMgr();c.onGotoPanel("all");var a=this.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView");var b=a.synoObj.store;this.installData=d;this.setStatusBusy();if(0===b.getTotalCount()||b.loading){this.mon(b,"load",this.onLoadCallBack,this);this.mon(b,"exception",this.onLoadExceptionCallBack,this);b.reload()}else{this.clearStatusBusy();this.doAction(d,b)}},doAction:function(b,a){if(!b){return}if("open"===b.action){this.doOpenAction(b,a)}else{if("install"==b.action){this.doInstallAction(b,a)}}},onLoadCallBack:function(a,b){this.clearStatusBusy();this.mun(a,"load",this.onLoadCallBack,this);this.mun(a,"exception",this.onLoadExceptionCallBack,this);this.doAction(this.installData,a)},onLoadExceptionCallBack:function(a){this.clearStatusBusy();this.mun(a,"load",this.onLoadExceptionCallBack,this);this.mun(a,"exception",this.onLoadExceptionCallBack,this)},doOpenAction:function(c,b){var d=b.getById(c.packages[0]);var a=this.getPanelScope("SYNO.SDS.PkgManApp.ViewListDataView");if(d){a.onGotoNext(d)}},doInstallAction:function(d,b){var c=0,a=[],f="";for(c=0;c<d.packages.size();c++){var e=b.getById(d.packages[c]);if(e&&this._isQuickInstll(e.data)&&!this._isFirstBuy(e)&&SYNO.SDS.PkgManApp.Utils.mode.open!==e.data.open){this._onClickSynoPkgActionBtn(e,true)}else{if(e&&SYNO.SDS.PkgManApp.Utils.mode.open!==e.data.open){a.push(e)}}}if(1===a.length){this._onClickSynoPkgActionBtn(a[0],true)}if(1<a.length){for(c=1;c<a.length;c++){f=f+a[c].id+" "}f=String.format(_T("pkgmgr","auto_install"),a[0].id,f);this.getMsgBox().alert("title",f,function(){this._onClickSynoPkgActionBtn(a[0],true)},this)}}});