/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.namespace("SYNO.SDS.App.SuggestDataScrubbingMessageApp");if(!Array.prototype.filter){Array.prototype.filter=function(c){if(this===void 0||this===null){throw new TypeError()}var f=Object(this);var a=f.length;if(typeof c!=="function"){throw new TypeError()}var e=[];var b=arguments.length>=2?arguments[1]:void 0;for(var d=0;d<a;d++){if(d in f){var g=f[d];if(c.call(b,g,d,f)){e.push(g)}}}return e}}if(!Array.prototype.reduce){Array.prototype.reduce=function(e){if(this===null){throw new TypeError("Array.prototype.reduce called on null or undefined")}if(typeof e!=="function"){throw new TypeError(e+" is not a function")}var c=Object(this),a=c.length,b=0,d;if(arguments.length==2){d=arguments[1]}else{while(b<a&&!(b in c)){b++}if(b>=a){throw new TypeError("Reduce of empty array with no initial value")}d=c[b++]}for(;b<a;b++){if(b in c){d=e(d,c[b],b,c)}}return d}}if(!Array.prototype.map){Array.prototype.map=function(i,h){var b,a,c;if(this===null){throw new TypeError(" this is null or not defined")}var e=Object(this);var f=e.length;if(typeof i!=="function"){throw new TypeError(i+" is not a function")}if(arguments.length>1){b=h}a=new Array(f);c=0;while(c<f){var d,g;if(c in e){d=e[c];g=i.call(b,d,c,e);a[c]=g}c++}return a}}if(!Array.prototype.some){Array.prototype.some=function(c){if(this===null){throw new TypeError("Array.prototype.some called on null or undefined")}if(typeof c!=="function"){throw new TypeError()}var e=Object(this);var a=e.length;var b=arguments.length>=2?arguments[1]:void 0;for(var d=0;d<a;d++){if(d in e&&c.call(b,e[d],d,e)){return true}}return false}}SYNO.SDS.App.SuggestDataScrubbingMessageApp.Instance=Ext.extend(SYNO.SDS.AppInstance,{shouldNotifyMsg:function(a,b){this.win.show();return false},initInstance:function(c){if(!this.win){this.win=new SYNO.SDS.App.SuggestDataScrubbingMessageApp.RaidScan({appInstance:this});this.addInstance(this.win);this.win.setTitle(_T("volume","data_scrubbing_suggestion"))}var b=["alpine","avoton","bromolow","cedarview","braswell","apollolake","denverton"];var a=_D("unique").split("_")[1];if(-1!==b.indexOf(a)){this.getSpaceForScrubbing()}},shouldSuggestDataScrubbing:function(a){var b=new Date();return b.getTime()>a.getTime()},scheduleNextSuggestion:function(){this.sendWebAPI({api:"SYNO.Storage.CGI.Check",method:"schedule_next_suggestion",version:1,scope:this,callback:function(b,a){if(b){this.updateRAIDList()}}})},disableSuggestion:function(){this.sendWebAPI({api:"SYNO.Storage.CGI.Check",method:"disable_suggestion",version:1})},updateRAIDList:function(){this.sendWebAPI({api:"SYNO.Storage.CGI.Check",method:"update_raid_list",version:1})},getSpaceForScrubbing:function(){this.sendWebAPI({api:"SYNO.Storage.CGI.Check",method:"get_space_for_scrubbing",version:1,scope:this,callback:function(b,a){if(b){this.suggestDataScrubbing(a)}}})},suggestDataScrubbing:function(d){var b=new Date(parseInt(_S("scheduledDataScrubbingTimeStamp"),10)*1000);if(this.shouldSuggestDataScrubbing(b)){var f=_S("scheduledDataScrubbingRAIDs").filter(function(h){var g=new Date(parseInt(h.time,10)*1000);g.setMonth(g.getMonth()+1);return this.shouldSuggestDataScrubbing(g)},this);var a=d.filter(function(g){return f.some(function(h){return h.name===g.raidDev})});var c=a.filter(function(g){return 4===g.type}).reduce(function(h,g){h[g.raidDev]=g.space;return h},{});var e=a.filter(function(g){return 4!==g.type}).reduce(function(h,g){if(undefined===c[g.raidDev]){c[g.raidDev]=""}if(undefined===h[c[g.raidDev]]){h[c[g.raidDev]]=[]}if(-1===h[c[g.raidDev]].indexOf(g.space)){h[c[g.raidDev]].push(g.space)}return h},{});this.spaceList=Object.keys(e).map(function(g){if(0===g.length||1000<=parseInt(g.split("_")[1],10)){return e[g].map(function(h){return SYNO.SDS.Utils.StorageUtils.SpaceIDParser(h).str}).sort().join(", ")}else{return String.format("{0} [{1}]",SYNO.SDS.Utils.StorageUtils.SpaceIDParser(g).str,e[g].map(function(h){return SYNO.SDS.Utils.StorageUtils.SpaceIDParser(h).str}).sort().join(", "))}});if(0!==this.spaceList.length){this.win.show()}else{this.scheduleNextSuggestion()}}},onOpen:function(a){this.initInstance(a)}});SYNO.SDS.App.SuggestDataScrubbingMessageApp.RaidScan=Ext.extend(SYNO.SDS.AppWindow,{ignoreHandler:function(){this.hide();if(Ext.getCmp(this.spaceScrubbingDisableID).getValue()){this.appInstance.disableSuggestion()}else{this.appInstance.scheduleNextSuggestion()}},applyHandler:function(){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance");this.hide();if(Ext.getCmp(this.spaceScrubbingDisableID).getValue()){this.appInstance.disableSuggestion()}else{this.appInstance.scheduleNextSuggestion()}},constructor:function(b){this.appInstance=b.appInstance;this.panel=this.createPanel();this.form=this.panel.getForm();var a=Ext.apply({title:_T("volume","data_scrubbing_suggestion"),width:480,autoHeight:true,minimizable:false,maximizable:false,showHelp:false,resizable:false,cls:"syno-diskremap",items:[this.panel],buttons:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","alt_apply"),handler:this.applyHandler,scope:this},{xtype:"syno_button",text:_T("common","alt_ignore"),handler:this.ignoreHandler,scope:this}]},b);SYNO.SDS.App.SuggestDataScrubbingMessageApp.RaidScan.superclass.constructor.call(this,a);this.on("beforeclose",function(c){this.hide();return false});this.on("beforeshow",function(c){Ext.getCmp(this.spaceScrubbingListID).setValue(this.appInstance.spaceList.sort().join(", "));return true})},createPanel:function(){var a={border:false,items:[{xtype:"syno_displayfield",value:_T("volume","data_scrubbing_explanation")},{xtype:"syno_displayfield",id:this.spaceScrubbingListID=Ext.id(),value:""},{xtype:"syno_checkbox",id:this.spaceScrubbingDisableID=Ext.id(),checked:false,boxLabel:_T("volume","data_scrubbing_disable")}]};return new Ext.form.FormPanel(a)}});