/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.HA.HABindWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",port:null,is_https_port:null,hostname:null,binding_progress_desc:null,binding_progress:null,PollID:null,PollTask:null,groupInfo:null,PanelWelcome:null,PanelNodeSetup:null,PanelSummary:null,constructor:function(c){var a=SYNO.SDS.HA;this.appWin=c.owner;this.PanelWelcome=new SYNO.SDS.Wizard.WelcomeStep({headline:_TT("SYNO.SDS.HA.Instance","wizard","welcome_title"),description:this.getWelcomeDesc(),itemId:"welcome",nextId:"nodesetup",cls:"synoha-list-style",owner:this,getNext:function(){this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Bind.Wizard",version:1,method:"wizard_first_check",params:{},callback:function(g,e,f,d){this.owner.clearStatusBusy();if(!g){SYNO.SDS.HA.ShowRespErrMsg(this.owner,e.code,true);SYNO.Debug("Ajax load failure "+e)}else{if(!e.success){SYNO.SDS.HA.ShowErrMsg(this.owner,e.errinfo,SYNO.SDS.HA.DefaultBindingErrorString);return}this.owner.goNext(this.nextId)}},scope:this});return false}});this.PanelNodeSetup=new a.NodeSetupPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","nodesetup_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","nodesetup_desc"),itemId:"nodesetup",nextId:"summary",header:false,owner:this});this.PanelSummary=new SYNO.SDS.Wizard.SummaryStep({autoScroll:true,headline:_T("localbkpwizard","summary_title"),description:_T("wizcommon","summary_descr"),itemId:"summary",nextId:null,getNext:function(){this.owner.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","warning_binding_remote"),function(d){if("yes"===d){this.owner.applySetting();return false}return false},this);return false},owner:this});var b=[this.PanelWelcome,this.PanelNodeSetup,this.PanelSummary];this.callParent([Ext.apply({title:_TT("SYNO.SDS.HA.Instance","wizard","wizard_title"),width:670,height:500,steps:b},c)])},getWelcomeDesc:function(){var b=[_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_step_setting_passive")];var a=[_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning_not_support"),_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning_if_constrain"),_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning_heartbeat_constrain"),_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning_ha_if_constrain"),_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning_ddsm_support")];var c=SYNO.SDS.HA.MakeOL(b)+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning"),SYNO.SDS.HA.MakeUL(a));return String.format(_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc"),c)},genApplyParams:function(){var a={};a.mode="bind_remote";a.is_hybrid=this.groupInfo.is_hybrid;a.group_name=this.groupInfo.group_name;a.model0=this.groupInfo.model0;a.model1=this.groupInfo.model1;a.lan_num=this.groupInfo.lan_num;a.remote_address=SYNO.SDS.HA.GetServerIP(this.PanelNodeSetup.getForm().findField("server").getRawValue());return a},updateBindingProgress:function(b,a){this.el.unmask();if(b.success){this.binding_progress_desc=b.binding_progress_desc;this.binding_progress=b.binding_progress}else{this.binding_progress_desc="stage_unknown"}},checkActivateEnvironmentDone:function(d,b,c,a){if(!b.success){SYNO.SDS.HA.ShowErrMsg(this,b.errinfo,SYNO.SDS.HA.DefaultBindingErrorString);return}this.sendRequest(b.activate_data)},bindRemoteDone:function(d,b,c,a){if(!b.success){SYNO.SDS.HA.ShowErrMsg(this,b.errinfo,SYNO.SDS.HA.DefaultBindingErrorString);return}SYNO.SDS.StatusNotifier.fireEvent("halt");this.PollTask={preventHalt:true,interval:5,webapi:{api:"SYNO.Core.SHA.Bind.Wizard",version:1,method:"load_binding_progress",params:{}},status_callback:function(h,f,g,e){if(h){this.updateBindingProgress(f,e)}else{SYNO.Debug("Ajax load failure "+f)}},scope:this};this.startWebapis();this.waitForBinding({times:1800000/1000,msg:_TT("SYNO.SDS.HA.Instance","wizard","wait_for_response")})},startWebapis:function(){this.PollID=this.appWin.pollReg(this.PollTask)},stopWebapis:function(){if(this.PollID){this.appWin.pollUnreg(this.PollID);this.PollID=null}},waitForBinding:function(d){var e=d.times||10;var a=e;var b=d.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:d.title||this.title,width:d.width||240,progress:true,closable:false});var c=function(){a--;if("stage_binding_done"===this.binding_progress_desc){this.stopWebapis();this.startWebapis();window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close();return}else{if("stage_binding_failed"===this.binding_progress_desc){this.stopWebapis();this.startWebapis();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","stage_binding_failed"),function(g){if("ok"===g){window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close()}},this);return}}if(0===a){this.stopWebapis();this.startWebapis();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","stage_binding_failed"),function(g){if("ok"===g){window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close()}},this);return}var f=_TT("SYNO.SDS.HA.Instance","wizard",this.binding_progress_desc)||d.msg;SYNO.SDS.Desktop.getMsgBox().updateProgress((1-a/e)/2+this.binding_progress/200,f,_TT("SYNO.SDS.HA.Instance","ui","do_not_turnoff"));c.defer(b,this)};c.defer(b,this)},CheckHeartbeatLinkDone:function(d,b,c,a){if(!b.success){SYNO.SDS.HA.ShowErrMsg(this,b.errinfo,SYNO.SDS.HA.DefaultBindingErrorString);return}this.checkActivateEnvironment()},CheckHeartbeatLink:function(){var a={};a["interface"]="";a.remote_addr=SYNO.SDS.HA.GetServerIP(this.PanelNodeSetup.getForm().findField("server").getRawValue());a.port=this.port;a.is_https_port=this.is_https_port;this.el.mask(_TT("SYNO.SDS.HA.Instance","wizard","activate_environment_checking"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Bind.Wizard",version:1,method:"check_heartbeat_link",params:a,callback:function(e,c,d,b){this.el.unmask();if(e){this.CheckHeartbeatLinkDone(e,c,d,b)}else{SYNO.Debug("Ajax load failure "+c);SYNO.SDS.HA.ShowRespErrMsg(this,c.code,true)}},scope:this})},checkActivateEnvironment:function(){var a=this.genApplyParams();this.el.mask(_TT("SYNO.SDS.HA.Instance","wizard","activate_environment_checking"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Bind.Wizard",version:1,method:"check_binding_environment",params:a,callback:function(e,c,d,b){this.el.unmask();if(e){this.checkActivateEnvironmentDone(e,c,d,b)}else{SYNO.Debug("Ajax load failure "+c);SYNO.SDS.HA.ShowRespErrMsg(this,c.code,true)}},scope:this})},sendRequest:function(a){var b={activate_data:a};this.el.mask(_TT("SYNO.SDS.HA.Instance","wizard","activate_environment_setting"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Bind.Wizard",version:1,timeout:300000,method:"activate_ha",params:b,callback:function(f,d,e,c){this.el.unmask();if(f){this.bindRemoteDone(f,d,e,c)}else{if(-1===d.status){this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("download","download_task_timeout"))}else{SYNO.SDS.HA.ShowRespErrMsg(this,d.code,true)}}},scope:this})},applySetting:function(){this.CheckHeartbeatLink()},Show:function(a){this.open()}});Ext.define("SYNO.SDS.HA.Instance",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.HA.HAMainWindow"});Ext.define("SYNO.SDS.HA.HAMainWindow",{extend:"SYNO.SDS.PageListAppWindow",activePage:"SYNO.SDS.HA.HAPanelOverview",skipDirtyCheck:false,funcToHelp:{general:"HAManager/overview.html","SYNO.SDS.HA.HAPanelOverview":"HAManager/overview.html","SYNO.SDS.HA.HAPanelConfig":"HAManager/network.html","SYNO.SDS.HA.HAPanelService":"HAManager/service.html","SYNO.SDS.HA.HAPanelSpaceStatus":"HAManager/storage.html","SYNO.SDS.HA.HAPanelDiskStatus":"HAManager/disk.html","SYNO.SDS.HA.HAPanelLogView":"HAManager/overview.html","SYNO.SDS.HA.HAPanelSplitBrain":"HAManager/split_brain.html"},constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){var b={width:SYNO.SDS.HA.CONF_DEFAULT_WIDTH,height:SYNO.SDS.HA.CONF_DEFAULT_HEIGHT,minWidth:SYNO.SDS.HA.CONF_DEFAULT_WIDTH,minHeight:SYNO.SDS.HA.CONF_DEFAULT_HEIGHT,listItems:[{text:_TT("SYNO.SDS.HA.Instance","ui","overview"),iconCls:"syno-ha-list-overview",fn:"SYNO.SDS.HA.HAPanelOverview"},{text:_TT("SYNO.SDS.HA.Instance","ui","network_setting"),iconCls:"syno-ha-list-networkConfig",fn:"SYNO.SDS.HA.HAPanelConfig"},{text:_TT("SYNO.SDS.HA.Instance","ui","service_monitor"),iconCls:"syno-ha-list-monitoring",fn:"SYNO.SDS.HA.HAPanelService"},{text:_TT("SYNO.SDS.HA.Instance","ui","storage_status"),iconCls:"syno-ha-list-space",fn:"SYNO.SDS.HA.HAPanelSpaceStatus"},{text:_TT("SYNO.SDS.HA.Instance","ui","disk_status"),iconCls:"syno-ha-list-disk",fn:"SYNO.SDS.HA.HAPanelDiskStatus"},{text:_TT("SYNO.SDS.HA.Instance","ui","log_view"),iconCls:"syno-ha-list-log",fn:"SYNO.SDS.HA.HAPanelLogView"},{text:_TT("SYNO.SDS.HA.Instance","ui","split_brain_tab"),iconCls:"syno-ha-list-splitBrain",hidden:!_S("ha_safemode"),fn:"SYNO.SDS.HA.HAPanelSplitBrain"}]};Ext.apply(b,a);return b},onBeforeSelect:function(b,c,d){if("SYNO.SDS.HA.HAPanelOverview"!==c.id&&true!==SYNO.SDS.HA.HAEnabled){this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_ha_not_enabled"));return false}if(!this.skipDirtyCheck){if(d&&d.leaf){var a=this.pageCt.getComponent(d.attributes.fn);if(a&&Ext.isFunction(a.isDirty)&&a.isDirty()){this.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","confirm_lostchange"),function(e){if("yes"===e){this.skipDirtyCheck=true;this.selectPage(c.attributes.fn);this.skipDirtyCheck=false}},this);return false}}}return this.callParent(arguments)},getHelpParam:function(){var a=this.activePage.itemId;var b=this.funcToHelp[a]||this.funcToHelp.general;return b}});Ext.define("SYNO.SDS.HA.ManageMenuPanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a={padding:"0px",items:[{columns:1,hideLabel:true,itemId:"option",border:false,items:[{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","manage_hardware_title"),name:"mode",inputValue:0,disabled:!b.canShutdownHA&&!b.canShutdownActive&&!b.canShutdownPassive},{xtype:"syno_displayfield",indent:1,value:_TT("SYNO.SDS.HA.Instance","wizard","manage_hardware_content")},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","manage_cluster_title"),name:"mode",inputValue:1},{xtype:"syno_displayfield",indent:1,value:_TT("SYNO.SDS.HA.Instance","wizard","manage_cluster_content")}]}]};var e=a.items[0].items.length;for(var c=0;c<e;++c){var d=a.items[0].items[c];if("mode"===d.name&&!d.disabled){d.checked=true;break}}SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){},getNext:function(){if(!this.getForm().isValid()){return false}var a=this.getForm().getValues().mode;return this.nextId[a]}});Ext.define("SYNO.SDS.HA.ManageHWPanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a={padding:"0px",items:[{columns:1,hideLabel:true,itemId:"option",border:false,items:[{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","move_both_servers"),name:"mode",inputValue:0,disabled:!b.canShutdownHA},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","upgrade_ram_nic"),name:"mode",inputValue:1,disabled:!b.canShutdownHA},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","replace_active_component"),name:"mode",inputValue:2,disabled:!b.canShutdownActive},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","replace_passive_component"),name:"mode",inputValue:3,disabled:!b.canShutdownPassive}]}]};var e=a.items[0].items.length;for(var c=0;c<e;++c){var d=a.items[0].items[c];if(!d.disabled){d.checked=true;break}}SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){},getNext:function(){if(!this.getForm().getValues().mode){return false}this.owner.opCode=this.getForm().getValues().mode;return this.nextId}});Ext.define("SYNO.SDS.HA.ManageClusterPanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a={padding:"0px",items:[{columns:1,hideLabel:true,itemId:"option",border:false,items:[{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","switch_server_desc"),name:"mode",inputValue:0,disabled:!b.canSwitchOver},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","upgrade_dsm_desc"),name:"mode",inputValue:1,disabled:!b.canUpgradeDSM},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","remove_cluster_desc"),name:"mode",inputValue:2,disabled:!b.canRemoveHA},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","bind_passive_desc"),name:"mode",inputValue:3,disabled:!b.canBindPassive},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","unbind_passive_desc"),name:"mode",inputValue:4,disabled:!b.canUnbindPassive}]}]};var e=a.items[0].items.length;for(var c=0;c<e;++c){var d=a.items[0].items[c];if(!d.disabled){d.checked=true;break}}SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){},getNext:function(){if(!this.getForm().getValues().mode){return false}this.owner.opCode=100+this.getForm().getValues().mode;return this.nextId}});Ext.define("SYNO.SDS.HA.ApplyPanel",{extend:"SYNO.ux.FormPanel",action:"",actionList:{0:"shutdown_ha",1:"shutdown_ha",2:"shutdown_active",3:"shutdown_passive",1000:"switchover",1001:"upgrade",1002:"disable_ha",1003:"bind_passive",1004:"unbind_passive"},descList:{0:_TT("SYNO.SDS.HA.Instance","wizard","move_server_steps"),1:_TT("SYNO.SDS.HA.Instance","wizard","upgrade_ram_nic_steps"),2:_TT("SYNO.SDS.HA.Instance","wizard","replace_active_component_steps"),3:_TT("SYNO.SDS.HA.Instance","wizard","replace_passive_component_steps"),1000:_TT("SYNO.SDS.HA.Instance","wizard","switch_server_steps"),1001:_TT("SYNO.SDS.HA.Instance","wizard","upgrade_dsm_steps"),1002:_TT("SYNO.SDS.HA.Instance","wizard","remove_cluster_steps"),1003:_TT("SYNO.SDS.HA.Instance","wizard","bind_passive_steps"),1004:_TT("SYNO.SDS.HA.Instance","wizard","unbind_passive_steps")},btnTextList:{0:_TT("SYNO.SDS.HA.Instance","button","shut_down"),1:_TT("SYNO.SDS.HA.Instance","button","shut_down"),2:_TT("SYNO.SDS.HA.Instance","button","shut_down"),3:_TT("SYNO.SDS.HA.Instance","button","shut_down"),1000:_TT("SYNO.SDS.HA.Instance","ui","switch_server"),1001:_TT("SYNO.SDS.HA.Instance","button","go"),1002:_TT("SYNO.SDS.HA.Instance","button","remove"),1003:_TT("SYNO.SDS.HA.Instance","button","go"),1004:_TT("SYNO.SDS.HA.Instance","button","unbind")},constructor:function(b){var a={cls:"syno-ha-wizard-panel",items:[{xtype:"syno_displayfield",htmlEncode:false,id:this.applyPanelTextID=Ext.id(),value:""}]};SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){var a=this.owner.opCode;var b=this.descList[a];Ext.getCmp(this.applyPanelTextID).setValue(b);this.action=this.actionList[a]},checkState:function(){var a=this.owner.opCode;SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);this.owner.getButton("next").setText(this.btnTextList[a])},getNext:function(){if(!this.getForm().isValid()){return false}if("switchover"===this.action){this.scope.switchOver()}else{if("upgrade"===this.action){this.scope.doUpgrade()}else{if("disable_ha"===this.action){this.scope.changeHAStatus()}else{if("bind_passive"===this.action){this.scope.maintainRemote()}else{if("unbind_passive"===this.action){this.scope.maintainRemote()}else{if("shutdown_ha"===this.action){this.scope.shutdownHA()}else{if("shutdown_active"===this.action){this.scope.shutdownActive()}else{if("shutdown_passive"===this.action){this.scope.shutdownPassive()}}}}}}}}this.owner.close();return false}});Ext.define("SYNO.SDS.HA.HAManageWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",PanelManageMenu:null,PanelManageHW:null,PanelManageCluster:null,PanelApply:null,opCode:0,constructor:function(c){var a=SYNO.SDS.HA;this.appWin=c.owner;this.PanelManageMenu=new a.ManageMenuPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","manage_menu_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","manage_menu_desc"),itemId:"managemenu",nextId:["managehw","managecluster"],header:false,canShutdownHA:c.canShutdownHA,canShutdownActive:c.canShutdownActive,canShutdownPassive:c.canShutdownPassive,owner:this});this.PanelManageHW=new a.ManageHWPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","manage_hardware_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","manage_hardware_desc"),itemId:"managehw",nextId:"apply",header:false,canShutdownHA:c.canShutdownHA,canShutdownActive:c.canShutdownActive,canShutdownPassive:c.canShutdownPassive,canBeepOffPassive:c.canBeepOffPassive,owner:this});this.PanelManageCluster=new a.ManageClusterPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","manage_cluster_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","manage_cluster_desc"),itemId:"managecluster",nextId:"apply",header:false,canSwitchOver:c.canSwitchOver,canUpgradeDSM:c.canUpgradeDSM,canRemoveHA:c.canRemoveHA,canBindPassive:c.canBindPassive,canUnbindPassive:c.canUnbindPassive,owner:this});this.PanelApply=new a.ApplyPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","apply_setting_title"),itemId:"apply",nextId:null,header:false,scope:c.scope,owner:this});var b=[this.PanelManageMenu,this.PanelManageHW,this.PanelManageCluster,this.PanelApply];this.callParent([Ext.apply({title:_TT("SYNO.SDS.HA.Instance","wizard","wizard_title"),width:600,height:490,steps:b},c)])}});Ext.define("SYNO.SDS.HA.HAPanelConfig",{extend:"SYNO.ux.FormPanel",mainPanel:null,PollID:null,PollTask:null,constructor:function(a){this.mainPanel=new SYNO.SDS.HA.HAIPListPanel({appWin:a.appWin,owner:this,title:_TT("SYNO.SDS.HA.Instance","config","general"),mode:"general"});this.leftNodePanel=new SYNO.SDS.HA.HAIPListPanel({appWin:a.appWin,owner:this,title:"     ",mode:"left_node"});this.rightNodePanel=new SYNO.SDS.HA.HAIPListPanel({appWin:a.appWin,owner:this,title:"     ",mode:"right_node"});this.appWin=a.appWin;this.tabpanel=new SYNO.SDS.HA.TabPanel({appWin:a.appWin,owner:this,tabPanels:[this.mainPanel,this.leftNodePanel,this.rightNodePanel]});var b={border:false,itemId:"networkConfig",layout:"fit",style:"padding: 0;",cls:"syno-ha-config-detail",items:[this.tabpanel]};this.callParent([b]);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.StopAjaxRequest,this)},onPageActivate:function(){if(true===_S("ha_safemode")){this.tabpanel.hideTabStripItem(0);this.tabpanel.setActiveTab(1)}else{this.tabpanel.setActiveTab(0)}this.loadNetConfig(true);if(!this.PollTask){this.PollTask={interval:15,webapi:{api:"SYNO.Core.SHA.Panel.Network",version:1,method:"load",params:{reload:false}},status_callback:function(d,b,c,a){if(d){this.loadNetConfigDone(b,a)}else{this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+b)}},scope:this}}this.startWebapis()},startWebapis:function(){this.PollID=this.appWin.pollReg(this.PollTask)},stopWebapis:function(){if(this.PollID){this.appWin.pollUnreg(this.PollID);this.PollID=null}},onPageDeactivate:function(){this.stopWebapis();this.mainPanel.getSelectionModel().clearSelections();this.leftNodePanel.getSelectionModel().clearSelections();this.rightNodePanel.getSelectionModel().clearSelections()},loadNetConfigDone:function(f,h){var b=0;var e=[];var g=null;var d=0;var c=0;this.appWin.clearStatusBusy();if(f.success){b=f.general.interface_num;e.items=[];var a=[];for(d=0;d<SYNO.SDS.HA.CONF_MAX_HA_IF_NUM;d++){if(""!==f.general.ha_networks[d].bond_if&&f.general.drbd_if!==f.general.ha_networks[d].bond_if){a[c]={};a[c]["if"]=f.general.ha_networks[d].bond_if;a[c].ip=f.general.ha_networks[d].bond_ip;a[c].mask=f.general.ha_networks[d].bond_mask;a[c].enabled=f.general.ha_networks[d].bond_enabled;a[c].connection=f.general.ha_networks[d].bond_connection;a[c].data_id=f.general.ha_networks[d].bond_if.replace(/(\w+)(\.\d+|)/g,"$1");e.items.push(a[c]);c++}}for(d=0;d<b;d++){if(!f.general.eth_is_slave_device[d]&&!f.general.eth_is_masked[d]&&f.general.drbd_if!==f.general.ha_networks[d]["if"]){a[c]={};a[c]["if"]=f.general.ha_networks[d]["if"];a[c].ip=f.general.ha_networks[d].ip;a[c].mask=f.general.ha_networks[d].mask;a[c].enabled=f.general.ha_networks[d].enabled;a[c].connection=f.general.ha_networks[d].connection;a[c].data_id=f.general.ha_networks[d]["if"].replace(/(\w+)(\.\d+|)/g,"$1");e.items.push(a[c]);c++}}if(this.mainPanel.IPListStore.getCount()!==e.items.length||true===h.reload){this.mainPanel.IPListStore.loadData(e,false)}else{for(d=0;d<e.items.length;d++){g=null;g=this.mainPanel.IPListStore.getById(e.items[d].data_id);if(g){g.set("if",e.items[d]["if"]);g.set("connection",e.items[d].connection);g.set("enabled",e.items[d].enabled);g.set("ip",e.items[d].ip);g.set("mask",e.items[d].mask)}else{this.mainPanel.IPListStore.loadData(e,false);break}}}this.mainPanel.HAHostname=f.general.ha_hostname;this.mainPanel.defaultGateway=f.general.default_gateway;this.mainPanel.DNS=f.general.dns;this.mainPanel.DNS2=f.general.dns2;this.mainPanel.isStaticDNS=f.general.is_static_dns;this.mainPanel.HAMainInterface=f.general.ha_if_main;this.mainPanel.HADrbdInterface=f.general.drbd_if;if(""!==f.general.lnode_name&&f.general.lnode_online){this.leftNodePanel.setTitle(f.general.lnode_name);this.leftNodePanel.enable()}else{if(!f.general.lnode_online){this.leftNodePanel.setTitle(f.general.lnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}else{this.leftNodePanel.setTitle("N/A");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}}if(""!==f.general.rnode_name&&f.general.rnode_online){this.rightNodePanel.setTitle(f.general.rnode_name);this.rightNodePanel.enable()}else{if(!f.general.rnode_online){this.rightNodePanel.setTitle(f.general.rnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}else{this.rightNodePanel.setTitle("N/A");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}}e.items=f.lnode;if(this.leftNodePanel.IPListStore.getCount()!==e.items.length||!this.leftNodePanel.getSelectionModel().getSelected()){this.leftNodePanel.IPListStore.loadData(e,false);this.leftNodePanel.IPListStore.commitChanges()}e.items=f.rnode;if(this.rightNodePanel.IPListStore.getCount()!==e.items.length||!this.rightNodePanel.getSelectionModel().getSelected()){this.rightNodePanel.IPListStore.loadData(e,false);this.rightNodePanel.IPListStore.commitChanges()}}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},StopAjaxRequest:function(a){if(this.PollTask){this.stopWebapis()}},locationGet:function(){var b=window.location.toString();var a=b.indexOf("#");if(-1===a||a===b.length-1){return""}else{return b.substr(a+1)}},locationCheck:function(b,a){var d=this.locationGet();var c=document.createElement("iframe");if(""!==d){window.location=a;return true}else{if(50>this.tryAddrCount){this.tryAddrCount++;c.width="0px";c.height="0px";c.src=b+"info.cgi?host="+window.location.href;document.getElementsByTagName("body")[0].appendChild(c);this.locationCheck.defer(5000,this,[b,a]);return}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","ui","timeout"));return false},redirect:function(a,d){var c=d||20000;var b=0;if(!Ext.isString(a)){return}SYNO.SDS.StatusNotifier.fireEvent("redirect");window.onbeforeunload=null;var e=function(){location.assign(a)};e.defer(c,this);for(b=0;b<3;b++){c+=10000;e.defer(c,this)}this.waitingBox({title:_TT("SYNO.SDS.HA.Instance","app","app_name"),times:c/1000,msg:_T("tcpip","connect_new_ip")})},waitingBox:function(e){var f=e.times||10;var b=f;var a=Ext.isDefined(e.no_close)?e.no_close:true;var c=e.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:e.title||this.title,width:e.width||240,progress:true,closable:false});var d=function(){b--;if(0===b&&!a){if(Ext.isFunction(e.callback)){e.callback.call(e.scope||this)}SYNO.SDS.Desktop.getMsgBox().hide();return}if(0===b){b=f}SYNO.SDS.Desktop.getMsgBox().updateProgress(1-b/f,_T("tcpip","connect_new_ip"));d.defer(c,this)};d.defer(c,this)},loadNetConfig:function(a){this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Network",version:1,method:"load",params:{reload:a},callback:function(e,c,d,b){if(e){this.loadNetConfigDone(c,d)}else{this.appWin.clearStatusBusy()}},scope:this})},setStatusError:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","error_system"),iconCls:"syno-ux-statusbar-error",clear:true});this.getFooterToolbar().setStatus(b)},setStatusOK:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","setting_applied"),iconCls:"syno-ux-statusbar-success"});this.getFooterToolbar().setStatus(b)}});Ext.define("SYNO.SDS.HA.HAIPListPanel",{extend:"SYNO.ux.EditorGridPanel",IPListStore:null,columnModel:null,toolbar:null,HAMainInterface:null,constructor:function(a){this.initForm(a);var b={title:a.title,owner:a.owner,store:this.IPListStore,tbar:this.toolbar,border:false,cls:"syno-ha-config-ip-list-detail",colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true,moveEditorOnEnter:false}),loadMask:true,stripeRows:true};Ext.apply(b,a);this.callParent([b])},initForm:function(c){var e;if("general"===c.mode){e="data_id"}else{e="node_if"}var d=new Ext.data.Store({proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"items",id:e},["if","enabled","ip","connection","type","mask","desc","data_id"]),sortInfo:{field:"if",direction:"ASC"},remoteSort:false});this.IPListStore=d;if("general"===c.mode){var b=[{xtype:"syno_button",text:_TT("SYNO.SDS.HA.Instance","config","change_cluster_setting"),handler:this.onChangeClusterSetting,disabled:_S("ha_safemode"),scope:this}];this.toolbar=b}var a;if("general"===c.mode){a=this.createEnumHAIPColumn()}else{a=this.createColumn()}this.columnModel=a},createEnumHAIPColumn:function(){var a=new Ext.grid.ColumnModel({columns:[{header:_TT("SYNO.SDS.HA.Instance","wizard","network_interface"),dataIndex:"if",width:0.15,align:"left",renderer:function(d){var b=d.replace(/\w+(\.\d+|)/g,"$1");var c=SYNO.SDS.Utils.Network.idToString(d);if(""!==b){c=c+" "+String.format(_TT("SYNO.SDS.HA.Instance","config","vlan_id"),b.replace(".",""))}return c}},{header:_TT("SYNO.SDS.HA.Instance","config","connection"),dataIndex:"connection",id:"connection",width:0.15,align:"left",renderer:function(b){if("connected"===b){return _TT("SYNO.SDS.HA.Instance","config","connected")}else{return _TT("SYNO.SDS.HA.Instance","config","disconnected")}}},{header:_TT("SYNO.SDS.HA.Instance","ui","ha_ip"),dataIndex:"ip",id:"ip_address",width:0.15,align:"left",renderer:function(b){if(""===b){return"-"}else{return b}}},{header:_TT("SYNO.SDS.HA.Instance","ui","ha_ip_mask"),dataIndex:"mask",id:"subnet_mask",width:0.15,align:"left",renderer:function(b){if(""===b){return"-"}else{return b}}},{dataIndex:"data_id",id:"data_id",hidden:true},{header:_TT("SYNO.SDS.HA.Instance","ui","use_ha_ip"),dataIndex:"enabled",id:"enabled",sortable:false,width:0.15,align:"left",renderer:function(b){if(true===b){return _T("common","yes")}return _T("common","no")}}],defaults:{sortable:false,menuDisabled:true}});return a},createColumn:function(){var a=new Ext.grid.ColumnModel({columns:[{header:_TT("SYNO.SDS.HA.Instance","wizard","network_interface"),dataIndex:"if",width:0.12,align:"left",renderer:function(d){var b=d.replace(/\w+(\.\d+|)/g,"$1");var c=SYNO.SDS.Utils.Network.idToString(d);if(""!==b){c=c+" "+String.format(_TT("SYNO.SDS.HA.Instance","config","vlan_id"),b.replace(".",""))}return c}},{header:_TT("SYNO.SDS.HA.Instance","ui","ip_address"),dataIndex:"ip",id:"ip_address",width:0.12,align:"left"},{header:_TT("SYNO.SDS.HA.Instance","config","subnet_mask"),dataIndex:"mask",id:"subnet_mask",width:0.12,align:"left"},{header:_TT("SYNO.SDS.HA.Instance","space","desc"),dataIndex:"desc",id:"desc",width:0.25,align:"left",renderer:function(b){return'<div ext:qtip="'+Ext.util.Format.htmlEncode(_TT("SYNO.SDS.HA.Instance","ui",b))+'">'+_TT("SYNO.SDS.HA.Instance","ui",b)+"</div>"}}],defaults:{sortable:false,menuDisabled:true}});return a},onChangeClusterSetting:function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Network.Main"})}});Ext.define("SYNO.SDS.HA.HAPanelDiskStatus",{extend:"Ext.Panel",leftNodePanel:null,rightNodePanel:null,PollID:null,PollTask:null,constructor:function(a){this.appWin=a.appWin;this.leftNodePanel=new SYNO.SDS.HA.HADiskListPanel({appWin:a.appWin,owner:this,title:"",role:"left_node"});this.rightNodePanel=new SYNO.SDS.HA.HADiskListPanel({appWin:a.appWin,owner:this,title:"",role:"right_node"});var c=[this.leftNodePanel,this.rightNodePanel];this.tabpanel=new SYNO.SDS.HA.TabPanel({appWin:a.appWin,owner:this,tabPanels:c});var b={border:false,itemId:"disk",layout:"fit",style:"padding: 0px 0px 10px 0px;",items:[this.tabpanel]};this.callParent([b])},onPageActivate:function(){this.tabpanel.setActiveTab(0);this.updateDiskWithMask();if(!this.PollTask){this.PollTask={interval:5,webapi:{api:"SYNO.Core.SHA.Panel.Disk",version:1,method:"load",params:{}},status_callback:function(d,b,c,a){if(d){this.updateDiskWithMaskDone(b,a)}else{SYNO.Debug("Ajax load failure "+b)}},scope:this}}this.startWebapis()},startWebapis:function(){this.PollID=this.appWin.pollReg(this.PollTask)},stopWebapis:function(){if(this.PollID){this.appWin.pollUnreg(this.PollID);this.PollID=null}},onPageDeactivate:function(){this.stopWebapis()},updateDiskWithMaskDone:function(f,d){this.appWin.clearStatusBusy();if(f.success){var e={};var a={};var c=0;e.items=f.lnode_disk;a.items=f.rnode_disk;if(""!==f.lnode_name&&f.lnode_online){this.leftNodePanel.setTitle(f.lnode_name);this.leftNodePanel.enable()}else{if(!f.lnode_online){this.leftNodePanel.setTitle(f.lnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(1)}}else{this.leftNodePanel.setTitle("N/A");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(1)}}}if(""!==f.rnode_name&&f.rnode_online){this.rightNodePanel.setTitle(f.rnode_name);this.rightNodePanel.enable()}else{if(!f.rnode_online){this.rightNodePanel.setTitle(f.rnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}else{this.rightNodePanel.setTitle("N/A");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}}if(this.leftNodePanel.diskStore.getCount()!==f.lnode_disk.length){this.leftNodePanel.diskStore.loadData(e,false)}else{for(c=0;c<f.lnode_disk.length;c++){var g=this.leftNodePanel.diskStore.getById(f.lnode_disk[c].index);if(g){g.set("name",f.lnode_disk[c].name);g.set("eunit",f.lnode_disk[c].eunit);g.set("size",f.lnode_disk[c].size);g.set("temperature",f.lnode_disk[c].temperature);g.set("smart",f.lnode_disk[c].smart);g.set("status",f.lnode_disk[c].status)}else{this.leftNodePanel.diskStore.loadData(e,false);break}}}this.leftNodePanel.diskStore.commitChanges();if(this.rightNodePanel.diskStore.getCount()!==f.rnode_disk.length){this.rightNodePanel.diskStore.loadData(a,false)}else{for(c=0;c<f.rnode_disk.length;c++){var b=this.rightNodePanel.diskStore.getById(f.rnode_disk[c].index);if(b){b.set("name",f.rnode_disk[c].name);b.set("eunit",f.rnode_disk[c].eunit);b.set("size",f.rnode_disk[c].size);b.set("temperature",f.rnode_disk[c].temperature);b.set("smart",f.rnode_disk[c].smart);b.set("status",f.rnode_disk[c].status)}else{this.rightNodePanel.diskStore.loadData(a,false);break}}}this.rightNodePanel.diskStore.commitChanges()}else{SYNO.Debug("Ajax load failure "+f)}},updateDiskWithMask:function(){this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Disk",version:1,method:"load",params:{},callback:function(d,b,c,a){if(d){this.updateDiskWithMaskDone(b,a)}else{this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+b)}},scope:this})}});Ext.define("SYNO.SDS.HA.HADiskListPanel",{extend:"SYNO.ux.EditorGridPanel",diskStore:null,columnModel:null,PollTask:null,constructor:function(a){this.initForm();var b={title:a.title,role:a.role,store:this.diskStore,border:false,colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),loadMask:true,stripeRows:true};Ext.apply(b,a);this.callParent([b]);this.getSelectionModel().on("rowselect",function(d,c,e){},this);this.getSelectionModel().on("rowdeselect",function(d,c){},this);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.StopAjaxRequest,this)},initForm:function(){var b=new Ext.data.Store({proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"items",id:"index"},["location","order","index","eunit","name","size","temperature","smart","status"]),remoteSort:false,hasMultiSort:true});b.sort([{field:"location",direction:"AES"},{field:"order",direction:"AES"}],"AES");this.diskStore=b;var a=new Ext.grid.ColumnModel({columns:[{id:"eunit",header:_T("volume","volume_disk_source_ebox"),dataIndex:"eunit",width:0.15,align:"left",renderer:function(h,e,g){var f=g.get("index").indexOf("-");var d=g.get("index").substr(0,f);var c=h.indexOf("EUnit");if(0!==d&&-1!==c){return h.replace("EUnit",_T("volume","volume_expansion"))}else{return h}}},{id:"name",header:_T("volume","volume_disk_number"),dataIndex:"name",width:0.12,align:"left",renderer:function(c){return c.replace("Disk",_T("volume","volume_disk"))}},{header:_T("volume","volume_diskcapacity"),dataIndex:"size",width:0.1,align:"left",renderer:this.diskSizeRender},{header:_T("status","temperature"),dataIndex:"temperature",width:0.15,align:"left",renderer:function(c,d,e){if("no"===_D("showdisktemperature","yes")||-1===c){return"-"}return String.format("{0} {1} / {2} {3}",c,_T("status","celsius"),(c*9/5+32).toFixed(0),_T("status","fahrenheit"))}},{header:_T("smart","smart_status"),dataIndex:"smart",width:0.15,align:"left",renderer:function(c){var d;if("yes"!==_D("supportsmart","no")){return"-"}if(!c){d=_T("common","loading")}else{if(c==="safe"){d='<font class="syno-ha-service-status-health">'+_T("volume","volume_status_normal")+"</font>"}else{if(c==="damage"){d='<font class="syno-ha-service-status-error">'+_T("smart","smart_status_abnormal")+"</font>"}else{if(c==="danger"){d='<font class="syno-ha-service-status-error">'+_T("smart","smart_status_abnormal")+"</font>"}else{d=_T("smart","smart_test_remain")+": "+c}}}}return d}},{header:_T("volume","volume_diskstatus"),dataIndex:"status",width:0.13,align:"left",renderer:this.DiskStatusRender}],defaults:{sortable:false,menuDisabled:true}});this.columnModel=a},StopAjaxRequest:function(a){if(this.PollTask){this.PollTask.stop()}},getStatus:function(a,b){this.appWin.clearStatusBusy()},DiskStatusRender:function(a){if(0===a.indexOf("all_partition_normal")){if(a.indexOf(":spare")>0){return'<span class="syno-ha-service-status-health">'+_T("volume","volume_spare_disk")+"</span>"}else{return'<span class="syno-ha-service-status-health">'+_T("volume","volume_diskinuse")+"</span>"}}else{if(0===a.indexOf("sys_partition_bad")){if(a.indexOf(":spare")>0){return String.format("<span class='syno-ha-service-status-health'>{0}</span><span class='syno-ha-service-status-error'>({1})</span>",_T("volume","volume_spare_disk"),_T("volume","volume_diskfailedsys"))}else{return'<span class="syno-ha-service-status-error">'+_T("volume","volume_diskfailedsys")+"</span>"}}else{if("sys_partition_normal"==a){return'<span class="syno-ha-service-status-health">'+_T("volume","volume_disksysuse")+"</span>"}else{if("data_partition_bad"==a){return'<span class="syno-ha-service-status-error">'+_T("volume","volume_diskfailed")+"</span>"}else{if("not_use"==a){return'<span class="syno-ha-service-status-health">'+_T("volume","volume_disknotuse")+"</span>"}else{if("no_disk"==a||"not_install"==a){return'<span class="normal-font">'+_T("volume","volume_disknotset")+"</span>"}else{if("normal"==a){return'<span class="syno-ha-service-status-health">'+_T("volume","volume_diskinuse")+"</span>"}else{if("crashed"==a){return'<span class="syno-ha-service-status-error">'+_T("volume","volume_diskfailed")+"</span>"}else{if("system_crashed"==a){return'<span class="syno-ha-service-status-error">'+_T("volume","volume_diskfailedsys")+"</span>"}else{return""}}}}}}}}}},diskSizeRender:function(b){var a=SYNO.SDS.Utils.StorageUtils;return a.GetSizeGB(b)+" GB"}});Ext.define("SYNO.SDS.HA.HAPanelLogView",{extend:"Ext.Panel",constructor:function(a){this.leftNodePanel=new SYNO.SDS.HA.HALogListPanel({appWin:a.appWin,owner:this,title:"     ",node:"lnode"});this.rightNodePanel=new SYNO.SDS.HA.HALogListPanel({appWin:a.appWin,owner:this,title:"     ",node:"rnode"});this.appWin=a.appWin;this.tabpanel=new SYNO.SDS.HA.TabPanel({appWin:a.appWin,owner:this,tabPanels:[this.leftNodePanel,this.rightNodePanel]});var b={border:false,itemId:"log",layout:"fit",style:"padding: 0px 0px 10px 0px;",items:[this.tabpanel]};this.callParent([b])},onPageActivate:function(){this.tabpanel.setActiveTab(0);this.loadLogView()},onPageDeactivate:function(){},loadLogViewDone:function(b,a){this.appWin.clearStatusBusy();if(b.success){if(""!==b.lnode_name&&b.lnode_online){this.leftNodePanel.setTitle(b.lnode_name);this.leftNodePanel.enable()}else{if(!b.lnode_online){this.leftNodePanel.setTitle(b.lnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(1)}}else{this.leftNodePanel.setTitle("N/A");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(1)}}}if(""!==b.rnode_name&&b.rnode_online){this.rightNodePanel.setTitle(b.rnode_name);this.rightNodePanel.enable()}else{if(!b.rnode_online){this.rightNodePanel.setTitle(b.rnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}else{this.rightNodePanel.setTitle("N/A");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}}}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","error_system"))}},loadLogView:function(){this.appWin.setStatusBusy(_T("common","loading"));this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Log",version:1,method:"load_info",params:{},callback:function(d,b,c,a){if(d){this.loadLogViewDone(b,a)}else{this.appWin.clearStatusBusy()}},scope:this})}});Ext.define("SYNO.SDS.HA.HALogListPanel",{extend:"SYNO.ux.EditorGridPanel",logListStore:null,storeParam:null,columnModel:null,toolbar:null,pagingToolbar:null,displayNum:20,constructor:function(a){this.initForm(a);var c=new Ext.data.SimpleStore({fields:["value","display"],data:[[20,20],[40,40],[60,60],[80,80],[100,100],[150,150],[200,200],[300,300],[400,400]]});var d=new SYNO.ux.ComboBox({store:c,displayField:"display",valueField:"value",triggerAction:"all",value:this.displayNum,editable:false,width:62,mode:"local",listeners:{select:{fn:this.itemPerPageChangedHandler,scope:this}}});var b={title:a.title,owner:a.owner,store:this.logListStore,tbar:this.toolbar,border:false,cls:"syno-ha-logview-log-list-detail",colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),loadMask:true,stripeRows:true,bbar:this.pagingToolbar=new SYNO.ux.PagingToolbar({store:this.logListStore,pageSize:this.displayNum,items:[new Ext.Toolbar.TextItem(_T("common","items_perpage")),d],displayInfo:true})};Ext.apply(b,a);this.callParent([b])},initForm:function(b){var c=new Ext.data.Store({proxy:new SYNO.API.Proxy({api:"SYNO.Core.SHA.Panel.Log",method:"load",version:1}),reader:new Ext.data.JsonReader({root:"items",totalProperty:"logCount"},["level","type","date","user","event"]),baseParams:this.storeParam={mode:b.node,start:0,limit:this.displayNum},autoLoad:true,autoDestroy:false});this.logListStore=c;var a=[{xtype:"syno_button",text:_T("common","clean"),handler:this.onClean,disabled:_S("ha_safemode"),scope:this},{xtype:"syno_button",text:_T("common","refresh"),handler:this.onRefresh,scope:this}];this.toolbar=a;this.columnModel=this.createColumn()},createColumn:function(){var a=new Ext.grid.ColumnModel({columns:[{header:" ",dataIndex:"level",width:0.06,align:"center",renderer:function(c){var b='<div class="{0}" ext:qtip="{1}">&nbsp;</div>';if(c=="info"){return String.format(b,"synoha-log-info",_T("log","info_level"))}else{if(c=="warn"){return String.format(b,"synoha-log-warn",_T("log","warn_level"))}else{return String.format(b,"synoha-log-err",_T("log","error_level"))}}}},{header:_T("tree","leaf_log"),dataIndex:"type",width:0.1,align:"left",renderer:function(c){var b="";switch(c){case"syslog":b=_T("log","log_link_system");break;case"connlog":b=_T("log","log_link_connection");break;default:b=_T("log","log_link_system")}return'<div ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(b))+'">'+Ext.util.Format.htmlEncode(b)+"</div>"}},{header:_T("log","log_time"),dataIndex:"date",width:0.17,align:"left",renderer:function(b){return'<div ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(b))+'">'+Ext.util.Format.htmlEncode(b)+"</div>"}},{header:_T("log","log_account"),dataIndex:"user",width:0.12,align:"left",renderer:function(b){return'<div ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(b))+'">'+Ext.util.Format.htmlEncode(b)+"</div>"}},{header:_T("log","log_action"),dataIndex:"event",id:"event",width:0.38,align:"left",renderer:function(b){return'<div ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(b))+'">'+Ext.util.Format.htmlEncode(b)+"</div>"}}],defaults:{sortable:false,menuDisabled:true}});return a},itemPerPageChangedHandler:function(a){if(this.displayNum!=a.getValue()){this.displayNum=a.getValue();this.pagingToolbar.pageSize=this.displayNum;this.storeParam.limit=this.displayNum;this.logListStore.load()}},onClean:function(){this.appWin.setStatusBusy(_T("common","loading"));this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Log",version:1,method:"clear",params:{},callback:function(e,b,d,a){if(e){this.appWin.clearStatusBusy();var c="";if(!b.success){if(b.errinfo&&b.errinfo.app){c=_TT(b.errinfo.app,b.errinfo.sec,b.errinfo.key)}else{if(b.errinfo){c=_T(b.errinfo.sec,b.errinfo.key)}else{c=_T("common","error_system")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),c);return}this.logListStore.load();this.owner.loadLogView()}else{this.appWin.clearStatusBusy()}},scope:this})},onRefresh:function(){this.logListStore.load()}});Ext.define("SYNO.SDS.HA.HAPanelOverview",{extend:"Ext.Panel",statusIconCSSClass:["syno-ha-overview-icon-healthy","syno-ha-overview-icon-danger","syno-ha-overview-icon-standalone","syno-ha-overview-icon-warning","syno-ha-overview-icon-configuring","syno-ha-overview-icon-empty_passive","syno-ha-overview-icon-preparing","syno-ha-overview-icon-loading"],statusTitleCSSClass:["syno-ha-overview-titleText-healthy","syno-ha-overview-titleText-danger","syno-ha-overview-titleText-standalone","syno-ha-overview-titleText-warning","syno-ha-overview-titleText-configuring","syno-ha-overview-titleText-empty_passive","syno-ha-overview-titleText-preparing","syno-ha-overview-titleText-loading"],sysStatusIndex:["healthy","error","standalone","warning","configuring","empty_passive","preparing","loading"],DSIconCSSClass:["syno-ha-overview-connectionFigure-normal","syno-ha-overview-connectionFigure-warning","syno-ha-overview-connectionFigure-configuring","syno-ha-overview-connectionFigure-offline","syno-ha-overview-connectionFigure-error","syno-ha-overview-connectionFigure-standalone","syno-ha-overview-connectionFigure-none"],DSStatus:["normal","warning","configuring","offline","error","standalone","none"],syncDirectionIconCSSClass:["syno-ha-overview-connectionFigure-syncLeft","syno-ha-overview-connectionFigure-syncRight","syno-ha-overview-connectionFigure-syncNone"],syncDirectionStatus:["left","right","none"],unbinding_progress_desc:null,unbinding_progress:null,contentRefresher:null,sysStatus:null,passiveOnline:null,remoteOnline:null,PollID:[],PollTask:[],progressFinished:false,tryAddrCount:null,hideMenuFlag:null,triggerMenuFlag:null,activeServerDown:null,pollingCount:0,activeServer:"",activeStatus:null,activeFailedServ:[],activeFailedNet:[],passiveServer:"",passiveStatus:null,passiveFailedServ:[],currentDescList:[],currentDescIndex:0,dataSyncProgress:"",haStatusKey:"",passiveDataUnsync:false,passiveSN:"",activeSN:"",localSN:"",remoteSN:"",actionMenuOn:false,lnodeDetailPanelID:null,rnodeDetailPanelID:null,lnodeNameID:null,rnodeNameID:null,lnodeRoleID:null,rnodeRoleID:null,lnodeModelID:null,rnodeModelID:null,lnodeSNID:null,rnodeSNID:null,lnodeServerFanID:null,rnodeServerFanID:null,lnodeThermalID:null,rnodeThermalID:null,lnodePowerUnitID:null,rnodePowerUnitID:null,lnodeMemoryID:null,rnodeMemoryID:null,SBLocalRole:"",constructor:function(a){this.appWin=a.appWin;var b=this.fillConfig(a);this.callParent([b]);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.stopWebapis,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.stopWebapis,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.stopWebapis,this);this.mon(Ext.getCmp(this.manageHABtnID),"menuhide",this.onMenuhide,this);this.mon(Ext.getCmp(this.manageHABtnID),"menutriggerout",this.onMenutriggerout,this)},fillConfig:function(a){var b={border:false,itemId:"overview",layout:"vbox",layoutConfig:{align:"stretch",pack:"start"},items:[this.createBriefOverviewBox(),this.createConnectionOverviewBox()],style:"padding: 0;",cls:"syno-ha-overview-panel",listeners:{activate:{fn:function(){this.updateHAStatus();if(!this.PollTask.Overview){this.PollTask.Overview={interval:5,immediate:true,webapi:{api:"SYNO.Core.SHA.Panel.Overview",version:1,method:"load",params:{}},status_callback:this.updateHAStatusDone,scope:this}}this.startWebapis("Overview")},scope:this},deactivate:{fn:function(){this.stopWebapis("Overview")},scope:this}}};return SYNO.LayoutConfig.fill(b)},startWebapis:function(a){if("Overview"===a){this.PollID.Overview=this.appWin.pollReg(this.PollTask.Overview)}else{if("Active"===a){this.PollID.Active=this.appWin.pollReg(this.PollTask.Active)}else{if("Passive"===a){this.PollID.Passive=this.appWin.pollReg(this.PollTask.Passive)}else{if("Unbinding_Progress"===a){this.PollID.Unbinding_Progress=this.appWin.pollReg(this.PollTask.Unbinding_Progress)}}}}},stopWebapis:function(a){if("Overview"===a){if(this.PollID.Overview){this.appWin.pollUnreg(this.PollID.Overview);this.PollID.Overview=null}}else{if("Active"===a){if(this.PollID.Active){this.appWin.pollUnreg(this.PollID.Active);this.PollID.Active=null}}else{if("Passive"===a){if(this.PollID.Passive){this.appWin.pollUnreg(this.PollID.Passive);this.PollID.Passive=null}}else{if("Unbinding_Progress"===a){if(this.PollID.Unbinding_Progress){this.appWin.pollUnreg(this.PollID.Unbinding_Progress);this.PollID.Unbinding_Progress=null}}}}}},createBriefOverviewPanel:function(){return{xtype:"panel",hideLabel:true,id:this.BriefOverviewPanelID=Ext.id(),layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},width:720,height:230,border:false,items:[this.createStatusIconBox(),this.createStatusMessageBox()]}},createBriefOverviewBox:function(){return{xtype:"panel",hideLabel:true,layout:"vbox",layoutConfig:{align:"center"},height:230,border:false,items:[this.createBriefOverviewPanel()]}},createStatusIconBox:function(){return{xtype:"panel",layout:"hbox",layoutConfig:{align:"middle"},hideLabel:true,width:258,border:false,cls:"syno-ha-overview-icon",items:[this.createStatusIconPanel()]}},createStatusIconPanel:function(){return{xtype:"panel",hideLabel:true,id:this.statusIconPanelID=Ext.id(),width:128,height:128,border:false,cls:"syno-ha-overview-icon-default"}},createStatusMessageBox:function(){return{xtype:"panel",hideLabel:true,border:false,id:this.StatusMessageBoxID=Ext.id(),layout:"hbox",layoutConfig:{align:"middle"},items:[this.createStatusMessagePanel()]}},createStatusMessagePanel:function(){return{xtype:"panel",hideLabel:true,width:439,height:230,layoutConfig:{align:"top"},border:false,items:[{xtype:"syno_displayfield",style:"margin-top: 17px; margin-bottom: 8px;",id:this.statusTitleID=Ext.id(),value:"",cls:"syno-ha-overview-titleText-healthy"},{xtype:"panel",hideLabel:true,layout:"hbox",border:false,style:"margin-bottom: 5px;",items:[{xtype:"syno_displayfield",id:this.statusDescriptionID=Ext.id(),width:378,value:"",style:"padding: 0px;"},this.createDescriptionBtn()]},this.createClusterInformationPanel(),this.createOperationButtonPanel()]}},createDescriptionBtn:function(){return{xtype:"panel",hideLabel:true,cls:"syno-ha-overview-descriptions-btn",border:false,layout:"hbox",layoutConfig:{align:"middle"},items:[{xtype:"button",id:this.prevDescBtnID=Ext.id(),handler:this.onPrevDesc,disabled:_S("demo_mode"),scope:this,hidden:true,cls:"syno-ha-overview-prevDescButton"},{xtype:"button",id:this.nextDescBtnID=Ext.id(),handler:this.onNextDesc,disabled:_S("demo_mode"),scope:this,hidden:true,cls:"syno-ha-overview-nextDescButton"}]}},createClusterInformationPanel:function(){return{xtype:"panel",layout:"form",labelWidth:190,border:false,style:"margin-bottom: 5px;",id:this.HAClusterInfoPanelID=Ext.id(),items:[{xtype:"syno_displayfield",fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","virtual_server"),hideLabel:false,value:"",hidden:true,id:this.HAHostNameID=Ext.id()},{xtype:"syno_displayfield",fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","virtual_ip"),hideLabel:false,value:"",hidden:true,id:this.HAHostIPID=Ext.id()},{xtype:"syno_displayfield",fieldLabel:_TT("SYNO.SDS.HA.Instance","overview","built_time"),hideLabel:false,value:"",hidden:true,id:this.HAEnabledTimeID=Ext.id()},{xtype:"syno_displayfield",htmlEncode:false,hideLabel:true,value:"",hidden:true,id:this.HAClusterDescID=Ext.id()}]}},createOperationButtonPanel:function(){return{xtype:"panel",hideLabel:true,layoutConfig:{align:"stretch",pack:"start"},border:false,items:[{xtype:"syno_button",text:_TT("SYNO.SDS.HA.Instance","ui","enable_ha"),id:this.enableHABtnID=Ext.id(),handler:this.changeHAStatus,disabled:_S("demo_mode"),scope:this,hidden:true,cls:"syno-ha-overview-squareButton"},new SYNO.ux.SplitButton({id:this.manageHABtnID=Ext.id(),text:_TT("SYNO.SDS.HA.Instance","overview","manage_cluster"),scope:this,handler:this.onSplitButton,disabled:_S("demo_mode"),hidden:true,menu:new Ext.menu.Menu({items:[{text:_S("ha_safemode")?_TT("SYNO.SDS.HA.Instance","overview","resolve_sb_errors"):_TT("SYNO.SDS.HA.Instance","overview","launch_manage_wizard"),scope:this,id:this.manageWizardBtnID=Ext.id(),handler:_S("ha_safemode")?this.doResolveSB:this.doManageHA},{xtype:"menuseparator",scope:this},{text:_TT("SYNO.SDS.HA.Instance","ui","switch_server"),scope:this,id:this.switchBtnID=Ext.id(),handler:this.switchOver},{text:_TT("SYNO.SDS.HA.Instance","button","update_dsm"),scope:this,id:this.upgradeBtnID=Ext.id(),handler:this.doUpgrade},{text:_TT("SYNO.SDS.HA.Instance","ui","disable_ha"),scope:this,id:this.disableHABtnID=Ext.id(),handler:this.changeHAStatus},{text:_TT("SYNO.SDS.HA.Instance","overview","unbind_remote"),scope:this,id:this.maintainPassiveBtnID=Ext.id(),handler:this.maintainRemote},{text:_TT("SYNO.SDS.HA.Instance","overview","shutdown_cluster"),scope:this,id:this.shutdownClusterBtnID=Ext.id(),handler:this.shutdownHA},{text:_TT("SYNO.SDS.HA.Instance","overview","shutdown_active"),scope:this,id:this.shutdownActiveBtnID=Ext.id(),handler:this.shutdownActive},{text:_TT("SYNO.SDS.HA.Instance","overview","reboot_active"),scope:this,id:this.rebootActiveBtnID=Ext.id(),handler:this.rebootActive},{text:_TT("SYNO.SDS.HA.Instance","overview","shutdown_passive"),scope:this,id:this.shutdownPassiveBtnID=Ext.id(),handler:this.shutdownPassive},{text:_TT("SYNO.SDS.HA.Instance","overview","reboot_passive"),scope:this,id:this.rebootPassiveBtnID=Ext.id(),handler:this.rebootPassive},{text:_TT("SYNO.SDS.HA.Instance","overview","shut_beep_remote"),scope:this,id:this.beepOffPassiveBtnID=Ext.id(),handler:this.shutbeepRemote},{text:_TT("SYNO.SDS.HA.Instance","overview","shutdown_sb_local"),scope:this,id:this.shutdownLocalBtnID=Ext.id(),handler:this.shutdownSBLocal}]})})]}},descRenderer:function(d){var c="";var b=[];var a=0;if("desc_data_mirroring"===d){c=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_data_mirroring"),this.dataSyncProgress)}else{if("active_has_failed_service"===d){for(a=0;a<this.activeFailedServ.size();a++){b.push(SYNO.SDS.HA.ServiceRenderer(this.activeFailedServ[a]))}c=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_failed_service_active"),b.join(", "))}else{if("passive_has_failed_service"===d){for(a=0;a<this.passiveFailedServ.size();a++){b.push(SYNO.SDS.HA.ServiceRenderer(this.passiveFailedServ[a]))}c=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_failed_service_passive"),b.join(", "))}else{if("active_has_failed_net"===d){for(a=0;a<this.activeFailedNet.size();a++){b.push(SYNO.SDS.Utils.Network.idToString(this.activeFailedNet[a],"lan"))}c=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_failed_net_active"),b.join(", "))}else{if("passive_has_failed_net"===d){for(a=0;a<this.passiveFailedNet.size();a++){b.push(SYNO.SDS.Utils.Network.idToString(this.passiveFailedNet[a],"lan"))}c=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_failed_net_passive"),b.join(", "))}else{if("memsize_not_identical"===d){c=_TT("SYNO.SDS.HA.Instance","overview","desc_memsize_not_identical_when_cache_exist")}else{if(""===d){c=""}else{c=_TT("SYNO.SDS.HA.Instance","overview",d)}}}}}}}Ext.getCmp(this.statusDescriptionID).setValue(c);Ext.getCmp(this.StatusMessageBoxID).doLayout();Ext.getCmp(this.BriefOverviewPanelID).doLayout()},onNextDesc:function(){var b=this.currentDescList;var a=this.currentDescIndex;if(0>=b.size()){return}if(b.size()>a+1){this.descRenderer(b[a+1]);this.haStatusKey=b[a+1];this.currentDescIndex++;a=this.currentDescIndex}if(b.size()===a+1){Ext.getCmp(this.nextDescBtnID).disable()}if(0<a){Ext.getCmp(this.prevDescBtnID).enable()}},onPrevDesc:function(){var b=this.currentDescList;var a=this.currentDescIndex;if(0>=b.size()){return}if(0<a){this.descRenderer(b[a-1]);this.haStatusKey=b[a-1];this.currentDescIndex--;a=this.currentDescIndex}if(0===a){Ext.getCmp(this.prevDescBtnID).disable()}if(b.size()>a+1){Ext.getCmp(this.nextDescBtnID).enable()}},onMenuhide:function(){this.hideMenuFlag=1},onMenutriggerout:function(){this.triggerMenuFlag=1},onSplitButton:function(a){if(1===this.hideMenuFlag&&0===this.triggerMenuFlag){a.hideMenu()}else{a.showMenu()}this.hideMenuFlag=0;this.triggerMenuFlag=0},createConnectionOverviewPanel:function(){return{xtype:"panel",hideLabel:true,width:722,height:368,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[this.createConnectionOverviewPanelContent()]}},createConnectionOverviewBox:function(){return{xtype:"panel",hideLabel:true,height:368,layout:"vbox",layoutConfig:{align:"center"},border:false,items:[this.createConnectionOverviewPanel()]}},createConnectionOverviewPanelContent:function(){return{xtype:"panel",hideLabel:true,flex:1,width:722,layout:"vbox",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[this.createUpperConnectionOverviewPanel(),this.createGraphicalConnectionFigurePanel(),this.createBottomConnectionOverviewPanel()]}},createUpperConnectionOverviewPanel:function(){return{xtype:"panel",hideLabel:true,width:612,height:18,layout:"hbox",cls:"syno-ha-overview-connection-nodeLabel",border:false,items:[{xtype:"syno_displayfield",value:"",flex:1,height:18,id:this.lnodeRoleID=Ext.id()},{xtype:"syno_displayfield",value:"",flex:1,height:18,id:this.rnodeRoleID=Ext.id()}]}},createGraphicalConnectionFigurePanel:function(){return{xtype:"panel",hideLabel:true,height:80,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[{xtype:"panel",id:this.leftNodeDSIconID=Ext.id(),cls:"syno-ha-overview-connectionFigure-default",border:false,width:361},{xtype:"panel",id:this.rightNodeDSIconID=Ext.id(),cls:"syno-ha-overview-connectionFigure-default",border:false,width:361},{xtype:"panel",id:this.syncDirectionIconID=Ext.id(),border:false,width:720}]}},createBottomConnectionOverviewPanel:function(){return{xtype:"panel",hideLabel:true,width:722,layout:"hbox",border:false,items:[this.createLeftConnectionDetailBox(),this.createRightConnectionDetailBox()]}},createLeftConnectionDetailBox:function(){return{xtype:"panel",hideLabel:false,flex:1,padding:"0px 25px 0px 20px",border:false,items:[this.createLeftConnectionDetailPanel()]}},createLeftConnectionDetailPanel:function(){return{xtype:"panel",hideLabel:false,layout:"form",labelSeparator:"",labelWidth:170,cls:"syno-ha-overview-server-detail",border:false,id:this.lnodeDetailPanelID=Ext.id(),hidden:true,items:[this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_name"),id:this.lnodeNameID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_model"),id:this.lnodeModelID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_sn"),id:this.lnodeSNID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",htmlEncode:false,hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_fan"),id:this.lnodeServerFanID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_thermal"),id:this.lnodeThermalID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",htmlEncode:false,hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_power"),id:this.lnodePowerUnitID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_T("rsrcmonitor","physical_memory"),id:this.lnodeMemoryID=Ext.id(),value:""},this.createServerDetailSeperator()]}},createServerDetailSeperator:function(){return{xtype:"panel",hideLabel:true,width:316,height:0,border:false,cls:"syno-ha-overview-connectionFigure-serverDetailSeperator"}},createRightConnectionDetailBox:function(){return{xtype:"panel",hideLabel:false,flex:1,padding:"0px 20px 0px 25px",border:false,items:[this.createRightConnectionDetailPanel()]}},createRightConnectionDetailPanel:function(){return{xtype:"panel",hideLabel:false,layout:"form",labelSeparator:"",labelWidth:170,cls:"syno-ha-overview-server-detail",border:false,id:this.rnodeDetailPanelID=Ext.id(),hidden:true,items:[this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_name"),id:this.rnodeNameID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_model"),id:this.rnodeModelID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_sn"),id:this.rnodeSNID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",htmlEncode:false,hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_fan"),id:this.rnodeServerFanID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_thermal"),id:this.rnodeThermalID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",htmlEncode:false,hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_power"),id:this.rnodePowerUnitID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_T("rsrcmonitor","physical_memory"),id:this.rnodeMemoryID=Ext.id(),value:""},this.createServerDetailSeperator()]}},doUpgrade:function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Update_Reset.Main"})},switchOver:function(){this.stopWebapis("Overview");this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_switchover"),function(a){if("yes"===a){var b={};b.mode="switch_over";this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Action",version:1,method:"switchover",params:b,callback:function(h,e,g,d){if(h){this.appWin.clearStatusBusy();this.startWebapis("Overview");if(e.success){this.progressFinished=false;SYNO.SDS.StatusNotifier.fireEvent("halt");var c=e.redirect_url.replace("__WEBMAN_ADDR__",e.ip_list[0]);this.tryAddrCount=0;this.locationCheck.defer(30000,this,[e.ping_url,c,"switch_over"]);this.redirect(e.redirect_url,e.ip_list,1800000,"switch_over")}else{var f="";if(e.errinfo&&e.errinfo.app){f=_TT(e.errinfo.app,e.errinfo.sec,e.errinfo.key)}else{if(e.errinfo){f=_T(e.errinfo.sec,e.errinfo.key)}else{f=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),f)}}else{this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.Debug("Ajax load failure "+e);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}},scope:this})}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)},redirect:function(a,c,e,g){var d=e||20000;var b=0;if(!Ext.isString(a)||!Ext.isArray(c)){return}if(false===this.activeServerDown){SYNO.SDS.StatusNotifier.fireEvent("redirect")}window.onbeforeunload=null;var h=function(j){SYNO.Debug("try "+c[j%c.length]);location.assign(a.replace("__WEBMAN_ADDR__",c[j%c.length]))};h.defer(d,this,[0]);for(b=0;b<3;b++){d+=10000;h.defer(d,this,[0])}for(b=1;b<=c.length;b++){d+=10000;h.defer(d,this,[b])}var f="";if("reboot_active"===g){f=_TT("SYNO.SDS.HA.Instance","ui","rebooting_active")}else{f=_T("tcpip","connect_new_ip")}this.waitingBox({title:_TT("SYNO.SDS.HA.Instance","app","app_name"),times:d/1000,msg:f})},waitingBox:function(d){var e=d.times||10;var a=e;var b=d.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:d.title||this.title,width:d.width||240,progress:true,closable:false});var c=function(){a--;if((0===a)||(this.progressFinished)){if(Ext.isFunction(d.callback)){d.callback.call(d.scope||this)}this.progressFinished=false;SYNO.SDS.Desktop.getMsgBox().hide();return}if(0===a){a=e}SYNO.SDS.Desktop.getMsgBox().updateProgress(1-a/e,d.msg);c.defer(b,this)};c.defer(b,this)},waitPassiveStatus:function(b){if(!this.PollTask.Passive){this.PollTask.Passive={preventHalt:true,interval:5,webapi:{api:"SYNO.Core.SHA.Panel.Overview",version:1,method:"polling_passive_server",params:{}},status_callback:function(f,d,e,c){this.pollingPassive(f,d,b)},scope:this}}this.pollingCount=0;this.progressFinished=false;this.startWebapis("Passive");var a="";if("shutdown_passive"===b||"reboot_passive"===b){a=_TT("SYNO.SDS.HA.Instance","ui","shutting_down_passive_desc")}else{if("unbind"===b){a=_TT("SYNO.SDS.HA.Instance","ui","unbinding_passive_desc")}}this.waitingBox({title:_TT("SYNO.SDS.HA.Instance","app","app_name"),times:600000/1000,msg:a,width:400})},pollingPassive:function(d,a,b){if(!d){this.stopWebapis("Passive");this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"));this.appWin.clearStatusBusy();this.startWebapis("Overview");this.progressFinished=true}else{var c=false;if(!a.success){this.pollingCount++;return}if("unbind"===b&&"none"===a.passive_status){c=true}else{if(("shutdown_passive"===b||"reboot_passive"===b)&&("offline"===a.passive_status||"wanring_offline"===a.passive_status)){c=true}}if(c){window.location.reload()}else{if(120<=this.pollingCount){this.stopWebapis("Passive");this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"));this.appWin.clearStatusBusy();this.startWebapis("Overview")}}this.pollingCount++}},powerOptPassiveDone:function(b,a){if(b.success){this.waitPassiveStatus(a)}else{var c="";this.appWin.clearStatusBusy();this.startWebapis("Overview");if(b.errinfo&&b.errinfo.app){c=_TT(b.errinfo.app,b.errinfo.sec,b.errinfo.key)}else{if(b.errinfo){c=_T(b.errinfo.sec,b.errinfo.key)}else{c=_T("error","error_error_system")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),c)}},doPowerOptPassive:function(a){var b="";this.stopWebapis("Overview");this.appWin.setStatusBusy();if("shutdown_passive"===a){b=_TT("SYNO.SDS.HA.Instance","overview","warning_turnoff_remote")}else{b=_TT("SYNO.SDS.HA.Instance","overview","warning_reboot_passive")}this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),b,function(c){if("yes"===c){this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Action",version:1,method:a,params:{},callback:function(g,e,f,d){if(g){this.powerOptPassiveDone(e,a)}else{this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.Debug("Ajax load failure "+e);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}},scope:this})}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)},shutRemoBeepteDone:function(b,a){this.appWin.clearStatusBusy();this.startWebapis("Overview");if(b.success){}else{var c="";if(b.errinfo&&b.errinfo.app){c=_TT(b.errinfo.app,b.errinfo.sec,b.errinfo.key)}else{if(b.errinfo){c=_T(b.errinfo.sec,b.errinfo.key)}else{c=_T("error","error_error_system")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),c)}},shutbeepRemote:function(){this.stopWebapis("Overview");this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Action",version:1,method:"shut_remote_beep",params:{},callback:function(d,b,c,a){if(d){this.shutRemoBeepteDone(b,a)}else{this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.Debug("Ajax load failure "+b);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}},scope:this})},shutdownPassive:function(){if(true===this.passiveOnline){this.doPowerOptPassive("shutdown_passive")}},rebootPassive:function(){if(true===this.passiveOnline){this.doPowerOptPassive("reboot_passive")}},shutdownSBLocal:function(){this.stopWebapis("Overview");this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),String.format(_TT("SYNO.SDS.HA.Instance","overview","warning_shutdown_sb_local"),this.localSN),function(a){if("yes"===a){this.doShutdown("sb_local_shutdown")}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)},unbindRemoteDone:function(b,a){if(b.success){this.waitPassiveStatus("unbind")}else{var c="";this.appWin.clearStatusBusy();this.startWebapis("Overview");if(b.errinfo&&b.errinfo.app){c=_TT(b.errinfo.app,b.errinfo.sec,b.errinfo.key)}else{if(b.errinfo){c=_T(b.errinfo.sec,b.errinfo.key)}else{c=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),c)}},SBunbindRemoteDone:function(b,a){this.SBRedirect(b,"sb_unbind_remote")},SBRedirect:function(b,d){if(b.success){this.progressFinished=false;SYNO.SDS.StatusNotifier.fireEvent("halt");var a=b.redirect_url.replace("__WEBMAN_ADDR__",b.ip_list[0]);this.tryAddrCount=0;this.locationCheck.defer(30000,this,[b.ping_url,a,d]);this.redirect(b.redirect_url,b.ip_list,1800000,d)}else{var c="";this.appWin.clearStatusBusy();this.startWebapis("Overview");if(b.errinfo&&b.errinfo.app){c=_TT(b.errinfo.app,b.errinfo.sec,b.errinfo.key)}else{if(b.errinfo){c=_T(b.errinfo.sec,b.errinfo.key)}else{c=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),c)}},unbindRemote:function(a){this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Action",version:1,method:"unbind_remote",params:{safemode:a},callback:function(e,c,d,b){if(e){if("true"===a){this.SBunbindRemoteDone(c,b)}else{this.unbindRemoteDone(c,b)}}else{this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.Debug("Ajax load failure "+c);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}},scope:this})},SBunbindLocalDone:function(b,a){this.SBRedirect(b,"sb_unbind_local")},unbindLocal:function(a){this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Action",version:1,method:"unbind_local",params:{safemode:a},callback:function(e,c,d,b){if(e){this.SBunbindLocalDone(c,b)}else{this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.Debug("Ajax load failure "+c);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}},scope:this})},bindRemoteDone:function(a,b){var c=Ext.decode(a.responseText);this.appWin.clearStatusBusy();if(c.success){}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance",c.e,"error_error_system"))}},bindRemote:function(){this.appWin.clearStatusBusy();var a=new SYNO.SDS.HA.HABindWizard({owner:this.appWin,scope:this});a.on("hide",function(){},this);a.Show()},maintainRemote:function(){this.stopWebapis("Overview");this.appWin.setStatusBusy();if("empty_passive"===this.sysStatus){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","warning_binding_remote"),function(c){if("yes"===c){this.bindRemote()}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)}else{var a=[];if(this.passiveDataUnsync){a.push('<font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","ui","warning_unsynced_passive_unbinding")+"</font>")}a.push(_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_passive_suggestion"));a.push(_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_no_switchover_service"));a.push(_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_rebind_passive"));var b=_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_passive")+SYNO.SDS.HA.MakeUL(a)+_T("common","ask_cont");SYNO.SDS.HA.ListStyleMsgBox(this.appWin).getWrapper().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),b,function(c){if("yes"===c){this.unbindRemote("false")}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)}},changeHAStatus:function(){if(null===SYNO.SDS.HA.HAEnabled){return}if(SYNO.SDS.HA.HAEnabled){this.checkWarningService()}else{this.doEnableHA()}},checkUnbindHAWarningServiceDone:function(f,d,e,c){var a=[];if(this.passiveDataUnsync){a.push('<font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","ui","warning_unsynced_passive_unbinding")+"</font>")}a.push(_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_stop_tasks"));if(d.has_joined_domain){a.push(_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_disconnect_domain"))}if(d.has_logined_myds){a.push(_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_logout_myds"))}if(d.has_opened_remote_access){a.push(_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_close_remote_access"))}if(d.has_enabled_push_service){a.push(_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_disable_push_service"))}if(d.has_enabled_non_synology_ddns){a.push(_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_disable_all_ddns"))}a.push(_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_rebind_ha"));var b=_TT("SYNO.SDS.HA.Instance","overview","warning_unbinding_ha")+SYNO.SDS.HA.MakeUL(a)+_T("common","ask_cont");SYNO.SDS.HA.ListStyleMsgBox(this.appWin).getWrapper().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),b,function(g){if("yes"===g){this.appWin.clearStatusBusy();this.doDisableHA()}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)},checkWarningService:function(){this.stopWebapis("Overview");this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Overview",version:1,method:"check_unbind_ha_warning_service",params:{},callback:function(d,b,c,a){if(d&&b.success){this.checkUnbindHAWarningServiceDone(d,b,c,a)}else{this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.Debug("Ajax load failure "+b);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},scope:this})},SBunbind:function(a){if(null===a||""===a){return}if(_S("ha_safemode")){var b=_TT("SYNO.SDS.HA.Instance","overview","warning_SB_unbind");this.stopWebapis("Overview");this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),b,function(c){if("yes"===c){this.appWin.clearStatusBusy();if("local"===a){this.unbindLocal("true")}if("remote"===a){this.unbindRemote("true")}}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)}},SBSetLocalRoleDone:function(b,a){this.SBRedirect(b,"sb_set_role")},SBSetLocalRole:function(b){if(null===b||""===b){return}if(_S("ha_safemode")){var a=_TT("SYNO.SDS.HA.Instance","overview","warning_SB_activate");this.stopWebapis("Overview");this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),a,function(c){if("yes"===c&&("active"===b||"passive"===b)){this.SBLocalRole=b;this.appWin.clearStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Action",version:1,method:"sb_local_"+b,params:{safemode:true},callback:function(g,e,f,d){if(g){this.SBSetLocalRoleDone(e,d)}else{this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.Debug("Ajax load failure "+e);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}},scope:this})}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)}},doEnableHA:function(){this.stopWebapis("Overview");var a=new SYNO.SDS.HA.HASetupWizard({owner:this.appWin,scope:this});a.on("hide",function(){},this);a.Show()},doManageHA:function(){this.stopWebapis("Overview");var a=new SYNO.SDS.HA.HAManageWizard({owner:this.appWin,canSwitchOver:("enabled"===this.buttons.switchover),canUpgradeDSM:("enabled"===this.buttons.upgrade_dsm),canRemoveHA:("enabled"===this.buttons.remove_cluster),canBindPassive:("enabled"===this.buttons.bind_passive),canUnbindPassive:("enabled"===this.buttons.unbind_passive),canShutdownHA:("enabled"===this.buttons.shutdown_cluster),canShutdownActive:("enabled"===this.buttons.shutdown_active),canShutdownPassive:("enabled"===this.buttons.shutdown_passive),canBeepOffPassive:("enabled"===this.buttons.passive_beep_off),scope:this});a.on("hide",function(){},this);a.open()},doResolveSB:function(){var c="";var a="";if("lnode"===this.ha.login_node){c=this.lnode;a=this.rnode}else{c=this.rnode;a=this.lnode}this.stopWebapis("Overview");var b=new SYNO.SDS.HA.HASplitBrainWizard({owner:this.appWin,isRemoteOnline:(true===this.remoteOnline),loginSN:c.sn,loginHostname:c.hostname,remoteSN:a.sn,remoteHostname:a.hostname,scope:this});b.on("hide",function(){},this);b.open()},startPollingActive:function(b){this.activeServerDown=false;var a={};a.mode="deactivate_ha";this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Overview",version:1,method:"polling_active_server",params:a,callback:function(f,d,e,c){if(f){if(b===d.sn){this.startPollingActive.defer(5000,this,[b])}else{this.activeServerDown=true}}else{this.activeServerDown=true}},scope:this})},updateUnbindingProgress:function(b,a){if(b.success){this.unbinding_progress_desc=b.unbinding_progress_desc;this.unbinding_progress=b.unbinding_progress}else{this.unbinding_progress_desc="stage_unknown"}},waitForUnbinding:function(d){var e=d.times||10;var a=e;var b=d.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:d.title||this.title,width:d.width||240,progress:true,closable:false});var c=function(){a--;if(true===this.activeServerDown){this.stopWebapis("Unbinding_Progress");SYNO.SDS.Desktop.getMsgBox().hide();var f=d.redirect_url.replace("__WEBMAN_ADDR__",d.ip_list[0]);this.progressFinished=false;this.tryAddrCount=0;this.locationCheck.defer(60000,this,[d.ping_url,f,"disable_ha"]);this.redirect(d.redirect_url,d.ip_list,1800000,"disable_ha");return}if(0===a){this.stopWebapis("Unbinding_Progress");this.stopWebapis("Overview");this.startWebapis("Overview");this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"),function(h){if("ok"===h){window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close()}},this);return}var g=_TT("SYNO.SDS.HA.Instance","wizard",this.unbinding_progress_desc)||d.msg;SYNO.SDS.Desktop.getMsgBox().updateProgress((1-a/e)+this.unbinding_progress/200,g,_TT("SYNO.SDS.HA.Instance","ui","disabling_ha"));c.defer(b,this)};c.defer(b,this)},doDisableHAFinished:function(b,a){this.appWin.clearStatusBusy();this.startWebapis("Overview");if(!b.success){this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.SDS.HA.ShowErrMsg(this.appWin,b.errinfo,_T("common","commfail"));return}SYNO.SDS.StatusNotifier.fireEvent("halt");if(!this.PollTask.Unbinding_Progress){this.PollTask.Unbinding_Progress={preventHalt:true,interval:5,webapi:{api:"SYNO.Core.SHA.Panel.Overview",version:1,method:"load_unbinding_progress",params:{}},status_callback:function(f,d,e,c){if(f){this.updateUnbindingProgress(d,c)}else{SYNO.Debug("Ajax load failure "+d)}},scope:this}}SYNO.SDS.StatusNotifier.fireEvent("redirect");this.startWebapis("Unbinding_Progress");this.startPollingActive(this.activeSN);this.waitForUnbinding({times:1800000/1000,msg:_TT("SYNO.SDS.HA.Instance","wizard","wait_for_response"),redirect_url:b.redirect_url,ip_list:b.ip_list,ping_url:b.ping_url})},locationGet:function(){var b=window.location.toString();var a=b.indexOf("#");if(-1===a||a===b.length-1){return""}else{return b.substr(a+1)}},locationCheck:function(g,a,f){var e=this.locationGet();var d=document.createElement("iframe");var c="";var h="";var b="";if(false===this.activeServerDown){this.locationCheck.defer(5000,this,[g,a,f]);return}if(""!==e){c=e.search("sn=");if(-1!==c){h=e.substr(c+3)}if("sb_set_role"===f){if("active"===this.SBLocalRole){b=this.localSN}else{b=this.remoteSN}}if(("switch_over"!==f&&"sb_unbind_remote"!==f&&"sb_unbind_local"!==f&&"sb_set_role"!==f)||("switch_over"===f&&""!==h&&this.passiveSN===h)||("sb_unbind_remote"===f&&""!==h&&this.localSN===h)||("sb_unbind_local"===f&&""!==h&&this.remoteSN===h)||("sb_set_role"===f&&""!==h&&b===h)){window.location=a;this.progressFinished=true;return true}}if(300>this.tryAddrCount){this.tryAddrCount++;d.width="0px";d.height="0px";d.src=g+"info.cgi?host="+window.location.href;document.getElementsByTagName("body")[0].appendChild(d);this.locationCheck.defer(5000,this,[g,a,f]);return}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","ui","timeout"));return false},doDisableHA:function(){var a={};a.mode="deactivate_ha";this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Action",version:1,method:"deactivate_ha",params:a,callback:function(e,c,d,b){if(e){this.doDisableHAFinished(c,b)}else{this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.Debug("Ajax load failure "+c)}},scope:this})},getSysMsgBox:function(a){if(!this.msgBox||this.msgBox.isDestroyed){this.msgBox=new SYNO.SDS.MessageBoxV5({modal:true,draggable:false,renderTo:document.body})}return this.msgBox.getWrapper()},doShutdown:function(a){this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Action",version:1,method:a,params:{},callback:function(e,c,d,b){if(e){this.appWin.clearStatusBusy();this.startWebapis("Overview");if(!c.success){SYNO.SDS.HA.ShowErrMsg(this.appWin,c.errinfo,_TT("SYNO.SDS.HA.Instance","ui","do_not_turnoff"));return}SYNO.SDS.StatusNotifier.fireEvent("halt");this.appWin.close();this.getSysMsgBox().show({closable:false,maxWidth:300,title:_D("product"),msg:_T("system","shutdown_desc2")})}else{this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.Debug("Ajax load failure "+c);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},scope:this})},shutdownHA:function(){this.stopWebapis("Overview");this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_shutdown_cluster"),function(a){if("yes"===a){this.doShutdown("shutdown_ha")}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)},shutdownActive:function(){this.stopWebapis("Overview");this.appWin.setStatusBusy();this.updateHAStatusImmediately();if("enabled"===this.buttons.switchover){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_shutdown_active"),function(a){if("yes"===a){this.doShutdown("shutdown_active")}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)}else{if("enabled"===this.buttons.shutdown_passive){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_not_only_shutdown_active"),function(a){if("yes"===a){this.doShutdown("shutdown_ha")}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)}else{this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_shutdown_lonely_active"),function(a){if("yes"===a){this.doShutdown("shutdown_active")}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)}}},doRebootActive:function(){var a={};a.mode="reboot_active";this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Action",version:1,method:"reboot_active",params:a,callback:function(f,d,e,c){if(f){this.appWin.clearStatusBusy();this.startWebapis("Overview");if(!d.success){SYNO.SDS.HA.ShowErrMsg(this.appWin,d.errinfo,_TT("SYNO.SDS.HA.Instance","ui","do_not_turnoff"));return}this.startPollingActive(this.activeSN);SYNO.SDS.StatusNotifier.fireEvent("halt");var b=d.redirect_url.replace("__WEBMAN_ADDR__",d.ip_list[0]);this.progressFinished=false;this.tryAddrCount=0;this.locationCheck.defer(30000,this,[d.ping_url,b,"reboot_active"]);this.redirect(d.redirect_url,d.ip_list,1800000,"reboot_active")}else{this.appWin.clearStatusBusy();this.startWebapis("Overview");SYNO.Debug("Ajax load failure "+d);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},scope:this})},rebootActive:function(){this.stopWebapis("Overview");this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_reboot_active"),function(a){if("yes"===a){this.doRebootActive()}else{this.appWin.clearStatusBusy();this.startWebapis("Overview")}},this)},onPageActivate:function(){this.doLayout()},onPageDeactivate:function(){if(null!==this.contentRefresher){this.contentRefresher.stop()}},renderFanStatus:function(a,b){if(""===a||"offline"===b||"none"===b){a="N/A"}else{if("status_normal"===a){a='<font class="syno-ha-service-status-health">'+_TT("SYNO.SDS.HA.Instance","overview","status_normal")+"</font>"}else{a='<font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","overview","fail")+"</font>"}}return a},renderPowerStatus:function(c,d){if(""===c||"offline"===d||"none"===d){c="N/A"}else{if("status_normal"===c){c='<font class="syno-ha-service-status-health">'+_TT("SYNO.SDS.HA.Instance","overview","status_normal")+"</font>"}else{var b=_T("system","power_supply")+c+": "+_T("common","status_abnormal");var a='<font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","overview","fail")+"</font>";c='<div ext:qtip="'+b+'">'+a+"</div>"}}return c},renderMemorySize:function(a,b){if(""===a||"offline"===b||"none"===b){a="N/A"}else{a=a+" "+_T("common","size_mb")}return a},renderThermalStatus:function(a,b){if("yes"!==_D("supportsystemperature")||""===a||"offline"===b||"none"===b){return"N/A"}return String.format("{0} {1} / {2} {3}",a,_T("status","celsius"),(a*9/5+32).toFixed(0),_T("status","fahrenheit"))},renderServerDetails:function(a,b){if(""===a){a="N/A"}return a},renderNodeRole:function(a){if(""!==a){a=_TT("SYNO.SDS.HA.Instance","ui",a)}return a},setButtonStatus:function(d,e){this.buttons=d;if(_S("ha_safemode")){Ext.getCmp(this.switchBtnID).hide();Ext.getCmp(this.upgradeBtnID).hide();Ext.getCmp(this.enableHABtnID).hide();Ext.getCmp(this.manageHABtnID).show();Ext.getCmp(this.shutdownClusterBtnID).hide();Ext.getCmp(this.shutdownActiveBtnID).hide();Ext.getCmp(this.rebootActiveBtnID).hide();Ext.getCmp(this.disableHABtnID).hide();Ext.getCmp(this.shutdownLocalBtnID).show();Ext.getCmp(this.beepOffPassiveBtnID).hide();Ext.getCmp(this.shutdownPassiveBtnID).hide();Ext.getCmp(this.rebootPassiveBtnID).hide();Ext.getCmp(this.maintainPassiveBtnID).hide();return}if("enabled"===d.switchover){Ext.getCmp(this.switchBtnID).enable()}else{Ext.getCmp(this.switchBtnID).disable()}if("enabled"===d.upgrade_dsm){Ext.getCmp(this.upgradeBtnID).enable()}else{Ext.getCmp(this.upgradeBtnID).disable()}if("enabled"===d.create_cluster){Ext.getCmp(this.enableHABtnID).show();Ext.getCmp(this.enableHABtnID).enable()}else{if("disabled"===d.create_cluster){Ext.getCmp(this.enableHABtnID).show();Ext.getCmp(this.enableHABtnID).disable()}else{Ext.getCmp(this.enableHABtnID).hide()}}if(_S("demo_mode")){Ext.getCmp(this.enableHABtnID).disable()}if("enabled"===d.manager_cluster){Ext.getCmp(this.manageHABtnID).show();Ext.getCmp(this.manageHABtnID).enable()}else{if("disabled"===d.manager_cluster){Ext.getCmp(this.manageHABtnID).show();Ext.getCmp(this.manageHABtnID).disable()}else{Ext.getCmp(this.manageHABtnID).hide()}}if("enabled"===d.shutdown_cluster){Ext.getCmp(this.shutdownClusterBtnID).enable()}else{Ext.getCmp(this.shutdownClusterBtnID).disable()}if("enabled"===d.shutdown_active){Ext.getCmp(this.shutdownActiveBtnID).enable();Ext.getCmp(this.rebootActiveBtnID).enable()}else{Ext.getCmp(this.shutdownActiveBtnID).disable();Ext.getCmp(this.rebootActiveBtnID).disable()}if("enabled"===d.remove_cluster){Ext.getCmp(this.disableHABtnID).enable()}else{Ext.getCmp(this.disableHABtnID).disable()}if("enabled"===d.shutdown_local){Ext.getCmp(this.shutdownLocalBtnID).show();Ext.getCmp(this.shutdownLocalBtnID).enable()}else{if("disabled"===d.shutdown_local){Ext.getCmp(this.shutdownLocalBtnID).show();Ext.getCmp(this.shutdownLocalBtnID).disable()}else{if("hidden"===d.shutdown_local){Ext.getCmp(this.shutdownLocalBtnID).hide()}}}var c=Ext.getCmp(this.beepOffPassiveBtnID);var b=Ext.getCmp(this.shutdownPassiveBtnID);var f=Ext.getCmp(this.rebootPassiveBtnID);var a=Ext.getCmp(this.maintainPassiveBtnID);if("lnode"===e||"rnode"===e){if("enabled"===d.passive_beep_off){c.enable()}else{c.disable()}if("enabled"===d.shutdown_passive){b.enable();f.enable()}else{b.disable();f.disable()}if("enabled"===d.unbind_passive){a.enable();a.setText(_TT("SYNO.SDS.HA.Instance","overview","unbind_remote"))}else{if("disabled"===d.unbind_passive){a.disable();a.setText(_TT("SYNO.SDS.HA.Instance","overview","unbind_remote"))}else{if(!_S("demo_mode")){a.enable()}else{a.disable()}a.setText(_TT("SYNO.SDS.HA.Instance","overview","bind_remote"))}}}},parseServList:function(a){var b=a.split(",");return b},parseNetList:function(b){var a=b.split(",");return a},updateHAStatusDone:function(d,b,c,a){if(!d){SYNO.Debug("Ajax load failure "+b)}else{if(b.success){this.ha=b.ha;this.lnode=b.lnode;this.rnode=b.rnode;if("standalone"===b.ha.status){SYNO.SDS.HA.HAEnabled=false;this.passiveOnline=null;Ext.getCmp(this.HAClusterInfoPanelID).el.removeClass("syno-ha-overview-clusterInfo");Ext.getCmp(this.HAClusterInfoPanelID).el.addClass("syno-ha-overview-clusterInfo-standalone");Ext.getCmp(this.HAHostNameID).hide();Ext.getCmp(this.HAHostIPID).hide();Ext.getCmp(this.HAEnabledTimeID).hide();Ext.getCmp(this.HAClusterDescID).setValue(_TT("SYNO.SDS.HA.Instance","overview","standalone_desc"));Ext.getCmp(this.HAClusterDescID).show()}else{SYNO.SDS.HA.HAEnabled=true;Ext.getCmp(this.HAClusterInfoPanelID).el.removeClass("syno-ha-overview-clusterInfo-standalone");Ext.getCmp(this.HAClusterInfoPanelID).el.addClass("syno-ha-overview-clusterInfo");Ext.getCmp(this.HAHostNameID).setValue(b.ha.host);Ext.getCmp(this.HAHostIPID).setValue(b.ha.ha_ip_main);Ext.getCmp(this.HAEnabledTimeID).setValue(b.ha.uptime);Ext.getCmp(this.HAHostNameID).show();Ext.getCmp(this.HAHostIPID).show();Ext.getCmp(this.HAEnabledTimeID).show();Ext.getCmp(this.HAClusterDescID).hide()}Ext.getCmp(this.lnodeNameID).setValue(this.renderServerDetails(b.lnode.hostname,b.lnode.status));Ext.getCmp(this.rnodeNameID).setValue(this.renderServerDetails(b.rnode.hostname,b.rnode.status));Ext.getCmp(this.lnodeRoleID).setValue(this.renderNodeRole(b.lnode.role));Ext.getCmp(this.rnodeRoleID).setValue(this.renderNodeRole(b.rnode.role));Ext.getCmp(this.lnodeModelID).setValue(this.renderServerDetails(b.lnode.model,b.lnode.status));Ext.getCmp(this.rnodeModelID).setValue(this.renderServerDetails(b.rnode.model,b.rnode.status));Ext.getCmp(this.lnodeSNID).setValue(this.renderServerDetails(b.lnode.sn,b.lnode.status));Ext.getCmp(this.rnodeSNID).setValue(this.renderServerDetails(b.rnode.sn,b.rnode.status));Ext.getCmp(this.lnodeServerFanID).setValue(this.renderFanStatus(b.lnode.fan_status,b.lnode.status));Ext.getCmp(this.rnodeServerFanID).setValue(this.renderFanStatus(b.rnode.fan_status,b.rnode.status));Ext.getCmp(this.lnodeThermalID).setValue(this.renderThermalStatus(b.lnode.thermal_status,b.lnode.status));Ext.getCmp(this.rnodeThermalID).setValue(this.renderThermalStatus(b.rnode.thermal_status,b.rnode.status));Ext.getCmp(this.lnodePowerUnitID).setValue(this.renderPowerStatus(b.lnode.power_status,b.lnode.status));Ext.getCmp(this.rnodePowerUnitID).setValue(this.renderPowerStatus(b.rnode.power_status,b.rnode.status));Ext.getCmp(this.lnodeMemoryID).setValue(this.renderMemorySize(b.lnode.memory_size,b.lnode.status));Ext.getCmp(this.rnodeMemoryID).setValue(this.renderMemorySize(b.rnode.memory_size,b.rnode.status));Ext.getCmp(this.lnodeDetailPanelID).show();Ext.getCmp(this.rnodeDetailPanelID).show();if("active"===b.lnode.role){this.setButtonStatus(b.buttons,"lnode");this.activeServer=b.lnode.hostname;this.activeStatus=b.lnode.status;this.passiveServer=b.rnode.hostname;this.passiveStatus=b.rnode.status;if("offline"===b.rnode.status){this.passiveOnline=false}else{this.passiveOnline=true}this.passiveSN=b.rnode.sn;this.activeSN=b.lnode.sn}else{if("active"===b.rnode.role){this.setButtonStatus(b.buttons,"rnode");this.activeServer=b.rnode.hostname;this.activeStatus=b.rnode.status;this.passiveServer=b.lnode.hostname;this.passiveStatus=b.lnode.status;if("offline"===b.lnode.status){this.passiveOnline=false}else{this.passiveOnline=true}this.passiveSN=b.lnode.sn;this.activeSN=b.rnode.sn}else{this.setButtonStatus(b.buttons,"none")}}if(_S("ha_safemode")){this.remoteOnline=true;if("lnode"===this.ha.login_node){this.localSN=b.lnode.sn;this.remoteSN=b.rnode.sn;this.remoteOnline=("offline"!==b.rnode.status)}else{this.localSN=b.rnode.sn;this.remoteSN=b.lnode.sn;this.remoteOnline=("offline"!==b.lnode.status)}}this.activeFailedServ=this.parseServList(b.ha.active_failed_service);this.passiveFailedServ=this.parseServList(b.ha.passive_failed_service);this.activeFailedNet=this.parseNetList(b.ha.active_failed_net);this.passiveFailedNet=this.parseNetList(b.ha.passive_failed_net);if("empty_passive"===b.ha.status){this.passiveOnline=null}this.passiveDataUnsync=b.ha.passive_data_unsynced;this.refreshInformation(b)}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}}this.appWin.clearStatusBusy()},updateHAStatusImmediately:function(){this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Overview",version:1,method:"load",params:{force_refresh:true},callback:function(d,b,c,a){if(d){this.updateHAStatusDone(d,b,c,a)}else{this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+b)}},scope:this})},updateHAStatus:function(){this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Overview",version:1,method:"load",params:{},callback:function(d,b,c,a){if(d){this.updateHAStatusDone(d,b,c,a)}else{this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+b)}},scope:this})},refreshInformation:function(a){this.sysStatus=a.ha.status;this.setObjectClassBySysStatus(Ext.getCmp(this.statusIconPanelID),a.ha.status,this.statusIconCSSClass);this.setObjectValueBySysStatus(Ext.getCmp(this.statusTitleID),a.ha.status);this.currentDescIndex=a.ha.description.indexOf(this.haStatusKey);if(-1===this.currentDescIndex&&""!==a.ha.description[0]){this.haStatusKey=a.ha.description[0];this.currentDescIndex=0}this.dataSyncProgress=a.ha.sync_progress+"%";if("loading"===a.ha.status){this.descRenderer("");Ext.getCmp(this.manageHABtnID).disable();Ext.getCmp(this.prevDescBtnID).hide();Ext.getCmp(this.nextDescBtnID).hide()}else{this.descRenderer(this.haStatusKey);this.currentDescList=a.ha.description;if(1<this.currentDescList.size()){Ext.getCmp(this.prevDescBtnID).show();Ext.getCmp(this.nextDescBtnID).show()}else{Ext.getCmp(this.prevDescBtnID).hide();Ext.getCmp(this.nextDescBtnID).hide()}if(this.currentDescList.size()>this.currentDescIndex+1){Ext.getCmp(this.nextDescBtnID).enable()}else{Ext.getCmp(this.nextDescBtnID).disable()}if(0<this.currentDescIndex){Ext.getCmp(this.prevDescBtnID).enable()}else{Ext.getCmp(this.prevDescBtnID).disable()}}this.setObjectClassBySysStatus(Ext.getCmp(this.statusTitleID),a.ha.status,this.statusTitleCSSClass);switch(a.ha.status){case"healthy":SYNO.Debug("system is healthy");break;case"danger":SYNO.Debug("system is danger");break;case"standalone":SYNO.Debug("system is standalone");break;case"warning":SYNO.Debug("system is warning");break;case"configuring":SYNO.Debug("system is configuring space");break;case"empty_passive":SYNO.Debug("system has no passive node");break;case"preparing":SYNO.Debug("system is preparing");break;case"loading":SYNO.Debug("system is loading the status");break;default:SYNO.Debug("undefined system status");break}this.setObjectClassByDSStatus(Ext.getCmp(this.leftNodeDSIconID),a.lnode.status,this.DSIconCSSClass);this.setObjectClassByDSStatus(Ext.getCmp(this.rightNodeDSIconID),a.rnode.status,this.DSIconCSSClass);this.setObjectClassBySyncStatus(Ext.getCmp(this.syncDirectionIconID),a.ha.sync_direction,this.syncDirectionIconCSSClass);this.doLayout()},setObjectValueBySysStatus:function(b,a){b.setValue(_TT("SYNO.SDS.HA.Instance","status",a))},setObjectClassBySyncStatus:function(c,b,a){this.setObjectClassByStatus(c,b,a,this.syncDirectionStatus)},setObjectClassByDSStatus:function(c,b,a){this.setObjectClassByStatus(c,b,a,this.DSStatus)},setObjectClassBySysStatus:function(c,b,a){this.setObjectClassByStatus(c,b,a,this.sysStatusIndex)},setObjectClassByStatus:function(e,c,b,a){var d=0;for(d=0;d<a.length;d++){if(a[d]!=c){e.removeClass(b[d])}else{e.addClass(b[d])}}}});Ext.define("SYNO.SDS.HA.HAPanelService",{extend:"SYNO.ux.FormPanel",PollID:null,PollTask:null,constructor:function(a){this.appWin=a.appWin;var b={border:false,cls:"syno-ha-service-detail",itemId:"monitoring",layout:"fit",style:"padding: 0;",items:[this.mainPanel=new SYNO.SDS.HA.HAServiceListPanel({appWin:a.appWin,owner:this})],fbar:{xtype:"statusbar",hideMode:"visibility",defaultText:"&nbsp;",statusAlign:"left",buttonAlign:"left",items:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","commit"),itemId:"apply",scope:this,disabled:_S("ha_safemode"),handler:this.doCommitSetting},{xtype:"syno_button",text:_T("common","alt_cancel"),itemId:"reset",scope:this,disabled:_S("ha_safemode"),handler:this.onCancel}]}};this.callParent([b])},isDirty:function(){var a=0;var b=this.mainPanel.serviceStore.getCount();for(a=0;a<b;a++){var c=this.mainPanel.serviceStore.getAt(a);if(c&&c.modified){if("monitoring" in c.modified){return true}}}return false},onPageActivate:function(){if(_S("ha_safemode")){this.el.mask(_TT("SYNO.SDS.HA.Instance","overview","desc_sb_no_service_monitor"),"syno-ux-mask-info");this.updateServiceWithMask(true);return}this.updateServiceWithMask(true);if(!this.PollTask){this.PollTask={interval:5,webapi:{api:"SYNO.Core.SHA.Panel.Service",version:1,method:"load",params:{reload:false}},status_callback:function(d,b,c,a){if(d){this.updateServiceWithMaskDone(b,c)}else{SYNO.Debug("Ajax load failure "+b)}},scope:this}}this.startWebapis()},startWebapis:function(){this.PollID=this.appWin.pollReg(this.PollTask)},stopWebapis:function(){if(this.PollID){this.appWin.pollUnreg(this.PollID);this.PollID=null}},onPageDeactivate:function(){this.stopWebapis()},doCommitSetting:function(){var d={};var a=0;var c="";var b;if(!this.isDirty()){this.setStatusError({text:_T("error","nochange_subject"),clear:true});return}for(a=0;a<this.mainPanel.serviceStore.getCount();a++){b=this.mainPanel.serviceStore.getAt(a);c=String.format("ha_mon{0}",a);d[c]=b.get("monitoring")}this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Service",version:1,method:"apply",params:d,callback:function(i,f,h,e){if(i){this.appWin.clearStatusBusy();if(!f.success){var g="";if(f.errinfo&&f.errinfo.app){g=_TT(f.errinfo.app,f.errinfo.sec,f.errinfo.key)}else{if(f.errinfo){g=_T(f.errinfo.sec,f.errinfo.key)}else{g=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),g);return}this.updateServiceWithMask(true);this.setStatusOK({text:_T("common","setting_applied"),clear:true})}else{this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+f)}},scope:this})},onCancel:function(){if(this.isDirty()){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","confirm_refresh"),function(a){if("yes"===a){this.updateServiceWithMask(true)}},this)}},updateServiceWithMaskDone:function(c,e){this.appWin.clearStatusBusy();if(c.success){var b={};b.items=c.service;if(this.mainPanel.serviceStore.getCount()!==b.items.length||true===e.reload){this.mainPanel.serviceStore.loadData(b,false);this.mainPanel.serviceStore.commitChanges()}else{for(var a=0;a<b.items.length;a++){var d=this.mainPanel.serviceStore.getById(b.items[a].name);if(d){d.set("status",b.items[a].status);if(d.modified&&"monitoring" in d.modified){continue}if(d.get("monitoring")===b.items[a].monitoring){continue}d.set("monitoring",b.items[a].monitoring);d.commit()}else{this.mainPanel.serviceStore.loadData(b,false);this.mainPanel.serviceStore.commitChanges();break}}}}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},updateServiceWithMask:function(a){this.appWin.setStatusBusy(_T("common","loading"));this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Service",version:1,method:"load",params:{reload:a},callback:function(e,c,d,b){if(e){this.updateServiceWithMaskDone(c,d)}else{this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+c)}},scope:this})},setStatusError:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","error_system"),iconCls:"syno-ux-statusbar-error",clear:true});this.getFooterToolbar().setStatus(b)},setStatusOK:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","setting_applied"),iconCls:"syno-ux-statusbar-success"});this.getFooterToolbar().setStatus(b)}});Ext.define("SYNO.SDS.HA.HAServiceListPanel",{extend:"SYNO.ux.EditorGridPanel",serviceStore:null,toolbar:null,columnModel:null,enableColumn:null,PollTask:null,constructor:function(a){this.enableColumn=new SYNO.ux.EnableColumn({header:_TT("SYNO.SDS.HA.Instance","ui","monitoring"),dataIndex:"monitoring",menuDisabled:true,disableSelectAll:_S("ha_safemode"),sortable:false,width:0.15,align:"left",isIgnore:function(d,c){return _S("ha_safemode")},renderer:function(f,d,c){var e="";if(_S("ha_safemode")){e=f?"disabled-checked":"disabled"}else{e=f?"checked":"unchecked"}return String.format('<div class="syno-ux-grid-enable-column-{0}"></div>',e)}});this.initForm();var b={border:false,store:this.serviceStore,plugins:[this.enableColumn],colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:false}),loadMask:true,stripeRows:true};Ext.apply(b,a);this.callParent([b]);this.getSelectionModel().on("rowselect",function(d,c,e){},this);this.getSelectionModel().on("rowdeselect",function(d,c){},this);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.StopAjaxRequest,this)},initForm:function(){var b=new Ext.data.Store({proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"items",id:"name"},["name","status","monitoring","type"]),remoteSort:false});this.serviceStore=b;var a=new Ext.grid.ColumnModel({columns:[{header:_TT("SYNO.SDS.HA.Instance","service","subject"),dataIndex:"name",width:0.25,align:"left",renderer:SYNO.SDS.HA.ServiceRenderer},{header:_TT("SYNO.SDS.HA.Instance","service","status"),dataIndex:"status",width:0.1,align:"left",renderer:this.statusRenderer},this.enableColumn],defaults:{sortable:false,menuDisabled:true}});this.columnModel=a},StopAjaxRequest:function(a){if(this.PollTask){this.PollTask.stop()}},statusRenderer:function(a){return _TT("SYNO.SDS.HA.Instance","service",a)}});Ext.define("SYNO.SDS.HA.HAPanelSpaceStatus",{extend:"Ext.Panel",PollID:null,PollTask:null,constructor:function(a){this.appWin=a.appWin;var b=this.fillConfig(a);this.callParent([b]);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.StopAjaxRequest,this)},fillConfig:function(a){var b={border:false,itemId:"space",layout:"fit",style:"padding: 0px 0px 10px 0px;",items:[this.mainPanel=new SYNO.SDS.HA.HASpaceListPanel({appWin:this.appWin,owner:this})]};return b},StopAjaxRequest:function(){if(this.PollTask){this.stopWebapis()}},onPageActivate:function(){this.updateSpaceWithMask();if(!this.PollTask){this.PollTask={interval:5,webapi:{api:"SYNO.Core.SHA.Panel.Space",version:1,method:"load",params:{}},status_callback:function(d,b,c,a){if(d){this.updateSpaceWithMaskDone(b,a)}else{SYNO.Debug("Ajax load failure "+b)}},scope:this}}this.startWebapis()},startWebapis:function(){this.PollID=this.appWin.pollReg(this.PollTask)},stopWebapis:function(){if(this.PollID){this.appWin.pollUnreg(this.PollID);this.PollID=null}},onPageDeactivate:function(){this.stopWebapis()},updateSpaceWithMaskDone:function(d,b){this.appWin.clearStatusBusy();if(d.success){var c={};c.items=d.spaces;if(this.mainPanel.spaceStore.getCount()!==d.spaces.length){this.mainPanel.spaceStore.loadData(c,false)}else{for(var a=0;a<d.spaces.length;a++){var e=this.mainPanel.spaceStore.getById(d.spaces[a].name);if(e){e.set("name",d.spaces[a].name);e.set("free_size",d.spaces[a].free_size);e.set("total_size",d.spaces[a].total_size);e.set("status",d.spaces[a].status);e.set("description",d.spaces[a].description);e.set("enable_repair",d.spaces[a].enable_repair)}else{this.mainPanel.spaceStore.loadData(c,false);break}}}this.mainPanel.spaceStore.commitChanges()}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}this.mainPanel.changeButtonStatus(this.mainPanel.getSelectionModel())},updateSpaceWithMask:function(){this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Space",version:1,method:"load",params:{},callback:function(d,b,c,a){if(d){this.updateSpaceWithMaskDone(b,a)}else{this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+b)}},scope:this})}});Ext.define("SYNO.SDS.HA.HASplitBrainSettings",{extend:"SYNO.SDS.ModalWindow",pingServerCheckBoxID:null,pingServerAddressID:null,constructor:function(a){this.owner=a.owner;var b={title:_TT("SYNO.SDS.HA.Instance","space","split_brain_settings"),resizable:false,width:480,height:300,padding:20,listeners:{scope:this,show:this.onShowSBSWindow},items:[this.createForm()],buttons:[{text:_T("common","apply"),scope:this,btnStyle:"blue",handler:this.onApply},{text:_T("common","cancel"),scope:this,handler:this.onCancel}]};Ext.apply(b,a);this.callParent([b])},createForm:function(){var a={xtype:"form",itemId:"pingserversetting_form",border:false,trackResetOnLoad:true,items:[{xtype:"syno_checkbox",id:this.pingServerCheckBoxID=Ext.id(),boxLabel:_TT("SYNO.SDS.HA.Instance","space","enable_ping_server"),checked:false,listeners:{scope:this,check:function(b,c){Ext.getCmp(this.pingServerAddressID).setDisabled(!c)}}},{xtype:"syno_textfield",id:this.pingServerAddressID=Ext.id(),indent:1,labelWidth:250,fieldLabel:_TT("SYNO.SDS.HA.Instance","space","ping_server_address"),emptyText:_T("common","ip_addr"),disabled:true,allowBlank:false,vtype:"ip"}]};return a},onShowSBSWindow:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Space",version:1,method:"get_ping_server",params:{},callback:function(d,b,c,a){this.clearStatusBusy();if(d){this.getPingServerDone(d,b,c,a)}else{SYNO.Debug("Ajax load failure "+b);this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},scope:this})},onApply:function(){if(!this.getComponent("pingserversetting_form").getForm().isValid()){return}var a="127.0.0.1";if(Ext.getCmp(this.pingServerCheckBoxID).checked){a=Ext.getCmp(this.pingServerAddressID).getValue()}if(!this.getComponent("pingserversetting_form").getForm().isDirty()){this.setStatusError({text:_T("error","nochange_subject"),clear:true});return}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Space",version:1,method:"set_ping_server",params:{ping_server:a},callback:function(e,c,d,b){this.clearStatusBusy();if(e){this.setPingServerDone(e,c,d,b)}else{SYNO.Debug("Ajax load failure "+c);this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},scope:this})},onCancel:function(){this.close()},getPingServerDone:function(e,c,d,b){if(c.success){var a=c.ping_server!=="127.0.0.1";Ext.getCmp(this.pingServerAddressID).setDisabled(!a);this.getComponent("pingserversetting_form").getForm().setValues([{id:this.pingServerCheckBoxID,value:a},{id:this.pingServerAddressID,value:a?c.ping_server:""}]);return}this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_unknown"));this.close()},setPingServerDone:function(e,b,d,a){if(b.success){this.close();return}var c=b.errinfo.map(function(g){var f=g.app?_TT(g.app,g.sec,g.key):_T(g.sec,g.key);return String.format(f,g.param[0],g.param[1],g.param[2],g.param[3])}).join("<br>");if(""===c){c=_T("error","error_error_system")}this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),c)}});Ext.define("SYNO.SDS.HA.HASpaceListPanel",{extend:"SYNO.ux.EditorGridPanel",spaceStore:null,columnModel:null,toolbar:null,splitBrainDialog:null,constructor:function(a){this.appWin=a.appWin;this.owner=a.owner;this.initForm();var b={store:this.spaceStore,border:false,cls:"syno-ha-space-space-list-detail",tbar:this.toolbar,height:533,colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),loadMask:true,stripeRows:true};Ext.apply(b,a);this.callParent([b]);this.getSelectionModel().on("rowselect",function(d,c,e){this.changeButtonStatus(d)},this);this.getSelectionModel().on("rowdeselect",function(d,c){this.changeButtonStatus(d)},this)},initForm:function(){var b=[{xtype:"syno_button",text:_TT("SYNO.SDS.HA.Instance","space","repair"),id:this.repairBtnID=Ext.id(),handler:this.onRepair,disabled:true,scope:this,hidden:false},{xtype:"syno_button",text:_TT("SYNO.SDS.HA.Instance","space","split_brain_settings"),handler:this.onSplitBrainSetting,disabled:_S("ha_safemode"),scope:this}];this.toolbar=b;var c=new Ext.data.Store({proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"items",id:"name"},[{name:"name",sortType:function(d){var f;var e;if(-1!==d.indexOf("iscsilun_LUN")){f=d.split("-");if(1<f.length){e=parseInt(f[1],10);if(!isNaN(e)){return e}}}else{if(-1!==d.indexOf("volume")){f=d.split("_");if(1<f.length){e=parseInt(f[1],10);if(!isNaN(e)){return e*1000}}}}return d}},"free_size","total_size","status","description","enable_repair"]),sortInfo:{field:"name",direction:"ASC"},remoteSort:false});this.spaceStore=c;var a=new Ext.grid.ColumnModel({columns:[{id:"name",header:_TT("SYNO.SDS.HA.Instance","space","space_name"),dataIndex:"name",width:0.15,align:"left",renderer:function(d,e){return SYNO.SDS.Utils.StorageUtils.SpaceIDParser(d).str}},{id:"size_in_percentage",header:_T("volume","volume_usedsize")+" (%)",dataIndex:"free_size",width:0.2,align:"left",renderer:function(d,f,g){var e=((g.get("total_size")-g.get("free_size"))*100/g.get("total_size")).toFixed(1);if(isNaN(e)||""===g.get("free_size")||""===g.get("total_size")){return"-"}else{return String.format('<div id="syno-ha-progress"><div style="width: {0}%;"></div></div><span style="display: inline;">{1}%</span>',e,e)}}},{header:_T("usb","usb_size"),dataIndex:"total_size",width:0.2,align:"left",renderer:function(f,i,j){var g=j.get("total_size")-j.get("free_size");var h=j.get("total_size");var d="";var e="";if(!isNaN(g)&&""!==j.get("free_size")){d=SYNO.SDS.Utils.StorageUtils.UiRenderHelper.SizeRender(g)}if(!isNaN(h)&&""!==j.get("total_size")){e=SYNO.SDS.Utils.StorageUtils.UiRenderHelper.SizeRender(h)}if(""===e){return"-"}if(""===d){return e}return String.format('<span style="color:#0086E5">{0}</span>&nbsp;/&nbsp;{1}',d,e)}},{header:_T("common","status"),dataIndex:"status",width:0.1,align:"left",renderer:this.SpaceStatusRender},{header:_TT("SYNO.SDS.HA.Instance","space","desc"),dataIndex:"description",width:0.25,align:"left",renderer:function(e){var d="";if(0===e.length){d=_T("volume","volume_status_waiting")}else{if(e.every(function(f){return !Boolean(f)})){d=_TT("SYNO.SDS.HA.Instance","space","space_status_normal")}else{d=e.filter(Boolean).map(function(f){var g=f.split(" ");g[0]=_TT("SYNO.SDS.HA.Instance","space",g[0]);return g.join(" ")}).join(" ")}}return'<div ext:qtip="'+Ext.util.Format.htmlEncode(d)+'">'+d+"</div>"}}],defaults:{sortable:false,menuDisabled:true}});this.columnModel=a},handleDiskRender:function(b){var d;var c=b.split(" ");var a="";if(0<c.length){for(d=0;d<c.length;d++){if(""===a){a=SYNO.SDS.HA.HADiskIndexRenderer(c[d])}else{a+=" , "+SYNO.SDS.HA.HADiskIndexRenderer(c[d])}}}return a},onRepairDone:function(b,a){var c="";this.appWin.clearStatusBusy();if(b&&b.success){this.owner.startWebapis();this.owner.updateSpaceWithMask()}else{if("none"!==b.hdd_missing){c=String.format(_TT("SYNO.SDS.HA.Instance","space","error_hdd_missing"))+"<br>";c+=this.handleDiskRender(b.hdd_missing);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),c,function(d){if("ok"===d){this.owner.startWebapis()}},this)}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_unknown"),function(d){if("ok"===d){this.owner.startWebapis()}},this)}}},onRepair:function(){var a=this.getSelectionModel().getSelected();var b={};var c="";if(-1!==a.get("description").indexOf("local_raid_degraded")||-1!==a.get("description").indexOf("local_raid_crashed")){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","space","repair_local_desc"),function(d){if("yes"===d){if("SYNO.SDS.CMS.Application"!==this.appWin.findAppWindow().getOpenConfig("className")){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}}},this);return}if(-1!==a.get("description").indexOf("local_ssd_raid_degraded")||-1!==a.get("description").indexOf("local_ssd_raid_crashed")){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","space","repair_local_fcache_desc"),function(d){if("yes"===d){if("SYNO.SDS.CMS.Application"!==this.appWin.findAppWindow().getOpenConfig("className")){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}}},this);return}if(-1!==a.get("description").indexOf("remote_ssd_raid_crashed")||-1!==a.get("description").indexOf("remote_ssd_raid_degraded")){c="repair_flashcache"}else{c="repair_space"}b.target=a.get("name");this.owner.stopWebapis();this.appWin.setStatusBusy({text:_T("pkgmgr","repairing")});this.sendWebAPI({api:"SYNO.Core.SHA.Panel.Space",version:1,method:c,timeout:300000,params:b,callback:function(g,e,f,d){if(g){this.onRepairDone(e,d)}else{this.appWin.clearStatusBusy();this.owner.startWebapis();SYNO.Debug("Ajax load failure "+e)}},scope:this})},changeButtonStatus:function(a){var c=Ext.getCmp(this.repairBtnID);var b=a.getSelected();if(!b||_S("ha_safemode")){c.disable();return}if(b.get("enable_repair")){c.enable()}else{c.disable()}},onSplitBrainSetting:function(){this.splitBrainDialog=new SYNO.SDS.HA.HASplitBrainSettings({owner:this.appWin});this.splitBrainDialog.open()},getStatus:function(a,b){this.appWin.clearStatusBusy()},SpaceStatusRender:function(a){if("normal"===a){return'<span class="syno-ha-service-status-health">'+_T("volume","volume_diskinuse")+"</span>"}else{if("operating"===a){return'<span class="syno-ha-service-status-health">'+_TT("SYNO.SDS.HA.Instance","space","operating")+"</span>"}else{if("error"===a){return'<span class="syno-ha-service-status-error">'+_T("volume","volume_status_crashed")+"</span>"}else{if("warning"===a){return'<span class="syno-ha-service-status-error">'+_T("volume","volume_status_degrade")+"</span>"}else{if("cannot_replicate"===a){return'<span class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","space","status_not_replicating")+"</span>"}else{if("no_replication"===a){return'<span class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","space","status_no_replication")+"</span>"}else{return"undefine"}}}}}}}});Ext.define("SYNO.SDS.HA.HAPanelSplitBrain",{extend:"Ext.Panel",PollID:null,PollTask:null,hasRemoteOnlineMask:false,hasTriggerGetShareList:false,lnode_online:true,rnode_online:true,lnode_name:null,rnode_name:null,constructor:function(a){this.appWin=a.appWin;var b=this.fillConfig(a);this.callParent([b]);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.StopAjaxRequest,this);Ext.getCmp(this.mainPanel.CID.ShareList).setValue(_TT("SYNO.SDS.HA.Instance","splitbrain","select_shared_folder"))},fillConfig:function(a){var b={border:false,itemId:"diff",layout:"fit",style:"padding: 0px 0px 10px 0px;",items:[this.mainPanel=new SYNO.SDS.HA.HADiffListPanel({appWin:this.appWin,owner:this})]};return b},StopAjaxRequest:function(){},startWebapis:function(){this.PollID=this.appWin.pollReg(this.PollTask)},stopWebapis:function(){if(this.PollID){this.appWin.pollUnreg(this.PollID);this.PollID=null}},onPageActivate:function(){if(!this.PollTask){this.PollTask={interval:5,immediate:true,webapi:{api:"SYNO.Core.SHA.Panel.SplitBrain",version:1,method:"load_info",params:{}},status_callback:function(e,c,d,a){if(e&&c.success){var b=false;if("lnode"==c.local_node){b=c.rnode_online}else{if("rnode"==c.local_node){b=c.lnode_online}}if(!b&&!this.hasRemoteOnlineMask){this.disableComparison(_TT("SYNO.SDS.HA.Instance","ui","remote_not_online"));this.hasRemoteOnlineMask=true}else{if(b){if(this.hasRemoteOnlineMask){this.enableComparison();this.hasRemoteOnlineMask=false}if(!this.hasTriggerGetShareList){this.getShareList();this.hasTriggerGetShareList=true}}}this.lnode_online=c.lnode_online;this.rnode_online=c.rnode_online;this.lnode_name=c.lnode_name;this.rnode_name=c.rnode_name}},scope:this}}this.startWebapis()},onPageDeactivate:function(){},enableComparison:function(){Ext.getCmp(this.mainPanel.CID.PagingToolbar).enable();Ext.getCmp(this.mainPanel.CID.ShareList).enable();this.mainPanel.unmaskView()},disableComparison:function(a){Ext.getCmp(this.mainPanel.CID.PagingToolbar).disable();Ext.getCmp(this.mainPanel.CID.ShareList).disable();this.mainPanel.maskView(a)},listShares:function(c,b){if(0>=c.shares.length){this.disableComparison(_T("error","error_no_shared_folder"));return}var a={name:_TT("SYNO.SDS.HA.Instance","splitbrain","compare_all_shares")};c.shares.splice(0,0,a);this.mainPanel.ShareStore.loadData(c,false);this.mainPanel.maskView(_TT("SYNO.SDS.HA.Instance","splitbrain","desc_select_shared_folder"))},getShareList:function(){this.appWin.setStatusBusy();this.sendGetShareList()},sendGetShareList:function(){this.sendWebAPI({api:"SYNO.Core.SHA.Panel.SplitBrain",version:1,method:"list_all_shares",params:{},callback:function(d,b,c,a){if(d){this.listShares(b,a);this.appWin.clearStatusBusy()}else{this.sendGetShareList.defer(5000,this);SYNO.Debug("Ajax load failure "+b)}},scope:this})}});Ext.define("SYNO.SDS.HA.HADiffListPanel",{extend:"SYNO.ux.EditorGridPanel",diffStore:null,columnModel:null,toolbar:null,PagingToolbar:null,displayNum:20,CID:{},currentMaskMsg:"",previousMaskMsg:"",constructor:function(a){this.appWin=a.appWin;this.owner=a.owner;this.ShareStore=new Ext.data.JsonStore({idProperty:"name",root:"shares",fields:["name"]});this.initForm();var c=new Ext.data.SimpleStore({fields:["value","display"],data:[[20,20],[40,40],[60,60],[80,80],[100,100],[150,150],[200,200],[300,300],[400,400]]});var d=new SYNO.ux.ComboBox({store:c,displayField:"display",valueField:"value",triggerAction:"all",value:this.displayNum,editable:false,width:62,mode:"local",listeners:{select:{fn:this.itemPerPageChangedHandler,scope:this}}});var b={store:this.diffStore,border:false,cls:"syno-ha-splitbrain-diff-list-detail",tbar:this.toolbar,height:533,colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),loadMask:true,stripeRows:true,bbar:this.PagingToolbar=new SYNO.ux.PagingToolbar({store:this.diffStore,pageSize:this.displayNum,id:this.CID.PagingToolbar=Ext.id(),items:[new Ext.Toolbar.TextItem(_T("common","items_perpage")),d],displayInfo:true})};Ext.apply(b,a);this.callParent([b])},itemPerPageChangedHandler:function(a){if(this.displayNum!=a.getValue()){this.displayNum=a.getValue();this.PagingToolbar.pageSize=this.displayNum;this.diffStore.baseParams.limit=this.displayNum;this.diffStore.load()}},initForm:function(){var d=this;var b=[{xtype:"syno_combobox",store:this.ShareStore,displayField:"name",valueField:"name",id:this.CID.ShareList=Ext.id(),width:350,editable:false,tpl:'<tpl for="."><div class="x-combo-list-item">'+this.renderWithTip("{name}")+"</div></tpl>",listeners:{select:{fn:function(i,f,e){this.unmaskView();var h=f.data.name;var g=(_TT("SYNO.SDS.HA.Instance","splitbrain","compare_all_shares")===h);var k=g?"list_all_difference":"list_difference";var j=("list_all_difference"===k)?{start:0,limit:this.displayNum}:{target:h,start:0,limit:this.displayNum};this.diffStore.proxy=new SYNO.API.Proxy({api:"SYNO.Core.SHA.Panel.SplitBrain",method:k,version:1});this.diffStore.baseParams=j;this.diffStore.load()},scope:this},expand:{fn:function(e){Ext.getCmp(this.CID.ShareList).setRawValue(_TT("SYNO.SDS.HA.Instance","splitbrain","select_shared_folder"))},scope:this},collapse:{fn:function(e){Ext.getCmp(this.CID.ShareList).setRawValue(e.getValue())},scope:this}}},{xtype:"syno_button",text:_TT("SYNO.SDS.HA.Instance","button","info"),style:"margin-left: 6px",handler:this.showSysAndISCSI,scope:this}];this.toolbar=b;var c=new Ext.data.Store({proxy:new SYNO.API.Proxy({api:"SYNO.Core.SHA.Panel.SplitBrain",method:null,params:null,version:1}),reader:new Ext.data.JsonReader({root:"diff",totalProperty:"total",id:"filepath"},["filepath","local_size","local_modify_time","remote_size","remote_modify_time"]),listeners:{load:{fn:function(e){if(0>=this.diffStore.getCount()){this.maskView(_TT("SYNO.SDS.HA.Instance","splitbrain","desc_data_are_identical"))}},scope:this}}});this.diffStore=c;var a=new Ext.grid.ColumnModel({columns:[{header:_T("common","file_path"),dataIndex:"filepath",width:0.3,align:"left",renderer:function(e,f,g){return d.renderWithTip(e)}},{header:_TT("SYNO.SDS.HA.Instance","splitbrain","local_size"),dataIndex:"local_size",width:0.125,align:"center",renderer:function(e,i,j){var f=j.get("local_size");var h=j.get("remote_size");var g=d.compareSize(f,h);return d.renderWithTip(d.renderSize(e),g)}},{header:_TT("SYNO.SDS.HA.Instance","splitbrain","local_modify_time"),dataIndex:"local_modify_time",width:0.225,align:"center",renderer:function(e,i,j){var f=j.get("local_modify_time");var h=j.get("remote_modify_time");var g=d.compareTime(f,h);return d.renderWithTip(d.renderTime(f),g)}},{header:_TT("SYNO.SDS.HA.Instance","splitbrain","remote_size"),dataIndex:"remote_size",width:0.125,align:"center",renderer:function(e,i,j){var f=j.get("local_size");var h=j.get("remote_size");var g=d.compareSize(h,f);return d.renderWithTip(d.renderSize(e),g)}},{header:_TT("SYNO.SDS.HA.Instance","splitbrain","remote_modify_time"),dataIndex:"remote_modify_time",width:0.225,align:"center",renderer:function(e,i,j){var f=j.get("local_modify_time");var h=j.get("remote_modify_time");var g=d.compareTime(h,f);return d.renderWithTip(d.renderTime(h),g)}}],defaults:{sortable:false,menuDisabled:false}});this.columnModel=a},renderWithTip:function(c,b){if("-"==c){return c}var a=b?String.format("<span class={0}>{1}</span>","syno-ha-split-brain-difference-text",c):c;return'<div ext:qtip="'+c+'">'+a+"</div>"},renderSize:function(a){if(0!==a&&!a){return"-"}var b=SYNO.SDS.HA.GetSize(a,2);return b.value+" "+b.unit},compareSize:function(c,a){var d=parseInt(c,10);var b=parseInt(a,10);return this.compareVal(d,b)},compareTime:function(c,a){var d=new Date(c);var b=new Date(a);return this.compareVal(d,b)},compareVal:function(b,a){if(isNaN(b)||isNaN(a)){return false}if(b<a){return true}return false},renderTime:function(b){if(""===b){b="-"}var a=SYNO.SDS.HA.GetTime(new Date(b));return a},maskView:function(a){if(a===this.currentMaskMsg){SYNO.Debug("Mask view with the same message: "+a);return}if(""!==this.currentMaskMsg){this.previousMaskMsg=this.currentMaskMsg}this.currentMaskMsg=a;this.view.el.mask(this.currentMaskMsg,"syno-ux-mask-info")},unmaskView:function(){if(""===this.currentMaskMsg){SYNO.Debug("Unmask view when there is no mask");return}this.view.el.unmask();if(""!==this.previousMaskMsg){this.view.el.mask(this.previousMaskMsg,"syno-ux-mask-info");this.currentMaskMsg=this.previousMaskMsg;this.previousMaskMsg=""}else{this.currentMaskMsg=""}},showSysAndISCSI:function(){this.dialog=new SYNO.SDS.HA.HASBInfoDialog({appWin:this.appWin,lnode_online:this.owner.lnode_online,rnode_online:this.owner.rnode_online,lnode_name:this.owner.lnode_name,rnode_name:this.owner.rnode_name});this.dialog.open()}});Ext.define("SYNO.SDS.HA.HASBInfoDialog",{extend:"SYNO.SDS.ModalWindow",lnode_online:false,rnode_online:false,lnode_name:null,rnode_name:null,constructor:function(a){this.appWin=a.appWin;this.lnode_online=a.lnode_online;this.rnode_online=a.rnode_online;this.lnode_name=a.lnode_name;this.rnode_name=a.rnode_name;this.leftNodePanel=new SYNO.SDS.HA.SplitBrain.GeneralTab({appWin:this.appWin,owner:this,title:this.lnode_name,node:"lnode",online:this.lnode_online});this.rightNodePanel=new SYNO.SDS.HA.SplitBrain.GeneralTab({appWin:this.appWin,owner:this,title:this.rnode_name,node:"rnode",online:this.rnode_online});var c=[this.leftNodePanel,this.rightNodePanel];this.tabpanel=new SYNO.SDS.HA.TabPanel({appWin:this.appWin,owner:this,tabPanels:c});var b={title:"System & iSCSI Information",autoDestroy:true,modal:false,resizable:false,width:740,height:530,layout:"fit",border:false,listeners:{scope:this,activate:this.onActivate},items:[this.tabpanel],buttons:[{text:_T("common","close"),scope:this,handler:this.onCancel}]};this.callParent([b])},onActivate:function(){if(this.lnode_name&&this.lnode_online){this.leftNodePanel.setTitle(this.lnode_name);this.leftNodePanel.enable()}else{if(!this.lnode_online){this.leftNodePanel.setTitle(this.lnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(1)}this.leftNodePanel.disable()}else{this.leftNodePanel.setTitle("N/A");if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(1)}this.leftNodePanel.disable()}}if(this.rnode_name&&this.rnode_online){this.rightNodePanel.setTitle(this.rnode_name);this.rightNodePanel.enable()}else{if(!this.rnode_online){this.rightNodePanel.setTitle(this.rnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}this.rightNodePanel.disable()}else{this.rightNodePanel.setTitle("N/A");if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}this.rightNodePanel.disable()}}},onCancel:function(){this.close()}});Ext.define("SYNO.SDS.HA.SplitBrain.GeneralTab",{extend:"Ext.Panel",activeTimeID:null,spiltbrainTimeID:null,uiData:null,dataGotten:null,online:null,constructor:function(a){this.appWin=a.appWin;this.owner=a.owner;this.online=a.online;this.view=undefined;this.createView();var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var b={title:a.title,node:a.node,hideMode:"offsets",listeners:{scope:this,activate:this.onActivate},items:[this.createSystemInfo(),this.createISCSIInfo()]};Ext.apply(b,a);return b},createView:function(){var d=SYNO.SDS.HA.SplitBrain.PropertyTpl(),a=new SYNO.SDS.HA.SplitBrain.ListTpl({scope:"log",title:_TT("SYNO.SDS.HA.Instance","splitbrain","recent_history"),emptyText:_T("log","no_log_available"),columns:[{header:_T("log","log_subtitle"),dataIndex:"history"}]}),c,b;c=new Ext.XTemplate('<div class="item-detail-inner">',d.html,a.html,"</div>");b={owner:this,dataType:"splitbrain-iscsi",itemId:"targetView",multiSelect:false,singleSelect:true,detailTpl:c,store:new SYNO.SDS.HA.SplitBrain.iSCSITrg.Store()};this.view=new SYNO.SDS.HA.SplitBrain.DataView(b)},onActivate:function(a){if(!this.online||this.dataGotten){return}this.dataGotten=true;this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Panel.SplitBrain",version:1,params:{node:this.node},method:"list_system_info",callback:function(e,c,d,b){if(e){Ext.getCmp(this.activeTimeID).setValue(c.sys_info.active_time);Ext.getCmp(this.splitbrainTimeID).setValue(c.sys_info.split_brain_time)}else{SYNO.Debug("Ajax load failure "+c)}this.sendWebAPI({api:"SYNO.Core.SHA.Panel.SplitBrain",version:1,params:{node:this.node},method:"list_iscsi_info",callback:function(i,g,h,f){this.owner.clearStatusBusy();if(i){this.iscsiInfoDoneHandler(g)}else{SYNO.Debug("Ajax load failure "+g)}},scope:this})},scope:this})},createSystemInfo:function(){var a={xtype:"syno_fieldset",title:_T("home","home_subject"),collapsible:false,labelWidth:350,items:[{fieldLabel:_TT("SYNO.SDS.HA.Instance","splitbrain","recently_active_time"),id:this.activeTimeID=Ext.id(),xtype:"syno_displayfield",value:""},{fieldLabel:_TT("SYNO.SDS.HA.Instance","splitbrain","split_brain_time"),id:this.splitbrainTimeID=Ext.id(),xtype:"syno_displayfield",value:""}]};return a},createISCSIInfo:function(){var a={xtype:"syno_fieldset",title:"iSCSI Target",collapsible:false,items:this.view};return a},iscsiInfoDoneHandler:function(a){this.uiData=[];Ext.each(a.iscsi_info,function(d){var c={};c.id=d.tid;c.displayName=d.name;c.iconCls="sm-list-icon-target";c.desc=d.iqn;c.property=[{name:_T("common","name"),value:d.name},{name:"IQN",value:d.iqn},{name:_T("iscsitrg","iscsitrg_mapped_lun"),value:d.LUNs}];c.log=[];for(var b=0;b<d.history.length;b++){c.log.push({history:d.history[b]})}this.uiData.push(c)},this);this.view.store.loadData(this.uiData,false)}});Ext.define("SYNO.SDS.HA.SplitBrain.iSCSITrg.Store",{extend:"Ext.data.JsonStore",constructor:function(a){var c=this,b;c.sortField="numId";c.sortDir="ASC";b={autoDestroy:true,idProperty:"id",fields:["numId","id","iconCls","statusIconCls","displayName","summaryStatus","property","log"],listeners:{load:function(){c.sort(c.sortField,c.sortDir)},scope:c}};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.HA.SplitBrain.DataView",{extend:"SYNO.ux.ExpandableListView",singleExpanded:true,height:250,constructor:function(a){var c=this,b;c.expandedItemId={};c.selectedItemId={};c.appWin=a.appWin;c.owner=a.owner;c.usageTpl=a.usageTpl;c.detailTpl=a.detailTpl;c.isCardLayout=a.isCardLayout;b={tpl:this.createTpl(),trackResetOnLoad:false};c.callParent([Ext.apply(b,a)])},createTpl:function(){var b=this;var a=new Ext.XTemplate('<tpl for=".">','<div class="item-wrap" itemId="{id}" id="{id}">','<div class="item-summary">','<div class="item-icon sm-list-icon {iconCls}"></div>','<div class="sm-list-status-icon {statusIconCls}"></div>',"<div>",'<span class="item-title">{displayName}</span>',"{summaryStatus}",'<div class="item-status">{desc}</div>',"</div>",(b.usageTpl)?b.usageTpl.html:"",(b.isCardLayout)?'<div class="sm-list-next-btn"><div class="sm-list-next-img"></div></div>':('<tpl if="property">'+((b.detailTpl)?'<div class="item-toggle"><div class="item-toggle-img"></div></div>':"")+"</tpl>"),"</div>",'<tpl if="property">','<div class="item-detail" style="display:none">',(b.detailTpl)?b.detailTpl.html:"","</div>","</tpl>","</div>","</tpl>",'<div class="x-clear"></div>',{hasValues:function(c){if(!c){return false}return 0<c.length}});return a},getSelectedItemIds:function(){var a,b,c=[];a=this.getSelectedRecords();for(b=0;b<a.length;++b){if(!a[b]){continue}c.push(a[b].get("id"))}return c},getSelectedItems:function(){var c=this,a=c.getSelectedItemIds(),d=c.appWin[c.dataType].data,b=[];Ext.each(a,function(e){if(e in d){if(d[e]){b.push(d[e])}}});return b},getSelectedItem:function(){var b=this;var a=b.getSelectedItems();if(0===a.length){return}return a[0]},onClick:function(d,c,b){this.callParent(arguments);if(!this.isCardLayout){return}var a=Ext.fly(c);if(a&&(a.hasClass("sm-list-next-btn")||a.hasClass("sm-list-next-img"))){this.owner.fireEvent("nextDetail")}},onDblClick:function(c,b,a){if(this.isCardLayout){this.owner.fireEvent("nextDetail");return}this.callParent(arguments)}});SYNO.SDS.HA.SplitBrain.PropertyTpl=function(){var a=new Ext.XTemplate("<div>",'<tpl for="property">',"<dl>",'<dt class="sm-grid-property-name">{name}</dt>','<dt class="sm-grid-property-value">{value}</dt>','<div style="clear:both"></div>',"</dl>","</tpl>",'<div class="x-clear"></div>',"</div>");return a};SYNO.SDS.HA.SplitBrain.ListTpl=function(b){var a,g,e,c=[],f=[],h,d;g=b.title||_T("smart","smart_toolbar_disk_info");a=b.emptyText||_T("volume","volume_status_none");e=100/b.columns.length;Ext.each(b.columns,function(i){c.push(String.format('<dt class="sm-grid-disk-list-column" style="width:{0}%">{1}</dt>',i.width?i.width:e,i.header));f.push(String.format('<dt class="sm-grid-disk-list-column" style="width:{0}%">{{1}}</dt>',i.width?i.width:e,i.dataIndex))});h=new Ext.XTemplate(String.format('<tpl if="this.hasValues(values.{0}) == false">',b.scope),String.format('<div style="padding-left:10px;height:28px;line-height:28px">{0}</div>',a),"</tpl>",String.format('<tpl for="{0}">',b.scope),'<dl class="sm-grid-disk-list-row">',f.join(""),'<div class="x-clear"></div>',"</dl>","</tpl>");d=new Ext.XTemplate(String.format('<div class="sm-grid-section-header">{0}</div>',g),'<div class="sm-grid-disk-list">','<div class="sm-grid-disk-list-header">','<dl style="padding-left:10px;">',c.join(""),'<div class="x-clear"></div>',"</dl>","</div>",'<div class="sm-grid-disk-list-body">',h.html,"</div>","</div>",'<div class="x-clear"></div>');return d};Ext.ns("SYNO.SDS.HA");Ext.define("SYNO.SDS.HA.NodeSetupPanel",{extend:"SYNO.ux.FormPanel",ServerStore:null,constructor:function(b){this.ServerList=[];this.ServerStore=new Ext.data.SimpleStore({fields:["value","display"],data:this.ServerList});var a={layout:"vbox",layoutConfig:{align:"center",pack:"start"},padding:"0px 0px 0px 0px",items:[{xtype:"panel",width:SYNO.SDS.HA.CONF_CONTD_WIDTH+80,border:false,padding:"20px 0px 0px 0px",items:[{xtype:"syno_textfield",hideLabel:true,name:"server",allowBlank:false,emptyText:_T("common","ip_addr"),editable:true,cls:"synoha-login-field",width:SYNO.SDS.HA.CONF_CONTD_WIDTH,validator:function(h){var e="";var c="";var g=new RegExp(e,"gi");if(h===c||h==="127.0.0.1"||(h.match(g)&&h.length===e.length)){return _T("netbackup","netbkp_sync_self")}var f=c.split(",");for(var d=0;d<f.length;d++){if(h===f[d]){return _T("netbackup","netbkp_sync_self")}}return true}},{xtype:"syno_compositefield",hideLabel:true,name:"port_composite_field",cls:"synoha-login-field",items:[{xtype:"syno_numberfield",name:"port",allowBlank:false,emptyText:_T("common","port"),width:SYNO.SDS.HA.CONF_CONTD_WIDTH,vtype:"port"},{xtype:"syno_checkbox",boxLabel:_T("common","https"),name:"enable_https"}]},{xtype:"syno_textfield",hideLabel:true,name:"account",allowBlank:false,emptyText:_T("netbackup","netbkp_account"),cls:"synoha-login-field",width:SYNO.SDS.HA.CONF_CONTD_WIDTH,vtype:"username_ext"},{xtype:"syno_textfield",hideLabel:true,name:"password",allowBlank:false,emptyText:_T("common","password"),inputType:"password",cls:"synoha-login-field",width:SYNO.SDS.HA.CONF_CONTD_WIDTH},{xtype:"syno_textfield",hideLabel:true,name:"otp_code",allowBlank:false,emptyText:_T("login","enter_otp_desc"),hidden:true,disabled:true,cls:"synoha-login-field",width:SYNO.SDS.HA.CONF_CONTD_WIDTH,vtype:"digit"}]}]};SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},showLoginField:function(a){a.findField("server").show();a.findField("port_composite_field").show();a.findField("account").show();a.findField("password").show();a.findField("otp_code").hide();a.findField("otp_code").setValue("");a.findField("otp_code").disable()},showOTPField:function(a){a.findField("otp_code").enable();a.findField("otp_code").show();a.findField("server").hide();a.findField("port_composite_field").hide();a.findField("account").hide();a.findField("password").hide()},activate:function(){var a=this.getForm();if(false===a.findField("otp_code").disabled){this.showLoginField(a)}},getBack:function(){var a=this.getForm();if(true===a.findField("otp_code").disabled){return"welcome"}else{this.showLoginField(a);return false}},saveSettings:function(){var a=this.getForm().findField("server").getRawValue();this.owner.passiveIP=SYNO.SDS.HA.GetServerIP(a);this.owner.port=this.getForm().findField("port").getValue();this.owner.is_https_port=this.getForm().findField("enable_https").checked},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();this.testConnections("next");return false},summary:function(e){var d=this.getForm();var b=d.findField("server").getRawValue();var a=SYNO.SDS.HA.GetServerName(b);var c=SYNO.SDS.HA.GetServerIP(b);var f;if(a!==""){f=a;if(c!==""){f+="("+c+")"}}else{f=c}e.append(_TT("SYNO.SDS.HA.Instance","wizard","hapassive_node"),f)},remoteVerifyDone:function(e,c,d,b){if(!c.success){SYNO.SDS.HA.ShowErrMsg(this.owner,c.errinfo,SYNO.SDS.HA.DefaultBindingErrorString);return}this.owner.groupInfo=c.group_info;if(true===c.group_info.is_hybrid||true===c.group_info.mem_size_unmatched){var a=_TT("SYNO.SDS.HA.Instance","wizard","warning_different_infor")+"<br>";if(true===c.group_info.is_hybrid){a+=_T("common","ds_model")+"<br>"}if(true===c.group_info.mem_size_unmatched){a+=_T("status","ramsize")+"<br>"}a+="<br>"+_TT("SYNO.SDS.HA.Instance","wizard","warning_performance_degraded");if(true===c.group_info.is_hybrid){a+="<br>"+_TT("SYNO.SDS.HA.Instance","wizard","warning_hybrid_lead_feature_lost")}this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),a,function(f){if("ok"===f){this.owner.goNext(this.nextId)}},this)}else{this.owner.goNext(this.nextId)}},remoteVerify:function(){var a={};a=this.getParamsVal(a);if(a){this.owner.el.mask(_T("common","loading"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Panels",version:1,method:"verify_remote",encryption:["username","passwd"],params:a,callback:function(e,c,d,b){this.owner.el.unmask();if(e){this.remoteVerifyDone(e,c,d,b)}else{SYNO.Debug("Ajax load failure "+c);SYNO.SDS.HA.ShowRespErrMsg(this.owner,c.code,true)}},scope:this})}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("netbackup","netbkp_err_host_str"))}},testConnectionWhenGoNext:function(e,c,d,b){if(!c.success){if(c.request_otp){var a=this.getForm();this.showOTPField(a)}else{SYNO.SDS.HA.ShowErrMsg(this.owner,c.errinfo,SYNO.SDS.HA.DefaultBindingErrorString)}return}this.remoteVerify()},testConnections:function(b){var a={};a=this.getParamsVal(a);if(a){this.owner.el.mask(_T("common","loading"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Panels",version:1,method:"login_remote",timeout:300*1000,encryption:["username","passwd"],params:a,callback:function(f,d,e,c){this.owner.el.unmask();if(f){this.testConnectionWhenGoNext(f,d,e,c)}else{SYNO.Debug("Ajax load failure "+d);SYNO.SDS.HA.ShowRespErrMsg(this.owner,d.code,true)}},scope:this})}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("netbackup","netbkp_err_host_str"))}},getParamsVal:function(g){var f=this.getForm();var b=SYNO.SDS.HA.GetServerName(f.findField("server").getRawValue());var e=SYNO.SDS.HA.GetServerIP(f.findField("server").getRawValue());var h=f.findField("account").getValue();var d=f.findField("password").getValue();var c=f.findField("port").getValue();var a=f.findField("enable_https").checked;if(b===""&&e===""){this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("netbackup","netbkp_err_host_str"));return false}g.server=b;g.address=e;g.port=c;g.is_https_port=a;g.username=h;g.passwd=d;if(false===f.findField("otp_code").disabled){g.otp_code=f.findField("otp_code").getValue()}return g}});Ext.define("SYNO.SDS.HA.ChannelSetupPanel",{extend:"SYNO.ux.FormPanel",LANStore:null,loginIf:"",constructor:function(b){this.filteredLANList=[];this.allLANList=[];this.LANStore=new Ext.data.SimpleStore({id:"value",fields:["value","display"],data:this.filteredLANList});var a={padding:"0px",cls:"syno-ha-wizard-channel-setup-panel",items:[{xtype:"syno_displayfield",value:_TT("SYNO.SDS.HA.Instance","wizard","drbd_channel")},{xtype:"syno_combobox",synotype:"indent",hideLabel:true,name:"lanport",allowBlank:false,editable:false,store:this.LANStore,displayField:"display",valueField:"value",triggerAction:"all",width:SYNO.SDS.HA.CONF_CONTD_WIDTH,mode:"local",owner:this},{xtype:"panel",hideLabel:true,id:this.connectionFigID=Ext.id(),padding:"8px 0px 8px 0px",height:120,border:false,cls:"syno-ha-wizard-channel-setup-figure"},{xtype:"syno_displayfield",value:_TT("SYNO.SDS.HA.Instance","wizard","desc_heartbeat_constraint")}]};SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a]);this.mon(this.getForm().findField("lanport"),"select",this.refreshPicture,this)},activate:function(){this.filteredLANList.length=0;this.allLANList.length=0;this.LANListEnum()},refreshPicture:function(){var a=this.getForm().findField("lanport").getValue();this.applyLANImage(Ext.getCmp(this.connectionFigID),a)},saveSettings:function(){this.owner.dataRepChannel=this.getForm().findField("lanport").getValue();this.owner.activeLoginIf=this.loginIf},checkLANDone:function(e,b,d,a){if(b.success){this.CheckHeartbeatLink();return}if("error_active_direct_connect"===b.errinfo.key){var c=String.format(_TT(b.errinfo.app,b.errinfo.sec,b.errinfo.key),SYNO.SDS.Utils.Network.idToString(this.owner.dataRepChannel));this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),c)}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T(b.errinfo.sec,b.errinfo.key))}},CheckHeartbeatLinkDone:function(d,b,c,a){if(!b.success){SYNO.SDS.HA.ShowErrMsg(this.owner,b.errinfo,SYNO.SDS.HA.DefaultBindingErrorString);return}this.owner.goNext(this.nextId)},checkLAN:function(){var a={};a["interface"]=this.getForm().findField("lanport").getValue();this.owner.el.mask(_TT("SYNO.SDS.HA.Instance","wizard","heartbeat_connection_checking"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Panels",version:1,method:"check_directconnect",params:a,callback:function(e,c,d,b){this.owner.el.unmask();if(e){this.checkLANDone(e,c,d,b)}else{SYNO.Debug("Ajax load failure "+c);SYNO.SDS.HA.ShowRespErrMsg(this.owner,c.code,true)}},scope:this})},CheckHeartbeatLink:function(){var a={};a["interface"]=this.getForm().findField("lanport").getValue();a.remote_addr=this.owner.passiveIP;a.port=this.owner.port;a.is_https_port=this.owner.is_https_port;this.owner.el.mask(_TT("SYNO.SDS.HA.Instance","wizard","heartbeat_connection_testing"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Panels",version:1,method:"check_heartbeat_link",params:a,callback:function(e,c,d,b){this.owner.el.unmask();if(e){this.CheckHeartbeatLinkDone(e,c,d,b)}else{SYNO.Debug("Ajax load failure "+c);SYNO.SDS.HA.ShowRespErrMsg(this.owner,c.code,true)}},scope:this})},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();this.checkLAN();return false},summary:function(a){a.append(_TT("SYNO.SDS.HA.Instance","wizard","drbd_channel"),SYNO.SDS.Utils.Network.idToString(this.owner.dataRepChannel))},LANListEnumDone:function(h,g,c,a){if(!g.success){this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T(g.errinfo.sec,g.errinfo.key));this.owner.getButton("next").disable();return}this.loginIf=g.loginIf;for(var e=0;e<g.lanlist.length;e++){if("connected"!==g.lanlist[e].status){continue}switch(g.lanlist[e].type){case"lan":case"bond":case"ovseth":case"ovsbond":break;default:continue}var f=SYNO.SDS.Utils.Network.idToString(g.lanlist[e].ifname)+((10000>g.lanlist[e].speed)?"":" ("+g.lanlist[e].speed/1000+"Gbps)");if(1!==g.lanlist.length||-1===f.indexOf("1")){this.allLANList.push([g.lanlist[e].ifname,f,g.lanlist[e].mask])}else{this.allLANList.push([g.lanlist[e].ifname,_T("helptoc","lan")],g.lanlist[e].mask)}if(g.loginIf===g.lanlist[e].ifname){continue}if(g.has10GEthernet&&10000>g.lanlist[e].speed){continue}if(1!==g.lanlist.length||-1===f.indexOf("1")){this.filteredLANList.push([g.lanlist[e].ifname,f])}else{this.filteredLANList.push([g.lanlist[e].ifname,_T("helptoc","lan")])}}this.filteredLANList.sort(function(k,i){return SYNO.SDS.HA.NetIFCompareFunc(k[0],i[0])});this.LANStore.loadData(this.filteredLANList,false);if(0<this.filteredLANList.length){var b=0;var j=this.getForm().findField("lanport");var d=j.getValue();if(d){for(e=0;e<this.filteredLANList.length;e++){if(d===this.filteredLANList[e][0]){b=e;break}}}j.setValue(this.filteredLANList[b][0]);this.applyLANImage(Ext.getCmp(this.connectionFigID),this.filteredLANList[b][0])}else{this.getForm().findField("lanport").setValue(_T("status","status_not_available"));this.owner.getButton("next").disable();if(g.has10GEthernet){this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","error_fastest_IF_for_heartbeat"))}}},applyLANImage:function(b,c){for(var a=0;a<SYNO.SDS.HA.CONF_MAX_HA_IF_NUM;a++){b.removeClass("syno-ha-wizard-channel-eth"+a)}if(-1!=c.indexOf("ovs_eth")){c=c.substring(4)}b.addClass("syno-ha-wizard-channel-"+c)},LANListEnum:function(){this.owner.el.mask(_T("common","loading"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Panels",version:1,method:"enum_lanlist",params:{},callback:function(d,b,c,a){this.owner.el.unmask();if(d){this.LANListEnumDone(d,b,c,a)}else{SYNO.Debug("Ajax load failure "+b);SYNO.SDS.HA.ShowRespErrMsg(this.owner,b.code,true);this.owner.getButton("next").disable()}},scope:this})}});Ext.define("SYNO.SDS.HA.NetSetupPanel",{extend:"SYNO.ux.FormPanel",LANStore:null,constructor:function(b){this.owner=b.owner;this.LANList=[];this.LANMaskList=[];this.LANStore=new Ext.data.SimpleStore({id:"value",fields:["value","display"],data:this.LANList});var a={padding:"0px",items:[{xtype:"syno_textfield",fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","virtual_server"),name:"hostname",vtype:"netbiosName",maxlength:15,allowBlank:false,labelWidth:SYNO.SDS.HA.CONF_LABEL_WIDTH,width:SYNO.SDS.HA.CONF_CONTD_WIDTH},{xtype:"syno_displayfield",indent:0,value:_TT("SYNO.SDS.HA.Instance","wizard","virtual_ip_interface")},{xtype:"syno_combobox",indent:2,synotype:"indent",fieldLabel:_TT("SYNO.SDS.HA.Instance","wizard","network_interface"),name:"lanport",allowBlank:false,editable:false,store:this.LANStore,displayField:"display",valueField:"value",triggerAction:"all",labelWidth:SYNO.SDS.HA.CONF_LABEL_WIDTH,width:SYNO.SDS.HA.CONF_CONTD_WIDTH,mode:"local",owner:this,listeners:{scope:this,select:function(){this.updateMaskValue()}}},{xtype:"syno_textfield",indent:2,fieldLabel:_T("common","ip_addr"),name:"ip_addr",vtype:"ip",maxlength:64,allowBlank:false,labelWidth:SYNO.SDS.HA.CONF_LABEL_WIDTH,width:SYNO.SDS.HA.CONF_CONTD_WIDTH},{xtype:"syno_textfield",indent:2,fieldLabel:_T("pppoe","pppoe_mask"),name:"net_mask",vtype:"netmask",maxlength:64,allowBlank:false,labelWidth:SYNO.SDS.HA.CONF_LABEL_WIDTH,width:SYNO.SDS.HA.CONF_CONTD_WIDTH}]};SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){this.LANList.length=0;this.LANMaskList.length=0;this.updateLANList()},saveSettings:function(){var a=this.getForm();this.owner.hostname=a.findField("hostname").getValue();this.owner.netInterface=a.findField("lanport").getValue();this.owner.netIP=a.findField("ip_addr").getValue();this.owner.netMask=a.findField("net_mask").getValue()},networkCheckDone:function(d,b,c,a){if(!b.success){SYNO.SDS.HA.ShowErrMsg(this.owner,b.errinfo,SYNO.SDS.HA.DefaultBindingErrorString);return}this.owner.goNext(this.nextId)},checkSetting:function(){var b={};var a=this.getForm();b.hostname=a.findField("hostname").getValue();b.net_interface=a.findField("lanport").getValue();b.net_ip=a.findField("ip_addr").getValue();b.net_mask=a.findField("net_mask").getValue();this.owner.el.mask(_T("common","loading"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Panels",version:1,method:"network_check",params:b,callback:function(f,d,e,c){this.owner.el.unmask();if(f){this.networkCheckDone(f,d,e,c)}else{SYNO.Debug("Ajax load failure "+d);SYNO.SDS.HA.ShowRespErrMsg(this.owner,d.code,true)}},scope:this})},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();this.checkSetting();return false},summary:function(c){var b=this.getForm();var a=b.findField("lanport").getValue();c.append(_TT("SYNO.SDS.HA.Instance","ui","virtual_server"),b.findField("hostname").getValue());c.append(_TT("SYNO.SDS.HA.Instance","wizard","network_interface"),SYNO.SDS.Utils.Network.idToString(a));c.append(_T("common","ip_addr"),b.findField("ip_addr").getValue());c.append(_T("pppoe","pppoe_mask"),b.findField("net_mask").getValue())},updateLANList:function(){var e=this.owner.PanelChannelSetup.allLANList;var b=0;var d=this.getForm().findField("lanport");var a=d.getValue();for(var c=0;c<e.length;c++){if(this.owner.dataRepChannel!==e[c][0]){this.LANList.push([e[c][0],e[c][1]]);this.LANMaskList.push(e[c][2]);if((!a&&this.owner.activeLoginIf===e[c][0])||a===e[c][0]){b=this.LANList.length-1}}}this.LANStore.loadData(this.LANList,false);if(0<this.LANList.length){d.setValue(this.LANList[b][0]);this.getForm().findField("net_mask").setValue(this.LANMaskList[b])}else{this.owner.getButton("next").disable()}},updateMaskValue:function(){var a=this.getForm().findField("lanport").getValue();for(var b=0;b<this.LANList.length;b++){if(a===this.LANList[b][0]){this.getForm().findField("net_mask").setValue(this.LANMaskList[b])}}}});Ext.define("SYNO.SDS.HA.HASetupWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",selfIPs:null,selfHostName:null,groupInfo:null,passiveIP:null,port:null,is_https_port:null,dataRepChannel:null,activeLoginIf:null,hostname:null,netInterface:null,netIP:null,netMask:null,binding_progress_desc:null,binding_progress:null,PollID:null,PollTask:null,PanelWelcome:null,PanelNodeSetup:null,PanelChannelSetup:null,PanelNetSetup:null,PanelSummary:null,constructor:function(c){var a=SYNO.SDS.HA;this.appWin=c.owner;this.PanelWelcome=new SYNO.SDS.Wizard.WelcomeStep({headline:_TT("SYNO.SDS.HA.Instance","wizard","welcome_title"),description:this.getWelcomeDesc(),itemId:"welcome",nextId:"nodesetup",cls:"synoha-list-style",owner:this,getNext:function(){this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Wizard",version:1,method:"wizard_first_check",params:{},callback:function(g,e,f,d){this.owner.clearStatusBusy();if(!g){SYNO.SDS.HA.ShowRespErrMsg(this.owner,e.code,true);SYNO.Debug("Ajax load failure "+e)}else{if(!e.success){SYNO.SDS.HA.ShowErrMsg(this.owner,e.errinfo,SYNO.SDS.HA.DefaultBindingErrorString);return}this.owner.goNext(this.nextId)}},scope:this});return false}});this.PanelNodeSetup=new a.NodeSetupPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","nodesetup_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","nodesetup_desc"),itemId:"nodesetup",nextId:"channelsetup",header:false,owner:this});this.PanelChannelSetup=new a.ChannelSetupPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","channel_setup_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","channel_setup_desc"),itemId:"channelsetup",nextId:"netsetup",header:false,owner:this});this.PanelNetSetup=new a.NetSetupPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","virtual_network_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","virtual_network_desc"),itemId:"netsetup",nextId:"summary",header:false,owner:this});this.PanelSummary=new SYNO.SDS.Wizard.SummaryStep({autoScroll:true,headline:_T("localbkpwizard","summary_title"),description:_T("wizcommon","summary_descr"),itemId:"summary",nextId:null,getNext:function(){this.owner.checkWarningService();return false},owner:this});var b=[this.PanelWelcome,this.PanelNodeSetup,this.PanelChannelSetup,this.PanelNetSetup,this.PanelSummary];this.callParent([Ext.apply({title:_TT("SYNO.SDS.HA.Instance","wizard","wizard_title"),width:750,height:525,steps:b},c)])},getWelcomeDesc:function(){var b=[_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_step_setting_passive"),_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_step_setting_heartbeat"),_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_step_setting_ha_if")];var a=[_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning_not_support"),_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning_if_constrain"),_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning_heartbeat_constrain"),_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning_ha_if_constrain"),_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning_ddsm_support")];var c=SYNO.SDS.HA.MakeOL(b)+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc_warning"),SYNO.SDS.HA.MakeUL(a));return String.format(_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc"),c)},genApplyParams:function(){var a={};a.mode="activate";a.remote_address=SYNO.SDS.HA.GetServerIP(this.PanelNodeSetup.getForm().findField("server").getRawValue());a.is_hybrid=this.groupInfo.is_hybrid;a.model_group=this.groupInfo.model_group;a.model0=this.groupInfo.model0;a.model1=this.groupInfo.model1;a.lan_num=this.groupInfo.lan_num;a.drbd_if_origin=this.dataRepChannel;a.ha_hostname=this.hostname;a.ha_if=this.netInterface;a.ha_ip=this.netIP;a.ha_netmask=this.netMask;return a},updateBindingProgress:function(b,a){this.el.unmask();if(b.success){this.binding_progress_desc=b.binding_progress_desc;this.binding_progress=b.binding_progress}else{this.binding_progress_desc="stage_unknown"}},checkActivateEnvironmentDone:function(d,b,c,a){if(!b.success){SYNO.SDS.HA.ShowErrMsg(this,b.errinfo,SYNO.SDS.HA.DefaultBindingErrorString);return}this.sendRequest(b.activate_data)},bindRemoteDone:function(d,b,c,a){if(!b.success){SYNO.SDS.HA.ShowErrMsg(this,b.errinfo,SYNO.SDS.HA.DefaultBindingErrorString);return}SYNO.SDS.StatusNotifier.fireEvent("halt");this.PollTask={preventHalt:true,interval:5,webapi:{api:"SYNO.Core.SHA.Setup.Wizard",version:1,method:"load_binding_progress",params:{}},status_callback:function(h,f,g,e){if(h){this.updateBindingProgress(f,e)}else{SYNO.Debug("Ajax load failure "+f)}},scope:this};this.startWebapis();this.waitForBinding({times:1800000/1000,msg:_TT("SYNO.SDS.HA.Instance","wizard","wait_for_response")})},startWebapis:function(){this.PollID=this.appWin.pollReg(this.PollTask)},stopWebapis:function(){if(this.PollID){this.appWin.pollUnreg(this.PollID);this.PollID=null}},redirect:function(a,c,e){var d=e||20000;var b=0;if(!Ext.isString(a)||!Ext.isArray(c)){return}SYNO.SDS.StatusNotifier.fireEvent("redirect");window.onbeforeunload=null;var f=function(g){SYNO.Debug("try "+c[g%c.length]);location.assign(a.replace("__WEBMAN_ADDR__",c[g%c.length]))};f.defer(d,this,[0]);for(b=0;b<3;b++){d+=10000;f.defer(d,this,[0])}for(b=1;b<=c.length;b++){d+=10000;f.defer(d,this,[b])}this.waitForNewIP({times:d/1000,msg:_TT("SYNO.SDS.HA.Instance","wizard","wait_for_newIP")})},waitForNewIP:function(e){var f=e.times||10;var b=f;var c=e.interval||1000;var a=Ext.isDefined(e.no_close)?e.no_close:true;SYNO.SDS.Desktop.getMsgBox().show({title:e.title||this.title,width:e.width||240,progress:true,closable:false});var d=function(){b--;if(0===b&&!a){if(Ext.isFunction(e.callback)){e.callback.call(e.scope||this)}SYNO.SDS.Desktop.getMsgBox().hide();return}if(0===b){b=f}SYNO.SDS.Desktop.getMsgBox().updateProgress(1-b/f,_TT("SYNO.SDS.HA.Instance","wizard","wait_for_newIP"));d.defer(c,this)};d.defer(c,this)},sendRedirectReq:function(){var a={};this.el.mask(_T("common","loading"),"x-mask-loading");a.mode="activate_ha";this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Wizard",version:1,method:"redirect_ip",params:a,callback:function(e,c,d,b){this.el.unmask();if(e){if(c.success){this.redirect(c.redirect_url,c.ip_list)}}else{SYNO.Debug("Ajax load failure "+c)}},scope:this})},waitForBinding:function(d){var e=d.times||10;var a=e;var b=d.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:d.title||this.title,width:d.width||240,progress:true,closable:false});var c=function(){a--;if("stage_binding_done"===this.binding_progress_desc){this.stopWebapis();this.startWebapis();SYNO.SDS.Desktop.getMsgBox().hide();this.sendRedirectReq();return}else{if("stage_binding_failed"===this.binding_progress_desc){this.stopWebapis();this.startWebapis();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","stage_binding_failed"),function(g){if("ok"===g){window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close()}},this);return}}if(0===a){this.stopWebapis();this.startWebapis();this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","stage_binding_failed"),function(g){if("ok"===g){window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close()}},this);return}var f=_TT("SYNO.SDS.HA.Instance","wizard",this.binding_progress_desc)||d.msg;SYNO.SDS.Desktop.getMsgBox().updateProgress((1-a/e)+this.binding_progress/200,f,_TT("SYNO.SDS.HA.Instance","ui","do_not_turnoff"));c.defer(b,this)};c.defer(b,this)},checkWarningServiceDone:function(f,d,e,c){var b=_TT("SYNO.SDS.HA.Instance","wizard","warning_binding_remote_stop_service");var a=[];a.push(_TT("SYNO.SDS.HA.Instance","wizard","warning_binding_remove_passive_data"));a.push(_TT("SYNO.SDS.HA.Instance","wizard","warning_binding_restart_services"));if(d.has_joined_domain){a.push(_TT("SYNO.SDS.HA.Instance","wizard","warning_binding_disconnect_domain"))}if(!d.ntp_enabled){a.push(_TT("SYNO.SDS.HA.Instance","wizard","warning_binding_enable_ntp"))}b+=SYNO.SDS.HA.MakeUL(a);b+=_T("common","ask_cont");SYNO.SDS.HA.ListStyleMsgBox(this).getWrapper().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),b,function(g){if("yes"===g){this.applySetting()}},this)},checkWarningService:function(){this.el.mask(_T("common","loading"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Wizard",version:1,method:"check_bind_ha_warning_service",params:{},callback:function(d,b,c,a){this.el.unmask();if(d&&b.success){this.checkWarningServiceDone(d,b,c,a)}else{SYNO.Debug("Ajax load failure "+b);SYNO.SDS.HA.ShowRespErrMsg(this,b.code,true)}},scope:this})},checkActivateEnvironment:function(){var a=this.genApplyParams();this.el.mask(_TT("SYNO.SDS.HA.Instance","wizard","activate_environment_checking"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Wizard",version:1,method:"check_binding_environment",params:a,callback:function(e,c,d,b){this.el.unmask();if(e){this.checkActivateEnvironmentDone(e,c,d,b)}else{SYNO.Debug("Ajax load failure "+c);SYNO.SDS.HA.ShowRespErrMsg(this,c.code,true)}},scope:this})},sendRequest:function(a){var b={activate_data:a};this.el.mask(_TT("SYNO.SDS.HA.Instance","wizard","activate_environment_setting"),"x-mask-loading");this.sendWebAPI({api:"SYNO.Core.SHA.Setup.Wizard",version:1,timeout:300000,method:"activate_ha",params:b,callback:function(f,d,e,c){this.el.unmask();if(f){this.bindRemoteDone(f,d,e,c)}else{if(-1===d.status){this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("download","download_task_timeout"))}else{SYNO.SDS.HA.ShowRespErrMsg(this,d.code,true)}}},scope:this})},applySetting:function(){this.checkActivateEnvironment()},Show:function(){this.open()}});Ext.define("SYNO.SDS.HA.SplitBrainMenuPanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a={padding:"0px",items:[{columns:1,hideLabel:true,itemId:"option",border:false,items:[{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_both_servers_title"),name:"mode",inputValue:1,disabled:!b.isRemoteOnline},{xtype:"syno_displayfield",indent:1,htmlEncode:false,value:_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_both_servers_content")+'<font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_both_servers_warning")+"</font>"},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_one_server_title"),name:"mode",inputValue:2},{xtype:"syno_displayfield",indent:1,value:_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_one_server_content")},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","sb_remove_ha_title"),name:"mode",inputValue:3},{xtype:"syno_displayfield",indent:1,value:_TT("SYNO.SDS.HA.Instance","wizard","sb_remove_ha_content")}]}]};var e=a.items[0].items.length;for(var c=0;c<e;++c){var d=a.items[0].items[c];if("mode"===d.name&&!d.disabled){d.checked=true;break}}SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){},getNext:function(){if(!this.getForm().isValid()||!this.getForm().getValues().mode){return false}this.owner.opCode=parseInt(this.getForm().getValues().mode,10);return(1===this.owner.opCode||2===this.owner.opCode)?this.nextId[0]:this.nextId[1]}});Ext.define("SYNO.SDS.HA.SplitBrainChooseActivePanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a={padding:"0px",items:[{columns:1,hideLabel:true,itemId:"option",border:false,items:[{xtype:"syno_displayfield",htmlEncode:false,id:this.chooseActiveDescID=Ext.id(),value:""},{xtype:"syno_radio",boxLabel:String.format(_TT("SYNO.SDS.HA.Instance","wizard","sb_login_host_info"),b.loginSN,b.loginHostname),name:"mode",inputValue:1,indent:1},{xtype:"syno_radio",boxLabel:String.format(_TT("SYNO.SDS.HA.Instance","wizard","sb_remote_host_info"),b.remoteSN,b.remoteHostname),name:"mode",inputValue:2,indent:1}]}]};var e=a.items[0].items.length;for(var c=0;c<e;++c){var d=a.items[0].items[c];if("mode"===d.name&&!d.disabled){d.checked=true;break}}SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){var a=(1===this.owner.opCode)?_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_both_servers_desc"):_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_one_server_desc");Ext.getCmp(this.chooseActiveDescID).setValue(a)},getNext:function(){if(!this.getForm().isValid()||!this.getForm().getValues().mode){return false}this.owner.opCode=(10*this.owner.opCode)+parseInt(this.getForm().getValues().mode,10);return this.nextId}});Ext.define("SYNO.SDS.HA.SplitBrainApplyPanel",{extend:"SYNO.ux.FormPanel",action:"",actionList:{11:"sb_local_active",12:"sb_local_passive",21:"unbind_remote",22:"unbind_local",3:"disable_ha"},descList:{11:_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_both_servers_steps"),12:_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_both_servers_steps"),21:_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_one_server_steps"),22:_TT("SYNO.SDS.HA.Instance","wizard","sb_preserve_one_server_steps"),3:_TT("SYNO.SDS.HA.Instance","wizard","remove_cluster_steps")},btnTextList:{11:_TT("SYNO.SDS.HA.Instance","button","sync"),12:_TT("SYNO.SDS.HA.Instance","button","sync"),21:_TT("SYNO.SDS.HA.Instance","button","go"),22:_TT("SYNO.SDS.HA.Instance","button","go"),3:_TT("SYNO.SDS.HA.Instance","button","remove")},constructor:function(b){var a={items:[{xtype:"syno_displayfield",htmlEncode:false,id:this.applyPanelTextID=Ext.id(),value:""}]};this.descList[11]=String.format(this.descList[11],b.loginSN,b.loginHostname,b.remoteSN,b.remoteHostname);this.descList[12]=String.format(this.descList[12],b.remoteSN,b.remoteHostname,b.loginSN,b.loginHostname);this.descList[21]=String.format(this.descList[21],b.loginSN,b.loginHostname,b.remoteSN,b.remoteHostname);this.descList[22]=String.format(this.descList[22],b.remoteSN,b.remoteHostname,b.loginSN,b.loginHostname);SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){var a=this.owner.opCode;var b=this.descList[a];Ext.getCmp(this.applyPanelTextID).setValue(b);this.action=this.actionList[a]},checkState:function(){var a=this.owner.opCode;SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);this.owner.getButton("next").setText(this.btnTextList[a])},getBack:function(){if(3!=this.owner.opCode){this.owner.opCode=Math.floor(this.owner.opCode/10)}},getNext:function(){if(!this.getForm().isValid()){return false}if("sb_local_active"===this.action){this.scope.SBSetLocalRole("active")}else{if("sb_local_passive"===this.action){this.scope.SBSetLocalRole("passive")}else{if("unbind_remote"===this.action){this.scope.SBunbind("remote")}else{if("unbind_local"===this.action){this.scope.SBunbind("local")}else{if("disable_ha"===this.action){this.scope.changeHAStatus()}}}}}this.owner.close();return false}});Ext.define("SYNO.SDS.HA.HASplitBrainWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",PanelSplitBrainMenu:null,PanelSplitBrainChooseActive:null,PanelSplitBrainApply:null,opCode:0,constructor:function(c){var a=SYNO.SDS.HA;this.PanelSplitBrainMenu=new a.SplitBrainMenuPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","sb_menu_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","sb_menu_desc"),itemId:"sb_menu",nextId:["sb_choose_active","sb_apply"],header:false,isRemoteOnline:c.isRemoteOnline,owner:this});this.PanelSplitBrainChooseActive=new a.SplitBrainChooseActivePanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","sb_choose_active_title"),itemId:"sb_choose_active",nextId:"sb_apply",header:false,loginSN:c.loginSN,loginHostname:c.loginHostname,remoteSN:c.remoteSN,remoteHostname:c.remoteHostname,owner:this});this.PanelSplitBrainApply=new a.SplitBrainApplyPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","apply_setting_title"),itemId:"sb_apply",nextId:null,header:false,loginSN:c.loginSN,loginHostname:c.loginHostname,remoteSN:c.remoteSN,remoteHostname:c.remoteHostname,scope:c.scope,owner:this});var b=[this.PanelSplitBrainMenu,this.PanelSplitBrainChooseActive,this.PanelSplitBrainApply];this.callParent([Ext.apply({title:_TT("SYNO.SDS.HA.Instance","wizard","wizard_title"),width:630,height:520,steps:b},c)])}});Ext.ns("SYNO.SDS.HA");SYNO.SDS.HA.CONF_PIC_PREFIX="modules/HAManager/images/";SYNO.SDS.HA.CONF_DEFAULT_WIDTH=990;SYNO.SDS.HA.CONF_DEFAULT_HEIGHT=580;SYNO.SDS.HA.CONF_LABEL_WIDTH=230;SYNO.SDS.HA.CONF_CONTD_WIDTH=300;SYNO.SDS.HA.CONF_MAX_HA_IF_NUM=12;SYNO.SDS.HA.EMBED=function(a,b,c){return a+c+b};SYNO.SDS.HA.EmbedByTag=function(a){return SYNO.SDS.HA.EMBED.bind(undefined,"<"+a+">","</"+a+">")};SYNO.SDS.HA.MakeOL=function(a){return"<ol>"+a.map(SYNO.SDS.HA.EmbedByTag("li")).join("")+"</ol>"};SYNO.SDS.HA.MakeUL=function(a){return"<ul>"+a.map(SYNO.SDS.HA.EmbedByTag("li")).join("")+"</ul>"};SYNO.SDS.HA.GetDefaultHASettingErrCheckListString=function(){var a=[_TT("SYNO.SDS.HA.Instance","wizard","check_mtu_and_vlan"),_T("service","dsm_port"),_T("network","proxy_title"),_T("controlpanel","leaf_firewall"),_TT("SYNO.SDS.HA.Instance","wizard","check_router_support")];return SYNO.SDS.HA.MakeUL(a)};SYNO.SDS.HA.DefaultBindingErrorString=_TT("SYNO.SDS.HA.Instance","wizard","ha_setting_error")+SYNO.SDS.HA.GetDefaultHASettingErrCheckListString();SYNO.SDS.HA.HAPlainTextRenderer=function(a){return Ext.util.Format.htmlEncode(a)};SYNO.SDS.HA.DiskStatusDescRender=function(a){return a};SYNO.SDS.HA.NetIdToString=function(a){return SYNO.SDS.Utils.Network.idToString(a)};SYNO.SDS.HA.HAGetPageStore=function(){var a=new Ext.data.SimpleStore({fields:["value","display"],data:[[20,20],[40,40],[60,60],[80,80],[100,100],[150,150],[200,200],[300,300],[400,400]]});return a};SYNO.SDS.HA.GetServerName=function(c){var b=c;var a=c.indexOf("(");if(a>0){b=c.substring(0,a)}if(Ext.form.VTypes.netbiosName(b)||(Ext.form.VTypes.hostname(b)&&!Ext.form.VTypes.looseip(b))){return b}return""};SYNO.SDS.HA.GetServerIP=function(b){var c=b;var a=b.indexOf("(");var d=b.indexOf(")");if(a>0&&a<d&&d==(b.length-1)){c=b.substring(a+1,d)}if(Ext.form.VTypes.looseip(c)){return c}return""};SYNO.SDS.HA.HADiskIndexRenderer=function(b){var c=b.split("-");var d=parseInt(c[0],10);var a=parseInt(c[1],10);if(0!==d){return _T("volume","volume_expansion")+" "+d+" "+_T("volume","volume_disk")+" "+a}else{return _T("volume","volume_disk")+" "+a}};SYNO.SDS.HA.ServiceRenderer=function(d){var a=["samba","iscsitrg","ftpd","atalk","nfsd","SyslogServer","DirectoryServer","networking","unknown"];var c=[_T("network","wnds_file_service"),_T("helptoc","iscsitrg_manager"),_T("tree","leaf_ftp"),_T("network","apple_subject"),_T("nfs","nfs_title"),_TT("SYNO.SDS.HA.Instance","service","syslog_server"),_TT("SYNO.SDS.HA.Instance","service","directory_server"),_TT("SYNO.SDS.HA.Instance","service","networking"),_TT("SYNO.SDS.HA.Instance","service","unknown")];var b=0;for(b=0;b<a.length;b++){if(a[b]==d){return c[b]}}};SYNO.SDS.HA.GetLinkAggrModeStr=function(b){var a="";switch(b){case 1:a=_T("network","linkaggr_mode_alb");break;case 2:a=_T("network","linkaggr_mode_8023ad");break;case 3:a=_T("network","linkaggr_mode_xor");break;case 4:a=_T("network","linkaggr_mode_failover");break;case 6:a=_T("ovs","ovs_linkaggr_mode_failover");break;case 7:a=_T("ovs","ovs_linkaggr_mode_slb");break;case 8:a=_T("ovs","ovs_linkaggr_mode_tcp");break;default:a=_T("common","unknown");break}return a};SYNO.SDS.HA.NetIFCompareFunc=function(b,a){var h=0;var c=/^([A-Za-z_]+)([0-9]+)(\.?)([0-9]*)$/;var g=c.exec(b);var e=c.exec(a);if(g instanceof Array&&e instanceof Array){if(g[1]==e[1]){var f=parseInt(g[2],10)||0;var d=parseInt(e[2],10)||0;h=f-d}else{h=(g[1]>e[1])?1:-1}}return h};SYNO.SDS.HA.HandleDrbdIPConflictErrorMsg=function(h){var m=[];var f=[];var k=h[0];var a=h[1];var b=h[2];var g=h[3];if(0<a.length){var c=a.map(SYNO.SDS.HA.NetIdToString).join(", ");f.push(String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_failed_net_active"),c));m=m.concat(k)}if(0<g.length){var l=g.map(SYNO.SDS.HA.NetIdToString).join(", ");f.push(String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_failed_net_passive"),l));m=m.concat(b)}for(var e=0;e<m.length;e++){for(var d=e+1;d<m.length;d++){if(m[e]===m[d]){m.splice(d--,1)}}}m.sort();h[0]=m.join(", ");h[1]=f.join(" ")};SYNO.SDS.HA.GetSize=function(a,c){if(null===a||isNaN(a)){return{value:"-",unit:""}}var b=_T("common","size_kb"),d=a/1024;if(0>=d){d=0}else{if(1>d){d=1}}if(999<d){d/=1024;b=_T("common","size_mb")}if(999<d){d/=1024;b=_T("common","size_gb")}if(999<d){d/=1024;b=_T("common","size_tb")}return{value:d.toFixed(c),unit:b}};SYNO.SDS.HA.GetTime=function(a){if(isNaN(a.getTime())){return"-"}return a.format("Y-m-d H:i:s")};SYNO.SDS.HA.HandleLinkAggrErrorMsg=function(n){var q=0,p=0;var s=n[0];var f=n[1];var l=n[2];var h=[];var t=[];var b=[];var r=[];var a=[];var e="Heartbeat";for(q=0;q<f.length;q++){if(!f[q].bond_slaves&&!f[q].bond_mode){continue}var o=SYNO.SDS.Utils.Network.idToString(f[q].bond_name);var m=SYNO.SDS.HA.GetLinkAggrModeStr(f[q].bond_mode);var c=(s===f[q].bond_name?e+", ":"");var k=[];for(p=0;p<f[q].bond_slaves.length;p++){k.push(SYNO.SDS.Utils.Network.idToString(f[q].bond_slaves[p]))}r.push(o+" ("+c+m+": "+k.join(", ")+")")}r.sort();for(q=0;q<f.length;q++){if(f[q].bond_slaves){h=h.concat(f[q].bond_slaves)}}for(q=0;q<l.length;q++){if(l[q].bond_slaves){t=t.concat(l[q].bond_slaves)}}for(q=0;q<t.length;q++){var g=h.indexOf(t[q]);if(-1===g){b.push(t[q])}}for(q=0;q<b.length;q++){var d=SYNO.SDS.Utils.Network.idToString(b[q]);if(s===b[q]){d+=" ("+e+")"}a.push(d)}a.sort();n[0]=a.concat(r).join(", ")};SYNO.SDS.HA.ListStyleMsgBox=function(b){var a=new SYNO.SDS.MessageBoxV5({owner:b,cls:"x-window-dlg synoha-list-style"});return a};SYNO.SDS.HA.GetRespErrorString=function(c,b){var a=b?SYNO.SDS.HA.DefaultBindingErrorString:_T("error","error_error_system");if(6603==c){a=_TT("SYNO.SDS.HA.Instance","ui","error_connect_passive_failed")+SYNO.SDS.HA.GetDefaultHASettingErrCheckListString()}return a};SYNO.SDS.HA.ShowRespErrMsg=function(c,b,a){var d=SYNO.SDS.HA.GetRespErrorString(b,a);SYNO.SDS.HA.ListStyleMsgBox(c).alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)};SYNO.SDS.HA.HandleErrParams=function(b){var a=b.param.slice();if("wizard"===b.sec){switch(b.key){case"error_login_remote_failed":a[0]=SYNO.SDS.HA.GetDefaultHASettingErrCheckListString();break;case"error_volume_number":a[0]=_D("max_ha_spacecount");break;case"error_disk_size":case"error_disk_type":case"error_disk_log_sect_size":a[0]=a[0].map(SYNO.SDS.HA.HADiskIndexRenderer).join(", ");break;case"error_link_aggr_conflict":SYNO.SDS.HA.HandleLinkAggrErrorMsg(a);break;case"drbdip_conflict":SYNO.SDS.HA.HandleDrbdIPConflictErrorMsg(a);break;case"error_vlan_conflict":case"error_passive_if_disabled":case"error_active_firewall":case"error_passive_firewall":a[0]=a[0].sort().map(SYNO.SDS.HA.NetIdToString).join(", ");break;case"error_passive_direct_connect":case"error_active_is_dhcp":case"error_passive_is_dhcp":case"error_ha_netmask_inconsistent_active":case"error_ha_netmask_inconsistent_passive":case"error_main_interface_communication":a[0]=SYNO.SDS.Utils.Network.idToString(a[0]);break;case"service_not_supported_active":case"service_not_supported_passive":a[0]=a[0].map(function(c){return _TT("SYNO.SDS.HA.Instance","overview",c)}).join(", ");break;default:break}}else{if("ui"===b.sec){switch(b.key){case"shutdown_active_feasibility_check_fail":case"shutdown_ha_feasibility_check_fail":case"reboot_active_feasibility_check_fail":case"deactivate_ha_feasibility_check_fail":a[0]="<br><b>"+SYNO.SDS.Utils.GetFeasibilityCheckMsgJoin(a)+"</b><br>"+_T("system","try_later_warning");break;default:break}}}return a};SYNO.SDS.HA.ShowErrMsg=function(a,d,c){var e=d.map(function(h){var g=h.app?_TT(h.app,h.sec,h.key):_T(h.sec,h.key);var f=SYNO.SDS.HA.HandleErrParams(h);return String.format.apply(a,[g].concat(f))});var b=(0<e.length)?e.join("<br>"):c;SYNO.SDS.HA.ListStyleMsgBox(a).alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),b)};Ext.define("SYNO.SDS.HA.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(a){var b;b=Ext.apply({activeTab:0,items:a.tabPanels},a);this.callParent([b])}});