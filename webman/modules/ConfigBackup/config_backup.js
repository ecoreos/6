/* Copyright (c) 2016 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.ConfigBackup",function(e){var c={ERR_INTERNAL_ERROR:[4401,_T("common","error_system")],ERR_SNAPSHOT_RESTORING:[4407,_T("share","share_snapshot_restore_running")],ERR_RESTORING:[4408,_T("backup","is_restoring")],ERR_BACKING_UP_RESTORING:[4409,_T("backup","is_backing_up_restoring")],ERR_CONFIG_OPERATE_ADMIN:[4416,_T("confbackup","confbkp_operating_user")],ERR_CONFIG_VERSION_WRONG:[4428,_T("confbackup","confbkp_failed_get_conf_file")],ERR_CONFIG_VERSION_FUTURE:[4429,_T("confbackup","confbkp_error_version")],ERR_RESTORE_VOLUME_BUILDING:[4431,_T("common","err_creating_volume")],ERR_CONFIG_NO_SPACE:[4436,_T("confbackup","upload_err_no_space")],ERR_CONFIG_WRONG_FORMAT:[4437,_T("confbackup","upload_err_format")],ERR_CONFIG_PORT_CONFLICT:[4438,_T("confbackup","confbkp_port_conflict")],ERR_CONFIG_SERVICE_FAIL:[4439,_T("confbackup","import_fail")],ERR_DATA_SESSION_EXPIRED:[4454,_T("confbackup","session_expired")],ERR_CONFIG_VERSION_OTHER_OS:[4474,{text_param:_T("confbackup","confbkp_error_other_os"),replace_keys:["os_name"]}],ERR_USER_EXCEED_MAX:[4478,{text:_T("confbackup","confbkp_user_exceed_max"),text_param:_T("confbackup","confbkp_user_exceed_max_param"),replace_keys:["max_user_account"]}],ERR_GROUP_EXCEED_MAX:[4479,{text:_T("confbackup","confbkp_group_exceed_max"),text_param:_T("confbackup","confbkp_group_exceed_max_param"),replace_keys:["max_group_account"]}]};var f={};Ext.iterate(c,function(h,i){f[h]=i[0]});function g(h){var i=null;if(Ext.isObject(h)&&h.code){return g(h.code)}Ext.iterate(c,function(j,k){if(h===k[0]){i=k[1];if(Ext.isObject(i)){if(!i.text&&i.text_param){i.text=i.text_param}if(!i.text){i.text=_T("comon","error_system")}}return false}});return i}function b(i,k){var l=[];var j=false;var h=i.text_param||i.text;if(!k){return i.text}if(Ext.isArray(k)&&k.length>0){return String.format.apply(String,[h].concat(k))}else{if(Ext.isObject(k)){j=true;Ext.each(i.replace_keys,function(m){if(!k.hasOwnProperty(m)){j=false;return false}l.push(k[m])});if(j){return String.format.apply(String,[h].concat(l))}}}return i.text}f.getErrorString=function(h,j){if(Ext.isObject(h)&&h.code){return f.getErrorString(h.code,h.errors)}var i=g(h);if(!i){return _T("common","error_system")}if(Ext.isString(i)){return i}else{return b(i,j)}};f.isConfigError=function(h){var i=g(h);return !!i};f.converLanString=function(k,j){var i=/^[.a-zA-Z0-9_\-]+(:[a-zA-Z0-9_\-]+){1,2}$/;var h;if(i.test(k)){h=k.split(":");if(h.length===2){return _T(h[0],h[1])}else{return _TT(h[0],h[1],h[2])}}else{return j||""}};var a={err_not_support_enc:_T("backup","err_not_support_enc"),err_not_support_acl:_T("backup","err_not_support_acl"),err_not_valid_fs:_T("backup","err_not_valid_fs"),err_share_not_writable:_T("backup","err_share_not_writable"),err_share_unmounted:_T("backup","err_share_unmounted"),err_share_acl_to_not_acl:_T("backup","err_share_acl_to_not_acl"),err_share_source_conflict:_T("backup","err_share_source_conflict"),err_peta_rename_same:_T("backup","err_peta_share_rename_same"),err_peta_rename_different:_T("backup","err_peta_share_rename_different")};f.getShareErrorString=function(i,h){var j=a[i];if("err_peta_rename_same"==i){j=String.format(j,"<b>"+h+"</b>")}return j};var d={warn_enc_current_not_exist:_T("backup","warn_enc_current_not_exist"),warn_not_acl_to_acl:_T("backup","warn_not_acl_to_acl"),warn_enc_current_not_enc:_T("backup","warn_enc_current_not_enc"),warn_peta_current_not_exist:_T("backup","warn_petashare_current_not_exist"),warn_peta_current_not_peta:_T("backup","warn_petashare_current_not_peta")};f.getShareWarningString=function(j){var i="";for(var h in j){if(j.hasOwnProperty(h)&&d.hasOwnProperty(h)){i+=String.format(d[h],"<b>"+j[h].join(", ")+"</b>");i+="<br/>"}}if(""!==i){i+=_T("backup","are_you_sure_to_continue")}return i};return{statics:f}});Ext.define("SYNO.SDS.ConfigBackup.BasicTreePanel",{extend:"SYNO.ux.TreePanel",constructor:function(a){var b=Ext.apply({useArrows:true,autoScroll:true,containerScroll:true,bodyStyle:"overflow-x: hidden;overflow-y:auto; padding-right: 12px;",enableDD:false},a);return this.callParent([b])},initEvents:function(){var a=this.callParent(arguments);this.mon(this,"checkchange",this.onCheckChange,this);this.mon(this,"expandnode",this.onExpandNode,this);return a},getCheckedSubTreeRoot:function(b){var a=[];var c=function(d){d.eachChild(function(f){var e=f.getUI()||{};if(!Ext.isFunction(e.getCheckValue)){return}if(true===e.getCheckValue()){a.push(f)}else{if("gray"===e.getCheckValue()){c(f)}}})};c(b||this.root);return a},onCheckChange:function(a,e){var d,c,g,f=function(k){var j=0,i=0,h=0;k.eachChild(function(m){var l=m.getUI()||{};if(l.checkbox&&Ext.isFunction(l.getCheckValue)&&(!Ext.isFunction(l.isDisabled)||!l.isDisabled())){if(true===l.getCheckValue()){i+=1}else{if(false===l.getCheckValue()){h+=1}}j+=1}});if(0===j){return k.getUI().getCheckValue()}else{if(i===j){return true}else{if(h===j){return false}else{return"gray"}}}},b=function(h){var i=Ext.apply({},h.attributes.depend);return Ext.applyIf(i,{parent:false,children:true})};g=b(a);if(true===g.children){if(true===e){a.eachChild(function(i){var h=i.getUI();if(h&&Ext.isFunction(h.setCheckValue)&&(!Ext.isFunction(h.isDisabled)||!h.isDisabled())){h.setCheckValue(true)}},this)}else{if(false===e){a.eachChild(function(i){var h=i.getUI();if(h&&Ext.isFunction(h.setCheckValue)&&(!Ext.isFunction(h.isDisabled)||!h.isDisabled())){h.setCheckValue(false)}},this)}}}d=a.parentNode;while(d){c=d.getUI();if(!c||!Ext.isFunction(c.getCheckValue)){g=b(d);d=d.parentNode;continue}if(true===g.parent){d.attributes.checked=f(d)}else{if(true===e&&false===d.attributes.checked){d.attributes.checked="gray"}else{if(false===e){d.attributes.checked=f(d)}}}c.syncCheckCssClass();g=b(d);d=d.parentNode}},onExpandNode:function(a){var b=a.getUI(),c=Ext.apply({},a.attributes.depend);Ext.applyIf(c,{parent:false,children:true});if(!b||!Ext.isFunction(b.getCheckValue)){return}if(true===c.children&&true===b.getCheckValue()){a.eachChild(function(d){b=d.getUI();if(b&&Ext.isFunction(b.isDisabled)&&!b.isDisabled()&&Ext.isFunction(b.setCheckValue)){b.setCheckValue(true)}},this)}}});Ext.define("SYNO.SDS.ConfigBackup.Restore.ShareConflictWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);return this.callParent([b])},fillConfig:function(a){var c=new SYNO.SDS.ConfigBackup.ConflictSharePanel({owner:this,conflict_share:a.conflict_share});var b={title:_T("confbackup","confbkp_share_conflict_title"),resizable:false,width:600,height:450,buttons:[{xtype:"syno_button",text:_T("common","ok"),btnStyle:"blue",scope:this,handler:function(){a.nextFunc.apply(a.nextScope,a.nextParams);this.close()}},{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.close}],items:[c]};Ext.apply(b,a);return b}});Ext.define("SYNO.SDS.ConfigBackup.ConflictSharePanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b=this.fillConfig(a);return this.callParent([b])},createFieldSet:function(a,g,e,f){var c=new Ext.XTemplate('<dl class="syno-config-backup-task-list-row">',String.format('<div class="syno-config-backup-task-list-column blue-status" style="width:50%">{0}</div>',e),String.format('<div class="syno-config-backup-task-list-column blue-status" style="width:50%">{0}</div>',f),'<div class="x-clear"></div>',"</dl>",'<tpl for=".">','<dl class="syno-config-backup-task-list-row">','<div class="syno-config-backup-task-list-column" style="width:50%">','<tpl if="encrypted==\'true\'"><div class="syno-config-backup-share-enc-true"></div></tpl>','<tpl if="encrypted==\'false\'"><div class="syno-config-backup-share-enc-false"></div></tpl>',"{name_current:htmlEncode}","</div>",'<div class="syno-config-backup-task-list-column" style="width:50%">','<tpl if="encrypted!=\'NA\'"><div class="syno-config-backup-share-enc-true"></div></tpl>',"{name_after:htmlEncode}","</div>",'<div class="x-clear"></div>',"</dl>","</tpl>");var b=new Ext.data.ArrayStore({fields:["name_current","name_after","encrypted"]});var d=[];Ext.each(a,function(h){var i=[];i.push(h.name_current);i.push(h.name_after);if(h.is_encryption&&h.is_encrypted){i.push("true")}else{if(h.is_encryption){i.push("false")}else{i.push("NA")}}d.push(i)});b.loadData(d);return new SYNO.ux.FieldSet({title:g,items:[{indent:1,xtype:"dataview",store:b,tpl:c,autoHeight:true}]})},fillConfig:function(a){var d=a.conflict_share;var b=[];b.push({xtype:"syno_displayfield",hideLabel:true,value:_T("confbackup","confbkp_share_conflict_description")});if(d&&d.length>0){b.push(this.createFieldSet(d,_T("confbackup","confbkp_share_conflict_list"),_T("confbackup","confbkp_share_name_current"),_T("confbackup","confbkp_share_name_after")))}var c=Ext.apply({height:365,items:[b]},a);return c}});Ext.define("SYNO.SDS.ConfigBackup.Restore.ConflictWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);return this.callParent([b])},fillConfig:function(a){var c=new SYNO.SDS.ConfigBackup.ConflictPanel({owner:this,conflict_user:a.conflict_user,conflict_group:a.conflict_group});var b={title:_T("confbackup","confbkp_user_group_conflict_title"),resizable:false,width:600,height:450,buttons:[{xtype:"syno_button",text:_T("common","ok"),btnStyle:"blue",scope:this,handler:function(){a.nextFunc.apply(a.nextScope,a.nextParams);this.close()}},{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.close}],items:[c]};Ext.apply(b,a);return b}});Ext.define("SYNO.SDS.ConfigBackup.ConflictPanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b=this.fillConfig(a);return this.callParent([b])},createFieldSet:function(a,g,e,f){var c=new Ext.XTemplate('<dl class="syno-config-backup-task-list-row">',String.format('<div class="syno-config-backup-task-list-column blue-status" style="width:50%">{0}</div>',e),String.format('<div class="syno-config-backup-task-list-column blue-status" style="width:50%">{0}</div>',f),'<div class="x-clear"></div>',"</dl>",'<tpl for=".">','<dl class="syno-config-backup-task-list-row">','<div class="syno-config-backup-task-list-column" style="width:50%">{name_current:htmlEncode}</div>','<div class="syno-config-backup-task-list-column" style="width:50%">{name_after:htmlEncode}</div>','<div class="x-clear"></div>',"</dl>","</tpl>");var b=new Ext.data.ArrayStore({fields:["name_current","name_after"]});var d=[];Ext.each(a,function(h){var i=[];i.push(h.name_current);i.push(h.name_after);d.push(i)});b.loadData(d);return new SYNO.ux.FieldSet({title:g,items:[{indent:1,xtype:"dataview",store:b,tpl:c,autoHeight:true}]})},fillConfig:function(a){var d=a.conflict_user;var e=a.conflict_group;var b=[];b.push({xtype:"syno_displayfield",hideLabel:true,value:_T("confbackup","confbkp_user_group_conflict_desc")});if(d&&d.length>0){b.push(this.createFieldSet(d,_T("confbackup","confbkp_user_conflict_list"),_T("confbackup","confbkp_user_name_current"),_T("confbackup","confbkp_user_name_after")))}if(e&&e.length>0){b.push(this.createFieldSet(e,_T("confbackup","confbkp_group_conflict_list"),_T("confbackup","confbkp_group_name_current"),_T("confbackup","confbkp_group_name_after")))}var c=Ext.apply({height:365,items:[b]},a);return c}});Ext.define("SYNO.SDS.ConfigBackup.Restore.ConfigTreePanel",{extend:"SYNO.SDS.ConfigBackup.BasicTreePanel",constructor:function(a){this.dss_version=a.dss_version;this.dss_path=a.dss_path;this.dss_id=a.dss_id;this.overwrite=a.overwrite;var b=Ext.apply({},a);return this.callParent([b])},getConfigRootText:function(a){if("confbkp_v5"===a||"confbkp_v4"===a||"confbkp_v3"===a){return _T("confbackup","confbkp_all")}if("confbkp_v1"===a||"confbkp_v2"===a){return _T("confbackup","confbkp_user_group")}return""},createConfigNodeFn:function(a){var b=function(c,d){var e=SYNO.SDS.ConfigBackup.converLanString(c[d]);if(e){c[d]=e}};b(a,"text");if(!("children" in a)){a.leaf=true}a.qtip=a.text;if("info"===a.type){if(a.value_multi){b(a,"value_multi");a.value=a.value_multi}if(a.value){a.qtip=a.text+" : "+a.value;a.text=a.text+' : <element class="green-status">'+a.value+"</element>"}}else{a.iconCls="syno-config-backup-config-node";a.checked=false}},getCheckedService:function(b){var a=[];var c=function(d){d.eachChild(function(f){var e=f.getUI()||{};if(!Ext.isFunction(e.getCheckValue)){return}if(true===e.getCheckValue()){if("category"===f.attributes.type){Ext.each(f.attributes.children,function(g){a.push(g)})}else{a.push(f)}}else{if("gray"===e.getCheckValue()){c(f)}}})};c(b||this.root);return a},getRestoreServiceList:function(){var a=[];if(true===this.root.getUI().getCheckValue()&&this.dsm_version<4980){a.push("all")}else{Ext.each(this.getCheckedService(),function(b){a.push(b.id)})}return a},isRestoreConfig:function(){return false!==this.getNodeById("config_root").getUI().getCheckValue()},showShareConflictWindow:function(c,b){if(c&&c.length>0){var a=new SYNO.SDS.ConfigBackup.Restore.ShareConflictWindow({conflict_share:c,nextFunc:this.checkRenameLeaveAdmin,nextScope:this,nextParams:b});a.open()}else{this.checkRenameLeaveAdmin.apply(this,b)}},showUGConflictWindow:function(d,e,c,b){if((d&&d.length>0)||(e&&e.length>0)){var a=new SYNO.SDS.ConfigBackup.Restore.ConflictWindow({conflict_user:d,conflict_group:e,nextFunc:this.showShareConflictWindow,nextScope:this,nextParams:[c,b]});a.open()}else{this.showShareConflictWindow(c,b)}},checkUGConflict:function(c,b,d,a){if(false===this.isRestoreConfig()){b.call(d);return}if(undefined===a){a=false}d.setStatusBusy();d.sendWebAPI({api:"SYNO.Backup.Config.Restore",method:"list_conflict",version:1,params:{types:a?["user","group","share"]:["user","group"],dss_path:this.dss_path,dss_id:this.dss_id,overwrite:c,category_or_service_ids:this.getRestoreServiceList()},callback:function(e,f){d.clearStatusBusy();if(!e||!f){d.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(f),function(){if(SYNO.SDS.ConfigBackup.ERR_DATA_SESSION_EXPIRED===f.code){d.close()}});return}this.showUGConflictWindow(f.user,f.group,f.share,[c,b,d,a])},scope:this})},checkRenameLeaveAdmin:function(d,b,f,a){if(false===this.isRestoreConfig()){return}var e=this.getRestoreServiceList();var c;if(a){if(-1!==e.indexOf("administration")||-1!==e.indexOf("router_cp")||-1!==e.indexOf("pctc")){c=_T("confbackup","upload_confirm_restart_network")}else{c=_T("confbackup","upload_confirm_minutes")}}else{c=_T("confbackup","upload_confirm")}f.setStatusBusy();f.sendWebAPI({api:"SYNO.Backup.Config.Restore",method:"check",version:1,params:{dss_path:this.dss_path,dss_id:this.dss_id,overwrite:d,category_or_service_ids:this.getRestoreServiceList()},callback:function(g,h){f.clearStatusBusy();if(!g){f.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(h))}else{f.getMsgBox().confirm(_T("tree","leaf_bkp"),c,function(i){if("yes"===i){b.call(f)}},this)}},scope:this})}});Ext.define("SYNO.SDS.ConfigBackup.TriTreeNodeUI",{extend:"Ext.tree.TreeNodeUI",renderElements:function(g,p,o,q){this.indentMarkup=g.parentNode?g.parentNode.ui.getChildIndent():"";var i='<img alt="" src="'+this.emptyIcon+'" class="syno-config-backup-tree-node-share-overwrite" ext:qtip="'+_T("confbackup","confbkp_share_overwrite")+'"/>';var k='<img alt="" src="'+this.emptyIcon+'" class="syno-config-backup-tree-node-share-rename" ext:qtip="'+_T("confbackup","confbkp_share_rename")+'"/>';var f='<img alt="" src="'+this.emptyIcon+'" class="syno-config-backup-tree-node-same-volume" ext:qtip="'+_T("backup","warn_backup_same_volume")+'"/>';var j=Ext.isBoolean(p.checked)||p.checked==="gray",h=Ext.util.Format.htmlEncode,e=p.input,c,b=this.getHref(p.href),d=['<li class="x-tree-node syno-config-backup-tri-tree-node"><div ext:tree-node-id="',h(g.id),'" class="x-tree-node-el x-tree-node-leaf x-unselectable ',p.cls,'" unselectable="on">','<span class="x-tree-node-indent">',this.indentMarkup,"</span>",'<img alt="" src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow" />',j?('<img alt="" src="'+this.emptyIcon+'" class="syno-config-backup-tri-tree-node-cb syno-ux-checkbox-icon" />'):"",'<img alt="" src="',p.icon||this.emptyIcon,'" class="x-tree-node-icon',(p.icon?" x-tree-node-inline-icon":""),(p.iconCls?" "+p.iconCls:""),'" unselectable="on" ',((p.icon||p.iconCls)?"":'style="display: none;"')+"/>",'<a hidefocus="on" class="x-tree-node-anchor" href="',b,'" tabIndex="1" ',p.hrefTarget?' target="'+p.hrefTarget+'"':"",'><span unselectable="on">',g.text,"</span></a>","rename"===p.shareConflict?k:"","overwrite"===p.shareConflict?i:"",f,"</div>",'<ul class="x-tree-node-ct" style="display:none;"></ul>',"</li>"].join("");if(q!==true&&g.nextSibling&&(c=g.nextSibling.ui.getEl())){this.wrap=Ext.DomHelper.insertHtml("beforeBegin",c,d)}else{this.wrap=Ext.DomHelper.insertHtml("beforeEnd",o,d)}this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1];var m=this.elNode.childNodes;var l=0;this.indentNode=m[l++];this.ecNode=m[l++];if(j){this.checkbox=m[l++]}this.iconNode=m[l++];this.anchor=m[l++];this.textNode=this.anchor.firstChild;if("rename"===p.shareConflict){this.renameNode=m[l++]}if("overwrite"===p.shareConflict){this.overwriteNode=m[l++]}this.volumeWarnNode=m[l++];if(e){this.createInputField(e,p,this.elNode);l++}if(j){this.syncCheckCssClass()}g.on("disabledchange",this.onDisabled,this)},onIdChange:function(b){var a=Ext.util.Format.htmlEncode;if(this.rendered){this.elNode.setAttribute("ext:tree-node-id",a(b))}},createInputField:function(b,a,c){var d=b;if(Ext.isObject(b)){this.inputConfig=Ext.apply({},b);d=b.xtype||"textfield";delete b.xtype}else{this.inputConfig={}}if(Ext.isDefined(a.value)){this.inputConfig.value=a.value}this.inputConfig.renderTo=c;switch(d){case"textfield":this.input=new SYNO.ux.TextField(this.inputConfig);break;case"numberfield":this.input=new SYNO.ux.NumberField(this.inputConfig);break}},initEvent:function(){var a=this.callParent(arguments);if(this.checkbox){this.initCheckEvent()}return a},isChecked:function(){return this.getCheckValue()},isDisabled:function(){var a=this.node;return(true===a.disabled)},toggleCheck:function(){var a=this.checkbox;if(true===this.node.disabled){return}if(a){this.setCheckValue(!this.getCheckValue())}},onClick:function(a){if(a.getTarget(".x-form-field")){return}if(a.getTarget(".syno-config-backup-tri-tree-node-cb")){this.toggleCheck()}return this.callParent(arguments)},onDblClick:function(a){a.preventDefault();if(this.disabled){return}if(this.fireEvent("beforedblclick",this.node,a)!==false){if(!this.animating&&this.node.isExpandable()){this.node.toggle()}this.fireEvent("dblclick",this.node,a)}},onDisabled:function(b,a){if(this.input){if(a){this.input.disable()}else{this.input.enable()}}if(this.checkbox){if(a){this.checkbox.addClassName("syno-ux-cb-disabled")}else{this.checkbox.removeClassName("syno-ux-cb-disabled")}}},onCheckChange:function(){this.syncCheckCssClass();this.fireEvent("checkchange",this.node,this.getCheckValue())},isValid:function(){if(this.node.disabled){return true}if(this.input&&!this.input.isValid()){return false}return true},getInputValue:function(){if(!this.input||this.disabled){return undefined}return this.input.getValue()},setInputValue:function(a){if(!this.input){return}this.input.setValue(a)},getCheckValue:function(){return this.node.attributes.checked},setCheckValue:function(a){if(this.node.disabled){return}if(a===this.getCheckValue()){return}if(a==="false"||a==="off"||a==="0"){a=false}else{if(a==="gray"){a="gray"}else{a=(a?true:false)}}this.node.attributes.checked=a;this.onCheckChange()},syncCheckCssClass:function(){var b=this.getCheckValue();var a=this.checkbox;if(!a){return}Ext.each(["checked","grayed","disabled"],function(c){this.checkbox.removeClassName("syno-ux-cb-"+c)},this);if(this.volumeWarnNode){this.volumeWarnNode.removeClassName("syno-ux-cb-selected")}if(b===true){this.checkbox.addClassName("syno-ux-cb-checked");if(this.volumeWarnNode){this.volumeWarnNode.addClassName("syno-ux-cb-selected")}}else{if(b==="gray"){this.checkbox.addClassName("syno-ux-cb-grayed");if(this.volumeWarnNode){this.volumeWarnNode.addClassName("syno-ux-cb-selected")}}}if(this.node.disabled){this.checkbox.addClassName("syno-ux-cb-disabled")}},initCheckEvent:function(){this.checkbox.addListener("mouseover",this.onCheckMouseover,this);this.checkbox.addListener("mouseout",this.onCheckMouseout,this);this.checkbox.addListener("focus",this.onCheckIconfocus,this);this.checkbox.addListener("blur",this.onCheckIconblur,this)},onCheckMouseover:function(){this.checkbox.addClassName("syno-ux-cb-hover")},onCheckMouseout:function(){this.checkbox.removeClassName("syno-ux-cb-hover")},onCheckIconfocus:function(){this.checkbox.addClassName("syno-ux-cb-focus")},onCheckIconblur:function(){this.checkbox.removeClassName("syno-ux-cb-focus")}});Ext.define("SYNO.SDS.ConfigBackup.TriTreeDisableCheckNodeUI",{extend:"SYNO.SDS.ConfigBackup.TriTreeNodeUI",checkShareNode:function(b,c,a){if(!b.dependAppRows||0===b.dependAppRows.length){return}Ext.each(b.dependAppRows,function(d){if(d.get("checked")){if(-1===c.indexOf(b.id.substr(1))){c.push(b.id.substr(1))}if(-1===a.indexOf(d.get("name"))){a.push(d.get("name"));this.node.appRowsToBeUnselected.push(d)}this.node.appGrid=b.dependGrid}},this)},setCheckValue:function(e){if(true!==e&&!this.node.clickConfirmed){this.node.appRowsToBeUnselected=[];var d=[];var a=[];var f;if("fm_root"===this.node.id){Ext.each(this.node.childNodes,function(g){this.checkShareNode(g,d,a)},this)}else{var c=this.node.id.substr(1).split("/",1)[0];var b=this.node.getOwnerTree().getNodeById("/"+c);this.checkShareNode(b,d,a)}if(0<a.length&&0<d.length){if(d[0].isBackup){f=_T("backup","unselect_share_alert_bkp")}else{f=_T("backup","unselect_share_alert_restore")}f=String.format(f,d.join(", "),a.join(", "));this.node.getOwnerTree().owner.getMsgBox().confirm("",f,function(g){if("yes"===g){this.node.clickConfirmed=true;this.setCheckValue(false)}},this);return false}}this.node.clickConfirmed=false;Ext.each(this.node.appRowsToBeUnselected,function(g){g.set("checked",false)});this.node.appRowsToBeUnselected=[];if(this.node.appGrid){this.node.appGrid.syncCheckedStatus();delete this.node.appGrid}if(!e&&this.node.disabled){this.node.disabled=false;this.callParent(arguments);this.node.disabled=true;this.syncCheckCssClass()}else{this.callParent(arguments)}}});Ext.define("SYNO.SDS.ConfigBackup.TreeLoader",{extend:"Ext.tree.TreeLoader",sendWebAPI:undefined,webapi:undefined,constructor:function(){var a=arguments[0];if(a&&a.webapi){this.dataUrl="dummy"}return this.callParent(arguments)},requestData:function(c,e,b){if(this.fireEvent("beforeload",this,c,e)!==false){if(this.directFn){var a=this.getParams(c);a.push(this.processDirectResponse.createDelegate(this,[{callback:e,node:c,scope:b}],true));this.directFn.apply(window,a)}else{if(this.nodeData&&-1!==this.owner.fm_root_nodes.indexOf(c.id)){this.handleNodeData(c,this.nodeData,e,b)}else{if(Ext.isFunction(this.sendWebAPI)){var d=Ext.apply({},{params:this.getParams(c),argument:{callback:e,node:c,scope:b},callback:this.handleWebAPIResponse,scope:this},this.webapi);this.transId=this.sendWebAPI(d)}else{this.transId=Ext.Ajax.request({method:this.requestMethod,url:this.dataUrl||this.url,success:this.handleResponse,failure:this.handleFailure,scope:this,argument:{callback:e,node:c,scope:b},params:this.getParams(c)})}}}}else{this.runCallback(e,b||c,[])}},handleNodeData:function(e,b,g,d){if(Ext.isFunction(this.parseWebApiResponse)){b=this.parseWebApiResponse.call(this,e,b)}e.beginUpdate();for(var c=0,a=b.length;c<a;c++){var f=this.createNode(b[c]);if(f){e.appendChild(f)}}e.endUpdate();this.runCallback(g,d||e,[e]);this.fireEvent("load",this,e,b)},handleWebAPIResponse:function(l,b,f,m){var k=m.argument,d=k.node;this.transId=false;if(l){try{if(Ext.isFunction(this.parseWebApiResponse)){b=this.parseWebApiResponse.call(this,d,b)}d.beginUpdate();for(var g=0,h=b.length;g<h;g++){if(b[g].recycle){continue}var c=this.createNode(b[g]);if(c){d.appendChild(c)}}d.endUpdate();this.runCallback(k.callback,k.scope||d,[d])}catch(j){SYNO.Debug("tree loadexception");this.fireEvent("loadexception",this,d,b);this.runCallback(k.callback,k.scope||d,[d]);return}this.fireEvent("load",this,d,b)}else{this.fireEvent("loadexception",this,d,b);this.runCallback(k.callback,k.scope||d,[d])}},createNode:function(a){var b;a.uiProvider="SYNO.SDS.ConfigBackup.TriTreeNodeUI";a.draggable=false;if(Ext.isFunction(this.createNodeFn)){b=this.createNodeFn.call(this.createNodeScope||this,a);if(b===false){return}}var c=this.callParent(arguments);return c}});