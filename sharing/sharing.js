/* Copyright (c) 2016 Synology Inc. All rights reserved. */

SYNO.SDS.isNVR="yes"===_D("nvr")?!0:!1,function(){var t=!("no"===_D("is_business_model"));Ext.isIE8?SYNO.SDS.isBusinessModel=t:Object.defineProperty(SYNO.SDS,"isBusinessModel",{get:function(){return t},set:function(){throw"cannot change readonly value"},configurable:!1})}(),Ext.define("SYNO.SDS.Environment",{statics:{ESM:"ESM",GetEnvironment:function(){return"yes"===_D("support_ESM")?SYNO.SDS.Environment.ESM:""}}}),Ext.namespace("SYNO.SDS");var _S,_TT;_S=function(t){return SYNO.SDS.Session[t]},_TT=function(t,e,i){try{return SYNO.SDS.Strings[t][e][i]}catch(n){return""}},Ext.define("SYNO.SDS.DependencyProvider",{extend:"Ext.util.Observable",constructor:function(t){var e=this;Ext.apply(e,t),e.callParent(arguments)},resolve:function(t,e){var i,n=this;return i=n.fn?n.fn.apply(t||window,e||[]):n.className}}),Ext.define("SYNO.SDS._Injector",{extend:"Ext.util.Observable",constructor:function(t){var e=this;e.callParent(arguments),e.providers={},e.selector=t},getEnvironment:function(){return this.selector},register:function(t){if(!(Ext.isEmpty(t)||Ext.isEmpty(t.cls)||Ext.isEmpty(t.realCls))){var e=t.cls;if(this.selector===t.name)Ext.define(e,{extend:t.realCls});else{if(e===t.defaultCls)return;Ext.isEmpty(t.defaultCls)||Ext.define(e,{extend:t.defaultCls})}}},configure:function(t){var e,i,n,s;e={};for(i in t)t.hasOwnProperty(i)&&(s=t[i],Ext.isString(s)?n=new SYNO.SDS.DependencyProvider({identifier:i,className:s}):Ext.isObject(s)&&(n=new SYNO.SDS.DependencyProvider(Ext.apply({identifier:i},s))),this.providers[i]=n)},resolve:function(t,e,i){var n=this,s=n.providers[t];if(s)return s.resolve(e,i)}}),Ext.define("SYNO.SDS.basic.Themer",{extend:"Ext.util.Observable",constructor:function(){var t=this;t.callParent(arguments)},setTheme:function(t,e){this.theme=t,this.themeCls=e,Ext.getBody().addClass(e)},getTheme:function(){return this.theme},getThemeCls:function(){return this.themeCls},getPath:function(t){var e=arguments.length>1;if(e||Ext.isArray(t)){var i=[];return Ext.each(e?arguments:t,function(t){i.push(this.innerGetPath(t))},this),i}return this.innerGetPath(t)},innerGetPath:function(t){return t.replace("default/",this.themeCls+"/")}}),Ext.define("SYNO.SDS.DSM.Themer",{extend:"SYNO.SDS.basic.Themer",statics:{BUSINESS:"business",DEFAULT:"default"},defaultThemeCls:"default",defaultThemeName:"dsm",constructor:function(t){var e=this,i=this.defaultThemeCls;e.callParent(arguments),SYNO.SDS.DSM.Themer.BUSINESS===t.themeCls&&(i=SYNO.SDS.DSM.Themer.BUSINESS),e.setTheme(this.defaultThemeName,i)}}),Ext.define("SYNO.SDS.ESM.Themer",{extend:"SYNO.SDS.basic.Themer",defaultThemeCls:"business",defaultThemeName:"esm",constructor:function(){var t=this;t.callParent(arguments),t.setTheme(this.defaultThemeName,this.defaultThemeCls)}}),Ext.define("SYNO.SDS.interval.Task",{extend:"Ext.Component",constructor:function(){var t=this;t.callParent(arguments),t.getTimeout()},stopPollingTask:function(){var t=this;t.pollTask&&t.pollUnreg(t.pollTask)},startPollingTask:function(){var t=this,e={interval:60,webapi:{api:"SYNO.Entry.Request",version:1,method:"request",stopwhenerror:!0,params:{compound:[{api:"SYNO.Core.Desktop.Timeout",version:1,method:"check"}]}},scope:t,status_callback:t.handleResponese};t.stopPollingTask(),t.pollTask=t.pollReg(e),t.mon(SYNO.SDS.StatusNotifier,"halt",function(){this.pollUnreg(this.pollTask)},t)},handleResponese:function(t,e,i,n){},delayGetTimeOut:function(){this.getTimeout.defer(6e4,this)},getTimeout:function(){var t=this,e={api:"SYNO.Core.Desktop.Timeout",method:"get",version:1,params:{}};t.sendWebAPI({api:e.api,version:e.version,method:e.method,params:e.params,scope:t,callback:function(t,e,i,n){t&&Ext.isNumber(e.timeout)&&e.timeout>0?(this.intervalTime=e.timeout,this.startPollingTask()):this.delayGetTimeOut()}})}}),SYNO.SDS.iFrameAppToFront=function(t){var e=SYNO.SDS.AppMgr.getByAppName(t);e.length&&Ext.each(e,function(t){return t.window?(t.window.toFront(),!1):void 0})},SYNO.SDS.onBasicBeforeUnload=function(){Ext.isChrome&&SYNO.SDS.DragToDesktop.destroy();var t,e;if(!_S("standalone")&&(t=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.WelcomeApp.Instance"),t&&t[0]&&!t[0].window.canReload()))return _T("welcome","unload_hint");if(!_S("standalone")&&(t=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.PkgManApp.Instance"),t&&t[0]&&t[0].window.isUpdating()))return _T("pkgmgr","close_updateall_confirm");if(t=SYNO.SDS.AppMgr.getByAppName(_S("standalone")?"SYNO.SDS.App.FileStation3.Instance":"SYNO.SDS.App.FileTaskMonitor.Instance"),t&&t[0]){e=_S("standalone")?t[0].window.panelObj.monitorPanel:t[0].window;var i="",n=_S("standalone")?_T("tree","leaf_filebrowser"):_D("os_name")||"DSM";if(e.uploadGrid.isProcessing()?i+=String.format(_WFT("upload","confirm_unload"),n):e.localGrid.isProcessing()?i+=String.format(_WFT("local_file_operation","confirm_unload"),n):e.downloadGrid.isProcessing()&&(i+=String.format(_WFT("download","confirm_unload"),n)),""!==i)return i}},SYNO.SDS.getMsgBeforeUnload=function(){var t=SYNO.SDS.onBasicBeforeUnload();return SYNO.SDS.StatusNotifier.fireEvent("beforeunload")===!1?_T("desktop","confirm_leave"):t?t:void 0},SYNO.SDS.onBeforeUnload=function(){var t=_S("standalone")?SYNO.SDS.Config.FnMap[_S("standaloneAppName")]:null,e=t&&t.config?SYNO.SDS.Utils.GetLocalizedString(t.config.title,t.config.jsID):_D("os_name")||"DSM";return SYNO.SDS.getMsgBeforeUnload()||(!1===SYNO.SDS.UserSettings.getProperty("Desktop","disableLogoutConfirm")?String.format(_T("desktop","confirm_unload"),e):void 0)},SYNO.SDS.onBeforeUnloadForApplication=function(){return SYNO.SDS.getMsgBeforeUnload()},SYNO.SDS.initData=function(t){var e,i=Ext.urlDecode(window.location.search.substr(1));return Ext.isNumber(t)&&t>0?void SYNO.SDS.initData.defer(t,this):(e=i.jsDebug?{action:"debug"}:null,void SYNO.API.Request({api:"SYNO.Core.Desktop.Initdata",method:"get",params:e,version:1,callback:function(t,e,n,s){function o(){r-=1,0===r&&(Ext.isDefined(window._loadSynoLang)&&window._loadSynoLang(),e.Session.SynoToken=_S("SynoToken"),SYNO.SDS.Session=e.Session,SYNO.SDS.Config.JSConfig=e.JSConfig,SYNO.SDS.Strings=e.Strings,SYNO.SDS.initUserSettings=e.UserSettings,SYNO.SDS.initGroupSettings=e.GroupSettings,SYNO.SDS.UrlTag=e.UrlTag,SYNO.SDS.AppPrivilege=e.AppPrivilege,SYNO.SDS.ServiceStatus=e.ServiceStatus,SYNO.SDS.UIFeatures.IconSizeManager.enableHDDisplay(e.SynohdpackStatus),SYNO.SDS.init(),window.loginLang&&_S("lang")!==window.loginLang&&(Ext.form.VTypes.reloadVtypeStr(),SYNO.API.AssignErrorStr(),SYNO.SDS.Utils.StorageUtils.UiRenderHelper=SYNO.SDS.Utils.StorageUtils.UiRenderHelperInitializer(),SYNO.SDS.Relay.GetRelaydStatusStr=SYNO.SDS.Relay.GenRelaydStatusStr()),SYNO.SDS.appendMissingCSSFiles(e.CSSFiles))}if(!t)return SYNO.Debug("SYNO.SDS.initData fail",arguments),void SYNO.SDS.initData(3e3);var r=1;switch(e.Session.lang){case"cht":case"chs":case"jpn":case"krn":Ext.getBody().addClass("syno-cjk")}var a=i.launchApp;e.Session.is_admin!==!0||e.Session.rewriteApp||a?window.loginLang&&e.Session.lang!==window.loginLang?SYNO.SDS.Utils.loadUIStrings(e.Session.lang,e.Session.fullversion,o):o():(r+=1,window.loginLang&&e.Session.lang!==window.loginLang?SYNO.SDS.Utils.loadUIStrings(e.Session.lang,e.Session.fullversion,o):o(),SYNO.API.Request({api:"SYNO.Core.QuickStart.Info",method:"load_ds_info",version:1,callback:function(t,i,n,s){return t?(Ext.isObject(i)&&(e.Session.welcome_hide=i.welcome_hide,e.Session.admin_configured=i.admin_configured,e.Session.update_setting_configured=i.update_setting_configured,e.Session.update_setting_configured===!1&&(e.Session.update_setting_update_type=i.update_setting_update_type),e.Session.myds_unified=i.myds_unified,e.Session.found_myds_account=i.found_myds_account,i.vol_path&&(e.Session.vol_path=i.vol_path)),void o()):(e.Session.qckFailed=!0,void o())}}))}}))},SYNO.SDS.appendMissingCSSFiles=function(t){var e=-1,i="",n=function(t){Ext.each(document.getElementsByTagName("link"),function(n){return e=t.indexOf("?"),-1!==e&&(i=t.substring(0,e),0<n.href.indexOf(i))?(n.parentNode.removeChild(n),!1):void 0})};Ext.each(t,function(t){var e=!1;if(0===t.indexOf("webman/3rdparty/")&&(Ext.each(document.getElementsByTagName("link"),function(i){return 0<i.href.indexOf(t)?(e=!0,!1):void 0}),!e)){n(t);var i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),i.setAttribute("href",t),document.getElementsByTagName("head")[0].appendChild(i)}})},SYNO.SDS.AutoLaunch=function(){var t=function(t,e){var i,n,s=SYNO.SDS.Config.FnMap[t]&&SYNO.SDS.Config.FnMap[t].config?SYNO.SDS.Config.FnMap[t].config:{},o=s.canLaunch;if(Ext.isObject(o))for(i in o)if(!!_S(i)!==o[i])return;n=SYNO.SDS.AppMgr.getByAppName(t),0===n.length&&SYNO.SDS.AppLaunch(t,{},!1,e)};SYNO.SDS.Config.AutoLaunchFnList.each(function(e){Ext.isObject(e)?t(e.dependName,t.createDelegate(this,[e.appName])):t(e)})},SYNO.SDS.reloadJSConfig=function(t){if(Ext.isNumber(t)&&t>0)return void SYNO.SDS.reloadJSConfig.defer(t,this);var e=function(){var t=[];SYNO.SDS.AppMgr.each(function(e){var i=e.jsConfig.jsID;Ext.isDefined(SYNO.SDS.Config.FnMap[i])||t.push(e)}),Ext.invoke(t,"destroy")};SYNO.API.Request({api:"SYNO.Core.Desktop.Initdata",method:"get",version:1,params:{action:"jsconfig"},callback:function(t,i,n,s){return t?(SYNO.SDS.Config.JSConfig=i.JSConfig,SYNO.SDS.Strings=i.Strings,SYNO.SDS.ServiceStatus=i.ServiceStatus,SYNO.SDS.AppPrivilege=i.AppPrivilege,SYNO.SDS.JSLoad.init(),SYNO.SDS.AppView.refresh(),SYNO.SDS.Desktop.refresh(),SYNO.SDS.appendMissingCSSFiles(i.CSSFiles),e(),SYNO.SDS.StatusNotifier&&SYNO.SDS.StatusNotifier.fireEvent("jsconfigLoaded"),void SYNO.SDS.AutoLaunch()):(SYNO.Debug("SYNO.SDS.reloadJSConfig fail",arguments),void SYNO.SDS.reloadJSConfig(3e3))}}),SYNO.API.currentManager||(SYNO.API.currentManager=new SYNO.API.Manager),SYNO.API.currentManager.queryAPI("all")},SYNO.SDS.autoStart=function(){var t=SYNO.SDS.UserSettings.getProperty("Desktop","restoreParams")||[],e=SYNO.SDS.UserSettings.getProperty("SYNO.SDS.HelpBrowser.Application","nolaunch")||!1;!_S("welcome_hide")&&_S("is_admin")&&SYNO.API.Request({api:"SYNO.Core.QuickStart.Info",method:"hide_welcome",version:1,callback:Ext.emptyFn}),SYNO.SDS.AutoLaunch(),Ext.each(t,function(t){SYNO.SDS.AppLaunch(t.className,Ext.apply({fromRestore:!0},t.params),!0)}),SYNO.SDS.UserSettings.removeProperty("Desktop","restoreParams"),e||SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{},!1)},SYNO.SDS.CheckBadge=function(){var t=function(){SYNO.API.Request({compound:{api:"SYNO.Entry.Request",version:1,method:"request",stopwhenerror:!1,params:[{api:"SYNO.Core.Upgrade.Server",method:"check",version:1},{api:"SYNO.Core.Package.Server",method:"check",version:1}]},scope:this,callback:Ext.emptyFn})};t()},SYNO.SDS.init=function(){var t,e,i=Ext.urlDecode(location.search.substr(1)),n=i.launchApp,s=i.launchParam,o=i.jsDebug,r=i.report,a=SYNO.SDS.Session.rewriteApp,l=Ext.id();if(Ext.isDefined(r))return void(window.location=Ext.urlAppend("/dar/"+r));Ext.isDefined(o)&&(SYNO.SDS.JSDebug=o),SYNO.SDS.initFramework();var h=SYNO.SDS.Config.FnMap[n],c=!1;if(h&&h.config){var d=h.config;("standalone"===d.type||!0===d.allowStandalone||"url"===d.type||"legacy"===d.type)&&(c=!0)}if(SYNO.SDS.StatusNotifier.isAppEnabled(n)&&c)SYNO.SDS.initStandaloneDesktop(n,s);else if(a){if(!SYNO.SDS.StatusNotifier.isAppEnabled(a))return SYNO.SDS.StatusNotifier.fireEvent("logout"),window.alert(_JSLIBSTR("uicommon","error_noprivilege")),void SYNO.SDS.Utils.Logout.action(!0);SYNO.SDS.Session.rewrite_mode=!0,SYNO.SDS.initStandaloneDesktop(a,s)}else SYNO.SDS.initDesktop(n),SYNO.SDS.StatusNotifier.isAppEnabled(n)&&SYNO.SDS.AppLaunch(n,s),window.Notification&&SYNO.SDS.UserSettings.getProperty("Desktop","enableDesktopNotification")&&"default"===window.Notification.permission&&(t=String.format('<span id={0} class="blue-status" style="cursor:pointer;">{1}</span>',l,_T("common","here")),t=String.format(_T("common","click_to_enable_notification"),t),e=SYNO.SDS.SystemTray.notifyMsg("",_T("common","desktop"),t,0,!1),Ext.get(l).on("click",function(){window.Notification.requestPermission(function(t){window.Notification.permission=t}),e.close()})),_S("is_admin")&&SYNO.SDS.CheckBadge();SYNO.SDS.GetExternalIP(),SYNO.SDS.initAccesibilityPlugin(),SYNO.SDS.HandleTimeoutTask=new SYNO.SDS.interval.Task},SYNO.SDS.initAccesibilityPlugin=function(){var t=SYNO.SDS.UserSettings.getProperty("Desktop","disableAccessibility")||!1;setARIAPluginsDisabled(t)},SYNO.SDS.initFramework=function(){var t=Ext.getCmp("sds-login");if(t&&t.el.fadeOut({callback:function(){t.destroy()}}),SYNO.SDS.LaunchTime=(new Date).getTime(),SYNO.SDS.JSLoad.init(),SYNO.SDS.StatusNotifier=new SYNO.SDS._StatusNotifier({}),SYNO.SDS.UserSettings=new SYNO.SDS._UserSettings,SYNO.SDS.GroupSettings=new SYNO.SDS._GroupSettings,SYNO.SDS.WindowMgr=new SYNO.SDS._WindowMgr,SYNO.SDS.FocusMgr=new SYNO.SDS._FocusMgr,SYNO.SDS.AppMgr=new SYNO.SDS._AppMgr,SYNO.SDS.GestureMgr=new SYNO.SDS._GestureMgr,SYNO.SDS.Injector=new SYNO.SDS._Injector(SYNO.SDS.Environment.GetEnvironment()),SYNO.SDS.Injector.configure({getDesktopClass:{fn:function(){var t=SYNO.SDS.UserSettings.getProperty("Desktop","desktopStyle");return"classical"===t||SYNO.SDS.Environment.GetEnvironment()===SYNO.SDS.Environment.ESM||"business"===_S("theme_cls")&&Ext.isEmpty(t)?"SYNO.SDS.Classical._Desktop":"SYNO.SDS._Desktop"}},getLaunchItemClass:{fn:function(){var t=SYNO.SDS.UserSettings.getProperty("Desktop","desktopStyle");return"classical"===t||SYNO.SDS.Environment.GetEnvironment()===SYNO.SDS.Environment.ESM||"business"===_S("theme_cls")&&Ext.isEmpty(t)?"SYNO.SDS.Classical._LaunchItem":"SYNO.SDS._LaunchItem"}},getAppMenuClass:{fn:function(){var t=SYNO.SDS.UserSettings.getProperty("Desktop","appMenuStyle");return"classical"===t||SYNO.SDS.Environment.GetEnvironment()===SYNO.SDS.Environment.ESM||"business"===_S("theme_cls")&&Ext.isEmpty(t)?"SYNO.SDS.Classic._AppView":"SYNO.SDS._AppView"}}}),SYNO.SDS._ActiveDesktop=Ext.getClassByName(SYNO.SDS.Injector.resolve("getDesktopClass")),SYNO.SDS.LaunchItem=Ext.getClassByName(SYNO.SDS.Injector.resolve("getLaunchItemClass")),SYNO.SDS._ActiveMenu=Ext.getClassByName(SYNO.SDS.Injector.resolve("getAppMenuClass")),SYNO.SDS.Injector.register({name:SYNO.SDS.Environment.ESM,cls:"SYNO.SDS.Themer",realCls:"SYNO.SDS.DSM.Themer",defaultCls:"SYNO.SDS.DSM.Themer"}),SYNO.SDS.ThemeProvider=new SYNO.SDS.Themer({themeCls:_S("theme_cls")}),Ext.isDefined(SYNO.SDS.JSDebug)&&(SYNO.Debug("JS Loading Caching Disabled. (append _dc to js link)"),"all"===SYNO.SDS.JSDebug)){var e=SYNO.SDS.Config.FnMap;SYNO.Debug("JS Dynamic Loading Disabled.");for(var i in e)e.hasOwnProperty(i)&&SYNO.SDS.JSLoad(i)}},SYNO.SDS.initStandaloneDesktop=function(t,e){SYNO.SDS.BackgroundTaskMgr=new SYNO.SDS._BackgroundTaskMgr,SYNO.SDS.UploadTaskMgr=new SYNO.SDS._UploadBackgroundTaskMgr,SYNO.SDS.MailTaskMgr=new SYNO.SDS._MailBackgroundTaskMgr,SYNO.SDS.SystemTray=new SYNO.SDS._SystemTray,SYNO.SDS.Session.standalone=!0,SYNO.SDS.Session.standaloneAppName=t,SYNO.SDS.Desktop=new SYNO.SDS._StandaloneDesktop,SYNO.SDS.AppLaunch(t,e),window.onbeforeunload=SYNO.SDS.onBeforeUnload,SYNO.SDS.HandleTimeoutTask=new SYNO.SDS.interval.Task},SYNO.SDS.HideDesktop=function(){SYNO.SDS.TaskBar.hide(),SYNO.SDS.Desktop.hide(),Ext.get("sds-taskbar-shadow").hide()},SYNO.SDS.ShowDesktop=function(){var t=Ext.fly("sds-wallpaper");t.dom&&t.dom.src&&Ext.fly("sds-wallpaper").show(),SYNO.SDS.Desktop.show(),SYNO.SDS.TaskBar.show(),Ext.get("sds-taskbar-shadow").show()},Ext.define("SYNO.SDS.LaunchFullSizeApps",{statics:{appList:["SYNO.SDS.App.WelcomeApp.Instance","SYNO.SDS.App.WelcomeTip.Instance"],index:0,start:function(){return this.index<this.appList.length?(SYNO.SDS.AppLaunch(this.appList[this.index],{},!1),void this.index++):void(this.index===this.appList.length&&(SYNO.SDS.ShowDesktop(),SYNO.SDS.autoStart()))}}}),SYNO.SDS.initDesktop=function(t){var e=!t&&!_S("qckFailed")&&_S("is_admin");return SYNO.SDS.BackgroundTaskMgr=new SYNO.SDS._BackgroundTaskMgr,SYNO.SDS.UploadTaskMgr=new SYNO.SDS._UploadBackgroundTaskMgr,SYNO.SDS.PackageTaskMgr=new SYNO.SDS._PackageBackgroundTaskMgr,SYNO.SDS.MailTaskMgr=new SYNO.SDS._MailBackgroundTaskMgr,SYNO.SDS.DeskTopManager=new SYNO.SDS._DeskTopManager,SYNO.SDS.TaskBar=new SYNO.SDS._TaskBar,SYNO.SDS.TaskButtons=Ext.getCmp("sds-taskbuttons-panel"),SYNO.SDS.SystemTray=Ext.getCmp("sds-tray-panel"),SYNO.SDS.Desktop=new SYNO.SDS._ActiveDesktop,SYNO.SDS.AppView=new SYNO.SDS._ActiveMenu,SYNO.SDS.System=new SYNO.SDS._System,!1===SYNO.SDS.Session.boot_done?void SYNO.SDS.System.WaitForBootUp():(e&&(SYNO.SDS.LaunchFullSizeApps.start(),SYNO.SDS.HideDesktop()),SYNO.SDS.PreviewBox=new SYNO.SDS._PreviewBox,window.onbeforeunload=SYNO.SDS.onBeforeUnload,SYNO.SDS.StatusNotifier.on("thirdpartychanged",SYNO.SDS.reloadJSConfig),SYNO.SDS.StatusNotifier.on("halt",function(){var t=Ext.getClassByName("SYNO.API.Request.Polling.Instance");SYNO.SDS.TaskMgr.setHalt(!0),Ext.isObject(t)&&Ext.isFunction(t.endPolling)&&t.endPolling("halt")}),void(e?SYNO.SDS.StatusNotifier.on("fullsizeappdestroy",function(){SYNO.SDS.LaunchFullSizeApps.start()}):SYNO.SDS.autoStart()))},SYNO.SDS.DragToDesktop=function(){var t=!1,e=[".syno-sds-fs-win",".welcomedragable-url"],i=function(t){var i=!1;Ext.each(e,function(e){return t.within(t.getTarget(e))?(i=!0,!1):void 0},this),i||t.preventDefault()},n=function(t){t.preventDefault();var e=this.timeStamp||(this.timeStamp=t.browserEvent.timeStamp);Math.abs(t.browserEvent.timeStamp-e)<100||(this.timeStamp=t.browserEvent.timeStamp,this.handleMouseMove(t))},s=function(t){this.handleMouseUp(t),t.stopPropagation(),t.preventDefault()},o=function(t){this.dragCurrent&&this.handleMouseUp.defer(150,this,[t])},r=function(t){t.preventDefault()},a=function(){Ext.dd.DragDropMgr.preventDefault=!1,Ext.EventManager.on(document,"dragstart",i,this,!0),Ext.EventManager.on(document,"dragenter",r,Ext.dd.DragDropMgr,!0),Ext.EventManager.on(document,"dragover",n,Ext.dd.DragDropMgr,!0),Ext.EventManager.on(document,"drop",s,Ext.dd.DragDropMgr,{preventDefault:!0}),Ext.EventManager.on(document,"dragend",o,Ext.dd.DragDropMgr,!0),t=!0},l=function(){Ext.dd.DragDropMgr.preventDefault=!0,Ext.EventManager.un(document,"dragstart",i,this,!0),Ext.EventManager.un(document,"dragover",n,Ext.dd.DragDropMgr,!0),Ext.EventManager.un(document,"dragenter",r,Ext.dd.DragDropMgr,!0),Ext.EventManager.un(document,"drop",s,Ext.dd.DragDropMgr),Ext.EventManager.un(document,"dragend",o,Ext.dd.DragDropMgr),t=!1},h=function(){return t};return{init:a,destroy:l,isEnable:h}}(),Ext.namespace("SYNO.SDS"),SYNO.SDS.GetExternalIP=function(){SYNO.API.Request({api:"SYNO.Core.Desktop.Initdata",method:"get",version:1,params:{action:"external_ip"},callback:function(t,e,i,n){return t?(SYNO.SDS.Session.external_ip=e.external_ip,void(SYNO.SDS.Session.ddns_hostname=e.ddns_hostname)):void SYNO.Debug("SYNO.SDS.GetExternalIP fail",arguments)}})},SYNO.SDS.HTML5Utils=function(){var t=window.XMLHttpRequest?new XMLHttpRequest:{};return{HTML5Progress:!!t.upload,HTML5SendBinary:!(!t.sendAsBinary&&!t.upload),HTML5ReadBinary:!!(window.FileReader||window.File&&window.File.prototype.getAsBinary),HTML5Slice:!(!window.File||!(window.File.prototype.slice||window.File.prototype.mozSlice||window.File.prototype.webkitSlice)),isSupportHTML5Upload:function(){var t=!(!Ext.isChrome&&(Ext.isSafari4||Ext.isSafari5_0||Ext.isWindows&&Ext.isSafari||Ext.isGecko3||Ext.isOpera));return t&&(!!window.FormData||SYNO.SDS.HTML5Utils.HTML5SendBinary&&SYNO.SDS.HTML5Utils.HTML5ReadBinary&&SYNO.SDS.HTML5Utils.HTML5Slice)},isDragFile:function(t){try{if(Ext.isWebKit){var e=t.dataTransfer.types&&-1!=t.dataTransfer.types.indexOf("Files");return e}if(Ext.isGecko)return t.dataTransfer.types.contains("application/x-moz-file");if(Ext.isIE10||Ext.isModernIE)return t.dataTransfer.files&&t.dataTransfer.types&&t.dataTransfer.types.contains("Files")}catch(i){}return!1}}}(),SYNO.SDS.SSOUtils=function(){return{callbackFn:{fn:Ext.emptyFn,scope:this},isSupport:function(){return _S("sso_support")&&_S("sso_server")&&_S("sso_appid")&&"SYNOSSO"in window&&Ext.isFunction(SYNOSSO.init)},init:function(){if(this.isSupport())try{SYNOSSO.init({oauthserver_url:_S("sso_server"),app_id:_S("sso_appid"),redirect_uri:document.URL,callback:this.callback.createDelegate(this)})}catch(t){}},callback:function(t){SYNOSSO.status=t.status,this.callbackFn.fn.call(this.callbackFn.scope,t)},login:function(t,e){this.callbackFn.fn=t,Ext.isDefined(e)&&(this.callbackFn.scope=e),SYNOSSO.login()},logout:function(t,e){e&&t.createDelegate(e),"sso"===Ext.util.Cookies.get("login_type")&&SYNOSSO.logout(t)}}}(),Ext.define("SYNO.SDS.IEUpgradeAlert",{extend:"SYNO.SDS.Window",constructor:function(){var t={cls:"ie-upgrade-alert",width:450,height:230,maximizable:!1,title:_D("manager"),items:[{xtype:"syno_formpanel",name:"ie_alert_form",items:[{xtype:"syno_displayfield",hideLabel:!0,value:_T("desktop","upgrade_ie_browser")},{name:"skip_alert",xtype:"syno_checkbox",checked:!1,boxLabel:_T("common","dont_alert_again")}]}],fbar:{toolbarCls:"x-panel-fbar x-statusbar",items:[{xtype:"syno_button",text:_T("common","ok"),btnStyle:"blue",handler:function(){var t=this.find("name","skip_alert")[0],e=new Date;t.getValue()===!0&&Ext.util.Cookies.set("skip_upgrade_ie_alert",!0,e.add(Date.YEAR,1)),this.close()},scope:this}]}};this.callParent([t])}}),Ext.define("SYNO.SDS.InitUtils",{singleton:!0,checkTargetSelectable:function(t){if(t.getTarget(".selectabletext"))return!0;if(t.getTarget("textarea"))return!0;var e=t.getTarget("input"),i=e&&e.type?e.type.toLowerCase():"";return"text"!==i&&"textarea"!==i&&"password"!==i?!1:e.readOnly?!1:!0},checkTargetTextFiledorTextArea:function(t){var e=t.getTarget("input"),i=e&&e.type?e.type.toLowerCase():"";return t.getTarget("textarea")?!0:"text"!==i&&"password"!==i?!1:!0},hideForms:function(){var t=Ext.get("sds-login-dialog-form"),e=Ext.get("sds-apply-preview-form");return t&&t.setStyle("display","none"),e&&e.setStyle("display","none"),this},initQuickTips:function(){return Ext.QuickTips.init(),(!Ext.isIE9m||Ext.isIE9)&&Ext.QuickTips.getQuickTip().getEl().disableShadow(),this},initDragDrop:function(){return Ext.dd.DragDropMgr.stopPropagation=!1,Ext.dd.DragDropMgr.clickTimeThresh=-1,Ext.WindowMgr.zseed=12e3,this},disableIESelect:function(){return Ext.isIE&&Ext.getDoc().on("selectstart",function(t){this.checkTargetSelectable(t)||t.stopEvent()},this),this},disableSelectAllKeyboard:function(){return Ext.getDoc().on("keydown",function(t){t.ctrlKey&&t.A===t.getKey()&&!this.checkTargetSelectable(t)&&t.stopEvent(),t.BACKSPACE!==t.getKey()||this.checkTargetTextFiledorTextArea(t)||t.preventDefault(),Ext.isIE&&t.ESC===t.getKey()&&this.checkTargetTextFiledorTextArea(t)&&t.preventDefault()},this),this},disableRightClick:function(){return Ext.getBody().on("contextmenu",function(t){this.checkTargetSelectable(t)||t.getTarget(".allowDefCtxMenu")||t.stopEvent()},this),this},handleServerError:function(){return Ext.Ajax.on("requestcomplete",function(t,e,i){try{SYNO.SDS.Utils.CheckServerError(e)&&(t.purgeListeners(),delete i.success,delete i.failure,delete i.callback)}catch(n){if(!Ext.isIE8)throw n}}),this},initHTML5Upload:function(){return SYNO.SDS.HTML5Utils.isSupportHTML5Upload()&&Ext.getBody().on("dragover",function(t){SYNO.SDS.HTML5Utils.isDragFile(t.browserEvent)&&(t.preventDefault(),t.browserEvent.dataTransfer.dropEffect="none")}),this},IEUpgradeAlert:function(){if(Ext.isIE6||Ext.isIE7||Ext.isIE8||Ext.isIE9){var t=Ext.util.Cookies.get("skip_upgrade_ie_alert");if(!t){var e=new SYNO.SDS.IEUpgradeAlert;e.show()}}return this},defaultCSSSelectors:function(){_S("diskless")&&Ext.getBody().addClass("syno-diskless"),Ext.isIE10Touch&&Ext.getBody().addClass("syno-ie10-touch");var t=Ext.urlDecode(location.search.substr(1)),e=t.accessible;return Ext.isDefined(e)&&Ext.getBody().addClass("accessible"),this},initAPIManagerPromise:function(){return SYNO.API.currentManager||(SYNO.API.currentManager=new SYNO.API.Manager),new Promise(function(t,e){SYNO.API.currentManager.queryAPI("all",t)})},initSSO:function(){return SYNO.SDS.SSOUtils.init(),this},initHDPack:function(){return SYNO.SDS.UIFeatures.IconSizeManager.addHDClsAndCSS(_S("SynohdpackStatus")),this},initLoginDialog:function(){var t,e;return"undefined"!=typeof SYNO.SDS.ForgotPass?t=new SYNO.SDS.ChangePassPage({}):_S("isLogined")?_S("preview")?(window.opener&&window.opener.previewParam&&window.opener.previewParam.preview_modified&&(t=new SYNO.SDS.LoginApplyPreviewForm({})),e=new SYNO.SDS.LoginDialog({preview:!0})):"no"!==_S("enable_syno_token")?SYNO.SDS.UpdateSynoToken(this.readyToInitData):this.readyToInitData():0<window.location.search.indexOf("SynoToken=")?window.location.search=window.location.search.replace(/&SynoToken=.*/,""):(window.loginLang=_S("lang"),e=new SYNO.SDS.LoginDialog({})),this},readyToInitData:function(){if(SYNO.SDS.initData(),"1"==Ext.util.Cookies.get("stay_login")){var t=new Date;t.setDate(t.getDate()+30);var e=Ext.util.Cookies.get("id");Ext.util.Cookies.set("id",e,t)}return this}}),Ext.define("SYNO.SDS.TransitionEndHandler",{extend:"Ext.util.Observable",constructor:function(t){var e=this;e.el=t,t.on("transitionend",this.endTransition,this),e.callParent(arguments)},start:function(){this.startTime=new Date},endTransition:function(){var t=this;t.fireEvent("aftertransition",t,new Date-t.startTime)}}),Ext.define("SYNO.SDS._DeskTopManager",{extend:"Ext.util.Observable",list:null,front:null,desktopId:"sds-desktop",constructor:function(){var t=this;t.list={},t.callParent()},register:function(t){var e=this;t.manager&&t.manager.unregister(t),t.manager=this,e.list[t.id]=t,(t.id===e.desktopId||t===e.desktopId)&&e.showDesktop()},unregister:function(t){var e=this;delete t.manager,delete e.list[t.id]},isDesktopOnTop:function(){var t=this;return t.front===t.get(t.desktopId)},showDesktop:function(){var t=this,e=t.get(t.desktopId);t.bringToFront(e)},get:function(t){return"object"==typeof t?t:this.list[t]},updateTransition:function(t,e){var i=this;e>500&&(i.disableBlur=!0,i.transitionHandler.un("aftertransition",i.updateTransition,i))},bringToFront:function(t){var e=this,i=!1;return t=e.get(t),t!==e.front&&t?(i=t.doLayout,t.show(),e.front&&e.front.id===e.desktopId?e.front.addClass(e.backgroundTransparent?"semi-transparent":"sent-back"):e.front&&e.front.hide(),e.front=t,i&&t.doLayout(),!0):!1},hideAllExceptMe:function(t){var e,i=this;for(var n in i.list)i.list.hasOwnProperty(n)&&(e=i.list[n],e&&e!==t&&"function"!=typeof i.list[n]&&i.list[n].isVisible()&&i.list[n].hide())},hideAll:function(){for(var t in this.list)this.list[t]&&"function"!=typeof this.list[t]&&this.list[t].isVisible()&&this.list[t].hide();this.front=null},getActive:function(){return this.front},each:function(t,e){for(var i in this.list)if(this.list[i]&&"function"!=typeof this.list[i]&&t.call(e||this.list[i],this.list[i])===!1)return}}),SYNO.SDS.DefineDesktopView=function(t,e){Ext.define(t,{extend:e,animateShowHideCls:"sds-desktop-view-animate",showCls:"sds-desktop-view-show",constructor:function(t){var e=this;t=t||{},t=Ext.apply(t,{tabIndex:-1,hideMode:"offsets",hidden:!0}),e.callParent([t]),e.initManager(t.manager||SYNO.SDS.DeskTopManager),t.taskBarConfig&&e.initTaskbarButton(t.taskBarConfig),t.trayIconConfig&&e.initTrayIconButton(t.trayIconConfig)},initManager:function(t){var e=this;e.manager=t,e.manager.register(e)},initTaskbarButton:function(t){_S("standalone")||(t=t||{},t=Ext.applyIf(t,{toggleHandler:this.onToggle.createDelegate(this)}),this.taskBarButton=SYNO.SDS.TaskBar.addDesktopViewButton(t))},initTrayIconButton:function(t){_S("standalone")||(t=t||{},t=Ext.applyIf(t,{toggleHandler:this.onToggle.createDelegate(this)}),this.taskBarButton=SYNO.SDS.TaskBar.addTrayIconViewButton(t))},toggleButton:function(t,e){var i=this,n=i.taskBarButton;n&&n.toggle(t,e)},onToggle:function(t,e){this[e?"activeView":"showDesktop"]()},hide:function(){var t=this;t.transitionHandler.start(),t.removeClass(t.showCls),t.callParent(),t.toggleButton(!1,!0)},show:function(){var t=this;t.transitionHandler.start(),t.addClass(t.showCls),t.callParent()},updateTransition:function(t,e){var i=this;e>500&&(i.addClass("no-transition"),i.transitionHandler.un("aftertransition",i.updateTransition,i))},resetTransition:function(){var t=this;t.disableBlur=!1,t.removeClass("no-transition")},activeView:function(){var t=this;t.manager.bringToFront(t),t.focus()},showDesktop:function(){var t=this;t.manager.showDesktop()},afterRender:function(){var t=this;t.callParent(),t.transitionHandler=t.transitionHandler||new SYNO.SDS.TransitionEndHandler(t.getEl()),t.transitionHandler.on("aftertransition",t.updateTransition,t),Ext.EventManager.onWindowResize(this.onWindowResize,this),t.animateShowHide&&t.addClass(t.animateShowHideCls),t.el.on("mousedown",this.onClick,this),void 0!==t.tabIndex&&t.el.dom.setAttribute("tabIndex",t.tabIndex),t.keyNav=new Ext.KeyNav(t.el,{esc:this.onEnterEsc,scope:this})},onEnterEsc:function(t){this.showDesktop()},onClick:function(t,e){},resize:function(t,e){},getViewSize:function(){var t={viewH:Ext.lib.Dom.getViewHeight()-SYNO.SDS.TaskBar.getHeight(),viewW:Ext.lib.Dom.getViewWidth()};return t},onWindowResize:function(){var t=this,e=t.getViewSize();t.resize(e.viewW,e.viewH)},refresh:function(){},addInstruction:function(){var t=Ext.lib.Dom.getViewHeight()-SYNO.SDS.TaskBar.getHeight(),e=Ext.lib.Dom.getViewWidth();this.instruction=new Ext.Container({cls:"sds-app-widget-instruction",width:e,height:t,items:[{xtype:"box",cls:"message-container",html:_T("desktop","shortcut_zone_instruction")},{xtype:"box",cls:"message-arrow"}],listeners:{afterlayout:function(){var t=this.el.child(".message-container"),e=this.el.child(".message-arrow"),i=.33*this.getHeight();t.alignTo(this.shortcutZoneLeft.el,"tl-tr",[-36,i]),e.alignTo(t,"r-l",[1,5])},scope:this},resize:function(){var t=Ext.lib.Dom.getViewHeight()-SYNO.SDS.TaskBar.getHeight(),e=Ext.lib.Dom.getViewWidth();this.setSize(e,t),this.doLayout()},showTip:function(){this.addClass("show")}}),this.add(this.instruction),this.on("show",this.showInstruction,this)},showInstruction:function(){this.showTaskId=Ext.defer(function(){this.instruction&&(this.shortcutZoneLeft.addClass("on-instruction"),this.shortcutZoneRight.addClass("on-instruction"),this.shortcutZoneBottom&&this.shortcutZoneBottom.addClass("on-instruction"),this.instruction.showTip())},500,this)},removeInstruction:function(){clearTimeout(this.showTaskId),this.resetTransition(),this.instruction&&(this.remove(this.instruction,!0),this.instruction=null,this.shortcutZoneLeft.removeClass("on-instruction"),this.shortcutZoneRight.removeClass("on-instruction"),this.shortcutZoneBottom&&this.shortcutZoneBottom.removeClass("on-instruction"),this.un("show",this.showInstruction,this),this.un("beforehide",this.removeInstruction,this))},destroy:function(){var t=this;t.transitionHandler.un("aftertransition",t.updateTransition,t),t.transitionHandler=null,Ext.EventManager.removeResizeListener(t.onWindowResize,t),Ext.destroy(t.keyNav),t.keyNav=null,t.taskBarButton.getEl().remove(),t.callParent(arguments)}})},SYNO.SDS.DefineDesktopView("SYNO.SDS._DesktopView","Ext.Container"),SYNO.SDS.DefineDesktopView("SYNO.SDS.Box_DesktopView","Ext.BoxComponent"),Ext.define("SYNO.SDS._Logo",{extend:"Ext.Component",theme:"light",logoArray:["synology","DSM"],constructor:function(t){var e=this;t=Ext.applyIf(t||{},{cls:"sds-logo"}),e.callParent([t])},onRender:function(t,e){var i=this;i.callParent(arguments),i.el.addClass(i.theme),i.logoArray.each(function(t){this[t]=this.el.createChild({cls:"logo-"+t})},i)}}),Ext.define("SYNO.SDS.DSMLogo",{extend:"SYNO.SDS._Logo",logoArray:["synology","DSM","major"],version:0,onRender:function(t,e){var i=this,n=i.version,s=[],o=_S("buildphase");i.callParent(arguments),n=Ext.isNumber(n)?n:0,n+="",s=n.split(""),s.each(function(t){this.el.createChild({cls:"logo-"+t})},i),("beta"===o||"rc"===o)&&(i.el.createChild({cls:"logo-"+o}),i.el.addClass(o))}}),Ext.namespace("SYNO.SDS.LaunchItem"),Ext.define("SYNO.SDS.LaunchItemHelper",{statics:{getGroupReviewIconPosition:function(t,e,i,n){i=Ext.isNumber(i)?i:6,
n=Ext.isNumber(n)?n:6;var s=i+e+t-2*e-2*i,o=n+e+t-2*e-2*n,r=[{left:i,top:n},{left:s,top:n},{left:i,top:o},{left:s,top:o}];return r}}}),SYNO.SDS._LaunchItem=Ext.extend(Ext.util.Observable,{getPriviewPositionFn:SYNO.SDS.LaunchItemHelper.getGroupReviewIconPosition.createDelegate(this,[64,24]),iconCategory:"Desktop",shortIconCls:"",manager:null,removable:!1,container:null,el:null,dragEl:null,contextMenu:null,lastClick:0,clickInterval:1e3,iconItems:[],li_el:null,defaultXY:null,specialTarget:{_blank:!0,_self:!0,_parent:!0,_top:!0},constructor:function(t,e){this.allowedCfgProperty=SYNO.SDS.ShortcutUtil.getCfgPropertis(),t.className||t.jsID?this.applyConfig(t):Ext.apply(this,t),Ext.id(this),this.container=Ext.get(e||document.body),this.contextMenu=this.getContextMenu(),this.module=t.module,this.index=t.index,this.el=this.createElement(),this.el.on("click",this.onClick,this),this.dragEl.on("mouseover",this.onMouseOver,this),this.dragEl.on("mousedown",this.onMouseDown,this),this.dragEl.on("contextmenu",this.onContextMenu,this)},applyConfig:function(t){var e,i=SYNO.SDS.Config.FnMap[t.className||t.jsID];this.className=t.jsID,t.title&&t.icon||Ext.copyTo(this,i.config,this.allowedCfgProperty),Ext.copyTo(this,t,"manager,removable,iconSize,"+this.allowedCfgProperty),this.plaintitle=SYNO.SDS.Utils.GetLocalizedString(this.title||"",this.className),this.title=SYNO.SDS.Utils.GetLocalizedString(this.formatedTitle||this.title||"",this.className),this.desc=SYNO.SDS.Utils.GetLocalizedString(this.desc||"",this.className),e=encodeURI(i.config.jsBaseURL)+"/"+(this.icon||this.icon_32),this.icon=SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(e,this.iconCategory)},remove:function(){return this.isSelected()&&this.manager?void this.manager.removeSelectedItems():this.manager&&"SYNO.SDS.VirtualGroup"==this.manager.className?1===this.manager.subItems.length?void this.manager.remove():(this.manager.subItems.remove(this.managerItemConfig),this.manager.manager.updateItemsSetting(),this.manager.refreshSubItems(),this.manager=null,void this.destroy()):(this.manager&&(this.manager.removeLaunchItem(this),this.manager=null),this.li_el.addClass("launch-icon-remove-animation"),void this.destroy.defer(250,this))},renameHandler:function(){this.showInputField()},showInputField:function(){var t,e=this.li_el.child(".text");e.hide(),this.renameInputField=Ext.getBody().createChild({tag:"input",type:"text",value:this.title||"",maxlength:256,cls:"sds-launch-icon-input"}),t=this.renameInputField,t.setLeft(e.getX()),t.setTop(e.getY()),t.focus(100),t.on("blur",this.onRenameInputBlur,this),t.on("keyup",this.onRenameInputKeyup,this)},onRenameInputBlur:function(t,e,i){var n=this.li_el.child(".text"),s=this.renameInputField;this.title=Ext.util.Format.htmlEncode(e.value),this.managerItemConfig.title=this.title,this.manager.updateItemsSetting(),this.updateGroupTitle(this.title),s.removeAllListeners(),s.remove(),n.show()},onRenameInputKeyup:function(t,e,i){var n=this.renameInputField;t.getKey()===t.ENTER&&n.blur()},destroy:function(){this.closeSubContainer(),this.monitoringMouseOver&&Ext.getDoc().un("mouseover",this.monitorMouseOver,this),this.monitoringMouseMove&&Ext.getDoc().un("mousemove",this.monitorMouseMove,this),this.contextMenu&&(this.contextMenu.destroy(),this.contextMenu=null),this.el&&(this.el.purgeAllListeners(),this.el.remove(),this.el=null)},refreshElementIcons:function(){Ext.each(this.iconEls,function(t){t&&t.remove()},this),this.iconEls=[],this.createVirtualGroupIcon()},getIconStyle:function(){return"SYNO.SDS.VirtualGroup"!==this.className?{"background-image":String.format("url({0})",this.icon||"")}:{}},createElement:function(){var t,e,i,n="",s=!1;if(n=this.desc||this.plaintitle||this.title||"",e=this.container,("standalone"===this.type||!0===this.allowStandalone||"url"===this.type||"legacy"===this.type)&&(this.url||this.urlTag)){var o=this.url||SYNO.SDS.UrlTag[this.urlTag]||"";if((this.port||this.protocol)&&"http"!==o.substr(0,4).toLowerCase()){var r=this.protocol||window.location.protocol,a=this.port||window.location.port||"";a&&(a=":"+a),o=r+"://"+window.location.hostname+a+o}e=e.createChild({tag:"li","aria-label":n,role:"menuitem",href:o,target:this.urlTarget in this.specialTarget?this.urlTarget:this.urlTarget?this.urlTarget+SYNO.SDS.LaunchTime:"_blank"}),t=e,s=!0}return i=e.createChild({tag:"li","ext:qtip":Ext.util.Format.htmlEncode(n),cls:"launch-icon "+this.shortIconCls,cn:[{cls:"image",style:this.getIconStyle()},{cls:"text",html:this.title||""}]}),s===!1&&i.set({"aria-label":n,role:"menuitem"}),this.li_el=i,this.createVirtualGroupIcon(),this.dragEl=i,t||i},getContextMenu:function(){var t=this.launchParams||{},e=[];for(var i in t)t.hasOwnProperty(i)&&e.push({id:this.id+i,text:SYNO.SDS.Utils.GetLocalizedString(i,this.className),handler:this.launchApp.createDelegate(this,[t[i]])});return("standalone"===this.type||!0===this.allowStandalone||("url"===this.type||"legacy"===this.type)&&"_self"!==this.urlTarget)&&e.push({text:_T("desktop","open_in_new_window"),scope:this,handler:this.openNewWindow,useBuffer:!1}),this.manager&&this.removable&&(e.length>0&&e.push("-"),e.push({itemId:"remove_shortcut",text:_T("desktop","remove_shortcut"),scope:this,handler:this.remove})),this.isFileShortcut(this)&&e.push({text:_WFT("filetable","filetable_rename"),scope:this,handler:this.renameHandler}),e.length?new SYNO.ux.Menu({items:e}):null},onContextMenu:function(t){if(t.preventDefault(),this.contextMenu){var e,i,n,s,o=this.contextMenu.getComponent("remove_shortcut"),r=!0;if(Ext.QuickTips.getQuickTip().cancelShow(this.dragEl),e=this.contextMenu.items,this.subItems?Ext.each(this.subItems,function(t){s=SYNO.SDS.Config.FnMap[t.className].config,s.removable===!1&&(r=!1)}):(s=SYNO.SDS.Config.FnMap[this.className].config,s.removable===!1&&(r=!1)),r===!1){if(o){if(1===e.getCount())return;i=e.indexOf(o),n=e.getRange(Math.max(i-1,0),i),n.each(function(t){t.hide()})}}else e.each(function(t){t.show()});this.contextMenu.showAt(t.getXY())}},openNewWindow:function(){SYNO.SDS.WindowLaunch(this.className,this.param,null,this)},onClick:function(t){var e=(new Date).getTime(),i=this.cancelClick||e-this.lastClick<this.clickInterval;return"click"===t.browserEvent.type&&i?void t.stopEvent():(this.lastClick=e,"SYNO.SDS.VirtualGroup"===this.className?(this.createSubContainer(),void this._ul.focus()):(this.manager&&"SYNO.SDS.VirtualGroup"==this.manager.className&&this.manager.closeSubContainer(),"url"===this.type||"standalone"===this.type||!0===this.allowStandalone&&t.hasModifier()||"legacy"===this.type&&("url"===this.urlDefMode||t.hasModifier())?void("_self"===this.urlTarget?window.onbeforeunload=null:(t.stopEvent(),this.openNewWindow())):(t.stopEvent(),void this.launchApp(this.param))))},launchApp:function(t){SYNO.SDS.AppLaunch.defer(100,window,[this.className,t,!0])},onMouseOver:function(t){this.dragEl.addClass("x-btn-over"),this.monitoringMouseOver||(Ext.getDoc().on("mouseover",this.monitorMouseOver,this),this.monitoringMouseOver=!0)},monitorMouseOver:function(t){t.target==this.el.dom||t.within(this.el)||(this.monitoringMouseOver&&(Ext.getDoc().un("mouseover",this.monitorMouseOver,this),this.monitoringMouseOver=!1),this.onMouseOut(t))},onMouseOut:function(t){this.dragEl.removeClass("x-btn-over")},onMouseDown:function(t){this.disabled||0!==t.button||(this.dragEl.addClass("x-btn-click"),Ext.getDoc().on("mouseup",this.onMouseUp,this),this.cancelClick=!1,this.monitoringMouseMove||(Ext.getDoc().on("mousemove",this.monitorMouseMove,this),this.monitoringMouseMove=t.getXY()))},onMouseUp:function(t){0===t.button&&(this.dragEl.removeClass("x-btn-click"),Ext.getDoc().un("mouseup",this.onMouseUp,this))},monitorMouseMove:function(t){if(this.monitoringMouseMove){var e=Ext.dd.DragDropMgr.clickPixelThresh,i=t.getXY(),n=this.monitoringMouseMove,s=Math.abs(n[0]-i[0]),o=Math.abs(n[1]-i[1]);e>=s&&e>=o||(Ext.getDoc().un("mousemove",this.monitorMouseMove,this),delete this.monitoringMouseMove,this.cancelClick=!0)}},createSubItems:function(){var t,e=["subItemsDesc","separator","divCt"];this.iconItems=[],this.uls=[],e.each(function(t){var e=this[t];e&&e.remove()},this),this.subItemsDesc=this.virtualContainer.createChild({tag:"input",type:"text",value:this.title||"",maxlength:64,cls:"sds-sub-container-desc"}),this.subItemsDesc.on("keyup",this.onDescKeyUp,this,{buffer:100}),this.subItemsDesc.on("blur",this.onDescBlur,this),this.separator=this.virtualContainer.createChild({tag:"hr"}),this.divCt=this.virtualContainer.createChild({tag:"div",cls:"sds-sub-container-div-ct"}),t=this.divCt.createChild({tag:"ul",tabindex:0,"aria-lable":this.title||"",role:"listbox",cls:"sds-desktop-shortcut"}),this.uls.push(t),this._ul=t,this.keyNav=new Ext.KeyNav(t,{esc:function(){this.closeSubContainer(),Ext.get("sds-desktop-shortcut").focus()},scope:this}),this.refresh()},onDescKeyUp:function(t,e,i){this.title=Ext.util.Format.htmlEncode(e.value),this.managerItemConfig.title=this.title,this.manager.updateItemsSetting(),this.updateGroupTitle(this.title),t.getKey()===t.ENTER&&this.subItemsDesc.blur()},onDescBlur:function(t,e,i){var n=e.value;Ext.isIE||Ext.isOpera?(e.value="",function(){e.value=n}.defer(10)):Ext.isGecko&&(e.value=n)},updateGroupTitle:function(t){var e=this.li_el,i=e.child(".text");i&&i.update(t),this.desc||e.set({"ext:qtip":t})},removeSubItems:function(){return this.manager&&"SYNO.SDS.VirtualGroup"==this.manager.className?(this.manager=null,void this.destroy()):void 0},createSubContainer:function(){var t,e=Ext.get("sds-desktop");this.iconItems=[],this.uls=[];var i=Ext.getBody();this.shim=i.createChild({tag:"div",id:"sds-sub-container-shim"}),this.shim.on("click",this.onShimClick,this),t=this.virtualContainer=e.createChild({tag:"div",cls:"white-scrollerbar "+(this.shortIconCls||""),id:"sds-sub-container"}),this.arrow=t.createChild({tag:"div",cls:"virtual-group-background"}).createChild({tag:"div",cls:"virtual-group-arrow"}),this.createSubItems(),this.adjustSubContainerPosition(),this.virtualContainer.shift({height:this.virtualContainer.targetHeight,width:this.virtualContainer.targetWidth,easing:"easeIn",duration:.45,callback:function(){},scope:this})},adjustSubContainerPosition:function(){var t,e,i,n=this.el,s=n.getTop(!0),o=n.getLeft(),r=n.getRight(),a=this.virtualContainer,l=316,h=192,c=this.arrow,d=84,S=Ext.get("sds-desktop"),u=S.getHeight(),g=S.getWidth();t=s-48,e=r-24+12,0>t&&(i=d+t,t=0),t+h>u&&(i=d+(t+h-u),t=u-h),o>l&&e+l>g&&(e=o-l+24-12,c&&c.addClass("right-arrow")),a.setLeft(e),a.setTop(t),c&&Ext.isNumber(i)&&c.setTop(i)},validTempNode:function(){var t;for(t=0;t<this.subItems.length;++t)if(this.subItems[t]._temp){this.subItems[t]._temp=!1,this.iconItems[t]&&(this.iconItems[t].li_el.show(),this.iconItems[t].li_el._temp=!1);break}return this.manager.updateItemsSetting(),!0},removeTempNode:function(){for(var t=-1,e=0;e<this.subItems.length;++e)if(this.subItems[e]._temp){t=e;break}return 0>t?!1:(this.subItems.splice(t,1),this.manager.updateItemsSetting(),!0)},addSubItem:function(t,e){t._temp=!e,this.subItems.push(t)},validateItems:function(){var t=[];Ext.each(this.subItems,function(e){if(e){var i=e.className||e.jsID;SYNO.SDS.Config.FnMap[i]&&SYNO.SDS.StatusNotifier.isAppEnabled(i)&&t.push(e)}},this),0===t.length?this.remove():this.subItems.length!==t.length&&(this.subItems=t,this.refreshElementIcons())},refresh:function(){var t,e,i=0,n=0;t=this._ul;var s=0,o=0,r=64,a=128,l=42,h=0,c=0,d=24;if(Ext.each(this.subItems,function(S,u){if(S&&SYNO.SDS.Config.FnMap[S.className]){++i,++n,e=this.iconItems[u],e||(e=new SYNO.SDS.LaunchItem(Ext.apply({},{manager:this,removable:!0},S),t),this.iconItems.push(e),e.managerItemConfig=S,S._temp&&(e.li_el._temp=!0,e.li_el.hide()),e.li_el.addClass("transition-cls")),u%3===0&&u>0&&(o++,s=0);var g=h+s*(r+l),p=d+o*(a+c);e.li_el.setLeft(g),e.li_el.setTop(p),s++}},this),t){var S=d+o*(a+c)+a;t.setHeight(S),this.updateScrollbar()}},updateScrollbar:function(){var t=this.divCt.dom;t&&t.fleXcroll?t.fleXcroll.updateScrollBars():t&&fleXenv.fleXcrollMain(this.divCt.dom)},refreshSubItems:function(){Ext.each(this.iconItems,function(t){t&&t.removeSubItems()}),this.iconItems=[],Ext.each(this.uls,function(t){t&&t.remove()}),this.uls=[],this.createSubItems(),this.adjustSubContainerPosition()},closeSubContainer:function(){if("SYNO.SDS.VirtualGroup"!=this.className)return!1;Ext.each(this.iconItems,function(t,e){t&&t.removeSubItems()}),this.iconItems=[],Ext.each(this.uls,function(t){t&&t.remove()}),this.uls=[],this.shim&&(this.shim.remove(),this.shim=null);var t=!1;return this.virtualContainer&&(t=!0,this.virtualContainer.remove(),this.virtualContainer=null),this.refreshElementIcons(),t},onShimClick:function(){this.shim.remove(),this.shim=null,this.virtualContainer.remove(),this.virtualContainer=null,this.manager.refresh(),SYNO.SDS.Desktop._containerShown=!1,this.refreshElementIcons()},setMoveIcon:function(t){if(!(0>t||t>=this.subItems.length)){var e=this.subItems[t];if(e){var i=SYNO.SDS.Config.FnMap[e.className];if(i){var n=encodeURI(i.config.jsBaseURL)+"/"+(e.icon||i.config.icon||i.config.icon_32),s=SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(n,this.iconCategory);this._preview.dom.src=s}}}},onMoveIcons:function(t){if(!Ext.dd.DragDropMgr.dragCurrent&&this._preview){var e=this.el.getWidth()+10,i=t.xy[0]-this.el.getLeft();if(!(i>e||0>i)){var n=Math.floor(i/e*this.subItems.length);this.setMoveIcon(n)}}},onMouseOverMoveIcons:function(){!Ext.dd.DragDropMgr.dragCurrent&&this._preview&&(this.setMoveIcon(0),this.icon_holder.addClass("sds-grouping-show-big-preview"))},onMouseOutMoveIcons:function(){this.icon_holder.removeClass("sds-grouping-show-big-preview")},rePosition:function(t,e){var i=t,n=e,s=this.subItems[i],o=this.iconItems[i];this.subItems.splice(n,0,s),this.iconItems.splice(n,0,o),i>n&&i++,this.subItems.splice(i,1),this.iconItems.splice(i,1),this.manager.updateItemsSetting(),this.refresh()},createVirtualGroupIcon:function(){if(this.subItems){var t=this.li_el;this.icon_holder=t.first(),this._background||(this._background=this.icon_holder.createChild({cls:"virtual-group-icon-background"})),this._preview||(this._preview=this.icon_holder.createChild({tag:"img",cls:"sds-grouping-big-preview-icon"}),t.on("mousemove",this.onMoveIcons,this),t.on("mouseover",this.onMouseOverMoveIcons,this),t.on("mouseout",this.onMouseOutMoveIcons,this)),this.iconEls=[];var e=this.getPriviewPositionFn();Ext.each(this.subItems,function(t,i){if(!(i>=4)&&t){var n=SYNO.SDS.Config.FnMap[t.className];if(n){var s=encodeURI(n.config.jsBaseURL)+"/"+(t.icon||n.config.icon||n.config.icon_32),o=SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(s,this.iconCategory);this.iconEls[i]=this.icon_holder.createChild({tag:"img",cls:"sds-grouping-preview-icon",style:String.format("left: {0}px; top: {1}px",e[i].left,e[i].top),src:o})}}},this)}},isSelected:function(){return!!this._selected},setSelected:function(t){this._selected=!!t},blinkForAdd:function(){var t;"SYNO.SDS.VirtualGroup"===this.className&&this.li_el&&(t=this.li_el.child(".image"),t.frame("#000",1,{duration:.5}),t.setStyle("visibility",""))},isFileShortcut:function(t){return t&&"SYNO.SDS.App.FileStation3.Instance"===t.className&&t.param&&t.param.file_id?!0:!1}}),Ext.define("SYNO.SDS.Classical._LaunchItem",{extend:"SYNO.SDS._LaunchItem",shortIconCls:"classical",iconCategory:"ClassicalDesktop",getPriviewPositionFn:SYNO.SDS.LaunchItemHelper.getGroupReviewIconPosition.createDelegate(this,[48,16]),adjustSubContainerPosition:function(){var t,e,i,n=this.el,s=n.getTop(!0),o=n.getLeft(),r=n.getRight(),a=this.virtualContainer,l=316,h=176,c=this.arrow,d=76,S=Ext.get("sds-desktop"),u=S.getHeight(),g=S.getWidth();t=s-48,e=r-24+12,0>t&&(i=d+t,t=0),t+h>u&&(i=d+(t+h-u),t=u-h),o>l&&e+l>g&&(e=o-l+24-12,c&&c.addClass("right-arrow")),a.setLeft(e),a.setTop(t),c&&Ext.isNumber(i)&&c.setTop(i)},refresh:function(){var t,e,i=0,n=0;t=this._ul;var s=0,o=0,r=74,a=112,l=27,h=0,c=0,d=24;if(Ext.each(this.subItems,function(S,u){if(S&&SYNO.SDS.Config.FnMap[S.className]){++i,++n,e=this.iconItems[u],e||(e=new SYNO.SDS.LaunchItem(Ext.apply({},{manager:this,removable:!0},S),t),this.iconItems.push(e),e.managerItemConfig=S,S._temp&&(e.li_el._temp=!0,e.li_el.hide()),e.li_el.addClass("transition-cls")),u%3===0&&u>0&&(o++,s=0);var g=h+s*(r+l),p=d+o*(a+c);e.li_el.setLeft(g),e.li_el.setTop(p),s++}},this),t){var S=d+o*(a+c)+a;t.setHeight(S),this.updateScrollbar()}}}),Ext.define("SYNO.SDS.DesktopShortcutPanel",{extend:"Ext.Container",activeIdx:-1,constructor:function(t){var e={autoEl:{tag:"ul",tabindex:0,role:"menu","aria-label":_T("common","desktop"),id:"sds-desktop-shortcut",cls:"sds-desktop-shortcut"},listeners:{afterrender:{fn:function(){this.getEl().on("keydown",this.onKeyPress,this),this.getEl().on("blur",this.onBlur,this)},scope:this}}};Ext.apply(e,t),this.callParent([e])},onBlur:function(){this.clearSelectCls(),this.getEl().dom.removeAttribute("aria-activedescendant"),this.activeIdx=-1},onKeyPress:function(t){var e=t.getKey(),i=this.activeIdx;e===t.ENTER||e===t.SPACE?(this.module.iconItems[i].onClick(t),t.preventDefault()):e===t.LEFT||e===t.UP?(this.setPrevItem(i),t.preventDefault()):(e===t.RIGHT||e===t.DOWN)&&(this.setNextItem(i),t.preventDefault())},setNextItem:function(t){var e=this.module.iconItems,i=t===e.length-1?0:t+1;return i>e.length-1?void 0:e[i].hidden===!0?void this.setNextItem(i):void this.setActiveItem(i)},setPrevItem:function(t){var e=this.module.iconItems,i=0===t?e.length-1:t-1;return 0>i?void 0:e[i].hidden===!0?void this.setPrevItem(i):void this.setActiveItem(i)},setActiveItem:function(t){var e=this.module.iconItems[t];e&&(this.clearSelectCls(),this.getSelectClsEl(e).addClass("sds-desktop-icon-selected"),this.getEl().dom.setAttribute("aria-activedescendant",e.el.dom.id),this.activeIdx=t)},clearSelectCls:function(){var t=this.module.iconItems[this.activeIdx];t&&this.getSelectClsEl(t).removeClass("sds-desktop-icon-selected")},getSelectClsEl:function(t){var e=t.el,i=t.el.child(".launch-icon");return i&&(e=i),e}}),Ext.define("SYNO.SDS.DesktopHotKeyPlugin",{extend:"Ext.util.Observable",init:function(t){this.initHotkeyEvents(),Ext.getBody().on("keydown",this.onKeyPress,this);var e=SYNO.SDS.UserSettings.getProperty("Desktop","hotkey_disabled");this.hotkeyEnabled=e===!0?!1:!0},setHotkeyEnabled:function(t){this.hotkeyEnabled=t,SYNO.SDS.UserSettings.setProperty("Desktop","hotkey_disabled",!t)},setHotkeySuspended:function(t){this.hotkeySuspended=t},initHotkeyEvents:function(){this.Alt_FnMap={87:this.onSwitchWindow,83:this.onFocusDesktop,81:this.onToggleAllWin,72:this.onLaunchHelp,65:this.onMainMenu},this.Ctrl_FnMap={70:this.onSearch}},onKeyPress:function(t){var e=t.getKey(),i="text"===document.activeElement.type||"textarea"===document.activeElement.type||"password"===document.activeElement.type,n=t.shiftKey&&191==e;i||this.hotkeySuspended||this.hotkeyEnabled===!1||(n?(t.preventDefault(),this.showTips(t)):t.altKey&&e in this.Alt_FnMap?(t.preventDefault(),this.Alt_FnMap[e]()):t.ctrlKey&&e in this.Ctrl_FnMap&&(t.preventDefault(),this.Ctrl_FnMap[e](t)))},onSwitchWindow:function(){SYNO.SDS.TaskButtons.setNextItem(),SYNO.SDS.TaskButtons.bringFocusWinUp()},onFocusDesktop:function(){Ext.get("sds-desktop-shortcut").focus()},onToggleAllWin:function(){SYNO.SDS.WindowMgr.toggleAllWin()},onMainMenu:function(){var t=SYNO.SDS.DeskTopManager.isDesktopOnTop()?SYNO.SDS.AppView:SYNO.SDS.Desktop;SYNO.SDS.DeskTopManager.bringToFront(t)},onLaunchHelp:function(){var t=SYNO.SDS.WindowMgr.getActiveAppWindow();t&&t.onClickHelp()},onSearch:function(){SYNO.SDS.SearchBox.toggleBox()},showTips:function(t){SYNO.SDS.AppLaunch("SYNO.SDS.HotkeyMgr.Instance",{target:t.target},!1)}}),Ext.namespace("SYNO.SDS"),Ext.define("SYNO.SDS.DesktopSetting",{statics:{miniHeight:580,miniWidth:1e3}}),SYNO.SDS.ShortcutUtil={allowedCfgProperty:["jsID","className","param","title","formatedTitle","desc","icon","type","url","urlDefMode","urlTag","urlTarget","launchParams","subItems","icon_16","icon_32","allowStandalone","port","protocol","windowLaunchEncodeFn","windowLaunchDecodeFn"],getCfgPropertis:function(){return this.allowedCfgProperty.join(",")}},SYNO.SDS._StandaloneDesktop=Ext.extend(Ext.BoxComponent,{constructor:function(){SYNO.SDS._StandaloneDesktop.superclass.constructor.call(this,{id:"sds-desktop",style:"background: transparent; top: 0px; background-size: 100% 100%;",renderTo:document.body}),this.onWindowResize(),Ext.EventManager.onWindowResize(this.onWindowResize,this)},onWindowResize:function(){this.el.setHeight(Ext.lib.Dom.getViewHeight());var t=this.el.getBox();this.el.setStyle({"overflow-x":t.width<=SYNO.SDS.DesktopSetting.miniWidth?"auto":"hidden","overflow-y":t.height<=SYNO.SDS.DesktopSetting.miniHeight?"auto":"hidden"})}}),Ext.define("SYNO.SDS._Desktop",{extend:"SYNO.SDS.Box_DesktopView",defShortCuts:SYNO.SDS.isNVR?[{className:"SYNO.SDS.PkgManApp.Instance"},{className:"SYNO.SDS.AdminCenter.Application"},{className:"SYNO.SDS.App.FileStation3.Instance"},{className:"SYNO.SDS.HelpBrowser.Application"},{className:"SYNO.SDS.SurveillanceStation"}]:[{className:"SYNO.SDS.PkgManApp.Instance"},{className:"SYNO.SDS.AdminCenter.Application"},{className:"SYNO.SDS.App.FileStation3.Instance"},{className:"SYNO.SDS.HelpBrowser.Application"}],DROP_ALLOWED_CLS:"x-dd-drop-ok-add",DROP_DENIED_CLS:"x-dd-drop-nodrop",REPOSITION_OK_CLS:"x-dd-reposition-ok",CURSOR_OVER_TYPE:{ABOVE_ICON:0,OVER_ICON:1,BELOW_ICON:2},items:null,iconItems:null,updateTask:null,updateDelay:200,bgPosition:"fill",bgRatio:1,previewCounter:0,ICON_WIDTH:136,ICON_HEIGHT:116,isBeta:!1,opacityHideCls:"sds-desktop-hide",isItemUpdated:!1,constructor:function(){var t=this;this.allowedCfgProperty=SYNO.SDS.ShortcutUtil.getCfgPropertis(),this.hotkeyPlugin=new SYNO.SDS.DesktopHotKeyPlugin({module:this}),SYNO.SDS._Desktop.superclass.constructor.call(this,{id:"sds-desktop",taskBarConfig:{handler:this.onShowAll.createDelegate(this),tooltip:_T("desktop","show_desktop"),renderTo:"sds-taskbar-showall"},plugins:[this.hotkeyPlugin],hidden:!1,renderTo:document.body}),this.items=[],this.iconItems=[],this.updateTask=new Ext.util.DelayedTask(this.updateItems,this),this.shortcutPanel=new SYNO.SDS.DesktopShortcutPanel({renderTo:"sds-desktop",module:this}),this.mon(this.el,"scroll",function(t){var e=this.el.getBox();return this.el.dom.scrollTop>0&&e.height>=SYNO.SDS.DesktopSetting.miniHeight&&(this.el.dom.scrollTop=-100),t.preventDefault(),!1},this),this.mon(Ext.getBody(),"scroll",function(t,e,i){return e.scrollTop>0&&(e.scrollTop=0),t.preventDefault(),!1},this),this.el.dragZone=new Ext.dd.DragZone(this.el,{ddGroup:"SDSShortCut",proxy:new SYNO.ux.StatusProxy({baseCls:"sds-launch-icon-dragging-proxy"}),validateTarget:function(t,e,i){var n=e.getTarget("li.launch-icon");return SYNO.SDS.Desktop.el.id===e.getTarget().id||n&&Ext.fly(n).findParentNode(".sds-desktop-shortcut")?!0:e.getTarget("#sds-sub-container")||e.getTarget("#sds-sub-container-shim")?!0:(this.getProxy().setStatus(this.dropNotAllowed),!1)},getDragData:this.getDragData.createDelegate(this,[],!0),getRepairXY:function(){return this.dragData.repairXY},endDrag:function(t){SYNO.SDS.Desktop.onEndDrag(this.dragData)},onStartDrag:function(e,i){var n=Ext.get(this.dragData.sourceEl).getBox(),s=SYNO.SDS.Desktop.getEl().getBox(),o=Ext.get(this.dragData.sourceEl);o.setVisibilityMode(Ext.Element.VISIBILITY),t.isInSelectState()||o.hide();var r=this.getProxy();r.getEl().disableShadow(),this.dragData.sourceEl.initPos=[e-o.getLeft(),i-o.getTop()+30],this.dragData.sourceEl.moving=!1,this.minX=s.x,this.minY=s.y,this.maxX=s.right-n.width,this.maxY=s.bottom-n.height,this.constrainX=!0,this.constrainY=!0;var a=Ext.get("sds-desktop"),l=a.dom.getElementsByTagName("iframe");Ext.each(l,function(t){var e=document.createElement("div");e.addClassName("sds-shim-for-iframe"),Ext.get(t.parentNode).appendChild(e)})}}),this.el.dropZone=new Ext.dd.DropZone(Ext.getBody(),{dropAllowed:"x-dd-drop-ok-add",ddGroup:"SDSShortCut",getTargetFromEvent:function(t){var e=t.getTarget("li.launch-icon");return e&&Ext.fly(e).findParentNode(".sds-desktop-shortcut")?e:null},onNodeOver:this.onNodeOver.createDelegate(this,[],!0),onContainerOver:this.onContainerOver.createDelegate(this,[],!0),onContainerDrop:this.onNotifyDrop.createDelegate(this,[],!0),onNodeDrop:this.onNodeDrop.createDelegate(this,[],!0)}),this.el.dropZone.addToGroup("AppReorderAndShortCut"),this.el.dropZone.addToGroup("AppShortCut"),this.onWindowResize(),Ext.EventManager.onWindowResize(this.onWindowResize,this),this.loadUserSettings(),this.mon(SYNO.SDS.StatusNotifier,"servicechanged",this.onServiceChanged,this),this.mon(SYNO.SDS.StatusNotifier,"appprivilegechanged",this.onServiceChanged,this),this.mon(SYNO.SDS.StatusNotifier,"urltagchanged",this.refresh,this),_S("isMobile")&&_S("is_admin")?this.addMobileEditionButton():t.isBeta&&this.addBetaBugReportButton(),this.el.on("mousedown",this.onDesktopMouseDown,this)},onEndDrag:function(t){var e=Ext.get(t._fromAppMenu?t.desktopSrcEl:t.sourceEl),i=SYNO.SDS.Desktop;i.isInSelectState()&&(Ext.removeNode(t.ddel),Ext.destroy(i.ddel)),e.show(),Ext.each(SYNO.SDS.Desktop.iconItems,function(t,e){t&&"SYNO.SDS.VirtualGroup"===t.className&&t.validTempNode()});var n=Ext.get("sds-desktop").query(".sds-shim-for-iframe");Ext.each(n,function(t){Ext.removeNode(t)}),this.el.focus()},setDesktopVisible:function(t){var e=Ext.get("sds-desktop");e.setVisibilityMode(Ext.Element.OFFSETS),this.bugReportButton&&this.bugReportButton.setVisible(t)},hide:function(){this.setDesktopVisible(!1),this.addClass(this.opacityHideCls),this.removeClass(this.showCls),Ext.isIE&&this.callParent()},show:function(){this.setDesktopVisible(!0),this.callParent(),this.removeClass(this.opacityHideCls),this.removeClass("semi-transparent"),this.removeClass("sent-back")},onShowAll:function(){this.showDesktop(),SYNO.SDS.WindowMgr.toggleAllWin(this.taskButton)},isInSelectState:function(){var t=!1;return Ext.each(this.iconItems,function(e){t||e&&e.isSelected()&&(t=!0)},this),t},getEvtXYWithScroll:function(t){return[t.xy[0]+this.el.dom.scrollLeft,t.xy[1]+this.el.dom.scrollTop]},onDesktopMouseDown:function(t,e,i){var n,s=this.el.getLeft(),o=this.getEvtXYWithScroll(t);o[0]>e.scrollWidth||o[1]>e.scrollHeight||t.target===this.el.dom&&(n=Ext.get(document.body),n.on("mousemove",this.onDesktopMouseMove,this),n.on("mouseup",this.onDesktopMouseUp,this),n.on("mouseleave",this.onDesktopMouseLeave,this,{delay:100}),this.el._beginDragPos=o,this._range&&this._range.remove(),this._range=this.el.createChild({tag:"div",cls:"sds-desktop-select-range"}),this._range.setPosition=function(t,e,i){this.setLeft(t[0]-s),this.setTop(t[1]-32),this.setWidth(e),this.setHeight(i)}.createDelegate(this._range),this._range.setPosition(o,0,0))},onDesktopMouseMove:function(t){if(this.el._beginDragPos&&t){var e=this.el._beginDragPos,i=this.getEvtXYWithScroll(t),n=i[0]-e[0],s=i[1]-e[1];i=[n>0?e[0]:i[0],s>0?e[1]:i[1]],n=Math.abs(n),s=Math.abs(s),this._range.setPosition(i,n,s),this.rangeDetectTask=new Ext.util.DelayedTask(this.detectOverlappedObjects,this),this.rangeDetectTask.delay(5)}},onDesktopMouseLeave:function(t){this.cancelRangeDetectTask(),this.endRangeDetect()},onDesktopMouseUp:function(t){this.cancelRangeDetectTask(),this.detectOverlappedObjects(),this.endRangeDetect()},cancelRangeDetectTask:function(){this.rangeDetectTask&&(this.rangeDetectTask.cancel(),this.rangeDetectTask=null)},endRangeDetect:function(){var t=Ext.get(document.body);this._range&&this._range.remove(),this._range=null,delete this.el._beginDragPos,t.un("mousemove",this.onDesktopMouseMove,this),t.un("mouseup",this.onDesktopMouseUp,this),t.un("mouseleave",this.onDesktopMouseLeave,this)},collisionDetect:function(t,e){var i,n;if(t&&e)return i=t.getRegion(),n=e.getRegion(),(i.left<n.right&&i.right>n.right||i.left<n.left&&i.right>n.left||i.left>n.left&&i.right<n.right)&&(i.top>n.top&&i.bottom<n.bottom||i.top<n.bottom&&i.bottom>n.bottom||i.bottom>n.top&&i.top<n.top)},detectOverlappedObjects:function(){var t=0;Ext.each(this.iconItems,function(e,i){e.subItems||(this.collisionDetect(e.li_el,this._range)?(this.selectItem(e,!0),t++):this.selectItem(e,!1))},this),0===t&&Ext.destroy(this.ddel)},selectItem:function(t,e){var i="sds-desktop-icon-selected";t&&t.li_el&&t.setSelected&&(t.setSelected(e),e?t.li_el.addClass(i):t.li_el.removeClass(i))},getCursorOverType:function(t,e){var i,n;return i=t[0]-e[0],n=t[1]-e[1],17>=n?this.CURSOR_OVER_TYPE.ABOVE_ICON:n>=80?this.CURSOR_OVER_TYPE.BELOW_ICON:this.CURSOR_OVER_TYPE.OVER_ICON},onContainerOver:function(t,e,i){return i.ddText&&t.getProxy().getGhost().update(i.ddText),e.getTarget("#sds-sub-container")?this.REPOSITION_OK_CLS:e.getTarget("#sds-taskbar")?this.DROP_DENIED_CLS:i._fromDesktop||i._fromAppMenu?this.REPOSITION_OK_CLS:this.DROP_ALLOWED_CLS},onNodeOver:function(t,e,i,n){return n._fromSubContainer||this.isSubContainerExist()?this.onSubNodeOver(t,e,i,n):n._fromDesktop||n._fromAppMenu?this.onDesktopNodeOver(t,e,i,n):this.DROP_ALLOWED_CLS},onSubNodeOver:function(t,e,i,n){var s=i.xy,o=Ext.get(t).getXY(),r=[s[0]-o[0],s[1]-o[1]],a=null;this.appendSubItemMode?a=this.getItemFromSubTempNode():n._fromSubContainer?a=this.getItemFromSubNode(n.sourceEl):this._creatingVirtualGroup&&(a=this.getItemFromSubTempNode());var l=this.getItemFromSubNode(t),h=this.iconItems[l[0]];return this.isVirtualGroup(h)?(r[0]>40&&l[1]++,h.rePosition(a[1],l[1]),this.REPOSITION_OK_CLS):this.DROP_ALLOWED_CLS},onDesktopNodeOver:function(t,e,i,n){var s,o,r,a,l,h=this.getItemFromNode(t);return s=this.getItemFromNode(n._fromAppMenu?n.desktopSrcEl:n.sourceEl),0>s||0>h?void 0:(o=this.iconItems[s],r=this.iconItems[h],l=this.getCursorOverType(i.xy,Ext.get(t).getXY()),this.cancelDeferTask(),l===this.CURSOR_OVER_TYPE.OVER_ICON?this.nodeOverToGrouping(t,s,h,o,r):(l===this.CURSOR_OVER_TYPE.ABOVE_ICON?(a=this.rePosition.defer(100,this,[s,h]),this.setDeferTaskId(a)):(a=this.rePosition.defer(100,this,[s,h+1]),this.setDeferTaskId(a)),this.REPOSITION_OK_CLS))},rePosition:function(t,e){if(t!==e&&!this.isInSelectState()){var i=this.items[t],n=this.iconItems[t];this.items.splice(e,0,i),this.iconItems.splice(e,0,n),t>e&&t++,this.items.splice(t,1),this.iconItems.splice(t,1),this.updateItemsSetting(),this.refresh()}},isVirtualGroup:function(t){return t&&"SYNO.SDS.VirtualGroup"===t.className?!0:!1},nodeOverToGrouping:function(t,e,i,n,s){var o,r=this.isVirtualGroup(n),a=this.isVirtualGroup(s);if(n&&s){if(n===s)return this.DROP_ALLOWED_CLS;if(this.isInSelectState())return s.isSelected()?void 0:this.DROP_ALLOWED_CLS;if(t&&a&&!r){var l=Ext.copyTo({},n.managerItemConfig?n.managerItemConfig:n,this.allowedCfgProperty);return o=this.deferTaskToShowFolder.defer(800,this,[i,l]),this.setDeferTaskId(o),this.DROP_ALLOWED_CLS}return!t||a||r?void 0:(o=this.deferCreateVirtualGroup.defer(800,this,[e,i,n,s]),this.setDeferTaskId(o),this.DROP_ALLOWED_CLS)}},deferCreateVirtualGroup:function(t,e,i,n){var s,o;this.backupNode={src:{index:t,item:this.items[t]},dst:{index:e,item:this.items[e]}},this.setOldDstItem(n),n.li_el.hide(),s=this.createNewGroupIcon(e,n,!1),this._containerShown=!0,this._creatingVirtualGroup=!0,s.createSubContainer(),o=Ext.copyTo({},i.managerItemConfig?i.managerItemConfig:i,this.allowedCfgProperty),s.addSubItem(o),s.refresh()},getItemFromSubTempNode:function(){var t=[-1,-1];return Ext.each(this.iconItems,function(e,i){return t[1]>=0?!1:void Ext.each(e.iconItems,function(e,n){return e&&e.li_el._temp?(t[0]=i,t[1]=n,!1):void 0})}),t},getItemFromSubNode:function(t){var e=[-1,-1];return Ext.each(this.iconItems,function(i,n){return i?e[1]>=0?!1:void Ext.each(i.iconItems,function(i,s){return i&&t===i.dragEl.dom?(e[0]=n,e[1]=s,!1):void 0}):void 0}),e},updateItemsSetting:function(){SYNO.SDS.UserSettings.setProperty("Desktop","ShortcutItems",this.items)},deferTaskToShowFolder:function(t,e){var i=this.iconItems[t];i&&(i.createSubContainer(),e&&(this.appendSubItemMode=!0,i.addSubItem(e),i.refresh()),this._containerShown=!0)},addMobileEditionButton:function(){this.bugReportButton=this.el.createChild({tag:"div",id:"sds-mobile-edition",title:_T("common","mobile_edition")
}),this.mon(Ext.fly("sds-mobile-edition"),"click",function(){window.location="?forceDesktop=0"})},addBetaBugReportButton:function(){this.bugReportButton=this.el.createChild({tag:"div",id:"sds-bug-report-container",cn:[{tag:"div",id:"sds-bug-report",title:_T("pkgmgr","report_desc")}]}),this.mon(Ext.fly("sds-bug-report"),"click",function(){_S("is_admin")?SYNO.SDS.AppLaunch("SYNO.SDS.SupportForm.Application"):window.open("http://myds.synology.com/support/beta_dsm_form.php","_blank")})},onWindowResize:function(){this.el.setHeight(Ext.lib.Dom.getViewHeight()-SYNO.SDS.TaskBar.getHeight()),this.el.setWidth(Ext.lib.Dom.getViewWidth());var t=this.el.getBox();this.el.setStyle({"overflow-x":t.width<=SYNO.SDS.DesktopSetting.miniWidth?"auto":"hidden","overflow-y":t.height<=SYNO.SDS.DesktopSetting.miniHeight?"auto":"hidden"}),this.customizeWallpaper?"fill"===this.bgPosition?this.doFillWallpaper():"fit"===this.bgPosition&&this.doFitWallpaper():this.bigScreen&&this.doFillWallpaper(),this.refresh(),this.fireEvent("desktopresize",this)},doFillWallpaper:function(){var t=Ext.lib.Dom.getViewWidth(),e=Ext.lib.Dom.getViewHeight(),i=Ext.fly("sds-wallpaper");t>e*this.bgRatio?(i.setWidth(t),i.setHeight(t/this.bgRatio),i.setLeft(0),i.setTop((e-t/this.bgRatio)/2)):(i.setWidth(e*this.bgRatio),i.setHeight(e),i.setLeft((t-e*this.bgRatio)/2),i.setTop(0))},doFitWallpaper:function(){var t=Ext.lib.Dom.getViewWidth(),e=Ext.lib.Dom.getViewHeight(),i=Ext.fly("sds-wallpaper");t>e*this.bgRatio?(i.setWidth(e*this.bgRatio),i.setHeight(e),i.setLeft((t-e*this.bgRatio)/2),i.setTop(0)):(i.setWidth(t),i.setHeight(t/this.bgRatio),i.setLeft(0),i.setTop((e-t/this.bgRatio)/2))},getDragData:function(t){var e,i,n=this.getItemFromNode(t.getTarget("li.launch-icon"));if(n>=0){if(i=this.iconItems[n],!i)return;if(this.isInSelectState()){if(i.isSelected())return this.getDragDataInSelectState(n,t);this.deselectItems()}return e=i.dragEl.dom.cloneNode(!0),e.style.position="",e.style.left="",e.style.top="",e.id=Ext.id(),{_fromDesktop:!0,ddel:e,sourceEl:i.dragEl.dom,repairXY:i.dragEl.getXY(),SDSShortCut:i.managerItemConfig}}var s=this.getItemFromSubNode(t.getTarget("li.launch-icon")),o=this.iconItems[s[0]];if(o&&!(o&&o.iconItems&&o.iconItems.length<=0)&&(i=o.iconItems[s[1]]))return e=i.dragEl.dom.cloneNode(!0),e.style.position="",e.style.left="",e.style.top="",e.id=Ext.id(),{_fromDesktop:!1,_fromSubContainer:!0,ddel:e,sourceEl:i.dragEl.dom,repairXY:i.dragEl.getXY(),SDSShortCut:i.managerItemConfig}},getDragDataInSelectState:function(t,e){var i,n,s=[];return i=Ext.getBody().createChild({tag:"div",cls:"sds-desktop-dd-ct"}),Ext.destroy(this.ddel),this.ddel=i,Ext.each(this.iconItems,function(t){var e;t&&t.isSelected()&&(e=t.dragEl.dom.cloneNode(!0),e.id=Ext.id(),s.push(e),i.appendChild(e))},this),(n=this.iconItems[t])?(i=i.dom.cloneNode(!0),i.style.top="0px",i.id=Ext.id(),{_fromDesktop:!0,ddel:i,sourceEl:n.dragEl.dom,repairXY:n.dragEl.getXY(),SDSShortCut:n.managerItemConfig}):void 0},onNodeDropToInsertToGroup:function(t,e,i){var n=this.getItemFromNode(i._fromAppMenu?i.desktopSrcEl:i.sourceEl);n>=0?this.iconItems[n].remove():SYNO.Debug("Failed to get src node when insert to group"),this.appendSubItemMode=!1},onNotifyDrop:function(t,e,i){return!e.getTarget("#sds-sub-container")&&"sds-sub-container-shim"!==e.target.id||(this._creatingVirtualGroup&&(this.removeOldDstItem(),this.iconItems[this.backupNode.src.index].remove(),this.updateItemsSetting(),this.refresh(),this.backupNode=null,this._creatingVirtualGroup=!1),this.appendSubItemMode&&this.onNodeDropToInsertToGroup(t,e,i),"sds-sub-container-shim"===e.target.id)?this.onNodeDrop(null,t,e,i):!0},onNodeDropSelectedToInsertToGroup:function(t,e,i,n){var s,o=this.getItemFromNode(t),r=[];if(!(0>o)&&(s=this.iconItems[o],s&&!s.isSelected()))return this.isVirtualGroup(s)||(s=this.createNewGroupIcon(o,s,!0)),Ext.each(this.iconItems,function(t,e){var i,n;t&&t.isSelected()&&(n=this.items[e],i=Ext.copyTo({},n.managerItemConfig?n.managerItemConfig:n,this.allowedCfgProperty),s.addSubItem(i,!0),r.push(t))},this),Ext.each(r,function(t){t.remove()},this),s.blinkForAdd(),s.refreshElementIcons(),this.refresh(),!0},createNewGroupIcon:function(t,e,i){var n,s,o;if(!(0>e)&&e){n=Ext.copyTo({},e.managerItemConfig?e.managerItemConfig:e,this.allowedCfgProperty),s={className:"SYNO.SDS.VirtualGroup",title:"New Group",subItems:[n]},o=this.iconItems[t],this.items[t]=s;var r={x:o.li_el.dom.style.left,y:o.li_el.dom.style.top},a=new SYNO.SDS.LaunchItem(Ext.apply({},{manager:this,removable:!0,module:this,index:t},s),this.shortcutPanel.getEl());return a.li_el.setLeft(r.x),a.li_el.setTop(r.y),a.li_el.addClass.defer(500,a.li_el,["transition-cls"]),this.iconItems[t]=a,a.managerItemConfig=this.items[t],i===!0&&o.remove(),a}},onNodeDrop:function(t,e,i,n){var s,o,r,a=-1,l=n.SDSShortCut;if(this.isInSelectState())return this.onNodeDropSelectedToInsertToGroup(t,e,i,n);if(!n._fromFile&&(!l||!l.className)||t&&t===n.sourceEl)return!1;if(t&&(a=this.getItemFromNode(t)),this.cancelDeferTask(),n._fromSubContainer&&"sds-sub-container-shim"===i.target.id){var h=this.getItemFromSubNode(n.sourceEl),c=this.iconItems[h[0]].iconItems[h[1]];c&&c.remove(),this.addLaunchItem(n.SDSShortCut,-1)}else{if(n._fromSubContainer&&i.getTarget("#sds-sub-container")){var d=this.getItemFromSubNode(t),S=this.getItemFromSubNode(n.sourceEl),u=this.iconItems[d[0]];return u.iconItems[d[1]].li_el.show(),u.iconItems[S[1]].li_el.show(),!0}if((n._fromDesktop||n._fromAppMenu)&&i.getTarget("#sds-sub-container"))return this.onNotifyDrop(e,i,n);if(n._fromFile){var g=i.getTarget();g&&Ext.fly(g).findParentNode("div.syno-sds-fs-win",Number.MAX_VALUE)||(s=this.isNodeDropOnIcon(t,e,i,n),s?this.isVirtualGroup(s)?Ext.isArray(n.SDSShortCut)&&(Ext.each(n.SDSShortCut,function(t){var e=Ext.copyTo({},t.config,this.allowedCfgProperty);s.addSubItem(e,!0)},this),s.blinkForAdd(),s.refreshElementIcons()):Ext.isArray(n.SDSShortCut)&&(r=this.createNewGroupIcon(a,s,!0),Ext.each(n.SDSShortCut,function(t){var e=Ext.copyTo({},t.config,this.allowedCfgProperty);r.addSubItem(e,!0)},this),r.blinkForAdd(),r.refreshElementIcons()):this.addLaunchItems(l,a))}else if(n.SDSShortCut&&(n._fromControlPanel||n._fromDesktop||n._fromAppMenu)){s=this.isNodeDropOnIcon(t,e,i,n);var p;if(n._fromDesktop||n._fromAppMenu){var m=this.getItemFromNode(n._fromAppMenu?n.desktopSrcEl:n.sourceEl);p=this.iconItems[m]}s?this.isVirtualGroup(p)||(this.isVirtualGroup(s)?(o=Ext.copyTo({},n.SDSShortCut,this.allowedCfgProperty),s=this.iconItems[a],s.addSubItem(o,!0),s.blinkForAdd(),s.refreshElementIcons(),(n._fromDesktop||n._fromAppMenu)&&p&&p.remove()):p!==s&&(o=Ext.copyTo({},n.SDSShortCut,this.allowedCfgProperty),r=this.createNewGroupIcon(a,s,!0),r.addSubItem(o,!0),r.blinkForAdd(),r.refreshElementIcons(),(n._fromDesktop||n._fromAppMenu)&&p&&p.remove(),this.refresh())):n._fromControlPanel&&this.addLaunchItem(n.SDSShortCut,a)}}return!0},isNodeDropOnIcon:function(t,e,i,n){var s,o,r=-1;return t&&(r=this.getItemFromNode(t),s=this.getCursorOverType(i.xy,Ext.get(t).getXY())),r>=0&&s===this.CURSOR_OVER_TYPE.OVER_ICON?o=this.iconItems[r]:!1},getItemFromNode:function(t){var e=-1;if(t)return Ext.each(this.iconItems,function(i,n){return i&&t===i.dragEl.dom?(e=n,!1):void 0}),e},validateItems:function(){var t=[],e=[];Ext.each(this.items,function(e,i){var n=e.className||e.jsID;if(!_S("ha_safemode")||-1!=n.search("SYNO.SDS.HA")||-1!=n.search("SYNO.SDS.SupportForm")||-1!=n.search("SYNO.SDS.App.FileStation3"))return this.isVirtualGroup(e)?void t.push(e):void(SYNO.SDS.Config.FnMap[n]&&!this.isHiddenControlPanelModule(n,e)&&(e.needHide=!SYNO.SDS.StatusNotifier.isAppEnabled(n),t.push(e)))},this),this.items.length!==t.length&&(this.items=t,SYNO.SDS.UserSettings.setProperty("Desktop","ShortcutItems",this.items),Ext.each(this.iconItems,function(t){-1===this.items.indexOf(t.managerItemConfig)&&e.push(t)},this),Ext.each(e,function(t){t.remove()},this)),Ext.each(this.iconItems,function(t){this.isVirtualGroup(t)&&t.validateItems()},this)},loadUserSettings:function(){var t=SYNO.SDS.UserSettings.getProperty("Desktop","ShortcutItems")||this.defShortCuts;t=this.removeDeprecatedShortcutItems(t),this.updateBackground(),Ext.each(t,function(t){this.addLaunchItem(t,-1,!0)},this),this.updateTextColor()},upgradeWallpaperConfig:function(t){var e=t.customize_wallpaper,i=t.wallpaper_path&&0<=t.wallpaper_path.indexOf("webman/resources/images/default_wallpaper");return e&&i&&(t.customize_wallpaper=!1,t.customize_color=!1),t.version="v5",SYNO.SDS.UserSettings.setProperty("Desktop","wallpaper",t),t},getDefaultWallpaper:function(){var t=SYNO.SDS.UIFeatures.IconSizeManager.getRetinaAndSynohdpackStatus(),e="business"===_S("theme_cls"),i=String.format("webman/resources/images/default/{0}/default_wallpaper/dsm6_{1}.jpg?v={2}",t?"2x":"1x",e?"02":"01",_S("version"));return i},setWallpaperSrcPath:function(t){var e;e=Ext.fly("sds-wallpaper"),e.dom.src="",e.dom.src=t},updateBackground:function(t){var e,i,n=Ext.apply({},SYNO.SDS.UserSettings.getProperty("Desktop","wallpaper")||{}),s=!1,o=_S("welcome_hide")||!("admin"==_S("user")&&_S("is_admin"))||_S("demo_mode")===!0,r={backgroundColor:"transparent",backgroundPosition:"center center",backgroundRepeat:"no-repeat",backgroundImage:this.getDefaultWallpaper()};"v5"!=n.version&&(n=this.upgradeWallpaperConfig(n)),t&&(Ext.apply(n,t,{customize_color:!1,customize_wallpaper:!1}),this.previewCounter++),n.customize_color&&(r.backgroundColor=n.background_color||"#FFFFFF",r.backgroundImage=""),n.customize_wallpaper?(this.customizeWallpaper=!0,this.bgPosition=n.wallpaper_position||"fill",i=Ext.fly("sds-wallpaper"),i.hide(),e=n.newImage?n.wallpaper_path?Ext.urlAppend("webapi/entry.cgi",Ext.urlEncode({api:"SYNO.Core.PersonalSettings",method:"wallpaper",version:1,path:Ext.encode(SYNO.SDS.Utils.bin2hex(n.wallpaper_path)),retina:SYNO.SDS.UIFeatures.IconSizeManager.getRetinaAndSynohdpackStatus(),id:n.wallpaper})):"":Ext.urlAppend("webapi/entry.cgi",Ext.urlEncode({api:"SYNO.Core.PersonalSettings",method:"wallpaper",version:1,retina:SYNO.SDS.UIFeatures.IconSizeManager.getRetinaAndSynohdpackStatus(),id:n.wallpaper})),"center"===this.bgPosition?r.backgroundImage=e:"tile"===this.bgPosition?(r.backgroundPosition="left top",r.backgroundRepeat="repeat",r.backgroundImage=e):(r.backgroundImage="",i.applyStyles({top:"auto",left:"auto",right:"auto",height:"auto"}),"stretch"===this.bgPosition?(i.applyStyles({top:0,left:0,width:"100%",height:"100%"}),e&&o&&i.show()):"fill"===this.bgPosition?i.on("load",function(t,n){this.bgRatio=Ext.fly("sds-wallpaper").getWidth()/Ext.fly("sds-wallpaper").getHeight(),this.doFillWallpaper(),e&&o&&i.show()},this,{single:!0}):"fit"===this.bgPosition&&i.on("load",function(t,n){this.bgRatio=Ext.fly("sds-wallpaper").getWidth()/Ext.fly("sds-wallpaper").getHeight(),this.doFitWallpaper(),e&&o&&i.show()},this,{single:!0}),e&&this.setWallpaperSrcPath(e))):(this.customizeWallpaper=!1,window.screen.width>1920||window.screen.height>1200?(this.bigScreen=!0,i=Ext.fly("sds-wallpaper"),i.hide(),e=r.backgroundImage,r.backgroundImage="",i.applyStyles({top:"auto",left:"auto",right:"auto",height:"auto"}),i.on("load",function(t,n){this.bgRatio=Ext.fly("sds-wallpaper").getWidth()/Ext.fly("sds-wallpaper").getHeight(),this.doFillWallpaper(),e&&o&&i.show()},this,{single:!0}),e&&this.setWallpaperSrcPath(e)):(this.bigScreen=!1,s=!0,Ext.fly("sds-wallpaper").hide())),r.backgroundImage?(document.body.style.background=String.format("{0} url({1}) {2} {3}",r.backgroundColor,r.backgroundImage,r.backgroundRepeat,r.backgroundPosition),_S("isMobile")&&s&&(document.body.style.webkitBackgroundSize="cover")):document.body.style.background=String.format("{0} {1} {2}",r.backgroundColor,r.backgroundRepeat,r.backgroundPosition)},updateTextColor:function(t){var e=Ext.apply({},SYNO.SDS.UserSettings.getProperty("Desktop","wallpaper")||{}),i="#FFFFFF";t&&Ext.apply(e,t,{customize_color:!1,customize_wallpaper:!1}),e.customize_color&&(i=e.text_color||"#FFFFFF"),!Ext.isIE9p&&Ext.isIE?(Ext.util.CSS.updateRule("#sds-desktop li.launch-icon .text","color",i),Ext.util.CSS.updateRule("#sds-desktop li.launch-icon .text a","color",i)):Ext.util.CSS.updateRule("#sds-desktop li.launch-icon .text, #sds-desktop li.launch-icon .text a","color",i)},onServiceChanged:function(t,e){for(var i=0;i<this.iconItems.length;i++)this.iconItems[i].className===t&&this.refresh()},addLaunchItemCfg:function(t,e,i){var n=Ext.copyTo({},t,this.allowedCfgProperty);Ext.isNumber(e)&&e>=0?this.items.splice(e,0,n):this.items.push(n),!0!==i&&SYNO.SDS.UserSettings.setProperty("Desktop","ShortcutItems",this.items)},addLaunchItem:function(t,e,i){this.addLaunchItemCfg(t,e,i),this.refresh()},addLaunchItems:function(t,e){Ext.each(t,function(t){this.addLaunchItemCfg(t.config,e||t.pos,t.skipRegister)},this),this.refresh()},addHiddenLaunchItem:function(t,e){var i=Ext.copyTo({},t,this.allowedCfgProperty),n=this.items.push(i)-1;this.refresh(),this.updateItems();var s=this.iconItems[n];return s.el.hide(),SYNO.SDS.UserSettings.setProperty("Desktop","ShortcutItems",this.items),n},removeLaunchItem:function(t){t.managerItemConfig&&(this.iconItems.remove(t),this.items.remove(t.managerItemConfig),SYNO.SDS.UserSettings.setProperty("Desktop","ShortcutItems",this.items),this.refresh())},showHideItems:function(t){this.showIcon=t,Ext.each(this.iconItems,function(e,i){t===!0?e.el.show():e.el.hide()},this)},refresh:function(){this.updateTask.delay(this.updateDelay)},updateItems:function(){var t,e,i=0,n=0,s=this.iconItems.length<=0;this.validateItems(),t=this.shortcutPanel.getEl();var o=0,r=this.ICON_WIDTH,a=this.ICON_HEIGHT;Ext.each(this.items,function(l){var h=o*r,c=n*a,d=!1;return s||(e=this.iconItems[i],e&&e.managerItemConfig!==l&&(e=null)),!s&&e&&e.li_el||(e=new SYNO.SDS.LaunchItem(Ext.apply({},{manager:this,removable:!0,module:this,index:i},l),t),e.param&&e.el.addClass("hide-overflow"),this.iconItems.splice(i,0,e),e.managerItemConfig=l,d=!0),e.el.setVisible(!l.needHide),l.needHide?void++i:(c+a>Ext.get("sds-desktop").getHeight()&&(n=0,o++,h=o*r,c=n*a),++i,++n,void this.animShortcutNode(e.li_el,h,c,!d))},this),this.el.getBox().width<this.getTotalIconWidth()&&(this.el.setStyle({"overflow-x":"scroll"}),this.fireEvent("desktopresize",this)),this.isItemUpdated=!0,this.fireEvent("desktopupdated")},animShortcutNode:function(t,e,i,n){if(t&&t.dom)if(Ext.isIE&&!t.dom.moving){var s=t.getLeft(),o=t.getTop();if(s===e&&o===i)return;n?t.shift({left:e,top:i,easing:"easeOut",duration:.5}):t.setLeftTop(e,i)}else t.dom.moving||(n||t.removeClass("transition-cls"),t.setStyle("left",e+"px"),t.setStyle("top",i+"px"),t.addClass.defer(100,t,["transition-cls"]))},isHiddenControlPanelModule:function(t,e){if("SYNO.SDS.ControlPanel.Instance"===t)return!0;if(!e.param||!e.param.fn)return!1;var i=e.param.fn;return Ext.isDefined(SYNO.SDS.AppPrivilege[i])&&!1===SYNO.SDS.AppPrivilege[i]?!0:!1},msgBox:null,getMsgBox:function(){return(!this.msgBox||this.msgBox.isDestroyed)&&(this.msgBox=new SYNO.SDS.MessageBoxV5({modal:!0,draggable:!1,renderTo:document.body})),this.msgBox.getWrapper()},removeDeprecatedShortcutItems:function(t){var e=[],i=function(t){if(t.className){for(var e=["SYNO.SDS.LogViewer.Application","SYNO.SDS.App.WelcomeApp.Instance","SYNO.SDS.SystemInfoApp.Application","SYNO.SDS.ControlPanel.Instance","SYNO.SDS.Tutorial.Application"],i=0;i<e.length;i++){if(e[i]==t.className)return!0;if("SYNO.SDS.VirtualGroup"==t.className)for(var n=t.subItems,s=n.length-1;s>=0;s--)e[i]==n[s].className&&t.subItems.splice(s,1)}return!1}},n=function(t){var e=["SYNO.SDS.AdminCenter.WebServices.Main"];return"SYNO.SDS.AdminCenter.Application"===t.className&&t.param&&t.param.fn&&-1!==e.indexOf(t.param.fn)?!0:!1};return Ext.each(t,function(t){i(t)||n(t)||e.push(t)},this),e},isSubContainerExist:function(){return!!Ext.getDom("sds-sub-container")},setDeferTaskId:function(t){this._deferTaskId=t},getDeferTaskId:function(){return this._deferTaskId},cancelDeferTask:function(){var t=this.getDeferTaskId();t>0&&(window.clearTimeout(t),this.setDeferTaskId(0))},getSelectedItems:function(){var t=[];return Ext.each(this.iconItems,function(e){e&&e.isSelected()&&t.push(e)},this),t},removeSelectedItems:function(){Ext.each(this.getSelectedItems(),function(t){t.setSelected(!1),t.remove()},this)},deselectItems:function(){Ext.each(this.getSelectedItems(),function(t){this.selectItem(t,!1)},this)},setOldDstItem:function(t){this._oldDstItem&&this._oldDstItem.remove(),this._oldDstItem=t},removeOldDstItem:function(t){this._oldDstItem&&this._oldDstItem.remove(),this._oldDstItem=null},getTotalIconWidth:function(){var t=Ext.get("sds-desktop").getHeight(),e=Math.floor(t/this.ICON_HEIGHT),i=10+this.ICON_WIDTH*Math.ceil(this.items.length/e);return i}}),Ext.define("SYNO.SDS.Classical._Desktop",{extend:"SYNO.SDS._Desktop",ICON_HEIGHT:100,getCursorOverType:function(t,e){var i,n;return i=t[0]-e[0],n=t[1]-e[1],17>=n?this.CURSOR_OVER_TYPE.ABOVE_ICON:n>=64?this.CURSOR_OVER_TYPE.BELOW_ICON:this.CURSOR_OVER_TYPE.OVER_ICON}}),Ext.define("SYNO.SDS._NewShortcutZone",{extend:"Ext.Container",isDropped:!1,constructor:function(t){this.zoneId=Ext.id(),this.addIconId=Ext.id(),this.type=t.type,this.parentView=t.parentView,this.slideDirection="right"===this.type?"r":"l";var e={cls:"syno-sds-shortcut-zone-wrapper",width:t.width,height:t.height,items:[new Ext.Container({cls:"syno-sds-shortcut-zone "+t.type,id:this.zoneId,autoEl:{cn:[{tag:"div",cls:"add-icon",id:this.addIconId}]},listeners:{afterrender:this.defineFields,scope:this}})]};SYNO.SDS._NewShortcutZone.superclass.constructor.call(this,e)},defineFields:function(){this.zone=Ext.get(this.zoneId),this.addIcon=Ext.get(this.addIconId),this.el.on("mouseenter",this.onMouseEnter,this),this.el.on("mouseleave",this.onMouseLeave,this)},onMouseEnter:function(){this.isDragging&&this.runTask("showDesktop",this.gotoDesktop,500)},onMouseLeave:function(){this.isDragging&&this.removeDelayedTask("showDesktop")},gotoDesktop:function(){this.parentView.fireEvent("gotoDesktop"),this.parentView.showDesktop()},resize:function(t,e){this.setSize({width:t,height:e})},onStartDrag:function(){this.addClass("on-mouse-drag"),this.isDropped=!1,this.isDragging=!0},onEndDrag:function(){this.isDragging=!1,this.removeDelayedTask("showDesktop"),this.isDropped?Ext.defer(this.animateDropped,100,this):this.removeClass("on-mouse-drag")},resetProperties:function(){this.addIcon.hide(),this.addIcon.removeClass("bounce-effect-fast"),this.removeClass("on-dropped"),this.removeClass("on-mouse-drag")},animateDropped:function(){this.addIcon.setXY(this.dropPos),this.addIcon.show(),this.addClass("on-dropped"),this.addIcon.addClass("bounce-effect-fast"),Ext.defer(function(){this.resetProperties()},1e3,this)}}),Ext.define("SYNO.SDS.LoginStyleParser",{extend:"Ext.util.Observable",constructor:function(t){this.isPreview=t.isPreview,this.isBusiness=t.isBusiness,this.parseAppPortalName(),this.parseTpl(),this.callParent()},getParam:function(t){var e;return e=this.isPreview&&window.opener&&window.opener.previewParam?Ext.util.Format.htmlEncode(window.opener.previewParam[t]):_S(t)},parseAppPortalName:function(){var t=_S("preview_appName")||_S("appName");this.appName=t?t+"_":""},parseTpl:function(){var t=this.getParam("login_style");this.tpl="dark"===t?"dark":"light"},getLoginConfig:function(){var t={tplName:this.tpl,preview:this.isPreview};return Ext.apply(t,this.getTitleConf()),Ext.apply(t,this.getCustomizeLogoConf()),Ext.apply(t,this.getWelcomeMsgConf()),Ext.apply(t,this.getBkgConf()),Ext.apply(t,this.getVersionLogoConf()),t},getBkgConf:function(){var t=this.getRawBkgConf(),e=t.background_enable,i=t.only_bgcolor;return e?this.isPreview&&this.getParam("new_background")?t.background_path=this.getEncodedPathUrl(this.getParam("login_background_path")):t.background_path=this.getBuiltInPath(t):i?t.background_path=Ext.BLANK_IMAGE_URL:t=this.getDefaultBkgConf(),t},getVersionLogoConf:function(){var t=this.getParam("login_version_logo");return{versionLogo:Ext.isDefined(t)?t:!0}},getRawBkgConf:function(){var t={background_enable:this.getParam("login_background_enable"),background_hd_enable:_S("login_background_hd_enable"),background_pos:this.getParam("login_background_pos")||"fill",only_bgcolor:this.getParam("login_only_bgcolor"),background_color:this.getParam("login_background_color")||"#FFFFFF",ext:_S("login_background_ext"),idx:_S("login_background_seq")};return t},getDefaultBkgConf:function(){var t,e=this.isRetina(),i=String.format("webman/resources/images/default/{0}/default_login_background/",e?"2x":"1x"),n={background_pos:"fill",background_path:i+"dsm6_02.jpg?v="+_S("version"),background_color:"#505050"},s={background_pos:"fill",background_path:i+"dsm6_01.jpg?v="+_S("version"),background_color:"#4c8fbf"};return t="dark"===this.tpl?n:s},isRetina:function(){return SYNO.SDS.UIFeatures.IconSizeManager.getRetinaAndSynohdpackStatus()},isBuiltInBkg2X:function(){var t="default"===this.getParam("login_background_type"),e=this.isRetina();return t&&e},getEncodedPathUrl:function(t){var e=new Date,i=Ext.urlAppend("webapi/entry.cgi",Ext.urlEncode({api:"SYNO.Core.PersonalSettings",method:"wallpaper",version:1,path:Ext.encode(SYNO.SDS.Utils.bin2hex(t)),preview:e.getTime()}));return i},getBuiltInPath:function(t){var e=this.isBuiltInBkg2X(),i=String.format("webman/{0}login_background{1}{2}?id={3}",this.appName,e?"_hd":"",t.ext,t.idx);return i},getTitleConf:function(){var t=this.getParam("custom_login_title"),e={login_title:t||_S("hostname")};return e},getCustomizeLogoConf:function(){var t={logo_enable:this.getParam("login_logo_enable")};return this.isPreview&&t.logo_enable&&this.getParam("new_logo")?t.logo_path=this.getEncodedPathUrl(this.getParam("login_logo_path")):t.logo_enable&&(t.logo_path="webman/"+this.appName+"login_logo"+_S("login_logo_ext")+"?id="+_S("login_logo_seq")),t},getWelcomeMsgConf:function(){var t={login_welcome_title:this.getParam("login_welcome_title"),login_welcome_msg:this.getParam("login_welcome_msg")},e={login_welcome_title:_T("login","default_welcome_title"),login_welcome_msg:_T("login","default_welcome_msg")},i={login_welcome_title:_T("login","default_welcome_title_business"),login_welcome_msg:_T("login","default_welcome_msg_business")},n=!0;return Ext.iterate(t,function(t,e){return Ext.isEmpty(e,!0)?(n=!1,!1):void 0}),n?t:this.isBusiness?i:e}}),SYNO.SDS.LoginDialog=Ext.extend(Ext.Container,{tplConfig:null,constructor:function(t){this.isAppPortal=_S("appIconPath")?!0:!1;var e=[];t=t||{},this.tplConfig=this.getTplConfig(t.preview),this.createBackground(),this.createWelcomeInfo(),this.createDialog(),e.push(this.backgound),e.push(this.blurLayer),this.welcomeInfo&&e.push(this.welcomeInfo),e.push(this.dialog),this.isAppPortal&&(this.createAppIcon(),e.push(this.appIcon));var i={id:"sds-login",cls:String.format("sds-login-{0} {1}",this.tplConfig.tplName,this.isAppPortal?"app-portal":""),renderTo:document.body,items:e,listeners:{afterrender:{fn:this.createOSLogo,scope:this}}};SYNO.SDS.LoginDialog.superclass.constructor.call(this,Ext.apply(i,t)),Ext.EventManager.onWindowResize(this.onWindowResize,this),this.el.applyStyles("background-color: "+this.tplConfig.background_color),this.onWindowResize(),t.preview||Ext.getDom("login_username")&&Ext.getDom("login_username").focus(),Ext.isSafari&&Ext.defer(this.onWindowResize,1e3,this)},createOSLogo:function(){if(this.tplConfig.versionLogo){var t="light"===this.tplConfig.tplName;this.osLogo=new SYNO.SDS.DSMLogo({id:"sds-login-logo",theme:t?"light":"dark",renderTo:Ext.get("sds-login")})}},createBackground:function(){this.backgound=SYNO.SDS.LoginUtils.createBackground(this.tplConfig,"sds-login-background"),this.blurBkg=new Ext.Container({id:"sds-blur-wrap",cls:"sds-blur-wrap",items:[SYNO.SDS.LoginUtils.createBackground(this.tplConfig,"sds-blur-bkg")]}),this.statusBlurBkg=new Ext.Container({id:"sds-status-blur-wrap",cls:"sds-blur-wrap",items:[SYNO.SDS.LoginUtils.createBackground(this.tplConfig,"sds-status-blur-bkg")]}),this.blurLayer=new Ext.Container({cls:"sds-blur-layer",items:[this.blurBkg,this.statusBlurBkg]})},createWelcomeInfo:function(){var t=""!==this.tplConfig.login_welcome_title||""!==this.tplConfig.login_welcome_msg,e=this.tplConfig.logo_enable;(t||e)&&(this.welcomeInfo=new SYNO.SDS.WelcomeInfo({logo_enable:this.tplConfig.logo_enable,logo_path:this.tplConfig.logo_path,login_welcome_title:this.tplConfig.login_welcome_title,login_welcome_msg:this.tplConfig.login_welcome_msg}))},createDialog:function(){var t=new Ext.Container({id:"sds-login-dialog-title",html:this.tplConfig.login_title});this.loginForm=this.newForm(),this.dialog=new Ext.Container({id:"sds-login-dialog",autoHeight:!0,module:this,items:[t,this.loginForm]})},createAppIcon:function(){this.appIcon=new Ext.Container({id:"sds-login-icon",autoEl:{tag:"img",src:SYNO.SDS.UIFeatures.IconSizeManager.getAppPortalIconPath(_S("appIconPath"))},style:String.format("width: {0}px",SYNO.SDS.UIFeatures.IconSizeManager.PortalIcon)})},newForm:function(){return new SYNO.SDS.LoginDialog.Form({module:this,tplConfig:this.tplConfig})},destroy:function(){Ext.EventManager.removeResizeListener(this.onWindowResize,this),SYNO.SDS.LoginDialog.superclass.destroy.apply(this,arguments)},onWindowResize:function(){var t=Ext.lib.Dom.getViewWidth(),e=Ext.lib.Dom.getViewHeight(),i=840,n=500,s=!1;i>t||n>e?(this.welcomeInfo&&this.welcomeInfo.hide(),s=!0):this.welcomeInfo&&this.welcomeInfo.show(),this.doAlignDialog(),this.backgound.resize(),this.welcomeInfo&&this.welcomeInfo.resize();var o=Ext.getCmp("sds-login-dialog-combobox");o&&o.isExpanded()&&o.list.alignTo(o.el,o.listAlign[0],o.listAlign[1]),this.updateDialogLayout()},updateDialogLayout:function(){this.loginForm&&(this.loginForm.updateFormBkg(),this.loginForm.updateStatusBkg()),this.doAlignAppIcon()},doAlignDialog:function(){var t=.45,e=Ext.lib.Dom.getViewHeight()*(t-.5);Ext.fly("sds-login-dialog").alignTo(document.body,"c-c",[0,-30+e]),Ext.defer(function(){Ext.fly("sds-login-dialog").alignTo(document.body,"c-c",[0,-30+e])},500,this)},doAlignAppIcon:function(){var t=Ext.get("login-inner-panel");this.appIcon&&t&&this.appIcon.el.alignTo(Ext.get("login-inner-panel"),"br-br",[16,16])},getTplConfig:function(t){var e=new SYNO.SDS.LoginStyleParser({isPreview:t===!0,isBusiness:SYNO.SDS.isBusinessModel});return e.getLoginConfig()}}),SYNO.SDS.LoginDialog.Form=Ext.extend(SYNO.ux.FormPanel,{btnLogin:null,iframe:null,constructor:function(t){Ext.fly("sds-login-dialog-form").dom.removeAttribute("style"),this.supportForgetPass=1===_S("login_enable_fp"),this.isAppPortal=_S("appIconPath")?!0:!1,this.isPreview=t.tplConfig.preview,this.createSSOcombobox(t.tplConfig.tplName),this.createInputFields(),this.createLoginBtn(),this.createLinks(),this.createStatus();var e=[this.userField,this.passField,this.otpField,this.rememberField,this.trustDeviceField,this.btnLogin,this.forgetPassUrl,this.lostPhoneUrl];this.isSupportSSO()&&e.unshift(this.ssoCombo),this.innerPanel=new SYNO.ux.Panel({id:"login-inner-panel",cls:"login-inner-panel",items:e});var i=this.supportForgetPass?"":"extra-padding",n={applyTo:"sds-login-dialog-form",cls:i,hideMode:"display",standardSubmit:!0,url:"webman/login.cgi",method:"POST",width:320,minHeight:260,unstyled:!0,autoFlexcroll:!1,useGradient:!1,listeners:{afterlayout:{scope:this,fn:this.onAfterLayout},afterrender:{scope:this,fn:this.onAfterRender,single:!0}},items:[this.innerPanel,this.statusField,{xtype:"hidden",name:"__cIpHeRtExT"},{xtype:"hidden",name:"isIframeLogin",value:"yes"},{xtype:"hidden",name:"enable_device_token"}]};SYNO.SDS.LoginDialog.Form.superclass.constructor.call(this,Ext.apply(n,t)),"no"!==_S("enable_syno_token")&&(this.form.url=Ext.urlAppend(this.form.url,"enable_syno_token="+_S("enable_syno_token")),this.form.el.dom.action=Ext.urlAppend(this.form.el.dom.action,"enable_syno_token="+_S("enable_syno_token")))},getUser:function(){return this.userField.getValue()},getPass:function(){return this.passField.getValue()},createInputFields:function(){this.userField=new SYNO.SDS.IconTextfield({el:"login_username",fieldLabel:_T("common","username"),iconCls:"user-icon"}),this.passField=new SYNO.SDS.IconTextfield({el:"login_passwd",fieldLabel:_T("common","password"),iconCls:"passwd-icon"}),this.otpField=new SYNO.SDS.IconTextfield({el:"login_otp",fieldLabel:_T("login","enter_otp_desc"),iconCls:"otp-icon",emptyText:_T("login","enter_otp_desc"),validator:function(t){var e=/^[0-9]{6}$/,i=/^[0-9]{8}$/;return e.exec(t)||i.exec(t)?!0:!1}}),this.rememberField=new SYNO.ux.Checkbox({id:"login_rememberme",name:"rememberme",width:296,hideLabel:!0,boxLabel:_T("login","rememberme"),disabled:!1}),this.trustDeviceField=new SYNO.ux.Checkbox({id:"login_trudtdevice",name:"trustdevice",width:296,boxLabel:_T("login","trustdevice"),disabled:!1})},createLinks:function(){this.lostPhoneUrl=new SYNO.ux.Button({id:"lost_phone",cls:"link",hidden:!0,text:_T("login","otp_lost_phone_desc"),scope:this,handler:this.lostPhone}),this.forgetPassUrl=new SYNO.ux.Button({id:"forget_pass",cls:"link",hidden:1!==_S("login_enable_fp"),text:_T("login","forget_pass_link"),scope:this,handler:this.onForgetPass})},createStatus:function(){this.statusField=new Ext.form.DisplayField({id:"sds-login-dialog-status",hideLabel:!0,hidden:!0,value:"",listeners:{afterrender:function(){this.el.setARIA({role:"log",live:"assertive"})},scope:this}})},createSSOcombobox:function(t){this.isSupportSSO()&&(this.ssoCombo=new SYNO.ux.ComboBox({xtype:"syno_combobox",width:320,id:"sds-login-dialog-combobox",listClass:"sds-login-"+t+" syno-ux-combobox-list sds-login-dialog-combobox-list",triggerClass:"sds-login-dialog-combobox-trigger",listAlign:["tl-bl?",[0,6]],forceSelection:!0,typeAhead:!0,triggerAction:"all",lazyRender:!0,allowBlank:!1,displayField:"display",valueField:"value",value:"local",hidden:!0,tpl:'<tpl for="."><div ext:qtip="{display}" class="x-combo-list-item">{display}</div></tpl>',store:new Ext.data.ArrayStore({fields:["value","display"],data:[["local",_T("sso","account_login")],["sso",_T("sso","sso_login")]]}),listeners:{scope:this,expand:function(t){t.list.setZIndex(19999)},select:function(t,e,i){this.onLoginTypeChange(e.get("value"))}}}))},createLoginBtn:function(t){this.btnLogin=new SYNO.ux.Button({xtype:"syno_button",btnStyle:"blue",text:_T("common","dsm_login"),id:"login-btn",width:280,height:40,scope:this,disabled:t,handler:this.onClickLogin})},onAfterLayout:function(){return this.initLayout?void 0:void(this.initLayout=!0)},updateFormBkg:function(){var t=Ext.getCmp("sds-blur-wrap"),e=Ext.getCmp("sds-blur-bkg");this.updateBlurBkg(e,t,this.innerPanel)},updateStatusBkg:function(){var t=Ext.getCmp("sds-status-blur-wrap"),e=Ext.getCmp("sds-status-blur-bkg");t.show(),this.updateBlurBkg(e,t,this.statusField)},updateBlurBkg:function(t,e,i){if(t.resize(),e){var n=i.getSize();e.setSize(n)}if(e.el){var s=i.getPosition();e.el.setStyle({marginLeft:s[0]+"px",marginTop:s[1]+"px"}),Ext.isGecko&&t.el.setStyle({left:-1*s[0]+"px",top:-1*s[1]+"px"})}},onAfterRender:function(){this.otpField.hide(),this.trustDeviceField.hide(),this.rememberField.setValue("1"===Ext.util.Cookies.get("stay_login")),this.form.el.dom.onsubmit=this.onSubmit.createDelegate(this),this.showLoginComboBox(),this.isPreview&&this.setFormDisabled(!0)},onForgetPass:function(){var t=this.module;t.el.fadeOut({callback:function(){t.destroy();var e=new SYNO.SDS.ForgotPassPage;e.el.fadeIn({duration:1})}})},setFormRemove:function(){this.userField.hide(),this.btnLogin.hide()},setFormDisabled:function(t,e){this.userField.setDisabled(t),this.passField.setDisabled(t),this.rememberField.setDisabled(t),this.forgetPassUrl.setDisabled(t),this.btnLogin.setDisabled(t),this.trustDeviceField.setDisabled(t),e&&(this.userField.setDisabled(!1),this.passField.setDisabled(!1))},initIFrameEvent:function(){var t=this;t.iframe||(t.iframe=Ext.get("login_iframe"),Ext.isIE?t.iframe.dom.onreadystatechange=function(){("complete"===this.readyState||"loaded"===this.readyState)&&t.onCallback()}:t.iframe.dom.onload=function(){t.onCallback()})},onClickLogin:function(){if(!1===this.onSSOLogin()){
Ext.getDom("login_submit").click();var t=this.ssoCombo;t&&(t.isExpanded()&&t.collapse(),t.setDisabled(!0))}},onSubmit:function(){return this.blShowOTPField&&!this.otpField.validate()?(this.setMsg(_T("login","otp_wrong_input_format")),!1):(Ext.getDom("login_submit").focus(),this.setFormDisabled(!0),this.setMsg(_T("common","msg_waiting")),SYNO.API.currentManager.requestAPI("SYNO.API.Encryption","getinfo",1,{format:"module"},this.onEncryptParams,this),!1)},stdTimezone:function(){var t=(new Date).getFullYear(),e=new Date(t,0,1),i=new Date(t,6,1);return e.getTimezoneOffset()>=i.getTimezoneOffset()?e.format("P"):i.format("P")},onEncryptParams:function(t,e,i){var n=this.form.findField("__cIpHeRtExT"),s="",o=this.form.findField("enable_device_token");t&&(SYNO.Encryption.CipherKey=e.cipherkey,SYNO.Encryption.RSAModulus=e.public_key,SYNO.Encryption.CipherToken=e.ciphertoken,SYNO.Encryption.TimeBias=e.server_time-Math.floor(+new Date/1e3));var r,a={};r={username:this.getUser(),passwd:this.getPass(),OTPcode:this.otpField.getValue(),rememberme:this.rememberField.getValue()?1:0,timezone:this.stdTimezone()},a=SYNO.Encryption.EncryptParam(r),s=a[e.cipherkey]||"",n.setValue(s),o.setValue(this.trustDeviceField.getValue()?"yes":"no");var l=new Date;l.setDate(l.getDate()+60),Ext.util.Cookies.set("stay_login",this.rememberField.getValue()?1:0,l);var h=""===s;this.initIFrameEvent(),this.setFormDisabled(!0,h),this.form.el.dom.submit()},launchOTPwizard:function(){var t=new SYNO.SDS.LoginStyleParser({isPreview:!1,isBusiness:"business"===_S("theme_cls")}),e=t.getDefaultBkgConf(),i=e.background_path,n=Ext.get("sds-login-background").dom.firstChild;n&&(n.style.display="none");var s;s=new SYNO.SDS.Background({id:"sds-steup-otp-background",renderTo:"sds-login-background",type:"fill",imgSrc:i,tplName:"tpl1"}),this.module.welcomeInfo&&(this.module.welcomeInfo.destroy(),this.module.welcomeInfo=null),this.module.blurLayer.hide();var o=Ext.get("sds-login-icon");o&&o.hide(),Ext.get("sds-login-dialog").hide();var r={module:this,username:this.getUser(),passwd:this.getPass(),isLDAP:this.isLDAP,modal:!1,draggable:!1,closable:!1,renderTo:"sds-login"};this.OTPwizard=new SYNO.SDS.EnforceOTPWizard(r),this.OTPwizard.onOpen()},onCallback:function(){var t,e,i,n=!1,s="";try{e=Ext.get(this.iframe.dom.contentWindow.document.body),i=e.first("#synology");var o=Ext.util.Format.htmlDecode(i.dom.innerHTML);if(t=Ext.decode(o),!0===t.success&&!0===t.setup_otp)this.isLDAP=t.is_ldap,this.launchOTPwizard();else if(!0===t.success)Ext.isEmpty(SYNO.SDS.Session)&&(SYNO.SDS.Session={}),Ext.isEmpty(t.SynoToken)||(SYNO.SDS.Session.SynoToken=encodeURIComponent(t.SynoToken)),n=!0,SYNO.SDS.initData(),this.setMsg(_T("common","loading")),this.iframe.dom.onload=Ext.emptyFn,this.iframe.dom.src="about:blank";else if(t.request_pwdchange)if(t.external_url){var r=Ext.urlAppend(t.external_url,Ext.urlEncode({callback_url:window.location.href}),!1);window.location.href=r}else{var a=this.module,l=this.getUser(),h=this.getPass(),c=window.location.pathname;a.el.fadeOut({callback:function(){a.destroy();var t=new SYNO.SDS.ChangeUserPassPage({username:l,passwd:h,path:c});t.el.fadeIn({duration:1})}})}else if(!0===t.request_otp)this.blShowOTPField=!0,this.clearMsg();else if(t.reason){if("error_otp_failed"!=t.reason){this.passField.setValue(""),this.passField.focus("",1);var d=Ext.getCmp("sds-login-dialog-combobox");d&&d.setDisabled(!1)}this.setError(_T("login",t.reason))}else this.setError(_T("common","error_system"))}catch(S){s=_T("common","error_system")}this.setFormDisabled(!1),this.blShowOTPField?this.showOTPField():n||"error_otp_failed"==t.reason||Ext.getDom("login_passwd").focus(),this.isSupportSSO()&&"login"===SYNOSSO.status&&!n&&SYNOSSO.logout(Ext.emptyFn)},showOTPField:function(){this.forgetPassUrl.hide(),this.userField.hide(),this.passField.hide(),this.otpField.show(),this.trustDeviceField.show(),this.rememberField.hide(),this.lostPhoneUrl.show(),this.otpField.focus(),this.hideLoginComboBox(),this.hideAppIcon(),this.updateFormBkg()},hideAppIcon:function(){this.isAppPortal&&(this.module.removeClass("app-portal"),this.module.appIcon.hide())},lostPhone:function(){this.sendWebAPI({api:"SYNO.Core.OTP.Mail",method:"send",version:1,params:{username:this.getUser()},scope:this,callback:function(t,e,i){var n=_T("login","unknown_otp_err");t?this.setMsg(_T("login","otp_mail_success")):this.setError(e.errors&&e.errors.err?_T("login",e.errors.err):n)}})},setError:function(t){this.statusField.addClass("error"),this.setStatus(t)},setMsg:function(t){this.statusField.removeClass("error"),this.setStatus(t)},clearMsg:function(){this.statusField.setValue(""),this.statusField.removeClass("error"),this.statusField.hide(),Ext.getCmp("sds-status-blur-wrap").hide()},setStatus:function(t){this.statusField.setValue(t),this.statusField.show(),this.updateStatusBkg(),this.module.doAlignAppIcon()},isSupportSSO:function(){return SYNO.SDS.SSOUtils.isSupport()},onLoginTypeChange:function(t){var e="local"===t,i=e&&this.supportForgetPass;this.userField.setVisible(e),this.passField.setVisible(e),this.forgetPassUrl.setVisible(i),i?this.el.removeClass("extra-padding"):this.el.addClass("extra-padding"),Ext.getCmp("login-btn").setText(e?_T("common","dsm_login"):_T("common","alt_next")),Ext.util.Cookies.set("login_type",t),this.module.updateDialogLayout()},showLoginComboBox:function(){if(this.isSupportSSO()){var t=this.ssoCombo;if(!t.isVisible()){var e=Ext.util.Cookies.get("login_type")||"local";!0===_S("sso_default_login")&&(e="sso"),t.setVisible(!0),t.setValue(e),this.onLoginTypeChange(e)}}},hideLoginComboBox:function(){if(this.isSupportSSO()){var t=this.ssoCombo;t.isVisible()&&"sso"!==t.getValue()&&t.setVisible(!1)}},onSSOLogin:function(){return this.isSupportSSO()&&"sso"===this.ssoCombo.getValue()?(SYNO.SDS.SSOUtils.login(this.onSSOCallback,this),!0):!1},onSSOCallback:function(t){"login"===t.status&&t.access_token&&40===t.access_token.length&&this.sendWebAPI({api:"SYNO.Core.Directory.SSO.utils",method:"exchange",version:1,params:{token:t.access_token},scope:this,callback:this.onGotSSOUsername})},onGotSSOUsername:function(t,e,i,n){if(!t)return void this.setError("SSO login fail");this.setMsg(_T("common","msg_waiting"));var s=this.passField,o=this.userField;s.hide(),o.hide(),s.setValue("SYNOSSOLOGIN"+i.token),o.setValue(e.user.replace("\\\\","\\")),Ext.getDom("login_submit").click();var r=Ext.getCmp("sds-login-dialog-combobox");r.isExpanded()&&r.collapse(),r.setDisabled(!0)}}),Ext.define("SYNO.SDS.IconTextfield",{extend:"Ext.Container",constructor:function(t){this.icon=new Ext.BoxComponent({cls:"icon "+(t.iconCls?t.iconCls:"")}),this.input=new Ext.form.TextField({cls:"textfield",el:t.el,inputType:t.inputType,fieldLabel:t.fieldLabel||null,emptyText:t.emptyText||null,validator:t.validator||null});var e={width:t.width,cls:String.format("sds-icon-text-field {0}",t.cls||""),items:[this.icon,this.input]};this.callParent([e])},getValue:function(){return this.input.getValue()},setValue:function(t){this.input.setValue(t)},setDisabled:function(t){this.input.setDisabled(t)},setEmptyText:function(t){this.input.emptyText=t,this.input.applyEmptyText()},focus:function(){this.input.focus(arguments)},validate:function(){return this.input.validate()}}),SYNO.SDS.LoginUtils={createBackground:function(t,e){var i=new SYNO.SDS.Background({id:e?e:Ext.id(),cls:"sds-login-background",type:t.background_pos,imgSrc:t.background_path,bgColor:t.background_color,tplName:t.tplName});return i}},Ext.namespace("SYNO.SDS.QuickConnect"),Ext.define("SYNO.SDS.QuickConnect.Main",{extend:"Ext.Component",DOMAIN:"QuickConnect.to",DOMAIN_PATTERN:/^.+[.]quickconnect[.]to$/,construtor:function(){this.callParent([{hidden:!0}])},TYPES:{NORMAL:"NORMAL",DIRECT:"DIRECT",TUNNEL:"TUNNEL"},SUB_DOMAIN_MAPPING:{NORMAL:"",DIRECT:"/direct/",TUNNEL:"/tunnel/"},aliasToPortalUrl:function(t){return this.generatePortalUrl(this.TYPES.NORMAL,t,this.DOMAIN)},getPortalUrl:function(t,e,i){if("undefined"==typeof this.SUB_DOMAIN_MAPPING[t])return!1;if("function"!=typeof e)return!1;if("undefined"==typeof this.callback_queue){this.callback_queue=[];var n={api:"SYNO.Core.QuickConnect",method:"get",version:1,scope:this,callback:this.processReturnData};this.sendWebAPI(n)}return this.callback_queue.push({callback:e,scope:i,type:t}),!0},isInTunnel:function(){return this.DOMAIN_PATTERN.test(window.location.hostname.toLowerCase())},processReturnData:function(t,e,i){for(var n=t&&"undefined"!=typeof e.server_alias&&"undefined"!=typeof e.region&&"undefined"!=typeof e.enabled&&e.enabled===!0,s=0;s<this.callback_queue.length;++s){var o="",r=this.callback_queue[s].callback,a=this.callback_queue[s].scope;if(n){var l=this.callback_queue[s].type;o=this.generatePortalUrl(l,e.server_alias,this.DOMAIN,e.region)}else o="undefined"==typeof e.error||"undefined"==typeof e.error.code?"":e.error.code;r.apply(a,[n,o])}delete this.callback_queue},generatePortalUrl:function(t,e,i,n){var s=this.SUB_DOMAIN_MAPPING[t],o=t==this.TYPES.NORMAL,r=o?"http":"https";return o?r+"://"+i+"/"+e:r+"://"+e+"."+n+"."+i+s}}),SYNO.SDS.QuickConnect.Utils=new SYNO.SDS.QuickConnect.Main,Ext.define("SYNO.SDS.Sharing.ErrorDialog",{extend:"SYNO.ux.Panel",constructor:function(t){var e={renderTo:document.body,cls:"syno-sds-sharing-errordialog",height:112,floating:!0,shadow:!1,items:[{type:"box",cls:"sharing-error-icon"},{type:"box",cls:"sharing-error-msg",html:t.errorMsg}],listeners:{scope:this,afterlayout:this._onAfterLayout}};Ext.apply(e,t),this.callParent([e])},_onAfterLayout:function(){this.getEl().alignTo(document.body,"c-c")}}),Ext.define("SYNO.SDS.Sharing.ErrorHandler",{singleton:!0,REASON:{permission:0,invalid:1,error:2,timeout:3,invalid_entry:4},MSG:{0:_JSLIBSTR("uicommon","error_noprivilege"),1:_T("error","error_page"),2:_T("error","error_error_system"),3:_T("error","error_timeout"),4:_T("sharing","error_invalid_entry")},toErrorPage:function(t){SYNO.SDS.Desktop&&SYNO.SDS.Desktop.hide(),Ext.getBody().mask().addClass("desktop-timeout-mask"),window.location.href="/sharing/errors?sharing_error="+t},initErrorPage:function(t){new SYNO.SDS.Sharing.ErrorDialog({errorMsg:this.MSG[t]})}}),Ext.define("SYNO.SDS.Sharing.Logout",{singleton:!0,logoutTriggered:!1,action:function(t){this.logoutTriggered||(window.onbeforeunload=null,this.logoutTriggered=!0,t===SYNO.SDS.Sharing.ErrorHandler.REASON.timeout?(window.alert(SYNO.SDS.Sharing.ErrorHandler.MSG[t]),this.reload()):SYNO.SDS.Sharing.ErrorHandler.toErrorPage(t))},reload:function(){window.location.reload()}}),SYNO.SDS.Utils.Logout.redirect=SYNO.SDS.Sharing.Logout.reload,Ext.ns("SYNO.SDS.Sharing"),SYNO.SDS.Sharing.LoginHandler=function(t){SYNO.SDS.Sharing.LoginDialog||(SYNO.SDS.Sharing.LoginDialog=new SYNO.SDS.Sharing._LoginDialog(t))},Ext.define("SYNO.SDS.Sharing._LoginDialog",{extend:"Ext.Container",constructor:function(t){this.loginType=t;var e=[];this.dialog=this.createLoginDialog(),this.wrapper=this.createLoginWrapper(),this.footer=this.createFooter(),e.push(this.wrapper),e.push(this.footer);var i="";Ext.isObject(_S("sharing_theme"))&&_S("sharing_theme").color&&(i+=" syno-sds-sharing-login-dialog-"+_S("sharing_theme").color);var n={cls:"syno-sds-sharing-login-dialog"+i,renderTo:document.body,items:e};this.callParent([n]),this._onResize(),Ext.EventManager.onWindowResize(this._onResize,this)},createLoginDialog:function(){return new SYNO.SDS.Sharing.LoginForm({owner:this,loginType:this.loginType})},createLoginWrapper:function(){return new SYNO.ux.Panel({cls:"login-wrapper",items:[{xtype:"box",cls:"login-image"},{xtype:"box",cls:"login-title",html:this.getProtectTitle()||_T("sharing","link")},this.dialog]})},createFooter:function(){return new SYNO.ux.Panel({cls:"login-footer",items:[{xtype:"box",cls:"login-footer-box",html:String.format("Copyright &copy; {0} Synology Inc.",(new Date).getFullYear())}]})},getProtectTitle:function(){var t=_S("sharing_protect_title");return Ext.isObject(t)?t.app_name?_TT(t.app_name,t.section,t.key):_T(t.section,t.key):Ext.util.Format.htmlEncode(t)},_onResize:function(){var t=Ext.lib.Dom.getViewHeight(),e=this.wrapper.getEl().getHeight(),i=this.footer.getEl().getHeight(),n=t-e-i;this.wrapper.getEl().alignTo(document.body,"t-t",[0,1*n/2.3])},destroy:function(){Ext.EventManager.removeResizeListener(this._onResize,this),this.callParent(arguments)}}),Ext.define("SYNO.SDS.Sharing.LoginController",{extend:"Ext.util.Observable",statics:{ERRCODE_MAP:{1e3:_T("error","error_error_system"),1001:_T("common","err_pass"),1002:_T("error","error_privilege_not_enough"),1003:_T("login","error_cantlogin"),1008:_T("login","error_maxtried"),1012:_T("sharing","err_expire_times")}},constructor:function(){this.callParent(arguments),this.addEvents("beforelogin","login","loginerror")},submit:function(t){t.sharing_id=_S("sharing_id"),SYNO.API.Request({api:"SYNO.Core.Sharing.Login",method:"login",version:1,params:t,scope:this,callback:function(t,e){if(t)this.fireEvent("beforelogin")&&(SYNO.SDS.Sharing.Init.initData(),this.fireEvent("login"));else{var i=SYNO.SDS.Sharing.LoginController.ERRCODE_MAP[e.code]||SYNO.API.Errors.common[e.code];this.fireEvent("loginerror",e.code,i)}},encryption:["password","dsm_username","dsm_password","sharing_id"]})}}),Ext.define("SYNO.SDS.Sharing.LoginForm",{extend:"SYNO.ux.Panel",constructor:function(t){this.onlyPassword="password"===t.loginType,this.createInputFields(),this.createLoginBtn();var e={cls:"login-form",items:[{xtype:"syno_panel",items:[this.userField]},{xtype:"syno_panel",items:[this.passField]},this.loginBtn,this.errMsgBox=new Ext.BoxComponent({cls:"login-error"})],listeners:{scope:this,afterlayout:this.applySharingLayout}};Ext.apply(e,t),this.callParent([e]),_S("preview")&&this.setFormDisabled(!0),this.attachLoginController()},attachLoginController:function(){this.loginController=new SYNO.SDS.Sharing.LoginController,this.mon(this.loginController,"loginerror",this.onLoginError,this),this.mon(this.loginController,"login",this.onAfterLogin,this)},createInputFields:function(){this.userField=new SYNO.ux.TextField({fieldLabel:_T("common","username"),emptyText:_T("common","username"),enableKeyEvents:!0,hideLabel:!0,listeners:{scope:this,keydown:this.onKeyDown}}),this.passField=new SYNO.ux.TextField({fieldLabel:_T("common","password"),emptyText:_T("common","password"),textType:"password",enableKeyEvents:!0,hideLabel:!0,listeners:{scope:this,keydown:this.onKeyDown}}),this.onlyPassword&&this.userField.hide()},onKeyDown:function(t,e){Ext.EventObject.ENTER===e.getKey()&&this.onSubmit()},applySharingLayout:function(){this.onlyPassword?this.passField.focus("",1):this.userField.focus("",1)},createLoginBtn:function(t){this.loginBtn=new SYNO.ux.Button({cls:"login-btn",xtype:"syno_button",btnStyle:"blue",text:_T("common","enter"),minWidth:84,scope:this,disabled:t,handler:this.onSubmit})},setFormDisabled:function(t){this.userField.setDisabled(t),this.passField.setDisabled(t),this.loginBtn.setDisabled(t),this.onlyPassword&&this.userField.hide()},setError:function(t){this.errMsgBox.update(t)},onLoginError:function(t,e){this.setError(e),this.setFormDisabled(!1)},onAfterLogin:function(){this.owner.destroy.defer(1e3,this.owner)},onSubmit:function(){var t={};this.onlyPassword?Ext.apply(t,{password:this.passField.getValue()}):Ext.apply(t,{dsm_username:this.userField.getValue(),dsm_password:this.passField.getValue()}),this.loginController.submit(t),this.setFormDisabled(!0)}}),Ext.define("SYNO.SDS.Sharing.PreviewDialog",{extend:"Ext.form.FormPanel",constructor:function(t){t=t||{},Ext.fly("sds-apply-preview-form").dom.removeAttribute("style"),this.callParent([SYNO.LayoutConfig.fill(Ext.apply({applyTo:"sds-apply-preview-form",unstyled:!0,items:[{synotype:"desc",value:_T("dsmoption","login_apply_preview")},{itemId:"btn_apply",xtype:"button",scope:this,width:100,text:_T("common","apply"),handler:this.onApply},{itemId:"btn_cancel",xtype:"button",scope:this,width:100,text:_T("common","cancel"),handler:this.onCancel}]},t))])},onApply:function(){this.getComponent("btn_apply").setDisabled(!0),this.getComponent("btn_cancel").setDisabled(!0);var t=window.location.origin;t||(t=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")),opener&&opener.postMessage({action:"save",origin:t},t),window.close()},onCancel:function(){window.close()}}),Ext.define("SYNO.SDS._UserSettings",{extend:"Ext.Component",getUnloadEventName:function(){var t="onpagehide"in window,e="onbeforeunload"in window,i="";return i=e?"beforeunload":t?"pagehide":null},registerUnloadEvent:Ext.emptyFn,unregisterUnloadEvent:Ext.emptyFn,saveAndUnload:Ext.emptyFn,syncSave:function(t){this.onSaveSuccess(t)},load:Ext.emptyFn,save:Ext.emptyFn,onSaveSuccess:function(t){var e;if(Ext.isObject(t)){e=t.scope||this;var i=t.callback;Ext.isFunction(i)&&i.call(e)}},getProperty:function(t,e){return SYNO.Debug.warn("getProperty is disabled in sharing mode."),null},setProperty:Ext.emptyFn,removeProperty:Ext.emptyFn}),Ext.define("SYNO.SDS.Sharing.Init",{extend:"Ext.util.Observable",singleton:!0,constructor:function(){this.callParent(arguments),this.addEvents("beforeredirect","beforeinitdata","initdata")},init:function(){this.preInitData(),"none"!==_S("sharing_status")||this.isErrorPage()||this.initData()},preInitData:function(){SYNO.SDS.InitUtils.hideForms().initQuickTips().initDragDrop().disableIESelect().disableSelectAllKeyboard().disableRightClick().handleServerError().initHTML5Upload().IEUpgradeAlert().defaultCSSSelectors().initSSO().initHDPack(),this.initAPI().initDialog().initPreviewDialog().hideStandaloneHelp()},initAPI:function(){return SYNO.API.currentManager||(SYNO.API.currentManager=new SYNO.API.Manager),SYNO.API.currentManager.baseURL="webapi",SYNO.API.currentManager.queryAPI("all"),this.injectCheckAPIResponse(),this},injectCheckAPIResponse:function(){var t=SYNO.API.CheckResponse;SYNO.API.CheckResponse=function(e,i,n,s){var o={105:SYNO.SDS.Sharing.ErrorHandler.REASON.permission,106:SYNO.SDS.Sharing.ErrorHandler.REASON.timeout,107:SYNO.SDS.Sharing.ErrorHandler.REASON.error,124:SYNO.SDS.Sharing.ErrorHandler.REASON.invalid,125:SYNO.SDS.Sharing.ErrorHandler.REASON.timeout},r=Ext.isObject(i)?i.code:void 0;if(void 0!==o[r])return void SYNO.SDS.Sharing.Logout.action(o[r]);var a=t.apply(SYNO.API,arguments);return r>=122&&127>=r&&SYNO.SDS.Sharing.Logout.action(SYNO.SDS.Sharing.ErrorHandler.REASON.permission),a}},initDialog:function(){switch(_S("sharing_status")){case"password":case"user":SYNO.SDS.Sharing.LoginHandler(_S("sharing_status"))}return this},isErrorPage:function(){return void 0!==_S("sharing_error")?(SYNO.SDS.Sharing.ErrorHandler.initErrorPage(_S("sharing_error")),!0):!1},initPreviewDialog:function(){return _S("preview")&&Ext.isObject(_S("sharing_preview_params"))&&_S("sharing_preview_params").preview_modified&&new SYNO.SDS.Sharing.PreviewDialog,this},hideStandaloneHelp:function(){return Ext.util.CSS.updateRule(".sds-standalone-help","display","none"),this},initData:function(t){var e=this;if(!1!==this.fireEvent("beforeinitdata"))return Ext.isNumber(t)&&t>0?void this.initData.defer(t,this):(SYNO.API.Request({api:"SYNO.Core.Sharing.Initdata",method:"get",version:1,headers:{"X-SYNO-SHARING":_S("sharing_id")},callback:function(t,i,n,s){function o(){Ext.isDefined(window._loadSynoLang)&&window._loadSynoLang(),Ext.apply(SYNO.SDS.Session,i.Session),SYNO.SDS.Config.JSConfig=i.JSConfig,SYNO.SDS.Strings=i.Strings,SYNO.SDS.AppPrivilege=i.AppPrivilege,SYNO.SDS.ServiceStatus=i.ServiceStatus,SYNO.SDS.UIFeatures.IconSizeManager.enableHDDisplay(i.SynohdpackStatus),SYNO.SDS.appendMissingCSSFiles(i.CSSFiles),e.postInitData(i.Sharing)}if(!t)return SYNO.Debug("SYNO.Core.Sharing.initData fail",arguments),void e.initData(3e3);if(!1!==e.fireEvent("initdata",i.Sharing)){if(0===Object.values(i).length)return void SYNO.SDS.Sharing.Logout.action(SYNO.SDS.Sharing.ErrorHandler.REASON.error);if(!e.initSharingRedirect(i.Sharing)){switch(i.Session.lang){case"cht":case"chs":case"jpn":case"krn":Ext.getBody().addClass("syno-cjk")}SYNO.SDS.Utils.loadUIStrings(i.Session.lang,i.Session.fullversion,o)}}}}),this)},postInitData:function(t){var e=Ext.urlDecode(location.search.substr(1)),i=t.project_name,n=t.app,s=e.jsDebug,o=e.accessible;Ext.isDefined(s)&&(SYNO.SDS.JSDebug=s),Ext.isDefined(o)&&Ext.getBody().addClass("accessible"),SYNO.SDS.initFramework(),this.injectIsAppEnabled();var r=SYNO.SDS.Config.FnMap[i],a=!1;if(r&&r.config){var l=r.config;a="standalone"===l.type||!0===l.allowStandalone||"url"===l.type||"legacy"===l.type}return SYNO.SDS.StatusNotifier.isAppEnabled(i)&&a?(this.initSharingId(),this.initStandaloneDesktop(i,n),this.getExternalIP(),this):(SYNO.SDS.Sharing.Logout.action(SYNO.SDS.Sharing.ErrorHandler.REASON.invalid_entry),this)},initSharingRedirect:function(t){return"always"===t.redirect_type||"url_param"===t.redirect_type&&"true"===Ext.urlDecode(location.search.substr(1)).redirect?(-1!==t.redirect_uri.indexOf("?")?t.redirect_uri+="&":t.redirect_uri+="?",t.redirect_uri+='_sharing_id="'+_S("sharing_id")+'"',t.redirect_uri=".."+t.redirect_uri,this.fireEvent("beforeredirect",t)&&(window.location.href=t.redirect_uri),!0):!1},initStandaloneDesktop:function(t,e){return SYNO.SDS.Session.standalone=!0,SYNO.SDS.Session.standaloneAppName=t,SYNO.SDS.Desktop=new SYNO.SDS._StandaloneDesktop,SYNO.SDS.AppLaunch(t,e),this},getExternalIP:function(){return SYNO.API.Request({api:"SYNO.Core.Sharing.Initdata",method:"get",version:1,headers:{"X-SYNO-SHARING":_S("sharing_id")},params:{action:"external_ip"},callback:function(t,e,i,n){return t?(SYNO.SDS.Session.external_ip=e.external_ip,void(SYNO.SDS.Session.ddns_hostname=e.ddns_hostname)):void SYNO.Debug("SYNO.Core.Sharing.initData get external_ip fail",arguments)}}),this},injectIsAppEnabled:function(){var t=SYNO.SDS.StatusNotifier.isAppHasPrivilege;return SYNO.SDS.StatusNotifier.isAppHasPrivilege=function(e){if(!t.call(SYNO.SDS.StatusNotifier,e))return!1;var i=SYNO.SDS.Config.FnMap[e];return i.config.allowSharing===!0},this},initSharingId:function(){var t=Ext.urlAppend,e="_sharing_id";return Ext.urlAppend=function(i,n){var s=Ext.urlDecode(n);return-1!==i.indexOf(e)||Ext.isEmpty(_S("sharing_id"))||(s[e]=Ext.util.JSON.encode(_S("sharing_id"))),t(i,Ext.urlEncode(s))},Ext.Ajax.on("beforerequest",function(t,e){Ext.isEmpty(_S("sharing_id"))||(Ext.isEmpty(e.headers)&&(e.headers={}),e.headers["X-SYNO-SHARING"]=_S("sharing_id"))}),Ext.util.Observable.observeClass(Ext.form.BasicForm),Ext.form.BasicForm.on("beforeaction",function(t,e){t.url&&(t.url=Ext.urlAppend(t.url))}),Ext.util.Observable.observeClass(Ext.data.Connection),Ext.data.Connection.on("beforerequest",function(t,e){Ext.isEmpty(_S("sharing_id"))||(e.headers=e.headers||{},e.headers["X-SYNO-SHARING"]=_S("sharing_id"))}),this}}),Ext.onReady(function(){SYNO.SDS.Sharing.Init.init()});
